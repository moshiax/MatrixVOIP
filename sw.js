/*! For license information please see sw.js.LICENSE.txt */
(()=>{var e,t,i,n={"./node_modules/another-json/another-json.js":e=>{"use strict";for(var t=/[\\\"\x00-\x1F]/g,i={},n=0;n<32;++n)i[String.fromCharCode(n)]="\\U"+("0000"+n.toString(16)).slice(-4).toUpperCase();function r(e){return t.lastIndex=0,e.replace(t,(function(e){return i[e]}))}function s(e){switch(typeof e){case"string":return'"'+r(e)+'"';case"number":return isFinite(e)?e:"null";case"boolean":return e;case"object":return null===e?"null":Array.isArray(e)?function(e){for(var t="[",i="",n=0;n<e.length;++n)i+=t,t=",",i+=s(e[n]);return","!=t?"[]":i+"]"}(e):function(e){var t="{",i="",n=Object.keys(e);n.sort();for(var o=0;o<n.length;++o){var a=n[o];i+=t+'"'+r(a)+'":',t=",",i+=s(e[a])}return","!=t?"{}":i+"}"}(e);default:throw new Error("Cannot stringify: "+typeof e)}}i["\b"]="\\b",i["\t"]="\\t",i["\n"]="\\n",i["\f"]="\\f",i["\r"]="\\r",i['"']='\\"',i["\\"]="\\\\",e.exports={stringify:s}},"./node_modules/matrix-js-sdk/src/@types/PushRules.ts":(e,t,i)=>{"use strict";i.d(t,{Ji:()=>o,QN:()=>r,YU:()=>n,kq:()=>a,wp:()=>s});let n=function(e){return e.DontNotify="dont_notify",e.Notify="notify",e.Coalesce="coalesce",e}({}),r=function(e){return e.Highlight="highlight",e.Sound="sound",e}({});let s=function(e){return e.EventMatch="event_match",e.EventPropertyIs="event_property_is",e.EventPropertyContains="event_property_contains",e.ContainsDisplayName="contains_display_name",e.RoomMemberCount="room_member_count",e.SenderNotificationPermission="sender_notification_permission",e.CallStarted="call_started",e.CallStartedPrefix="org.matrix.msc3914.call_started",e}({}),o=function(e){return e.Override="override",e.ContentSpecific="content",e.RoomSpecific="room",e.SenderSpecific="sender",e.Underride="underride",e}({}),a=function(e){return e.Master=".m.rule.master",e.IsUserMention=".m.rule.is_user_mention",e.IsRoomMention=".m.rule.is_room_mention",e.ContainsDisplayName=".m.rule.contains_display_name",e.ContainsUserName=".m.rule.contains_user_name",e.AtRoomNotification=".m.rule.roomnotif",e.DM=".m.rule.room_one_to_one",e.EncryptedDM=".m.rule.encrypted_room_one_to_one",e.Message=".m.rule.message",e.EncryptedMessage=".m.rule.encrypted",e.InviteToSelf=".m.rule.invite_for_me",e.MemberEvent=".m.rule.member_event",e.IncomingCall=".m.rule.call",e.SuppressNotices=".m.rule.suppress_notices",e.Tombstone=".m.rule.tombstone",e.PollStart=".m.rule.poll_start",e.PollStartUnstable=".org.matrix.msc3930.rule.poll_start",e.PollEnd=".m.rule.poll_end",e.PollEndUnstable=".org.matrix.msc3930.rule.poll_end",e.PollStartOneToOne=".m.rule.poll_start_one_to_one",e.PollStartOneToOneUnstable=".org.matrix.msc3930.rule.poll_start_one_to_one",e.PollEndOneToOne=".m.rule.poll_end_one_to_one",e.PollEndOneToOneUnstable=".org.matrix.msc3930.rule.poll_end_one_to_one",e}({})},"./node_modules/matrix-js-sdk/src/@types/beacon.ts":(e,t,i)=>{"use strict";i.d(t,{E:()=>r,z:()=>s});var n=i("./node_modules/matrix-js-sdk/src/NamespacedValue.ts");const r=new n.qr("m.beacon_info","org.matrix.msc3672.beacon_info"),s=new n.qr("m.beacon","org.matrix.msc3672.beacon")},"./node_modules/matrix-js-sdk/src/@types/event.ts":(e,t,i)=>{"use strict";i.d(t,{Bx:()=>r,CJ:()=>c,Ct:()=>a,D7:()=>l,ID:()=>m,Ng:()=>f,SY:()=>_,Sr:()=>w,Wr:()=>o,Xs:()=>S,Yg:()=>y,Z3:()=>v,cr:()=>b,ge:()=>g,iK:()=>p,nN:()=>h,ud:()=>u,wt:()=>d,zZ:()=>s});var n=i("./node_modules/matrix-js-sdk/src/NamespacedValue.ts");i("./node_modules/matrix-js-sdk/src/@types/beacon.ts"),i("./node_modules/matrix-js-sdk/src/@types/polls.ts");let r=function(e){return e.RoomCanonicalAlias="m.room.canonical_alias",e.RoomCreate="m.room.create",e.RoomJoinRules="m.room.join_rules",e.RoomMember="m.room.member",e.RoomThirdPartyInvite="m.room.third_party_invite",e.RoomPowerLevels="m.room.power_levels",e.RoomName="m.room.name",e.RoomTopic="m.room.topic",e.RoomAvatar="m.room.avatar",e.RoomPinnedEvents="m.room.pinned_events",e.RoomEncryption="m.room.encryption",e.RoomHistoryVisibility="m.room.history_visibility",e.RoomGuestAccess="m.room.guest_access",e.RoomServerAcl="m.room.server_acl",e.RoomTombstone="m.room.tombstone",e.RoomPredecessor="org.matrix.msc3946.room_predecessor",e.PolicyRuleUser="m.policy.rule.user",e.PolicyRuleRoom="m.policy.rule.room",e.PolicyRuleServer="m.policy.rule.server",e.SpaceChild="m.space.child",e.SpaceParent="m.space.parent",e.RoomRedaction="m.room.redaction",e.RoomMessage="m.room.message",e.RoomMessageEncrypted="m.room.encrypted",e.Sticker="m.sticker",e.CallInvite="m.call.invite",e.CallCandidates="m.call.candidates",e.CallAnswer="m.call.answer",e.CallHangup="m.call.hangup",e.CallReject="m.call.reject",e.CallSelectAnswer="m.call.select_answer",e.CallNegotiate="m.call.negotiate",e.CallSDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",e.CallSDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",e.CallReplaces="m.call.replaces",e.CallAssertedIdentity="m.call.asserted_identity",e.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",e.CallEncryptionKeysPrefix="io.element.call.encryption_keys",e.KeyVerificationRequest="m.key.verification.request",e.KeyVerificationStart="m.key.verification.start",e.KeyVerificationCancel="m.key.verification.cancel",e.KeyVerificationMac="m.key.verification.mac",e.KeyVerificationDone="m.key.verification.done",e.KeyVerificationKey="m.key.verification.key",e.KeyVerificationAccept="m.key.verification.accept",e.KeyVerificationReady="m.key.verification.ready",e.RoomMessageFeedback="m.room.message.feedback",e.Reaction="m.reaction",e.PollStart="org.matrix.msc3381.poll.start",e.Typing="m.typing",e.Receipt="m.receipt",e.Presence="m.presence",e.FullyRead="m.fully_read",e.Tag="m.tag",e.SpaceOrder="org.matrix.msc3230.space_order",e.PushRules="m.push_rules",e.Direct="m.direct",e.IgnoredUserList="m.ignored_user_list",e.RoomKey="m.room_key",e.RoomKeyRequest="m.room_key_request",e.ForwardedRoomKey="m.forwarded_room_key",e.Dummy="m.dummy",e.GroupCallPrefix="org.matrix.msc3401.call",e.GroupCallMemberPrefix="org.matrix.msc3401.call.member",e.CallNotify="org.matrix.msc4075.call.notify",e}({}),s=function(e){return e.Annotation="m.annotation",e.Replace="m.replace",e.Reference="m.reference",e.Thread="m.thread",e}({}),o=function(e){return e.Text="m.text",e.Emote="m.emote",e.Notice="m.notice",e.Image="m.image",e.File="m.file",e.Audio="m.audio",e.Location="m.location",e.Video="m.video",e.KeyVerificationRequest="m.key.verification.request",e}({});const a="type";let c=function(e){return e.Space="m.space",e.UnstableCall="org.matrix.msc3417.call",e.ElementVideo="io.element.video",e}({});const d="org.matrix.msgid",l=new n.qr("m.room.purpose","org.matrix.msc3088.purpose"),u=new n.qr("m.enabled","org.matrix.msc3088.enabled"),h=new n.qr("m.data_tree","org.matrix.msc3089.data_tree"),m=new n.qr("m.leaf","org.matrix.msc3089.leaf"),p=new n.qr("m.branch","org.matrix.msc3089.branch"),g=new n.qr("m.room.marker","org.matrix.msc2716.marker"),v=new n.qr("with_rel_types","org.matrix.msc3912.with_relations"),f=new n.qr("io.element.functional_members","io.element.functional_members"),y=new n.qr("m.visibility","org.matrix.msc3531.visibility"),b=new n.qr("enabled","org.matrix.msc3881.enabled"),S=(new n.qr("device_id","org.matrix.msc3881.device_id"),new n.qr("m.local_notification_settings","org.matrix.msc3890.local_notification_settings")),w=new n.qr("thread_id","org.matrix.msc4023.thread_id"),_=new n.qr("membership","io.element.msc4115.membership")},"./node_modules/matrix-js-sdk/src/@types/extensible_events.ts":(e,t,i)=>{"use strict";var n=i("./node_modules/matrix-events-sdk/lib/index.js");new n.UnstableValue("m.message","org.matrix.msc1767.message"),new n.UnstableValue("m.text","org.matrix.msc1767.text"),new n.UnstableValue("m.html","org.matrix.msc1767.html"),new n.NamespacedValue("m.reference")},"./node_modules/matrix-js-sdk/src/@types/location.ts":(e,t,i)=>{"use strict";i.d(t,{J1:()=>r,M6:()=>o,vo:()=>s});var n=i("./node_modules/matrix-js-sdk/src/NamespacedValue.ts");i("./node_modules/matrix-js-sdk/src/@types/extensible_events.ts");const r=new n.qr("m.asset","org.matrix.msc3488.asset"),s=new n.qr("m.ts","org.matrix.msc3488.ts"),o=new n.qr("m.location","org.matrix.msc3488.location")},"./node_modules/matrix-js-sdk/src/@types/membership.ts":(e,t,i)=>{"use strict";i.d(t,{O:()=>n});let n=function(e){return e.Ban="ban",e.Invite="invite",e.Join="join",e.Knock="knock",e.Leave="leave",e}({})},"./node_modules/matrix-js-sdk/src/@types/partials.ts":(e,t,i)=>{"use strict";i.d(t,{Jv:()=>o,dx:()=>r,k:()=>n,rF:()=>s});let n=function(e){return e.PrivateChat="private_chat",e.TrustedPrivateChat="trusted_private_chat",e.PublicChat="public_chat",e}({}),r=function(e){return e.Public="public",e.Invite="invite",e.Private="private",e.Knock="knock",e.Restricted="restricted",e}({}),s=function(e){return e.CanJoin="can_join",e.Forbidden="forbidden",e}({}),o=function(e){return e.Invited="invited",e.Joined="joined",e.Shared="shared",e.WorldReadable="world_readable",e}({})},"./node_modules/matrix-js-sdk/src/@types/polls.ts":(e,t,i)=>{"use strict";i.d(t,{cI:()=>s,qN:()=>r});var n=i("./node_modules/matrix-events-sdk/lib/index.js");new n.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed"),new n.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed"),new n.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");const r=new n.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response"),s=new n.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end")},"./node_modules/matrix-js-sdk/src/@types/read_receipts.ts":(e,t,i)=>{"use strict";i.d(t,{L:()=>n,S:()=>r});let n=function(e){return e.Read="m.read",e.FullyRead="m.fully_read",e.ReadPrivate="m.read.private",e}({});const r="main"},"./node_modules/matrix-js-sdk/src/@types/search.ts":(e,t,i)=>{"use strict";i.d(t,{g:()=>n});let n=function(e){return e.Recent="recent",e.Rank="rank",e}({})},"./node_modules/matrix-js-sdk/src/@types/sync.ts":(e,t,i)=>{"use strict";i.d(t,{a:()=>n});const n=new(i("./node_modules/matrix-js-sdk/src/NamespacedValue.ts").M6)("unread_thread_notifications","org.matrix.msc3773.unread_thread_notifications")},"./node_modules/matrix-js-sdk/src/@types/topic.ts":(e,t,i)=>{"use strict";i.d(t,{s:()=>n});const n=new(i("./node_modules/matrix-js-sdk/src/NamespacedValue.ts").qr)("m.topic","org.matrix.msc3765.topic")},"./node_modules/matrix-js-sdk/src/NamespacedValue.ts":(e,t,i)=>{"use strict";i.d(t,{M6:()=>s,qr:()=>o,xu:()=>r});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js");class r{constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}get names(){const e=[this.name],t=this.altName;return t&&e.push(t),e}matches(e){return this.name===e||this.altName===e}findIn(e){let t;return this.name&&(t=null==e?void 0:e[this.name]),!t&&this.altName&&(t=null==e?void 0:e[this.altName]),t}includedIn(e){let t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}}class s extends r{constructor(...e){super(...e),(0,n.A)(this,"preferUnstable",!1)}setPreferUnstable(e){this.preferUnstable=e}get name(){return this.stable&&!this.preferUnstable?this.stable:this.unstable}}class o extends r{constructor(e,t){if(super(e,t),!this.unstable)throw new Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}}},"./node_modules/matrix-js-sdk/src/ReEmitter.ts":(e,t,i)=>{"use strict";i.d(t,{K:()=>r,Q:()=>s});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js");class r{constructor(e){this.target=e,(0,n.A)(this,"reEmitters",new WeakMap)}reEmit(e,t){let i=this.reEmitters.get(e);i||(i=new Map,this.reEmitters.set(e,i));for(const n of t){if(i.has(n))continue;const t=(...t)=>{"error"===n&&0===this.target.listenerCount("error")||this.target.emit(n,...t,e)};e.on(n,t),i.set(n,t)}}stopReEmitting(e,t){const i=this.reEmitters.get(e);if(i){for(const n of t)e.off(n,i.get(n)),i.delete(n);0===i.size&&this.reEmitters.delete(e)}}}class s extends r{constructor(e){super(e)}reEmit(e,t){super.reEmit(e,t)}stopReEmitting(e,t){super.stopReEmitting(e,t)}}},"./node_modules/matrix-js-sdk/src/autodiscovery.ts":(e,t,i)=>{"use strict";i.d(t,{MN:()=>d});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/logger.ts"),s=i("./node_modules/matrix-js-sdk/src/http-api/index.ts"),o=i("./node_modules/matrix-js-sdk/src/version-support.ts");let a=function(e){return e.SUCCESS="SUCCESS",e.IGNORE="IGNORE",e.PROMPT="PROMPT",e.FAIL_PROMPT="FAIL_PROMPT",e.FAIL_ERROR="FAIL_ERROR",e}({}),c=function(e){return e.Invalid="Invalid homeserver discovery response",e.GenericFailure="Failed to get autodiscovery configuration from server",e.InvalidHsBaseUrl="Invalid base_url for m.homeserver",e.InvalidHomeserver="Homeserver URL does not appear to be a valid Matrix homeserver",e.InvalidIsBaseUrl="Invalid base_url for m.identity_server",e.InvalidIdentityServer="Identity server URL does not appear to be a valid identity server",e.InvalidIs="Invalid identity server discovery response",e.MissingWellknown="No .well-known JSON file found",e.InvalidJson="Invalid JSON",e.UnsupportedHomeserverSpecVersion="The homeserver does not meet the version requirements",e}({});class d{static async fromDiscoveryConfig(e){var t;const i={"m.homeserver":{state:d.FAIL_ERROR,error:d.ERROR_INVALID,base_url:null},"m.identity_server":{state:d.PROMPT,error:null,base_url:null}};if(null==e||!e["m.homeserver"])return r.v.error("No m.homeserver key in config"),i["m.homeserver"].state=d.FAIL_PROMPT,i["m.homeserver"].error=d.ERROR_INVALID,Promise.resolve(i);if(!e["m.homeserver"].base_url)return r.v.error("No m.homeserver base_url in config"),i["m.homeserver"].state=d.FAIL_PROMPT,i["m.homeserver"].error=d.ERROR_INVALID_HS_BASE_URL,Promise.resolve(i);const n=this.sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!n)return r.v.error("Invalid base_url for m.homeserver"),i["m.homeserver"].error=d.ERROR_INVALID_HS_BASE_URL,Promise.resolve(i);const s=await this.fetchWellKnownObject(`${n}/_matrix/client/versions`);if(!s||!Array.isArray(null===(t=s.raw)||void 0===t?void 0:t.versions))return r.v.error("Invalid /versions response"),i["m.homeserver"].error=d.ERROR_INVALID_HOMESERVER,i["m.homeserver"].base_url=n,Promise.resolve(i);const c=new Set(s.raw.versions);let l=!1;for(const e of o.Hr)if(c.has(e)){l=!0;break}if(!l)return r.v.error("Homeserver does not meet version requirements"),i["m.homeserver"].error=d.ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION,i["m.homeserver"].base_url=n,Promise.resolve(i);i["m.homeserver"]={state:d.SUCCESS,error:null,base_url:n};let u="";if(e["m.identity_server"]){const t={"m.homeserver":i["m.homeserver"],"m.identity_server":{state:d.FAIL_PROMPT,error:d.ERROR_INVALID_IS,base_url:null}};if(u=this.sanitizeWellKnownUrl(e["m.identity_server"].base_url),!u)return r.v.error("Invalid base_url for m.identity_server"),t["m.identity_server"].error=d.ERROR_INVALID_IS_BASE_URL,Promise.resolve(t);const n=await this.fetchWellKnownObject(`${u}/_matrix/identity/v2`);if(null==n||!n.raw||n.action!==a.SUCCESS)return r.v.error("Invalid /v2 response"),t["m.identity_server"].error=d.ERROR_INVALID_IDENTITY_SERVER,t["m.identity_server"].base_url=u,Promise.resolve(t)}return u&&u.toString().length>0&&(i["m.identity_server"]={state:d.SUCCESS,error:null,base_url:u}),Object.keys(e).forEach((t=>{if("m.homeserver"===t||"m.identity_server"===t){const n=["error","state","base_url"];for(const r of Object.keys(e[t]))n.includes(r)||(i[t][r]=e[t][r])}else i[t]=e[t]})),Promise.resolve(i)}static async findClientConfig(e){if(!e||"string"!=typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const t={"m.homeserver":{state:d.FAIL_ERROR,error:d.ERROR_INVALID,base_url:null},"m.identity_server":{state:d.PROMPT,error:null,base_url:null}},i=e.includes("://")?e:`https://${e}`,n=await this.fetchWellKnownObject(`${i}/.well-known/matrix/client`);return n&&n.action===a.SUCCESS?d.fromDiscoveryConfig(n.raw):(r.v.error("No response or error when parsing .well-known"),n.reason&&r.v.error(n.reason),n.action===a.IGNORE?t["m.homeserver"]={state:d.PROMPT,error:null,base_url:null}:(t["m.homeserver"].state=d.FAIL_PROMPT,t["m.homeserver"].error=d.ERROR_INVALID),Promise.resolve(t))}static async getRawClientConfig(e){var t;if(!e||"string"!=typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const i=await this.fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return i&&null!==(t=i.raw)&&void 0!==t?t:{}}static sanitizeWellKnownUrl(e){if(!e)return!1;try{var t;let i;try{i=new URL(e)}catch(e){r.v.error("Could not parse url",e)}if(null===(t=i)||void 0===t||!t.hostname)return!1;if("http:"!==i.protocol&&"https:"!==i.protocol)return!1;const n=i.port?`:${i.port}`:"",s=i.pathname?i.pathname:"";let o=`${i.protocol}//${i.hostname}${n}${s}`;return o.endsWith("/")&&(o=o.substring(0,o.length-1)),o}catch(e){return r.v.error(e),!1}}static fetch(e,t){return this.fetchFn?this.fetchFn(e,t):i.g.fetch(e,t)}static setFetchFn(e){d.fetchFn=e}static async fetchWellKnownObject(e){let t;try{if(t=await d.fetch(e,{method:s.IT.Get,signal:(0,s._)(5e3)}),404===t.status)return{raw:{},action:a.IGNORE,reason:d.ERROR_MISSING_WELLKNOWN};if(!t.ok)return{raw:{},action:a.FAIL_PROMPT,reason:"General failure"}}catch(e){const t=e;let i="";return"object"==typeof t&&(i=null==t?void 0:t.message),{error:t,raw:{},action:a.FAIL_PROMPT,reason:i||"General failure"}}try{return{raw:await t.json(),action:a.SUCCESS}}catch(e){const t=e;return{error:t,raw:{},action:a.FAIL_PROMPT,reason:"SyntaxError"===(null==t?void 0:t.name)?d.ERROR_INVALID_JSON:d.ERROR_INVALID}}}}(0,n.A)(d,"ERROR_INVALID",c.Invalid),(0,n.A)(d,"ERROR_GENERIC_FAILURE",c.GenericFailure),(0,n.A)(d,"ERROR_INVALID_HS_BASE_URL",c.InvalidHsBaseUrl),(0,n.A)(d,"ERROR_INVALID_HOMESERVER",c.InvalidHomeserver),(0,n.A)(d,"ERROR_INVALID_IS_BASE_URL",c.InvalidIsBaseUrl),(0,n.A)(d,"ERROR_INVALID_IDENTITY_SERVER",c.InvalidIdentityServer),(0,n.A)(d,"ERROR_INVALID_IS",c.InvalidIs),(0,n.A)(d,"ERROR_MISSING_WELLKNOWN",c.MissingWellknown),(0,n.A)(d,"ERROR_INVALID_JSON",c.InvalidJson),(0,n.A)(d,"ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION",c.UnsupportedHomeserverSpecVersion),(0,n.A)(d,"ALL_ERRORS",Object.keys(c)),(0,n.A)(d,"FAIL_ERROR",a.FAIL_ERROR),(0,n.A)(d,"FAIL_PROMPT",a.FAIL_PROMPT),(0,n.A)(d,"PROMPT",a.PROMPT),(0,n.A)(d,"SUCCESS",a.SUCCESS),(0,n.A)(d,"fetchFn",void 0)},"./node_modules/matrix-js-sdk/src/base64.ts":(e,t,i)=>{"use strict";i.d(t,{A4:()=>o,PP:()=>s,WG:()=>r,y4:()=>a});var n=i("./node_modules/buffer/index.js").hp;function r(e){if("function"==typeof n)return n.from(e).toString("base64");if("function"==typeof btoa&&e instanceof Uint8Array)return btoa(e.reduce(((e,t)=>e+String.fromCharCode(t)),""));throw new Error("No base64 impl found!")}function s(e){return r(e).replace(/={1,2}$/,"")}function o(e){return s(e).replace("+","-").replace("/","_")}function a(e){if("function"==typeof n)return n.from(e,"base64");if("function"==typeof atob){const t=function*(){const t=atob(e.replace("-","+").replace("_","/"));for(let e=0;e<t.length;++e)yield t.charCodeAt(e)};return Uint8Array.from(t())}throw new Error("No base64 impl found!")}},"./node_modules/matrix-js-sdk/src/client.ts":(e,t,i)=>{"use strict";i.d(t,{AU:()=>_e,pB:()=>Ie,eO:()=>be,L$:()=>Se,fN:()=>Re,Xb:()=>ke});var n=i("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),r=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=i("./node_modules/matrix-js-sdk/src/sync.ts"),o=i("./node_modules/matrix-js-sdk/src/models/event.ts");class a{constructor(){(0,r.A)(this,"accountData",new Map),(0,r.A)(this,"fromToken",null)}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}setUserCreator(e){}storeEvents(e,t,i,n){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve(void 0)}storeClientOptions(e){return Promise.resolve()}async getPendingEvents(e){return[]}setPendingEvents(e,t){return Promise.resolve()}async saveToDeviceBatches(e){return Promise.resolve()}getOldestToDeviceBatch(){return Promise.resolve(null)}async removeToDeviceBatch(e){return Promise.resolve()}async destroy(){}}var c=i("./node_modules/matrix-js-sdk/src/webrtc/call.ts"),d=i("./node_modules/matrix-js-sdk/src/filter.ts"),l=i("./node_modules/matrix-js-sdk/src/webrtc/callEventHandler.ts"),u=i("./node_modules/matrix-js-sdk/src/webrtc/groupCallEventHandler.ts"),h=i("./node_modules/matrix-js-sdk/src/utils.ts"),m=i("./node_modules/matrix-js-sdk/src/models/event-timeline.ts"),p=i("./node_modules/matrix-js-sdk/src/pushprocessor.ts"),g=i("./node_modules/matrix-js-sdk/src/autodiscovery.ts"),v=i("./node_modules/matrix-js-sdk/src/crypto/olmlib.ts"),f=i("./node_modules/matrix-js-sdk/src/base64.ts"),y=i("./node_modules/matrix-js-sdk/src/ReEmitter.ts"),b=i("./node_modules/matrix-js-sdk/src/logger.ts"),S=i("./node_modules/matrix-js-sdk/src/service-types.ts"),w=i("./node_modules/matrix-js-sdk/src/http-api/index.ts"),_=i("./node_modules/matrix-js-sdk/src/crypto/index.ts"),E=i("./node_modules/matrix-js-sdk/src/crypto/recoverykey.ts"),I=i("./node_modules/matrix-js-sdk/src/crypto/key_passphrase.ts"),k=i("./node_modules/matrix-js-sdk/src/models/user.ts"),R=i("./node_modules/matrix-js-sdk/src/content-repo.ts"),T=i("./node_modules/matrix-js-sdk/src/models/search-result.ts"),C=i("./node_modules/matrix-js-sdk/src/crypto/dehydration.ts"),A=i("./node_modules/matrix-js-sdk/src/crypto/api.ts"),O=i("./node_modules/matrix-js-sdk/src/content-helpers.ts"),x=i("./node_modules/matrix-js-sdk/src/models/room.ts"),M=i("./node_modules/matrix-js-sdk/src/models/room-member.ts"),P=i("./node_modules/matrix-js-sdk/src/@types/event.ts"),j=i("./node_modules/matrix-js-sdk/src/@types/partials.ts");function D(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function U(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?D(Object(i),!0).forEach((function(t){(0,r.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):D(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var L=i("./node_modules/matrix-js-sdk/src/randomstring.ts"),N=i("./node_modules/matrix-js-sdk/src/crypto/backup.ts"),B=i("./node_modules/p-retry/index.js"),F=i.n(B);function K(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function $(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?K(Object(i),!0).forEach((function(t){(0,r.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):K(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class q{constructor(e,t,i){this.client=e,this.indexEvent=t,this.directory=i}get id(){const e=this.indexEvent.getStateKey();if(!e)throw new Error("State key not found for branch");return e}get isActive(){return!0===this.indexEvent.getContent().active}get version(){var e;return null!==(e=this.indexEvent.getContent().version)&&void 0!==e?e:1}get roomId(){return this.indexEvent.getRoomId()}async delete(){await this.client.sendStateEvent(this.roomId,P.iK.name,{},this.id),await this.client.redactEvent(this.roomId,this.id);const e=(await this.getVersionHistory())[1];e&&await e.delete()}getName(){return this.indexEvent.getContent().name||"Unnamed File"}async setName(e){await this.client.sendStateEvent(this.roomId,P.iK.name,$($({},this.indexEvent.getContent()),{},{name:e}),this.id)}isLocked(){return this.indexEvent.getContent().locked||!1}async setLocked(e){await this.client.sendStateEvent(this.roomId,P.iK.name,$($({},this.indexEvent.getContent()),{},{locked:e}),this.id)}async getFileInfo(){const e=(await this.getFileEvent()).getOriginalContent().file,t=this.client.mxcUrlToHttp(e.url);if(!t)throw new Error(`No HTTP URL available for ${e.url}`);return{info:e,httpUrl:t}}async getFileEvent(){const e=this.client.getRoom(this.roomId);if(!e)throw new Error("Unknown room");let t=e.getUnfilteredTimelineSet().findEventById(this.id);for(;!t&&e.getLiveTimeline().getState(m.q.BACKWARDS).paginationToken;)await this.client.scrollback(e,100),t=e.getUnfilteredTimelineSet().findEventById(this.id);if(!t)throw new Error("Failed to find event");return await this.client.decryptEventIfNeeded(t),t}async createNewVersion(e,t,i,n){const r=await this.directory.createFile(e,t,i,$($({},null!=n?n:{}),{},{"m.new_content":!0,"m.relates_to":{rel_type:P.zZ.Replace,event_id:this.id}}));return await this.client.sendStateEvent(this.roomId,P.iK.name,{active:!0,name:e,version:this.version+1},r.event_id),await this.client.sendStateEvent(this.roomId,P.iK.name,$($({},this.indexEvent.getContent()),{},{active:!1}),this.id),r}async getVersionHistory(){const e=[];e.push(this);const t=this.client.getRoom(this.roomId);if(!t)throw new Error("Invalid or unknown room");const i=[...t.getLiveTimeline().getEvents()].reverse();let n,r=await this.getFileEvent();do{if(n=i.find((e=>e.replacingEventId()===r.getId())),n){const t=this.directory.getFile(n.getId());if(!t)break;e.push(t),r=n}}while(n);return e}}var V=i("./node_modules/matrix-js-sdk/src/crypto/algorithms/megolm.ts"),G=i("./node_modules/matrix-js-sdk/src/@types/membership.ts");function W(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function H(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?W(Object(i),!0).forEach((function(t){(0,r.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):W(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const J={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[P.Bx.RoomPowerLevels]:100,[P.Bx.RoomHistoryVisibility]:100,[P.Bx.RoomTombstone]:100,[P.Bx.RoomEncryption]:100,[P.Bx.RoomName]:50,[P.Bx.RoomMessage]:50,[P.Bx.RoomMessageEncrypted]:50,[P.Bx.Sticker]:50},users:{}};let z=function(e){return e.Viewer="viewer",e.Editor="editor",e.Owner="owner",e}({});class Q{constructor(e,t){if(this.client=e,this.roomId=t,(0,r.A)(this,"room",void 0),this.room=this.client.getRoom(this.roomId),!this.room)throw new Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){const e=this.room.currentState.getStateEvents(P.Bx.SpaceParent);return null==e||!e.length||e.every((e=>{var t;return!(null!==(t=e.getContent())&&void 0!==t&&t.via)}))}async setName(e){await this.client.sendStateEvent(this.roomId,P.Bx.RoomName,{name:e},"")}async invite(e,t=!0,i=!0){const n=[this.retryInvite(e)];return t&&n.push(...this.getDirectories().map((n=>n.invite(e,t,i)))),Promise.all(n).then((()=>{i&&(0,V.hk)(this.room)&&this.client.sendSharedHistoryKeys(this.roomId,[e])}))}retryInvite(e){return(0,h.CC)((async()=>{await this.client.invite(this.roomId,e).catch((e=>{if("M_FORBIDDEN"===(null==e?void 0:e.errcode))throw new(F().AbortError)(e);throw e}))}))}async setPermissions(e,t){var i;const n=this.room.currentState.getStateEvents(P.Bx.RoomPowerLevels,"");if(Array.isArray(n))throw new Error("Unexpected return type for power levels");const r=(null==n?void 0:n.getContent())||{},s=r.users_default||0,o=r.events_default||50,a=(null===(i=r.events)||void 0===i?void 0:i[P.Bx.RoomPowerLevels])||100,c=r.users||{};switch(t){case z.Viewer:c[e]=s;break;case z.Editor:c[e]=o;break;case z.Owner:c[e]=a;break;default:throw new Error("Invalid role: "+t)}r.users=c,await this.client.sendStateEvent(this.roomId,P.Bx.RoomPowerLevels,r,"")}getPermissions(e){var t,i;const n=this.room.currentState.getStateEvents(P.Bx.RoomPowerLevels,"");if(Array.isArray(n))throw new Error("Unexpected return type for power levels");const r=(null==n?void 0:n.getContent())||{},s=r.users_default||0,o=r.events_default||50,a=(null===(t=r.events)||void 0===t?void 0:t[P.Bx.RoomPowerLevels])||100,c=(null===(i=r.users)||void 0===i?void 0:i[e])||s;return c>=a?z.Owner:c>=o?z.Editor:z.Viewer}async createDirectory(e){const t=await this.client.unstableCreateFileTree(e);return await this.client.sendStateEvent(this.roomId,P.Bx.SpaceChild,{via:[this.client.getDomain()]},t.roomId),await this.client.sendStateEvent(t.roomId,P.Bx.SpaceParent,{via:[this.client.getDomain()]},this.roomId),t}getDirectories(){const e=[],t=this.room.currentState.getStateEvents(P.Bx.SpaceChild);for(const i of t)try{const t=i.getStateKey();if(t){const i=this.client.unstableGetFileTreeSpace(t);i&&e.push(i)}}catch(e){b.v.warn("Unable to create tree space instance for listing. Are we joined?",e)}return e}getDirectory(e){return this.getDirectories().find((t=>t.roomId===e))}async delete(){const e=this.getDirectories();for(const t of e)await t.delete();const t=[G.O.Invite,G.O.Knock,G.O.Join],i=this.room.currentState.getStateEvents(P.Bx.RoomMember);for(const e of i){if(e.getStateKey()!==this.client.getUserId()&&t.includes(e.getContent().membership)){const t=e.getStateKey();if(!t)throw new Error("State key not found for branch");await this.client.kick(this.roomId,t,"Room deleted")}}await this.client.leave(this.roomId)}getOrderedChildren(e){const t=e.map((e=>({roomId:e.getStateKey(),order:e.getContent().order}))).filter((e=>e.roomId));return t.sort(((e,t)=>{if(e.order&&!t.order)return-1;if(!e.order&&t.order)return 1;if(e.order||t.order)return(0,h.aw)(e.order,t.order);{var i,n,r,s;const o=this.client.getRoom(e.roomId),a=this.client.getRoom(t.roomId);if(!o||!a)return(0,h.aw)(e.roomId,t.roomId);const c=null!==(i=null===(n=o.currentState.getStateEvents(P.Bx.RoomCreate,""))||void 0===n?void 0:n.getTs())&&void 0!==i?i:0,d=null!==(r=null===(s=a.currentState.getStateEvents(P.Bx.RoomCreate,""))||void 0===s?void 0:s.getTs())&&void 0!==r?r:0;return c===d?(0,h.aw)(e.roomId,t.roomId):c-d}})),t}getParentRoom(){const e=this.room.currentState.getStateEvents(P.Bx.SpaceParent)[0];if(!e)throw new Error("Expected to have a parent in a non-top level space");const t=e.getStateKey();if(!t)throw new Error("No state key found for parent");const i=this.client.getRoom(t);if(!i)throw new Error("Unable to locate room for parent");return i}getOrder(){if(this.isTopLevel)return-1;const e=this.getParentRoom().currentState.getStateEvents(P.Bx.SpaceChild);return this.getOrderedChildren(e).findIndex((e=>e.roomId===this.roomId))}async setOrder(e){var t;if(this.isTopLevel)throw new Error("Cannot set order of top level spaces currently");const i=this.getParentRoom(),n=i.currentState.getStateEvents(P.Bx.SpaceChild),r=this.getOrderedChildren(n);e=Math.max(Math.min(e,r.length-1),0);const s=this.getOrder()<e;s&&e===r.length-1?e--:s||0!==e||e++;const o=r[s?e:e-1],a=r[s?e+1:e];let c=h.Mf[0],d=!1;if(o)if(e===r.length-1)null!=a&&a.order&&(c=(0,h.$9)(a.order));else{const e=null==o?void 0:o.order,t=null==a?void 0:a.order;e&&t?c=e===t?(0,h.$9)(e):(0,h.sy)(e,t):e?c=(0,h.$9)(e):t?c=(0,h.zR)(t):d=!0}else null!=a&&a.order&&(c=(0,h.zR)(a.order));if(d){let t;for(let n=0;n<=e;n++){const e=r[n];if(0===n&&(t=e.order),e.order)t=e.order;else{var l;t=t?(0,h.$9)(t):h.Mf[0];const n=i.currentState.getStateEvents(P.Bx.SpaceChild,e.roomId),r=null!==(l=null==n?void 0:n.getContent())&&void 0!==l?l:{via:[this.client.getDomain()]};await this.client.sendStateEvent(i.roomId,P.Bx.SpaceChild,H(H({},r),{},{order:t}),e.roomId)}}t&&(c=(0,h.$9)(t))}const u=i.currentState.getStateEvents(P.Bx.SpaceChild,this.roomId),m=null!==(t=null==u?void 0:u.getContent())&&void 0!==t?t:{via:[this.client.getDomain()]};await this.client.sendStateEvent(i.roomId,P.Bx.SpaceChild,H(H({},m),{},{order:c}),this.roomId)}async createFile(e,t,i,n){var r;const{content_uri:s}=await this.client.uploadContent(t,{includeFilename:!1});i.url=s;const o={msgtype:P.Wr.File,body:e,url:s,file:i};(n=null!==(r=n)&&void 0!==r?r:{})["m.new_content"]&&(n["m.new_content"]=o);const a=await this.client.sendMessage(this.roomId,H(H(H({},n),o),{},{[P.ID.name]:{}}));return await this.client.sendStateEvent(this.roomId,P.iK.name,{active:!0,name:e},a.event_id),a}getFile(e){const t=this.room.currentState.getStateEvents(P.iK.name,e);return t?new q(this.client,t,this):null}listFiles(){return this.listAllFiles().filter((e=>e.isActive))}listAllFiles(){var e;return(null!==(e=this.room.currentState.getStateEvents(P.iK.name))&&void 0!==e?e:[]).map((e=>new q(this.client,e,this)))}}var Y=i("./node_modules/matrix-js-sdk/src/@types/search.ts"),X=i("./node_modules/matrix-js-sdk/src/@types/PushRules.ts"),Z=i("./node_modules/matrix-js-sdk/src/webrtc/groupCall.ts"),ee=i("./node_modules/matrix-js-sdk/src/webrtc/mediaHandler.ts"),te=i("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),ie=i("./node_modules/matrix-js-sdk/src/@types/read_receipts.ts"),ne=i("./node_modules/matrix-js-sdk/src/sliding-sync-sdk.ts"),re=i("./node_modules/matrix-js-sdk/src/models/thread.ts"),se=i("./node_modules/matrix-js-sdk/src/@types/beacon.ts"),oe=i("./node_modules/matrix-js-sdk/src/NamespacedValue.ts"),ae=i("./node_modules/matrix-js-sdk/src/scheduler.ts");class ce{constructor(e){this.client=e,(0,r.A)(this,"sending",!1),(0,r.A)(this,"running",!0),(0,r.A)(this,"retryTimeout",null),(0,r.A)(this,"retryAttempts",0),(0,r.A)(this,"sendQueue",(async()=>{if(null!==this.retryTimeout&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.sending||!this.running)return;let e;b.v.debug("Attempting to send queued to-device messages"),this.sending=!0;try{for(;this.running&&(e=await this.client.store.getOldestToDeviceBatch(),null!==e);)await this.sendBatch(e),await this.client.store.removeToDeviceBatch(e.id),this.retryAttempts=0;if(!this.running)return;b.v.debug("All queued to-device messages sent")}catch(t){++this.retryAttempts;const i=ae.b.RETRY_BACKOFF_RATELIMIT(null,this.retryAttempts,t);if(-1===i)return void(4===Math.floor(t.httpStatus/100)?(b.v.error("Fatal error when sending to-device message - dropping to-device batch!",t),await this.client.store.removeToDeviceBatch(e.id)):b.v.info("Automatic retry limit reached for to-device messages."));b.v.info(`Failed to send batch of to-device messages. Will retry in ${i}ms`,t),this.retryTimeout=setTimeout(this.sendQueue,i)}finally{this.sending=!1}})),(0,r.A)(this,"onResumedSync",((e,t)=>{e===s.Lm.Syncing&&t!==s.Lm.Syncing&&(b.v.info("Resuming queue after resumed sync"),this.sendQueue())}))}start(){this.running=!0,this.sendQueue(),this.client.on(_e.Sync,this.onResumedSync)}stop(){this.running=!1,null!==this.retryTimeout&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.client.removeListener(_e.Sync,this.onResumedSync)}async queueBatch(e){const t=[];for(let i=0;i<e.batch.length;i+=20){const n={eventType:e.eventType,batch:e.batch.slice(i,i+20),txnId:this.client.makeTxnId()};t.push(n);const r=n.batch.map((e=>`${e.userId}/${e.deviceId} (msgid ${e.payload[P.wt]})`));b.v.info(`Enqueuing batch of to-device messages. type=${e.eventType} txnid=${n.txnId}`,r)}await this.client.store.saveToDeviceBatches(t),this.sendQueue()}async sendBatch(e){const t=new h.kG((()=>new Map));for(const i of e.batch)t.getOrCreate(i.userId).set(i.deviceId,i.payload);b.v.info(`Sending batch of ${e.batch.length} to-device messages with ID ${e.id} and txnId ${e.txnId}`),await this.client.sendToDevice(e.eventType,t,e.txnId)}}var de=i("./node_modules/matrix-js-sdk/src/models/invites-ignorer.ts"),le=i("./node_modules/matrix-js-sdk/src/feature.ts");const ue="matrix-js-sdk";var he=i("./node_modules/matrix-js-sdk/src/secret-storage.ts"),me=i("./node_modules/matrix-js-sdk/src/matrixrtc/MatrixRTCSessionManager.ts");function pe(e){return t=>{var i,n,r,s;return(null===(i=t.content)||void 0===i||null===(n=i["m.relates_to"])||void 0===n?void 0:n.event_id)!==e||(null===(r=t.content)||void 0===r||null===(s=r["m.relates_to"])||void 0===s?void 0:s.rel_type)===re.RN.name}}const ge=["server","limit","since"];function ve(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function fe(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ve(Object(i),!0).forEach((function(t){(0,r.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ve(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}(0,_.DM)();const ye=6e5;new oe.qr("last_seen_user_agent","org.matrix.msc3852.last_seen_user_agent");let be=function(e){return e.Chronological="chronological",e.Detached="detached",e}({}),Se=function(e){return e.Stable="stable",e.Unstable="unstable",e}({});new oe.xu("m.get_login_token","org.matrix.msc3882.get_login_token");const we="$";let _e=function(e){return e.Sync="sync",e.Event="event",e.ToDeviceEvent="toDeviceEvent",e.AccountData="accountData",e.Room="Room",e.DeleteRoom="deleteRoom",e.SyncUnexpectedError="sync.unexpectedError",e.ClientWellKnown="WellKnown.client",e.ReceivedVoipEvent="received_voip_event",e.UndecryptableToDeviceEvent="toDeviceEvent.undecryptable",e.TurnServers="turnServers",e.TurnServersError="turnServers.error",e}({});const Ee=new oe.qr("action","org.matrix.msc3824.action");class Ie extends te.X{constructor(e){var t,i,n;super(),(0,r.A)(this,"logger",void 0),(0,r.A)(this,"reEmitter",new y.Q(this)),(0,r.A)(this,"olmVersion",null),(0,r.A)(this,"usingExternalCrypto",!1),(0,r.A)(this,"_store",void 0),(0,r.A)(this,"deviceId",void 0),(0,r.A)(this,"credentials",void 0),(0,r.A)(this,"pickleKey",void 0),(0,r.A)(this,"scheduler",void 0),(0,r.A)(this,"clientRunning",!1),(0,r.A)(this,"timelineSupport",!1),(0,r.A)(this,"urlPreviewCache",{}),(0,r.A)(this,"identityServer",void 0),(0,r.A)(this,"http",void 0),(0,r.A)(this,"crypto",void 0),(0,r.A)(this,"cryptoBackend",void 0),(0,r.A)(this,"cryptoCallbacks",void 0),(0,r.A)(this,"callEventHandler",void 0),(0,r.A)(this,"groupCallEventHandler",void 0),(0,r.A)(this,"supportsCallTransfer",!1),(0,r.A)(this,"forceTURN",!1),(0,r.A)(this,"iceCandidatePoolSize",0),(0,r.A)(this,"idBaseUrl",void 0),(0,r.A)(this,"baseUrl",void 0),(0,r.A)(this,"isVoipWithNoMediaAllowed",void 0),(0,r.A)(this,"useLivekitForGroupCalls",void 0),(0,r.A)(this,"canSupportVoip",!1),(0,r.A)(this,"peekSync",null),(0,r.A)(this,"isGuestAccount",!1),(0,r.A)(this,"ongoingScrollbacks",{}),(0,r.A)(this,"notifTimelineSet",null),(0,r.A)(this,"cryptoStore",void 0),(0,r.A)(this,"verificationMethods",void 0),(0,r.A)(this,"fallbackICEServerAllowed",!1),(0,r.A)(this,"syncApi",void 0),(0,r.A)(this,"roomNameGenerator",void 0),(0,r.A)(this,"pushRules",void 0),(0,r.A)(this,"syncLeftRoomsPromise",void 0),(0,r.A)(this,"syncedLeftRooms",!1),(0,r.A)(this,"clientOpts",void 0),(0,r.A)(this,"clientWellKnownIntervalID",void 0),(0,r.A)(this,"canResetTimelineCallback",void 0),(0,r.A)(this,"canSupport",new Map),(0,r.A)(this,"pushProcessor",new p.j(this)),(0,r.A)(this,"serverVersionsPromise",void 0),(0,r.A)(this,"cachedCapabilities",void 0),(0,r.A)(this,"clientWellKnown",void 0),(0,r.A)(this,"clientWellKnownPromise",void 0),(0,r.A)(this,"turnServers",[]),(0,r.A)(this,"turnServersExpiry",0),(0,r.A)(this,"checkTurnServersIntervalID",void 0),(0,r.A)(this,"exportedOlmDeviceToImport",void 0),(0,r.A)(this,"txnCtr",0),(0,r.A)(this,"mediaHandler",new ee.L(this)),(0,r.A)(this,"sessionId",void 0),(0,r.A)(this,"eventsBeingEncrypted",new Set),(0,r.A)(this,"useE2eForGroupCall",!0),(0,r.A)(this,"toDeviceMessageQueue",void 0),(0,r.A)(this,"livekitServiceURL",void 0),(0,r.A)(this,"_secretStorage",void 0),(0,r.A)(this,"ignoredInvites",void 0),(0,r.A)(this,"matrixRTC",void 0),(0,r.A)(this,"startCallEventHandler",(()=>{this.isInitialSyncComplete()&&((0,c.sj)()&&(this.callEventHandler.start(),this.groupCallEventHandler.start()),this.off(_e.Sync,this.startCallEventHandler))})),(0,r.A)(this,"startMatrixRTC",(()=>{this.isInitialSyncComplete()&&(this.matrixRTC.start(),this.off(_e.Sync,this.startMatrixRTC))})),(0,r.A)(this,"fixupRoomNotifications",(()=>{if(this.isInitialSyncComplete()){var e;const t=(null!==(e=this.getRooms())&&void 0!==e?e:[]).filter((e=>e.getUnreadNotificationCount(x.X5.Total)>0));for(const e of t){const t=this.getSafeUserId();e.fixupNotifications(t)}this.off(_e.Sync,this.fixupRoomNotifications)}})),this.logger=null!==(t=e.logger)&&void 0!==t?t:b.v,e.baseUrl=h.hc(e.baseUrl),e.idBaseUrl=h.hc(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer,this.usingExternalCrypto=null!==(i=e.usingExternalCrypto)&&void 0!==i&&i,this.store=e.store||new a,this.deviceId=e.deviceId||null,this.sessionId=(0,L.DU)(10);const s=e.userId||null;this.credentials={userId:s},this.http=new w.ED(this,{fetchFn:e.fetchFn,baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,refreshToken:e.refreshToken,tokenRefreshFunction:e.tokenRefreshFunction,prefix:w.iD.V3,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader,logger:this.logger}),e.deviceToImport?this.deviceId?this.logger.warn("not importing device because device ID is provided to constructor independently of exported data"):this.credentials.userId?this.logger.warn("not importing device because user ID is provided to constructor independently of exported data"):e.deviceToImport.deviceId?(this.deviceId=e.deviceToImport.deviceId,this.credentials.userId=e.deviceToImport.userId,this.exportedOlmDeviceToImport=e.deviceToImport.olmDevice):this.logger.warn("not importing device because no device ID in exported data"):e.pickleKey&&(this.pickleKey=e.pickleKey),this.useLivekitForGroupCalls=Boolean(e.useLivekitForGroupCalls),this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction((async e=>{const t=this.getRoom(e.getRoomId());e.status!==o.fb.SENDING&&this.updatePendingEventStatus(t,e,o.fb.SENDING);const i=await this.sendEventHttpRequest(e);return t&&t.updatePendingEvent(e,o.fb.SENT,i.event_id),i})),(0,c.sj)()&&(this.callEventHandler=new l.N(this),this.groupCallEventHandler=new u.e(this),this.canSupportVoip=!0,this.on(_e.Sync,this.startCallEventHandler)),this.matrixRTC=new me.I(this),this.on(_e.Sync,this.fixupRoomNotifications),this.timelineSupport=Boolean(e.timelineSupport),this.cryptoStore=e.cryptoStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=void 0===e.iceCandidatePoolSize?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.isVoipWithNoMediaAllowed=e.isVoipWithNoMediaAllowed||!1,void 0!==e.useE2eForGroupCall&&(this.useE2eForGroupCall=e.useE2eForGroupCall),this.livekitServiceURL=e.livekitServiceURL,this.roomNameGenerator=e.roomNameGenerator,this.toDeviceMessageQueue=new ce(this),this.on(o.OQ.Decrypted,(e=>{!function(e,t){var i;const n=e.getUserId(),r=t.getId(),s=e.getRoom(t.getRoomId());if(!s||!n||!r)return;if(!s.findEventById(r))return void b.v.info(`Decrypted event ${t.getId()} is not in room ${s.roomId}: ignoring`);const o=!!t.threadRootId&&!t.isThreadRoot;let a;if(o){const e=s.getThread(t.threadRootId);a=!e||e.hasUserReadEvent(n,r)}else a=s.hasUserReadEvent(n,r);if(a)return;const c=e.getPushActionsForEvent(t,!0);if(null!=c&&null!==(i=c.tweaks)&&void 0!==i&&i.highlight){const e=s.getUnreadCountForEventContext(x.X5.Highlight,t)+1;o?s.setThreadUnreadNotificationCount(t.threadRootId,x.X5.Highlight,e):s.setUnreadNotificationCount(x.X5.Highlight,e)}if(null!=c&&c.notify){const e=s.getUnreadCountForEventContext(x.X5.Total,t)+1;o?s.setThreadUnreadNotificationCount(t.threadRootId,x.X5.Total,e):s.setUnreadNotificationCount(x.X5.Total,e)}}(this,e)})),this.ignoredInvites=new de.bp(this),this._secretStorage=new he.ServerSideSecretStorageImpl(this,null!==(n=e.cryptoCallbacks)&&void 0!==n?n:{}),this.setMaxListeners(0)}set store(e){this._store=e,this._store.setUserCreator((e=>k.K.createUser(e,this)))}get store(){return this._store}async startClient(e){if(this.clientRunning)return;this.clientRunning=!0,this.on(_e.Sync,this.startMatrixRTC);const t=this.getUserId();t&&this.store.storeUser(new k.K(t)),this.canSupportVoip&&(this.checkTurnServersIntervalID=setInterval((()=>{this.checkTurnServers()}),ye),this.checkTurnServers()),this.syncApi&&(this.logger.error("Still have sync object whilst not running: stopping old one"),this.syncApi.stop());try{await this.getVersions();const{threads:e,list:t,fwdPagination:i}=await this.doesServerSupportThread();re.jV.setServerSideSupport(e),re.jV.setServerSideListSupport(t),re.jV.setServerSideFwdPaginationSupport(i)}catch(e){this.logger.error("Can't fetch server versions, continuing to initialise sync, this will be retried later",e)}this.clientOpts=null!=e?e:{},this.clientOpts.slidingSync?this.syncApi=new ne.m(this.clientOpts.slidingSync,this,this.clientOpts,this.buildSyncApiOptions()):this.syncApi=new s.w_(this,this.clientOpts,this.buildSyncApiOptions()),this.syncApi.sync().catch((e=>this.logger.info("Sync startup aborted with an error:",e))),void 0!==this.clientOpts.clientWellKnownPollPeriod&&(this.clientWellKnownIntervalID=setInterval((()=>{this.fetchClientWellKnown()}),1e3*this.clientOpts.clientWellKnownPollPeriod),this.fetchClientWellKnown()),this.toDeviceMessageQueue.start()}buildSyncApiOptions(){return{crypto:this.crypto,cryptoCallbacks:this.cryptoBackend,canResetEntireTimeline:e=>!!this.canResetTimelineCallback&&this.canResetTimelineCallback(e)}}stopClient(){var e,t,n,r,s;null===(e=this.cryptoBackend)||void 0===e||e.stop(),this.off(_e.Sync,this.startMatrixRTC),this.clientRunning&&(this.logger.debug("stopping MatrixClient"),this.clientRunning=!1,null===(t=this.syncApi)||void 0===t||t.stop(),this.syncApi=void 0,null===(n=this.peekSync)||void 0===n||n.stopPeeking(),null===(r=this.callEventHandler)||void 0===r||r.stop(),null===(s=this.groupCallEventHandler)||void 0===s||s.stop(),this.callEventHandler=void 0,this.groupCallEventHandler=void 0,i.g.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,void 0!==this.clientWellKnownIntervalID&&i.g.clearInterval(this.clientWellKnownIntervalID),this.toDeviceMessageQueue.stop(),this.matrixRTC.stop())}async rehydrateDevice(){if(this.crypto)throw new Error("Cannot rehydrate device after crypto is initialized");if(!this.cryptoCallbacks.getDehydrationKey)return;const e=await this.getDehydratedDevice();if(!e)return;if(!e.device_data||!e.device_id)return void this.logger.info("no dehydrated device found");const t=new i.g.Olm.Account;try{const i=e.device_data;if(i.algorithm!==C.S)return void this.logger.warn("Wrong algorithm for dehydrated device");this.logger.debug("unpickling dehydrated device");const n=await this.cryptoCallbacks.getDehydrationKey(i,(e=>{t.unpickle(new Uint8Array(e),i.account)}));t.unpickle(n,i.account),this.logger.debug("unpickled device");if((await this.http.authedRequest(w.IT.Post,"/dehydrated_device/claim",void 0,{device_id:e.device_id},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).success){this.deviceId=e.device_id,this.logger.info("using dehydrated device");const i=this.pickleKey||"DEFAULT_KEY";return this.exportedOlmDeviceToImport={pickledAccount:t.pickle(i),sessions:[],pickleKey:i},t.free(),this.deviceId}return t.free(),void this.logger.info("not using dehydrated device")}catch(e){t.free(),this.logger.warn("could not unpickle",e)}}async getDehydratedDevice(){try{return await this.http.authedRequest(w.IT.Get,"/dehydrated_device",void 0,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})}catch(e){return void this.logger.info("could not get dehydrated device",e)}}async setDehydrationKey(e,t,i){if(this.crypto)return this.crypto.dehydrationManager.setKeyAndQueueDehydration(e,t,i);this.logger.warn("not dehydrating device if crypto is not enabled")}async createDehydratedDevice(e,t,i){if(this.crypto)return await this.crypto.dehydrationManager.setKey(e,t,i),this.crypto.dehydrationManager.dehydrateDevice();this.logger.warn("not dehydrating device if crypto is not enabled")}async exportDevice(){if(this.crypto)return{userId:this.credentials.userId,deviceId:this.deviceId,olmDevice:await this.crypto.olmDevice.export()};this.logger.warn("not exporting device if crypto is not enabled")}clearStores(){if(this.clientRunning)throw new Error("Cannot clear stores while client is running");const e=[];e.push(this.store.deleteAllData()),this.cryptoStore&&e.push(this.cryptoStore.deleteAllData());return e.push((async()=>{let e;try{if(e=i.g.indexedDB,!e)return}catch(e){return}for(const t of[`${ue}::matrix-sdk-crypto`,`${ue}::matrix-sdk-crypto-meta`]){const i=new Promise(((i,n)=>{this.logger.info(`Removing IndexedDB instance ${t}`);const r=e.deleteDatabase(t);r.onsuccess=e=>{this.logger.info(`Removed IndexedDB instance ${t}`),i(0)},r.onerror=e=>{this.logger.warn(`Failed to remove IndexedDB instance ${t}:`,e),i(0)},r.onblocked=e=>{this.logger.info(`cannot yet remove IndexedDB instance ${t}`)}}));await i}})()),Promise.all(e).then()}getUserId(){return this.credentials&&this.credentials.userId?this.credentials.userId:null}getSafeUserId(){const e=this.getUserId();if(!e)throw new Error("Expected logged in user but found none.");return e}getDomain(){return this.credentials&&this.credentials.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){return this.credentials&&this.credentials.userId?this.credentials.userId.split(":")[0].substring(1):null}getDeviceId(){return this.deviceId}getSessionId(){return this.sessionId}supportsVoip(){return this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}getUseE2eForGroupCall(){return this.useE2eForGroupCall}createCall(e){return(0,c.sv)(this,e)}async createGroupCall(e,t,i,n,r,s){if(this.getGroupCallForRoom(e))throw new Error(`${e} already has an existing group call`);const o=this.getRoom(e);if(!o)throw new Error(`Cannot find room ${e}`);return new Z.eO(this,o,t,i,n,void 0,r||this.isVoipWithNoMediaAllowed,s,this.isVoipWithNoMediaAllowed,this.useLivekitForGroupCalls,this.livekitServiceURL).create()}getLivekitServiceURL(){return this.livekitServiceURL}setLivekitServiceURL(e){this.livekitServiceURL=e}waitUntilRoomReadyForGroupCalls(e){return this.groupCallEventHandler.waitUntilRoomReadyForGroupCalls(e)}getGroupCallForRoom(e){return this.groupCallEventHandler.groupCalls.get(e)||null}getSyncState(){var e,t;return null!==(e=null===(t=this.syncApi)||void 0===t?void 0:t.getSyncState())&&void 0!==e?e:null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){const e=this.getSyncState();return!!e&&(e===s.Lm.Prepared||e===s.Lm.Syncing)}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){var e,t;return this.toDeviceMessageQueue.sendQueue(),null!==(e=null===(t=this.syncApi)||void 0===t?void 0:t.retryImmediately())&&void 0!==e&&e}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(e=!1){const t=(new Date).getTime();return this.cachedCapabilities&&!e&&t<this.cachedCapabilities.expiration?(this.logger.debug("Returning cached capabilities"),Promise.resolve(this.cachedCapabilities.capabilities)):this.http.authedRequest(w.IT.Get,"/capabilities").catch((e=>(this.logger.error(e),{}))).then(((e={})=>{const i=e.capabilities||{},n=Object.keys(i).length?216e5:6e4+5e3*Math.random();return this.cachedCapabilities={capabilities:i,expiration:t+n},this.logger.debug("Caching capabilities: ",i),i}))}async initCrypto(){if(!(0,_.DM)())throw new Error("End-to-end encryption not supported in this js-sdk build: did you remember to load the olm library?");if(this.cryptoBackend)return void this.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");if(!this.cryptoStore)throw new Error("Cannot enable encryption: no cryptoStore provided");this.logger.debug("Crypto: Starting up crypto store..."),await this.cryptoStore.startup();const e=this.getUserId();if(null===e)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");if(null===this.deviceId)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");const t=new _.Qr(this,e,this.deviceId,this.store,this.cryptoStore,this.verificationMethods);this.reEmitter.reEmit(t,[_.cr.KeyBackupFailed,_.cr.KeyBackupSessionsRemaining,_.cr.RoomKeyRequest,_.cr.RoomKeyRequestCancellation,_.cr.Warning,_.cr.DevicesUpdated,_.cr.WillUpdateDevices,_.cr.DeviceVerificationChanged,_.cr.UserTrustStatusChanged,_.cr.KeysChanged]),this.logger.debug("Crypto: initialising crypto object..."),await t.init({exportedOlmDevice:this.exportedOlmDeviceToImport,pickleKey:this.pickleKey}),delete this.exportedOlmDeviceToImport,this.olmVersion=_.Qr.getOlmVersion(),t.registerEventHandlers(this),this.cryptoBackend=this.crypto=t,this.crypto.uploadDeviceKeys().catch((e=>{this.logger.error("Error uploading device keys",e)}))}async initRustCrypto(e={}){var t,n;if(this.cryptoBackend)return void this.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");const r=this.getUserId();if(null===r)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");const s=this.getDeviceId();if(null===s)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");this.logger.debug("Downloading Rust crypto library");const o=await i.e(5484).then(i.bind(i,"./node_modules/matrix-js-sdk/src/rust-crypto/index.ts")),a=await o.initRustCrypto({logger:this.logger,http:this.http,userId:r,deviceId:s,secretStorage:this.secretStorage,cryptoCallbacks:this.cryptoCallbacks,storePrefix:!1===e.useIndexedDB?null:ue,storeKey:e.storageKey,storePassphrase:null!==(t=e.storagePassword)&&void 0!==t?t:this.pickleKey,legacyCryptoStore:this.cryptoStore,legacyPickleKey:null!==(n=this.pickleKey)&&void 0!==n?n:"DEFAULT_KEY",legacyMigrationProgressListener:(e,t)=>{this.emit(_.cr.LegacyCryptoStoreMigrationProgress,e,t)}});a.setSupportedVerificationMethods(this.verificationMethods),this.cryptoBackend=a,this.on(M.o.Membership,a.onRoomMembership.bind(a)),this.on(_e.Event,(e=>{a.onLiveEventFromSync(e)})),this.reEmitter.reEmit(a,[_.cr.VerificationRequestReceived,_.cr.UserTrustStatusChanged,_.cr.KeyBackupStatus,_.cr.KeyBackupSessionsRemaining,_.cr.KeyBackupFailed,_.cr.KeyBackupDecryptionKeyCached,_.cr.KeysChanged,_.cr.DevicesUpdated,_.cr.WillUpdateDevices])}get secretStorage(){return this._secretStorage}getCrypto(){return this.cryptoBackend}isCryptoEnabled(){return!!this.cryptoBackend}getDeviceEd25519Key(){var e,t;return null!==(e=null===(t=this.crypto)||void 0===t?void 0:t.getDeviceEd25519Key())&&void 0!==e?e:null}getDeviceCurve25519Key(){var e,t;return null!==(e=null===(t=this.crypto)||void 0===t?void 0:t.getDeviceCurve25519Key())&&void 0!==e?e:null}async uploadKeys(){this.logger.warn("MatrixClient.uploadKeys is deprecated")}downloadKeys(e,t){return this.crypto?this.crypto.downloadKeys(e,t):Promise.reject(new Error("End-to-end encryption disabled"))}getStoredDevicesForUser(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevicesForUser(e)||[]}getStoredDevice(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevice(e,t)||null}setDeviceVerified(e,t,i=!0){const n=this.setDeviceVerification(e,t,i,null,null);return e==this.credentials.userId&&this.checkKeyBackup(),n}setDeviceBlocked(e,t,i=!0){return this.setDeviceVerification(e,t,null,i,null)}setDeviceKnown(e,t,i=!0){return this.setDeviceVerification(e,t,null,null,i)}async setDeviceVerification(e,t,i,n,r){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.setDeviceVerification(e,t,i,n,r)}requestVerificationDM(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerificationDM(e,t)}findVerificationRequestDMInProgress(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");if(this.crypto)return this.crypto.findVerificationRequestDMInProgress(e)}getVerificationRequestsToDeviceInProgress(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getVerificationRequestsToDeviceInProgress(e)}requestVerification(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerification(e,t)}beginKeyVerification(e,t,i){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.beginKeyVerification(e,t,i)}checkSecretStorageKey(e,t){return this.secretStorage.checkKey(e,t)}setGlobalBlacklistUnverifiedDevices(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalBlacklistUnverifiedDevices=e,e}getGlobalBlacklistUnverifiedDevices(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalBlacklistUnverifiedDevices}setGlobalErrorOnUnknownDevices(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");this.cryptoBackend.globalErrorOnUnknownDevices=e}getGlobalErrorOnUnknownDevices(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalErrorOnUnknownDevices}getCrossSigningId(e=A.n.Master){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getCrossSigningId(e)}getStoredCrossSigningForUser(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.getStoredCrossSigningForUser(e)}checkUserTrust(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.checkUserTrust(e)}checkDeviceTrust(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkDeviceTrust(e,t)}checkIfOwnDeviceCrossSigned(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkIfOwnDeviceCrossSigned(e)}checkOwnCrossSigningTrust(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.checkOwnCrossSigningTrust(e)}checkCrossSigningPrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkCrossSigningPrivateKey(e,t)}legacyDeviceVerification(e,t,i){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.legacyDeviceVerification(e,t,i)}prepareToEncrypt(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");this.cryptoBackend.prepareToEncrypt(e)}userHasCrossSigningKeys(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.userHasCrossSigningKeys()}isCrossSigningReady(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.isCrossSigningReady()}bootstrapCrossSigning(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.bootstrapCrossSigning(e)}getCryptoTrustCrossSignedDevices(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.getTrustCrossSignedDevices()}setCryptoTrustCrossSignedDevices(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");this.cryptoBackend.setTrustCrossSignedDevices(e)}countSessionsNeedingBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.countSessionsNeedingBackup()}getEventEncryptionInfo(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.getEventEncryptionInfo(e)}createRecoveryKeyFromPassphrase(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.createRecoveryKeyFromPassphrase(e)}isSecretStorageReady(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.isSecretStorageReady()}bootstrapSecretStorage(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.bootstrapSecretStorage(e)}addSecretStorageKey(e,t,i){return this.secretStorage.addKey(e,t,i)}hasSecretStorageKey(e){return this.secretStorage.hasKey(e)}storeSecret(e,t,i){return this.secretStorage.store(e,t,i)}getSecret(e){return this.secretStorage.get(e)}isSecretStored(e){return this.secretStorage.isStored(e)}requestSecret(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestSecret(e,t)}getDefaultSecretStorageKeyId(){return this.secretStorage.getDefaultKeyId()}setDefaultSecretStorageKeyId(e){return this.secretStorage.setDefaultKeyId(e)}checkSecretStoragePrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkSecretStoragePrivateKey(e,t)}async getEventSenderDeviceInfo(e){return this.crypto?this.crypto.getEventSenderDeviceInfo(e):null}async isEventSenderVerified(e){const t=await this.getEventSenderDeviceInfo(e);return!!t&&t.isVerified()}getOutgoingRoomKeyRequest(e){if(!this.crypto)throw new Error("End-to-End encryption disabled");const t=e.getWireContent(),i={session_id:t.session_id,sender_key:t.sender_key,algorithm:t.algorithm,room_id:e.getRoomId()};return i.session_id&&i.sender_key&&i.algorithm&&i.room_id?this.crypto.cryptoStore.getOutgoingRoomKeyRequest(i):Promise.resolve(null)}cancelAndResendEventRoomKeyRequest(e){if(!this.crypto)throw new Error("End-to-End encryption disabled");return e.cancelAndResendKeyRequest(this.crypto,this.getUserId())}setRoomEncryption(e,t){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.setRoomEncryption(e,t)}isRoomEncrypted(e){var t,i;const n=this.getRoom(e);return!!n&&(!!n.hasEncryptionStateEvent()||null!==(t=null===(i=this.crypto)||void 0===i?void 0:i.isRoomEncrypted(e))&&void 0!==t&&t)}encryptAndSendToDevices(e,t){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.encryptAndSendToDevices(e,t)}forceDiscardSession(e){if(!this.cryptoBackend)throw new Error("End-to-End encryption disabled");this.cryptoBackend.forceDiscardSession(e)}exportRoomKeys(){return this.cryptoBackend?this.cryptoBackend.exportRoomKeys():Promise.reject(new Error("End-to-end encryption disabled"))}importRoomKeys(e,t){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.importRoomKeys(e,t)}checkKeyBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.checkKeyBackup()}async getKeyBackupVersion(){let e;try{e=await this.http.authedRequest(w.IT.Get,"/room_keys/version",void 0,void 0,{prefix:w.iD.V3})}catch(e){if("M_NOT_FOUND"===e.errcode)return null;throw e}return N.IO.checkBackupVersion(e),e}isKeyBackupTrusted(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.isKeyBackupTrusted(e)}getKeyBackupEnabled(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.getKeyBackupEnabled()}enableKeyBackup(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.enableKeyBackup(e)}disableKeyBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto.backupManager.disableKeyBackup()}async prepareKeyBackupVersion(e,t={secureSecretStorage:!1}){if(!this.crypto)throw new Error("End-to-end encryption disabled");const{algorithm:i,auth_data:n,recovery_key:r,privateKey:s}=await this.crypto.backupManager.prepareKeyBackupVersion(e);return t.secureSecretStorage&&(await this.secretStorage.store("m.megolm_backup.v1",(0,f.WG)(s)),this.logger.info("Key backup private key stored in secret storage")),{algorithm:i,auth_data:n,recovery_key:r}}isKeyBackupKeyStored(){return Promise.resolve(this.secretStorage.isStored("m.megolm_backup.v1"))}async createKeyBackupVersion(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.backupManager.createKeyBackupVersion(e);const t={algorithm:e.algorithm,auth_data:e.auth_data};await this.crypto.signObject(t.auth_data),this.cryptoCallbacks.getCrossSigningKey&&this.crypto.crossSigningInfo.getId()&&await this.crypto.crossSigningInfo.signObject(t.auth_data,"master");const i=await this.http.authedRequest(w.IT.Post,"/room_keys/version",void 0,t);return await this.checkKeyBackup(),this.getKeyBackupEnabled()||this.logger.error("Key backup not usable even though we just created it"),i}async deleteKeyBackupVersion(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");await this.cryptoBackend.deleteKeyBackupVersion(e)}makeKeyBackupPath(e,t,i){let n;n=void 0!==t?h.RR("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):void 0!==e?h.RR("/room_keys/keys/$roomId",{$roomId:e}):"/room_keys/keys";return{path:n,queryData:void 0===i?void 0:{version:i}}}async sendKeyBackup(e,t,i,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");const r=this.makeKeyBackupPath(e,t,i);await this.http.authedRequest(w.IT.Put,r.path,r.queryData,n,{prefix:w.iD.V3})}async scheduleAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.backupManager.scheduleAllGroupSessionsForBackup()}flagAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.flagAllGroupSessionsForBackup()}isValidRecoveryKey(e){try{return(0,E.R)(e),!0}catch(e){return!1}}keyBackupKeyFromPassword(e,t){return(0,I.cE)(t.auth_data,e)}keyBackupKeyFromRecoveryKey(e){return(0,E.R)(e)}async restoreKeyBackupWithPassword(e,t,i,n,r){const s=await(0,I.cE)(n.auth_data,e);return this.restoreKeyBackup(s,t,i,n,r)}async restoreKeyBackupWithSecretStorage(e,t,i,n){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");const r=await this.secretStorage.get("m.megolm_backup.v1"),s=(0,_.D$)(r);if(s){const e=await this.secretStorage.getKey();await this.secretStorage.store("m.megolm_backup.v1",s,[e[0]])}const o=(0,f.y4)(s||r);return this.restoreKeyBackup(o,t,i,e,n)}restoreKeyBackupWithRecoveryKey(e,t,i,n,r){const s=(0,E.R)(e);return this.restoreKeyBackup(s,t,i,n,r)}async restoreKeyBackupWithCache(e,t,i,n){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");const r=await this.cryptoBackend.getSessionBackupPrivateKey();if(!r)throw new Error("Couldn't get key");return this.restoreKeyBackup(r,e,t,i,n)}async restoreKeyBackup(e,t,i,n,r){const s=null==r?void 0:r.cacheCompleteCallback,o=null==r?void 0:r.progressCallback;if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");if(!n.version)throw new Error("Backup version must be defined");const a=n.version;let c=0,d=0,l=0;const u=this.makeKeyBackupPath(t,i,a),h=await this.cryptoBackend.getBackupDecryptor(n,e),m=!h.sourceTrusted;try{if(!(e instanceof Uint8Array))throw new Error(`restoreKeyBackup expects Uint8Array, got ${e}`);this.cryptoBackend.storeSessionBackupPrivateKey(e,a).catch((e=>{this.logger.warn("Error caching session backup key:",e)})).then(s),o&&o({stage:"fetch"});const r=await this.http.authedRequest(w.IT.Get,u.path,u.queryData,void 0,{prefix:w.iD.V3});if(o&&o({stage:"load_keys"}),r.rooms)c=this.getTotalKeyCount(r),await this.handleDecryptionOfAFullBackup(r,h,200,(async e=>{try{const t=n.version;await this.cryptoBackend.importBackedUpRoomKeys(e,t,{untrusted:m}),l+=e.length}catch(t){d+=e.length,b.v.error("Error importing keys from backup",t)}o&&o({total:c,successes:l,stage:"load_keys",failures:d})}));else if(r.sessions){const e=r.sessions;c=Object.keys(e).length;const i=await h.decryptSessions(e);for(const e of i)e.room_id=t;await this.cryptoBackend.importBackedUpRoomKeys(i,a,{progressCallback:o,untrusted:m}),l=i.length}else{c=1;try{const[e]=await h.decryptSessions({[i]:r});e.room_id=t,e.session_id=i,await this.cryptoBackend.importBackedUpRoomKeys([e],a,{progressCallback:o,untrusted:m}),l=1}catch(e){this.logger.debug("Failed to decrypt megolm session from backup",e)}}}finally{h.free()}return await this.cryptoBackend.checkKeyBackupAndEnable(),{total:c,imported:l}}getTotalKeyCount(e){const t=e.rooms;let i=0;for(const e of Object.values(t))e.sessions&&(i+=Object.keys(e.sessions).length);return i}async handleDecryptionOfAFullBackup(e,t,i,n){const r=e.rooms;let s=0,o=new Map;const a=async e=>{const i=[];for(const n of e.keys()){const r=await t.decryptSessions(e.get(n));for(const e in r){const t=r[e];t.room_id=n,i.push(t)}}await n(i)};for(const[e,t]of Object.entries(r))if(t.sessions){o.set(e,{});for(const[n,r]of Object.entries(t.sessions)){o.get(e)[n]=r,s+=1,s>=i&&(await a(o),o=new Map,o.set(e,{}),s=0)}}s>0&&await a(o)}async deleteKeysFromBackup(e,t,i){if(!this.crypto)throw new Error("End-to-end encryption disabled");const n=this.makeKeyBackupPath(e,t,i);await this.http.authedRequest(w.IT.Delete,n.path,n.queryData,void 0,{prefix:w.iD.V3})}async sendSharedHistoryKeys(e,t){var i;if(!this.crypto)throw new Error("End-to-end encryption disabled");const n=null===(i=this.crypto)||void 0===i?void 0:i.getRoomEncryption(e);if(!n)return void this.logger.error("Unknown room.  Not sharing decryption keys");const r=await this.crypto.downloadKeys(t),s=new Map;for(const[e,t]of r)s.set(e,Array.from(t.values()));const o=this.crypto.getRoomDecryptor(e,n.algorithm);o.sendSharedHistoryInboundSessions?await o.sendSharedHistoryInboundSessions(s):this.logger.warn("Algorithm does not support sharing previous keys",n.algorithm)}getMediaConfig(){return this.http.authedRequest(w.IT.Get,"/config",void 0,void 0,{prefix:w.zs.V3})}getRoom(e){return e?this.store.getRoom(e):null}getRooms(){return this.store.getRooms()}getVisibleRooms(e=!1){const t=this.store.getRooms(),i=new Set;for(const r of t){var n;const t=null===(n=r.findPredecessor(e))||void 0===n?void 0:n.roomId;t&&i.add(t)}return t.filter((e=>!e.currentState.getStateEvents(P.Bx.RoomTombstone,"")||!i.has(e.roomId)))}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t){const i=h.RR("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return(0,w.Y6)(5,(()=>this.http.authedRequest(w.IT.Put,i,void 0,t)))}getAccountData(e){return this.store.getAccountData(e)}async getAccountDataFromServer(e){if(this.isInitialSyncComplete()){const t=this.store.getAccountData(e);return t?t.getContent():null}const t=h.RR("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});try{return await this.http.authedRequest(w.IT.Get,t)}catch(e){var i;if("M_NOT_FOUND"===(null===(i=e.data)||void 0===i?void 0:i.errcode))return null;throw e}}async deleteAccountData(e){const t=this.canSupport.get(le.Xj.AccountDataDeletion);if(t===le.Tj.Unsupported)return void await this.setAccountData(e,{});const i=h.RR("/user/$userId/account_data/$type",{$userId:this.getSafeUserId(),$type:e}),n=t===le.Tj.Unstable?{prefix:"/_matrix/client/unstable/org.matrix.msc3391"}:void 0;return await this.http.authedRequest(w.IT.Delete,i,void 0,void 0,n)}getIgnoredUsers(){const e=this.getAccountData("m.ignored_user_list");return e&&e.getContent()&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]}setIgnoredUsers(e){const t={ignored_users:{}};return e.forEach((e=>{t.ignored_users[e]={}})),this.setAccountData("m.ignored_user_list",t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}async joinRoom(e,t={}){void 0===t.syncRoom&&(t.syncRoom=!0);const i=this.getRoom(e);if(null!=i&&i.hasMembershipState(this.credentials.userId,G.O.Join))return i;let n=Promise.resolve();if(t.inviteSignUrl){const e=new URL(t.inviteSignUrl);e.searchParams.set("mxid",this.credentials.userId),n=this.http.requestOtherUrl(w.IT.Post,e)}const r={};t.viaServers&&(r.server_name=t.viaServers);const o={},a=await n;a&&(o.third_party_signed=a);const c=h.RR("/join/$roomid",{$roomid:e}),d=(await this.http.authedRequest(w.IT.Post,c,r,o)).room_id,l=this.getRoom(d);if(null!=l&&l.hasMembershipState(this.credentials.userId,G.O.Join))return l;const u=new s.w_(this,this.clientOpts,this.buildSyncApiOptions()).createRoom(d);return t.syncRoom,u}knockRoom(e,t={}){const i=this.getRoom(e);if(null!=i&&i.hasMembershipState(this.credentials.userId,G.O.Knock))return Promise.resolve({room_id:i.roomId});const n=h.RR("/knock/$roomIdOrAlias",{$roomIdOrAlias:e}),r={};t.viaServers&&(r.server_name=t.viaServers);const s={};return t.reason&&(s.reason=t.reason),this.http.authedRequest(w.IT.Post,n,r,s)}resendEvent(e,t){return this.toDeviceMessageQueue.sendQueue(),this.updatePendingEventStatus(t,e,o.fb.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if(![o.fb.QUEUED,o.fb.NOT_SENT,o.fb.ENCRYPTING].includes(e.status))throw new Error("cannot cancel an event with status "+e.status);e.status===o.fb.ENCRYPTING?this.eventsBeingEncrypted.delete(e.getId()):this.scheduler&&e.status===o.fb.QUEUED&&this.scheduler.removeEventFromQueue(e);const t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,o.fb.CANCELLED)}setRoomName(e,t){return this.sendStateEvent(e,P.Bx.RoomName,{name:t})}setRoomTopic(e,t,i){const n=O.makeTopicContent(t,i);return this.sendStateEvent(e,P.Bx.RoomTopic,n)}getRoomTags(e){const t=h.RR("/user/$userId/rooms/$roomId/tags",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(w.IT.Get,t)}setRoomTag(e,t,i={}){const n=h.RR("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(w.IT.Put,n,void 0,i)}deleteRoomTag(e,t){const i=h.RR("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(w.IT.Delete,i)}setRoomAccountData(e,t,i){const n=h.RR("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(w.IT.Put,n,void 0,i)}async setPowerLevel(e,t,i){var n;let r;var s,o,a;this.clientRunning&&this.isInitialSyncComplete()&&(r=null===(s=this.getRoom(e))||void 0===s||null===(o=s.currentState)||void 0===o||null===(a=o.getStateEvents(P.Bx.RoomPowerLevels,""))||void 0===a?void 0:a.getContent());if(!r)try{r=await this.getStateEvent(e,P.Bx.RoomPowerLevels,"")}catch(e){if(!(e instanceof w.up&&"M_NOT_FOUND"===e.errcode))throw e;r={}}r=h.A4(r),null!==(n=r)&&void 0!==n&&n.users||(r.users={});const c=Array.isArray(t)?t:[t];for(const e of c)null==i?delete r.users[e]:r.users[e]=i;return this.sendStateEvent(e,P.Bx.RoomPowerLevels,r,"")}async unstable_createLiveBeacon(e,t){return this.unstable_setLiveBeacon(e,t)}async unstable_setLiveBeacon(e,t){return this.sendStateEvent(e,se.E.name,t,this.getUserId())}sendEvent(e,t,i,n,r){var s;let o,a,c,d;if(null!=t&&t.startsWith(we)||null===t?(d=r,c=n,a=i,o=t):(d=n,c=i,a=t,o=null),o&&(null===(s=c["m.relates_to"])||void 0===s||!s.rel_type)){var l,u;const t=!(null===(l=c["m.relates_to"])||void 0===l||!l["m.in_reply_to"]);c["m.relates_to"]=fe(fe({},c["m.relates_to"]),{},{rel_type:re.RN.name,event_id:o,is_falling_back:!t});const i=null===(u=this.getRoom(e))||void 0===u?void 0:u.getThread(o);var h,m;if(i&&!t)c["m.relates_to"]["m.in_reply_to"]={event_id:null!==(h=null===(m=i.lastReply((e=>e.isRelation(re.RN.name)&&!e.status)))||void 0===m?void 0:m.getId())&&void 0!==h?h:o}}return this.sendCompleteEvent(e,o,{type:a,content:c},d)}sendCompleteEvent(e,t,i,n){n||(n=this.makeTxnId());const r=new o.kl(Object.assign(i,{event_id:"~"+e+":"+n,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:(new Date).getTime()})),s=this.getRoom(e),a=t?null==s?void 0:s.getThread(t):void 0;a&&r.setThread(a),this.reEmitter.reEmit(r,[o.OQ.Replaced,o.OQ.VisibilityChange]),null==s||s.reEmitter.reEmit(r,[o.OQ.BeforeRedaction]);const c=r.getAssociatedId();if(null!=c&&c.startsWith("~")){const e=null==s?void 0:s.getPendingEvents().find((e=>e.getId()===c));null==e||e.once(o.OQ.LocalEventIdReplaced,(()=>{r.updateAssociatedId(e.getId())}))}const d=r.getType();return this.logger.debug(`sendEvent of type ${d} in ${e} with txnId ${n}`),r.setTxnId(n),r.setStatus(o.fb.SENDING),null==s||s.addPendingEvent(r,n),r.status===o.fb.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(s,r)}async encryptAndSendEvent(e,t){try{let i;this.eventsBeingEncrypted.add(t.getId());try{await this.encryptEventIfNeeded(t,null!=e?e:void 0)}finally{i=!this.eventsBeingEncrypted.delete(t.getId())}if(i)return{};t.status===o.fb.ENCRYPTING&&this.updatePendingEventStatus(e,t,o.fb.SENDING);let n=null;return this.scheduler&&(n=this.scheduler.queueEvent(t),n&&this.scheduler.getQueueForEvent(t).length>1&&this.updatePendingEventStatus(e,t,o.fb.QUEUED)),n||(n=this.sendEventHttpRequest(t),e&&(n=n.then((i=>(e.updatePendingEvent(t,o.fb.SENT,i.event_id),i))))),await n}catch(i){this.logger.error("Error sending event",i);try{t.error=i,this.updatePendingEventStatus(e,t,o.fb.NOT_SENT)}catch(e){this.logger.error("Exception in error handler!",e)}throw i instanceof w.up&&(i.event=t),i}}async encryptEventIfNeeded(e,t){if(t&&await this.shouldEncryptEventForRoom(e,t)&&(this.cryptoBackend||!this.usingExternalCrypto)){if(!this.cryptoBackend)throw new Error("This room is configured to use encryption, but your client does not support encryption.");this.updatePendingEventStatus(t,e,o.fb.ENCRYPTING),await this.cryptoBackend.encryptEvent(e,t)}}async shouldEncryptEventForRoom(e,t){var i;return!e.isEncrypted()&&(e.getType()!==P.Bx.Reaction&&(!e.isRedaction()&&(!!t.hasEncryptionStateEvent()||!!await(null===(i=this.cryptoBackend)||void 0===i?void 0:i.isEncryptionEnabledInRoom(t.roomId)))))}getEncryptedIfNeededEventType(e,t){var i;return t===P.Bx.Reaction?t:null!==(i=this.getRoom(e))&&void 0!==i&&i.hasEncryptionStateEvent()?P.Bx.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,i){e?e.updatePendingEvent(t,i):t.setStatus(i)}sendEventHttpRequest(e){let t=e.getTxnId();t||(t=this.makeTxnId(),e.setTxnId(t));const i={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:t};let n;if(e.isState()){let t="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(t="/rooms/$roomId/state/$eventType/$stateKey"),n=h.RR(t,i)}else if(e.isRedaction()&&e.event.redacts){const t="/rooms/$roomId/redact/$redactsEventId/$txnId";n=h.RR(t,fe({$redactsEventId:e.event.redacts},i))}else n=h.RR("/rooms/$roomId/send/$eventType/$txnId",i);return this.http.authedRequest(w.IT.Put,n,void 0,e.getWireContent()).then((t=>(this.logger.debug(`Event sent to ${e.getRoomId()} with event id ${t.event_id}`),t)))}redactEvent(e,t,i,n,r){var s,o,a;null!==(s=i)&&void 0!==s&&s.startsWith(we)||(r=n,n=i,i=t,t=null);const c={reason:null===(o=r)||void 0===o?void 0:o.reason};if(void 0!==(null===(a=r)||void 0===a?void 0:a.with_rel_types)){if(this.canSupport.get(le.Xj.RelationBasedRedactions)===le.Tj.Unsupported)throw new Error(`Server does not support relation based redactions roomId ${e} eventId ${i} txnId: ${n} threadId ${t}`);c[this.canSupport.get(le.Xj.RelationBasedRedactions)===le.Tj.Stable?P.Z3.stable:P.Z3.unstable]=r.with_rel_types}return this.sendCompleteEvent(e,t,{type:P.Bx.RoomRedaction,content:c,redacts:i},n)}sendMessage(e,t,i,n){"string"!=typeof t&&null!==t&&(n=i,i=t,t=null);const r=P.Bx.RoomMessage,s=i;return this.sendEvent(e,t,r,s,n)}sendTextMessage(e,t,i,n){var r;null!==(r=t)&&void 0!==r&&r.startsWith(we)||null===t||(n=i,i=t,t=null);const s=O.makeTextMessage(i);return this.sendMessage(e,t,s,n)}sendNotice(e,t,i,n){var r;null!==(r=t)&&void 0!==r&&r.startsWith(we)||null===t||(n=i,i=t,t=null);const s=O.makeNotice(i);return this.sendMessage(e,t,s,n)}sendEmoteMessage(e,t,i,n){var r;null!==(r=t)&&void 0!==r&&r.startsWith(we)||null===t||(n=i,i=t,t=null);const s=O.makeEmoteMessage(i);return this.sendMessage(e,t,s,n)}sendImageMessage(e,t,i,n,r="Image"){var s;null!==(s=t)&&void 0!==s&&s.startsWith(we)||null===t||(r=n||"Image",n=i,i=t,t=null);const o={msgtype:P.Wr.Image,url:i,info:n,body:r};return this.sendMessage(e,t,o)}sendStickerMessage(e,t,i,n,r="Sticker"){var s;null!==(s=t)&&void 0!==s&&s.startsWith(we)||null===t||(r=n||"Sticker",n=i,i=t,t=null);const o={url:i,info:n,body:r};return this.sendEvent(e,t,P.Bx.Sticker,o)}sendHtmlMessage(e,t,i,n){var r;null!==(r=t)&&void 0!==r&&r.startsWith(we)||null===t||(n=i,i=t,t=null);const s=O.makeHtmlMessage(i,n);return this.sendMessage(e,t,s)}sendHtmlNotice(e,t,i,n){var r;null!==(r=t)&&void 0!==r&&r.startsWith(we)||null===t||(n=i,i=t,t=null);const s=O.makeHtmlNotice(i,n);return this.sendMessage(e,t,s)}sendHtmlEmote(e,t,i,n){var r;null!==(r=t)&&void 0!==r&&r.startsWith(we)||null===t||(n=i,i=t,t=null);const s=O.makeHtmlEmote(i,n);return this.sendMessage(e,t,s)}async sendReceipt(e,t,i,n=!1){if(this.isGuest())return Promise.resolve({});const r=h.RR("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),s=!n&&this.supportsThreads()?fe(fe({},i),{},{thread_id:ke(e)}):i,o=this.http.authedRequest(w.IT.Post,r,void 0,s||{}),a=this.getRoom(e.getRoomId());return a&&this.credentials.userId&&a.addLocalEchoReceipt(this.credentials.userId,e,t,n),o}async sendReadReceipt(e,t=ie.L.Read,i=!1){if(!e)return;const n=e.getId(),r=this.getRoom(e.getRoomId());if(null!=r&&r.hasPendingEvent(n))throw new Error(`Cannot set read receipt to a pending event (${n})`);return this.sendReceipt(e,t,{},i)}async setRoomReadMarkers(e,t,i,n){const r=this.getRoom(e);if(null!=r&&r.hasPendingEvent(t))throw new Error(`Cannot set read marker to a pending event (${t})`);let s,o;if(i){if(s=i.getId(),null!=r&&r.hasPendingEvent(s))throw new Error(`Cannot set read receipt to a pending event (${s})`);null==r||r.addLocalEchoReceipt(this.credentials.userId,i,ie.L.Read)}if(n){if(o=n.getId(),null!=r&&r.hasPendingEvent(o))throw new Error(`Cannot set read receipt to a pending event (${o})`);null==r||r.addLocalEchoReceipt(this.credentials.userId,n,ie.L.ReadPrivate)}return await this.setRoomReadMarkersHttpRequest(e,t,s,o)}getUrlPreview(e,t){t=6e4*Math.floor(t/6e4);const i=new URL(e);i.hash="";const n=t+"_"+(e=i.toString());if(n in this.urlPreviewCache)return this.urlPreviewCache[n];const r=this.http.authedRequest(w.IT.Get,"/preview_url",{url:e,ts:t.toString()},void 0,{prefix:w.zs.V3,priority:"low"});return this.urlPreviewCache[n]=r,r}sendTyping(e,t,i){if(this.isGuest())return Promise.resolve({});const n=h.RR("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.getUserId()}),r={typing:t};return t&&(r.timeout=i||2e4),this.http.authedRequest(w.IT.Put,n,void 0,r)}getRoomUpgradeHistory(e,t=!1,i=!1){const n=this.getRoom(e);if(!n)return[];return[...this.findPredecessorRooms(n,t,i),n,...this.findSuccessorRooms(n,t,i)]}findPredecessorRooms(e,t,i){var n;const r=[];let s=null===(n=e.findPredecessor(i))||void 0===n?void 0:n.roomId;for(;null!==s;){var o;const n=this.getRoom(s);if(null===n)break;if(t){const t=n.currentState.getStateEvents(P.Bx.RoomTombstone,"");if(!t||t.getContent().replacement_room!==e.roomId)break}r.splice(0,0,n),s=null===(o=(e=n).findPredecessor(i))||void 0===o?void 0:o.roomId}return r}findSuccessorRooms(e,t,i){const n=[];let r=e.currentState.getStateEvents(P.Bx.RoomTombstone,"");for(;r;){const o=this.getRoom(r.getContent().replacement_room);if(!o)break;if(o.roomId===e.roomId)break;if(t){var s;const t=null===(s=o.findPredecessor(i))||void 0===s?void 0:s.roomId;if(!t||t!==e.roomId)break}n.push(o);if(new Set(n.map((e=>e.roomId))).size<n.length)return n.slice(0,n.length-1);r=(e=o).currentState.getStateEvents(P.Bx.RoomTombstone,"")}return n}invite(e,t,i){return this.membershipChange(e,t,G.O.Invite,i)}inviteByEmail(e,t){return this.inviteByThreePid(e,"email",t)}async inviteByThreePid(e,t,i){var n;const r=h.RR("/rooms/$roomId/invite",{$roomId:e}),s=this.getIdentityServerUrl(!0);if(!s)return Promise.reject(new w.up({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));const o={id_server:s,medium:t,address:i};if(null!==(n=this.identityServer)&&void 0!==n&&n.getAccessToken){const e=await this.identityServer.getAccessToken();e&&(o.id_access_token=e)}return this.http.authedRequest(w.IT.Post,r,void 0,o)}leave(e){return this.membershipChange(e,void 0,G.O.Leave)}leaveRoomChain(e,t=!0){const i=this.getRoomUpgradeHistory(e);let n=i;if(!t){n=[];for(const t of i)if(n.push(t),t.roomId===e)break}const r={},s=[],o=e=>this.leave(e).then((()=>{delete r[e]})).catch((t=>{r[e]=t}));for(const e of n)s.push(o(e.roomId));return Promise.all(s).then((()=>r))}ban(e,t,i){return this.membershipChange(e,t,G.O.Ban,i)}forget(e,t=!0){const i=this.membershipChange(e,void 0,"forget");return t?i.then((t=>(this.store.removeRoom(e),this.emit(_e.DeleteRoom,e),t))):i}unban(e,t){const i=h.RR("/rooms/$roomId/unban",{$roomId:e}),n={user_id:t};return this.http.authedRequest(w.IT.Post,i,void 0,n)}kick(e,t,i){const n=h.RR("/rooms/$roomId/kick",{$roomId:e}),r={user_id:t,reason:i};return this.http.authedRequest(w.IT.Post,n,void 0,r)}membershipChange(e,t,i,n){const r=h.RR("/rooms/$room_id/$membership",{$room_id:e,$membership:i});return this.http.authedRequest(w.IT.Post,r,void 0,{user_id:t,reason:n})}getPushActionsForEvent(e,t=!1){if(!e.getPushActions()||t){const{actions:t,rule:i}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(t,i)}return e.getPushActions()}getPushDetailsForEvent(e,t=!1){if(!e.getPushDetails()||t){const{actions:t,rule:i}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(t,i)}return e.getPushDetails()}setProfileInfo(e,t){const i=h.RR("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(w.IT.Put,i,void 0,t)}async setDisplayName(e){const t=await this.setProfileInfo("displayname",{displayname:e}),i=this.getUser(this.getUserId());return i&&(i.displayName=e,i.emit(k.U.DisplayName,i.events.presence,i)),t}async setAvatarUrl(e){const t=await this.setProfileInfo("avatar_url",{avatar_url:e}),i=this.getUser(this.getUserId());return i&&(i.avatarUrl=e,i.emit(k.U.AvatarUrl,i.events.presence,i)),t}mxcUrlToHttp(e,t,i,n,r,s,o){return(0,R.y)(this.baseUrl,e,t,i,n,r,s,o)}async setSyncPresence(e){var t;null===(t=this.syncApi)||void 0===t||t.setPresence(e)}async setPresence(e){const t=h.RR("/presence/$userId/status",{$userId:this.credentials.userId});if(-1===["offline","online","unavailable"].indexOf(e.presence))throw new Error("Bad presence value: "+e.presence);await this.http.authedRequest(w.IT.Put,t,void 0,e)}getPresence(e){const t=h.RR("/presence/$userId/status",{$userId:e});return this.http.authedRequest(w.IT.Get,t)}scrollback(e,t=30){let i=0,n=this.ongoingScrollbacks[e.roomId]||{};if(n.promise)return n.promise;if(n.errorTs){const e=Date.now()-n.errorTs;i=Math.max(3e3-e,0)}if(null===e.oldState.paginationToken)return Promise.resolve(e);const r=this.store.scrollback(e,t).length;if(r===t)return Promise.resolve(e);t-=r;const s=new Promise(((n,r)=>{(0,h.yy)(i).then((()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,m.O.Backward))).then((t=>{var i,r;const s=t.chunk.map(this.getEventMapper());if(t.state){const i=t.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(i)}const[o,a,c]=e.partitionThreadedEvents(s);this.processAggregatedTimelineEvents(e,o),e.addEventsToTimeline(o,!0,e.getLiveTimeline()),this.processThreadEvents(e,a,!0),c.forEach((t=>e.relations.aggregateChildEvent(t))),e.oldState.paginationToken=null!==(i=t.end)&&void 0!==i?i:null,0===t.chunk.length&&(e.oldState.paginationToken=null),this.store.storeEvents(e,s,null!==(r=t.end)&&void 0!==r?r:null,!0),delete this.ongoingScrollbacks[e.roomId],n(e)})).catch((t=>{this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},r(t)}))}));return n={promise:s},this.ongoingScrollbacks[e.roomId]=n,s}getEventMapper(e){return function(e,t){let i=Boolean(t.preventReEmit);const n=!1!==t.decrypt;return function r(s){t.toDevice&&delete s.room_id;const a=e.getRoom(s.room_id);let c;a&&void 0===s.state_key&&(c=a.findEventById(s.event_id)),!c||c.status?c=new o.kl(s):(c.setUnsigned(U(U({},c.getUnsigned()),s.unsigned)),i=!0);const d=c.getServerAggregatedRelation(P.zZ.Replace);if(null!=d&&d.content){const e=r(d);c.makeReplaced(e)}const l=null==a?void 0:a.findThreadForEvent(c);return l&&c.setThread(l),c.isEncrypted()&&(i||e.reEmitter.reEmit(c,[o.OQ.Decrypted]),n&&e.decryptEventIfNeeded(c)),i||(e.reEmitter.reEmit(c,[o.OQ.Replaced,o.OQ.VisibilityChange]),null==a||a.reEmitter.reEmit(c,[o.OQ.BeforeRedaction])),c}}(this,e||{})}async getEventTimeline(e,t){var i,n,r,s;if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(null==e||!e.room)throw new Error("getEventTimeline only supports room timelines");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);if(e.thread&&this.supportsThreads())return this.getThreadTimeline(e,t);const o=h.RR("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t});let a;null!==(i=this.clientOpts)&&void 0!==i&&i.lazyLoadMembers&&(a={filter:JSON.stringify(d.d.LAZY_LOADING_MESSAGES_FILTER)});const c=await this.http.authedRequest(w.IT.Get,o,a);if(!c.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);const l=this.getEventMapper(),u=l(c.event);if(u.isRelation(re.RN.name))return void this.logger.warn("Tried loading a regular timeline at the position of a thread event");const p=[...c.events_after.reverse().map(l),u,...c.events_before.map(l)];let g=e.getTimelineForEvent(p[0].getId());g?g.getState(m.q.BACKWARDS).setUnknownStateEvents(c.state.map(l)):(g=e.addTimeline(),g.initialiseState(c.state.map(l)),g.getState(m.q.FORWARDS).paginationToken=c.end);const[v,f,y]=e.room.partitionThreadedEvents(p);return e.addEventsToTimeline(v,!0,g,c.start),this.processThreadEvents(e.room,f,!0),this.processAggregatedTimelineEvents(e.room,v),y.forEach((t=>e.relations.aggregateChildEvent(t))),null!==(n=null!==(r=e.getTimelineForEvent(t))&&void 0!==r?r:null===(s=e.room.findThreadForEvent(u))||void 0===s?void 0:s.liveTimeline)&&void 0!==n?n:g}async getThreadTimeline(e,t){var i;if(!this.supportsThreads())throw new Error("could not get thread timeline: no client support");if(!e.room)throw new Error("could not get thread timeline: not a room timeline");if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");const n=h.RR("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),r={limit:"0"};null!==(i=this.clientOpts)&&void 0!==i&&i.lazyLoadMembers&&(r.filter=JSON.stringify(d.d.LAZY_LOADING_MESSAGES_FILTER));const s=await this.http.authedRequest(w.IT.Get,n,r),o=this.getEventMapper(),a=o(s.event);if(!e.canContain(a))return;const c=this.canSupport.get(le.Xj.RelationsRecursion)!==le.Tj.Unsupported;if(re.jV.hasServerSideSupport){if(re.jV.hasServerSideFwdPaginationSupport){var l,u,p;if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");const i=e.thread,n=await this.fetchRelations(e.room.roomId,i.id,null,null,{dir:m.O.Backward,from:s.start,recurse:c||void 0}),r=await this.fetchRelations(e.room.roomId,i.id,null,null,{dir:m.O.Forward,from:s.end,recurse:c||void 0}),d=[...r.chunk.reverse().filter(pe(i.id)).map(o),a,...n.chunk.filter(pe(i.id)).map(o)];for(const t of d){var g;await(null===(g=e.thread)||void 0===g?void 0:g.processEvent(t))}let h=e.getTimelineForEvent(a.getId());if(h?h.getState(m.q.BACKWARDS).setUnknownStateEvents(s.state.map(o)):(h=e.addTimeline(),h.initialiseState(s.state.map(o))),e.addEventsToTimeline(d,!0,h,r.next_batch),!n.next_batch){const t=await this.fetchRoomEvent(e.room.roomId,i.id);e.addEventsToTimeline([o(t)],!0,h,null)}return h.setPaginationToken(null!==(l=n.next_batch)&&void 0!==l?l:null,m.O.Backward),h.setPaginationToken(null!==(u=r.next_batch)&&void 0!==u?u:null,m.O.Forward),this.processAggregatedTimelineEvents(e.room,d),null!==(p=e.getTimelineForEvent(t))&&void 0!==p?p:h}{var v;const t=e.thread,i=await this.fetchRelations(e.room.roomId,t.id,re.RN.name,null,{dir:m.O.Backward,from:s.start,recurse:c||void 0}),n=[];let r=s.end;for(;r;){var f;const i=await this.fetchRelations(e.room.roomId,t.id,re.RN.name,null,{dir:m.O.Forward,from:r,recurse:c||void 0});r=null!==(f=i.next_batch)&&void 0!==f?f:null,n.push(...i.chunk)}const d=[...n.reverse().map(o),a,...i.chunk.map(o)];for(const t of d){var y;await(null===(y=e.thread)||void 0===y?void 0:y.processEvent(t))}const l=e.getLiveTimeline();if(l.getState(m.q.BACKWARDS).setUnknownStateEvents(s.state.map(o)),e.addEventsToTimeline(d,!0,l,null),!i.next_batch){const i=await this.fetchRoomEvent(e.room.roomId,t.id);e.addEventsToTimeline([o(i)],!0,l,null)}return l.setPaginationToken(null!==(v=i.next_batch)&&void 0!==v?v:null,m.O.Backward),l.setPaginationToken(null,m.O.Forward),this.processAggregatedTimelineEvents(e.room,d),l}}}async getLatestTimeline(e){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!e.room)throw new Error("getLatestTimeline only supports room timelines");let t;if(null!==e.threadListType){var i;t=null===(i=(await this.createThreadListMessagesRequest(e.room.roomId,null,1,m.O.Backward,e.threadListType,e.getFilter())).chunk)||void 0===i?void 0:i[0]}else if(e.thread&&re.jV.hasServerSideSupport){var n;const i=this.canSupport.get(le.Xj.RelationsRecursion)!==le.Tj.Unsupported;t=null===(n=(await this.fetchRelations(e.room.roomId,e.thread.id,re.RN.name,null,{dir:m.O.Backward,limit:1,recurse:i||void 0})).chunk)||void 0===n?void 0:n[0]}else{var r,s;const i=h.RR("/rooms/$roomId/messages",{$roomId:e.room.roomId}),n={dir:"b"};null!==(r=this.clientOpts)&&void 0!==r&&r.lazyLoadMembers&&(n.filter=JSON.stringify(d.d.LAZY_LOADING_MESSAGES_FILTER));t=null===(s=(await this.http.authedRequest(w.IT.Get,i,n)).chunk)||void 0===s?void 0:s[0]}if(!t)throw new Error("No message returned when trying to construct getLatestTimeline");return this.getEventTimeline(e,t.event_id)}createMessagesRequest(e,t,i=30,n,r){var s;const o=h.RR("/rooms/$roomId/messages",{$roomId:e}),a={limit:i.toString(),dir:n};t&&(a.from=t);let c=null;var l;(null!==(s=this.clientOpts)&&void 0!==s&&s.lazyLoadMembers&&(c=Object.assign({},d.d.LAZY_LOADING_MESSAGES_FILTER)),r)&&(c=c||{},Object.assign(c,null===(l=r.getRoomTimelineFilterComponent())||void 0===l?void 0:l.toJSON()));return c&&(a.filter=JSON.stringify(c)),this.http.authedRequest(w.IT.Get,o,a)}createThreadListMessagesRequest(e,t,i=30,n=m.O.Backward,r=re.x3.All,s){var o;const a=h.RR("/rooms/$roomId/threads",{$roomId:e}),c={limit:i.toString(),dir:n,include:(0,re.UR)(r)};t&&(c.from=t);let l={};var u;(null!==(o=this.clientOpts)&&void 0!==o&&o.lazyLoadMembers&&(l=fe({},d.d.LAZY_LOADING_MESSAGES_FILTER)),s)&&(l=fe(fe({},l),null===(u=s.getRoomTimelineFilterComponent())||void 0===u?void 0:u.toJSON()));Object.keys(l).length&&(c.filter=JSON.stringify(l));const p={prefix:re.jV.hasServerSideListSupport===re.c1.Stable?w.iD.V1:"/_matrix/client/unstable/org.matrix.msc3856"};return this.http.authedRequest(w.IT.Get,a,c,void 0,p).then((e=>{var t;return fe(fe({},e),{},{chunk:null===(t=e.chunk)||void 0===t?void 0:t.reverse(),start:e.prev_batch,end:e.next_batch})}))}paginateEventTimeline(e,t){const i=e.getTimelineSet()===this.notifTimelineSet,n=this.getRoom(e.getRoomId()),r=e.getTimelineSet().threadListType,s=e.getTimelineSet().thread,o=(t=t||{}).backwards||!1;if(i&&!o)throw new Error("paginateNotifTimeline can only paginate backwards");const a=o?m.q.BACKWARDS:m.q.FORWARDS,c=e.getPaginationToken(a),d=e.paginationRequests[a];if(d)return d;let l,u,p;var g;if(i)l="/notifications",u={limit:(null!==(g=t.limit)&&void 0!==g?g:30).toString(),only:"highlight"},c&&"end"!==c&&(u.from=c),p=this.http.authedRequest(w.IT.Get,"/notifications",u).then((async t=>{const i=t.next_token,n=[];t.notifications=t.notifications.filter(h.O5);for(let e=0;e<t.notifications.length;e++){const i=t.notifications[e],r=this.getEventMapper()(i.event);this.getPushDetailsForEvent(r,!0),r.event.room_id=i.room_id,n[e]=r}const r=e.getTimelineSet();return r.addEventsToTimeline(n,o,e,i),this.processAggregatedTimelineEvents(r.room,n),o&&!t.next_token&&e.setPaginationToken(null,a),Boolean(t.next_token)})).finally((()=>{e.paginationRequests[a]=null})),e.paginationRequests[a]=p;else if(null!==r){if(!n)throw new Error("Unknown room "+e.getRoomId());if(!re.jV.hasServerSideFwdPaginationSupport&&a===m.O.Forward)throw new Error("Cannot paginate threads forwards without server-side support for MSC 3715");p=this.createThreadListMessagesRequest(e.getRoomId(),c,t.limit,a,r,e.getFilter()).then((t=>{if(t.state){const i=e.getState(a),n=t.state.filter(h.O5).map(this.getEventMapper());i.setUnknownStateEvents(n)}const i=t.end,r=t.chunk.filter(h.O5).map(this.getEventMapper());return e.getTimelineSet().addEventsToTimeline(r,o,e,i),this.processAggregatedTimelineEvents(n,r),this.processThreadRoots(n,r,o),o&&t.end==t.start&&e.setPaginationToken(null,a),t.end!==t.start})).finally((()=>{e.paginationRequests[a]=null})),e.paginationRequests[a]=p}else if(s){var v,f;const i=this.getRoom(null!==(v=e.getRoomId())&&void 0!==v?v:void 0);if(!i)throw new Error("Unknown room "+e.getRoomId());const n=this.canSupport.get(le.Xj.RelationsRecursion)!==le.Tj.Unsupported;p=this.fetchRelations(null!==(f=e.getRoomId())&&void 0!==f?f:"",s.id,null,null,{dir:a,limit:t.limit,from:null!=c?c:void 0,recurse:n||void 0}).then((async t=>{const n=this.getEventMapper(),r=t.chunk.filter(h.O5).filter(pe(s.id)).map(n);for(const e of r.slice().reverse()){await(null==s?void 0:s.processEvent(e));const t=e.getSender();o&&null!==(null==s?void 0:s.getEventReadUpTo(t))||i.addLocalEchoReceipt(t,e,ie.L.Read)}const c=t.next_batch,d=e.getTimelineSet();if(d.addEventsToTimeline(r,o,e,null!=c?c:null),!c&&o){var l,u;const t=null!==(l=s.rootEvent)&&void 0!==l?l:n(await this.fetchRoomEvent(null!==(u=e.getRoomId())&&void 0!==u?u:"",s.id));d.addEventsToTimeline([t],!0,e,null)}return this.processAggregatedTimelineEvents(d.room,r),o&&!c&&e.setPaginationToken(null,a),Boolean(c)})).finally((()=>{e.paginationRequests[a]=null})),e.paginationRequests[a]=p}else{if(!n)throw new Error("Unknown room "+e.getRoomId());p=this.createMessagesRequest(e.getRoomId(),c,t.limit,a,e.getFilter()).then((t=>{if(t.state){const i=e.getState(a),n=t.state.filter(h.O5).map(this.getEventMapper());i.setUnknownStateEvents(n)}const i=t.end,r=t.chunk.filter(h.O5).map(this.getEventMapper()),s=e.getTimelineSet(),[c,,d]=n.partitionThreadedEvents(r);s.addEventsToTimeline(c,o,e,i),this.processAggregatedTimelineEvents(n,c),this.processThreadRoots(n,c.filter((e=>e.getServerAggregatedRelation(re.RN.name))),!1),d.forEach((e=>n.relations.aggregateChildEvent(e)));const l=void 0===t.end||t.end===t.start;return o&&l&&e.setPaginationToken(null,a),!l})).finally((()=>{e.paginationRequests[a]=null})),e.paginationRequests[a]=p}return p}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end")}peekInRoom(e){var t;return null===(t=this.peekSync)||void 0===t||t.stopPeeking(),this.peekSync=new s.w_(this,this.clientOpts,this.buildSyncApiOptions()),this.peekSync.peek(e)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){const i=this.sendStateEvent(e,P.Bx.RoomGuestAccess,{guest_access:t.allowJoin?j.rF.CanJoin:j.rF.Forbidden},"");let n=Promise.resolve();return t.allowRead&&(n=this.sendStateEvent(e,P.Bx.RoomHistoryVisibility,{history_visibility:j.Jv.WorldReadable},"")),Promise.all([n,i]).then()}requestRegisterEmailToken(e,t,i,n){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:i,next_link:n})}requestRegisterMsisdnToken(e,t,i,n,r){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:i,send_attempt:n,next_link:r})}requestAdd3pidEmailToken(e,t,i,n){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:i,next_link:n})}requestAdd3pidMsisdnToken(e,t,i,n,r){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:i,send_attempt:n,next_link:r})}requestPasswordEmailToken(e,t,i,n){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:i,next_link:n})}requestPasswordMsisdnToken(e,t,i,n,r){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:i,send_attempt:n,next_link:r})}async requestTokenFromEndpoint(e,t){const i=Object.assign({},t);return this.http.request(w.IT.Post,e,void 0,i)}getRoomPushRule(e,t){var i,n;if(this.pushRules)return null===(i=this.pushRules[e])||void 0===i||null===(n=i.room)||void 0===n?void 0:n.find((e=>e.rule_id===t));throw new Error("SyncApi.sync() must be done before accessing to push rules.")}setRoomMutePushRule(e,t,i){let n,r=!1;const s=this.getRoomPushRule(e,t);if(null!=s&&s.actions.includes(X.YU.DontNotify)&&(r=!0),i)if(s){if(!r){const i=h.v6();this.deletePushRule(e,X.Ji.RoomSpecific,s.rule_id).then((()=>{this.addPushRule(e,X.Ji.RoomSpecific,t,{actions:[X.YU.DontNotify]}).then((()=>{i.resolve()})).catch((e=>{i.reject(e)}))})).catch((e=>{i.reject(e)})),n=i.promise}}else n=this.addPushRule(e,X.Ji.RoomSpecific,t,{actions:[X.YU.DontNotify]});else r&&(n=this.deletePushRule(e,X.Ji.RoomSpecific,s.rule_id));if(n)return new Promise(((e,t)=>{n.then((()=>{this.getPushRules().then((t=>{this.pushRules=t,e()})).catch((e=>{t(e)}))})).catch((e=>{this.getPushRules().then((i=>{this.pushRules=i,t(e)})).catch((i=>{t(e)}))}))}))}searchMessageText(e){const t={search_term:e.query};return"keys"in e&&(t.keys=e.keys),this.search({body:{search_categories:{room_events:t}}})}searchRoomEvents(e){const t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:Y.g.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},i={_query:t,results:[],highlights:[]};return this.search({body:t}).then((e=>this.processRoomEventsSearch(i,e)))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;const t={body:e._query,next_batch:e.next_batch},i=this.search(t,e.abortSignal).then((t=>this.processRoomEventsSearch(e,t))).finally((()=>{e.pendingRequest=void 0}));return e.pendingRequest=i,i}processRoomEventsSearch(e,t){var i,n;const r=t.search_categories.room_events;e.count=r.count,e.next_batch=r.next_batch;const s=new Set(r.highlights);e.highlights.forEach((e=>{s.add(e)})),e.highlights=Array.from(s);const o=this.getEventMapper(),a=null!==(i=null===(n=r.results)||void 0===n?void 0:n.length)&&void 0!==i?i:0;for(let t=0;t<a;t++){const i=T.q.fromJson(r.results[t],o),n=this.getRoom(i.context.getEvent().getRoomId());if(n)for(const e of i.context.getTimeline()){const t=n.getMember(e.getSender());!e.sender&&t&&(e.sender=t)}e.results.push(i)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;const e=new s.w_(this,this.clientOpts,this.buildSyncApiOptions());return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then((()=>{this.logger.debug("Marking success of sync left room request"),this.syncedLeftRooms=!0})).finally((()=>{this.syncLeftRoomsPromise=void 0})),this.syncLeftRoomsPromise}createFilter(e){const t=h.RR("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(w.IT.Post,t,void 0,e).then((t=>{const i=d.d.fromJson(this.credentials.userId,t.filter_id,e);return this.store.storeFilter(i),i}))}getFilter(e,t,i){if(i){const i=this.store.getFilter(e,t);if(i)return Promise.resolve(i)}const n=h.RR("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(w.IT.Get,n).then((i=>{const n=d.d.fromJson(e,t,i);return this.store.storeFilter(n),n}))}async getOrCreateFilter(e,t){const i=this.store.getFilterIdByName(e);let n;if(i){try{const e=await this.getFilter(this.credentials.userId,i,!0);if(e){const r=e.getDefinition(),s=t.getDefinition();h.ky(r,s)&&(n=i)}}catch(e){if("M_UNKNOWN"!==e.errcode&&"M_NOT_FOUND"!==e.errcode)throw e}n||this.store.setFilterIdByName(e,void 0)}if(n)return n;const r=await this.createFilter(t.getDefinition());return this.store.setFilterIdByName(e,r.filterId),r.filterId}getOpenIdToken(){const e=h.RR("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(w.IT.Post,e,void 0,{})}turnServer(){return this.http.authedRequest(w.IT.Get,"/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}get pollingTurnServers(){return void 0!==this.checkTurnServersIntervalID}async checkTurnServers(){if(!this.canSupportVoip)return;let e=!1;const t=this.turnServersExpiry-Date.now();if(t>ye)this.logger.debug("TURN creds are valid for another "+t+" ms: not fetching new ones."),e=!0;else{this.logger.debug("Fetching new TURN credentials");try{const t=await this.turnServer();if(t.uris){this.logger.debug("Got TURN URIs: "+t.uris+" refresh in "+t.ttl+" secs");const i={urls:t.uris,username:t.username,credential:t.password};this.turnServers=[i],this.turnServersExpiry=Date.now()+1e3*t.ttl,e=!0,this.emit(_e.TurnServers,this.turnServers)}}catch(e){this.logger.error("Failed to get TURN URIs",e),403===e.httpStatus?(this.logger.info("TURN access unavailable for this account: stopping credentials checks"),null!==this.checkTurnServersIntervalID&&i.g.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,this.emit(_e.TurnServersError,e,!0)):this.emit(_e.TurnServersError,e,!1)}}return e}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){const e=h.RR("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(w.IT.Get,e,void 0,void 0,{prefix:""}).then((e=>e.admin))}whoisSynapseUser(e){const t=h.RR("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(w.IT.Get,t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){const t=h.RR("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(w.IT.Post,t,void 0,void 0,{prefix:""})}async fetchClientWellKnown(){var e;this.clientWellKnownPromise=g.MN.getRawClientConfig(null!==(e=this.getDomain())&&void 0!==e?e:void 0),this.clientWellKnown=await this.clientWellKnownPromise,this.emit(_e.ClientWellKnown,this.clientWellKnown)}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){if(!this.clientRunning)throw new Error("Client is not running");return this.clientWellKnownPromise}storeClientOptions(){const e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter((([t,i])=>e.includes(typeof i))).reduce(((e,[t,i])=>(e[t]=i,e)),{});return this.store.storeClientOptions(t)}async _unstable_getSharedRooms(e){const t=await this.doesServerSupportUnstableFeature("uk.half-shot.msc2666"),i=await this.doesServerSupportUnstableFeature("uk.half-shot.msc2666.mutual_rooms"),n=await this.doesServerSupportUnstableFeature("uk.half-shot.msc2666.query_mutual_rooms");if(!t&&!i&&!n)throw Error("Server does not support the Mutual Rooms API");let r,s;n?(r="/uk.half-shot.msc2666/user/mutual_rooms",s={user_id:e}):(r=h.RR(`/uk.half-shot.msc2666/user/${i?"mutual_rooms":"shared_rooms"}/$userId`,{$userId:e}),s={});const o=[];let a=null;do{const e={};null!=a&&n&&(e.batch_token=a);const t=await this.http.authedRequest(w.IT.Get,r,fe(fe({},s),e),void 0,{prefix:w.iD.Unstable});o.push(...t.joined),a=void 0!==t.next_batch_token?t.next_batch_token:null}while(null!=a);return o}async getVersions(){if(this.serverVersionsPromise)return this.serverVersionsPromise;this.serverVersionsPromise=this.http.authedRequest(w.IT.Get,"/_matrix/client/versions",void 0,void 0,{prefix:""}).catch((e=>{throw this.serverVersionsPromise=void 0,e}));const e=await this.serverVersionsPromise;return this.canSupport=await(0,le.yk)(e),this.serverVersionsPromise}async isVersionSupported(e){const{versions:t}=await this.getVersions();return t&&t.includes(e)}async doesServerSupportUnstableFeature(e){const t=await this.getVersions();if(!t)return!1;const i=t.unstable_features;return i&&!!i[e]}async doesServerForceEncryptionForPreset(e){const t=await this.getVersions();if(!t)return!1;const i=t.unstable_features,n=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return i&&!!i[`io.element.e2ee_forced.${n}`]}async doesServerSupportThread(){if(await this.isVersionSupported("v1.4"))return{threads:re.c1.Stable,list:re.c1.Stable,fwdPagination:re.c1.Stable};try{const[e,t,i,n,r,s]=await Promise.all([this.doesServerSupportUnstableFeature("org.matrix.msc3440"),this.doesServerSupportUnstableFeature("org.matrix.msc3440.stable"),this.doesServerSupportUnstableFeature("org.matrix.msc3856"),this.doesServerSupportUnstableFeature("org.matrix.msc3856.stable"),this.doesServerSupportUnstableFeature("org.matrix.msc3715"),this.doesServerSupportUnstableFeature("org.matrix.msc3715.stable")]);return{threads:(0,re.FD)(t,e),list:(0,re.FD)(n,i),fwdPagination:(0,re.FD)(s,r)}}catch(e){return{threads:re.c1.None,list:re.c1.None,fwdPagination:re.c1.None}}}hasLazyLoadMembersEnabled(){var e;return!(null===(e=this.clientOpts)||void 0===e||!e.lazyLoadMembers)}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}async relations(e,t,i,n,r={dir:m.O.Backward}){var s,o;const a=n?this.getEncryptedIfNeededEventType(e,n):null,[c,d]=await Promise.all([this.fetchRoomEvent(e,t),this.fetchRelations(e,t,i,a,r)]),l=this.getEventMapper(),u=c?l(c):void 0;let h=d.chunk.map(l);if(a===P.Bx.RoomMessageEncrypted){const e=u?h.concat(u):h;await Promise.all(e.map((e=>this.decryptEventIfNeeded(e)))),null!==n&&(h=h.filter((e=>e.getType()===n)))}return u&&i===P.zZ.Replace&&(h=h.filter((e=>e.getSender()===u.getSender()))),{originalEvent:null!=u?u:null,events:h,nextBatch:null!==(s=d.next_batch)&&void 0!==s?s:null,prevBatch:null!==(o=d.prev_batch)&&void 0!==o?o:null}}getCrossSigningCacheCallbacks(){var e;return null===(e=this.crypto)||void 0===e?void 0:e.crossSigningInfo.getCacheCallbacks()}generateClientSecret(){return(0,L.DU)(32)}decryptEventIfNeeded(e,t){return e.shouldAttemptDecryption()&&this.isCryptoEnabled()&&e.attemptDecryption(this.cryptoBackend,t),e.isBeingDecrypted()?e.getDecryptionPromise():Promise.resolve()}termsUrlForService(e,t){switch(e){case S.S.IS:return this.http.getUrl("/terms",void 0,w.Pw.V2,t);case S.S.IM:return this.http.getUrl("/terms",void 0,"/_matrix/integrations/v1",t);default:throw new Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(e=!1){var t,i;return e&&(null!==(t=this.idBaseUrl)&&void 0!==t&&t.startsWith("http://")||null!==(i=this.idBaseUrl)&&void 0!==i&&i.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=h.hc(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}getRefreshToken(){var e;return null!==(e=this.http.opts.refreshToken)&&void 0!==e?e:null}setAccessToken(e){this.http.opts.accessToken=e,this.serverVersionsPromise=void 0}isLoggedIn(){return void 0!==this.http.opts.accessToken}makeTxnId(){return"m"+(new Date).getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(w.IT.Get,"/register/available",{username:e}).then((e=>e.available)).catch((e=>"M_USER_IN_USE"!==e.errcode&&Promise.reject(e)))}register(e,t,i,n,r,s,o){i&&(n.session=i);const a={auth:n,refresh_token:!0};return null!=e&&(a.username=e),null!=t&&(a.password=t),null!=s&&(a.guest_access_token=s),null!=o&&(a.inhibit_login=o),this.registerRequest(a)}registerGuest({body:e}={}){return this.registerRequest(e||{},"guest")}registerRequest(e,t){const i={};return t&&(i.kind=t),this.http.request(w.IT.Post,"/register",i,e)}refreshToken(e){const t=t=>this.http.authedRequest(w.IT.Post,"/refresh",void 0,{refresh_token:e},{prefix:t,inhibitLogoutEmit:!0});return t(w.iD.V3).catch((e=>{if("M_UNRECOGNIZED"===e.errcode)return t(w.iD.V1);throw e}))}loginFlows(){return this.http.request(w.IT.Get,"/login")}login(e,t){return this.http.authedRequest(w.IT.Post,"/login",void 0,fe(fe({},t),{},{type:e})).then((e=>(e.access_token&&e.user_id&&(this.http.opts.accessToken=e.access_token,this.credentials={userId:e.user_id}),e)))}loginWithPassword(e,t){return this.login("m.login.password",{user:e,password:t})}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e,t="sso",i,n){let r="/login/"+t+"/redirect";i&&(r+="/"+i);const s={redirectUrl:e,[Ee.unstable]:n};return this.http.getUrl(r,s).href}loginWithToken(e){return this.login("m.login.token",{token:e})}async logout(e=!1){var t,i;if(null!==(t=this.crypto)&&void 0!==t&&null!==(i=t.backupManager)&&void 0!==i&&i.getKeyBackupEnabled())try{for(;await this.crypto.backupManager.backupPendingKeys(200)>0;);}catch(e){this.logger.error("Key backup request failed when logging out. Some keys may be missing from backup",e)}return e&&(this.stopClient(),this.http.abort()),this.http.authedRequest(w.IT.Post,"/logout")}deactivateAccount(e,t){const i={};return e&&(i.auth=e),void 0!==t&&(i.erase=t),this.http.authedRequest(w.IT.Post,"/account/deactivate",void 0,i)}async requestLoginToken(e){const t={auth:e};return this.http.authedRequest(w.IT.Post,"/login/get_token",void 0,t,{prefix:w.iD.V1})}getFallbackAuthUrl(e,t){const i=h.RR("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(i,{session:t}).href}async createRoom(e){var t;const i=(e.invite_3pid||[]).filter((e=>!e.id_access_token));if(i.length>0&&null!==(t=this.identityServer)&&void 0!==t&&t.getAccessToken){const e=await this.identityServer.getAccessToken();if(e)for(const t of i)t.id_access_token=e}return this.http.authedRequest(w.IT.Post,"/createRoom",void 0,e)}fetchRelations(e,t,i,n,r={dir:m.O.Backward}){let s=r;re.jV.hasServerSideFwdPaginationSupport===re.c1.Experimental&&(s=(0,h.Ab)("dir","org.matrix.msc3715.dir",s)),this.canSupport.get(le.Xj.RelationsRecursion)===le.Tj.Unstable&&(s=(0,h.Ab)("recurse","org.matrix.msc3981.recurse",s));const o=h.hm(s);let a="/rooms/$roomId/relations/$eventId";null!==i?(a+="/$relationType",null!==n&&(a+="/$eventType")):null!==n&&(this.logger.warn(`eventType: ${n} ignored when fetching\n            relations as relationType is null`),n=null);const c=h.RR(a+"?"+o,{$roomId:e,$eventId:t,$relationType:i,$eventType:n});return this.http.authedRequest(w.IT.Get,c,void 0,void 0,{prefix:w.iD.V1})}roomState(e){const t=h.RR("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(w.IT.Get,t)}fetchRoomEvent(e,t){const i=h.RR("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(w.IT.Get,i)}members(e,t,i,n){const r={};t&&(r.membership=t),i&&(r.not_membership=i),n&&(r.at=n);const s=h.hm(r),o=h.RR("/rooms/$roomId/members?"+s,{$roomId:e});return this.http.authedRequest(w.IT.Get,o)}upgradeRoom(e,t){const i=h.RR("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(w.IT.Post,i,void 0,{new_version:t})}getStateEvent(e,t,i){const n={$roomId:e,$eventType:t,$stateKey:i};let r=h.RR("/rooms/$roomId/state/$eventType",n);return void 0!==i&&(r=h.RR(r+"/$stateKey",n)),this.http.authedRequest(w.IT.Get,r)}sendStateEvent(e,t,i,n="",r={}){const s={$roomId:e,$eventType:t,$stateKey:n};let o=h.RR("/rooms/$roomId/state/$eventType",s);return void 0!==n&&(o=h.RR(o+"/$stateKey",s)),this.http.authedRequest(w.IT.Put,o,void 0,i,r)}roomInitialSync(e,t){var i;const n=h.RR("/rooms/$roomId/initialSync",{$roomId:e});return this.http.authedRequest(w.IT.Get,n,{limit:null!==(i=null==t?void 0:t.toString())&&void 0!==i?i:"30"})}async setRoomReadMarkersHttpRequest(e,t,i,n){const r=h.RR("/rooms/$roomId/read_markers",{$roomId:e}),s={[ie.L.FullyRead]:t,[ie.L.Read]:i};return(await this.doesServerSupportUnstableFeature("org.matrix.msc2285.stable")||await this.isVersionSupported("v1.4"))&&(s[ie.L.ReadPrivate]=n),this.http.authedRequest(w.IT.Post,r,void 0,s)}getJoinedRooms(){const e=h.RR("/joined_rooms",{});return this.http.authedRequest(w.IT.Get,e)}getJoinedRoomMembers(e){const t=h.RR("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(w.IT.Get,t)}publicRooms(e={}){let{server:t,limit:i,since:r}=e,s=(0,n.A)(e,ge);if(0===Object.keys(s).length){const e={server:t,limit:i,since:r};return this.http.authedRequest(w.IT.Get,"/publicRooms",e)}{const e={server:t},n=fe({limit:i,since:r},s);return this.http.authedRequest(w.IT.Post,"/publicRooms",e,n)}}createAlias(e,t){const i=h.RR("/directory/room/$alias",{$alias:e}),n={room_id:t};return this.http.authedRequest(w.IT.Put,i,void 0,n)}deleteAlias(e){const t=h.RR("/directory/room/$alias",{$alias:e});return this.http.authedRequest(w.IT.Delete,t)}getLocalAliases(e){const t=h.RR("/rooms/$roomId/aliases",{$roomId:e}),i=w.iD.V3;return this.http.authedRequest(w.IT.Get,t,void 0,void 0,{prefix:i})}getRoomIdForAlias(e){const t=h.RR("/directory/room/$alias",{$alias:e});return this.http.authedRequest(w.IT.Get,t)}getRoomDirectoryVisibility(e){const t=h.RR("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(w.IT.Get,t)}setRoomDirectoryVisibility(e,t){const i=h.RR("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(w.IT.Put,i,void 0,{visibility:t})}searchUserDirectory({term:e,limit:t}){const i={search_term:e};return void 0!==t&&(i.limit=t),this.http.authedRequest(w.IT.Post,"/user_directory/search",void 0,i)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t){const i=t?h.RR("/profile/$userId/$info",{$userId:e,$info:t}):h.RR("/profile/$userId",{$userId:e});return this.http.authedRequest(w.IT.Get,i)}getThreePids(){return this.http.authedRequest(w.IT.Get,"/account/3pid")}async addThreePidOnly(e){return this.http.authedRequest(w.IT.Post,"/account/3pid/add",void 0,e)}async bindThreePid(e){return this.http.authedRequest(w.IT.Post,"/account/3pid/bind",void 0,e)}async unbindThreePid(e,t){const i={medium:e,address:t,id_server:this.getIdentityServerUrl(!0)};return this.http.authedRequest(w.IT.Post,"/account/3pid/unbind",void 0,i)}deleteThreePid(e,t){return this.http.authedRequest(w.IT.Post,"/account/3pid/delete",void 0,{medium:e,address:t})}setPassword(e,t,i){const n={auth:e,new_password:t,logout_devices:i};return this.http.authedRequest(w.IT.Post,"/account/password",void 0,n)}getDevices(){return this.http.authedRequest(w.IT.Get,"/devices")}getDevice(e){const t=h.RR("/devices/$device_id",{$device_id:e});return this.http.authedRequest(w.IT.Get,t)}setDeviceDetails(e,t){const i=h.RR("/devices/$device_id",{$device_id:e});return this.http.authedRequest(w.IT.Put,i,void 0,t)}deleteDevice(e,t){const i=h.RR("/devices/$device_id",{$device_id:e}),n={};return t&&(n.auth=t),this.http.authedRequest(w.IT.Delete,i,void 0,n)}deleteMultipleDevices(e,t){const i={devices:e};t&&(i.auth=t);return this.http.authedRequest(w.IT.Post,"/delete_devices",void 0,i)}async getPushers(){const e=await this.http.authedRequest(w.IT.Get,"/pushers");return await this.doesServerSupportUnstableFeature("org.matrix.msc3881")||(e.pushers=e.pushers.map((e=>(e.hasOwnProperty(P.cr.name)||(e[P.cr.name]=!0),e)))),e}setPusher(e){return this.http.authedRequest(w.IT.Post,"/pushers/set",void 0,e)}removePusher(e,t){const i={pushkey:e,app_id:t,kind:null};return this.http.authedRequest(w.IT.Post,"/pushers/set",void 0,i)}setLocalNotificationSettings(e,t){const i=`${P.Xs.name}.${e}`;return this.setAccountData(i,t)}getPushRules(){return this.http.authedRequest(w.IT.Get,"/pushrules/").then((e=>(this.setPushRules(e),this.pushRules)))}setPushRules(e){this.pushRules=p.j.rewriteDefaultRules(e,this.getUserId()),this.pushProcessor.updateCachedPushRuleKeys(this.pushRules)}addPushRule(e,t,i,n){const r=h.RR("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:i});return this.http.authedRequest(w.IT.Put,r,void 0,n)}deletePushRule(e,t,i){const n=h.RR("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:i});return this.http.authedRequest(w.IT.Delete,n)}setPushRuleEnabled(e,t,i,n){const r=h.RR("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:i});return this.http.authedRequest(w.IT.Put,r,void 0,{enabled:n})}setPushRuleActions(e,t,i,n){const r=h.RR("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:i});return this.http.authedRequest(w.IT.Put,r,void 0,{actions:n})}search({body:e,next_batch:t},i){const n={};return t&&(n.next_batch=t),this.http.authedRequest(w.IT.Post,"/search",n,e,{abortSignal:i})}uploadKeysRequest(e,t){return this.http.authedRequest(w.IT.Post,"/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(w.IT.Post,"/keys/signatures/upload",void 0,e)}downloadKeysForUsers(e,{token:t}={}){const i={device_keys:{}};return void 0!==t&&(i.token=t),e.forEach((e=>{i.device_keys[e]=[]})),this.http.authedRequest(w.IT.Post,"/keys/query",void 0,i)}claimOneTimeKeys(e,t="signed_curve25519",i){const n={};void 0===t&&(t="signed_curve25519");for(const[i,r]of e){const e=n[i]||{};(0,h.C6)(n,i,e),(0,h.C6)(e,r,t)}const r={one_time_keys:n};i&&(r.timeout=i);return this.http.authedRequest(w.IT.Post,"/keys/claim",void 0,r)}getKeyChanges(e,t){const i={from:e,to:t};return this.http.authedRequest(w.IT.Get,"/keys/changes",i)}uploadDeviceSigningKeys(e,t){const i=Object.assign({},t);return e&&Object.assign(i,{auth:e}),this.http.authedRequest(w.IT.Post,"/keys/device_signing/upload",void 0,i,{prefix:w.iD.Unstable})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw new Error("No identity server base URL set");const t=this.http.getUrl("/account/register",void 0,w.Pw.V2,this.idBaseUrl);return this.http.requestOtherUrl(w.IT.Post,t,e)}requestEmailToken(e,t,i,n,r){const s={client_secret:t,email:e,send_attempt:null==i?void 0:i.toString()};return n&&(s.next_link=n),this.http.idServerRequest(w.IT.Post,"/validate/email/requestToken",s,w.Pw.V2,r)}requestMsisdnToken(e,t,i,n,r,s){const o={client_secret:i,country:e,phone_number:t,send_attempt:null==n?void 0:n.toString()};return r&&(o.next_link=r),this.http.idServerRequest(w.IT.Post,"/validate/msisdn/requestToken",o,w.Pw.V2,s)}submitMsisdnToken(e,t,i,n){const r={sid:e,client_secret:t,token:i};return this.http.idServerRequest(w.IT.Post,"/validate/msisdn/submitToken",r,w.Pw.V2,null!=n?n:void 0)}submitMsisdnTokenOtherUrl(e,t,i,n){const r={sid:t,client_secret:i,token:n};return this.http.requestOtherUrl(w.IT.Post,e,r)}getIdentityHashDetails(e){return this.http.idServerRequest(w.IT.Get,"/hash_details",void 0,w.Pw.V2,e)}async identityHashedLookup(e,t){const n={},r=await this.getIdentityHashDetails(t);if(!r||!r.lookup_pepper||!r.algorithms)throw new Error("Unsupported identity server: bad response");n.pepper=r.lookup_pepper;const s={};if(r.algorithms.includes("sha256")){const t=new i.g.Olm.Utility;n.addresses=e.map((e=>{const i=e[0].toLowerCase(),r=e[1].toLowerCase(),o=t.sha256(`${i} ${r} ${n.pepper}`).replace(/\+/g,"-").replace(/\//g,"_");return s[o]=e[0],o})),n.algorithm="sha256"}else{if(!r.algorithms.includes("none"))throw new Error("Unsupported identity server: unknown hash algorithm");n.addresses=e.map((e=>{const t=`${e[0].toLowerCase()} ${e[1].toLowerCase()}`;return s[t]=e[0],t})),n.algorithm="none"}const o=await this.http.idServerRequest(w.IT.Post,"/lookup",n,w.Pw.V2,t);if(null==o||!o.mappings)return[];const a=[];for(const e of Object.keys(o.mappings)){const t=o.mappings[e],i=s[e];if(!i)throw new Error("Identity server returned more results than expected");a.push({address:i,mxid:t})}return a}async lookupThreePid(e,t,i){const n=(await this.identityHashedLookup([[t,e]],i)).find((e=>e.address===t));if(!n)return{};return{address:t,medium:e,mxid:n.mxid}}async bulkLookupThreePids(e,t){const i=await this.identityHashedLookup(e.map((e=>[e[1],e[0]])),t),n=[];for(const t of i){const i=e.find((e=>e[1]===t.address));if(!i)throw new Error("Identity sever returned unexpected results");n.push([i[0],t.address,t.mxid])}return{threepids:n}}getIdentityAccount(e){return this.http.idServerRequest(w.IT.Get,"/account",void 0,w.Pw.V2,e)}sendToDevice(e,t,i){const n=h.RR("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:i||this.makeTxnId()}),r={messages:h.HF(t)},s=new Map;for(const[e,i]of t)s.set(e,Array.from(i.keys()));return this.logger.debug(`PUT ${n}`,s),this.http.authedRequest(w.IT.Put,n,void 0,r)}queueToDevice(e){return this.toDeviceMessageQueue.queueBatch(e)}getThirdpartyProtocols(){return this.http.authedRequest(w.IT.Get,"/thirdparty/protocols").then((e=>{if(!e||"object"!=typeof e)throw new Error(`/thirdparty/protocols did not return an object: ${e}`);return e}))}getThirdpartyLocation(e,t){const i=h.RR("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(w.IT.Get,i,t)}getThirdpartyUser(e,t){const i=h.RR("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(w.IT.Get,i,t)}getTerms(e,t){const i=this.termsUrlForService(e,t);return this.http.requestOtherUrl(w.IT.Get,i)}agreeToTerms(e,t,i,n){const r=this.termsUrlForService(e,t),s={Authorization:"Bearer "+i};return this.http.requestOtherUrl(w.IT.Post,r,{user_accepts:n},{headers:s})}reportEvent(e,t,i,n){const r=h.RR("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(w.IT.Post,r,void 0,{score:i,reason:n})}getRoomHierarchy(e,t,i,n=!1,r){const s=h.RR("/rooms/$roomId/hierarchy",{$roomId:e}),o={suggested_only:String(n),max_depth:null==i?void 0:i.toString(),from:r,limit:null==t?void 0:t.toString()};return this.http.authedRequest(w.IT.Get,s,o,void 0,{prefix:w.iD.V1}).catch((e=>{if("M_UNRECOGNIZED"===e.errcode)return this.http.authedRequest(w.IT.Get,s,o,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"});throw e}))}async unstableCreateFileTree(e){const{room_id:t}=await this.createRoom({name:e,preset:j.k.PrivateChat,power_level_content_override:fe(fe({},J),{},{users:{[this.getUserId()]:100}}),creation_content:{[P.Ct]:P.CJ.Space},initial_state:[{type:P.D7.name,state_key:P.nN.name,content:{[P.ud.name]:!0}},{type:P.Bx.RoomEncryption,state_key:"",content:{algorithm:v.MEGOLM_ALGORITHM}}]});return new Q(this,t)}unstableGetFileTreeSpace(e){var t,i;const n=this.getRoom(e);if((null==n?void 0:n.getMyMembership())!==G.O.Join)return null;const r=n.currentState.getStateEvents(P.Bx.RoomCreate,""),s=n.currentState.getStateEvents(P.D7.name,P.nN.name);if(!r)throw new Error("Expected single room create event");return null!=s&&null!==(t=s.getContent())&&void 0!==t&&t[P.ud.name]?(null===(i=r.getContent())||void 0===i?void 0:i[P.Ct])!==P.CJ.Space?null:new Q(this,e):null}slidingSync(e,t,i){const n={};e.pos&&(n.pos=e.pos,delete e.pos),e.timeout&&(n.timeout=e.timeout,delete e.timeout);const r=e.clientTimeout;return delete e.clientTimeout,this.http.authedRequest(w.IT.Post,"/sync",n,e,{prefix:"/_matrix/client/unstable/org.matrix.msc3575",baseUrl:t,localTimeoutMs:r,abortSignal:i})}supportsThreads(){var e;return(null===(e=this.clientOpts)||void 0===e?void 0:e.threadSupport)||!1}supportsIntentionalMentions(){return this.canSupport.get(le.Xj.IntentionalMentions)!==le.Tj.Unsupported}async getRoomSummary(e,t){const i={prefix:"/_matrix/client/unstable/im.nheko.summary"};try{const n=h.RR("/summary/$roomid",{$roomid:e});return await this.http.authedRequest(w.IT.Get,n,{via:t},void 0,i)}catch(n){if(n instanceof w.up&&"M_UNRECOGNIZED"===n.errcode){const n=h.RR("/rooms/$roomid/summary",{$roomid:e});return await this.http.authedRequest(w.IT.Get,n,{via:t},void 0,i)}throw n}}processThreadEvents(e,t,i){e.processThreadedEvents(t,i)}processThreadRoots(e,t,i){this.supportsThreads()&&e.processThreadRoots(t,i)}processBeaconEvents(e,t){this.processAggregatedTimelineEvents(e,t)}processAggregatedTimelineEvents(e,t){null!=t&&t.length&&e&&(e.currentState.processBeaconEvents(t,this),e.processPollEvents(t))}async whoami(){return this.http.authedRequest(w.IT.Get,"/account/whoami")}async timestampToEvent(e,t,i){const n=h.RR("/rooms/$roomId/timestamp_to_event",{$roomId:e}),r={ts:t.toString(),dir:i};try{return await this.http.authedRequest(w.IT.Get,n,r,void 0,{prefix:w.iD.V1})}catch(e){if("M_UNRECOGNIZED"===e.errcode&&(400===e.httpStatus||404===e.httpStatus||405===e.httpStatus))return await this.http.authedRequest(w.IT.Get,n,r,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc3030"});throw e}}async getAuthIssuer(){return this.http.request(w.IT.Get,"/auth_issuer",void 0,void 0,{prefix:w.iD.Unstable+"/org.matrix.msc2965"})}}function ke(e){return Re(e)?ie.S:e.threadRootId}function Re(e){if(!e.threadRootId)return!0;if(e.isThreadRoot)return!0;if(!e.isRelation())return b.v.warn(`Event is not a relation or a thread root, but still has a threadRootId! id=${e.getId()}`),!0;if(e.isRelation(re.RN.name))return!1;return e.relationEventId===e.threadRootId}(0,r.A)(Ie,"RESTORE_BACKUP_ERROR_BAD_KEY","RESTORE_BACKUP_ERROR_BAD_KEY")},"./node_modules/matrix-js-sdk/src/common-crypto/CryptoBackend.ts":(e,t,i)=>{"use strict";i.d(t,{O:()=>r});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js");class r extends Error{constructor(e,t,i){super(t),this.code=e,(0,n.A)(this,"detailedString",void 0),this.name="DecryptionError",this.detailedString=function(e,t){let i=e.name+"[msg: "+e.message;t&&(i+=", "+Object.keys(t).map((e=>e+": "+t[e])).join(", "));return i+="]",i}(this,i)}}},"./node_modules/matrix-js-sdk/src/content-helpers.ts":(e,t,i)=>{"use strict";i.d(t,{makeEmoteMessage:()=>h,makeHtmlEmote:()=>d,makeHtmlMessage:()=>a,makeHtmlNotice:()=>c,makeNotice:()=>u,makeTextMessage:()=>l,makeTopicContent:()=>m,parseBeaconContent:()=>g,parseBeaconInfoContent:()=>p});var n=i("./node_modules/matrix-js-sdk/src/@types/event.ts"),r=(i("./node_modules/matrix-js-sdk/src/@types/extensible_events.ts"),i("./node_modules/matrix-js-sdk/src/extensible_events_v1/utilities.ts")),s=i("./node_modules/matrix-js-sdk/src/@types/location.ts"),o=i("./node_modules/matrix-js-sdk/src/@types/topic.ts");function a(e,t){return{msgtype:n.Wr.Text,format:"org.matrix.custom.html",body:e,formatted_body:t}}function c(e,t){return{msgtype:n.Wr.Notice,format:"org.matrix.custom.html",body:e,formatted_body:t}}function d(e,t){return{msgtype:n.Wr.Emote,format:"org.matrix.custom.html",body:e,formatted_body:t}}function l(e){return{msgtype:n.Wr.Text,body:e}}function u(e){return{msgtype:n.Wr.Notice,body:e}}function h(e){return{msgtype:n.Wr.Emote,body:e}}const m=(e,t)=>{const i=[{body:e,mimetype:"text/plain"}];return(0,r.c)(t)&&i.push({body:t,mimetype:"text/html"}),{topic:e,[o.s.name]:i}},p=e=>{var t;const{description:i,timeout:n,live:r}=e,o=null!==(t=s.vo.findIn(e))&&void 0!==t?t:void 0,a=s.J1.findIn(e);return{description:i,timeout:n,live:r,assetType:null==a?void 0:a.type,timestamp:o}},g=e=>{var t;const i=s.M6.findIn(e),n=null!==(t=s.vo.findIn(e))&&void 0!==t?t:void 0;return{description:null==i?void 0:i.description,uri:null==i?void 0:i.uri,timestamp:n}}},"./node_modules/matrix-js-sdk/src/content-repo.ts":(e,t,i)=>{"use strict";i.d(t,{y:()=>r});var n=i("./node_modules/matrix-js-sdk/src/utils.ts");function r(e,t,i,r,s,o=!1,a,c){if("string"!=typeof t||!t)return"";if(0!==t.indexOf("mxc://"))return o?t:"";c&&(a=!0);let d,l=t.slice(6);d=c?"/_matrix/client/unstable/org.matrix.msc3916/media/download/":"/_matrix/media/v3/download/";const u={};i&&(u.width=Math.round(i).toString()),r&&(u.height=Math.round(r).toString()),s&&(u.method=s),Object.keys(u).length>0&&(d=c?"/_matrix/client/unstable/org.matrix.msc3916/media/thumbnail/":"/_matrix/media/v3/thumbnail/"),"boolean"==typeof a&&(u.allow_redirect=JSON.stringify(a));const h=l.indexOf("#");let m="";h>=0&&(m=l.slice(h),l=l.slice(0,h));return e+d+l+(0===Object.keys(u).length?"":"?"+(0,n.hm)(u))+m}},"./node_modules/matrix-js-sdk/src/crypto-api.ts":(e,t,i)=>{"use strict";i.d(t,{CrossSigningKey:()=>a,DecryptionFailureCode:()=>r,DeviceVerificationStatus:()=>o,EventShieldColour:()=>c,EventShieldReason:()=>d,UserVerificationStatus:()=>s});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js");i("./node_modules/matrix-js-sdk/src/crypto-api/verification.ts");let r=function(e){return e.MEGOLM_UNKNOWN_INBOUND_SESSION_ID="MEGOLM_UNKNOWN_INBOUND_SESSION_ID",e.OLM_UNKNOWN_MESSAGE_INDEX="OLM_UNKNOWN_MESSAGE_INDEX",e.HISTORICAL_MESSAGE_NO_KEY_BACKUP="HISTORICAL_MESSAGE_NO_KEY_BACKUP",e.HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED="HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED",e.HISTORICAL_MESSAGE_WORKING_BACKUP="HISTORICAL_MESSAGE_WORKING_BACKUP",e.HISTORICAL_MESSAGE_USER_NOT_JOINED="HISTORICAL_MESSAGE_USER_NOT_JOINED",e.UNKNOWN_ERROR="UNKNOWN_ERROR",e.MEGOLM_BAD_ROOM="MEGOLM_BAD_ROOM",e.MEGOLM_MISSING_FIELDS="MEGOLM_MISSING_FIELDS",e.OLM_DECRYPT_GROUP_MESSAGE_ERROR="OLM_DECRYPT_GROUP_MESSAGE_ERROR",e.OLM_BAD_ENCRYPTED_MESSAGE="OLM_BAD_ENCRYPTED_MESSAGE",e.OLM_BAD_RECIPIENT="OLM_BAD_RECIPIENT",e.OLM_BAD_RECIPIENT_KEY="OLM_BAD_RECIPIENT_KEY",e.OLM_BAD_ROOM="OLM_BAD_ROOM",e.OLM_BAD_SENDER_CHECK_FAILED="OLM_BAD_SENDER_CHECK_FAILED",e.OLM_BAD_SENDER="OLM_BAD_SENDER",e.OLM_FORWARDED_MESSAGE="OLM_FORWARDED_MESSAGE",e.OLM_MISSING_CIPHERTEXT="OLM_MISSING_CIPHERTEXT",e.OLM_NOT_INCLUDED_IN_RECIPIENTS="OLM_NOT_INCLUDED_IN_RECIPIENTS",e.UNKNOWN_ENCRYPTION_ALGORITHM="UNKNOWN_ENCRYPTION_ALGORITHM",e}({});class s{constructor(e,t,i){this.crossSigningVerified=e,this.crossSigningVerifiedBefore=t,this.tofu=i}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}}class o{constructor(e){var t,i,r,s,o;(0,n.A)(this,"signedByOwner",void 0),(0,n.A)(this,"crossSigningVerified",void 0),(0,n.A)(this,"tofu",void 0),(0,n.A)(this,"localVerified",void 0),(0,n.A)(this,"trustCrossSignedDevices",void 0),this.signedByOwner=null!==(t=e.signedByOwner)&&void 0!==t&&t,this.crossSigningVerified=null!==(i=e.crossSigningVerified)&&void 0!==i&&i,this.tofu=null!==(r=e.tofu)&&void 0!==r&&r,this.localVerified=null!==(s=e.localVerified)&&void 0!==s&&s,this.trustCrossSignedDevices=null!==(o=e.trustCrossSignedDevices)&&void 0!==o&&o}isVerified(){return this.localVerified||this.trustCrossSignedDevices&&this.crossSigningVerified}}let a=function(e){return e.Master="master",e.SelfSigning="self_signing",e.UserSigning="user_signing",e}({}),c=function(e){return e[e.NONE=0]="NONE",e[e.GREY=1]="GREY",e[e.RED=2]="RED",e}({}),d=function(e){return e[e.UNKNOWN=0]="UNKNOWN",e[e.UNVERIFIED_IDENTITY=1]="UNVERIFIED_IDENTITY",e[e.UNSIGNED_DEVICE=2]="UNSIGNED_DEVICE",e[e.UNKNOWN_DEVICE=3]="UNKNOWN_DEVICE",e[e.AUTHENTICITY_NOT_GUARANTEED=4]="AUTHENTICITY_NOT_GUARANTEED",e[e.MISMATCHED_SENDER_KEY=5]="MISMATCHED_SENDER_KEY",e}({})},"./node_modules/matrix-js-sdk/src/crypto-api/verification.ts":(e,t,i)=>{"use strict";i.d(t,{Dy:()=>o,FM:()=>n,Ji:()=>s,X9:()=>r});let n=function(e){return e.Change="change",e}({}),r=function(e){return e[e.Unsent=1]="Unsent",e[e.Requested=2]="Requested",e[e.Ready=3]="Ready",e[e.Started=4]="Started",e[e.Cancelled=5]="Cancelled",e[e.Done=6]="Done",e}({}),s=function(e){return e.Cancel="cancel",e.ShowSas="show_sas",e.ShowReciprocateQr="show_reciprocate_qr",e}({});function o(e){return e.phase<r.Ready&&!e.accepting&&!e.declining}},"./node_modules/matrix-js-sdk/src/crypto/OlmDevice.ts":(e,t,i)=>{"use strict";i.d(t,{FL:()=>l,nC:()=>u});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/logger.ts"),s=i("./node_modules/matrix-js-sdk/src/crypto/store/indexeddb-crypto-store.ts"),o=i("./node_modules/matrix-js-sdk/src/crypto-api.ts"),a=i("./node_modules/matrix-js-sdk/src/common-crypto/CryptoBackend.ts");class c extends Error{constructor(...e){super(...e),(0,n.A)(this,"data",{errcode:"M_TOO_LARGE",error:"Payload too large for encrypted message"})}}function d(e){if(void 0===e)throw new Error("payloadString undefined");if(e.length>49152)throw new c(`Message too long (${e.length} bytes). The maximum for an encrypted message is 49152 bytes.`)}class l{constructor(e){this.cryptoStore=e,(0,n.A)(this,"pickleKey","DEFAULT_KEY"),(0,n.A)(this,"deviceCurve25519Key",null),(0,n.A)(this,"deviceEd25519Key",null),(0,n.A)(this,"maxOneTimeKeys",null),(0,n.A)(this,"outboundGroupSessionStore",{}),(0,n.A)(this,"inboundGroupSessionMessageIndexes",{}),(0,n.A)(this,"sessionsInProgress",{}),(0,n.A)(this,"olmPrekeyPromise",Promise.resolve())}static getOlmVersion(){return i.g.Olm.get_library_version()}async init({pickleKey:e,fromExportedDevice:t}={}){let n;const s=new i.g.Olm.Account;try{t?(e&&r.v.warn("ignoring opts.pickleKey because opts.fromExportedDevice is present."),this.pickleKey=t.pickleKey,await this.initialiseFromExportedDevice(t,s)):(e&&(this.pickleKey=e),await this.initialiseAccount(s)),n=JSON.parse(s.identity_keys()),this.maxOneTimeKeys=s.max_number_of_one_time_keys()}finally{s.free()}this.deviceCurve25519Key=n.curve25519,this.deviceEd25519Key=n.ed25519}async initialiseFromExportedDevice(e,t){await this.cryptoStore.doTxn("readwrite",[s.y.STORE_ACCOUNT,s.y.STORE_SESSIONS],(t=>{this.cryptoStore.storeAccount(t,e.pickledAccount),e.sessions.forEach((e=>{const{deviceKey:i,sessionId:n}=e,r={session:e.session,lastReceivedMessageTs:e.lastReceivedMessageTs};this.cryptoStore.storeEndToEndSession(i,n,r,t)}))})),t.unpickle(this.pickleKey,e.pickledAccount)}async initialiseAccount(e){await this.cryptoStore.doTxn("readwrite",[s.y.STORE_ACCOUNT],(t=>{this.cryptoStore.getAccount(t,(i=>{null!==i?e.unpickle(this.pickleKey,i):(e.create(),i=e.pickle(this.pickleKey),this.cryptoStore.storeAccount(t,i))}))}))}getAccount(e,t){this.cryptoStore.getAccount(e,(e=>{const n=new i.g.Olm.Account;try{n.unpickle(this.pickleKey,e),t(n)}finally{n.free()}}))}storeAccount(e,t){this.cryptoStore.storeAccount(e,t.pickle(this.pickleKey))}async export(){const e={pickleKey:this.pickleKey};return await this.cryptoStore.doTxn("readonly",[s.y.STORE_ACCOUNT,s.y.STORE_SESSIONS],(t=>{this.cryptoStore.getAccount(t,(t=>{e.pickledAccount=t})),e.sessions=[],this.cryptoStore.getAllEndToEndSessions(t,(t=>{e.sessions.push(t)}))})),e}getSession(e,t,i,n){this.cryptoStore.getEndToEndSession(e,t,i,(e=>{this.unpickleSession(e,n)}))}unpickleSession(e,t){const n=new i.g.Olm.Session;try{n.unpickle(this.pickleKey,e.session);t(Object.assign({},e,{session:n}))}finally{n.free()}}saveSession(e,t,i){const n=t.session.session_id();r.v.debug(`Saving Olm session ${n} with device ${e}: ${t.session.describe()}`);const s=Object.assign(t,{session:t.session.pickle(this.pickleKey)});this.cryptoStore.storeEndToEndSession(e,n,s,i)}getUtility(e){const t=new i.g.Olm.Utility;try{return e(t)}finally{t.free()}}async sign(e){let t;return await this.cryptoStore.doTxn("readonly",[s.y.STORE_ACCOUNT],(i=>{this.getAccount(i,(i=>{t=i.sign(e)}))})),t}async getOneTimeKeys(){let e;return await this.cryptoStore.doTxn("readonly",[s.y.STORE_ACCOUNT],(t=>{this.getAccount(t,(t=>{e=JSON.parse(t.one_time_keys())}))})),e}maxNumberOfOneTimeKeys(){var e;return null!==(e=this.maxOneTimeKeys)&&void 0!==e?e:-1}async markKeysAsPublished(){await this.cryptoStore.doTxn("readwrite",[s.y.STORE_ACCOUNT],(e=>{this.getAccount(e,(t=>{t.mark_keys_as_published(),this.storeAccount(e,t)}))}))}generateOneTimeKeys(e){return this.cryptoStore.doTxn("readwrite",[s.y.STORE_ACCOUNT],(t=>{this.getAccount(t,(i=>{i.generate_one_time_keys(e),this.storeAccount(t,i)}))}))}async generateFallbackKey(){await this.cryptoStore.doTxn("readwrite",[s.y.STORE_ACCOUNT],(e=>{this.getAccount(e,(t=>{t.generate_fallback_key(),this.storeAccount(e,t)}))}))}async getFallbackKey(){let e;return await this.cryptoStore.doTxn("readonly",[s.y.STORE_ACCOUNT],(t=>{this.getAccount(t,(t=>{e=JSON.parse(t.unpublished_fallback_key())}))})),e}async forgetOldFallbackKey(){await this.cryptoStore.doTxn("readwrite",[s.y.STORE_ACCOUNT],(e=>{this.getAccount(e,(t=>{t.forget_old_fallback_key(),this.storeAccount(e,t)}))}))}async createOutboundSession(e,t){let n;return await this.cryptoStore.doTxn("readwrite",[s.y.STORE_ACCOUNT,s.y.STORE_SESSIONS],(r=>{this.getAccount(r,(s=>{const o=new i.g.Olm.Session;try{o.create_outbound(s,e,t),n=o.session_id(),this.storeAccount(r,s);const i={session:o,lastReceivedMessageTs:Date.now()};this.saveSession(e,i,r)}finally{o.free()}}))}),r.v.getChild("[createOutboundSession]")),n}async createInboundSession(e,t,n){if(0!==t)throw new Error("Need messageType == 0 to create inbound session");let o;return await this.cryptoStore.doTxn("readwrite",[s.y.STORE_ACCOUNT,s.y.STORE_SESSIONS],(r=>{this.getAccount(r,(s=>{const a=new i.g.Olm.Session;try{a.create_inbound_from(s,e,n),s.remove_one_time_keys(a),this.storeAccount(r,s);const i=a.decrypt(t,n),c={session:a,lastReceivedMessageTs:Date.now()};this.saveSession(e,c,r),o={payload:i,session_id:a.session_id()}}finally{a.free()}}))}),r.v.getChild("[createInboundSession]")),o}async getSessionIdsForDevice(e){const t=r.v.getChild("[getSessionIdsForDevice]");if(e in this.sessionsInProgress){t.debug(`Waiting for Olm session for ${e} to be created`);try{await this.sessionsInProgress[e]}catch(e){}}let i;return await this.cryptoStore.doTxn("readonly",[s.y.STORE_SESSIONS],(t=>{this.cryptoStore.getEndToEndSessions(e,t,(e=>{i=Object.keys(e)}))}),t),i}async getSessionIdForDevice(e,t=!1,i){const n=await this.getSessionInfoForDevice(e,t,i);if(0===n.length)return null;let r=0;for(let e=1;e<n.length;e++){const t=n[e],i=void 0===t.lastReceivedMessageTs?0:t.lastReceivedMessageTs,s=n[r],o=void 0===s.lastReceivedMessageTs?0:s.lastReceivedMessageTs;(i>o||i===o&&t.sessionId<s.sessionId)&&(r=e)}return n[r].sessionId}async getSessionInfoForDevice(e,t=!1,i=r.v){if(i=i.getChild("[getSessionInfoForDevice]"),e in this.sessionsInProgress&&!t){i.debug(`Waiting for Olm session for ${e} to be created`);try{await this.sessionsInProgress[e]}catch(e){}}const n=[];return await this.cryptoStore.doTxn("readonly",[s.y.STORE_SESSIONS],(t=>{this.cryptoStore.getEndToEndSessions(e,t,(e=>{const t=Object.keys(e).sort();for(const i of t)this.unpickleSession(e[i],(e=>{n.push({lastReceivedMessageTs:e.lastReceivedMessageTs,hasReceivedMessage:e.session.has_received_message(),sessionId:i})}))}))}),i),n}async encryptMessage(e,t,i){let n;return d(i),await this.cryptoStore.doTxn("readwrite",[s.y.STORE_SESSIONS],(s=>{this.getSession(e,t,s,(o=>{const a=o.session.describe();r.v.log("encryptMessage: Olm Session ID "+t+" to "+e+": "+a),n=o.session.encrypt(i),this.saveSession(e,o,s)}))}),r.v.getChild("[encryptMessage]")),n}async decryptMessage(e,t,i,n){let o;return await this.cryptoStore.doTxn("readwrite",[s.y.STORE_SESSIONS],(s=>{this.getSession(e,t,s,(a=>{const c=a.session.describe();r.v.log("decryptMessage: Olm Session ID "+t+" from "+e+": "+c),o=a.session.decrypt(i,n),a.lastReceivedMessageTs=Date.now(),this.saveSession(e,a,s)}))}),r.v.getChild("[decryptMessage]")),o}async matchesSession(e,t,i,n){if(0!==i)return!1;let o;return await this.cryptoStore.doTxn("readonly",[s.y.STORE_SESSIONS],(i=>{this.getSession(e,t,i,(e=>{o=e.session.matches_inbound(n)}))}),r.v.getChild("[matchesSession]")),o}async recordSessionProblem(e,t,i){r.v.info(`Recording problem on olm session with ${e} of type ${t}. Recreating: ${i}`),await this.cryptoStore.storeEndToEndSessionProblem(e,t,i)}sessionMayHaveProblems(e,t){return this.cryptoStore.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.cryptoStore.filterOutNotifiedErrorDevices(e)}saveOutboundGroupSession(e){this.outboundGroupSessionStore[e.session_id()]=e.pickle(this.pickleKey)}getOutboundGroupSession(e,t){const n=this.outboundGroupSessionStore[e];if(void 0===n)throw new Error("Unknown outbound group session "+e);const r=new i.g.Olm.OutboundGroupSession;try{return r.unpickle(this.pickleKey,n),t(r)}finally{r.free()}}createOutboundGroupSession(){const e=new i.g.Olm.OutboundGroupSession;try{return e.create(),this.saveOutboundGroupSession(e),e.session_id()}finally{e.free()}}encryptGroupMessage(e,t){return r.v.log(`encrypting msg with megolm session ${e}`),d(t),this.getOutboundGroupSession(e,(e=>{const i=e.encrypt(t);return this.saveOutboundGroupSession(e),i}))}getOutboundGroupSessionKey(e){return this.getOutboundGroupSession(e,(function(e){return{chain_index:e.message_index(),key:e.session_key()}}))}unpickleInboundGroupSession(e,t){const n=new i.g.Olm.InboundGroupSession;try{return n.unpickle(this.pickleKey,e.session),t(n)}finally{n.free()}}getInboundGroupSession(e,t,i,n,r){this.cryptoStore.getEndToEndInboundGroupSession(t,i,n,((t,i)=>{if(null!==t){if(null!==e&&e!==t.room_id)throw new Error("Mismatched room_id for inbound group session (expected "+t.room_id+", was "+e+")");this.unpickleInboundGroupSession(t,(e=>{r(e,t,i)}))}else r(null,null,i)}))}async addInboundGroupSession(e,t,n,o,a,c,d,l={}){await this.cryptoStore.doTxn("readwrite",[s.y.STORE_INBOUND_GROUP_SESSIONS,s.y.STORE_INBOUND_GROUP_SESSIONS_WITHHELD,s.y.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],(s=>{this.getInboundGroupSession(e,t,o,s,((u,h)=>{const m=new i.g.Olm.InboundGroupSession;try{if(d?m.import_session(a):m.create(a),o!=m.session_id())throw new Error("Mismatched group session ID from senderKey: "+t);if(u&&(r.v.log(`Update for megolm session ${t}|${o}`),u.first_known_index()<=m.first_known_index())){if(!h.untrusted||l.untrusted)return void r.v.log(`Keeping existing megolm session ${t}|${o}`);if(u.first_known_index()<m.first_known_index())return void(u.export_session(m.first_known_index())===m.export_session(m.first_known_index())?(r.v.info(`Upgrading trust of existing megolm session ${t}|${o} based on newly-received trusted session`),h.untrusted=!1,this.cryptoStore.storeEndToEndInboundGroupSession(t,o,h,s)):r.v.warn(`Newly-received megolm session ${t}|$sessionId} does not match existing session! Keeping existing session`))}r.v.debug(`Storing megolm session ${t}|${o} with first index `+m.first_known_index());const i=Object.assign({},l,{room_id:e,session:m.pickle(this.pickleKey),keysClaimed:c,forwardingCurve25519KeyChain:n});this.cryptoStore.storeEndToEndInboundGroupSession(t,o,i,s),!u&&l.sharedHistory&&this.cryptoStore.addSharedHistoryInboundGroupSession(e,t,o,s)}finally{m.free()}}))}),r.v.getChild("[addInboundGroupSession]"))}async addInboundGroupSessionWithheld(e,t,i,n,r){await this.cryptoStore.doTxn("readwrite",[s.y.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(s=>{this.cryptoStore.storeEndToEndInboundGroupSessionWithheld(t,i,{room_id:e,code:n,reason:r},s)}))}async decryptGroupMessage(e,t,i,n,c,d){let l,u=null;if(await this.cryptoStore.doTxn("readwrite",[s.y.STORE_INBOUND_GROUP_SESSIONS,s.y.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(r=>{this.getInboundGroupSession(e,t,i,r,((e,s,m)=>{if(null===e||null===s)return m&&(l=new a.O(o.DecryptionFailureCode.MEGOLM_UNKNOWN_INBOUND_SESSION_ID,h(m),{session:t+"|"+i})),void(u=null);let p;try{p=e.decrypt(n)}catch(e){return void(l="OLM.UNKNOWN_MESSAGE_INDEX"===(null==e?void 0:e.message)&&m?new a.O(o.DecryptionFailureCode.MEGOLM_UNKNOWN_INBOUND_SESSION_ID,h(m),{session:t+"|"+i}):e)}let g=p.plaintext;if(void 0===g)g=p;else{const e=t+"|"+i+"|"+p.message_index;if(e in this.inboundGroupSessionMessageIndexes){const t=this.inboundGroupSessionMessageIndexes[e];if(t.id!==c||t.timestamp!==d)return void(l=new Error("Duplicate message index, possible replay attack: "+e))}this.inboundGroupSessionMessageIndexes[e]={id:c,timestamp:d}}s.session=e.pickle(this.pickleKey),this.cryptoStore.storeEndToEndInboundGroupSession(t,i,s,r),u={result:g,keysClaimed:s.keysClaimed||{},senderKey:t,forwardingCurve25519KeyChain:s.forwardingCurve25519KeyChain||[],untrusted:!!s.untrusted}}))}),r.v.getChild("[decryptGroupMessage]")),l)throw l;return u}async hasInboundSessionKeys(e,t,i){let n;return await this.cryptoStore.doTxn("readonly",[s.y.STORE_INBOUND_GROUP_SESSIONS,s.y.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(s=>{this.cryptoStore.getEndToEndInboundGroupSession(t,i,s,(s=>{null!==s?e!==s.room_id?(r.v.warn(`requested keys for inbound group session ${t}|${i}, with incorrect room_id (expected ${s.room_id}, was ${e})`),n=!1):n=!0:n=!1}))}),r.v.getChild("[hasInboundSessionKeys]")),n}async getInboundGroupSessionKey(e,t,i,n){let o=null;return await this.cryptoStore.doTxn("readonly",[s.y.STORE_INBOUND_GROUP_SESSIONS,s.y.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(r=>{this.getInboundGroupSession(e,t,i,r,((e,t)=>{if(null===e||null===t)return void(o=null);void 0===n&&(n=e.first_known_index());const i=e.export_session(n),r=(t.keysClaimed||{}).ed25519||null,s=t.forwardingCurve25519KeyChain||[],a="untrusted"in t?t.untrusted:s.length>0;o={chain_index:n,key:i,forwarding_curve25519_key_chain:s,sender_claimed_ed25519_key:r,shared_history:t.sharedHistory||!1,untrusted:a}}))}),r.v.getChild("[getInboundGroupSessionKey]")),o}exportInboundGroupSession(e,t,i){return this.unpickleInboundGroupSession(i,(n=>{const r=n.first_known_index();return{sender_key:e,sender_claimed_keys:i.keysClaimed,room_id:i.room_id,session_id:t,session_key:n.export_session(r),forwarding_curve25519_key_chain:i.forwardingCurve25519KeyChain||[],first_known_index:n.first_known_index(),"org.matrix.msc3061.shared_history":i.sharedHistory||!1}}))}async getSharedHistoryInboundGroupSessions(e){let t;return await this.cryptoStore.doTxn("readonly",[s.y.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],(i=>{t=this.cryptoStore.getSharedHistoryInboundGroupSessions(e,i)}),r.v.getChild("[getSharedHistoryInboundGroupSessionsForRoom]")),t}verifySignature(e,t,i){this.getUtility((function(n){n.ed25519_verify(e,t,i)}))}}const u={"m.unverified":"The sender has disabled encrypting to unverified devices.","m.blacklisted":"The sender has blocked you.","m.unauthorised":"You are not authorised to read the message.","m.no_olm":"Unable to establish a secure channel."};function h(e){return e.code&&e.code in u?u[e.code]:e.reason?e.reason:"decryption key withheld"}},"./node_modules/matrix-js-sdk/src/crypto/OutgoingRoomKeyRequestManager.ts":(e,t,i)=>{"use strict";i.d(t,{j:()=>l,z:()=>u});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/uuid/dist/esm-browser/v4.js"),s=i("./node_modules/matrix-js-sdk/src/logger.ts"),o=i("./node_modules/matrix-js-sdk/src/@types/event.ts"),a=i("./node_modules/matrix-js-sdk/src/utils.ts");function c(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function d(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?c(Object(i),!0).forEach((function(t){(0,n.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):c(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let l=function(e){return e[e.Unsent=0]="Unsent",e[e.Sent=1]="Sent",e[e.CancellationPending=2]="CancellationPending",e[e.CancellationPendingAndWillResend=3]="CancellationPendingAndWillResend",e}({});class u{constructor(e,t,i){this.baseApis=e,this.deviceId=t,this.cryptoStore=i,(0,n.A)(this,"sendOutgoingRoomKeyRequestsTimer",void 0),(0,n.A)(this,"sendOutgoingRoomKeyRequestsRunning",!1),(0,n.A)(this,"clientRunning",!0)}stop(){s.v.log("stopping OutgoingRoomKeyRequestManager"),this.clientRunning=!1}sendQueuedRequests(){this.startTimer()}async queueRoomKeyRequest(e,t,i=!1){const n=await this.cryptoStore.getOutgoingRoomKeyRequest(e);if(n)switch(n.state){case l.CancellationPendingAndWillResend:case l.Unsent:return;case l.CancellationPending:{const e=i?l.CancellationPendingAndWillResend:l.Sent;await this.cryptoStore.updateOutgoingRoomKeyRequest(n.requestId,l.CancellationPending,{state:e,cancellationTxnId:this.baseApis.makeTxnId()});break}case l.Sent:if(i){const r=l.CancellationPendingAndWillResend,o=await this.cryptoStore.updateOutgoingRoomKeyRequest(n.requestId,l.Sent,{state:r,cancellationTxnId:this.baseApis.makeTxnId(),requestTxnId:this.baseApis.makeTxnId()});if(!o)return this.queueRoomKeyRequest(e,t,i);try{await this.sendOutgoingRoomKeyRequestCancellation(o,!0)}catch(e){s.v.error("Error sending room key request cancellation; will retry later.",e)}}break;default:throw new Error("unhandled state: "+n.state)}else await this.cryptoStore.getOrAddOutgoingRoomKeyRequest({requestBody:e,recipients:t,requestId:this.baseApis.makeTxnId(),state:l.Unsent})}cancelRoomKeyRequest(e){return this.cryptoStore.getOutgoingRoomKeyRequest(e).then((t=>{if(t)switch(t.state){case l.CancellationPending:case l.CancellationPendingAndWillResend:return;case l.Unsent:return s.v.log("deleting unnecessary room key request for "+h(e)),this.cryptoStore.deleteOutgoingRoomKeyRequest(t.requestId,l.Unsent);case l.Sent:return this.cryptoStore.updateOutgoingRoomKeyRequest(t.requestId,l.Sent,{state:l.CancellationPending,cancellationTxnId:this.baseApis.makeTxnId()}).then((t=>{t?this.sendOutgoingRoomKeyRequestCancellation(t).catch((e=>{s.v.error("Error sending room key request cancellation; will retry later.",e),this.startTimer()})):s.v.log("Tried to cancel room key request for "+h(e)+" but it was already cancelled in another tab")}));default:throw new Error("unhandled state: "+t.state)}}))}getOutgoingSentRoomKeyRequest(e,t){return this.cryptoStore.getOutgoingRoomKeyRequestsByTarget(e,t,[l.Sent])}async cancelAndResendAllOutgoingRequests(){const e=await this.cryptoStore.getAllOutgoingRoomKeyRequestsByState(l.Sent);return Promise.all(e.map((({requestBody:e,recipients:t})=>this.queueRoomKeyRequest(e,t,!0))))}startTimer(){if(this.sendOutgoingRoomKeyRequestsTimer)return;this.sendOutgoingRoomKeyRequestsTimer=setTimeout((()=>{if(this.sendOutgoingRoomKeyRequestsRunning)throw new Error("RoomKeyRequestSend already in progress!");this.sendOutgoingRoomKeyRequestsRunning=!0,this.sendOutgoingRoomKeyRequests().finally((()=>{this.sendOutgoingRoomKeyRequestsRunning=!1})).catch((e=>{s.v.warn(`error in OutgoingRoomKeyRequestManager: ${e}`)}))}),500)}async sendOutgoingRoomKeyRequests(){if(!this.clientRunning)return void(this.sendOutgoingRoomKeyRequestsTimer=void 0);const e=await this.cryptoStore.getOutgoingRoomKeyRequestByState([l.CancellationPending,l.CancellationPendingAndWillResend,l.Unsent]);if(e)try{switch(e.state){case l.Unsent:await this.sendOutgoingRoomKeyRequest(e);break;case l.CancellationPending:await this.sendOutgoingRoomKeyRequestCancellation(e);break;case l.CancellationPendingAndWillResend:await this.sendOutgoingRoomKeyRequestCancellation(e,!0)}return this.sendOutgoingRoomKeyRequests()}catch(e){s.v.error("Error sending room key request; will retry later.",e),this.sendOutgoingRoomKeyRequestsTimer=void 0}else this.sendOutgoingRoomKeyRequestsTimer=void 0}sendOutgoingRoomKeyRequest(e){s.v.log(`Requesting keys for ${h(e.requestBody)} from ${m(e.recipients)}(id ${e.requestId})`);const t={action:"request",requesting_device_id:this.deviceId,request_id:e.requestId,body:e.requestBody};return this.sendMessageToDevices(t,e.recipients,e.requestTxnId||e.requestId).then((()=>this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,l.Unsent,{state:l.Sent})))}sendOutgoingRoomKeyRequestCancellation(e,t=!1){s.v.log(`Sending cancellation for key request for ${h(e.requestBody)} to ${m(e.recipients)} (cancellation id ${e.cancellationTxnId})`);const i={action:"request_cancellation",requesting_device_id:this.deviceId,request_id:e.requestId};return this.sendMessageToDevices(i,e.recipients,e.cancellationTxnId).then((()=>t?this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,l.CancellationPendingAndWillResend,{state:l.Unsent}):this.cryptoStore.deleteOutgoingRoomKeyRequest(e.requestId,l.CancellationPending)))}sendMessageToDevices(e,t,i){const n=new a.kG((()=>new Map));for(const i of t){n.getOrCreate(i.userId).set(i.deviceId,d(d({},e),{},{[o.wt]:(0,r.A)()}))}return this.baseApis.sendToDevice(o.Bx.RoomKeyRequest,n,i)}}function h(e){return e.room_id+" / "+e.session_id}function m(e){return`[${e.map((e=>`${e.userId}:${e.deviceId}`)).join(",")}]`}},"./node_modules/matrix-js-sdk/src/crypto/aes.ts":(e,t,i)=>{"use strict";i.d(t,{VK:()=>a,iV:()=>l,r9:()=>o});var n=i("./node_modules/matrix-js-sdk/src/base64.ts"),r=i("./node_modules/matrix-js-sdk/src/crypto/crypto.ts");const s=new Uint8Array(8);async function o(e,t,i,s){let o;s?o=(0,n.y4)(s):(o=new Uint8Array(16),r.Et.getRandomValues(o),o[8]&=127);const[a,d]=await c(t,i),l=(new r._3).encode(e),u=await r.n1.encrypt({name:"AES-CTR",counter:o,length:64},a,l),h=await r.n1.sign({name:"HMAC"},d,u);return{iv:(0,n.WG)(o),ciphertext:(0,n.WG)(u),mac:(0,n.WG)(h)}}async function a(e,t,i){const[s,o]=await c(t,i),a=(0,n.y4)(e.ciphertext);if(!await r.n1.verify({name:"HMAC"},o,(0,n.y4)(e.mac),a))throw new Error(`Error decrypting secret ${i}: bad MAC`);const d=await r.n1.decrypt({name:"AES-CTR",counter:(0,n.y4)(e.iv),length:64},s,a);return(new TextDecoder).decode(new Uint8Array(d))}async function c(e,t){const i=await r.n1.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),n=await r.n1.deriveBits({name:"HKDF",salt:s,info:(new r._3).encode(t),hash:"SHA-256"},i,512),o=n.slice(0,32),a=n.slice(32),c=r.n1.importKey("raw",o,{name:"AES-CTR"},!1,["encrypt","decrypt"]),d=r.n1.importKey("raw",a,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return Promise.all([c,d])}const d="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0";function l(e,t){return o(d,e,"",t)}},"./node_modules/matrix-js-sdk/src/crypto/algorithms/base.ts":(e,t,i)=>{"use strict";i.d(t,{Jn:()=>s,Tb:()=>a,V5:()=>c,l1:()=>r,li:()=>o,x:()=>d});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js");i("./node_modules/matrix-js-sdk/src/common-crypto/CryptoBackend.ts");const r=new Map,s=new Map;class o{constructor(e){(0,n.A)(this,"userId",void 0),(0,n.A)(this,"deviceId",void 0),(0,n.A)(this,"crypto",void 0),(0,n.A)(this,"olmDevice",void 0),(0,n.A)(this,"baseApis",void 0),(0,n.A)(this,"roomId",void 0),this.userId=e.userId,this.deviceId=e.deviceId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis,this.roomId=e.roomId}prepareToEncrypt(e){}onRoomMembership(e,t,i){}}class a{constructor(e){(0,n.A)(this,"userId",void 0),(0,n.A)(this,"crypto",void 0),(0,n.A)(this,"olmDevice",void 0),(0,n.A)(this,"baseApis",void 0),(0,n.A)(this,"roomId",void 0),this.userId=e.userId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis,this.roomId=e.roomId}async onRoomKeyEvent(e){}async importRoomKey(e,t){}hasKeysForKeyRequest(e){return Promise.resolve(!1)}shareKeysWithDevice(e){throw new Error("shareKeysWithDevice not supported for this DecryptionAlgorithm")}async retryDecryptionFromSender(e){return!1}}class c extends Error{constructor(e,t,i){super(e),this.devices=t,this.event=i,this.name="UnknownDeviceError",this.devices=t}}function d(e,t,i){r.set(e,t),s.set(e,i)}},"./node_modules/matrix-js-sdk/src/crypto/algorithms/megolm.ts":(e,t,i)=>{"use strict";i.d(t,{hk:()=>f});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/uuid/dist/esm-browser/v4.js"),s=i("./node_modules/matrix-js-sdk/src/logger.ts"),o=i("./node_modules/matrix-js-sdk/src/crypto/olmlib.ts"),a=i("./node_modules/matrix-js-sdk/src/crypto/algorithms/base.ts"),c=i("./node_modules/matrix-js-sdk/src/crypto/OlmDevice.ts"),d=i("./node_modules/matrix-js-sdk/src/@types/event.ts"),l=i("./node_modules/matrix-js-sdk/src/crypto/OutgoingRoomKeyRequestManager.ts"),u=i("./node_modules/matrix-js-sdk/src/utils.ts"),h=i("./node_modules/matrix-js-sdk/src/@types/membership.ts"),m=i("./node_modules/matrix-js-sdk/src/crypto-api.ts"),p=i("./node_modules/matrix-js-sdk/src/common-crypto/CryptoBackend.ts");function g(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function v(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?g(Object(i),!0).forEach((function(t){(0,n.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):g(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function f(e){var t,i;const n=null==e||null===(t=e.currentState)||void 0===t?void 0:t.getStateEvents("m.room.history_visibility",""),r=null==n||null===(i=n.getContent())||void 0===i?void 0:i.history_visibility;return["world_readable","shared"].includes(r)}const y=e=>"string"==typeof e.ciphertext?!!e.ciphertext.length:!!Object.keys(e.ciphertext).length;class b{constructor(e,t=!1){this.sessionId=e,this.sharedHistory=t,(0,n.A)(this,"useCount",0),(0,n.A)(this,"creationTime",void 0),(0,n.A)(this,"sharedWithDevices",new u.kG((()=>new Map))),(0,n.A)(this,"blockedDevicesNotified",new u.kG((()=>new Map))),this.creationTime=(new Date).getTime()}needsRotation(e,t){const i=(new Date).getTime()-this.creationTime;return(this.useCount>=e||i>=t)&&(s.v.log("Rotating megolm session after "+this.useCount+" messages, "+i+"ms"),!0)}markSharedWithDevice(e,t,i,n){this.sharedWithDevices.getOrCreate(e).set(t,{deviceKey:i,messageIndex:n})}markNotifiedBlockedDevice(e,t){this.blockedDevicesNotified.getOrCreate(e).set(t,!0)}sharedWithTooManyDevices(e){for(const[i,n]of this.sharedWithDevices){if(!e.has(i))return s.v.log("Starting new megolm session because we shared with "+i),!0;for(const[r]of n){var t;if(null===(t=e.get(i))||void 0===t||!t.get(r))return s.v.log("Starting new megolm session because we shared with "+i+":"+r),!0}}return!1}}class S extends a.li{constructor(e){var t,i,r,o;super(e),(0,n.A)(this,"setupPromise",Promise.resolve(null)),(0,n.A)(this,"outboundSessions",{}),(0,n.A)(this,"sessionRotationPeriodMsgs",void 0),(0,n.A)(this,"sessionRotationPeriodMs",void 0),(0,n.A)(this,"encryptionPreparation",void 0),(0,n.A)(this,"roomId",void 0),(0,n.A)(this,"prefixedLogger",void 0),this.roomId=e.roomId,this.prefixedLogger=s.v.getChild(`[${this.roomId} encryption]`),this.sessionRotationPeriodMsgs=null!==(t=null===(i=e.config)||void 0===i?void 0:i.rotation_period_msgs)&&void 0!==t?t:100,this.sessionRotationPeriodMs=null!==(r=null===(o=e.config)||void 0===o?void 0:o.rotation_period_ms)&&void 0!==r?r:6048e5}async ensureOutboundSession(e,t,i,n=!1){const r=this.setupPromise.then((async r=>{const s=f(e),o=await this.prepareSession(t,s,r);return await this.shareSession(t,s,n,i,o),o}));return this.setupPromise=r.catch((e=>(this.prefixedLogger.error("Failed to setup outbound session",e),null))),r}async prepareSession(e,t,i){var n,r;return i&&t!==i.sharedHistory&&(i=null),null!==(n=i)&&void 0!==n&&n.needsRotation(this.sessionRotationPeriodMsgs,this.sessionRotationPeriodMs)&&(this.prefixedLogger.debug("Starting new megolm session because we need to rotate."),i=null),null!==(r=i)&&void 0!==r&&r.sharedWithTooManyDevices(e)&&(i=null),i||(this.prefixedLogger.debug("Starting new megolm session"),i=await this.prepareNewSession(t),this.prefixedLogger.debug(`Started new megolm session ${i.sessionId}`),this.outboundSessions[i.sessionId]=i),i}async shareSession(e,t,i,n,r){const s={};for(const[t,i]of e)for(const[e,n]of i){var a;n.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&(null!==(a=r.sharedWithDevices.get(t))&&void 0!==a&&a.get(e)||(s[t]=s[t]||[],s[t].push(n)))}const c=this.olmDevice.getOutboundGroupSessionKey(r.sessionId),d={type:"m.room_key",content:{algorithm:o.MEGOLM_ALGORITHM,room_id:this.roomId,session_id:r.sessionId,session_key:c.key,chain_index:c.chain_index,"org.matrix.msc3061.shared_history":t}},[l,h]=await o.getExistingOlmSessions(this.olmDevice,this.baseApis,s);await Promise.all([(async()=>{const e=Array.from(h.entries()).map((([e,t])=>Array.from(t.entries()).map((([t,i])=>`${e}/${t}: ${i.sessionId}`)))).flat(1);this.prefixedLogger.debug("Sharing keys with devices with existing Olm sessions:",e),await this.shareKeyWithOlmSessions(r,c,d,h),this.prefixedLogger.debug("Shared keys with existing Olm sessions")})(),(async()=>{const e=Array.from(l.entries()).map((([e,t])=>t.map((t=>`${e}/${t.deviceId}`)))).flat(1);this.prefixedLogger.debug("Sharing keys (start phase 1) with devices without existing Olm sessions:",e);const t=[],n=Date.now(),s=[];await this.shareKeyWithDevices(r,c,d,l,t,i?1e4:2e3,s),this.prefixedLogger.debug("Shared keys (end phase 1) with devices without existing Olm sessions"),!i&&Date.now()-n<1e4?(async()=>{const e=new u.kG((()=>[])),i=new Set;for(const e of s)i.add(e);const n=[];for(const{userId:r,deviceInfo:s}of t){const t=r.slice(r.indexOf(":")+1);i.has(t)?e.getOrCreate(r).push(s):n.push({userId:r,deviceInfo:s})}const o=Array.from(e.entries()).map((([e,t])=>t.map((t=>`${e}/${t.deviceId}`)))).flat(1);o.length>0&&(this.prefixedLogger.debug("Sharing keys (start phase 2) with devices without existing Olm sessions:",o),await this.shareKeyWithDevices(r,c,d,e,n,3e4),this.prefixedLogger.debug("Shared keys (end phase 2) with devices without existing Olm sessions")),await this.notifyFailedOlmDevices(r,c,n)})():await this.notifyFailedOlmDevices(r,c,t)})(),(async()=>{this.prefixedLogger.debug(`There are ${n.size} blocked devices:`,Array.from(n.entries()).map((([e,t])=>Array.from(t.entries()).map((([t,i])=>`${e}/${t}`)))).flat(1));const e=new u.kG((()=>new Map));let t=0;for(const[s,o]of n)for(const[n,a]of o){var i;void 0===(null===(i=r.blockedDevicesNotified.get(s))||void 0===i?void 0:i.get(n))&&(e.getOrCreate(s).set(n,{device:a}),t++)}t&&(this.prefixedLogger.debug(`Notifying ${t} newly blocked devices:`,Array.from(e.entries()).map((([e,t])=>Object.entries(t).map((([t,i])=>`${e}/${t}`)))).flat(1)),await this.notifyBlockedDevices(r,e),this.prefixedLogger.debug(`Notified ${t} newly blocked devices`))})()])}async prepareNewSession(e){const t=this.olmDevice.createOutboundGroupSession(),i=this.olmDevice.getOutboundGroupSessionKey(t);return await this.olmDevice.addInboundGroupSession(this.roomId,this.olmDevice.deviceCurve25519Key,[],t,i.key,{ed25519:this.olmDevice.deviceEd25519Key},!1,{sharedHistory:e}),this.crypto.backupManager.backupGroupSession(this.olmDevice.deviceCurve25519Key,t),new b(t,e)}getDevicesWithoutSessions(e,t,i=[]){for(const[n,r]of t){const t=e.get(n);for(const e of r){const r=e.deviceId,s=null==t?void 0:t.get(r);null!=s&&s.sessionId||(i.push({userId:n,deviceInfo:e}),null==t||t.delete(r))}}return i}splitDevices(e){let t=[];const i=[t];for(const[n,r]of e){for(const e of r.values())t.push({userId:n,deviceInfo:e.device});t.length>20&&(t=[],i.push(t))}return 0===t.length&&i.pop(),i}encryptAndSendKeysToDevices(e,t,i,n){return this.crypto.encryptAndSendToDevices(i,n).then((()=>{for(const n of i)e.markSharedWithDevice(n.userId,n.deviceInfo.deviceId,n.deviceInfo.getIdentityKey(),t)})).catch((e=>{throw this.prefixedLogger.error("failed to encryptAndSendToDevices",e),e}))}async sendBlockedNotificationsToDevices(e,t,i){const n=new u.kG((()=>new Map));for(const e of t){const t=e.userId,s=e.deviceInfo,o=s.deviceInfo.deviceId,a=v(v({},i),{},{code:s.code,reason:s.reason,[d.wt]:(0,r.A)()});"m.no_olm"===a.code&&(delete a.room_id,delete a.session_id),n.getOrCreate(t).set(o,a)}await this.baseApis.sendToDevice("m.room_key.withheld",n);for(const[t,i]of n)for(const n of i.keys())e.markNotifiedBlockedDevice(t,n)}async reshareKeyWithDevice(e,t,i,n){var s;const a=this.outboundSessions[t];if(!a)return void this.prefixedLogger.debug(`megolm session ${e}|${t} not found: not re-sharing keys`);if(!a.sharedWithDevices.has(i))return void this.prefixedLogger.debug(`megolm session ${e}|${t} never shared with user ${i}`);const c=null===(s=a.sharedWithDevices.get(i))||void 0===s?void 0:s.get(n.deviceId);if(void 0===c)return void this.prefixedLogger.debug(`megolm session ${e}|${t} never shared with device ${i}:${n.deviceId}`);if(c.deviceKey!==n.getIdentityKey())return void this.prefixedLogger.warn(`Megolm session ${e}|${t} has been shared with device ${n.deviceId} but with identity key ${c.deviceKey}. Key is now ${n.getIdentityKey()}!`);const l=await this.olmDevice.getInboundGroupSessionKey(this.roomId,e,t,c.messageIndex);if(!l)return void this.prefixedLogger.warn(`No inbound session key found for megolm session ${e}|${t}: not re-sharing keys`);await o.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[i,[n]]]));const u={type:"m.forwarded_room_key",content:{algorithm:o.MEGOLM_ALGORITHM,room_id:this.roomId,session_id:t,session_key:l.key,chain_index:l.chain_index,sender_key:e,sender_claimed_ed25519_key:l.sender_claimed_ed25519_key,forwarding_curve25519_key_chain:l.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":l.shared_history||!1}},h={algorithm:o.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[d.wt]:(0,r.A)()};await o.encryptMessageForDevice(h.ciphertext,this.userId,this.deviceId,this.olmDevice,i,n,u),await this.baseApis.sendToDevice("m.room.encrypted",new Map([[i,new Map([[n.deviceId,h]])]])),this.prefixedLogger.debug(`Re-shared key for megolm session ${e}|${t} with ${i}:${n.deviceId}`)}async shareKeyWithDevices(e,t,i,n,r,s,a){const c=await o.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,n,!1,s,a,this.prefixedLogger);this.getDevicesWithoutSessions(c,n,r),await this.shareKeyWithOlmSessions(e,t,i,c)}async shareKeyWithOlmSessions(e,t,i,n){const r=this.splitDevices(n);for(let n=0;n<r.length;n++){const s=`megolm keys for ${e.sessionId} (slice ${n+1}/${r.length})`;try{this.prefixedLogger.debug(`Sharing ${s}`,r[n].map((e=>`${e.userId}/${e.deviceInfo.deviceId}`))),await this.encryptAndSendKeysToDevices(e,t.chain_index,r[n],i),this.prefixedLogger.debug(`Shared ${s}`)}catch(e){throw this.prefixedLogger.error(`Failed to share ${s}`),e}}}async notifyFailedOlmDevices(e,t,i){this.prefixedLogger.debug(`Notifying ${i.length} devices we failed to create Olm sessions`);for(const{userId:n,deviceInfo:r}of i){const i=r.deviceId;e.markSharedWithDevice(n,i,r.getIdentityKey(),t.chain_index)}const n=await this.olmDevice.filterOutNotifiedErrorDevices(i);this.prefixedLogger.debug(`Need to notify ${n.length} failed devices which haven't been notified before`);const r=new u.kG((()=>new Map));for(const{userId:e,deviceInfo:t}of n)r.getOrCreate(e).set(t.deviceId,{device:{code:"m.no_olm",reason:c.nC["m.no_olm"],deviceInfo:t}});await this.notifyBlockedDevices(e,r),this.prefixedLogger.debug(`Notified ${n.length} devices we failed to create Olm sessions`)}async notifyBlockedDevices(e,t){const i={room_id:this.roomId,session_id:e.sessionId,algorithm:o.MEGOLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key},n=this.splitDevices(t);for(let t=0;t<n.length;t++)try{await this.sendBlockedNotificationsToDevices(e,n[t],i),this.prefixedLogger.debug(`Completed blacklist notification for ${e.sessionId} (slice ${t+1}/${n.length})`)}catch(i){throw this.prefixedLogger.debug(`blacklist notification for ${e.sessionId} (slice ${t+1}/${n.length}) failed`),i}}prepareToEncrypt(e){if(e.roomId!==this.roomId)throw new Error("MegolmEncryption.prepareToEncrypt called on unexpected room");if(null!=this.encryptionPreparation){const e=Date.now()-this.encryptionPreparation.startTime;return this.prefixedLogger.debug(`Already started preparing to encrypt for this room ${e}ms ago, skipping`),this.encryptionPreparation.cancel}this.prefixedLogger.debug("Preparing to encrypt events");let t=!1;const i=()=>t;return this.encryptionPreparation={startTime:Date.now(),promise:(async()=>{try{const t=await this.getDevicesInRoom(e,!1,i);if(null===t)return;const[n,r]=t;this.crypto.globalErrorOnUnknownDevices&&this.removeUnknownDevices(n),this.prefixedLogger.debug("Ensuring outbound megolm session"),await this.ensureOutboundSession(e,n,r,!0),this.prefixedLogger.debug("Ready to encrypt events")}catch(e){this.prefixedLogger.error("Failed to prepare to encrypt events",e)}finally{delete this.encryptionPreparation}})(),cancel:()=>{t=!0,delete this.encryptionPreparation}},this.encryptionPreparation.cancel}async encryptMessage(e,t,i){if(this.prefixedLogger.debug("Starting to encrypt event"),null!=this.encryptionPreparation)try{await this.encryptionPreparation.promise}catch(e){}const n=this.isVerificationEvent(t,i),[r,s]=await this.getDevicesInRoom(e,n);this.crypto.globalErrorOnUnknownDevices&&this.checkForUnknownDevices(r);const a=await this.ensureOutboundSession(e,r,s),c={room_id:this.roomId,type:t,content:i},d=this.olmDevice.encryptGroupMessage(a.sessionId,JSON.stringify(c)),l={algorithm:o.MEGOLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:d,session_id:a.sessionId,device_id:this.deviceId};return a.useCount++,l}isVerificationEvent(e,t){switch(e){case d.Bx.KeyVerificationCancel:case d.Bx.KeyVerificationDone:case d.Bx.KeyVerificationMac:case d.Bx.KeyVerificationStart:case d.Bx.KeyVerificationKey:case d.Bx.KeyVerificationReady:case d.Bx.KeyVerificationAccept:return!0;case d.Bx.RoomMessage:return t.msgtype===d.Wr.KeyVerificationRequest;default:return!1}}forceDiscardSession(){this.setupPromise=this.setupPromise.then((()=>null))}checkForUnknownDevices(e){const t=new u.kG((()=>new Map));for(const[i,n]of e)for(const[e,r]of n)r.isUnverified()&&!r.isKnown()&&t.getOrCreate(i).set(e,r);if(t.size)throw new a.V5("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",t)}removeUnknownDevices(e){for(const[t,i]of e){for(const[e,t]of i)t.isUnverified()&&!t.isKnown()&&i.delete(e);0===i.size&&e.delete(t)}}async getDevicesInRoom(e,t=!1,i){const n=await e.getEncryptionTargetMembers();this.prefixedLogger.debug(`Encrypting for users (shouldEncryptForInvitedMembers: ${e.shouldEncryptForInvitedMembers()}):`,n.map((e=>`${e.userId} (${e.membership})`)));const r=n.map((function(e){return e.userId}));let s=this.crypto.globalBlacklistUnverifiedDevices;const o=e.getBlacklistUnverifiedDevices();"boolean"==typeof o&&(s=o);const a=await this.crypto.downloadKeys(r,!1);if(!0===(null==i?void 0:i()))return null;const d=new u.kG((()=>new Map));for(const[e,n]of a)for(const[r,o]of n){if(void 0!==i&&await(0,u.iH)(),!0===(null==i?void 0:i()))return null;const a=this.crypto.checkDeviceTrust(e,r);if(o.isBlocked()||!a.isVerified()&&s&&!t){const t=d.getOrCreate(e),i=o.isBlocked();t.set(r,{code:i?"m.blacklisted":"m.unverified",reason:c.nC[i?"m.blacklisted":"m.unverified"],deviceInfo:o}),n.delete(r)}}return[a,d]}}class w extends a.Tb{constructor(e){super(e),(0,n.A)(this,"pendingEvents",new Map),(0,n.A)(this,"olmlib",o),(0,n.A)(this,"roomId",void 0),(0,n.A)(this,"prefixedLogger",void 0),this.roomId=e.roomId,this.prefixedLogger=s.v.getChild(`[${this.roomId} decryption]`)}async decryptEvent(e){const t=e.getWireContent();if(!t.sender_key||!t.session_id||!t.ciphertext)throw new p.O(m.DecryptionFailureCode.MEGOLM_MISSING_FIELDS,"Missing fields in input");let i;this.addEventToPendingList(e);try{i=await this.olmDevice.decryptGroupMessage(e.getRoomId(),t.sender_key,t.session_id,t.ciphertext,e.getId(),e.getTs())}catch(i){if("DecryptionError"===i.name)throw i;let n=m.DecryptionFailureCode.OLM_DECRYPT_GROUP_MESSAGE_ERROR;throw"OLM.UNKNOWN_MESSAGE_INDEX"===(null==i?void 0:i.message)&&(this.requestKeysForEvent(e),n=m.DecryptionFailureCode.OLM_UNKNOWN_MESSAGE_INDEX),new p.O(n,i instanceof Error?i.message:"Unknown Error: Error is undefined",{session:t.sender_key+"|"+t.session_id})}if(null===i){this.crypto.backupManager.queryKeyBackupRateLimited(e.getRoomId(),t.session_id).catch((()=>{})),this.requestKeysForEvent(e);const i=await this.olmDevice.sessionMayHaveProblems(t.sender_key,e.getTs()-12e4);if(i){this.prefixedLogger.info(`When handling UISI from ${e.getSender()} (sender key ${t.sender_key}): recent session problem with that sender:`,i);let n=_[i.type]||_.unknown;throw i.fixed&&(n+=" Trying to create a new secure channel and re-requesting the keys."),new p.O(m.DecryptionFailureCode.MEGOLM_UNKNOWN_INBOUND_SESSION_ID,n,{session:t.sender_key+"|"+t.session_id})}throw new p.O(m.DecryptionFailureCode.MEGOLM_UNKNOWN_INBOUND_SESSION_ID,"The sender's device has not sent us the keys for this message.",{session:t.sender_key+"|"+t.session_id})}i.untrusted||this.removeEventFromPendingList(e);const n=JSON.parse(i.result);if(n.room_id!==e.getRoomId())throw new p.O(m.DecryptionFailureCode.MEGOLM_BAD_ROOM,"Message intended for room "+n.room_id);return{clearEvent:n,senderCurve25519Key:i.senderKey,claimedEd25519Key:i.keysClaimed.ed25519,forwardingCurve25519KeyChain:i.forwardingCurve25519KeyChain,untrusted:i.untrusted}}requestKeysForEvent(e){const t=e.getWireContent(),i=e.getKeyRequestRecipients(this.userId);this.crypto.requestRoomKey({room_id:e.getRoomId(),algorithm:t.algorithm,sender_key:t.sender_key,session_id:t.session_id},i)}addEventToPendingList(e){var t;const i=e.getWireContent(),n=i.sender_key,r=i.session_id;this.pendingEvents.has(n)||this.pendingEvents.set(n,new Map);const s=this.pendingEvents.get(n);s.has(r)||s.set(r,new Set),null===(t=s.get(r))||void 0===t||t.add(e)}removeEventFromPendingList(e){const t=e.getWireContent(),i=t.sender_key,n=t.session_id,r=this.pendingEvents.get(i),s=null==r?void 0:r.get(n);s&&(s.delete(e),0===s.size&&r.delete(n),0===r.size&&this.pendingEvents.delete(i))}roomKeyFromEvent(e){const t=e.getSenderKey(),i=e.getContent(),n={};if(!(i.room_id&&i.session_key&&i.session_id&&i.algorithm))return void this.prefixedLogger.error("key event is missing fields");if(!o.isOlmEncrypted(e))return void this.prefixedLogger.error("key event not properly encrypted");i["org.matrix.msc3061.shared_history"]&&(n.sharedHistory=!0);return{senderKey:t,sessionId:i.session_id,sessionKey:i.session_key,extraSessionData:n,exportFormat:!1,roomId:i.room_id,algorithm:i.algorithm,forwardingKeyChain:[],keysClaimed:e.getKeysClaimed()}}forwardedRoomKeyFromEvent(e){const t=this.roomKeyFromEvent(e);if(!t)return;const i=e.getSenderKey(),n=e.getContent(),r=this.baseApis.crypto.deviceList.getUserByIdentityKey(o.OLM_ALGORITHM,i),s=n.sender_key,a=n.sender_claimed_ed25519_key;let c=Array.isArray(n.forwarding_curve25519_key_chain)?n.forwarding_curve25519_key_chain:[];if(c=c.slice(),c.push(i),r!==e.getSender())return void this.prefixedLogger.error("sending device does not belong to the user it claims to be from");if(!s)return void this.prefixedLogger.error("forwarded_room_key event is missing sender_key field");if(!a)return void this.prefixedLogger.error("forwarded_room_key_event is missing sender_claimed_ed25519_key field");const d={ed25519:a};return t.senderKey=s,t.keysClaimed=d,t.exportFormat=!0,t.forwardingKeyChain=c,t.extraSessionData.untrusted=!0,t}async shouldAcceptForwardedKey(e,t){var i;const n=e.getSenderKey(),r=null!==(i=this.crypto.deviceList.getDeviceByIdentityKey(o.OLM_ALGORITHM,n))&&void 0!==i?i:void 0,s=this.crypto.checkDeviceInfoTrust(e.getSender(),r),a=e.getSender()===this.baseApis.getUserId(),c=s.isVerified()&&a,d=await this.wasRoomKeyRequested(e,t),l=this.wasRoomKeyForwardedByInviter(e,t),u=this.wasRoomKeyForwardedAsHistory(t);return d&&c||l&&u}async wasRoomKeyRequested(e,t){return(await this.crypto.cryptoStore.getOutgoingRoomKeyRequestsByTarget(e.getSender(),"*",[l.j.Sent])).some((e=>e.requestBody.room_id===t.roomId&&e.requestBody.session_id===t.sessionId))}wasRoomKeyForwardedByInviter(e,t){var i,n,r;const s=this.baseApis.getRoom(t.roomId),a=e.getSenderKey();if(!a)return!1;const c=this.crypto.deviceList.getUserByIdentityKey(o.OLM_ALGORITHM,a);if(!c)return!1;const d=null==s||null===(i=s.getMember(this.userId))||void 0===i?void 0:i.events.member,l=(null==d?void 0:d.getSender())===c||(null==d||null===(n=d.getUnsigned())||void 0===n?void 0:n.prev_sender)===c&&(null==d||null===(r=d.getPrevContent())||void 0===r?void 0:r.membership)===h.O.Invite;return!(!s||!l)}wasRoomKeyForwardedAsHistory(e){return!(!this.baseApis.getRoom(e.roomId)||!e.extraSessionData.sharedHistory)}shouldParkForwardedKey(e){return!(this.baseApis.getRoom(e.roomId)||!e.extraSessionData.sharedHistory)}async parkForwardedKey(e,t){const i={senderId:e.getSender(),senderKey:t.senderKey,sessionId:t.sessionId,sessionKey:t.sessionKey,keysClaimed:t.keysClaimed,forwardingCurve25519KeyChain:t.forwardingKeyChain};await this.crypto.cryptoStore.doTxn("readwrite",["parked_shared_history"],(e=>this.crypto.cryptoStore.addParkedSharedHistory(t.roomId,i,e)),s.v.getChild("[addParkedSharedHistory]"))}async addRoomKey(e){try{await this.olmDevice.addInboundGroupSession(e.roomId,e.senderKey,e.forwardingKeyChain,e.sessionId,e.sessionKey,e.keysClaimed,e.exportFormat,e.extraSessionData),await this.retryDecryption(e.senderKey,e.sessionId,!e.extraSessionData.untrusted)&&this.crypto.cancelRoomKeyRequest({algorithm:e.algorithm,room_id:e.roomId,session_id:e.sessionId,sender_key:e.senderKey}),await this.crypto.backupManager.backupGroupSession(e.senderKey,e.sessionId)}catch(e){this.prefixedLogger.error(`Error handling m.room_key_event: ${e}`)}}async onForwardedRoomKey(e){const t=this.forwardedRoomKeyFromEvent(e);t&&(await this.shouldAcceptForwardedKey(e,t)?await this.addRoomKey(t):this.shouldParkForwardedKey(t)&&await this.parkForwardedKey(e,t))}async onRoomKeyEvent(e){if("m.forwarded_room_key"==e.getType())await this.onForwardedRoomKey(e);else{const t=this.roomKeyFromEvent(e);if(!t)return;await this.addRoomKey(t)}}async onRoomKeyWithheldEvent(e){const t=e.getContent(),i=t.sender_key;"m.no_olm"===t.code?await this.onNoOlmWithheldEvent(e):"m.unavailable"===t.code||await this.olmDevice.addInboundGroupSessionWithheld(t.room_id,i,t.session_id,t.code,t.reason),t.session_id?await this.retryDecryption(i,t.session_id):await this.retryDecryptionFromSender(i)}async onNoOlmWithheldEvent(e){const t=e.getContent(),i=t.sender_key,n=e.getSender();if(this.prefixedLogger.warn(`${n}:${i} was unable to establish an olm session with us`),await this.olmDevice.getSessionIdForDevice(i))return this.prefixedLogger.debug("New session already created.  Not creating a new one."),void await this.olmDevice.recordSessionProblem(i,"no_olm",!0);let s=this.crypto.deviceList.getDeviceByIdentityKey(t.algorithm,i);if(!s&&(await this.crypto.downloadKeys([n],!1),s=this.crypto.deviceList.getDeviceByIdentityKey(t.algorithm,i),!s))return this.prefixedLogger.info("Couldn't find device for identity key "+i+": not establishing session"),void await this.olmDevice.recordSessionProblem(i,"no_olm",!1);await o.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[n,[s]]]),!1);const a={algorithm:o.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[d.wt]:(0,r.A)()};await o.encryptMessageForDevice(a.ciphertext,this.userId,void 0,this.olmDevice,n,s,{type:"m.dummy"}),await this.olmDevice.recordSessionProblem(i,"no_olm",!0),await this.baseApis.sendToDevice("m.room.encrypted",new Map([[n,new Map([[s.deviceId,a]])]]))}hasKeysForKeyRequest(e){const t=e.requestBody;return this.olmDevice.hasInboundSessionKeys(t.room_id,t.sender_key,t.session_id)}shareKeysWithDevice(e){const t=e.userId,i=e.deviceId,n=this.crypto.getStoredDevice(t,i),s=e.requestBody;this.olmlib.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[t,[n]]])).then((e=>{var n;const r=null===(n=e.get(t))||void 0===n?void 0:n.get(i);return null!=r&&r.sessionId?(this.prefixedLogger.debug("sharing keys for session "+s.sender_key+"|"+s.session_id+" with device "+t+":"+i),this.buildKeyForwardingMessage(s.room_id,s.sender_key,s.session_id)):null})).then((e=>{const s={algorithm:o.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[d.wt]:(0,r.A)()};return this.olmlib.encryptMessageForDevice(s.ciphertext,this.userId,void 0,this.olmDevice,t,n,e).then((()=>this.baseApis.sendToDevice("m.room.encrypted",new Map([[t,new Map([[i,s]])]]))))}))}async buildKeyForwardingMessage(e,t,i){const n=await this.olmDevice.getInboundGroupSessionKey(e,t,i);return{type:"m.forwarded_room_key",content:{algorithm:o.MEGOLM_ALGORITHM,room_id:e,sender_key:t,sender_claimed_ed25519_key:n.sender_claimed_ed25519_key,session_id:i,session_key:n.key,chain_index:n.chain_index,forwarding_curve25519_key_chain:n.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":n.shared_history||!1}}}importRoomKey(e,{untrusted:t,source:i}={}){const n={};return(t||e.untrusted)&&(n.untrusted=!0),e["org.matrix.msc3061.shared_history"]&&(n.sharedHistory=!0),this.olmDevice.addInboundGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0,n).then((()=>{"backup"!==i&&this.crypto.backupManager.backupGroupSession(e.sender_key,e.session_id).catch((e=>{this.prefixedLogger.debug("Failed to back up megolm session",e)})),this.retryDecryption(e.sender_key,e.session_id,!n.untrusted)}))}async retryDecryption(e,t,i){var n;const r=this.pendingEvents.get(e);if(!r)return!0;const s=r.get(t);if(!s)return!0;const o=[...s];return this.prefixedLogger.debug("Retrying decryption on events:",o.map((e=>`${e.getId()}`))),await Promise.all(o.map((async e=>{try{await e.attemptDecryption(this.crypto,{isRetry:!0,forceRedecryptIfUntrusted:i})}catch(e){}}))),!(null!==(n=this.pendingEvents.get(e))&&void 0!==n&&n.has(t))}async retryDecryptionFromSender(e){const t=this.pendingEvents.get(e);return!t||(this.pendingEvents.delete(e),await Promise.all([...t].map((async([e,t])=>{await Promise.all([...t].map((async e=>{try{await e.attemptDecryption(this.crypto)}catch(e){}})))}))),!this.pendingEvents.has(e))}async sendSharedHistoryInboundSessions(e){await o.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,e);const t=await this.olmDevice.getSharedHistoryInboundGroupSessions(this.roomId);this.prefixedLogger.debug(`Sharing history in with users ${Array.from(e.keys())}`,t.map((([e,t])=>`${e}|${t}`)));for(const[i,n]of t){const t=await this.buildKeyForwardingMessage(this.roomId,i,n),s=[],a=new Map;for(const[i,n]of e){const e=new Map;a.set(i,e);for(const a of n){const n={algorithm:o.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[d.wt]:(0,r.A)()};e.set(a.deviceId,n),s.push(o.encryptMessageForDevice(n.ciphertext,this.userId,void 0,this.olmDevice,i,a,t))}}await Promise.all(s);for(const[e,t]of a){for(const[i,n]of t)y(n)||(this.prefixedLogger.debug("No ciphertext for device "+e+":"+i+": pruning"),t.delete(i));0===t.size&&(this.prefixedLogger.debug("Pruned all devices for user "+e),a.delete(e))}if(0===a.size)return void this.prefixedLogger.debug("No users left to send to: aborting");await this.baseApis.sendToDevice("m.room.encrypted",a)}}}const _={no_olm:"The sender was unable to establish a secure channel.",unknown:"The secure channel with the sender was corrupted."};(0,a.x)(o.MEGOLM_ALGORITHM,S,w)},"./node_modules/matrix-js-sdk/src/crypto/api.ts":(e,t,i)=>{"use strict";i.d(t,{n:()=>n.CrossSigningKey});var n=i("./node_modules/matrix-js-sdk/src/crypto-api.ts")},"./node_modules/matrix-js-sdk/src/crypto/backup.ts":(e,t,i)=>{"use strict";i.d(t,{IG:()=>_,IO:()=>v,M7:()=>E});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/client.ts"),s=i("./node_modules/matrix-js-sdk/src/logger.ts"),o=i("./node_modules/matrix-js-sdk/src/crypto/olmlib.ts"),a=i("./node_modules/matrix-js-sdk/src/crypto/key_passphrase.ts"),c=i("./node_modules/matrix-js-sdk/src/utils.ts"),d=i("./node_modules/matrix-js-sdk/src/crypto/store/indexeddb-crypto-store.ts"),l=i("./node_modules/matrix-js-sdk/src/crypto/recoverykey.ts"),u=i("./node_modules/matrix-js-sdk/src/crypto/aes.ts"),h=i("./node_modules/matrix-js-sdk/src/NamespacedValue.ts"),m=i("./node_modules/matrix-js-sdk/src/crypto/index.ts"),p=i("./node_modules/matrix-js-sdk/src/crypto/crypto.ts"),g=i("./node_modules/matrix-js-sdk/src/http-api/index.ts");class v{constructor(e,t){this.baseApis=e,this.getKey=t,(0,n.A)(this,"algorithm",void 0),(0,n.A)(this,"backupInfo",void 0),(0,n.A)(this,"checkedForBackup",void 0),(0,n.A)(this,"sendingBackups",void 0),(0,n.A)(this,"sessionLastCheckAttemptedTime",{}),(0,n.A)(this,"clientRunning",!0),this.checkedForBackup=!1,this.sendingBackups=!1}stop(){this.clientRunning=!1}get version(){return this.backupInfo&&this.backupInfo.version}static checkBackupVersion(e){const t=S[e.algorithm];if(!t)throw new Error("Unknown backup algorithm: "+e.algorithm);if("object"!=typeof e.auth_data)throw new Error("Invalid backup data returned");return t.checkBackupVersion(e)}static makeAlgorithm(e,t){const i=S[e.algorithm];if(!i)throw new Error("Unknown backup algorithm");return i.init(e.auth_data,t)}async enableKeyBackup(e){this.backupInfo=e,this.algorithm&&this.algorithm.free(),this.algorithm=await v.makeAlgorithm(e,this.getKey),this.baseApis.emit(m.cr.KeyBackupStatus,!0),this.scheduleKeyBackupSend()}disableKeyBackup(){this.algorithm&&this.algorithm.free(),this.algorithm=void 0,this.backupInfo=void 0,this.baseApis.emit(m.cr.KeyBackupStatus,!1)}getKeyBackupEnabled(){return this.checkedForBackup?Boolean(this.algorithm):null}async prepareKeyBackupVersion(e,t){const i=t?S[t]:w;if(!i)throw new Error("Unknown backup algorithm");const[n,r]=await i.prepare(e),s=(0,l.j)(n);return{algorithm:i.algorithmName,auth_data:r,recovery_key:s,privateKey:n}}async createKeyBackupVersion(e){this.algorithm=await v.makeAlgorithm(e,this.getKey)}async deleteAllKeyBackupVersions(){var e,t;let i=null!==(e=null===(t=await this.baseApis.getKeyBackupVersion())||void 0===t?void 0:t.version)&&void 0!==e?e:null;for(;null!=i;){var n,r;await this.deleteKeyBackupVersion(i),this.disableKeyBackup(),i=null!==(n=null===(r=await this.baseApis.getKeyBackupVersion())||void 0===r?void 0:r.version)&&void 0!==n?n:null}}async deleteKeyBackupVersion(e){const t=(0,c.RR)("/room_keys/version/$version",{$version:e});await this.baseApis.http.authedRequest(g.IT.Delete,t,void 0,void 0,{prefix:g.iD.V3})}async checkAndStart(){if(s.v.log("Checking key backup status..."),this.baseApis.isGuest())return s.v.log("Skipping key backup check since user is guest"),this.checkedForBackup=!0,null;let e;try{var t;e=null!==(t=await this.baseApis.getKeyBackupVersion())&&void 0!==t?t:void 0}catch(e){return s.v.log("Error checking for active key backup",e),404===e.httpStatus&&(this.checkedForBackup=!0),null}this.checkedForBackup=!0;const i=await this.isKeyBackupTrusted(e);return i.usable&&!this.backupInfo?(s.v.log(`Found usable key backup v${e.version}: enabling key backups`),await this.enableKeyBackup(e)):!i.usable&&this.backupInfo?(s.v.log("No usable key backup: disabling key backup"),this.disableKeyBackup()):i.usable||this.backupInfo?i.usable&&this.backupInfo&&(e.version!==this.backupInfo.version?(s.v.log(`On backup version ${this.backupInfo.version} but found version ${e.version}: switching.`),this.disableKeyBackup(),await this.enableKeyBackup(e),await this.scheduleAllGroupSessionsForBackup()):s.v.log(`Backup version ${e.version} still current`)):s.v.log("No usable key backup: not enabling key backup"),{backupInfo:e,trustInfo:i}}async checkKeyBackup(){return this.checkedForBackup=!1,this.checkAndStart()}async queryKeyBackupRateLimited(e,t){if(!this.backupInfo)return;const i=(new Date).getTime();(!this.sessionLastCheckAttemptedTime[t]||i-this.sessionLastCheckAttemptedTime[t]>5e3)&&(this.sessionLastCheckAttemptedTime[t]=i,await this.baseApis.restoreKeyBackupWithCache(e,t,this.backupInfo,{}))}async isKeyBackupTrusted(e){const t={usable:!1,trusted_locally:!1,sigs:[]};if(!(e&&e.algorithm&&e.auth_data&&e.auth_data.signatures))return s.v.info(`Key backup is absent or missing required data: ${JSON.stringify(e)}`),t;const i=this.baseApis.getUserId(),n=await this.baseApis.crypto.getSessionBackupPrivateKey();if(n){let i=null;try{i=await v.makeAlgorithm(e,(async()=>n)),await i.keyMatches(n)&&(s.v.info("Backup is trusted locally"),t.trusted_locally=!0)}catch{}finally{var r;null===(r=i)||void 0===r||r.free()}}const a=e.auth_data.signatures[i]||{};for(const n of Object.keys(a)){const r=n.split(":");if("ed25519"!==r[0]){s.v.log("Ignoring unknown signature type: "+r[0]);continue}const a={deviceId:r[1]},c=this.baseApis.crypto.crossSigningInfo.getId();if(c===a.deviceId){a.crossSigningId=!0;try{await(0,o.verifySignature)(this.baseApis.crypto.olmDevice,e.auth_data,i,a.deviceId,c),a.valid=!0}catch(e){s.v.warn("Bad signature from cross signing key "+c,e),a.valid=!1}t.sigs.push(a);continue}const d=this.baseApis.crypto.deviceList.getStoredDevice(i,a.deviceId);if(d){a.device=d,a.deviceTrust=this.baseApis.checkDeviceTrust(i,a.deviceId);try{await(0,o.verifySignature)(this.baseApis.crypto.olmDevice,e.auth_data,i,d.deviceId,d.getFingerprint()),a.valid=!0}catch(t){s.v.info("Bad signature from key ID "+n+" userID "+this.baseApis.getUserId()+" device ID "+d.deviceId+" fingerprint: "+d.getFingerprint(),e.auth_data,t),a.valid=!1}}else a.valid=null,s.v.info("Ignoring signature from unknown key "+n);t.sigs.push(a)}return t.usable=t.sigs.some((e=>{var t;return e.valid&&(e.device&&(null===(t=e.deviceTrust)||void 0===t?void 0:t.isVerified())||e.crossSigningId)})),t}async scheduleKeyBackupSend(e=1e4){if(s.v.debug(`Key backup: scheduleKeyBackupSend currentSending:${this.sendingBackups} delay:${e}`),!this.sendingBackups){this.sendingBackups=!0;try{const t=Math.random()*e;if(await(0,c.yy)(t),!this.clientRunning)return void(this.sendingBackups=!1);let i=0;for(;;){if(!this.algorithm)return;try{if(0===await this.backupPendingKeys(200))return void(this.sendingBackups=!1);i=0}catch(e){if(i++,s.v.log("Key backup request failed",e),e instanceof g.up){const t=e.data.errcode;if("M_NOT_FOUND"==t||"M_WRONG_ROOM_KEYS_VERSION"==t)return this.sendingBackups=!1,this.baseApis.crypto.emit(m.cr.KeyBackupFailed,t),void await this.checkKeyBackup()}}if(i&&await(0,c.yy)(1e3*Math.pow(2,Math.min(i-1,4))),!this.clientRunning)return s.v.debug("Key backup send loop aborted, client stopped"),void(this.sendingBackups=!1)}}catch(e){s.v.log(`Backup loop failed ${e}`),this.sendingBackups=!1}}}async backupPendingKeys(e){const t=await this.baseApis.crypto.cryptoStore.getSessionsNeedingBackup(e);if(!t.length)return 0;let i=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();this.baseApis.crypto.emit(m.cr.KeyBackupSessionsRemaining,i);const n={};for(const e of t){var r;const t=e.sessionData.room_id;(0,c.C6)(n,t,n[t]||{sessions:{}});const i=this.baseApis.crypto.olmDevice.exportInboundGroupSession(e.senderKey,e.sessionId,e.sessionData);i.algorithm=o.MEGOLM_ALGORITHM;const s=(i.forwarding_curve25519_key_chain||[]).length,a=this.baseApis.crypto.deviceList.getUserByIdentityKey(o.MEGOLM_ALGORITHM,e.senderKey),d=null!==(r=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(o.MEGOLM_ALGORITHM,e.senderKey))&&void 0!==r?r:void 0,l=this.baseApis.crypto.checkDeviceInfoTrust(a,d).isVerified();(0,c.C6)(n[t].sessions,e.sessionId,{first_message_index:i.first_known_index,forwarded_count:s,is_verified:l,session_data:await this.algorithm.encryptSession(i)})}return await this.baseApis.sendKeyBackup(void 0,void 0,this.backupInfo.version,{rooms:n}),await this.baseApis.crypto.cryptoStore.unmarkSessionsNeedingBackup(t),i=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup(),this.baseApis.crypto.emit(m.cr.KeyBackupSessionsRemaining,i),t.length}async backupGroupSession(e,t){await this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([{senderKey:e,sessionId:t}]),this.backupInfo&&this.scheduleKeyBackupSend()}async scheduleAllGroupSessionsForBackup(){await this.flagAllGroupSessionsForBackup(),this.scheduleKeyBackupSend(0)}async flagAllGroupSessionsForBackup(){await this.baseApis.crypto.cryptoStore.doTxn("readwrite",[d.y.STORE_INBOUND_GROUP_SESSIONS,d.y.STORE_BACKUP],(e=>{this.baseApis.crypto.cryptoStore.getAllEndToEndInboundGroupSessions(e,(t=>{null!==t&&this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([t],e)}))}));const e=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();return this.baseApis.emit(m.cr.KeyBackupSessionsRemaining,e),e}countSessionsNeedingBackup(){return this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup()}}class f{constructor(e,t,i){this.authData=e,this.publicKey=t,this.getKey=i}static async init(e,t){if(!e||!("public_key"in e))throw new Error("auth_data missing required information");const n=new i.g.Olm.PkEncryption;return n.set_recipient_key(e.public_key),new f(e,n,t)}static async prepare(e){const t=new i.g.Olm.PkDecryption;try{const n={};if(e)if(e instanceof Uint8Array)n.public_key=t.init_with_private_key(e);else{const i=await(0,a.SM)(e);n.private_key_salt=i.salt,n.private_key_iterations=i.iterations,n.public_key=t.init_with_private_key(i.key)}else n.public_key=t.generate_key();return(new i.g.Olm.PkEncryption).set_recipient_key(n.public_key),[t.get_private_key(),n]}finally{t.free()}}static checkBackupVersion(e){if(!("public_key"in e.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!0}async encryptSession(e){const t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,this.publicKey.encrypt(JSON.stringify(t))}async decryptSessions(e){const t=await this.getKey(),n=new i.g.Olm.PkDecryption;try{if(n.init_with_private_key(t)!==this.authData.public_key)throw new g.up({errcode:r.pB.RESTORE_BACKUP_ERROR_BAD_KEY});const i=[];for(const[t,r]of Object.entries(e))try{const e=JSON.parse(n.decrypt(r.session_data.ephemeral,r.session_data.mac,r.session_data.ciphertext));e.session_id=t,i.push(e)}catch(e){s.v.log("Failed to decrypt megolm session from backup",e,r)}return i}finally{n.free()}}async keyMatches(e){const t=new i.g.Olm.PkDecryption;let n;try{n=t.init_with_private_key(e)}finally{t.free()}return n===this.authData.public_key}free(){this.publicKey.free()}}(0,n.A)(f,"algorithmName","m.megolm_backup.v1.curve25519-aes-sha2");const y=new h.qr("m.megolm_backup.v1.aes-hmac-sha2","org.matrix.msc3270.v1.aes-hmac-sha2");class b{constructor(e,t){this.authData=e,this.key=t}static async init(e,t){if(!e)throw new Error("auth_data missing");const i=await t();if(e.mac){const{mac:t}=await(0,u.iV)(i,e.iv);if(e.mac.replace(/=+$/g,"")!==t.replace(/=+/g,""))throw new Error("Key does not match")}return new b(e,i)}static async prepare(e){let t;const i={};if(e)if(e instanceof Uint8Array)t=new Uint8Array(e);else{const n=await(0,a.SM)(e);i.private_key_salt=n.salt,i.private_key_iterations=n.iterations,t=n.key}else t=function(e){const t=new Uint8Array(e);return p.Et.getRandomValues(t),t}(32);const{iv:n,mac:r}=await(0,u.iV)(t);return i.iv=n,i.mac=r,[t,i]}static checkBackupVersion(e){if(!("iv"in e.auth_data)||!("mac"in e.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!1}encryptSession(e){const t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,(0,u.r9)(JSON.stringify(t),this.key,e.session_id)}async decryptSessions(e){const t=[];for(const[i,n]of Object.entries(e))try{const e=JSON.parse(await(0,u.VK)(n.session_data,this.key,i));e.session_id=i,t.push(e)}catch(e){s.v.log("Failed to decrypt megolm session from backup",e,n)}return t}async keyMatches(e){if(this.authData.mac){const{mac:t}=await(0,u.iV)(e,this.authData.iv);return this.authData.mac.replace(/=+$/g,"")===t.replace(/=+/g,"")}return!0}free(){this.key.fill(0)}}(0,n.A)(b,"algorithmName",y.name);const S={[f.algorithmName]:f,[b.algorithmName]:b},w=f;function _(e){var t;return{trusted:e.usable,matchesDecryptionKey:null!==(t=e.trusted_locally)&&void 0!==t&&t}}class E{constructor(e){(0,n.A)(this,"algorithm",void 0),(0,n.A)(this,"sourceTrusted",void 0),this.algorithm=e,this.sourceTrusted=!e.untrusted}free(){this.algorithm.free()}async decryptSessions(e){return await this.algorithm.decryptSessions(e)}}},"./node_modules/matrix-js-sdk/src/crypto/crypto.ts":(e,t,i)=>{"use strict";i.d(t,{Et:()=>a,_3:()=>d,n1:()=>c});var n,r,s,o=i("./node_modules/matrix-js-sdk/src/logger.ts");let a=globalThis.crypto,c=null!==(n=null===(r=a)||void 0===r?void 0:r.subtle)&&void 0!==n?n:null===(s=a)||void 0===s?void 0:s.webkitSubtle,d=globalThis.TextEncoder;if(!a)try{a=i("?50b8").webcrypto}catch(e){o.v.error("Failed to load webcrypto",e)}var l;c||(c=null===(l=a)||void 0===l?void 0:l.subtle);if(!d)try{d=i("./node_modules/util/util.js").TextEncoder}catch(e){o.v.error("Failed to load TextEncoder util",e)}},"./node_modules/matrix-js-sdk/src/crypto/dehydration.ts":(e,t,i)=>{"use strict";i.d(t,{S:()=>h,v:()=>p});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/another-json/another-json.js"),s=i.n(r),o=i("./node_modules/matrix-js-sdk/src/base64.ts"),a=i("./node_modules/matrix-js-sdk/src/crypto/store/indexeddb-crypto-store.ts"),c=i("./node_modules/matrix-js-sdk/src/crypto/aes.ts"),d=i("./node_modules/matrix-js-sdk/src/logger.ts"),l=i("./node_modules/matrix-js-sdk/src/http-api/index.ts"),u=i("./node_modules/buffer/index.js").hp;const h="org.matrix.msc2697.v1.olm.libolm_pickle",m=6048e5;class p{constructor(e){this.crypto=e,(0,n.A)(this,"inProgress",!1),(0,n.A)(this,"timeoutId",void 0),(0,n.A)(this,"key",void 0),(0,n.A)(this,"keyInfo",void 0),(0,n.A)(this,"deviceDisplayName",void 0),this.getDehydrationKeyFromCache()}getDehydrationKeyFromCache(){return this.crypto.cryptoStore.doTxn("readonly",[a.y.STORE_ACCOUNT],(e=>{this.crypto.cryptoStore.getSecretStorePrivateKey(e,(async e=>{if(e){const{key:t,keyInfo:n,deviceDisplayName:r,time:s}=e,a=u.from(this.crypto.olmDevice.pickleKey),d=await(0,c.VK)(t,a,h);this.key=(0,o.y4)(d),this.keyInfo=n,this.deviceDisplayName=r;const l=Date.now(),p=Math.max(1,s+m-l);this.timeoutId=i.g.setTimeout(this.dehydrateDevice.bind(this),p)}}),"dehydration")}))}async setKeyAndQueueDehydration(e,t={},i){await this.setKey(e,t,i)||this.dehydrateDevice()}async setKey(e,t={},n){if(!e)return this.timeoutId&&(i.g.clearTimeout(this.timeoutId),this.timeoutId=void 0),await this.crypto.cryptoStore.doTxn("readwrite",[a.y.STORE_ACCOUNT],(e=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(e,"dehydration",null)})),this.key=void 0,void(this.keyInfo=void 0);let r=!!this.key&&e.length==this.key.length;for(let t=0;r&&t<e.length;t++)e[t]!=this.key[t]&&(r=!1);return r||(this.key=e,this.keyInfo=t,this.deviceDisplayName=n),r}async dehydrateDevice(){if(this.inProgress)d.v.log("Dehydration already in progress -- not starting new dehydration");else{this.inProgress=!0,this.timeoutId&&(i.g.clearTimeout(this.timeoutId),this.timeoutId=void 0);try{const e=u.from(this.crypto.olmDevice.pickleKey),t=await(0,c.r9)((0,o.WG)(this.key),e,h);await this.crypto.cryptoStore.doTxn("readwrite",[a.y.STORE_ACCOUNT],(e=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(e,"dehydration",{keyInfo:this.keyInfo,key:t,deviceDisplayName:this.deviceDisplayName,time:Date.now()})})),d.v.log("Attempting to dehydrate device"),d.v.log("Creating account");const n=new i.g.Olm.Account;n.create();const r=JSON.parse(n.identity_keys()),p=n.max_number_of_one_time_keys();n.generate_one_time_keys(p/2),n.generate_fallback_key();const g=JSON.parse(n.one_time_keys()),v=JSON.parse(n.fallback_key());n.mark_keys_as_published();const f=n.pickle(new Uint8Array(this.key)),y={algorithm:h,account:f};this.keyInfo.passphrase&&(y.passphrase=this.keyInfo.passphrase),d.v.log("Uploading account to server");const b=(await this.crypto.baseApis.http.authedRequest(l.IT.Put,"/dehydrated_device",void 0,{device_data:y,initial_device_display_name:this.deviceDisplayName},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).device_id;d.v.log("Preparing device keys",b);const S={algorithms:this.crypto.supportedAlgorithms,device_id:b,user_id:this.crypto.userId,keys:{[`ed25519:${b}`]:r.ed25519,[`curve25519:${b}`]:r.curve25519}},w=n.sign(s().stringify(S));S.signatures={[this.crypto.userId]:{[`ed25519:${b}`]:w}},this.crypto.crossSigningInfo.getId("self_signing")&&await this.crypto.crossSigningInfo.signObject(S,"self_signing"),d.v.log("Preparing one-time keys");const _={};for(const[e,t]of Object.entries(g.curve25519)){const i={key:t},r=n.sign(s().stringify(i));i.signatures={[this.crypto.userId]:{[`ed25519:${b}`]:r}},_[`signed_curve25519:${e}`]=i}d.v.log("Preparing fallback keys");const E={};for(const[e,t]of Object.entries(v.curve25519)){const i={key:t,fallback:!0},r=n.sign(s().stringify(i));i.signatures={[this.crypto.userId]:{[`ed25519:${b}`]:r}},E[`signed_curve25519:${e}`]=i}return d.v.log("Uploading keys to server"),await this.crypto.baseApis.http.authedRequest(l.IT.Post,"/keys/upload/"+encodeURI(b),void 0,{device_keys:S,one_time_keys:_,"org.matrix.msc2732.fallback_keys":E}),d.v.log("Done dehydrating"),this.timeoutId=i.g.setTimeout(this.dehydrateDevice.bind(this),m),b}finally{this.inProgress=!1}}}stop(){this.timeoutId&&(i.g.clearTimeout(this.timeoutId),this.timeoutId=void 0)}}},"./node_modules/matrix-js-sdk/src/crypto/deviceinfo.ts":(e,t,i)=>{"use strict";i.d(t,{V:()=>s});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/models/device.ts");class s{static fromStorage(e,t){const i=new s(t);for(const t in e)e.hasOwnProperty(t)&&(i[t]=e[t]);return i}constructor(e){this.deviceId=e,(0,n.A)(this,"algorithms",[]),(0,n.A)(this,"keys",{}),(0,n.A)(this,"verified",r.u.Unverified),(0,n.A)(this,"known",!1),(0,n.A)(this,"unsigned",{}),(0,n.A)(this,"signatures",{})}toStorage(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned,signatures:this.signatures}}getFingerprint(){return this.keys["ed25519:"+this.deviceId]}getIdentityKey(){return this.keys["curve25519:"+this.deviceId]}getDisplayName(){return this.unsigned.device_display_name||null}isBlocked(){return this.verified==r.u.Blocked}isVerified(){return this.verified==r.u.Verified}isUnverified(){return this.verified==r.u.Unverified}isKnown(){return!0===this.known}}(0,n.A)(s,"DeviceVerification",{VERIFIED:r.u.Verified,UNVERIFIED:r.u.Unverified,BLOCKED:r.u.Blocked})},"./node_modules/matrix-js-sdk/src/crypto/index.ts":(e,t,i)=>{"use strict";i.d(t,{Qr:()=>It,cr:()=>Et,D$:()=>kt,DM:()=>_t});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/another-json/another-json.js"),s=i.n(r),o=i("./node_modules/uuid/dist/esm-browser/v4.js"),a=i("./node_modules/matrix-js-sdk/src/@types/event.ts"),c=i("./node_modules/matrix-js-sdk/src/ReEmitter.ts"),d=i("./node_modules/matrix-js-sdk/src/logger.ts"),l=i("./node_modules/matrix-js-sdk/src/crypto/OlmDevice.ts"),u=i("./node_modules/matrix-js-sdk/src/crypto/olmlib.ts"),h=i("./node_modules/matrix-js-sdk/src/crypto/deviceinfo.ts"),m=i("./node_modules/matrix-js-sdk/src/crypto/store/indexeddb-crypto-store.ts"),p=i("./node_modules/matrix-js-sdk/src/crypto/aes.ts"),g=i("./node_modules/matrix-js-sdk/src/crypto-api.ts"),v=i("./node_modules/matrix-js-sdk/src/base64.ts"),f=i("./node_modules/buffer/index.js").hp;function y(e){return Object.values(e.keys)[0]}class b{constructor(e,t={},i={}){this.userId=e,this.callbacks=t,this.cacheCallbacks=i,(0,n.A)(this,"keys",{}),(0,n.A)(this,"firstUse",!0),(0,n.A)(this,"crossSigningVerifiedBefore",!1)}static fromStorage(e,t){const i=new b(t);for(const t in e)e.hasOwnProperty(t)&&(i[t]=e[t]);return i}toStorage(){return{keys:this.keys,firstUse:this.firstUse,crossSigningVerifiedBefore:this.crossSigningVerifiedBefore}}async getCrossSigningKey(e,t){const n=["master","self_signing","user_signing"].indexOf(e)>=0;if(!this.callbacks.getCrossSigningKey)throw new Error("No getCrossSigningKey callback supplied");function r(e){if(!e)return;const n=new i.g.Olm.PkSigning,r=n.init_with_seed(e);if(r===t)return[r,n];n.free()}void 0===t&&(t=this.getId(e));let s=null;this.cacheCallbacks.getCrossSigningKeyCache&&n&&(s=await this.cacheCallbacks.getCrossSigningKeyCache(e,t));const o=r(s);if(o)return o;s=await this.callbacks.getCrossSigningKey(e,t);const a=r(s);if(a)return this.cacheCallbacks.storeCrossSigningKeyCache&&n&&await this.cacheCallbacks.storeCrossSigningKeyCache(e,s),a;if(!s)throw new Error("getCrossSigningKey callback for "+e+" returned falsey");throw new Error("Key type "+e+" from getCrossSigningKey callback did not match")}async isStoredInSecretStorage(e){const t=await e.isStored("m.cross_signing.master")||{};function i(e){for(const i of Object.keys(t))e[i]||delete t[i]}for(const t of["self_signing","user_signing"])i(await e.isStored(`m.cross_signing.${t}`)||{});return Object.keys(t).length?t:null}static async storeInSecretStorage(e,t){for(const[i,n]of e){const e=(0,v.WG)(n);await t.store(`m.cross_signing.${i}`,e)}}static async getFromSecretStorage(e,t){const i=await t.get(`m.cross_signing.${e}`);return i?(0,v.y4)(i):null}async isStoredInKeyCache(e){const t=this.cacheCallbacks;if(!t)return!1;const i=e?[e]:["master","self_signing","user_signing"];for(const e of i){var n;if(!await(null===(n=t.getCrossSigningKeyCache)||void 0===n?void 0:n.call(t,e)))return!1}return!0}async getCrossSigningKeysFromCache(){const e=new Map,t=this.cacheCallbacks;if(!t)return e;for(const n of["master","self_signing","user_signing"]){var i;const r=await(null===(i=t.getCrossSigningKeyCache)||void 0===i?void 0:i.call(t,n));r&&e.set(n,r)}return e}getId(e="master"){if(!this.keys[e])return null;return y(this.keys[e])}async resetKeys(e){if(!this.callbacks.saveCrossSigningKeys)throw new Error("No saveCrossSigningKeys callback supplied");if(void 0===e||e&S.MASTER||!this.keys.master)e=S.MASTER|S.USER_SIGNING|S.SELF_SIGNING;else if(0===e)return;const t={},n={};let r,s;try{if(e&S.MASTER?(r=new i.g.Olm.PkSigning,t.master=r.generate_seed(),s=r.init_with_seed(t.master),n.master={user_id:this.userId,usage:["master"],keys:{["ed25519:"+s]:s}}):[s,r]=await this.getCrossSigningKey("master"),e&S.SELF_SIGNING){const e=new i.g.Olm.PkSigning;try{t.self_signing=e.generate_seed();const i=e.init_with_seed(t.self_signing);n.self_signing={user_id:this.userId,usage:["self_signing"],keys:{["ed25519:"+i]:i}},(0,u.pkSign)(n.self_signing,r,this.userId,s)}finally{e.free()}}if(e&S.USER_SIGNING){const e=new i.g.Olm.PkSigning;try{t.user_signing=e.generate_seed();const i=e.init_with_seed(t.user_signing);n.user_signing={user_id:this.userId,usage:["user_signing"],keys:{["ed25519:"+i]:i}},(0,u.pkSign)(n.user_signing,r,this.userId,s)}finally{e.free()}}Object.assign(this.keys,n),this.callbacks.saveCrossSigningKeys(t)}finally{r&&r.free()}}clearKeys(){this.keys={}}setKeys(e){const t={};if(e.master){if(e.master.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in master key from "+this.userId;throw d.v.error(t),new Error(t)}this.keys.master?y(e.master)!==this.getId()&&(this.firstUse=!1):this.firstUse=!0,t.master=e.master}else{if(!this.keys.master)throw new Error("Tried to set cross-signing keys without a master key");t.master=this.keys.master}const i=y(t.master);if(e.user_signing){if(e.user_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in user_signing key from "+this.userId;throw d.v.error(t),new Error(t)}try{(0,u.pkVerify)(e.user_signing,i,this.userId)}catch(e){throw d.v.error("invalid signature on user-signing key"),e}}if(e.self_signing){if(e.self_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in self_signing key from "+this.userId;throw d.v.error(t),new Error(t)}try{(0,u.pkVerify)(e.self_signing,i,this.userId)}catch(e){throw d.v.error("invalid signature on self-signing key"),e}}e.master&&(this.keys.master=e.master,delete this.keys.self_signing,delete this.keys.user_signing),e.self_signing&&(this.keys.self_signing=e.self_signing),e.user_signing&&(this.keys.user_signing=e.user_signing)}updateCrossSigningVerifiedBefore(e){!this.crossSigningVerifiedBefore&&e&&(this.crossSigningVerifiedBefore=!0)}async signObject(e,t){if(!this.keys[t])throw new Error("Attempted to sign with "+t+" key but no such key present");const[i,n]=await this.getCrossSigningKey(t);try{return(0,u.pkSign)(e,n,this.userId,i),e}finally{n.free()}}async signUser(e){if(this.keys.user_signing)return this.signObject(e.keys.master,"user_signing");d.v.info("No user signing key: not signing user")}async signDevice(e,t){if(e!==this.userId)throw new Error(`Trying to sign ${e}'s device; can only sign our own device`);if(this.keys.self_signing)return this.signObject({algorithms:t.algorithms,keys:t.keys,device_id:t.deviceId,user_id:e},"self_signing");d.v.info("No self signing key: not signing device")}checkUserTrust(e){if(this.userId===e.userId&&this.getId()&&this.getId()===e.getId()&&this.getId("self_signing")&&this.getId("self_signing")===e.getId("self_signing"))return new g.UserVerificationStatus(!0,!0,this.firstUse);if(!this.keys.user_signing)return new g.UserVerificationStatus(!1,!1,e.firstUse);let t;const i=e.keys.master,n=this.getId("user_signing");try{(0,u.pkVerify)(i,n,this.userId),t=!0}catch(e){t=!1}return new g.UserVerificationStatus(t,e.crossSigningVerifiedBefore,e.firstUse)}checkDeviceTrust(e,t,i,n){const r=this.checkUserTrust(e),s=e.keys.self_signing;if(!s)return new w(!1,!1,i,n);const o=function(e,t){return{algorithms:e.algorithms,keys:e.keys,device_id:e.deviceId,user_id:t,signatures:e.signatures}}(t,e.userId);try{return(0,u.pkVerify)(s,e.getId(),e.userId),(0,u.pkVerify)(o,y(s),e.userId),w.fromUserTrustLevel(r,i,n)}catch(e){return new w(!1,!1,i,n)}}getCacheCallbacks(){return this.cacheCallbacks}}let S=function(e){return e[e.MASTER=4]="MASTER",e[e.USER_SIGNING=2]="USER_SIGNING",e[e.SELF_SIGNING=1]="SELF_SIGNING",e}({});class w extends g.DeviceVerificationStatus{constructor(e,t,i,n,r=!1){super({crossSigningVerified:e,tofu:t,localVerified:i,trustCrossSignedDevices:n,signedByOwner:r})}static fromUserTrustLevel(e,t,i){return new w(e.isCrossSigningVerified(),e.isTofu(),t,i,!0)}isCrossSigningVerified(){return this.crossSigningVerified}isLocallyVerified(){return this.localVerified}isTofu(){return this.tofu}}function _(e,t){return{getCrossSigningKeyCache:async function(i,n){const r=await new Promise((t=>{e.doTxn("readonly",[m.y.STORE_ACCOUNT],(n=>{e.getSecretStorePrivateKey(n,t,i)}))}));if(r&&r.ciphertext){const e=f.from(t.pickleKey),n=await(0,p.VK)(r,e,i);return(0,v.y4)(n)}return r},storeCrossSigningKeyCache:async function(i,n){if(!(n instanceof Uint8Array))throw new Error(`storeCrossSigningKeyCache expects Uint8Array, got ${n}`);const r=f.from(t.pickleKey),s=await(0,p.r9)((0,v.WG)(n),r,i);return e.doTxn("readwrite",[m.y.STORE_ACCOUNT],(t=>{e.storeSecretStorePrivateKey(t,i,s)}))}}}var E=i("./node_modules/matrix-js-sdk/src/utils.ts"),I=i("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts");let k=function(e){return e[e.NotTracked=0]="NotTracked",e[e.PendingDownload=1]="PendingDownload",e[e.DownloadInProgress=2]="DownloadInProgress",e[e.UpToDate=3]="UpToDate",e}({});class R extends I.X{constructor(e,t,i,r=250){super(),this.cryptoStore=t,this.keyDownloadChunkSize=r,(0,n.A)(this,"devices",{}),(0,n.A)(this,"crossSigningInfo",{}),(0,n.A)(this,"userByIdentityKey",{}),(0,n.A)(this,"deviceTrackingStatus",{}),(0,n.A)(this,"syncToken",null),(0,n.A)(this,"keyDownloadsInProgressByUser",new Map),(0,n.A)(this,"dirty",!1),(0,n.A)(this,"savePromise",null),(0,n.A)(this,"resolveSavePromise",null),(0,n.A)(this,"savePromiseTime",null),(0,n.A)(this,"saveTimer",null),(0,n.A)(this,"hasFetched",null),(0,n.A)(this,"serialiser",void 0),this.serialiser=new T(e,i,this)}async load(){await this.cryptoStore.doTxn("readonly",[m.y.STORE_DEVICE_DATA],(e=>{this.cryptoStore.getEndToEndDeviceData(e,(e=>{var t;this.hasFetched=Boolean(null==e?void 0:e.devices),this.devices=e?e.devices:{},this.crossSigningInfo=e&&e.crossSigningInfo||{},this.deviceTrackingStatus=e?e.trackingStatus:{},this.syncToken=null!==(t=null==e?void 0:e.syncToken)&&void 0!==t?t:null,this.userByIdentityKey={};for(const e of Object.keys(this.devices)){const t=this.devices[e];for(const i of Object.keys(t)){const n=t[i].keys["curve25519:"+i];void 0!==n&&(this.userByIdentityKey[n]=e)}}}))}));for(const e of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[e]==k.DownloadInProgress&&(this.deviceTrackingStatus[e]=k.PendingDownload)}stop(){null!==this.saveTimer&&clearTimeout(this.saveTimer)}async saveIfDirty(e=500){if(!this.dirty)return Promise.resolve(!1);const t=Date.now()+e;this.savePromiseTime&&t<this.savePromiseTime&&(clearTimeout(this.saveTimer),this.saveTimer=null,this.savePromiseTime=null);let i=this.savePromise;if(null===i&&(i=new Promise((e=>{this.resolveSavePromise=e})),this.savePromise=i),null===this.saveTimer){const i=this.resolveSavePromise;this.savePromiseTime=t,this.saveTimer=setTimeout((()=>{d.v.log("Saving device tracking data",this.syncToken),this.savePromiseTime=null,this.saveTimer=null,this.savePromise=null,this.resolveSavePromise=null,this.cryptoStore.doTxn("readwrite",[m.y.STORE_DEVICE_DATA],(e=>{var t;this.cryptoStore.storeEndToEndDeviceData({devices:this.devices,crossSigningInfo:this.crossSigningInfo,trackingStatus:this.deviceTrackingStatus,syncToken:null!==(t=this.syncToken)&&void 0!==t?t:void 0},e)})).then((()=>{this.dirty=!1,null==i||i(!0)}),(e=>{d.v.error("Failed to save device tracking data",this.syncToken),d.v.error(e)}))}),e)}return i}getSyncToken(){return this.syncToken}setSyncToken(e){this.syncToken=e}downloadKeys(e,t){const i=[],n=[];if(e.forEach((e=>{const r=this.deviceTrackingStatus[e];this.keyDownloadsInProgressByUser.has(e)?(d.v.log(`downloadKeys: already have a download in progress for ${e}: awaiting its result`),n.push(this.keyDownloadsInProgressByUser.get(e))):(t||r!=k.UpToDate)&&i.push(e)})),0!=i.length){d.v.log("downloadKeys: downloading for",i);const e=this.doKeyDownload(i);n.push(e)}return 0===n.length&&d.v.log("downloadKeys: already have all necessary keys"),Promise.all(n).then((()=>this.getDevicesFromStore(e)))}getDevicesFromStore(e){const t=new Map;return e.forEach((e=>{var i;const n=new Map;null===(i=this.getStoredDevicesForUser(e))||void 0===i||i.forEach((function(e){n.set(e.deviceId,e)})),t.set(e,n)})),t}getKnownUserIds(){return Object.keys(this.devices)}getStoredDevicesForUser(e){const t=this.devices[e];if(!t)return null;const i=[];for(const e in t)t.hasOwnProperty(e)&&i.push(h.V.fromStorage(t[e],e));return i}getRawStoredDevicesForUser(e){return this.devices[e]}getStoredCrossSigningForUser(e){return this.crossSigningInfo[e]?b.fromStorage(this.crossSigningInfo[e],e):null}storeCrossSigningForUser(e,t){this.crossSigningInfo[e]=t,this.dirty=!0}getStoredDevice(e,t){const i=this.devices[e];if(null!=i&&i[t])return h.V.fromStorage(i[t],t)}getUserByIdentityKey(e,t){return e!==u.OLM_ALGORITHM&&e!==u.MEGOLM_ALGORITHM?null:this.userByIdentityKey[t]}getDeviceByIdentityKey(e,t){const i=this.getUserByIdentityKey(e,t);if(!i)return null;const n=this.devices[i];if(!n)return null;for(const e in n){if(!n.hasOwnProperty(e))continue;const i=n[e];for(const n in i.keys){if(!i.keys.hasOwnProperty(n))continue;if(0!==n.indexOf("curve25519:"))continue;if(i.keys[n]==t)return h.V.fromStorage(i,e)}}return null}storeDevicesForUser(e,t){this.setRawStoredDevicesForUser(e,t),this.dirty=!0}startTrackingDeviceList(e){if("string"!=typeof e)throw new Error("userId must be a string; was "+e);this.deviceTrackingStatus[e]||(d.v.log("Now tracking device list for "+e),this.deviceTrackingStatus[e]=k.PendingDownload,this.dirty=!0)}stopTrackingDeviceList(e){this.deviceTrackingStatus[e]&&(d.v.log("No longer tracking device list for "+e),this.deviceTrackingStatus[e]=k.NotTracked,this.dirty=!0)}stopTrackingAllDeviceLists(){for(const e of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[e]=k.NotTracked;this.dirty=!0}invalidateUserDeviceList(e){this.deviceTrackingStatus[e]&&(d.v.log("Marking device list outdated for",e),this.deviceTrackingStatus[e]=k.PendingDownload,this.dirty=!0)}refreshOutdatedDeviceLists(){this.saveIfDirty();const e=[];for(const t of Object.keys(this.deviceTrackingStatus)){this.deviceTrackingStatus[t]==k.PendingDownload&&e.push(t)}return this.doKeyDownload(e)}setRawStoredDevicesForUser(e,t){if(void 0!==this.devices[e])for(const[t,i]of Object.entries(this.devices[e])){const e=i.keys["curve25519:"+t];delete this.userByIdentityKey[e]}this.devices[e]=t;for(const[i,n]of Object.entries(t)){const t=n.keys["curve25519:"+i];this.userByIdentityKey[t]=e}}setRawStoredCrossSigningForUser(e,t){this.crossSigningInfo[e]=t}doKeyDownload(e){if(0===e.length)return Promise.resolve();const t=this.serialiser.updateDevicesForUsers(e,this.syncToken).then((()=>{i(!0)}),(t=>{throw d.v.error("Error downloading keys for "+e+":",t),i(!1),t}));e.forEach((e=>{this.keyDownloadsInProgressByUser.set(e,t);this.deviceTrackingStatus[e]==k.PendingDownload&&(this.deviceTrackingStatus[e]=k.DownloadInProgress)}));const i=i=>{this.emit(Et.WillUpdateDevices,e,!this.hasFetched),e.forEach((e=>{if(this.dirty=!0,this.keyDownloadsInProgressByUser.get(e)!==t)return void d.v.log("Another update in the queue for",e,"- not marking up-to-date");this.keyDownloadsInProgressByUser.delete(e);this.deviceTrackingStatus[e]==k.DownloadInProgress&&(i?(this.deviceTrackingStatus[e]=k.UpToDate,d.v.log("Device list for",e,"now up to date")):this.deviceTrackingStatus[e]=k.PendingDownload)})),this.saveIfDirty(),this.emit(Et.DevicesUpdated,e,!this.hasFetched),this.hasFetched=!0};return t}}class T{constructor(e,t,i){this.baseApis=e,this.olmDevice=t,this.deviceList=i,(0,n.A)(this,"downloadInProgress",!1),(0,n.A)(this,"keyDownloadsQueuedByUser",{}),(0,n.A)(this,"queuedQueryDeferred",void 0),(0,n.A)(this,"syncToken",void 0)}updateDevicesForUsers(e,t){return e.forEach((e=>{this.keyDownloadsQueuedByUser[e]=!0})),this.queuedQueryDeferred||(this.queuedQueryDeferred=(0,E.v6)()),this.syncToken=t,this.downloadInProgress?(d.v.log("Queued key download for",e),this.queuedQueryDeferred.promise):this.doQueuedQueries()}doQueuedQueries(){if(this.downloadInProgress)throw new Error("DeviceListUpdateSerialiser.doQueuedQueries called with request active");const e=Object.keys(this.keyDownloadsQueuedByUser);this.keyDownloadsQueuedByUser={};const t=this.queuedQueryDeferred;this.queuedQueryDeferred=void 0,d.v.log("Starting key download for",e),this.downloadInProgress=!0;const i={};this.syncToken&&(i.token=this.syncToken);const n=[];for(let t=0;t<e.length;t+=this.deviceList.keyDownloadChunkSize){const r=e.slice(t,t+this.deviceList.keyDownloadChunkSize);n.push((()=>this.baseApis.downloadKeysForUsers(r,i)))}return(0,E.iK)(n,3).then((async t=>{const i=Object.assign({},...t.map((e=>e.device_keys||{}))),n=Object.assign({},...t.map((e=>e.master_keys||{}))),r=Object.assign({},...t.map((e=>e.self_signing_keys||{}))),s=Object.assign({},...t.map((e=>e.user_signing_keys||{})));for(const t of e){await(0,E.yy)(5);try{await this.processQueryResponseForUser(t,i[t],{master:null==n?void 0:n[t],self_signing:null==r?void 0:r[t],user_signing:null==s?void 0:s[t]})}catch(e){d.v.error(`Error processing keys for ${t}:`,e)}}})).then((()=>{d.v.log("Completed key download for "+e),this.downloadInProgress=!1,null==t||t.resolve(),this.queuedQueryDeferred&&this.doQueuedQueries()}),(i=>{d.v.warn("Error downloading keys for "+e+":",i),this.downloadInProgress=!1,null==t||t.reject(i)})),t.promise}async processQueryResponseForUser(e,t,i){d.v.log("got device keys for "+e+":",t),d.v.log("got cross-signing keys for "+e+":",i);{const i={},n=this.deviceList.getRawStoredDevicesForUser(e);n&&Object.keys(n).forEach((e=>{const t=h.V.fromStorage(n[e],e);i[e]=t})),await async function(e,t,i,n,r,s){let o=!1;for(const e in i)if(i.hasOwnProperty(e)&&!(e in n)){if(t===r&&e===s){d.v.warn(`Local device ${e} missing from sync, skipping removal`);continue}d.v.log("Device "+t+":"+e+" has been removed"),delete i[e],o=!0}for(const r in n){if(!n.hasOwnProperty(r))continue;const s=n[r];s.user_id===t?s.device_id===r?await C(e,i,s)&&(o=!0):d.v.warn("Mismatched device_id "+s.device_id+" in keys from "+t+":"+r):d.v.warn("Mismatched user_id "+s.user_id+" in keys from "+t+":"+r)}return o}(this.olmDevice,e,i,t||{},this.baseApis.getUserId(),this.baseApis.deviceId);const r={};Object.keys(i).forEach((e=>{r[e]=i[e].toStorage()})),this.deviceList.setRawStoredDevicesForUser(e,r)}if(i&&(i.master||i.self_signing||i.user_signing)){const t=this.deviceList.getStoredCrossSigningForUser(e)||new b(e);t.setKeys(i),this.deviceList.setRawStoredCrossSigningForUser(e,t.toStorage()),this.deviceList.emit(Et.UserCrossSigningUpdated,e)}}}async function C(e,t,i){if(!i.keys)return!1;const n=i.device_id,r=i.user_id,s="ed25519:"+n,o=i.keys[s];if(!o)return d.v.warn("Device "+r+":"+n+" has no ed25519 key"),!1;const a=i.unsigned||{},c=i.signatures||{};try{await u.verifySignature(e,i,r,n,o)}catch(e){return d.v.warn("Unable to verify signature on device "+r+":"+n+":"+e),!1}let l;if(n in t){if(l=t[n],l.getFingerprint()!=o)return d.v.warn("Ed25519 key for device "+r+":"+n+" has changed"),!1}else t[n]=l=new h.V(n);return l.keys=i.keys||{},l.algorithms=i.algorithms||[],l.unsigned=a,l.signatures=c,!0}var A=i("./node_modules/matrix-js-sdk/src/crypto/algorithms/base.ts"),O=i("./node_modules/matrix-js-sdk/src/common-crypto/CryptoBackend.ts");const x=h.V.DeviceVerification;class M extends A.li{constructor(...e){super(...e),(0,n.A)(this,"sessionPrepared",!1),(0,n.A)(this,"prepPromise",null)}ensureSession(e){return this.prepPromise?this.prepPromise:this.sessionPrepared?Promise.resolve():(this.prepPromise=this.crypto.downloadKeys(e).then((()=>this.crypto.ensureOlmSessionsForUsers(e))).then((()=>{this.sessionPrepared=!0})).finally((()=>{this.prepPromise=null})),this.prepPromise)}async encryptMessage(e,t,i){const n=(await e.getEncryptionTargetMembers()).map((function(e){return e.userId}));await this.ensureSession(n);const r={room_id:e.roomId,type:t,content:i},s={algorithm:u.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}},o=[];for(const e of n){const t=this.crypto.getStoredDevicesForUser(e)||[];for(const i of t){i.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&(i.verified!=x.BLOCKED&&o.push(u.encryptMessageForDevice(s.ciphertext,this.userId,this.deviceId,this.olmDevice,e,i,r)))}}return Promise.all(o).then((()=>s))}}class P extends A.Tb{async decryptEvent(e){const t=e.getWireContent(),i=t.sender_key,n=t.ciphertext;if(!n)throw new O.O(g.DecryptionFailureCode.OLM_MISSING_CIPHERTEXT,"Missing ciphertext");if(!(this.olmDevice.deviceCurve25519Key in n))throw new O.O(g.DecryptionFailureCode.OLM_NOT_INCLUDED_IN_RECIPIENTS,"Not included in recipients");const r=n[this.olmDevice.deviceCurve25519Key];let s;try{s=await this.decryptMessage(i,r)}catch(e){throw new O.O(g.DecryptionFailureCode.OLM_BAD_ENCRYPTED_MESSAGE,"Bad Encrypted Message",{sender:i,err:e})}const o=JSON.parse(s);if(o.recipient!=this.userId)throw new O.O(g.DecryptionFailureCode.OLM_BAD_RECIPIENT,"Message was intended for "+o.recipient);if(o.recipient_keys.ed25519!=this.olmDevice.deviceEd25519Key)throw new O.O(g.DecryptionFailureCode.OLM_BAD_RECIPIENT_KEY,"Message not intended for this device",{intended:o.recipient_keys.ed25519,our_key:this.olmDevice.deviceEd25519Key});let a=this.crypto.deviceList.getUserByIdentityKey(u.OLM_ALGORITHM,i);if(null==a){try{await this.crypto.deviceList.downloadKeys([e.getSender()],!1)}catch(e){throw new O.O(g.DecryptionFailureCode.OLM_BAD_SENDER_CHECK_FAILED,"Could not verify sender identity",{sender:i,err:e})}a=this.crypto.deviceList.getUserByIdentityKey(u.OLM_ALGORITHM,i)}if(a!==e.getSender()&&null!=a)throw new O.O(g.DecryptionFailureCode.OLM_BAD_SENDER,"Message claimed to be from "+e.getSender(),{real_sender:a});if(o.sender!=e.getSender())throw new O.O(g.DecryptionFailureCode.OLM_FORWARDED_MESSAGE,"Message forwarded from "+o.sender,{reported_sender:e.getSender()});if(o.room_id!==e.getRoomId())throw new O.O(g.DecryptionFailureCode.OLM_BAD_ROOM,"Message intended for room "+o.room_id,{reported_room:e.getRoomId()||"ROOM_ID_UNDEFINED"});return{clearEvent:o,senderCurve25519Key:i,claimedEd25519Key:(o.keys||{}).ed25519||null}}decryptMessage(e,t){if(0!==t.type)return this.reallyDecryptMessage(e,t);{const i=this.olmDevice.olmPrekeyPromise.then((()=>this.reallyDecryptMessage(e,t)));return this.olmDevice.olmPrekeyPromise=i.catch((()=>{})),i}}async reallyDecryptMessage(e,t){const i=await this.olmDevice.getSessionIdsForDevice(e),n={};for(const r of i)try{const i=await this.olmDevice.decryptMessage(e,r,t.type,t.body);return d.v.log("Decrypted Olm message from "+e+" with session "+r),i}catch(i){if(await this.olmDevice.matchesSession(e,r,t.type,t.body))throw new Error("Error decrypting prekey message with existing session id "+r+": "+i.message);n[r]=i.message}if(0!==t.type){if(0===i.length)throw new Error("No existing sessions");throw new Error("Error decrypting non-prekey message with existing sessions: "+JSON.stringify(n))}let r;try{r=await this.olmDevice.createInboundSession(e,t.type,t.body)}catch(e){throw n["(new)"]=e.message,new Error("Error decrypting prekey message: "+JSON.stringify(n))}return d.v.log("created new inbound Olm session ID "+r.session_id+" with "+e),r.payload}}(0,A.x)(u.OLM_ALGORITHM,M,P);i("./node_modules/matrix-js-sdk/src/crypto/algorithms/megolm.ts");var j=i("./node_modules/matrix-js-sdk/src/models/event.ts"),D=i("./node_modules/matrix-js-sdk/src/http-api/index.ts"),U=i("./node_modules/matrix-js-sdk/src/client.ts");class L{constructor(e,t){(0,n.A)(this,"accountDataClientAdapter",void 0),(0,n.A)(this,"crossSigningCallbacks",void 0),(0,n.A)(this,"ssssCryptoCallbacks",void 0),(0,n.A)(this,"crossSigningKeys",void 0),(0,n.A)(this,"keySignatures",void 0),(0,n.A)(this,"keyBackupInfo",void 0),(0,n.A)(this,"sessionBackupPrivateKey",void 0),this.accountDataClientAdapter=new B(e),this.crossSigningCallbacks=new F,this.ssssCryptoCallbacks=new K(t)}addCrossSigningKeys(e,t){this.crossSigningKeys={authUpload:e,keys:t}}addSessionBackup(e){this.keyBackupInfo=e}addSessionBackupPrivateKeyToCache(e){this.sessionBackupPrivateKey=e}addKeySignature(e,t,i){this.keySignatures||(this.keySignatures={});const n=this.keySignatures[e]||{};this.keySignatures[e]=n,n[t]=i}async setAccountData(e,t){await this.accountDataClientAdapter.setAccountData(e,t)}buildOperation(){const e=this.accountDataClientAdapter.values;return new N(e,this.crossSigningKeys,this.keyBackupInfo,this.keySignatures)}async persist(e){if(this.crossSigningKeys){const i=_(e.cryptoStore,e.olmDevice);for(const e of["master","self_signing","user_signing"]){var t;d.v.log(`Cache ${e} cross-signing private key locally`);const n=this.crossSigningCallbacks.privateKeys.get(e);await(null===(t=i.storeCrossSigningKeyCache)||void 0===t?void 0:t.call(i,e,n))}await e.cryptoStore.doTxn("readwrite",[m.y.STORE_ACCOUNT],(t=>{e.cryptoStore.storeCrossSigningKeys(t,this.crossSigningKeys.keys)}))}this.sessionBackupPrivateKey&&await e.storeSessionBackupPrivateKey(this.sessionBackupPrivateKey)}}class N{constructor(e,t,i,n){this.accountData=e,this.crossSigningKeys=t,this.keyBackupInfo=i,this.keySignatures=n}async apply(e){const t=e.baseApis;if(this.crossSigningKeys){var i,n;const r={};for(const[e,t]of Object.entries(this.crossSigningKeys.keys))r[e+"_key"]=t;await(null===(i=(n=this.crossSigningKeys).authUpload)||void 0===i?void 0:i.call(n,(e=>t.uploadDeviceSigningKeys(null!=e?e:void 0,r)))),e.crossSigningInfo.setKeys(this.crossSigningKeys.keys)}if(this.accountData)for(const[e,i]of this.accountData)await t.setAccountData(e,i);this.keySignatures&&await t.uploadKeySignatures(this.keySignatures),this.keyBackupInfo&&(this.keyBackupInfo.version?await t.http.authedRequest(D.IT.Put,"/room_keys/version/"+this.keyBackupInfo.version,void 0,{algorithm:this.keyBackupInfo.algorithm,auth_data:this.keyBackupInfo.auth_data},{prefix:D.iD.V3}):await t.http.authedRequest(D.IT.Post,"/room_keys/version",void 0,this.keyBackupInfo,{prefix:D.iD.V3}),await e.backupManager.checkKeyBackup())}}class B extends I.X{constructor(e){super(),this.existingValues=e,(0,n.A)(this,"values",new Map)}getAccountDataFromServer(e){return Promise.resolve(this.getAccountData(e))}getAccountData(e){const t=this.values.get(e);if(t)return t;const i=this.existingValues.get(e);return i?i.getContent():null}setAccountData(e,t){const i=this.values.get(e);return this.values.set(e,t),Promise.resolve().then((()=>{const n=new j.kl({type:e,content:t});return this.emit(U.AU.AccountData,n,i),{}}))}}class F{constructor(){(0,n.A)(this,"privateKeys",new Map)}getCrossSigningKeyCache(e,t){return this.getCrossSigningKey(e,t)}storeCrossSigningKeyCache(e,t){return this.privateKeys.set(e,t),Promise.resolve()}getCrossSigningKey(e,t){var i;return Promise.resolve(null!==(i=this.privateKeys.get(e))&&void 0!==i?i:null)}saveCrossSigningKeys(e){for(const[t,i]of Object.entries(e))this.privateKeys.set(t,i)}}class K{constructor(e){this.delegateCryptoCallbacks=e,(0,n.A)(this,"privateKeys",new Map)}async getSecretStorageKey({keys:e},t){var i;for(const t of Object.keys(e)){const e=this.privateKeys.get(t);if(e)return[t,e]}if(null!=this&&null!==(i=this.delegateCryptoCallbacks)&&void 0!==i&&i.getSecretStorageKey){const i=await this.delegateCryptoCallbacks.getSecretStorageKey({keys:e},t);if(i){const[e,t]=i;this.privateKeys.set(e,t)}return i}return null}addPrivateKey(e,t,i){var n,r;this.privateKeys.set(e,i),null===(n=this.delegateCryptoCallbacks)||void 0===n||null===(r=n.cacheSecretStorageKey)||void 0===r||r.call(n,e,t,i)}}var $=i("./node_modules/matrix-js-sdk/src/secret-storage.ts");class q{constructor(e,t){this.baseApis=e,this.cryptoCallbacks=t,(0,n.A)(this,"requests",new Map)}request(e,t){const i=this.baseApis.makeTxnId(),n=(0,E.v6)();this.requests.set(i,{name:e,devices:t,deferred:n});const r={name:e,action:"request",requesting_device_id:this.baseApis.deviceId,request_id:i,[a.wt]:(0,o.A)()},s=new Map;for(const e of t)s.set(e,r);return d.v.info(`Request secret ${e} from ${t}, id ${i}`),this.baseApis.sendToDevice("m.secret.request",new Map([[this.baseApis.getUserId(),s]])),{requestId:i,promise:n.promise,cancel:e=>{const r={action:"request_cancellation",requesting_device_id:this.baseApis.deviceId,request_id:i},s=new Map;for(const e of t)s.set(e,r);this.baseApis.sendToDevice("m.secret.request",new Map([[this.baseApis.getUserId(),s]])),n.reject(new Error(e||"Cancelled"))}}}async onRequestReceived(e){const t=e.getSender(),i=e.getContent();if(t!==this.baseApis.getUserId()||!(i.name&&i.action&&i.requesting_device_id&&i.request_id))return;const n=i.requesting_device_id;if("request_cancellation"===i.action);else if("request"===i.action){if(n===this.baseApis.deviceId)return;if(d.v.info("received request for secret ("+t+", "+n+", "+i.request_id+")"),!this.cryptoCallbacks.onSecretRequested)return;const e=await this.cryptoCallbacks.onSecretRequested(t,n,i.request_id,i.name,this.baseApis.checkDeviceTrust(t,n));if(e){d.v.info(`Preparing ${i.name} secret for ${n}`);const r={type:"m.secret.send",content:{request_id:i.request_id,secret:e}},s={algorithm:u.OLM_ALGORITHM,sender_key:this.baseApis.crypto.olmDevice.deviceCurve25519Key,ciphertext:{},[a.wt]:(0,o.A)()};await u.ensureOlmSessionsForDevices(this.baseApis.crypto.olmDevice,this.baseApis,new Map([[t,[this.baseApis.getStoredDevice(t,n)]]])),await u.encryptMessageForDevice(s.ciphertext,this.baseApis.getUserId(),this.baseApis.deviceId,this.baseApis.crypto.olmDevice,t,this.baseApis.getStoredDevice(t,n),r);const c=new Map([[t,new Map([[n,s]])]]);d.v.info(`Sending ${i.name} secret for ${n}`),this.baseApis.sendToDevice("m.room.encrypted",c)}else d.v.info(`Request denied for ${i.name} secret for ${n}`)}}onSecretReceived(e){if(e.getSender()!==this.baseApis.getUserId())return;if(!u.isOlmEncrypted(e))return void d.v.error("secret event not properly encrypted");const t=e.getContent();if(this.baseApis.crypto.deviceList.getUserByIdentityKey(u.OLM_ALGORITHM,e.getSenderKey()||"")!==e.getSender())return void d.v.error("sending device does not belong to the user it claims to be from");d.v.log("got secret share for request",t.request_id);const i=this.requests.get(t.request_id);if(i){const n=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(u.OLM_ALGORITHM,e.getSenderKey());if(!n)return void d.v.log("secret share from unknown device with key",e.getSenderKey());if(!i.devices.includes(n.deviceId))return void d.v.log("unsolicited secret share from device",n.deviceId);if(!this.baseApis.crypto.checkDeviceInfoTrust(e.getSender(),n).isVerified())return void d.v.log("secret share from unverified device");d.v.log(`Successfully received secret ${i.name} from ${n.deviceId}`),i.deferred.resolve(t.secret)}}}class V{constructor(e,t,i){(0,n.A)(this,"storageImpl",void 0),(0,n.A)(this,"sharingImpl",void 0),this.storageImpl=new $.ServerSideSecretStorageImpl(e,t),this.sharingImpl=new q(i,t)}getDefaultKeyId(){return this.storageImpl.getDefaultKeyId()}setDefaultKeyId(e){return this.storageImpl.setDefaultKeyId(e)}addKey(e,t,i){return this.storageImpl.addKey(e,t,i)}getKey(e){return this.storageImpl.getKey(e)}hasKey(e){return this.storageImpl.hasKey(e)}checkKey(e,t){return this.storageImpl.checkKey(e,t)}store(e,t,i){return this.storageImpl.store(e,t,i)}get(e){return this.storageImpl.get(e)}async isStored(e){return this.storageImpl.isStored(e)}request(e,t){return this.sharingImpl.request(e,t)}onRequestReceived(e){return this.sharingImpl.onRequestReceived(e)}onSecretReceived(e){this.sharingImpl.onSecretReceived(e)}}var G=i("./node_modules/matrix-js-sdk/src/crypto/api.ts"),W=i("./node_modules/matrix-js-sdk/src/crypto/OutgoingRoomKeyRequestManager.ts"),H=i("./node_modules/matrix-js-sdk/src/crypto/crypto.ts");function J(e,t){return function(i){return function(e,t,i){const n=Object.assign({},{code:e,reason:t},i);return new j.kl({type:a.Bx.KeyVerificationCancel,content:n})}(e,t,i)}}const z=J("m.user","Cancelled by user"),Q=J("m.timeout","Timed out"),Y=J("m.unknown_method","Unknown method"),X=J("m.unexpected_message","Unexpected message"),Z=J("m.key_mismatch","Key mismatch"),ee=J("m.invalid_message","Invalid message");function te(e){const t=e.getContent();if(t){const{code:e,reason:i}=t;return{code:e,reason:i}}return{code:"Unknown error",reason:"m.unknown"}}var ie=i("./node_modules/matrix-js-sdk/src/crypto-api/verification.ts");const ne=new Error("Verification timed out");class re extends Error{constructor(e){super(),this.startEvent=e}}const se=ie.Ji;class oe extends I.X{constructor(e,t,i,r,s,o){super(),this.channel=e,this.baseApis=t,this.userId=i,this.deviceId=r,this.startEvent=s,this.request=o,(0,n.A)(this,"cancelled",!1),(0,n.A)(this,"_done",!1),(0,n.A)(this,"promise",null),(0,n.A)(this,"transactionTimeoutTimer",null),(0,n.A)(this,"expectedEvent",void 0),(0,n.A)(this,"resolve",void 0),(0,n.A)(this,"reject",void 0),(0,n.A)(this,"resolveEvent",void 0),(0,n.A)(this,"rejectEvent",void 0),(0,n.A)(this,"started",void 0),(0,n.A)(this,"doVerification",void 0)}get initiatedByMe(){if(!this.startEvent)return!0;const e=this.startEvent.getSender(),t=this.startEvent.getContent();return e===this.baseApis.getUserId()&&t.from_device===this.baseApis.getDeviceId()}get hasBeenCancelled(){return this.cancelled}resetTimer(){d.v.info("Refreshing/starting the verification transaction timeout timer"),null!==this.transactionTimeoutTimer&&clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=setTimeout((()=>{this._done||this.cancelled||(d.v.info("Triggering verification timeout"),this.cancel(ne))}),6e5)}endTimer(){null!==this.transactionTimeoutTimer&&(clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=null)}send(e,t){return this.channel.send(e,t)}waitForEvent(e){if(this._done)return Promise.reject(new Error("Verification is already done"));const t=this.request.getEventFromOtherParty(e);return t?Promise.resolve(t):(this.expectedEvent=e,new Promise(((e,t)=>{this.resolveEvent=e,this.rejectEvent=t})))}canSwitchStartEvent(e){return!1}switchStartEvent(e){if(this.canSwitchStartEvent(e))if(d.v.log("Verification Base: switching verification start event",{restartingFlow:!!this.rejectEvent}),this.rejectEvent){const t=this.rejectEvent;this.rejectEvent=void 0,t(new re(e))}else this.startEvent=e}handleEvent(e){var t;if(!this._done)if(e.getType()===this.expectedEvent)this.expectedEvent!==a.Bx.KeyVerificationDone&&(this.expectedEvent=void 0,this.rejectEvent=void 0,this.resetTimer(),null===(t=this.resolveEvent)||void 0===t||t.call(this,e));else if(e.getType()===a.Bx.KeyVerificationCancel){const t=this.reject;if(this.reject=void 0,t){const i=e.getContent(),{reason:n,code:r}=i;t(new Error(`Other side cancelled verification because ${n} (${r})`))}}else if(this.expectedEvent){const t=new Error("Unexpected message: expecting "+this.expectedEvent+" but got "+e.getType());if(this.expectedEvent=void 0,this.rejectEvent){const e=this.rejectEvent;this.rejectEvent=void 0,e(t)}this.cancel(t)}}async done(){var e;if(this.endTimer(),!this._done)return this.request.onVerifierFinished(),null===(e=this.resolve)||void 0===e||e.call(this),async function(e,t,i){if(e.getUserId()===t)return d.v.log("Cross-signing: Self-verification done; requesting keys"),new Promise(((t,n)=>{const r=e,s=r.crypto.crossSigningInfo,o=new b(s.userId,{getCrossSigningKey:async e=>{d.v.debug("Cross-signing: requesting secret",e,i);const{promise:t}=r.requestSecret(`m.cross_signing.${e}`,[i]),n=await t,s=(0,v.y4)(n);return Uint8Array.from(s)}},s.getCacheCallbacks());o.keys=s.keys;const a=new Promise((e=>{setTimeout(e,6e4,new Error("Timeout"))})),c=(async()=>{if(!await r.crypto.getSessionBackupPrivateKey()){d.v.info("No cached backup key found. Requesting...");const e=r.requestSecret("m.megolm_backup.v1",[i]),t=await e.promise;d.v.info("Got key backup key, decoding...");const n=(0,v.y4)(t);d.v.info("Decoded backup key, storing..."),await r.crypto.storeSessionBackupPrivateKey(Uint8Array.from(n)),d.v.info("Backup key stored. Starting backup restore...");const s=await r.getKeyBackupVersion();r.restoreKeyBackupWithCache(void 0,void 0,s).then((()=>{d.v.info("Backup restored.")}))}})();Promise.race([Promise.all([o.getCrossSigningKey("master"),o.getCrossSigningKey("self_signing"),o.getCrossSigningKey("user_signing"),c]),a]).then(t,n)})).catch((e=>{d.v.warn("Cross-signing: failure while requesting keys:",e)}))}(this.baseApis,this.userId,this.deviceId)}cancel(e){if(this.endTimer(),!this._done){if(this.cancelled=!0,this.request.onVerifierCancelled(),this.userId&&this.deviceId)if(e===ne){const e=Q();this.send(e.getType(),e.getContent())}else if(e instanceof j.kl){if(e.getSender()!==this.userId){const t=e.getContent();e.getType()===a.Bx.KeyVerificationCancel?(t.code=t.code||"m.unknown",t.reason=t.reason||t.body||"Unknown reason",this.send(a.Bx.KeyVerificationCancel,t)):this.send(a.Bx.KeyVerificationCancel,{code:"m.unknown",reason:t.body||"Unknown reason"})}}else this.send(a.Bx.KeyVerificationCancel,{code:"m.unknown",reason:e.toString()});null!==this.promise?this.reject&&this.reject(e):this.promise=Promise.reject(e),this.emit(se.Cancel,e)}}verify(){return this.promise||(this.promise=new Promise(((e,t)=>{this.resolve=(...t)=>{this._done=!0,this.endTimer(),e(...t)},this.reject=e=>{this._done=!0,this.endTimer(),t(e)}})),this.doVerification&&!this.started&&(this.started=!0,this.resetTimer(),new Promise(((e,t)=>{var i;(null===(i=this.baseApis.crypto.deviceList.getStoredCrossSigningForUser(this.userId))||void 0===i?void 0:i.getId())===this.deviceId&&t(new Error("Device ID is the same as the cross-signing ID")),e()})).then((()=>this.doVerification())).then(this.done.bind(this),this.cancel.bind(this)))),this.promise}async verifyKeys(e,t,i){const n=[];for(const[r,s]of Object.entries(t)){const t=r.split(":",2)[1],o=this.baseApis.getStoredDevice(e,t);if(o)i(r,o,s),n.push([t,r,o.keys[r]]);else{const o=this.baseApis.crypto.deviceList.getStoredCrossSigningForUser(e);o&&o.getId()===t?(i(r,h.V.fromStorage({keys:{[r]:t}},t),s),n.push([t,r,t])):d.v.warn(`verification: Could not find device ${t} to verify`)}}if(!n.length)throw new Error("No devices could be verified");d.v.info("Verification completed! Marking devices verified: ",n);for(const[t,i,r]of n)await this.baseApis.crypto.setDeviceVerification(e,t,!0,null,null,{[i]:r});e==this.baseApis.credentials.userId&&await this.baseApis.checkKeyBackup()}get events(){}getShowSasCallbacks(){return null}getReciprocateQrCodeCallbacks(){return null}}var ae=i("./node_modules/matrix-js-sdk/src/types.ts"),ce=i("./node_modules/buffer/index.js").hp;const de=ae.V.ShowQrCode,le=ae.V.ScanQrCode,ue=ie.Ji;class he extends oe{constructor(...e){super(...e),(0,n.A)(this,"reciprocateQREvent",void 0),(0,n.A)(this,"doVerification",(async()=>{if(!this.startEvent)throw new Error("It is not currently possible to start verificationwith this method yet.");const{qrCodeData:e}=this.request;if(this.startEvent.getContent().secret!==(null==e?void 0:e.encodedSharedSecret))throw Z();await new Promise(((e,t)=>{this.reciprocateQREvent={confirm:e,cancel:()=>t(z())},this.emit(ue.ShowReciprocateQr,this.reciprocateQREvent)}));const t={};switch(null==e?void 0:e.mode){case me.VerifyOtherUser:{const i=e.otherUserMasterKey;t[`ed25519:${i}`]=i;break}case me.VerifySelfTrusted:{const i=this.request.targetDevice.deviceId;t[`ed25519:${i}`]=e.otherDeviceKey;break}case me.VerifySelfUntrusted:{const i=e.myMasterKey;t[`ed25519:${i}`]=i;break}}await this.verifyKeys(this.userId,t,((e,i,n)=>{const r=t[e];if(!r)throw Z();if(n!==r)throw d.v.error("key ID from key info does not match"),Z();for(const e in i.keys){if(!e.startsWith("ed25519"))continue;const n=t[e];if(!n)throw Z();if(i.keys[e]!==n)throw d.v.error("master key does not match"),Z()}}))}))}static factory(e,t,i,n,r,s){return new he(e,t,i,n,r,s)}static get NAME(){return"m.reciprocate.v1"}getReciprocateQrCodeCallbacks(){var e;return null!==(e=this.reciprocateQREvent)&&void 0!==e?e:null}}var me=function(e){return e[e.VerifyOtherUser=0]="VerifyOtherUser",e[e.VerifySelfTrusted=1]="VerifySelfTrusted",e[e.VerifySelfUntrusted=2]="VerifySelfUntrusted",e}(me||{});class pe{constructor(e,t,i,n,r,s){this.mode=e,this.sharedSecret=t,this.otherUserMasterKey=i,this.otherDeviceKey=n,this.myMasterKey=r,this.buffer=s}static async create(e,t){const i=pe.generateSharedSecret(),n=pe.determineMode(e,t);let r=null,s=null,o=null;if(n===me.VerifyOtherUser){r=t.getStoredCrossSigningForUser(e.otherUserId).getId("master")}else if(n===me.VerifySelfTrusted)s=await pe.getOtherDeviceKey(e,t);else if(n===me.VerifySelfUntrusted){const e=t.getUserId();o=t.getStoredCrossSigningForUser(e).getId("master")}const a=pe.generateQrData(e,t,n,i,r,s,o),c=pe.generateBuffer(a);return new pe(n,i,r,s,o,c)}get encodedSharedSecret(){return this.sharedSecret}getBuffer(){return this.buffer}static generateSharedSecret(){const e=new Uint8Array(11);return H.Et.getRandomValues(e),(0,v.PP)(e)}static async getOtherDeviceKey(e,t){const i=t.getUserId(),n=e.targetDevice,r=n.deviceId?t.getStoredDevice(i,n.deviceId):void 0;if(!r)throw new Error("could not find device "+(null==n?void 0:n.deviceId));return r.getFingerprint()}static determineMode(e,t){const i=t.getUserId(),n=e.otherUserId;let r=me.VerifyOtherUser;if(i===n){r=t.checkUserTrust(i).isCrossSigningVerified()?me.VerifySelfTrusted:me.VerifySelfUntrusted}return r}static generateQrData(e,t,i,n,r,s,o){const a=t.getUserId(),c={prefix:"MATRIX",version:2,mode:i,transactionId:e.channel.transactionId,firstKeyB64:"",secondKeyB64:"",secretB64:n},d=t.getStoredCrossSigningForUser(a);return i===me.VerifyOtherUser?(c.firstKeyB64=d.getId("master"),c.secondKeyB64=r):i===me.VerifySelfTrusted?(c.firstKeyB64=d.getId("master"),c.secondKeyB64=s):i===me.VerifySelfUntrusted&&(c.firstKeyB64=t.getDeviceEd25519Key(),c.secondKeyB64=o),c}static generateBuffer(e){let t=ce.alloc(0);const i=e=>{const i=ce.from([e]);t=ce.concat([t,i])},n=(e,i,n=!0)=>{const r=ce.from(e,i);n&&(e=>{const i=ce.alloc(2);i.writeInt16BE(e,0),t=ce.concat([t,i])})(r.byteLength),t=ce.concat([t,r])},r=e=>{const i=(0,v.y4)(e),n=ce.from(i);t=ce.concat([t,n])};return n(e.prefix,"ascii",!1),i(e.version),i(e.mode),n(e.transactionId,"utf-8"),r(e.firstKeyB64),r(e.secondKeyB64),r(e.secretB64),t}}var ge=i("./node_modules/matrix-js-sdk/src/crypto/verification/SASDecimal.ts");const ve=a.Bx.KeyVerificationStart,fe=[a.Bx.KeyVerificationAccept,a.Bx.KeyVerificationKey,a.Bx.KeyVerificationMac];let ye;const be=J("m.mismatched_sas","Mismatched short authentication string"),Se=J("m.mismatched_commitment","Mismatched commitment"),we=[["","dog"],["","cat"],["","lion"],["","horse"],["","unicorn"],["","pig"],["","elephant"],["","rabbit"],["","panda"],["","rooster"],["","penguin"],["","turtle"],["","fish"],["","octopus"],["","butterfly"],["","flower"],["","tree"],["","cactus"],["","mushroom"],["","globe"],["","moon"],["","cloud"],["","fire"],["","banana"],["","apple"],["","strawberry"],["","corn"],["","pizza"],["","cake"],["","heart"],["","smiley"],["","robot"],["","hat"],["","glasses"],["","spanner"],["","santa"],["","thumbs up"],["","umbrella"],["","hourglass"],["","clock"],["","gift"],["","light bulb"],["","book"],["","pencil"],["","paperclip"],["","scissors"],["","lock"],["","key"],["","hammer"],["","telephone"],["","flag"],["","train"],["","bicycle"],["","aeroplane"],["","rocket"],["","trophy"],["","ball"],["","guitar"],["","trumpet"],["","bell"],["","anchor"],["","headphones"],["","folder"],["","pin"]];const _e={decimal:ge.c,emoji:function(e){return[e[0]>>2,(3&e[0])<<4|e[1]>>4,(15&e[1])<<2|e[2]>>6,63&e[2],e[3]>>2,(3&e[3])<<4|e[4]>>4,(15&e[4])<<2|e[5]>>6].map((e=>we[e]))}};function Ee(e,t){const i={};for(const n of t)n in _e&&(i[n]=_e[n](Array.from(e)));return i}const Ie={"hkdf-hmac-sha256":"calculate_mac","org.matrix.msc3783.hkdf-hmac-sha256":"calculate_mac_fixed_base64","hkdf-hmac-sha256.v2":"calculate_mac_fixed_base64","hmac-sha256":"calculate_mac_long_kdf"};function ke(e,t){return function(i,n){const r=e[Ie[t]](i,n);return d.v.log("SAS calculateMAC:",t,[i,n],r),r}}const Re={"curve25519-hkdf-sha256":function(e,t,i){const n=`${e.baseApis.getUserId()}|${e.baseApis.deviceId}|${e.ourSASPubKey}|`,r=`${e.userId}|${e.deviceId}|${e.theirSASPubKey}|`,s="MATRIX_KEY_VERIFICATION_SAS|"+(e.initiatedByMe?n+r:r+n)+e.channel.transactionId;return t.generate_bytes(s,i)},curve25519:function(e,t,i){const n=`${e.baseApis.getUserId()}${e.baseApis.deviceId}`,r=`${e.userId}${e.deviceId}`,s="MATRIX_KEY_VERIFICATION_SAS"+(e.initiatedByMe?n+r:r+n)+e.channel.transactionId;return t.generate_bytes(s,i)}},Te=["curve25519-hkdf-sha256","curve25519"],Ce=["sha256"],Ae=["hkdf-hmac-sha256.v2","org.matrix.msc3783.hkdf-hmac-sha256","hkdf-hmac-sha256","hmac-sha256"],Oe=Object.keys(_e),xe=new Set(Te),Me=new Set(Ce),Pe=new Set(Ae),je=new Set(Oe);function De(e,t){return Array.isArray(e)?e.filter((e=>t.has(e))):[]}const Ue=ie.Ji;class Le extends oe{constructor(...e){super(...e),(0,n.A)(this,"waitingForAccept",void 0),(0,n.A)(this,"ourSASPubKey",void 0),(0,n.A)(this,"theirSASPubKey",void 0),(0,n.A)(this,"sasEvent",void 0),(0,n.A)(this,"doVerification",(async()=>{await i.g.Olm.init(),ye=ye||new i.g.Olm.Utility,await this.baseApis.downloadKeys([this.userId]);let e=!1;do{try{return this.initiatedByMe?await this.doSendVerification():await this.doRespondVerification()}catch(t){if(!(t instanceof re))throw t;this.startEvent=t.startEvent,e=!0}}while(e)}))}static get NAME(){return ae.V.Sas}get events(){return fe}canSwitchStartEvent(e){if(e.getType()!==ve)return!1;const t=e.getContent();return(null==t?void 0:t.method)===Le.NAME&&!!this.waitingForAccept}async sendStart(){const e=this.channel.completeContent(ve,{method:Le.NAME,from_device:this.baseApis.deviceId,key_agreement_protocols:Te,hashes:Ce,message_authentication_codes:Ae,short_authentication_string:Oe});return await this.channel.sendCompleted(ve,e),e}async verifyAndCheckMAC(e,t,i,n){const r=Re[e](this,i,6),s=new Promise(((e,s)=>{this.sasEvent={sas:Ee(r,t),confirm:async()=>{try{await this.sendMAC(i,n),e()}catch(e){s(e)}},cancel:()=>s(z()),mismatch:()=>s(be())},this.emit(Ue.ShowSas,this.sasEvent)})),[o]=await Promise.all([this.waitForEvent(a.Bx.KeyVerificationMac).then((e=>(this.expectedEvent=a.Bx.KeyVerificationDone,e))),s]),c=o.getContent();await this.checkMAC(i,c,n)}async doSendVerification(){let e,t;if(this.waitingForAccept=!0,e=this.startEvent?this.channel.completedContentFromEvent(this.startEvent):await this.sendStart(),!this.initiatedByMe)throw new re(this.startEvent);try{t=await this.waitForEvent(a.Bx.KeyVerificationAccept)}finally{this.waitingForAccept=!1}let n=t.getContent();const r=De(n.short_authentication_string,je);if(!(xe.has(n.key_agreement_protocol)&&Me.has(n.hash)&&Pe.has(n.message_authentication_code)&&r.length))throw Y();if("string"!=typeof n.commitment)throw ee();const o=n.key_agreement_protocol,c=n.message_authentication_code,d=n.commitment,l=new i.g.Olm.SAS;try{this.ourSASPubKey=l.get_pubkey(),await this.send(a.Bx.KeyVerificationKey,{key:this.ourSASPubKey}),t=await this.waitForEvent(a.Bx.KeyVerificationKey),n=t.getContent();const i=n.key+s().stringify(e);if(ye.sha256(i)!==d)throw Se();this.theirSASPubKey=n.key,l.set_their_key(n.key),await this.verifyAndCheckMAC(o,r,l,c)}finally{l.free()}}async doRespondVerification(){let e=this.channel.completedContentFromEvent(this.startEvent);const t=De(Te,new Set(e.key_agreement_protocols))[0],n=De(Ce,new Set(e.hashes))[0],r=De(Ae,new Set(e.message_authentication_codes))[0],o=De(e.short_authentication_string,je);if(void 0===t||void 0===n||void 0===r||!o.length)throw Y();const c=new i.g.Olm.SAS;try{const i=c.get_pubkey()+s().stringify(e);await this.send(a.Bx.KeyVerificationAccept,{key_agreement_protocol:t,hash:n,message_authentication_code:r,short_authentication_string:o,commitment:ye.sha256(i)});e=(await this.waitForEvent(a.Bx.KeyVerificationKey)).getContent(),this.theirSASPubKey=e.key,c.set_their_key(e.key),this.ourSASPubKey=c.get_pubkey(),await this.send(a.Bx.KeyVerificationKey,{key:this.ourSASPubKey}),await this.verifyAndCheckMAC(t,o,c,r)}finally{c.free()}}sendMAC(e,t){const i={},n=[],r="MATRIX_KEY_VERIFICATION_MAC"+this.baseApis.getUserId()+this.baseApis.deviceId+this.userId+this.deviceId+this.channel.transactionId,s=`ed25519:${this.baseApis.deviceId}`;i[s]=ke(e,t)(this.baseApis.getDeviceEd25519Key(),r+s),n.push(s);const o=this.baseApis.getCrossSigningId();if(o){const s=`ed25519:${o}`;i[s]=ke(e,t)(o,r+s),n.push(s)}const c=ke(e,t)(n.sort().join(","),r+"KEY_IDS");return this.send(a.Bx.KeyVerificationMac,{mac:i,keys:c})}async checkMAC(e,t,i){const n="MATRIX_KEY_VERIFICATION_MAC"+this.userId+this.deviceId+this.baseApis.getUserId()+this.baseApis.deviceId+this.channel.transactionId;if(t.keys!==ke(e,i)(Object.keys(t.mac).sort().join(","),n+"KEY_IDS"))throw Z();await this.verifyKeys(this.userId,t.mac,((t,r,s)=>{if(s!==ke(e,i)(r.keys[t],n+t))throw Z()}))}getShowSasCallbacks(){var e;return null!==(e=this.sasEvent)&&void 0!==e?e:null}}var Ne=i("./node_modules/matrix-js-sdk/src/crypto/key_passphrase.ts"),Be=i("./node_modules/matrix-js-sdk/src/crypto/recoverykey.ts");const Fe="m.key.verification.",Ke=Fe+"request",$e=Fe+"start",qe=Fe+"cancel",Ve=Fe+"done",Ge=Fe+"ready",We=ie.X9.Unsent,He=ie.X9.Requested,Je=ie.X9.Ready,ze=ie.X9.Started,Qe=ie.X9.Cancelled,Ye=ie.X9.Done;class Xe extends I.X{constructor(e,t,i){super(),this.channel=e,this.verificationMethods=t,this.client=i,(0,n.A)(this,"eventsByUs",new Map),(0,n.A)(this,"eventsByThem",new Map),(0,n.A)(this,"_observeOnly",!1),(0,n.A)(this,"timeoutTimer",null),(0,n.A)(this,"_accepting",!1),(0,n.A)(this,"_declining",!1),(0,n.A)(this,"verifierHasFinished",!1),(0,n.A)(this,"_cancelled",!1),(0,n.A)(this,"_chosenMethod",null),(0,n.A)(this,"_qrCodeData",null),(0,n.A)(this,"requestReceivedAt",null),(0,n.A)(this,"commonMethods",[]),(0,n.A)(this,"_phase",void 0),(0,n.A)(this,"_cancellingUserId",void 0),(0,n.A)(this,"_verifier",void 0),(0,n.A)(this,"cancelOnTimeout",(async()=>{try{this.initiatedByMe?await this.cancel({reason:"Other party didn't accept in time",code:"m.timeout"}):await this.cancel({reason:"User didn't accept in time",code:"m.timeout"})}catch(e){d.v.error("Error while cancelling verification request",e)}})),this.channel.request=this,this.setPhase(We,!1)}static validateEvent(e,t,i){const n=t.getContent();return!(!e||!e.startsWith(Fe))&&(n?e!==Ke&&e!==Ge||Array.isArray(n.methods)?e!==Ke&&e!==Ge&&e!==$e||"string"==typeof n.from_device&&0!==n.from_device.length||(d.v.log("VerificationRequest: validateEvent: fail because from_device"),!1):(d.v.log("VerificationRequest: validateEvent: fail because methods"),!1):(d.v.log("VerificationRequest: validateEvent: no content"),!1))}get transactionId(){return this.channel.transactionId}get roomId(){return this.channel.roomId}get invalid(){return this.phase===We}get requested(){return this.phase===He}get cancelled(){return this.phase===Qe}get ready(){return this.phase===Je}get started(){return this.phase===ze}get done(){return this.phase===Ye}get methods(){return this.commonMethods}get chosenMethod(){return this._chosenMethod}calculateEventTimeout(e){let t=this.channel.getTimestamp(e)+6e5;if(this.requestReceivedAt&&!this.initiatedByMe&&this.phase<=He){const e=this.requestReceivedAt+12e4;t=Math.min(t,e)}return Math.max(0,t-Date.now())}get timeout(){const e=this.getEventByEither(Ke);return e?this.calculateEventTimeout(e):0}get requestEvent(){return this.getEventByEither(Ke)}get phase(){return this._phase}get verifier(){return this._verifier}get canAccept(){return(0,ie.Dy)(this)}get accepting(){return this._accepting}get declining(){return this._declining}get pending(){return!this.observeOnly&&this._phase!==Ye&&this._phase!==Qe}get qrCodeData(){return this._qrCodeData}getQRCodeBytes(){var e;return null===(e=this._qrCodeData)||void 0===e?void 0:e.getBuffer()}async generateQRCode(){return this.getQRCodeBytes()}otherPartySupportsMethod(e,t=!1){if(!t&&!this.ready&&!this.started)return!1;const i=this.eventsByThem.get(Ke)||this.eventsByThem.get(Ge);if(!i){if(this.started&&this.initiatedByMe){const t=this.eventsByUs.get($e),i=t&&t.getContent();return e==(i&&i.method)}return!1}const n=i.getContent();if(!n)return!1;const{methods:r}=n;return!!Array.isArray(r)&&r.includes(e)}get initiatedByMe(){const e=this.eventsByUs.size+this.eventsByThem.size===0;if(this._phase===We&&e)return!0;const t=this.eventsByUs.has(Ke),i=this.eventsByThem.has(Ke);if(t&&!i)return!0;if(!t&&i)return!1;const n=this.eventsByUs.has($e),r=this.eventsByThem.has($e);return!(!n||r)}get requestingUserId(){return this.initiatedByMe?this.client.getUserId():this.otherUserId}get receivingUserId(){return this.initiatedByMe?this.otherUserId:this.client.getUserId()}get otherUserId(){return this.channel.userId}get otherDeviceId(){return this.channel.deviceId}get isSelfVerification(){return this.client.getUserId()===this.otherUserId}get cancellingUserId(){const e=this.eventsByUs.get(qe),t=this.eventsByThem.get(qe);return e&&(!t||e.getId()<t.getId())?e.getSender():t?t.getSender():void 0}get cancellationCode(){const e=this.getEventByEither(qe);return e?e.getContent().code:null}get observeOnly(){return this._observeOnly}get targetDevice(){const e=this.eventsByThem.get(Ke)||this.eventsByThem.get(Ge)||this.eventsByThem.get($e),t=null==e?void 0:e.getContent(),i=null==t?void 0:t.from_device;return{userId:this.otherUserId,deviceId:i}}beginKeyVerification(e,t=null){if(!this.observeOnly&&!this._verifier){if(this.phase===He||this.phase===Je||this.phase===We&&this.channel.canCreateRequest($e)){if(this.commonMethods.length&&!this.commonMethods.includes(e))throw Y();if(this._verifier=this.createVerifier(e,null,t),!this._verifier)throw Y();this._chosenMethod=e}}return this._verifier}async startVerification(e){const t=this.beginKeyVerification(e);return t.verify(),t}scanQRCode(e){throw new Error("QR code scanning not supported by legacy crypto")}async sendRequest(){if(!this.observeOnly&&this._phase===We){const e=[...this.verificationMethods.keys()];await this.channel.send(Ke,{methods:e})}}async cancel({reason:e="User declined",code:t="m.user"}={}){if(!this.observeOnly&&this._phase!==Qe){if(this._declining=!0,this.emit(ie.FM.Change),this._verifier)return this._verifier.cancel(J(t,e)());this._cancellingUserId=this.client.getUserId(),await this.channel.send(qe,{code:t,reason:e})}}async accept(){if(!this.observeOnly&&this.phase===He&&!this.initiatedByMe){const e=[...this.verificationMethods.keys()];this._accepting=!0,this.emit(ie.FM.Change),await this.channel.send(Ge,{methods:e})}}waitFor(e){return new Promise(((t,i)=>{const n=()=>{let r=!1;return e(this)?(t(this),r=!0):this.cancelled&&(i(new Error("cancelled")),r=!0),r&&this.off(ie.FM.Change,n),r};n()||this.on(ie.FM.Change,n)}))}setPhase(e,t=!0){this._phase=e,t&&this.emit(ie.FM.Change)}getEventByEither(e){return this.eventsByThem.get(e)||this.eventsByUs.get(e)}getEventBy(e,t=!1){return t?this.eventsByThem.get(e):this.eventsByUs.get(e)}calculatePhaseTransitions(){const e=[{phase:We}],t=()=>e[e.length-1].phase,i=this.eventsByThem.has(Ke),n=this.getEventBy(Ke,i);n&&e.push({phase:He,event:n});const r=n&&this.getEventBy(Ge,!i);let s;if(r&&t()===He&&e.push({phase:Je,event:r}),r||!n){const e=this.eventsByThem.get($e),t=this.eventsByUs.get($e);s=e&&t?e.getSender()<t.getSender()?e:t:e||t}else s=this.getEventBy($e,!i);if(s){const i=t()===He&&(null==n?void 0:n.getSender())!==s.getSender(),r=t()===We&&this.channel.canCreateRequest($e);(i||t()===Je||r)&&e.push({phase:ze,event:s})}const o=this.eventsByUs.get(Ve);(this.verifierHasFinished||o&&t()===ze)&&e.push({phase:Ye});const a=this.getEventByEither(qe);return(this._cancelled||a)&&t()!==Ye?(e.push({phase:Qe,event:a}),e):e}transitionToPhase(e){const{phase:t,event:i}=e;if((t===He||t===Je)&&!this.wasSentByOwnDevice(i)){const e=i.getContent();this.commonMethods=e.methods.filter((e=>this.verificationMethods.has(e)))}if(this.observeOnly||t!==He&&t!==ze&&t!==Je||this.channel.receiveStartFromOtherDevices&&this.wasSentByOwnUser(i)&&!this.wasSentByOwnDevice(i)&&(this._observeOnly=!0),t===ze){const{method:e}=i.getContent();this._verifier||this.observeOnly||(this._verifier=this.createVerifier(e,i),this._verifier?this._chosenMethod=e:this.cancel({code:"m.unknown_method",reason:`Unknown method: ${e}`}))}}applyPhaseTransitions(){const e=this.calculatePhaseTransitions(),t=e.findIndex((e=>e.phase===this.phase)),i=e.slice(t+1);for(const e of i)this.transitionToPhase(e);return i}isWinningStartRace(e){if(e.getType()!==$e)return!1;const t=this._verifier.startEvent;let i,n;if(this.isSelfVerification)if(t){const e=t.getContent();i=e&&e.from_device}else i=this.client.getDeviceId();else i=t?t.getSender():this.client.getUserId();if(this.isSelfVerification){const t=e.getContent();n=t&&t.from_device}else n=e.getSender();return n<i}hasEventId(e){for(const t of this.eventsByUs.values())if(t.getId()===e)return!0;for(const t of this.eventsByThem.values())if(t.getId()===e)return!0;return!1}async handleEvent(e,t,i,n,r){if(this.done||this.cancelled)return;const s=this._observeOnly;if(this.adjustObserveOnly(t,i),!this.observeOnly&&!n&&await this.cancelOnError(e,t))return;if(r?this.eventsByUs.has(e):this.eventsByThem.has(e))return;const o=this.phase;this.addEvent(e,t,r);const a=this.applyPhaseTransitions();try{if(this._verifier&&!this.observeOnly){const i=this.isWinningStartRace(t);if(this._verifier.canSwitchStartEvent(t)&&i)this._verifier.switchStartEvent(t);else if(!n){var c;(e===qe||null!==(c=this._verifier.events)&&void 0!==c&&c.includes(e))&&this._verifier.handleEvent(t)}}if(a.length){if(i&&a.some((e=>e.phase===Je))){this.otherPartySupportsMethod(le,!0)&&(this._qrCodeData=await pe.create(this,this.client))}const e=a[a.length-1],{phase:t}=e;this.setupTimeout(t),this.setPhase(t)}else this._observeOnly!==s&&this.emit(ie.FM.Change)}finally{d.v.log(`Verification request ${this.channel.transactionId}: ${e} event with id:${t.getId()}, content:${JSON.stringify(t.getContent())} deviceId:${this.channel.deviceId}, sender:${t.getSender()}, isSentByUs:${r}, isLiveEvent:${i}, isRemoteEcho:${n}, phase:${o}=>${this.phase}, observeOnly:${s}=>${this._observeOnly}`)}}setupTimeout(e){if(!this.timeoutTimer&&!this.observeOnly&&e===He&&(this.timeoutTimer=setTimeout(this.cancelOnTimeout,this.timeout)),this.timeoutTimer){(e===ze||e===Je||e===Ye||e===Qe)&&(clearTimeout(this.timeoutTimer),this.timeoutTimer=null)}}async cancelOnError(e,t){if(e===$e){const e=t.getContent().method;if(!this.verificationMethods.has(e))return await this.cancel(te(Y())),!0}const i=e===Ke&&this.phase!==We,n=e===Ge&&this.phase!==He&&this.phase!==ze;if(this.phase!==We&&(i||n)){d.v.warn(`Cancelling, unexpected ${e} verification event from ${t.getSender()}`);const i=`Unexpected ${e} event in phase ${this.phase}`;return await this.cancel(te(X({reason:i}))),!0}return!1}adjustObserveOnly(e,t=!1){t||(this._observeOnly=!0),this.calculateEventTimeout(e)<3e3&&(this._observeOnly=!0)}addEvent(e,t,i=!1){if(i?this.eventsByUs.set(e,t):this.eventsByThem.set(e,t),e===Ke){for(const[e,t]of this.eventsByThem.entries())t.getSender()!==this.otherUserId&&this.eventsByThem.delete(e);this.requestReceivedAt=Date.now()}}createVerifier(e,t=null,i=null){i||(i=this.targetDevice);const{userId:n,deviceId:r}=i,s=this.verificationMethods.get(e);if(s)return new s(this.channel,this.client,n,r,t,this);d.v.warn("could not find verifier constructor for method",e)}wasSentByOwnUser(e){return(null==e?void 0:e.getSender())===this.client.getUserId()}wasSentByOwnDevice(e){if(!this.wasSentByOwnUser(e))return!1;const t=e.getContent();return!(!t||t.from_device!==this.client.getDeviceId())}onVerifierCancelled(){this._cancelled=!0;const e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}onVerifierFinished(){this.channel.send(a.Bx.KeyVerificationDone,{}),this.verifierHasFinished=!0;const e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}getEventFromOtherParty(e){return this.eventsByThem.get(e)}}const Ze=a.Bx.RoomMessage,et="m.reference",tt="m.relates_to";class it{constructor(e,t,i){this.client=e,this.roomId=t,this.userId=i,(0,n.A)(this,"requestEventId",void 0)}get receiveStartFromOtherDevices(){return!0}get transactionId(){return this.requestEventId}static getOtherPartyUserId(e,t){if(it.getEventType(e)!==Ke)return;const i=t.getUserId(),n=e.getSender(),r=e.getContent().to;return n===i?r:r===i?n:void 0}getTimestamp(e){return e.getTs()}static canCreateRequest(e){return e===Ke}canCreateRequest(e){return it.canCreateRequest(e)}static getTransactionId(e){if(it.getEventType(e)===Ke)return e.getId();{const t=e.getRelation();if((null==t?void 0:t.rel_type)===et)return t.event_id}}static validateEvent(e,t){const i=it.getTransactionId(e);if("string"!=typeof i||0===i.length)return!1;const n=it.getEventType(e),r=e.getContent();if(n===Ke){if(!r||"string"!=typeof r.to||!r.to.length)return d.v.log("InRoomChannel: validateEvent: no valid to "+r.to),!1;if(!it.getOtherPartyUserId(e,t))return d.v.log(`InRoomChannel: validateEvent: not directed to or sent by me: ${e.getSender()}, ${r.to}`),!1}return Xe.validateEvent(n,e,t)}static getEventType(e){const t=e.getType();if(t===Ze){const t=e.getContent();if(t){const{msgtype:e}=t;if(e===Ke)return Ke}}return t&&t!==Ke?t:""}async handleEvent(e,t,i=!1){if(t.hasEventId(e.getId()))return;const n=it.getEventType(e);if(e.getRoomId()!==this.roomId)return;if(!this.userId){const t=it.getOtherPartyUserId(e,this.client);t&&(this.userId=t)}const r=this.client.getUserId(),s=e.getSender();if(this.userId&&s!==r&&s!==this.userId)return void d.v.log(`InRoomChannel: ignoring verification event from non-participating sender ${s}`);this.requestEventId||(this.requestEventId=it.getTransactionId(e));const o=!!e.getTxnId(),a=!!e.getUnsigned().transaction_id,c=e.getSender()===this.client.getUserId();return t.handleEvent(n,e,i,o||a,c)}completedContentFromEvent(e){const t=Object.assign({},e.getContent());return t[tt]=e.getRelation(),t}completeContent(e,t){return t=Object.assign({},t),e!==Ke&&e!==Ge&&e!==$e||(t.from_device=this.client.getDeviceId()),e===Ke?t={body:this.client.getUserId()+" is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.",msgtype:Ke,to:this.userId,from_device:t.from_device,methods:t.methods}:t[tt]={rel_type:et,event_id:this.transactionId},t}send(e,t){const i=this.completeContent(e,t);return this.sendCompleted(e,i)}async sendCompleted(e,t){let i=e;e===Ke&&(i=Ze);const n=await this.client.sendEvent(this.roomId,i,t);e===Ke&&(this.requestEventId=n.event_id)}}class nt{constructor(){(0,n.A)(this,"requestsByRoomId",new Map)}getRequest(e){const t=e.getRoomId(),i=it.getTransactionId(e);return this.getRequestByTxnId(t,i)}getRequestByChannel(e){return this.getRequestByTxnId(e.roomId,e.transactionId)}getRequestByTxnId(e,t){const i=this.requestsByRoomId.get(e);if(i)return i.get(t)}setRequest(e,t){this.doSetRequest(e.getRoomId(),it.getTransactionId(e),t)}setRequestByChannel(e,t){this.doSetRequest(e.roomId,e.transactionId,t)}doSetRequest(e,t,i){let n=this.requestsByRoomId.get(e);n||(n=new Map,this.requestsByRoomId.set(e,n)),n.set(t,i)}removeRequest(e){const t=e.getRoomId(),i=this.requestsByRoomId.get(t);i&&(i.delete(it.getTransactionId(e)),0===i.size&&this.requestsByRoomId.delete(t))}findRequestInProgress(e,t){const i=this.requestsByRoomId.get(e);if(i)for(const e of i.values())if(e.pending&&(void 0===t||e.requestingUserId===t))return e}}var rt=i("./node_modules/matrix-js-sdk/src/randomstring.ts");class st{constructor(e,t,i,r,s){this.client=e,this.userId=t,this.devices=i,this.transactionId=r,this.deviceId=s,(0,n.A)(this,"request",void 0)}isToDevices(e){if(e.length===this.devices.length){for(const t of e)if(!this.devices.includes(t))return!1;return!0}return!1}static getEventType(e){return e.getType()}static getTransactionId(e){const t=e.getContent();return t&&t.transaction_id}static canCreateRequest(e){return e===Ke||e===$e}canCreateRequest(e){return st.canCreateRequest(e)}static validateEvent(e,t){if(e.isCancelled())return d.v.warn("Ignoring flagged verification request from "+e.getSender()),!1;const i=e.getContent();if(!i)return d.v.warn("ToDeviceChannel.validateEvent: invalid: no content"),!1;if(!i.transaction_id)return d.v.warn("ToDeviceChannel.validateEvent: invalid: no transaction_id"),!1;const n=e.getType();if(n===Ke){if(!Number.isFinite(i.timestamp))return d.v.warn("ToDeviceChannel.validateEvent: invalid: no timestamp"),!1;if(e.getSender()===t.getUserId()&&i.from_device==t.getDeviceId())return d.v.warn("ToDeviceChannel.validateEvent: invalid: from own device"),!1}return Xe.validateEvent(n,e,t)}getTimestamp(e){const t=e.getContent();return t&&t.timestamp}async handleEvent(e,t,i=!1){const n=e.getType(),r=e.getContent();if(n===Ke||n===Ge||n===$e){this.transactionId||(this.transactionId=r.transaction_id);const e=r.from_device;if(!this.deviceId&&this.devices.includes(e)&&(this.deviceId=e),!this.deviceId||this.deviceId!==e){const t=this.completeContent(qe,te(X()));return this.sendToDevices(qe,t,[e])}}const s=t.phase===ze||t.phase===Je;await t.handleEvent(e.getType(),e,i,!1,!1);const o=t.phase===ze||t.phase===Je;if((n===$e||n===Ge)&&!s&&o&&this.deviceId){const e=this.devices.filter((e=>e!==this.deviceId&&e!==this.client.getDeviceId()));if(e.length){const t=this.completeContent(qe,{code:"m.accepted",reason:"Verification request accepted by another device"});await this.sendToDevices(qe,t,e)}}}completedContentFromEvent(e){return e.getContent()}completeContent(e,t){return t=Object.assign({},t),this.transactionId&&(t.transaction_id=this.transactionId),e!==Ke&&e!==Ge&&e!==$e||(t.from_device=this.client.getDeviceId()),e===Ke&&(t.timestamp=Date.now()),t}send(e,t={}){e!==Ke&&e!==$e||this.transactionId||(this.transactionId=st.makeTransactionId());const i=this.completeContent(e,t);return this.sendCompleted(e,i)}async sendCompleted(e,t){let i;i=e===Ke||e===qe&&!this.deviceId?await this.sendToDevices(e,t,this.devices):await this.sendToDevices(e,t,[this.deviceId]);const n=new j.kl({sender:this.client.getUserId(),content:t,type:e});return await this.request.handleEvent(e,n,!0,!0,!0),i}async sendToDevices(e,t,i){if(i.length){const n=new Map;for(const e of i)n.set(e,t);await this.client.sendToDevice(e,new Map([[this.userId,n]]))}}static makeTransactionId(){return(0,rt.DU)(32)}}class ot{constructor(){(0,n.A)(this,"requestsByUserId",new Map)}getRequest(e){return this.getRequestBySenderAndTxnId(e.getSender(),st.getTransactionId(e))}getRequestByChannel(e){return this.getRequestBySenderAndTxnId(e.userId,e.transactionId)}getRequestBySenderAndTxnId(e,t){const i=this.requestsByUserId.get(e);if(i)return i.get(t)}setRequest(e,t){this.setRequestBySenderAndTxnId(e.getSender(),st.getTransactionId(e),t)}setRequestByChannel(e,t){this.setRequestBySenderAndTxnId(e.userId,e.transactionId,t)}setRequestBySenderAndTxnId(e,t,i){let n=this.requestsByUserId.get(e);n||(n=new Map,this.requestsByUserId.set(e,n)),n.set(t,i)}removeRequest(e){const t=e.getSender(),i=this.requestsByUserId.get(t);i&&(i.delete(st.getTransactionId(e)),0===i.size&&this.requestsByUserId.delete(t))}findRequestInProgress(e,t){const i=this.requestsByUserId.get(e);if(i)for(const e of i.values())if(e.pending&&e.channel.isToDevices(t))return e}getRequestsInProgress(e){const t=this.requestsByUserId.get(e);return t?Array.from(t.values()).filter((e=>e.pending)):[]}}class at extends oe{constructor(...e){super(...e),(0,n.A)(this,"doVerification",(async()=>{throw new Error("Verification is not possible with this method")}))}static factory(e,t,i,n,r,s){return new at(e,t,i,n,r,s)}static get NAME(){return"org.matrix.illegal_method"}}var ct=i("./node_modules/matrix-js-sdk/src/errors.ts"),dt=i("./node_modules/matrix-js-sdk/src/crypto/dehydration.ts"),lt=i("./node_modules/matrix-js-sdk/src/crypto/backup.ts"),ut=i("./node_modules/matrix-js-sdk/src/models/room.ts"),ht=i("./node_modules/matrix-js-sdk/src/models/room-member.ts");class mt{constructor(e){this.cryptoStore=e,(0,n.A)(this,"roomEncryption",{})}async init(){await this.cryptoStore.doTxn("readwrite",[m.y.STORE_ROOMS],(e=>{this.cryptoStore.getEndToEndRooms(e,(e=>{this.roomEncryption=e}))}))}getRoomEncryption(e){return this.roomEncryption[e]||null}isRoomEncrypted(e){return Boolean(this.getRoomEncryption(e))}async setRoomEncryption(e,t){this.roomEncryption[e]=t,await this.cryptoStore.doTxn("readwrite",[m.y.STORE_ROOMS],(i=>{this.cryptoStore.storeEndToEndRoom(e,t,i)}))}}var pt=i("./node_modules/matrix-js-sdk/src/models/room-state.ts"),gt=i("./node_modules/matrix-js-sdk/src/models/device.ts");function vt(e,t){const i=new Map(Object.entries(e.keys)),n=e.getDisplayName()||void 0,r=new Map;if(e.signatures)for(const t in e.signatures)r.set(t,new Map(Object.entries(e.signatures[t])));return new gt.p({deviceId:e.deviceId,userId:t,keys:i,algorithms:e.algorithms,verified:e.verified,signatures:r,displayName:n})}var ft=i("./node_modules/matrix-js-sdk/src/@types/membership.ts"),yt=i("./node_modules/buffer/index.js").hp;function bt(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}const St=h.V.DeviceVerification,wt={[he.NAME]:he,[Le.NAME]:Le,[de]:at,[le]:at};function _t(){return Boolean(globalThis.Olm)}let Et=function(e){return e.DeviceVerificationChanged="deviceVerificationChanged",e.UserTrustStatusChanged="userTrustStatusChanged",e.UserCrossSigningUpdated="userCrossSigningUpdated",e.RoomKeyRequest="crypto.roomKeyRequest",e.RoomKeyRequestCancellation="crypto.roomKeyRequestCancellation",e.KeyBackupStatus="crypto.keyBackupStatus",e.KeyBackupFailed="crypto.keyBackupFailed",e.KeyBackupSessionsRemaining="crypto.keyBackupSessionsRemaining",e.KeyBackupDecryptionKeyCached="crypto.keyBackupDecryptionKeyCached",e.KeySignatureUploadFailure="crypto.keySignatureUploadFailure",e.VerificationRequest="crypto.verification.request",e.VerificationRequestReceived="crypto.verificationRequestReceived",e.Warning="crypto.warning",e.WillUpdateDevices="crypto.willUpdateDevices",e.DevicesUpdated="crypto.devicesUpdated",e.KeysChanged="crossSigning.keysChanged",e.LegacyCryptoStoreMigrationProgress="crypto.legacyCryptoStoreMigrationProgress",e}({});class It extends I.X{static getOlmVersion(){return l.FL.getOlmVersion()}constructor(e,t,i,r,s,o){if(super(),this.baseApis=e,this.userId=t,this.deviceId=i,this.clientStore=r,this.cryptoStore=s,(0,n.A)(this,"backupManager",void 0),(0,n.A)(this,"crossSigningInfo",void 0),(0,n.A)(this,"olmDevice",void 0),(0,n.A)(this,"deviceList",void 0),(0,n.A)(this,"dehydrationManager",void 0),(0,n.A)(this,"secretStorage",void 0),(0,n.A)(this,"roomList",void 0),(0,n.A)(this,"reEmitter",void 0),(0,n.A)(this,"verificationMethods",void 0),(0,n.A)(this,"supportedAlgorithms",void 0),(0,n.A)(this,"outgoingRoomKeyRequestManager",void 0),(0,n.A)(this,"toDeviceVerificationRequests",void 0),(0,n.A)(this,"inRoomVerificationRequests",void 0),(0,n.A)(this,"trustCrossSignedDevices",!0),(0,n.A)(this,"lastOneTimeKeyCheck",null),(0,n.A)(this,"oneTimeKeyCheckInProgress",!1),(0,n.A)(this,"roomEncryptors",new Map),(0,n.A)(this,"roomDecryptors",new Map),(0,n.A)(this,"deviceKeys",{}),(0,n.A)(this,"globalBlacklistUnverifiedDevices",!1),(0,n.A)(this,"globalErrorOnUnknownDevices",!0),(0,n.A)(this,"receivedRoomKeyRequests",[]),(0,n.A)(this,"receivedRoomKeyRequestCancellations",[]),(0,n.A)(this,"processingRoomKeyRequests",!1),(0,n.A)(this,"lazyLoadMembers",!1),(0,n.A)(this,"roomDeviceTrackingState",{}),(0,n.A)(this,"forceNewSessionRetryTime",new E.kG((()=>new E.kG((()=>0))))),(0,n.A)(this,"sendKeyRequestsImmediately",!1),(0,n.A)(this,"oneTimeKeyCount",void 0),(0,n.A)(this,"needsNewFallback",void 0),(0,n.A)(this,"fallbackCleanup",void 0),(0,n.A)(this,"onDeviceListUserCrossSigningUpdated",(async e=>{if(e===this.userId){const t=this.deviceList.getStoredCrossSigningForUser(e),i=t?t.getId():null,n=this.crossSigningInfo.getId();n&&i&&!(n!==i)?await this.checkOwnCrossSigningTrust():(this.storeTrustedSelfKeys(null),this.emit(Et.KeysChanged,{}),this.emit(Et.UserTrustStatusChanged,this.userId,this.checkUserTrust(e)))}else{await this.checkDeviceVerifications(e);const t=this.deviceList.getStoredCrossSigningForUser(e);t&&(t.updateCrossSigningVerifiedBefore(this.checkUserTrust(e).isCrossSigningVerified()),this.deviceList.setRawStoredCrossSigningForUser(e,t.toStorage())),this.emit(Et.UserTrustStatusChanged,e,this.checkUserTrust(e))}})),(0,n.A)(this,"onMembership",((e,t,i)=>{try{this.onRoomMembership(e,t,i)}catch(e){d.v.error("Error handling membership change:",e)}})),(0,n.A)(this,"onToDeviceEvent",(e=>{try{d.v.log(`received to-device ${e.getType()} from: ${e.getSender()} id: ${e.getContent()[a.wt]}`),"m.room_key"==e.getType()||"m.forwarded_room_key"==e.getType()?this.onRoomKeyEvent(e):"m.room_key_request"==e.getType()?this.onRoomKeyRequestEvent(e):"m.secret.request"===e.getType()?this.secretStorage.onRequestReceived(e):"m.secret.send"===e.getType()?this.secretStorage.onSecretReceived(e):"m.room_key.withheld"===e.getType()?this.onRoomKeyWithheldEvent(e):e.getContent().transaction_id?this.onKeyVerificationMessage(e):"m.bad.encrypted"===e.getContent().msgtype?this.onToDeviceBadEncrypted(e):(e.isBeingDecrypted()||e.shouldAttemptDecryption())&&(e.isBeingDecrypted()||e.attemptDecryption(this),e.once(j.OQ.Decrypted,(e=>{this.onToDeviceEvent(e)})))}catch(e){d.v.error("Error handling toDeviceEvent:",e)}})),(0,n.A)(this,"onTimelineEvent",((e,t,i,n,{liveEvent:r=!0}={})=>{if(!it.validateEvent(e,this.baseApis))return;this.handleVerificationEvent(e,this.inRoomVerificationRequests,(e=>{const t=new it(this.baseApis,e.getRoomId());return new Xe(t,this.verificationMethods,this.baseApis)}),r)})),d.v.debug("Crypto: initialising roomlist..."),this.roomList=new mt(s),this.reEmitter=new c.Q(this),o){this.verificationMethods=new Map;for(const e of o)"string"==typeof e?wt[e]&&this.verificationMethods.set(e,wt[e]):e.NAME?this.verificationMethods.set(e.NAME,e):d.v.warn(`Excluding unknown verification method ${e}`)}else this.verificationMethods=new Map(Object.entries(wt));this.backupManager=new lt.IO(e,(async()=>{const e=await this.getSessionBackupPrivateKey();if(e)return e;const t=await this.secretStorage.get("m.megolm_backup.v1");if(t){const e=kt(t);if(e){const t=await this.secretStorage.getKey();await this.secretStorage.store("m.megolm_backup.v1",e,[t[0]])}return(0,v.y4)(e||t)}if(this.baseApis.cryptoCallbacks&&this.baseApis.cryptoCallbacks.getBackupKey)return this.baseApis.cryptoCallbacks.getBackupKey();throw new Error("Unable to get private key")})),this.olmDevice=new l.FL(s),this.deviceList=new R(e,s,this.olmDevice),this.deviceList.on(Et.UserCrossSigningUpdated,this.onDeviceListUserCrossSigningUpdated),this.reEmitter.reEmit(this.deviceList,[Et.DevicesUpdated,Et.WillUpdateDevices]),this.supportedAlgorithms=Array.from(A.Jn.keys()),this.outgoingRoomKeyRequestManager=new W.z(e,this.deviceId,this.cryptoStore),this.toDeviceVerificationRequests=new ot,this.inRoomVerificationRequests=new nt;const u=this.baseApis.cryptoCallbacks||{},h=_(s,this.olmDevice);this.crossSigningInfo=new b(t,u,h),this.secretStorage=new V(e,u,e),this.dehydrationManager=new dt.v(this),!u.getCrossSigningKey&&u.getSecretStorageKey&&(u.getCrossSigningKey=async e=>b.getFromSecretStorage(e,this.secretStorage))}async init({exportedOlmDevice:e,pickleKey:t}={}){d.v.log("Crypto: initialising Olm..."),await i.g.Olm.init(),d.v.log(e?"Crypto: initialising Olm device from exported device...":"Crypto: initialising Olm device..."),await this.olmDevice.init({fromExportedDevice:e,pickleKey:t}),d.v.log("Crypto: loading device list..."),await this.deviceList.load(),this.deviceKeys["ed25519:"+this.deviceId]=this.olmDevice.deviceEd25519Key,this.deviceKeys["curve25519:"+this.deviceId]=this.olmDevice.deviceCurve25519Key,d.v.log("Crypto: fetching own devices...");let n=this.deviceList.getRawStoredDevicesForUser(this.userId);if(n||(n={}),!n[this.deviceId]){d.v.log("Crypto: adding this device to the store...");const e={keys:this.deviceKeys,algorithms:this.supportedAlgorithms,verified:St.VERIFIED,known:!0};n[this.deviceId]=e,this.deviceList.storeDevicesForUser(this.userId,n),this.deviceList.saveIfDirty()}await this.cryptoStore.doTxn("readonly",[m.y.STORE_ACCOUNT],(e=>{this.cryptoStore.getCrossSigningKeys(e,(e=>{e&&0!==Object.keys(e).length&&(d.v.log("Loaded cross-signing public keys from crypto store"),this.crossSigningInfo.setKeys(e))}))})),this.deviceList.startTrackingDeviceList(this.userId),d.v.debug("Crypto: initialising roomlist..."),await this.roomList.init(),d.v.log("Crypto: checking for key backup..."),this.backupManager.checkAndStart()}getVersion(){const e=It.getOlmVersion();return`Olm ${e[0]}.${e[1]}.${e[2]}`}getTrustCrossSignedDevices(){return this.trustCrossSignedDevices}getCryptoTrustCrossSignedDevices(){return this.trustCrossSignedDevices}setTrustCrossSignedDevices(e){this.trustCrossSignedDevices=e;for(const e of this.deviceList.getKnownUserIds()){const t=this.deviceList.getRawStoredDevicesForUser(e);for(const i of Object.keys(t)){const t=this.checkDeviceTrust(e,i);if(!t.isLocallyVerified()&&t.isCrossSigningVerified()){const t=this.deviceList.getStoredDevice(e,i);this.emit(Et.DeviceVerificationChanged,e,i,t)}}}}setCryptoTrustCrossSignedDevices(e){this.setTrustCrossSignedDevices(e)}async createRecoveryKeyFromPassphrase(e){const t=new i.g.Olm.PkDecryption;try{if(e){const i=await(0,Ne.SM)(e);t.init_with_private_key(i.key);const n=t.get_private_key();return{keyInfo:{passphrase:{algorithm:"m.pbkdf2",iterations:i.iterations,salt:i.salt}},privateKey:n,encodedPrivateKey:(0,Be.j)(n)}}{t.generate_key();const e=t.get_private_key();return{privateKey:e,encodedPrivateKey:(0,Be.j)(e)}}}finally{null==t||t.free()}}async userHasCrossSigningKeys(e=this.userId){return await this.downloadKeys([e]),null!==this.deviceList.getStoredCrossSigningForUser(e)}async isCrossSigningReady(){const e=this.crossSigningInfo.getId(),t=await this.crossSigningInfo.isStoredInKeyCache()||await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage);return!(!e||!t)}async isSecretStorageReady(){const e=await this.secretStorage.hasKey(),t=await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),i=!this.backupManager.getKeyBackupEnabled()||await this.baseApis.isKeyBackupKeyStored();return!!(e&&t&&i)}async getCrossSigningStatus(){var e,t,i;const n=Boolean(this.crossSigningInfo.getId()),r=Boolean(await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage)),s=this.crossSigningInfo.getCacheCallbacks();return{publicKeysOnDevice:n,privateKeysInSecretStorage:r,privateKeysCachedLocally:{masterKey:Boolean(await(null===(e=s.getCrossSigningKeyCache)||void 0===e?void 0:e.call(s,"master"))),selfSigningKey:Boolean(await(null===(t=s.getCrossSigningKeyCache)||void 0===t?void 0:t.call(s,"self_signing"))),userSigningKey:Boolean(await(null===(i=s.getCrossSigningKeyCache)||void 0===i?void 0:i.call(s,"user_signing")))}}}async bootstrapCrossSigning({authUploadDeviceSigningKeys:e,setupNewCrossSigning:t}={}){d.v.log("Bootstrapping cross-signing");const i=this.baseApis.cryptoCallbacks,n=new L(this.baseApis.store.accountData,i),r=new b(this.userId,n.crossSigningCallbacks,n.crossSigningCallbacks),s=async()=>{r.resetKeys(),await this.signObject(r.keys.master),n.addCrossSigningKeys(e,r.keys);const t=this.deviceList.getStoredDevice(this.userId,this.deviceId),i=await r.signDevice(this.userId,t);n.addKeySignature(this.userId,this.deviceId,i),this.backupManager.backupInfo&&(await r.signObject(this.backupManager.backupInfo.auth_data,"master"),n.addSessionBackup(this.backupManager.backupInfo))},o=this.crossSigningInfo.getId(),a=await this.crossSigningInfo.isStoredInKeyCache(),c=await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),l=a||c;d.v.log({setupNewCrossSigning:t,publicKeysOnDevice:o,privateKeysInCache:a,privateKeysInStorage:c,privateKeysExistSomewhere:l}),!l||t?(d.v.log("Cross-signing private keys not found locally or in secret storage, creating new keys"),await s()):o&&a?d.v.log("Cross-signing public keys trusted and private keys found locally"):c&&(d.v.log("Cross-signing private keys not found locally, but they are available in secret storage, reading storage and caching locally"),await this.checkOwnCrossSigningTrust({allowPrivateKeyRequests:!0}));const u=n.crossSigningCallbacks.privateKeys;if(u.size&&!this.baseApis.cryptoCallbacks.saveCrossSigningKeys){const e=new $.ServerSideSecretStorageImpl(n.accountDataClientAdapter,n.ssssCryptoCallbacks);await e.hasKey()&&(d.v.log("Storing new cross-signing private keys in secret storage"),await b.storeInSecretStorage(u,e))}const h=n.buildOperation();await h.apply(this),await n.persist(this),d.v.log("Cross-signing ready")}async bootstrapSecretStorage({createSecretStorageKey:e=(async()=>({})),keyBackupInfo:t,setupNewKeyBackup:i,setupNewSecretStorage:n,getKeyBackupPassphrase:r}={}){d.v.log("Bootstrapping Secure Secret Storage");const s=this.baseApis.cryptoCallbacks,o=new L(this.baseApis.store.accountData,s),a=new $.ServerSideSecretStorageImpl(o.accountDataClientAdapter,o.ssssCryptoCallbacks);let c=null;const l=async e=>{const{keyId:t,keyInfo:i}=await a.addKey($.SECRET_STORAGE_ALGORITHM_V1_AES,e);return o.ssssCryptoCallbacks.addPrivateKey(t,i,e.key),await a.setDefaultKeyId(t),t},u=async(e,t)=>{if(!t.mac){var i,n;const r=await(null===(i=(n=this.baseApis.cryptoCallbacks).getSecretStorageKey)||void 0===i?void 0:i.call(n,{keys:{[e]:t}},""));if(r){const i=r[1];o.ssssCryptoCallbacks.addPrivateKey(e,t,i);const{iv:n,mac:s}=await(0,p.iV)(i);t.iv=n,t.mac=s,await o.setAccountData(`m.secret_storage.key.${e}`,t)}}},h=async e=>{if(this.crossSigningInfo.getId()&&await this.crossSigningInfo.isStoredInKeyCache("master"))try{d.v.log("Adding cross-signing signature to key backup"),await this.crossSigningInfo.signObject(e,"master")}catch(e){d.v.error("Signing key backup with cross-signing keys failed",e)}else d.v.warn("Cross-signing keys not available, skipping signature on key backup")},m=await this.secretStorage.getKey(),[g,f]=m||[null,null],y=!n&&f&&f.algorithm===$.SECRET_STORAGE_ALGORITHM_V1_AES;if(d.v.log({keyBackupInfo:t,setupNewKeyBackup:i,setupNewSecretStorage:n,storageExists:y,oldKeyInfo:f}),y||t)if(!y&&t){d.v.log("Secret storage does not exist, using key backup key");const e=await this.getSessionBackupPrivateKey()||await(null==r?void 0:r()),i={key:e};t.auth_data.private_key_salt&&t.auth_data.private_key_iterations&&(i.passphrase={algorithm:"m.pbkdf2",iterations:t.auth_data.private_key_iterations,salt:t.auth_data.private_key_salt,bits:256}),c=await l(i),await a.store("m.megolm_backup.v1",(0,v.WG)(e),[c]),await h(t.auth_data),o.addSessionBackup(t)}else d.v.log("Secret storage exists"),f&&f.algorithm===$.SECRET_STORAGE_ALGORITHM_V1_AES&&await u(g,f);else{d.v.log("Secret storage does not exist, creating new storage key");const{keyInfo:t,privateKey:i}=await e();c=await l({passphrase:null==t?void 0:t.passphrase,key:i,name:null==t?void 0:t.name})}if(!this.baseApis.cryptoCallbacks.saveCrossSigningKeys&&await this.isCrossSigningReady()&&(c||!await this.crossSigningInfo.isStoredInSecretStorage(a))){d.v.log("Copying cross-signing private keys from cache to secret storage");const e=await this.crossSigningInfo.getCrossSigningKeysFromCache();await b.storeInSecretStorage(e,a)}if(i&&!t){d.v.log("Creating new message key backup version");const e=await this.baseApis.prepareKeyBackupVersion(null,{secureSecretStorage:!1}),t=(0,Be.R)(e.recovery_key);await a.store("m.megolm_backup.v1",(0,v.WG)(t));const i={algorithm:e.algorithm,auth_data:e.auth_data};await h(i.auth_data),await this.signObject(i.auth_data),o.addSessionBackup(i)}const S=await a.get("m.megolm_backup.v1");if(S){d.v.info("Got session backup key from secret storage: caching");const e=kt(S);if(e){const t=c||g;await a.store("m.megolm_backup.v1",e,t?[t]:null)}const t=new Uint8Array((0,v.y4)(e||S));o.addSessionBackupPrivateKeyToCache(t)}else if(this.backupManager.getKeyBackupEnabled()){const e=await this.getSessionBackupPrivateKey()||await(null==r?void 0:r());if(!e)return void d.v.error("Key backup is enabled but couldn't get key backup key!");d.v.info("Got session backup key from cache/user that wasn't in SSSS: saving to SSSS"),await a.store("m.megolm_backup.v1",(0,v.WG)(e))}const w=o.buildOperation();await w.apply(this),await o.persist(this),d.v.log("Secure Secret Storage ready")}async resetKeyBackup(){await this.backupManager.deleteAllKeyBackupVersions();const e=await this.backupManager.prepareKeyBackupVersion();await this.signObject(e.auth_data);const{version:t}=await this.baseApis.http.authedRequest(D.IT.Post,"/room_keys/version",void 0,e,{prefix:D.iD.V3});d.v.log(`Created backup version ${t}`);const i=e.privateKey;await this.secretStorage.store("m.megolm_backup.v1",(0,v.WG)(i)),await this.storeSessionBackupPrivateKey(i),await this.backupManager.checkAndStart(),await this.backupManager.scheduleAllGroupSessionsForBackup()}async deleteKeyBackupVersion(e){await this.backupManager.deleteKeyBackupVersion(e)}addSecretStorageKey(e,t,i){return this.secretStorage.addKey(e,t,i)}hasSecretStorageKey(e){return this.secretStorage.hasKey(e)}getSecretStorageKey(e){return this.secretStorage.getKey(e)}storeSecret(e,t,i){return this.secretStorage.store(e,t,i)}getSecret(e){return this.secretStorage.get(e)}isSecretStored(e){return this.secretStorage.isStored(e)}requestSecret(e,t){return t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(this.userId))),this.secretStorage.request(e,t)}getDefaultSecretStorageKeyId(){return this.secretStorage.getDefaultKeyId()}setDefaultSecretStorageKeyId(e){return this.secretStorage.setDefaultKeyId(e)}checkSecretStorageKey(e,t){return this.secretStorage.checkKey(e,t)}checkSecretStoragePrivateKey(e,t){let n=null;try{n=new i.g.Olm.PkDecryption;return n.init_with_private_key(e)===t}finally{var r;null===(r=n)||void 0===r||r.free()}}async getSessionBackupPrivateKey(){const e=await new Promise((e=>{this.cryptoStore.doTxn("readonly",[m.y.STORE_ACCOUNT],(t=>{this.cryptoStore.getSecretStorePrivateKey(t,e,"m.megolm_backup.v1")}))}));let t=null;if("string"==typeof e&&(t=new Uint8Array((0,v.y4)(kt(e)||e)),await this.storeSessionBackupPrivateKey(t)),e&&"object"==typeof e&&"ciphertext"in e){const i=yt.from(this.olmDevice.pickleKey),n=await(0,p.VK)(e,i,"m.megolm_backup.v1");t=(0,v.y4)(n)}return t}async storeSessionBackupPrivateKey(e,t){if(!(e instanceof Uint8Array))throw new Error(`storeSessionBackupPrivateKey expects Uint8Array, got ${e}`);const i=yt.from(this.olmDevice.pickleKey),n=await(0,p.r9)((0,v.WG)(e),i,"m.megolm_backup.v1");return this.cryptoStore.doTxn("readwrite",[m.y.STORE_ACCOUNT],(e=>{this.cryptoStore.storeSecretStorePrivateKey(e,"m.megolm_backup.v1",n)}))}async getActiveSessionBackupVersion(){var e;return this.backupManager.getKeyBackupEnabled()&&null!==(e=this.backupManager.version)&&void 0!==e?e:null}async isKeyBackupTrusted(e){const t=await this.backupManager.isKeyBackupTrusted(e);return(0,lt.IG)(t)}async checkKeyBackupAndEnable(){const e=await this.backupManager.checkKeyBackup();return e&&e.backupInfo?{backupInfo:e.backupInfo,trustInfo:(0,lt.IG)(e.trustInfo)}:null}checkCrossSigningPrivateKey(e,t){let n=null;try{n=new i.g.Olm.PkSigning;return n.init_with_seed(e)===t}finally{var r;null===(r=n)||void 0===r||r.free()}}async afterCrossSigningLocalKeyChange(){d.v.info("Starting cross-signing key change post-processing");const e=this.deviceList.getStoredDevice(this.userId,this.deviceId),t=await this.crossSigningInfo.signDevice(this.userId,e);d.v.info(`Starting background key sig upload for ${this.deviceId}`);const i=({shouldEmit:e=!1})=>this.baseApis.uploadKeySignatures({[this.userId]:{[this.deviceId]:t}}).then((t=>{const{failures:n}=t||{};if(Object.keys(n||[]).length>0)throw e&&this.baseApis.emit(Et.KeySignatureUploadFailure,n,"afterCrossSigningLocalKeyChange",i),new ct.b0("Key upload failed",{failures:n});d.v.info(`Finished background key sig upload for ${this.deviceId}`)})).catch((e=>{d.v.error(`Error during background key sig upload for ${this.deviceId}`,e)}));i({shouldEmit:!0});const n=this.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(n){d.v.info("Starting device verification upgrade");const e={};for(const[t,i]of Object.entries(this.deviceList.crossSigningInfo)){const n=await this.checkForDeviceVerificationUpgrade(t,b.fromStorage(i,t));n&&(e[t]=n)}if(Object.keys(e).length>0){d.v.info(`Found ${Object.keys(e).length} verif users to upgrade`);try{const t=await n({users:e});if(t)for(const i of t)i in e&&await this.baseApis.setDeviceVerified(i,e[i].crossSigningInfo.getId())}catch(e){d.v.log("shouldUpgradeDeviceVerifications threw an error: not upgrading",e)}}d.v.info("Finished device verification upgrade")}d.v.info("Finished cross-signing key change post-processing")}async checkForDeviceVerificationUpgrade(e,t){const i=this.crossSigningInfo.checkUserTrust(t);if(t.firstUse&&!i.isVerified()){const i=this.deviceList.getRawStoredDevicesForUser(e),n=await this.checkForValidDeviceSignature(e,t.keys.master,i);if(n.length)return{devices:n.map((e=>h.V.fromStorage(i[e],e))),crossSigningInfo:t}}}async checkForValidDeviceSignature(e,t,i){const n=[];if(i&&t.signatures&&t.signatures[e])for(const r of Object.keys(t.signatures[e])){const[,s]=r.split(":",2);if(s in i&&i[s].verified===St.VERIFIED)try{await u.verifySignature(this.olmDevice,t,e,s,i[s].keys[r]),n.push(s)}catch(e){}}return n}getCrossSigningKeyId(e=G.n.Master){return Promise.resolve(this.getCrossSigningId(e))}getCrossSigningId(e){return this.crossSigningInfo.getId(e)}getStoredCrossSigningForUser(e){return this.deviceList.getStoredCrossSigningForUser(e)}checkUserTrust(e){const t=this.deviceList.getStoredCrossSigningForUser(e);return t?this.crossSigningInfo.checkUserTrust(t):new g.UserVerificationStatus(!1,!1,!1)}async getUserVerificationStatus(e){return this.checkUserTrust(e)}async getDeviceVerificationStatus(e,t){const i=this.deviceList.getStoredDevice(e,t);return i?this.checkDeviceInfoTrust(e,i):null}checkDeviceTrust(e,t){const i=this.deviceList.getStoredDevice(e,t);return this.checkDeviceInfoTrust(e,i)}checkDeviceInfoTrust(e,t){const i=!(null==t||!t.isVerified()),n=this.deviceList.getStoredCrossSigningForUser(e);if(t&&n){const r=this.trustCrossSignedDevices||e===this.userId;return this.crossSigningInfo.checkDeviceTrust(n,t,i,r)}return new w(!1,!1,i,!1)}checkIfOwnDeviceCrossSigned(e){var t;const i=this.deviceList.getStoredDevice(this.userId,e);if(!i)return!1;const n=this.deviceList.getStoredCrossSigningForUser(this.userId);return null!==(t=null==n?void 0:n.checkDeviceTrust(n,i,!1,!0).isCrossSigningVerified())&&void 0!==t&&t}async checkOwnCrossSigningTrust({allowPrivateKeyRequests:e=!1}={}){const t=this.userId;await this.downloadKeys([this.userId]);const i=await this.crossSigningInfo.getCrossSigningKeysFromCache(),n=this.deviceList.getStoredCrossSigningForUser(t);if(!n)return void d.v.error("Got cross-signing update event for user "+t+" but no new cross-signing information found!");const r=n.getId(),s=this.crossSigningInfo.getId()!==r,o=n.getId()&&!i.has("master");if(s&&d.v.info("Got new master public key",r),e&&(s||o)){d.v.info("Attempting to retrieve cross-signing master private key");let e=null;try{e=(await this.crossSigningInfo.getCrossSigningKey("master",r))[1],d.v.info("Got cross-signing master private key")}finally{var a;null===(a=e)||void 0===a||a.free()}}const c=this.crossSigningInfo.getId("self_signing"),l=this.crossSigningInfo.getId("user_signing");this.storeTrustedSelfKeys(n.keys);const u=c!==n.getId("self_signing"),h=l!==n.getId("user_signing"),m=n.getId("self_signing")&&!i.has("self_signing"),p=n.getId("user_signing")&&!i.has("user_signing"),g={};if(u&&d.v.info("Got new self-signing key",n.getId("self_signing")),e&&(u||m)){d.v.info("Attempting to retrieve cross-signing self-signing private key");let e=null;try{e=(await this.crossSigningInfo.getCrossSigningKey("self_signing",n.getId("self_signing")))[1],d.v.info("Got cross-signing self-signing private key")}finally{var v;null===(v=e)||void 0===v||v.free()}const t=this.deviceList.getStoredDevice(this.userId,this.deviceId),i=await this.crossSigningInfo.signDevice(this.userId,t);g[this.deviceId]=i}if(h&&d.v.info("Got new user-signing key",n.getId("user_signing")),e&&(h||p)){d.v.info("Attempting to retrieve cross-signing user-signing private key");let e=null;try{e=(await this.crossSigningInfo.getCrossSigningKey("user_signing",n.getId("user_signing")))[1],d.v.info("Got cross-signing user-signing private key")}finally{var f;null===(f=e)||void 0===f||f.free()}}if(s){const e=this.crossSigningInfo.keys.master;await this.signObject(e);const t=e.signatures[this.userId]["ed25519:"+this.deviceId];g[this.crossSigningInfo.getId()]=Object.assign({},e,{signatures:{[this.userId]:{["ed25519:"+this.deviceId]:t}}})}const y=Object.keys(g);if(y.length){const e=({shouldEmit:t=!1})=>(d.v.info(`Starting background key sig upload for ${y}`),this.baseApis.uploadKeySignatures({[this.userId]:g}).then((i=>{const{failures:n}=i||{};if(d.v.info(`Finished background key sig upload for ${y}`),Object.keys(n||[]).length>0)throw t&&this.baseApis.emit(Et.KeySignatureUploadFailure,n,"checkOwnCrossSigningTrust",e),new ct.b0("Key upload failed",{failures:n})})).catch((e=>{d.v.error(`Error during background key sig upload for ${y}`,e)})));e({shouldEmit:!0})}this.emit(Et.UserTrustStatusChanged,t,this.checkUserTrust(t)),s&&(this.emit(Et.KeysChanged,{}),await this.afterCrossSigningLocalKeyChange()),await this.backupManager.checkKeyBackup()}async getBackupDecryptor(e,t){if(!(t instanceof Uint8Array))throw new Error("getBackupDecryptor expects Uint8Array");const i=await lt.IO.makeAlgorithm(e,(async()=>t));return await i.keyMatches(t)?new lt.M7(i):Promise.reject(new D.up({errcode:U.pB.RESTORE_BACKUP_ERROR_BAD_KEY}))}importBackedUpRoomKeys(e,t,i={}){return i.source="backup",this.importRoomKeys(e,i)}async storeTrustedSelfKeys(e){e?this.crossSigningInfo.setKeys(e):this.crossSigningInfo.clearKeys(),await this.cryptoStore.doTxn("readwrite",[m.y.STORE_ACCOUNT],(e=>{this.cryptoStore.storeCrossSigningKeys(e,this.crossSigningInfo.keys)}))}async checkDeviceVerifications(e){const t=this.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(t){if(d.v.info(`Starting device verification upgrade for ${e}`),this.crossSigningInfo.keys.user_signing){const i=this.deviceList.getStoredCrossSigningForUser(e);if(i){const n=await this.checkForDeviceVerificationUpgrade(e,i);if(n){(await t({users:{[e]:n}})).includes(e)&&await this.baseApis.setDeviceVerified(e,i.getId())}}}d.v.info(`Finished device verification upgrade for ${e}`)}}enableLazyLoading(){this.lazyLoadMembers=!0}registerEventHandlers(e){e.on(ht.o.Membership,this.onMembership),e.on(U.AU.ToDeviceEvent,this.onToDeviceEvent),e.on(ut.u9.Timeline,this.onTimelineEvent),e.on(j.OQ.Decrypted,this.onTimelineEvent)}start(){d.v.warn("MatrixClient.crypto.start() is deprecated")}stop(){this.outgoingRoomKeyRequestManager.stop(),this.deviceList.stop(),this.dehydrationManager.stop(),this.backupManager.stop()}getDeviceEd25519Key(){return this.olmDevice.deviceEd25519Key}getDeviceCurve25519Key(){return this.olmDevice.deviceCurve25519Key}async getOwnDeviceKeys(){if(!this.olmDevice.deviceCurve25519Key)throw new Error("Curve25519 key not yet created");if(!this.olmDevice.deviceEd25519Key)throw new Error("Ed25519 key not yet created");return{ed25519:this.olmDevice.deviceEd25519Key,curve25519:this.olmDevice.deviceCurve25519Key}}setGlobalBlacklistUnverifiedDevices(e){this.globalBlacklistUnverifiedDevices=e}getGlobalBlacklistUnverifiedDevices(){return this.globalBlacklistUnverifiedDevices}uploadDeviceKeys(){const e={algorithms:this.supportedAlgorithms,device_id:this.deviceId,keys:this.deviceKeys,user_id:this.userId};return this.signObject(e).then((()=>this.baseApis.uploadKeysRequest({device_keys:e})))}getNeedsNewFallback(){return!!this.needsNewFallback}maybeUploadOneTimeKeys(){if(this.oneTimeKeyCheckInProgress)return;const e=Date.now();if(null!==this.lastOneTimeKeyCheck&&e-this.lastOneTimeKeyCheck<6e4)return;this.lastOneTimeKeyCheck=e;const t=this.olmDevice.maxNumberOfOneTimeKeys(),i=Math.floor(t/2),n=async e=>{for(;i>e||this.getNeedsNewFallback();){if(i>e){d.v.info("generating oneTimeKeys");const t=Math.min(i-e,5);await this.olmDevice.generateOneTimeKeys(t)}if(this.getNeedsNewFallback()){const e=await this.olmDevice.getFallbackKey();e.curve25519&&0!=Object.keys(e.curve25519).length||(d.v.info("generating fallback key"),this.fallbackCleanup&&(clearTimeout(this.fallbackCleanup),delete this.fallbackCleanup),await this.olmDevice.generateFallbackKey())}d.v.info("calling uploadOneTimeKeys");const t=await this.uploadOneTimeKeys();if(!t.one_time_key_counts||!t.one_time_key_counts.signed_curve25519)throw new Error("response for uploading keys does not contain one_time_key_counts.signed_curve25519");e=t.one_time_key_counts.signed_curve25519}};this.oneTimeKeyCheckInProgress=!0,Promise.resolve().then((()=>void 0!==this.oneTimeKeyCount?Promise.resolve(this.oneTimeKeyCount):this.baseApis.uploadKeysRequest({}).then((e=>e.one_time_key_counts.signed_curve25519||0)))).then((e=>n(e))).catch((e=>{d.v.error("Error uploading one-time keys",e.stack||e)})).finally((()=>{this.oneTimeKeyCount=void 0,this.oneTimeKeyCheckInProgress=!1}))}async uploadOneTimeKeys(){const e=[];let t;if(this.getNeedsNewFallback()){t={};const i=await this.olmDevice.getFallbackKey();for(const[n,r]of Object.entries(i.curve25519)){const i={key:r,fallback:!0};t["signed_curve25519:"+n]=i,e.push(this.signObject(i))}this.needsNewFallback=!1}const i=await this.olmDevice.getOneTimeKeys(),n={};for(const t in i.curve25519)if(i.curve25519.hasOwnProperty(t)){const r={key:i.curve25519[t]};n["signed_curve25519:"+t]=r,e.push(this.signObject(r))}await Promise.all(e);const r={one_time_keys:n};t&&(r["org.matrix.msc2732.fallback_keys"]=t,r.fallback_keys=t);const s=await this.baseApis.uploadKeysRequest(r);return t&&(this.fallbackCleanup=setTimeout((()=>{delete this.fallbackCleanup,this.olmDevice.forgetOldFallbackKey()}),36e5)),await this.olmDevice.markKeysAsPublished(),s}downloadKeys(e,t){return this.deviceList.downloadKeys(e,!!t)}getStoredDevicesForUser(e){return this.deviceList.getStoredDevicesForUser(e)}async getUserDeviceInfo(e,t=!1){const i=new Map,n=[];for(const t of e){const e=await this.getStoredDevicesForUser(t);if(e){const n=new Map(e.map((e=>[e.deviceId,vt(e,t)])));i.set(t,n)}else n.push(t)}if(t&&n.length>0){(await this.downloadKeys(n)).forEach(((e,t)=>{const n=new Map;e.forEach(((e,i)=>n.set(i,vt(e,t)))),i.set(t,n)}))}return i}getStoredDevice(e,t){return this.deviceList.getStoredDevice(e,t)}saveDeviceList(e){return this.deviceList.saveIfDirty(e)}async setDeviceVerified(e,t,i=!0){await this.setDeviceVerification(e,t,i)}async crossSignDevice(e){await this.setDeviceVerified(this.userId,e,!0)}async setDeviceVerification(e,t,i=null,n=null,r=null,s){const o=this.deviceList.getStoredCrossSigningForUser(e);if((null==o?void 0:o.getId())===t){if(null!==n||null!==r)throw new Error("Cannot set blocked or known for a cross-signing key");if(!i)throw new Error("Cannot set a cross-signing key as unverified");const a=s?Object.values(s)[0]:null;if(s&&(1!==Object.values(s).length||a!==o.getId()))throw new Error(`Key did not match expected value: expected ${o.getId()}, got ${a}`);if(this.crossSigningInfo.getId()||e!==this.crossSigningInfo.userId||(this.storeTrustedSelfKeys(o.keys),this.emit(Et.UserTrustStatusChanged,this.userId,this.checkUserTrust(e))),e!==this.userId){d.v.info("Master key "+o.getId()+" for "+e+" marked verified. Signing...");const i=await this.crossSigningInfo.signUser(o);if(i){const n=async({shouldEmit:r=!1})=>{d.v.info("Uploading signature for "+e+"...");const s=await this.baseApis.uploadKeySignatures({[e]:{[t]:i}}),{failures:o}=s||{};if(Object.keys(o||[]).length>0)throw r&&this.baseApis.emit(Et.KeySignatureUploadFailure,o,"setDeviceVerification",n),new ct.b0("Key upload failed",{failures:o})};await n({shouldEmit:!0})}return i}return o}const a=this.deviceList.getRawStoredDevicesForUser(e);if(!a||!a[t])throw new Error("Unknown device "+e+":"+t);const c=a[t];let l=c.verified;if(i){if(s)for(const[e,t]of Object.entries(s))if(c.keys[e]!==t)throw new Error(`Key did not match expected value: expected ${t}, got ${c.keys[e]}`);l=St.VERIFIED}else null!==i&&l==St.VERIFIED&&(l=St.UNVERIFIED);n?l=St.BLOCKED:null!==n&&l==St.BLOCKED&&(l=St.UNVERIFIED);let u=c.known;if(null!==r&&(u=r),c.verified===l&&c.known===u||(c.verified=l,c.known=u,this.deviceList.storeDevicesForUser(e,a),this.deviceList.saveIfDirty()),i&&e===this.userId){let i;d.v.info("Own device "+t+" marked verified: signing");if(this.checkDeviceTrust(e,t).isCrossSigningVerified()?d.v.log(`Own device ${t} already cross-signing verified`):i=await this.crossSigningInfo.signDevice(e,h.V.fromStorage(c,t)),i){const n=async({shouldEmit:r=!1})=>{d.v.info("Uploading signature for "+t);const s=await this.baseApis.uploadKeySignatures({[e]:{[t]:i}}),{failures:o}=s||{};if(Object.keys(o||[]).length>0)throw r&&this.baseApis.emit(Et.KeySignatureUploadFailure,o,"setDeviceVerification",n),new ct.b0("Key upload failed",{failures:o})};await n({shouldEmit:!0})}}const m=h.V.fromStorage(c,t);return this.emit(Et.DeviceVerificationChanged,e,t,m),m}findVerificationRequestDMInProgress(e,t){return this.inRoomVerificationRequests.findRequestInProgress(e,t)}getVerificationRequestsToDeviceInProgress(e){return this.toDeviceVerificationRequests.getRequestsInProgress(e)}requestVerificationDM(e,t){const i=this.inRoomVerificationRequests.findRequestInProgress(t);if(i)return Promise.resolve(i);const n=new it(this.baseApis,t,e);return this.requestVerificationWithChannel(e,n,this.inRoomVerificationRequests)}requestVerification(e,t){t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(e)));const i=this.toDeviceVerificationRequests.findRequestInProgress(e,t);if(i)return Promise.resolve(i);const n=new st(this.baseApis,e,t,st.makeTransactionId());return this.requestVerificationWithChannel(e,n,this.toDeviceVerificationRequests)}requestOwnUserVerification(){return this.requestVerification(this.userId)}requestDeviceVerification(e,t){return this.requestVerification(e,[t])}async requestVerificationWithChannel(e,t,i){let n=new Xe(t,this.verificationMethods,this.baseApis);t.transactionId&&i.setRequestByChannel(t,n),await n.sendRequest();const r=i.getRequestByChannel(t);return r?n=r:(d.v.log(`Crypto: adding new request to requestsByTxnId with id ${t.transactionId} ${t.roomId}`),i.setRequestByChannel(t,n)),n}beginKeyVerification(e,t,i,n=null){let r;if(n){if(r=this.toDeviceVerificationRequests.getRequestBySenderAndTxnId(t,n),!r)throw new Error(`No request found for user ${t} with transactionId ${n}`)}else{n=st.makeTransactionId();const e=new st(this.baseApis,t,[i],n,i);r=new Xe(e,this.verificationMethods,this.baseApis),this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(t,n,r)}return r.beginKeyVerification(e,{userId:t,deviceId:i})}async legacyDeviceVerification(e,t,i){const n=st.makeTransactionId(),r=new st(this.baseApis,e,[t],n,t),s=new Xe(r,this.verificationMethods,this.baseApis);this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(e,n,s);const o=s.beginKeyVerification(i,{userId:e,deviceId:t});return await Promise.race([o.verify(),s.waitFor((e=>e.started))]),s}async getOlmSessionsForUser(e){const t=this.getStoredDevicesForUser(e)||[],i={};for(const e of t){const t=e.getIdentityKey(),n=await this.olmDevice.getSessionInfoForDevice(t);i[e.deviceId]={deviceIdKey:t,sessions:n}}return i}getEventSenderDeviceInfo(e){const t=e.getSenderKey(),i=e.getWireContent().algorithm;if(!t||!i)return null;if(e.isKeySourceUntrusted())return null;const n=this.deviceList.getDeviceByIdentityKey(i,t);if(null===n)return null;const r=e.getClaimedEd25519Key();return r?r!==n.getFingerprint()?(d.v.warn("Event "+e.getId()+" claims ed25519 key "+r+" but sender device has key "+n.getFingerprint()),null):n:(d.v.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),null)}getEventEncryptionInfo(e){var t,i;const n={};if(n.senderKey=null!==(t=e.getSenderKey())&&void 0!==t?t:void 0,n.algorithm=e.getWireContent().algorithm,!n.senderKey||!n.algorithm)return n.encrypted=!1,n;n.encrypted=!0,e.isKeySourceUntrusted()?n.authenticated=!1:n.authenticated=!0,n.sender=null!==(i=this.deviceList.getDeviceByIdentityKey(n.algorithm,n.senderKey))&&void 0!==i?i:void 0;const r=e.getClaimedEd25519Key();return r||(d.v.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),n.mismatchedSender=!0),n.sender&&r!==n.sender.getFingerprint()&&(d.v.warn("Event "+e.getId()+" claims ed25519 key "+r+"but sender device has key "+n.sender.getFingerprint()),n.mismatchedSender=!0),n}async getEncryptionInfoForEvent(e){const t=this.getEventEncryptionInfo(e);if(!t.encrypted)return null;const i=e.getSender();if(!i||t.mismatchedSender)return{shieldColour:g.EventShieldColour.RED,shieldReason:g.EventShieldReason.MISMATCHED_SENDER_KEY};if(!this.checkUserTrust(i).isCrossSigningVerified())return t.authenticated?{shieldColour:g.EventShieldColour.NONE,shieldReason:null}:{shieldColour:g.EventShieldColour.GREY,shieldReason:g.EventShieldReason.AUTHENTICITY_NOT_GUARANTEED};const n=i&&t.sender&&await this.getDeviceVerificationStatus(i,t.sender.deviceId);return n?n.isVerified()?t.authenticated?{shieldColour:g.EventShieldColour.NONE,shieldReason:null}:{shieldColour:g.EventShieldColour.GREY,shieldReason:g.EventShieldReason.AUTHENTICITY_NOT_GUARANTEED}:{shieldColour:g.EventShieldColour.RED,shieldReason:g.EventShieldReason.UNSIGNED_DEVICE}:{shieldColour:g.EventShieldColour.GREY,shieldReason:g.EventShieldReason.UNKNOWN_DEVICE}}forceDiscardSession(e){const t=this.roomEncryptors.get(e);if(void 0===t)throw new Error("Room not encrypted");if(void 0===t.forceDiscardSession)throw new Error("Room encryption algorithm doesn't support session discarding");return t.forceDiscardSession(),Promise.resolve()}async setRoomEncryption(e,t,i){const n=this.clientStore.getRoom(e);if(!n)throw new Error(`Unable to enable encryption tracking devices in unknown room ${e}`);await this.setRoomEncryptionImpl(n,t),this.lazyLoadMembers||i||this.deviceList.refreshOutdatedDeviceLists()}async setRoomEncryptionImpl(e,t){const i=e.roomId;if(!t.algorithm)return void d.v.log("Ignoring setRoomEncryption with no algorithm");const n=this.roomList.getRoomEncryption(i);if(n&&JSON.stringify(n)!=JSON.stringify(t))return void d.v.error("Ignoring m.room.encryption event which requests a change of config in "+i);if(this.roomEncryptors.get(i))return;let r=null;n||(r=this.roomList.setRoomEncryption(i,t));const s=A.l1.get(t.algorithm);if(!s)throw new Error("Unable to encrypt with "+t.algorithm);const o=new s({userId:this.userId,deviceId:this.deviceId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:i,config:t});if(this.roomEncryptors.set(i,o),r&&await r,d.v.log(`Enabling encryption in ${i}`),e.membersLoaded())await this.trackRoomDevicesImpl(e);else{const t=n=>{e.off(pt.f.Update,t),e.membersLoaded()&&this.trackRoomDevicesImpl(e).catch((e=>{d.v.error(`Error enabling device tracking in ${i}`,e)}))};e.on(pt.f.Update,t)}}trackRoomDevices(e){const t=this.clientStore.getRoom(e);if(!t)throw new Error(`Unable to start tracking devices in unknown room ${e}`);return this.trackRoomDevicesImpl(t)}trackRoomDevicesImpl(e){const t=e.roomId,i=async()=>{if(!this.roomEncryptors.has(t))return;d.v.log(`Starting to track devices for room ${t} ...`);(await e.getEncryptionTargetMembers()).forEach((e=>{this.deviceList.startTrackingDeviceList(e.userId)}))};let n=this.roomDeviceTrackingState[t];return n||(n=i(),this.roomDeviceTrackingState[t]=n.catch((e=>{throw delete this.roomDeviceTrackingState[t],e}))),n}ensureOlmSessionsForUsers(e,t){const i=new Map;for(const t of e){const e=[];i.set(t,e);const n=this.getStoredDevicesForUser(t)||[];for(const t of n){t.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&(t.verified!=St.BLOCKED&&e.push(t))}}return u.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,i,t)}async exportRoomKeys(){const e=[];return await this.cryptoStore.doTxn("readonly",[m.y.STORE_INBOUND_GROUP_SESSIONS],(t=>{this.cryptoStore.getAllEndToEndInboundGroupSessions(t,(t=>{if(null===t)return;const i=this.olmDevice.exportInboundGroupSession(t.senderKey,t.sessionId,t.sessionData);delete i.first_known_index,i.algorithm=u.MEGOLM_ALGORITHM,e.push(i)}))})),e}async exportRoomKeysAsJson(){return JSON.stringify(await this.exportRoomKeys())}importRoomKeys(e,t={}){let i=0,n=0;const r=e.length;function s(){var e;null===(e=t.progressCallback)||void 0===e||e.call(t,{stage:"load_keys",successes:i,failures:n,total:r})}return Promise.all(e.map((e=>{if(!e.room_id||!e.algorithm)return d.v.warn("ignoring room key entry with missing fields",e),n++,t.progressCallback&&s(),null;return this.getRoomDecryptor(e.room_id,e.algorithm).importRoomKey(e,t).finally((()=>{i++,t.progressCallback&&s()}))}))).then()}async importRoomKeysAsJson(e,t){return await this.importRoomKeys(JSON.parse(e))}countSessionsNeedingBackup(){return this.backupManager.countSessionsNeedingBackup()}prepareToEncrypt(e){const t=this.roomEncryptors.get(e.roomId);t&&t.prepareToEncrypt(e)}async encryptEvent(e,t){const i=e.getRoomId(),n=this.roomEncryptors.get(i);if(!n)throw new Error("Room "+i+" was previously configured to use encryption, but is no longer. Perhaps the homeserver is hiding the configuration event.");await this.trackRoomDevicesImpl(t);let r=e.getContent();const s=r["m.relates_to"];s&&(r=Object.assign({},r),delete r["m.relates_to"]);const o=r["io.element.performance_metrics"];o&&(r=Object.assign({},r),delete r["io.element.performance_metrics"]);const a=await n.encryptMessage(t,e.getType(),r);s&&(a["m.relates_to"]=s),o&&(a["io.element.performance_metrics"]=o),e.makeEncrypted("m.room.encrypted",a,this.olmDevice.deviceCurve25519Key,this.olmDevice.deviceEd25519Key)}async decryptEvent(e){if(e.isRedacted()){const t=new j.kl(function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?bt(Object(i),!0).forEach((function(t){(0,n.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):bt(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({room_id:e.getRoomId()},e.getUnsigned().redacted_because));let i=e.getUnsigned().redacted_because;if(t.isEncrypted())try{i=(await this.decryptEvent(t)).clearEvent}catch(e){d.v.warn("Decryption of redaction failed. Falling back to unencrypted event.",e)}return{clearEvent:{room_id:e.getRoomId(),type:"m.room.message",content:{},unsigned:{redacted_because:i}}}}{const t=e.getWireContent();return this.getRoomDecryptor(e.getRoomId(),t.algorithm).decryptEvent(e)}}async processDeviceLists(e){await this.evalDeviceListChanges(e)}requestRoomKey(e,t,i=!1){return this.outgoingRoomKeyRequestManager.queueRoomKeyRequest(e,t,i).then((()=>{this.sendKeyRequestsImmediately&&this.outgoingRoomKeyRequestManager.sendQueuedRequests()})).catch((e=>{d.v.error("Error requesting key for event",e)}))}cancelRoomKeyRequest(e){this.outgoingRoomKeyRequestManager.cancelRoomKeyRequest(e).catch((e=>{d.v.warn("Error clearing pending room key requests",e)}))}async cancelAndResendAllOutgoingKeyRequests(){await this.outgoingRoomKeyRequestManager.cancelAndResendAllOutgoingRequests()}async onCryptoEvent(e,t){const i=t.getContent();await this.setRoomEncryptionImpl(e,i)}async onSyncWillProcess(e){e.oldSyncToken||(d.v.log("Initial sync performed - resetting device tracking state"),this.deviceList.stopTrackingAllDeviceLists(),this.deviceList.startTrackingDeviceList(this.userId),this.roomDeviceTrackingState={}),this.sendKeyRequestsImmediately=!1}async onSyncCompleted(e){var t;this.deviceList.setSyncToken(null!==(t=e.nextSyncToken)&&void 0!==t?t:null),this.deviceList.saveIfDirty(),this.deviceList.startTrackingDeviceList(this.userId),this.deviceList.refreshOutdatedDeviceLists(),e.catchingUp||(this.maybeUploadOneTimeKeys(),this.processReceivedRoomKeyRequests(),this.outgoingRoomKeyRequestManager.sendQueuedRequests(),this.sendKeyRequestsImmediately=!0)}async evalDeviceListChanges(e){if(Array.isArray(null==e?void 0:e.changed)&&e.changed.forEach((e=>{this.deviceList.invalidateUserDeviceList(e)})),Array.isArray(null==e?void 0:e.left)&&e.left.length){const t=new Set(await this.getTrackedE2eUsers());e.left.forEach((e=>{t.has(e)||this.deviceList.stopTrackingDeviceList(e)}))}}async getTrackedE2eUsers(){const e=[];for(const t of this.getTrackedE2eRooms()){const i=await t.getEncryptionTargetMembers();for(const t of i)e.push(t.userId)}return e}getTrackedE2eRooms(){return this.clientStore.getRooms().filter((e=>{if(!this.roomEncryptors.get(e.roomId))return!1;if(!this.roomDeviceTrackingState[e.roomId])return!1;const t=e.getMyMembership();return t===ft.O.Join||t===ft.O.Invite}))}async encryptAndSendToDevices(e,t){const i={eventType:a.Bx.RoomMessageEncrypted,batch:[]};try{await Promise.all(e.map((async({userId:e,deviceInfo:n})=>{const r=n.deviceId,s={algorithm:u.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[a.wt]:(0,o.A)()};i.batch.push({userId:e,deviceId:r,payload:s}),await u.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[e,[n]]])),await u.encryptMessageForDevice(s.ciphertext,this.userId,this.deviceId,this.olmDevice,e,n,t)}))),i.batch=i.batch.filter((e=>Object.keys(e.payload.ciphertext).length>0||(d.v.log(`No ciphertext for device ${e.userId}:${e.deviceId}: pruning`),!1)));try{await this.baseApis.queueToDevice(i)}catch(e){throw d.v.error("sendToDevice failed",e),e}}catch(e){throw d.v.error("encryptAndSendToDevices promises failed",e),e}}async preprocessToDeviceMessages(e){return e.filter((e=>{var t;return!(e.type===a.Bx.RoomMessageEncrypted&&!["m.olm.v1.curve25519-aes-sha2"].includes(null===(t=e.content)||void 0===t?void 0:t.algorithm))||(d.v.log("Ignoring invalid encrypted to-device event from "+e.sender),!1)}))}updateOneTimeKeyCount(e){if(!isFinite(e))throw new TypeError("Parameter for updateOneTimeKeyCount has to be a number");this.oneTimeKeyCount=e}processKeyCounts(e,t){return void 0!==e&&this.updateOneTimeKeyCount(e.signed_curve25519||0),void 0!==t&&(this.needsNewFallback=!t.includes("signed_curve25519")),Promise.resolve()}onRoomKeyEvent(e){const t=e.getContent();if(!t.room_id||!t.algorithm)return void d.v.error("key event is missing fields");this.backupManager.checkedForBackup||this.backupManager.checkAndStart();this.getRoomDecryptor(t.room_id,t.algorithm).onRoomKeyEvent(e)}onRoomKeyWithheldEvent(e){const t=e.getContent();if(!(("m.no_olm"===t.code||t.room_id&&t.session_id)&&t.algorithm&&t.sender_key))return void d.v.error("key withheld event is missing fields");d.v.info(`Got room key withheld event from ${e.getSender()} for ${t.algorithm} session ${t.sender_key}|${t.session_id} in room ${t.room_id} with code ${t.code} (${t.reason})`);const i=this.getRoomDecryptor(t.room_id,t.algorithm);if(i.onRoomKeyWithheldEvent&&i.onRoomKeyWithheldEvent(e),!t.room_id){const e=this.getRoomDecryptors(t.algorithm);for(const i of e)i.retryDecryptionFromSender(t.sender_key)}}onKeyVerificationMessage(e){if(!st.validateEvent(e,this.baseApis))return;this.handleVerificationEvent(e,this.toDeviceVerificationRequests,(e=>{if(!st.canCreateRequest(st.getEventType(e)))return;const t=e.getContent(),i=t&&t.from_device;if(!i)return;const n=e.getSender(),r=new st(this.baseApis,n,[i]);return new Xe(r,this.verificationMethods,this.baseApis)}))}async handleVerificationEvent(e,t,i,n=!0){if(e.isSending()&&e.status!=j.fb.SENT){let t,i;try{await new Promise(((n,r)=>{t=n,i=()=>{e.status==j.fb.CANCELLED&&r(new Error("Event status set to CANCELLED."))},e.once(j.OQ.LocalEventIdReplaced,t),e.on(j.OQ.Status,i)}))}catch(e){return void d.v.error("error while waiting for the verification event to be sent: ",e)}finally{e.removeListener(j.OQ.LocalEventIdReplaced,t),e.removeListener(j.OQ.Status,i)}}let r=t.getRequest(e),s=!1;if(!r){if(r=i(e),!r)return void d.v.log(`Crypto: could not find VerificationRequest for ${e.getType()}, and could not create one, so ignoring.`);s=!0,t.setRequest(e,r)}e.setVerificationRequest(r);try{await r.channel.handleEvent(e,r,n)}catch(e){d.v.error("error while handling verification event",e)}s&&!r.initiatedByMe&&!r.invalid&&!r.observeOnly&&(this.baseApis.emit(Et.VerificationRequest,r),this.baseApis.emit(Et.VerificationRequestReceived,r))}async onToDeviceBadEncrypted(e){const t=e.getWireContent(),i=e.getSender(),n=t.algorithm,r=t.sender_key;this.baseApis.emit(U.AU.UndecryptableToDeviceEvent,e);const s=()=>{const e=this.getRoomDecryptors(u.MEGOLM_ALGORITHM);for(const t of e)t.retryDecryptionFromSender(r)};if(void 0===i||void 0===r||void 0===r)return;const c=this.forceNewSessionRetryTime.getOrCreate(i),l=c.getOrCreate(r);if(l>Date.now())return d.v.debug(`New session already forced with device ${i}:${r}: not forcing another until at least ${new Date(l).toUTCString()}`),await this.olmDevice.recordSessionProblem(r,"wedged",!0),void s();c.set(r,Date.now()+3e5);let h=this.deviceList.getDeviceByIdentityKey(n,r);if(!h&&(await this.downloadKeys([i],!1),h=this.deviceList.getDeviceByIdentityKey(n,r),!h))return d.v.info("Couldn't find device for identity key "+r+": not re-establishing session"),await this.olmDevice.recordSessionProblem(r,"wedged",!1),void s();const m=new Map([[i,[h]]]);await u.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,m,!0),c.set(r,Date.now()+36e5);const p={algorithm:u.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[a.wt]:(0,o.A)()};await u.encryptMessageForDevice(p.ciphertext,this.userId,this.deviceId,this.olmDevice,i,h,{type:"m.dummy"}),await this.olmDevice.recordSessionProblem(r,"wedged",!0),s(),await this.baseApis.sendToDevice("m.room.encrypted",new Map([[i,new Map([[h.deviceId,p]])]]));const g=await this.outgoingRoomKeyRequestManager.getOutgoingSentRoomKeyRequest(i,h.deviceId);for(const e of g)this.requestRoomKey(e.requestBody,e.recipients,!0)}onRoomMembership(e,t,i){const n=t.roomId,r=this.roomEncryptors.get(n);if(r){var s;if(n in this.roomDeviceTrackingState)t.membership==ft.O.Join?(d.v.log("Join event for "+t.userId+" in "+n),this.deviceList.startTrackingDeviceList(t.userId)):t.membership==ft.O.Invite&&null!==(s=this.clientStore.getRoom(n))&&void 0!==s&&s.shouldEncryptForInvitedMembers()&&(d.v.log("Invite event for "+t.userId+" in "+n),this.deviceList.startTrackingDeviceList(t.userId));r.onRoomMembership(e,t,i)}}onRoomKeyRequestEvent(e){const t=e.getContent();if("request"===t.action){const t=new Rt(e);this.receivedRoomKeyRequests.push(t)}else if("request_cancellation"===t.action){const t=new Tt(e);this.receivedRoomKeyRequestCancellations.push(t)}}async processReceivedRoomKeyRequests(){if(!this.processingRoomKeyRequests){this.processingRoomKeyRequests=!0;try{const e=this.receivedRoomKeyRequests;this.receivedRoomKeyRequests=[];const t=this.receivedRoomKeyRequestCancellations;this.receivedRoomKeyRequestCancellations=[],await Promise.all(e.map((e=>this.processReceivedRoomKeyRequest(e)))),await Promise.all(t.map((e=>this.processReceivedRoomKeyRequestCancellation(e))))}catch(e){d.v.error(`Error processing room key requsts: ${e}`)}finally{this.processingRoomKeyRequests=!1}}}async processReceivedRoomKeyRequest(e){const t=e.userId,i=e.deviceId,n=e.requestBody,r=n.room_id,s=n.algorithm;if(d.v.log(`m.room_key_request from ${t}:${i} for ${r} / ${n.session_id} (id ${e.requestId})`),t!==this.userId){if(!this.roomEncryptors.get(r))return void d.v.debug(`room key request for unencrypted room ${r}`);const e=this.roomEncryptors.get(r),s=this.deviceList.getStoredDevice(t,i);if(!s)return void d.v.debug(`Ignoring keyshare for unknown device ${t}:${i}`);try{await e.reshareKeyWithDevice(n.sender_key,n.session_id,t,s)}catch(e){d.v.warn("Failed to re-share keys for session "+n.session_id+" with device "+t+":"+s.deviceId,e)}return}if(i===this.deviceId)return void d.v.log("Ignoring room key request from ourselves");if(!this.roomDecryptors.has(r))return void d.v.log(`room key request for unencrypted room ${r}`);const o=this.roomDecryptors.get(r).get(s);if(o)if(await o.hasKeysForKeyRequest(e)){if(e.share=()=>{o.shareKeysWithDevice(e)},this.checkDeviceTrust(t,i).isVerified())return d.v.log("device is already verified: sharing keys"),void e.share();this.emit(Et.RoomKeyRequest,e)}else d.v.log(`room key request for unknown session ${r} / `+n.session_id);else d.v.log(`room key request for unknown alg ${s} in room ${r}`)}async processReceivedRoomKeyRequestCancellation(e){d.v.log(`m.room_key_request cancellation for ${e.userId}:${e.deviceId} (id ${e.requestId})`),this.emit(Et.RoomKeyRequestCancellation,e)}getRoomDecryptor(e,t){let i,n;if(e&&(i=this.roomDecryptors.get(e),i||(i=new Map,this.roomDecryptors.set(e,i)),n=i.get(t),n))return n;const r=A.Jn.get(t);if(!r)throw new O.O(g.DecryptionFailureCode.UNKNOWN_ENCRYPTION_ALGORITHM,'Unknown encryption algorithm "'+t+'".');return n=new r({userId:this.userId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:null!=e?e:void 0}),i&&i.set(t,n),n}getRoomDecryptors(e){const t=[];for(const i of this.roomDecryptors.values())i.has(e)&&t.push(i.get(e));return t}async signObject(e){const t=new Map(Object.entries(e.signatures||{})),i=e.unsigned;delete e.signatures,delete e.unsigned;const n=t.get(this.userId)||{};t.set(this.userId,n),n["ed25519:"+this.deviceId]=await this.olmDevice.sign(s().stringify(e)),e.signatures=(0,E.HF)(t),void 0!==i&&(e.unsigned=i)}isRoomEncrypted(e){return this.roomList.isRoomEncrypted(e)}async isEncryptionEnabledInRoom(e){return this.isRoomEncrypted(e)}getRoomEncryption(e){return this.roomList.getRoomEncryption(e)}async isDehydrationSupported(){return!1}async startDehydration(e){throw new Error("Not implemented")}}function kt(e){if("string"!=typeof e||e.indexOf(",")<0)return null;const t=Uint8Array.from(e.split(","),(e=>parseInt(e)));return(0,v.WG)(t)}class Rt{constructor(e){(0,n.A)(this,"userId",void 0),(0,n.A)(this,"deviceId",void 0),(0,n.A)(this,"requestId",void 0),(0,n.A)(this,"requestBody",void 0),(0,n.A)(this,"share",void 0);const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id,this.requestBody=t.body||{},this.share=()=>{throw new Error("don't know how to share keys for this request yet")}}}class Tt{constructor(e){(0,n.A)(this,"userId",void 0),(0,n.A)(this,"deviceId",void 0),(0,n.A)(this,"requestId",void 0);const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id}}},"./node_modules/matrix-js-sdk/src/crypto/key_passphrase.ts":(e,t,i)=>{"use strict";i.d(t,{SM:()=>c,cE:()=>a});var n=i("./node_modules/matrix-js-sdk/src/randomstring.ts"),r=i("./node_modules/matrix-js-sdk/src/crypto/crypto.ts");const s=5e5,o=256;function a(e,t){if(!i.g.Olm)throw new Error("Olm is not available");if(!e.private_key_salt||!e.private_key_iterations)throw new Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");return d(t,e.private_key_salt,e.private_key_iterations,e.private_key_bits||o)}async function c(e){if(!i.g.Olm)throw new Error("Olm is not available");const t=(0,n.DU)(32);return{key:await d(e,t,s,o),salt:t,iterations:s}}async function d(e,t,i,n=o){if(!r.n1||!r._3)throw new Error("Password-based backup is not available on this platform");const s=await r.n1.importKey("raw",(new r._3).encode(e),{name:"PBKDF2"},!1,["deriveBits"]),a=await r.n1.deriveBits({name:"PBKDF2",salt:(new r._3).encode(t),iterations:i,hash:"SHA-512"},s,n);return new Uint8Array(a)}},"./node_modules/matrix-js-sdk/src/crypto/olmlib.ts":(e,t,i)=>{"use strict";i.r(t),i.d(t,{MEGOLM_ALGORITHM:()=>h,MEGOLM_BACKUP_ALGORITHM:()=>m,OLM_ALGORITHM:()=>u,encryptMessageForDevice:()=>p,ensureOlmSessionsForDevices:()=>v,getExistingOlmSessions:()=>g,isOlmEncrypted:()=>w,pkSign:()=>b,pkVerify:()=>S,verifySignature:()=>y});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/another-json/another-json.js"),s=i.n(r),o=i("./node_modules/matrix-js-sdk/src/logger.ts"),a=i("./node_modules/matrix-js-sdk/src/@types/event.ts"),c=i("./node_modules/matrix-js-sdk/src/utils.ts");function d(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}var l=function(e){return e.Olm="m.olm.v1.curve25519-aes-sha2",e.Megolm="m.megolm.v1.aes-sha2",e.MegolmBackup="m.megolm_backup.v1.curve25519-aes-sha2",e}(l||{});const u=l.Olm,h=l.Megolm,m=l.MegolmBackup;async function p(e,t,i,r,s,a,c){const l=a.getIdentityKey(),u=await r.getSessionIdForDevice(l);if(null===u)return void o.v.log(`[olmlib.encryptMessageForDevice] Unable to find Olm session for device ${s}:${a.deviceId}`);o.v.log(`[olmlib.encryptMessageForDevice] Using Olm session ${u} for device ${s}:${a.deviceId}`);const h=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?d(Object(i),!0).forEach((function(t){(0,n.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):d(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({sender:t,sender_device:i,keys:{ed25519:r.deviceEd25519Key},recipient:s,recipient_keys:{ed25519:a.getFingerprint()}},c);e[l]=await r.encryptMessage(l,u,JSON.stringify(h))}async function g(e,t,i){const n=new c.kG((()=>[])),r=new c.kG((()=>new Map)),s=[];for(const[t,o]of Object.entries(i))for(const i of o){const o=i.deviceId,a=i.getIdentityKey();s.push((async()=>{const s=await e.getSessionIdForDevice(a,!0);null===s?n.getOrCreate(t).push(i):r.getOrCreate(t).set(o,{device:i,sessionId:s})})())}return await Promise.all(s),[n,r]}async function v(e,t,i,n=!1,r,s,a=o.v){const c=[],d=new Map,l=new Map;for(const t of i.values())for(const i of t){const t=i.getIdentityKey();t!==e.deviceCurve25519Key&&(e.sessionsInProgress[t]||(e.sessionsInProgress[t]=new Promise((i=>{l.set(t,(n=>{delete e.sessionsInProgress[t],i(n)}))}))))}for(const[t,r]of i){const i=new Map;d.set(t,i);for(const s of r){const r=s.deviceId,o=s.getIdentityKey();if(o===e.deviceCurve25519Key){a.info("Attempted to start session with ourself! Ignoring"),i.set(r,{device:s,sessionId:null});continue}const d=`for ${o} (${t}:${r})`,u=await e.getSessionIdForDevice(o,!!l.get(o),a),h=l.get(o);null!==u&&h&&h(),(null===u||n)&&(n?a.info(`Forcing new Olm session ${d}`):a.info(`Making new Olm session ${d}`),c.push([t,r])),i.set(r,{device:s,sessionId:u})}}if(0===c.length)return d;const u="signed_curve25519";let h,m=`one-time keys for ${c.length} devices`;try{a.debug(`Claiming ${m}`),h=await t.claimOneTimeKeys(c,u,r),a.debug(`Claimed ${m}`)}catch(e){for(const e of l.values())e();throw a.debug(`Failed to claim ${m}`,e,c),e}s&&"failures"in h&&s.push(...Object.keys(h.failures));const p=h.one_time_keys||{},g=[];for(const[t,r]of i){const i=p[t]||{};for(const s of r){var v,y;const r=s.deviceId,o=s.getIdentityKey();if(o===e.deviceCurve25519Key)continue;if(null!==(v=d.get(t))&&void 0!==v&&null!==(y=v.get(r))&&void 0!==y&&y.sessionId&&!n)continue;const c=i[r]||{};let h=null;for(const e in c)0===e.indexOf(u+":")&&(h=c[e]);var b;if(h)g.push(f(e,h,t,s).then((e=>{var i,n;null===(i=l.get(o))||void 0===i||i(null!=e?e:void 0);const s=null===(n=d.get(t))||void 0===n?void 0:n.get(r);s&&(s.sessionId=e)}),(e=>{var t;throw null===(t=l.get(o))||void 0===t||t(),e})));else a.warn(`No one-time keys (alg=${u}) for device ${t}:${r}`),null===(b=l.get(o))||void 0===b||b()}}return m=`Olm sessions for ${g.length} devices`,a.debug(`Starting ${m}`),await Promise.all(g),a.debug(`Started ${m}`),d}async function f(e,t,i,n){const r=n.deviceId;try{await y(e,t,i,r,n.getFingerprint())}catch(e){return o.v.error("Unable to verify signature on one-time key for device "+i+":"+r+":",e),null}let s;try{s=await e.createOutboundSession(n.getIdentityKey(),t.key)}catch(e){return o.v.error("Error starting olm session with device "+i+":"+r+": "+e),null}return o.v.log("Started new olm sessionid "+s+" for device "+i+":"+r),s}async function y(e,t,i,n,r){const o="ed25519:"+n,a=((t.signatures||{})[i]||{})[o];if(!a)throw Error("No signature");const c=Object.assign({},t);"unsigned"in c&&delete c.unsigned,delete c.signatures;const d=s().stringify(c);e.verifySignature(r,d,a)}function b(e,t,n,r){let o=!1;if(t instanceof Uint8Array){const e=new i.g.Olm.PkSigning;r=e.init_with_seed(t),t=e,o=!0}const a=e.signatures||{};delete e.signatures;const c=e.unsigned;e.unsigned&&delete e.unsigned;try{const i=a[n]||{};return a[n]=i,i["ed25519:"+r]=t.sign(s().stringify(e))}finally{e.signatures=a,c&&(e.unsigned=c),o&&t.free()}}function S(e,t,n){const r="ed25519:"+t;if(!(e.signatures&&e.signatures[n]&&e.signatures[n][r]))throw new Error("No signature");const o=e.signatures[n][r],a=new i.g.Olm.Utility,c=e.signatures;delete e.signatures;const d=e.unsigned;e.unsigned&&delete e.unsigned;try{a.ed25519_verify(t,s().stringify(e),o)}finally{e.signatures=c,d&&(e.unsigned=d),a.free()}}function w(e){return e.getSenderKey()?!(e.getWireType()!==a.Bx.RoomMessageEncrypted||!["m.olm.v1.curve25519-aes-sha2"].includes(e.getWireContent().algorithm))||(o.v.error("Event was not encrypted using an appropriate algorithm"),!1):(o.v.error("Event has no sender key (not encrypted?)"),!1)}},"./node_modules/matrix-js-sdk/src/crypto/recoverykey.ts":(e,t,i)=>{"use strict";i.d(t,{R:()=>c,j:()=>a});var n=i("./node_modules/bs58/index.js"),r=i("./node_modules/buffer/index.js").hp;const s=[139,1],o=32;function a(e){var t;const i=r.alloc(s.length+e.length+1);i.set(s,0),i.set(e,s.length);let o=0;for(let e=0;e<i.length-1;++e)o^=i[e];i[i.length-1]=o;return null===(t=n.encode(i).match(/.{1,4}/g))||void 0===t?void 0:t.join(" ")}function c(e){const t=n.decode(e.replace(/ /g,""));let i=0;for(const e of t)i^=e;if(0!==i)throw new Error("Incorrect parity");for(let e=0;e<s.length;++e)if(t[e]!==s[e])throw new Error("Incorrect prefix");if(t.length!==s.length+o+1)throw new Error("Incorrect length");return Uint8Array.from(t.slice(s.length,s.length+o))}},"./node_modules/matrix-js-sdk/src/crypto/store/base.ts":(e,t,i)=>{"use strict";i.d(t,{Il:()=>r,Nv:()=>n,oT:()=>s});const n="migrationState";let r=function(e){return e[e.NOT_STARTED=0]="NOT_STARTED",e[e.INITIAL_DATA_MIGRATED=1]="INITIAL_DATA_MIGRATED",e[e.OLM_SESSIONS_MIGRATED=2]="OLM_SESSIONS_MIGRATED",e[e.MEGOLM_SESSIONS_MIGRATED=3]="MEGOLM_SESSIONS_MIGRATED",e[e.ROOM_SETTINGS_MIGRATED=4]="ROOM_SETTINGS_MIGRATED",e[e.INITIAL_OWN_KEY_QUERY_DONE=5]="INITIAL_OWN_KEY_QUERY_DONE",e}({});const s=50},"./node_modules/matrix-js-sdk/src/crypto/store/indexeddb-crypto-store.ts":(e,t,i)=>{"use strict";i.d(t,{y:()=>v});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/logger.ts"),s=i("./node_modules/matrix-js-sdk/src/crypto/store/localStorage-crypto-store.ts"),o=i("./node_modules/matrix-js-sdk/src/crypto/store/memory-crypto-store.ts"),a=i("./node_modules/matrix-js-sdk/src/utils.ts"),c=i("./node_modules/matrix-js-sdk/src/crypto/store/base.ts");class d{constructor(e){this.db=e,(0,n.A)(this,"nextTxnId",0),e.onversionchange=()=>{r.v.log(`versionchange for indexeddb ${this.db.name}: closing`),e.close()}}async containsData(){throw Error("Not implemented for Backend")}async startup(){return this}async deleteAllData(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")}async getMigrationState(){let e=c.Il.NOT_STARTED;return await this.doTxn("readonly",[v.STORE_ACCOUNT],(t=>{const i=t.objectStore(v.STORE_ACCOUNT).get(c.Nv);i.onsuccess=()=>{var t;e=null!==(t=i.result)&&void 0!==t?t:c.Il.NOT_STARTED}})),e}async setMigrationState(e){await this.doTxn("readwrite",[v.STORE_ACCOUNT],(t=>{t.objectStore(v.STORE_ACCOUNT).put(e,c.Nv)}))}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return new Promise(((i,n)=>{const s=this.db.transaction("outgoingRoomKeyRequests","readwrite");s.onerror=n,this._getOutgoingRoomKeyRequest(s,t,(n=>{if(n)return r.v.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),void i(n);r.v.log(`enqueueing key request for ${t.room_id} / `+t.session_id),s.oncomplete=()=>{i(e)};s.objectStore("outgoingRoomKeyRequests").add(e)}))}))}getOutgoingRoomKeyRequest(e){return new Promise(((t,i)=>{const n=this.db.transaction("outgoingRoomKeyRequests","readonly");n.onerror=i,this._getOutgoingRoomKeyRequest(n,e,(e=>{t(e)}))}))}_getOutgoingRoomKeyRequest(e,t,i){const n=e.objectStore("outgoingRoomKeyRequests").index("session").openCursor([t.room_id,t.session_id]);n.onsuccess=()=>{const e=n.result;if(!e)return void i(null);const r=e.value;(0,a.ky)(r.requestBody,t)?i(r):e.continue()}}getOutgoingRoomKeyRequestByState(e){if(0===e.length)return Promise.resolve(null);let t,i=0;const n=this.db.transaction("outgoingRoomKeyRequests","readonly"),r=n.objectStore("outgoingRoomKeyRequests"),s=e[i];return r.index("state").openCursor(s).onsuccess=function n(){const r=this.result;if(r)return void(t=r.value);if(i++,i>=e.length)return;const s=e[i];this.source.openCursor(s).onsuccess=n},m(n).then((()=>t))}getAllOutgoingRoomKeyRequestsByState(e){return new Promise(((t,i)=>{const n=this.db.transaction("outgoingRoomKeyRequests","readonly").objectStore("outgoingRoomKeyRequests").index("state").getAll(e);n.onsuccess=()=>t(n.result),n.onerror=()=>i(n.error)}))}getOutgoingRoomKeyRequestsByTarget(e,t,i){let n=0;const r=[];const s=this.db.transaction("outgoingRoomKeyRequests","readonly"),o=s.objectStore("outgoingRoomKeyRequests"),a=i[n];return o.index("state").openCursor(a).onsuccess=function s(){const o=this.result;if(o){const i=o.value;i.recipients.some((i=>i.userId===e&&i.deviceId===t))&&r.push(i),o.continue()}else{if(n++,n>=i.length)return;const e=i[n];this.source.openCursor(e).onsuccess=s}},m(s).then((()=>r))}updateOutgoingRoomKeyRequest(e,t,i){let n=null;const s=this.db.transaction("outgoingRoomKeyRequests","readwrite");return s.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=function(){const e=this.result;if(!e)return;const s=e.value;s.state==t?(Object.assign(s,i),e.update(s),n=s):r.v.warn(`Cannot update room key request from ${t} as it was already updated to ${s.state}`)},m(s).then((()=>n))}deleteOutgoingRoomKeyRequest(e,t){const i=this.db.transaction("outgoingRoomKeyRequests","readwrite"),n=i.objectStore("outgoingRoomKeyRequests").openCursor(e);return n.onsuccess=()=>{const e=n.result;if(!e)return;const i=e.value;i.state==t?e.delete():r.v.warn(`Cannot delete room key request in state ${i.state} (expected ${t})`)},m(i)}getAccount(e,t){const i=e.objectStore("account").get("-");i.onsuccess=function(){try{t(i.result||null)}catch(t){h(e,t)}}}storeAccount(e,t){e.objectStore("account").put(t,"-")}getCrossSigningKeys(e,t){const i=e.objectStore("account").get("crossSigningKeys");i.onsuccess=function(){try{t(i.result||null)}catch(t){h(e,t)}}}getSecretStorePrivateKey(e,t,i){const n=e.objectStore("account").get(`ssss_cache:${i}`);n.onsuccess=function(){try{t(n.result||null)}catch(t){h(e,t)}}}storeCrossSigningKeys(e,t){e.objectStore("account").put(t,"crossSigningKeys")}storeSecretStorePrivateKey(e,t,i){e.objectStore("account").put(i,`ssss_cache:${t}`)}countEndToEndSessions(e,t){const i=e.objectStore("sessions").count();i.onsuccess=function(){try{t(i.result)}catch(t){h(e,t)}}}getEndToEndSessions(e,t,i){const n=t.objectStore("sessions").index("deviceKey").openCursor(e),r={};n.onsuccess=function(){const e=n.result;if(e)r[e.value.sessionId]={session:e.value.session,lastReceivedMessageTs:e.value.lastReceivedMessageTs},e.continue();else try{i(r)}catch(e){h(t,e)}}}getEndToEndSession(e,t,i,n){const r=i.objectStore("sessions").get([e,t]);r.onsuccess=function(){try{r.result?n({session:r.result.session,lastReceivedMessageTs:r.result.lastReceivedMessageTs}):n(null)}catch(e){h(i,e)}}}getAllEndToEndSessions(e,t){const i=e.objectStore("sessions").openCursor();i.onsuccess=function(){try{const e=i.result;e?(t(e.value),e.continue()):t(null)}catch(t){h(e,t)}}}storeEndToEndSession(e,t,i,n){n.objectStore("sessions").put({deviceKey:e,sessionId:t,session:i.session,lastReceivedMessageTs:i.lastReceivedMessageTs})}async storeEndToEndSessionProblem(e,t,i){const n=this.db.transaction("session_problems","readwrite");n.objectStore("session_problems").put({deviceKey:e,type:t,fixed:i,time:Date.now()}),await m(n)}async getEndToEndSessionProblem(e,t){let i=null;const n=this.db.transaction("session_problems","readwrite"),r=n.objectStore("session_problems").index("deviceKey").getAll(e);return r.onsuccess=()=>{const e=r.result;if(!e.length)return void(i=null);e.sort(((e,t)=>e.time-t.time));const n=e[e.length-1];for(const r of e)if(r.time>t)return void(i=Object.assign({},r,{fixed:n.fixed}));i=n.fixed?null:n},await m(n),i}async filterOutNotifiedErrorDevices(e){const t=this.db.transaction("notified_error_devices","readwrite").objectStore("notified_error_devices"),i=[];return await Promise.all(e.map((e=>new Promise((n=>{const{userId:r,deviceInfo:s}=e,o=t.get([r,s.deviceId]);o.onsuccess=function(){o.result||(t.put({userId:r,deviceId:s.deviceId}),i.push(e)),n()}}))))),i}async getEndToEndSessionsBatch(){const e=[];return await this.doTxn("readonly",[v.STORE_SESSIONS],(t=>{const i=t.objectStore(v.STORE_SESSIONS).openCursor();i.onsuccess=function(){try{const t=i.result;t&&(e.push(t.value),e.length<c.oT&&t.continue())}catch(e){h(t,e)}}})),0===e.length?null:e}async deleteEndToEndSessionsBatch(e){await this.doTxn("readwrite",[v.STORE_SESSIONS],(async t=>{try{const i=t.objectStore(v.STORE_SESSIONS);for(const{deviceKey:t,sessionId:n}of e){const e=i.delete([t,n]);await new Promise((t=>{e.onsuccess=t}))}}catch(e){h(t,e)}}))}getEndToEndInboundGroupSession(e,t,i,n){let r=!1,s=!1;const o=i.objectStore("inbound_group_sessions").get([e,t]);o.onsuccess=function(){try{r=o.result?o.result.session:null,!1!==s&&n(r,s)}catch(e){h(i,e)}};const a=i.objectStore("inbound_group_sessions_withheld").get([e,t]);a.onsuccess=function(){try{s=a.result?a.result.session:null,!1!==r&&n(r,s)}catch(e){h(i,e)}}}getAllEndToEndInboundGroupSessions(e,t){const i=e.objectStore("inbound_group_sessions").openCursor();i.onsuccess=function(){const n=i.result;if(n){try{t({senderKey:n.value.senderCurve25519Key,sessionId:n.value.sessionId,sessionData:n.value.session})}catch(t){h(e,t)}n.continue()}else try{t(null)}catch(t){h(e,t)}}}addEndToEndInboundGroupSession(e,t,i,n){const s=n.objectStore("inbound_group_sessions").add({senderCurve25519Key:e,sessionId:t,session:i});s.onerror=i=>{var o;"ConstraintError"===(null===(o=s.error)||void 0===o?void 0:o.name)?(i.stopPropagation(),i.preventDefault(),r.v.log("Ignoring duplicate inbound group session: "+e+" / "+t)):h(n,new Error("Failed to add inbound group session: "+s.error))}}storeEndToEndInboundGroupSession(e,t,i,n){n.objectStore("inbound_group_sessions").put({senderCurve25519Key:e,sessionId:t,session:i})}storeEndToEndInboundGroupSessionWithheld(e,t,i,n){n.objectStore("inbound_group_sessions_withheld").put({senderCurve25519Key:e,sessionId:t,session:i})}async countEndToEndInboundGroupSessions(){let e=0;return await this.doTxn("readonly",[v.STORE_INBOUND_GROUP_SESSIONS],(t=>{const i=t.objectStore(v.STORE_INBOUND_GROUP_SESSIONS).count();i.onsuccess=()=>{e=i.result}})),e}async getEndToEndInboundGroupSessionsBatch(){const e=[];return await this.doTxn("readonly",[v.STORE_INBOUND_GROUP_SESSIONS,v.STORE_BACKUP],(t=>{const i=t.objectStore(v.STORE_INBOUND_GROUP_SESSIONS),n=t.objectStore(v.STORE_BACKUP),r=i.openCursor();r.onsuccess=function(){try{const t=r.result;if(t){const i=n.get(t.key);i.onsuccess=()=>{e.push({senderKey:t.value.senderCurve25519Key,sessionId:t.value.sessionId,sessionData:t.value.session,needsBackup:void 0!==i.result}),e.length<c.oT&&t.continue()}}}catch(e){h(t,e)}}})),0===e.length?null:e}async deleteEndToEndInboundGroupSessionsBatch(e){await this.doTxn("readwrite",[v.STORE_INBOUND_GROUP_SESSIONS],(async t=>{try{const i=t.objectStore(v.STORE_INBOUND_GROUP_SESSIONS);for(const{senderKey:t,sessionId:n}of e){const e=i.delete([t,n]);await new Promise((t=>{e.onsuccess=t}))}}catch(e){h(t,e)}}))}getEndToEndDeviceData(e,t){const i=e.objectStore("device_data").get("-");i.onsuccess=function(){try{t(i.result||null)}catch(t){h(e,t)}}}storeEndToEndDeviceData(e,t){t.objectStore("device_data").put(e,"-")}storeEndToEndRoom(e,t,i){i.objectStore("rooms").put(t,e)}getEndToEndRooms(e,t){const i={},n=e.objectStore("rooms").openCursor();n.onsuccess=function(){const r=n.result;if(r)i[r.key]=r.value,r.continue();else try{t(i)}catch(t){h(e,t)}}}getSessionsNeedingBackup(e){return new Promise(((t,i)=>{const n=[],r=this.db.transaction(["sessions_needing_backup","inbound_group_sessions"],"readonly");r.onerror=i,r.oncomplete=function(){t(n)};const s=r.objectStore("sessions_needing_backup"),o=r.objectStore("inbound_group_sessions"),a=s.openCursor();a.onsuccess=function(){const t=a.result;if(t){const i=o.get(t.key);i.onsuccess=function(){n.push({senderKey:i.result.senderCurve25519Key,sessionId:i.result.sessionId,sessionData:i.result.session})},(!e||n.length<e)&&t.continue()}}}))}countSessionsNeedingBackup(e){e||(e=this.db.transaction("sessions_needing_backup","readonly"));const t=e.objectStore("sessions_needing_backup");return new Promise(((e,i)=>{const n=t.count();n.onerror=i,n.onsuccess=()=>e(n.result)}))}async unmarkSessionsNeedingBackup(e,t){t||(t=this.db.transaction("sessions_needing_backup","readwrite"));const i=t.objectStore("sessions_needing_backup");await Promise.all(e.map((e=>new Promise(((t,n)=>{const r=i.delete([e.senderKey,e.sessionId]);r.onsuccess=t,r.onerror=n})))))}async markSessionsNeedingBackup(e,t){t||(t=this.db.transaction("sessions_needing_backup","readwrite"));const i=t.objectStore("sessions_needing_backup");await Promise.all(e.map((e=>new Promise(((t,n)=>{const r=i.put({senderCurve25519Key:e.senderKey,sessionId:e.sessionId});r.onsuccess=t,r.onerror=n})))))}addSharedHistoryInboundGroupSession(e,t,i,n){n||(n=this.db.transaction("shared_history_inbound_group_sessions","readwrite"));const r=n.objectStore("shared_history_inbound_group_sessions"),s=r.get([e]);s.onsuccess=()=>{const{sessions:n}=s.result||{sessions:[]};n.push([t,i]),r.put({roomId:e,sessions:n})}}getSharedHistoryInboundGroupSessions(e,t){t||(t=this.db.transaction("shared_history_inbound_group_sessions","readonly"));const i=t.objectStore("shared_history_inbound_group_sessions").get([e]);return new Promise(((e,t)=>{i.onsuccess=()=>{const{sessions:t}=i.result||{sessions:[]};e(t)},i.onerror=t}))}addParkedSharedHistory(e,t,i){i||(i=this.db.transaction("parked_shared_history","readwrite"));const n=i.objectStore("parked_shared_history"),r=n.get([e]);r.onsuccess=()=>{const{parked:i}=r.result||{parked:[]};i.push(t),n.put({roomId:e,parked:i})}}takeParkedSharedHistory(e,t){t||(t=this.db.transaction("parked_shared_history","readwrite"));const i=t.objectStore("parked_shared_history").openCursor(e);return new Promise(((e,t)=>{i.onsuccess=()=>{const t=i.result;if(!t)return void e([]);const n=t.value;t.delete(),e(n)},i.onerror=t}))}doTxn(e,t,i,n=r.v){const s=this.db.transaction(t,e),o=m(s),a=i(s);return o.then((()=>a))}}const l=[e=>{!function(e){const t=e.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});t.createIndex("session",["requestBody.room_id","requestBody.session_id"]),t.createIndex("state","state")}(e)},e=>{e.createObjectStore("account")},e=>{e.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]}).createIndex("deviceKey","deviceKey")},e=>{e.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("device_data")},e=>{e.createObjectStore("rooms")},e=>{e.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("session_problems",{keyPath:["deviceKey","time"]}).createIndex("deviceKey","deviceKey"),e.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})},e=>{e.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})},e=>{e.createObjectStore("parked_shared_history",{keyPath:["roomId"]})}],u=l.length;function h(e,t){e._mx_abortexception=t;try{e.abort()}catch(t){}}function m(e){return new Promise(((t,i)=>{e.oncomplete=()=>{void 0!==e._mx_abortexception&&i(e._mx_abortexception),t(null)},e.onerror=t=>{void 0!==e._mx_abortexception?i(e._mx_abortexception):(r.v.log("Error performing indexeddb txn",t),i(e.error))},e.onabort=t=>{void 0!==e._mx_abortexception?i(e._mx_abortexception):(r.v.log("Error performing indexeddb txn",t),i(e.error))}}))}var p=i("./node_modules/matrix-js-sdk/src/errors.ts"),g=i("./node_modules/matrix-js-sdk/src/indexeddb-helpers.ts");class v{static exists(e,t){return g.t(e,t)}static existsAndIsNotMigrated(e,t){return new Promise(((i,n)=>{let r=!0;const s=e.open(t);s.onupgradeneeded=()=>{r=!1},s.onblocked=()=>n(s.error),s.onsuccess=()=>{const o=s.result;if(r){const e=o.transaction([v.STORE_ACCOUNT],"readonly").objectStore(v.STORE_ACCOUNT).get(c.Nv);e.onsuccess=()=>{var t;const n=null!==(t=e.result)&&void 0!==t?t:c.Il.NOT_STARTED;i(n===c.Il.NOT_STARTED)},e.onerror=()=>{n(e.error)},o.close()}else o.close(),e.deleteDatabase(t),i(!1)},s.onerror=()=>n(s.error)}))}constructor(e,t){this.indexedDB=e,this.dbName=t,(0,n.A)(this,"backendPromise",void 0),(0,n.A)(this,"backend",void 0)}async containsData(){return v.exists(this.indexedDB,this.dbName)}startup(){return this.backendPromise||(this.backendPromise=new Promise(((e,t)=>{if(!this.indexedDB)return void t(new Error("no indexeddb support available"));r.v.log(`connecting to indexeddb ${this.dbName}`);const i=this.indexedDB.open(this.dbName,u);i.onupgradeneeded=e=>{!function(e,t){r.v.log(`Upgrading IndexedDBCryptoStore from version ${t} to ${u}`),l.forEach(((i,n)=>{t<=n&&i(e)}))}(i.result,e.oldVersion)},i.onblocked=()=>{r.v.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},i.onerror=e=>{r.v.log("Error connecting to indexeddb",e),t(i.error)},i.onsuccess=()=>{const t=i.result;r.v.log(`connected to indexeddb ${this.dbName}`),e(new d(t))}})).then((e=>e.doTxn("readonly",[v.STORE_INBOUND_GROUP_SESSIONS,v.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(t=>{e.getEndToEndInboundGroupSession("","",t,(()=>{}))})).then((()=>e)))).catch((e=>{if("VersionError"===e.name)throw r.v.warn("Crypto DB is too new for us to use!",e),new p.E5(p.hP.TooNew);r.v.warn(`unable to connect to indexeddb ${this.dbName}: falling back to localStorage store: ${e}`);try{return new s.F(i.g.localStorage)}catch(e){return r.v.warn(`unable to open localStorage: falling back to in-memory store: ${e}`),new o._}})).then((e=>(this.backend=e,e)))),this.backendPromise}deleteAllData(){return new Promise(((e,t)=>{if(!this.indexedDB)return void t(new Error("no indexeddb support available"));r.v.log(`Removing indexeddb instance: ${this.dbName}`);const i=this.indexedDB.deleteDatabase(this.dbName);i.onblocked=()=>{r.v.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},i.onerror=e=>{r.v.log("Error deleting data from indexeddb",e),t(i.error)},i.onsuccess=()=>{r.v.log(`Removed indexeddb instance: ${this.dbName}`),e()}})).catch((e=>{r.v.warn(`unable to delete IndexedDBCryptoStore: ${e}`)}))}getMigrationState(){return this.backend.getMigrationState()}setMigrationState(e){return this.backend.setMigrationState(e)}getOrAddOutgoingRoomKeyRequest(e){return this.backend.getOrAddOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequest(e){return this.backend.getOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequestByState(e){return this.backend.getOutgoingRoomKeyRequestByState(e)}getAllOutgoingRoomKeyRequestsByState(e){return this.backend.getAllOutgoingRoomKeyRequestsByState(e)}getOutgoingRoomKeyRequestsByTarget(e,t,i){return this.backend.getOutgoingRoomKeyRequestsByTarget(e,t,i)}updateOutgoingRoomKeyRequest(e,t,i){return this.backend.updateOutgoingRoomKeyRequest(e,t,i)}deleteOutgoingRoomKeyRequest(e,t){return this.backend.deleteOutgoingRoomKeyRequest(e,t)}getAccount(e,t){this.backend.getAccount(e,t)}storeAccount(e,t){this.backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this.backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,i){this.backend.getSecretStorePrivateKey(e,t,i)}storeCrossSigningKeys(e,t){this.backend.storeCrossSigningKeys(e,t)}storeSecretStorePrivateKey(e,t,i){this.backend.storeSecretStorePrivateKey(e,t,i)}countEndToEndSessions(e,t){this.backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,i,n){this.backend.getEndToEndSession(e,t,i,n)}getEndToEndSessions(e,t,i){this.backend.getEndToEndSessions(e,t,i)}getAllEndToEndSessions(e,t){this.backend.getAllEndToEndSessions(e,t)}storeEndToEndSession(e,t,i,n){this.backend.storeEndToEndSession(e,t,i,n)}storeEndToEndSessionProblem(e,t,i){return this.backend.storeEndToEndSessionProblem(e,t,i)}getEndToEndSessionProblem(e,t){return this.backend.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.backend.filterOutNotifiedErrorDevices(e)}countEndToEndInboundGroupSessions(){return this.backend.countEndToEndInboundGroupSessions()}getEndToEndSessionsBatch(){return this.backend.getEndToEndSessionsBatch()}deleteEndToEndSessionsBatch(e){return this.backend.deleteEndToEndSessionsBatch(e)}getEndToEndInboundGroupSession(e,t,i,n){this.backend.getEndToEndInboundGroupSession(e,t,i,n)}getAllEndToEndInboundGroupSessions(e,t){this.backend.getAllEndToEndInboundGroupSessions(e,t)}addEndToEndInboundGroupSession(e,t,i,n){this.backend.addEndToEndInboundGroupSession(e,t,i,n)}storeEndToEndInboundGroupSession(e,t,i,n){this.backend.storeEndToEndInboundGroupSession(e,t,i,n)}storeEndToEndInboundGroupSessionWithheld(e,t,i,n){this.backend.storeEndToEndInboundGroupSessionWithheld(e,t,i,n)}getEndToEndInboundGroupSessionsBatch(){return this.backend.getEndToEndInboundGroupSessionsBatch()}deleteEndToEndInboundGroupSessionsBatch(e){return this.backend.deleteEndToEndInboundGroupSessionsBatch(e)}storeEndToEndDeviceData(e,t){this.backend.storeEndToEndDeviceData(e,t)}getEndToEndDeviceData(e,t){this.backend.getEndToEndDeviceData(e,t)}storeEndToEndRoom(e,t,i){this.backend.storeEndToEndRoom(e,t,i)}getEndToEndRooms(e,t){this.backend.getEndToEndRooms(e,t)}getSessionsNeedingBackup(e){return this.backend.getSessionsNeedingBackup(e)}countSessionsNeedingBackup(e){return this.backend.countSessionsNeedingBackup(e)}unmarkSessionsNeedingBackup(e,t){return this.backend.unmarkSessionsNeedingBackup(e,t)}markSessionsNeedingBackup(e,t){return this.backend.markSessionsNeedingBackup(e,t)}addSharedHistoryInboundGroupSession(e,t,i,n){this.backend.addSharedHistoryInboundGroupSession(e,t,i,n)}getSharedHistoryInboundGroupSessions(e,t){return this.backend.getSharedHistoryInboundGroupSessions(e,t)}addParkedSharedHistory(e,t,i){this.backend.addParkedSharedHistory(e,t,i)}takeParkedSharedHistory(e,t){return this.backend.takeParkedSharedHistory(e,t)}doTxn(e,t,i,n){return this.backend.doTxn(e,t,i,n)}}(0,n.A)(v,"STORE_ACCOUNT","account"),(0,n.A)(v,"STORE_SESSIONS","sessions"),(0,n.A)(v,"STORE_INBOUND_GROUP_SESSIONS","inbound_group_sessions"),(0,n.A)(v,"STORE_INBOUND_GROUP_SESSIONS_WITHHELD","inbound_group_sessions_withheld"),(0,n.A)(v,"STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS","shared_history_inbound_group_sessions"),(0,n.A)(v,"STORE_PARKED_SHARED_HISTORY","parked_shared_history"),(0,n.A)(v,"STORE_DEVICE_DATA","device_data"),(0,n.A)(v,"STORE_ROOMS","rooms"),(0,n.A)(v,"STORE_BACKUP","sessions_needing_backup")},"./node_modules/matrix-js-sdk/src/crypto/store/localStorage-crypto-store.ts":(e,t,i)=>{"use strict";i.d(t,{F:()=>_});var n=i("./node_modules/matrix-js-sdk/src/logger.ts"),r=i("./node_modules/matrix-js-sdk/src/crypto/store/memory-crypto-store.ts"),s=i("./node_modules/matrix-js-sdk/src/crypto/store/base.ts"),o=i("./node_modules/matrix-js-sdk/src/utils.ts");const a="crypto.",c=a+"migration",d=a+"account",l=a+"cross_signing_keys",u=a+"notified_error_devices",h=a+"device_data",m=a+"inboundgroupsessions/",p=a+"inboundgroupsessions.withheld/",g=a+"rooms/",v=a+"sessionsneedingbackup";function f(e){return a+"sessions/"+e}function y(e){return a+"session.problems/"+e}function b(e,t){return m+e+"/"+t}function S(e,t){return p+e+"/"+t}function w(e){return g+e}class _ extends r._{static exists(e){const t=e.length;for(let n=0;n<t;n++){var i;if(null!==(i=e.key(n))&&void 0!==i&&i.startsWith(a))return!0}return!1}constructor(e){super(),this.store=e}async containsData(){return _.exists(this.store)}async getMigrationState(){var e;return null!==(e=E(this.store,c))&&void 0!==e?e:s.Il.NOT_STARTED}async setMigrationState(e){I(this.store,c,e)}countEndToEndSessions(e,t){let i=0;for(let e=0;e<this.store.length;++e){const t=this.store.key(e);if(null!=t&&t.startsWith(f(""))){const e=E(this.store,t);i+=Object.keys(null!=e?e:{}).length}}t(i)}_getEndToEndSessions(e){const t=E(this.store,f(e)),i={};for(const[e,n]of Object.entries(t||{}))i[e]="string"==typeof n?{session:n}:n;return i}getEndToEndSession(e,t,i,n){n(this._getEndToEndSessions(e)[t]||{})}getEndToEndSessions(e,t,i){i(this._getEndToEndSessions(e)||{})}getAllEndToEndSessions(e,t){for(let e=0;e<this.store.length;++e){var i;if(null!==(i=this.store.key(e))&&void 0!==i&&i.startsWith(f(""))){const i=this.store.key(e).split("/")[1];for(const e of Object.values(this._getEndToEndSessions(i)))t(e)}}}storeEndToEndSession(e,t,i,n){const r=this._getEndToEndSessions(e)||{};r[t]=i,I(this.store,f(e),r)}async storeEndToEndSessionProblem(e,t,i){const n=y(e),r=E(this.store,n)||[];r.push({type:t,fixed:i,time:Date.now()}),r.sort(((e,t)=>e.time-t.time)),I(this.store,n,r)}async getEndToEndSessionProblem(e,t){const i=y(e),n=E(this.store,i)||[];if(!n.length)return null;const r=n[n.length-1];for(const e of n)if(e.time>t)return Object.assign({},e,{fixed:r.fixed});return r.fixed?null:r}async filterOutNotifiedErrorDevices(e){const t=E(this.store,u)||{},i=[];for(const n of e){const{userId:e,deviceInfo:r}=n;e in t?r.deviceId in t[e]||(i.push(n),(0,o.C6)(t[e],r.deviceId,!0)):(i.push(n),(0,o.C6)(t,e,{[r.deviceId]:!0}))}return I(this.store,u,t),i}async getEndToEndSessionsBatch(){const e=[];for(let i=0;i<this.store.length;++i){var t;if(null!==(t=this.store.key(i))&&void 0!==t&&t.startsWith(f(""))){const t=this.store.key(i).split("/")[1];for(const i of Object.values(this._getEndToEndSessions(t)))if(e.push(i),e.length>=s.oT)return e}}return 0===e.length?null:e}async deleteEndToEndSessionsBatch(e){for(const{deviceKey:t,sessionId:i}of e){const e=this._getEndToEndSessions(t)||{};delete e[i],0===Object.keys(e).length?this.store.removeItem(f(t)):I(this.store,f(t),e)}}getEndToEndInboundGroupSession(e,t,i,n){n(E(this.store,b(e,t)),E(this.store,S(e,t)))}getAllEndToEndInboundGroupSessions(e,t){for(let e=0;e<this.store.length;++e){const i=this.store.key(e);null!=i&&i.startsWith(m)&&t({senderKey:i.slice(28,71),sessionId:i.slice(72),sessionData:E(this.store,i)})}t(null)}addEndToEndInboundGroupSession(e,t,i,n){E(this.store,b(e,t))||this.storeEndToEndInboundGroupSession(e,t,i,n)}storeEndToEndInboundGroupSession(e,t,i,n){I(this.store,b(e,t),i)}storeEndToEndInboundGroupSessionWithheld(e,t,i,n){I(this.store,S(e,t),i)}async countEndToEndInboundGroupSessions(){let e=0;for(let t=0;t<this.store.length;++t){const i=this.store.key(t);null!=i&&i.startsWith(m)&&(e+=1)}return e}async getEndToEndInboundGroupSessionsBatch(){const e=E(this.store,v)||{},t=[];for(let i=0;i<this.store.length;++i){const n=this.store.key(i);if(null!=n&&n.startsWith(m)){const i=n.slice(28);if(t.push({senderKey:i.slice(0,43),sessionId:i.slice(44),sessionData:E(this.store,n),needsBackup:i in e}),t.length>=s.oT)return t}}return 0===t.length?null:t}async deleteEndToEndInboundGroupSessionsBatch(e){for(const{senderKey:t,sessionId:i}of e){const e=b(t,i);this.store.removeItem(e)}}getEndToEndDeviceData(e,t){t(E(this.store,h))}storeEndToEndDeviceData(e,t){I(this.store,h,e)}storeEndToEndRoom(e,t,i){I(this.store,w(e),t)}getEndToEndRooms(e,t){const i={},n=w("");for(let e=0;e<this.store.length;++e){const t=this.store.key(e);if(null!=t&&t.startsWith(n)){i[t.slice(n.length)]=E(this.store,t)}}t(i)}getSessionsNeedingBackup(e){const t=E(this.store,v)||{},i=[];for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)){const t=n.slice(0,43),r=n.slice(44);if(this.getEndToEndInboundGroupSession(t,r,null,(e=>{i.push({senderKey:t,sessionId:r,sessionData:e})})),e&&i.length>=e)break}return Promise.resolve(i)}countSessionsNeedingBackup(){const e=E(this.store,v)||{};return Promise.resolve(Object.keys(e).length)}unmarkSessionsNeedingBackup(e){const t=E(this.store,v)||{};for(const i of e)delete t[i.senderKey+"/"+i.sessionId];return I(this.store,v,t),Promise.resolve()}markSessionsNeedingBackup(e){const t=E(this.store,v)||{};for(const i of e)t[i.senderKey+"/"+i.sessionId]=!0;return I(this.store,v,t),Promise.resolve()}deleteAllData(){return this.store.removeItem(d),Promise.resolve()}getAccount(e,t){t(E(this.store,d))}storeAccount(e,t){I(this.store,d,t)}getCrossSigningKeys(e,t){t(E(this.store,l))}getSecretStorePrivateKey(e,t,i){t(E(this.store,a+`ssss_cache.${i}`))}storeCrossSigningKeys(e,t){I(this.store,l,t)}storeSecretStorePrivateKey(e,t,i){I(this.store,a+`ssss_cache.${t}`,i)}doTxn(e,t,i){return Promise.resolve(i(null))}}function E(e,t){try{return JSON.parse(e.getItem(t))}catch(e){n.v.log("Error: Failed to get key %s: %s",t,e.message),n.v.log(e.stack)}return null}function I(e,t,i){e.setItem(t,JSON.stringify(i))}},"./node_modules/matrix-js-sdk/src/crypto/store/memory-crypto-store.ts":(e,t,i)=>{"use strict";i.d(t,{_:()=>u});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/logger.ts"),s=i("./node_modules/matrix-js-sdk/src/utils.ts"),o=i("./node_modules/matrix-js-sdk/src/crypto/store/base.ts");function a(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function c(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?a(Object(i),!0).forEach((function(t){(0,n.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):a(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function d(e,t){return encodeURIComponent(e)+"/"+encodeURIComponent(t)}function l(e){const t=e.split("/");return{senderKey:decodeURIComponent(t[0]),sessionId:decodeURIComponent(t[1])}}class u{constructor(){(0,n.A)(this,"migrationState",o.Il.NOT_STARTED),(0,n.A)(this,"outgoingRoomKeyRequests",[]),(0,n.A)(this,"account",null),(0,n.A)(this,"crossSigningKeys",null),(0,n.A)(this,"privateKeys",{}),(0,n.A)(this,"sessions",{}),(0,n.A)(this,"sessionProblems",{}),(0,n.A)(this,"notifiedErrorDevices",{}),(0,n.A)(this,"inboundGroupSessions",{}),(0,n.A)(this,"inboundGroupSessionsWithheld",{}),(0,n.A)(this,"deviceData",null),(0,n.A)(this,"rooms",{}),(0,n.A)(this,"sessionsNeedingBackup",{}),(0,n.A)(this,"sharedHistoryInboundGroupSessions",{}),(0,n.A)(this,"parkedSharedHistory",new Map)}async containsData(){return null!==this.account}async startup(){return this}deleteAllData(){return Promise.resolve()}async getMigrationState(){return this.migrationState}async setMigrationState(e){this.migrationState=e}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return(0,s.j0)((()=>{const i=this._getOutgoingRoomKeyRequest(t);return i?(r.v.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),i):(r.v.log(`enqueueing key request for ${t.room_id} / `+t.session_id),this.outgoingRoomKeyRequests.push(e),e)}))}getOutgoingRoomKeyRequest(e){return Promise.resolve(this._getOutgoingRoomKeyRequest(e))}_getOutgoingRoomKeyRequest(e){for(const t of this.outgoingRoomKeyRequests)if((0,s.ky)(t.requestBody,e))return t;return null}getOutgoingRoomKeyRequestByState(e){for(const t of this.outgoingRoomKeyRequests)for(const i of e)if(t.state===i)return Promise.resolve(t);return Promise.resolve(null)}getAllOutgoingRoomKeyRequestsByState(e){return Promise.resolve(this.outgoingRoomKeyRequests.filter((t=>t.state==e)))}getOutgoingRoomKeyRequestsByTarget(e,t,i){const n=[];for(const r of this.outgoingRoomKeyRequests)for(const s of i)r.state===s&&r.recipients.some((i=>i.userId===e&&i.deviceId===t))&&n.push(r);return Promise.resolve(n)}updateOutgoingRoomKeyRequest(e,t,i){for(const n of this.outgoingRoomKeyRequests)if(n.requestId===e)return n.state!==t?(r.v.warn(`Cannot update room key request from ${t} as it was already updated to ${n.state}`),Promise.resolve(null)):(Object.assign(n,i),Promise.resolve(n));return Promise.resolve(null)}deleteOutgoingRoomKeyRequest(e,t){for(let i=0;i<this.outgoingRoomKeyRequests.length;i++){const n=this.outgoingRoomKeyRequests[i];if(n.requestId===e)return n.state!=t?(r.v.warn(`Cannot delete room key request in state ${n.state} (expected ${t})`),Promise.resolve(null)):(this.outgoingRoomKeyRequests.splice(i,1),Promise.resolve(n))}return Promise.resolve(null)}getAccount(e,t){t(this.account)}storeAccount(e,t){this.account=t}getCrossSigningKeys(e,t){t(this.crossSigningKeys)}getSecretStorePrivateKey(e,t,i){t(this.privateKeys[i]||null)}storeCrossSigningKeys(e,t){this.crossSigningKeys=t}storeSecretStorePrivateKey(e,t,i){this.privateKeys[t]=i}countEndToEndSessions(e,t){let i=0;for(const e of Object.values(this.sessions))i+=Object.keys(e).length;t(i)}getEndToEndSession(e,t,i,n){n((this.sessions[e]||{})[t]||null)}getEndToEndSessions(e,t,i){i(this.sessions[e]||{})}getAllEndToEndSessions(e,t){Object.entries(this.sessions).forEach((([e,i])=>{Object.entries(i).forEach((([i,n])=>{t(c(c({},n),{},{deviceKey:e,sessionId:i}))}))}))}storeEndToEndSession(e,t,i,n){let r=this.sessions[e];void 0===r&&(r={},this.sessions[e]=r),(0,s.C6)(r,t,i)}async storeEndToEndSessionProblem(e,t,i){const n=this.sessionProblems[e]=this.sessionProblems[e]||[];n.push({type:t,fixed:i,time:Date.now()}),n.sort(((e,t)=>e.time-t.time))}async getEndToEndSessionProblem(e,t){const i=this.sessionProblems[e]||[];if(!i.length)return null;const n=i[i.length-1];for(const e of i)if(e.time>t)return Object.assign({},e,{fixed:n.fixed});return n.fixed?null:n}async filterOutNotifiedErrorDevices(e){const t=this.notifiedErrorDevices,i=[];for(const n of e){const{userId:e,deviceInfo:r}=n;e in t?r.deviceId in t[e]||(i.push(n),(0,s.C6)(t[e],r.deviceId,!0)):(i.push(n),(0,s.C6)(t,e,{[r.deviceId]:!0}))}return i}async getEndToEndSessionsBatch(){const e=[];for(const t of Object.values(this.sessions))for(const i of Object.values(t))if(e.push(i),e.length>=o.oT)return e;return 0===e.length?null:e}async deleteEndToEndSessionsBatch(e){for(const{deviceKey:t,sessionId:i}of e){const e=this.sessions[t]||{};delete e[i],0===Object.keys(e).length&&delete this.sessions[t]}}getEndToEndInboundGroupSession(e,t,i,n){const r=d(e,t);n(this.inboundGroupSessions[r]||null,this.inboundGroupSessionsWithheld[r]||null)}getAllEndToEndInboundGroupSessions(e,t){for(const e of Object.keys(this.inboundGroupSessions))t(c(c({},l(e)),{},{sessionData:this.inboundGroupSessions[e]}));t(null)}addEndToEndInboundGroupSession(e,t,i,n){const r=d(e,t);void 0===this.inboundGroupSessions[r]&&(this.inboundGroupSessions[r]=i)}storeEndToEndInboundGroupSession(e,t,i,n){const r=d(e,t);this.inboundGroupSessions[r]=i}storeEndToEndInboundGroupSessionWithheld(e,t,i,n){const r=d(e,t);this.inboundGroupSessionsWithheld[r]=i}async countEndToEndInboundGroupSessions(){return Object.keys(this.inboundGroupSessions).length}async getEndToEndInboundGroupSessionsBatch(){const e=[];for(const[t,i]of Object.entries(this.inboundGroupSessions))if(e.push(c(c({},l(t)),{},{sessionData:i,needsBackup:t in this.sessionsNeedingBackup})),e.length>=o.oT)return e;return 0===e.length?null:e}async deleteEndToEndInboundGroupSessionsBatch(e){for(const{senderKey:t,sessionId:i}of e){const e=d(t,i);delete this.inboundGroupSessions[e]}}getEndToEndDeviceData(e,t){t(this.deviceData)}storeEndToEndDeviceData(e,t){this.deviceData=e}storeEndToEndRoom(e,t,i){this.rooms[e]=t}getEndToEndRooms(e,t){t(this.rooms)}getSessionsNeedingBackup(e){const t=[];for(const i in this.sessionsNeedingBackup)if(this.inboundGroupSessions[i]&&(t.push(c(c({},l(i)),{},{sessionData:this.inboundGroupSessions[i]})),e&&i.length>=e))break;return Promise.resolve(t)}countSessionsNeedingBackup(){return Promise.resolve(Object.keys(this.sessionsNeedingBackup).length)}unmarkSessionsNeedingBackup(e){for(const t of e){const e=d(t.senderKey,t.sessionId);delete this.sessionsNeedingBackup[e]}return Promise.resolve()}markSessionsNeedingBackup(e){for(const t of e){const e=d(t.senderKey,t.sessionId);this.sessionsNeedingBackup[e]=!0}return Promise.resolve()}addSharedHistoryInboundGroupSession(e,t,i){const n=this.sharedHistoryInboundGroupSessions[e]||[];n.push([t,i]),this.sharedHistoryInboundGroupSessions[e]=n}getSharedHistoryInboundGroupSessions(e){return Promise.resolve(this.sharedHistoryInboundGroupSessions[e]||[])}addParkedSharedHistory(e,t){var i;const n=null!==(i=this.parkedSharedHistory.get(e))&&void 0!==i?i:[];n.push(t),this.parkedSharedHistory.set(e,n)}takeParkedSharedHistory(e){var t;const i=null!==(t=this.parkedSharedHistory.get(e))&&void 0!==t?t:[];return this.parkedSharedHistory.delete(e),Promise.resolve(i)}doTxn(e,t,i){return Promise.resolve(i(null))}}},"./node_modules/matrix-js-sdk/src/crypto/verification/SASDecimal.ts":(e,t,i)=>{"use strict";function n(e){return[1e3+(e[0]<<5|e[1]>>3),1e3+((7&e[1])<<10|e[2]<<2|e[3]>>6),1e3+((63&e[3])<<7|e[4]>>1)]}i.d(t,{c:()=>n})},"./node_modules/matrix-js-sdk/src/errors.ts":(e,t,i)=>{"use strict";i.d(t,{E5:()=>s,LA:()=>a,b0:()=>o,hP:()=>r});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js");let r=function(e){return e.TooNew="TOO_NEW",e}({});class s extends Error{constructor(e){super(`Crypto store is invalid because ${e}, please stop the client, delete all data and start the client again`),this.reason=e,this.name="InvalidCryptoStoreError"}}(0,n.A)(s,"TOO_NEW",r.TooNew);class o extends Error{constructor(e,t){super(e),this.value=t}}class a extends Error{constructor(){super("MatrixClient has been stopped")}}},"./node_modules/matrix-js-sdk/src/extensible_events_v1/utilities.ts":(e,t,i)=>{"use strict";function n(e){return null!=e}i.d(t,{c:()=>n})},"./node_modules/matrix-js-sdk/src/feature.ts":(e,t,i)=>{"use strict";i.d(t,{Tj:()=>n,Xj:()=>r,yk:()=>o});let n=function(e){return e[e.Stable=0]="Stable",e[e.Unstable=1]="Unstable",e[e.Unsupported=2]="Unsupported",e}({}),r=function(e){return e.Thread="Thread",e.ThreadUnreadNotifications="ThreadUnreadNotifications",e.LoginTokenRequest="LoginTokenRequest",e.RelationBasedRedactions="RelationBasedRedactions",e.AccountDataDeletion="AccountDataDeletion",e.RelationsRecursion="RelationsRecursion",e.IntentionalMentions="IntentionalMentions",e}({});const s={[r.Thread]:{unstablePrefixes:["org.matrix.msc3440"],matrixVersion:"v1.3"},[r.ThreadUnreadNotifications]:{unstablePrefixes:["org.matrix.msc3771","org.matrix.msc3773"],matrixVersion:"v1.4"},[r.LoginTokenRequest]:{unstablePrefixes:["org.matrix.msc3882"]},[r.RelationBasedRedactions]:{unstablePrefixes:["org.matrix.msc3912"]},[r.AccountDataDeletion]:{unstablePrefixes:["org.matrix.msc3391"]},[r.RelationsRecursion]:{unstablePrefixes:["org.matrix.msc3981"]},[r.IntentionalMentions]:{unstablePrefixes:["org.matrix.msc3952_intentional_mentions"],matrixVersion:"v1.7"}};async function o(e){const t=new Map;for(const[c,d]of Object.entries(s)){var i,r,o,a;const s=null!==(i=null===(r=e.versions)||void 0===r?void 0:r.includes(d.matrixVersion||""))&&void 0!==i&&i,l=null!==(o=null===(a=d.unstablePrefixes)||void 0===a?void 0:a.every((t=>{var i;return!0===(null===(i=e.unstable_features)||void 0===i?void 0:i[t])})))&&void 0!==o&&o;s?t.set(c,n.Stable):l?t.set(c,n.Unstable):t.set(c,n.Unsupported)}return t}},"./node_modules/matrix-js-sdk/src/filter.ts":(e,t,i)=>{"use strict";i.d(t,{d:()=>l});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/@types/sync.ts"),s=i("./node_modules/matrix-js-sdk/src/models/thread.ts");class o{constructor(e,t){this.filterJson=e,this.userId=t}check(e){var t,i;const n=(null===(t=e.getUnsigned())||void 0===t?void 0:t["m.relations"])||{},r=Object.keys(n),o=[];return this.userId&&null!=n&&null!==(i=n[s.RN.name])&&void 0!==i&&i.current_user_participated&&o.push(this.userId),this.checkFields(e.getRoomId(),e.getSender(),e.getType(),!!e.getContent()&&void 0!==e.getContent().url,r,o)}toJSON(){return{types:this.filterJson.types||null,not_types:this.filterJson.not_types||[],rooms:this.filterJson.rooms||null,not_rooms:this.filterJson.not_rooms||[],senders:this.filterJson.senders||null,not_senders:this.filterJson.not_senders||[],contains_url:this.filterJson.contains_url||null,[s.o1.name]:this.filterJson[s.o1.name]||[],[s.H.name]:this.filterJson[s.H.name]||[]}}checkFields(e,t,i,n,r,o){const a={rooms:function(t){return e===t},senders:function(e){return t===e},types:function(e){return function(e,t){if(t.endsWith("*")){const i=t.slice(0,-1);return e.slice(0,i.length)===i}return e===t}(i,e)}};for(const e in a){const t=a[e],i="not_"+e,n=this.filterJson[i];if(null!=n&&n.some(t))return!1;const r=this.filterJson[e];if(r&&!r.some(t))return!1}const c=this.filterJson.contains_url;if(void 0!==c&&c!==n)return!1;const d=this.filterJson[s.H.name];if(void 0!==d&&!this.arrayMatchesFilter(d,r))return!1;const l=this.filterJson[s.o1.name];return!(void 0!==l&&!this.arrayMatchesFilter(l,o))}arrayMatchesFilter(e,t){return t.length>0&&e.every((e=>t.includes(e)))}filter(e){return e.filter(this.check,this)}limit(){return void 0!==this.filterJson.limit?this.filterJson.limit:10}}function a(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function c(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?a(Object(i),!0).forEach((function(t){(0,n.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):a(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function d(e,t,i){const n=t.split(".");let r=e;for(let e=0;e<n.length-1;e++)r[n[e]]||(r[n[e]]={}),r=r[n[e]];r[n[n.length-1]]=i}class l{static fromJson(e,t,i){const n=new l(e,t);return n.setDefinition(i),n}constructor(e,t){this.userId=e,this.filterId=t,(0,n.A)(this,"definition",{}),(0,n.A)(this,"roomFilter",void 0),(0,n.A)(this,"roomTimelineFilter",void 0)}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(e){this.definition=e;const t=e.room,i={};t&&(t.rooms&&(i.rooms=t.rooms),t.rooms&&(i.not_rooms=t.not_rooms)),this.roomFilter=new o(i,this.userId),this.roomTimelineFilter=new o((null==t?void 0:t.timeline)||{},this.userId)}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(e){return this.roomFilter&&(e=this.roomFilter.filter(e)),this.roomTimelineFilter&&(e=this.roomTimelineFilter.filter(e)),e}setTimelineLimit(e){d(this.definition,"room.timeline.limit",e)}setUnreadThreadNotifications(e){var t,i,n;this.definition=c(c({},this.definition),{},{room:c(c({},null===(t=this.definition)||void 0===t?void 0:t.room),{},{timeline:c(c({},null===(i=this.definition)||void 0===i||null===(n=i.room)||void 0===n?void 0:n.timeline),{},{[r.a.name]:e})})})}setLazyLoadMembers(e){d(this.definition,"room.state.lazy_load_members",e)}setIncludeLeaveRooms(e){d(this.definition,"room.include_leave",e)}}(0,n.A)(l,"LAZY_LOADING_MESSAGES_FILTER",{lazy_load_members:!0})},"./node_modules/matrix-js-sdk/src/http-api/index.ts":(e,t,i)=>{"use strict";i.d(t,{iD:()=>S,Pw:()=>w,up:()=>a,ED:()=>M,zs:()=>_,IT:()=>s,fZ:()=>v,Y6:()=>g,_:()=>h});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/utils.ts");let s=function(e){return e.Get="GET",e.Put="PUT",e.Post="POST",e.Delete="DELETE",e.Options="OPTIONS",e.Head="HEAD",e.Patch="PATCH",e}({});class o extends Error{constructor(e,t){super(e),this.httpStatus=t}}class a extends o{constructor(e={},t,i,r){let s=e.error||"Unknown message";t&&(s=`[${t}] ${s}`),i&&(s=`${s} (${i})`),super(`MatrixError: ${s}`,t),this.httpStatus=t,this.url=i,this.event=r,(0,n.A)(this,"errcode",void 0),(0,n.A)(this,"data",void 0),this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.data=e}}class c extends Error{constructor(e,t){super(e+(t?`: ${t.message}`:""))}get name(){return"ConnectionError"}}let d=function(e){return e.SessionLoggedOut="Session.logged_out",e.NoConsent="no_consent",e}({});var l=i("./node_modules/content-type/index.js"),u=i("./node_modules/matrix-js-sdk/src/logger.ts");function h(e){const t=new AbortController;return setTimeout((()=>{t.abort()}),e),t.signal}function m(e,t){var i,n;let r;try{r=function(e){let t;t=p(e)?e.getResponseHeader("Content-Type"):e.headers.get("Content-Type");if(!t)return null;try{return(0,l.q)(t)}catch(e){throw new Error(`Error parsing Content-Type '${t}': ${e}`)}}(e)}catch(e){return e}return"application/json"===(null===(i=r)||void 0===i?void 0:i.type)&&t?new a(JSON.parse(t),e.status,p(e)?e.responseURL:e.url):"text/plain"===(null===(n=r)||void 0===n?void 0:n.type)?new o(`Server returned ${e.status} error: ${t}`,e.status):new o(`Server returned ${e.status} error`,e.status)}function p(e){return"getResponseHeader"in e}async function g(e,t){let i=0,n=null;for(;i<e;)try{if(i>0){const e=1e3*Math.pow(2,i);u.v.log(`network operation failed ${i} times, retrying in ${e}ms...`),await(0,r.yy)(e)}return await t()}catch(e){if(!(e instanceof c))throw e;i+=1,n=e}throw n}function v(e,t,i){if(t>4)return-1;if(e instanceof c&&!i)return-1;if(e.httpStatus&&(400===e.httpStatus||403===e.httpStatus||401===e.httpStatus))return-1;if("AbortError"===e.name)return-1;if("M_TOO_LARGE"===e.name)return-1;if("M_LIMIT_EXCEEDED"===e.name){const t=e.data.retry_after_ms;if(t>0)return t}return 1e3*Math.pow(2,t)}function f(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function y(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?f(Object(i),!0).forEach((function(t){(0,n.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):f(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class b{constructor(e,t){var i;this.eventEmitter=e,this.opts=t,(0,n.A)(this,"abortController",new AbortController),(0,r.UB)(t,["baseUrl","prefix"]),t.onlyData=!!t.onlyData,t.useAuthorizationHeader=null===(i=t.useAuthorizationHeader)||void 0===i||i}abort(){this.abortController.abort(),this.abortController=new AbortController}fetch(e,t){return this.opts.fetchFn?this.opts.fetchFn(e,t):i.g.fetch(e,t)}setIdBaseUrl(e){this.opts.idBaseUrl=e}idServerRequest(e,t,i,n,r){if(!this.opts.idBaseUrl)throw new Error("No identity server base URL set");let o,a;e===s.Get?o=i:a=i;const c=this.getUrl(t,o,n,this.opts.idBaseUrl),d={json:!0,headers:{}};return r&&(d.headers.Authorization=`Bearer ${r}`),this.requestOtherUrl(e,c,a,d)}async authedRequest(e,t,i,n,r={}){i||(i={});const s=y({},r);this.opts.accessToken&&(this.opts.useAuthorizationHeader?(s.headers||(s.headers={}),s.headers.Authorization||(s.headers.Authorization="Bearer "+this.opts.accessToken),i.access_token&&delete i.access_token):i.access_token||(i.access_token=this.opts.accessToken));try{return await this.request(e,t,i,n,s)}catch(o){const a=o;if("M_UNKNOWN_TOKEN"===a.errcode&&!s.doNotAttemptTokenRefresh){if(await this.tryRefreshToken())return this.authedRequest(e,t,i,n,y(y({},r),{},{doNotAttemptTokenRefresh:!0}))}throw"M_UNKNOWN_TOKEN"!=a.errcode||null!=s&&s.inhibitLogoutEmit?"M_CONSENT_NOT_GIVEN"==a.errcode&&this.eventEmitter.emit(d.NoConsent,a.message,a.data.consent_uri):this.eventEmitter.emit(d.SessionLoggedOut,a),a}}async tryRefreshToken(){if(!this.opts.refreshToken||!this.opts.tokenRefreshFunction)return!1;try{const{accessToken:e,refreshToken:t}=await this.opts.tokenRefreshFunction(this.opts.refreshToken);return this.opts.accessToken=e,this.opts.refreshToken=t,!0}catch(t){var e;return null===(e=this.opts.logger)||void 0===e||e.warn("Failed to refresh token",t),!1}}request(e,t,i,n,r){const s=this.getUrl(t,i,null==r?void 0:r.prefix,null==r?void 0:r.baseUrl);return this.requestOtherUrl(e,s,n,r)}async requestOtherUrl(e,t,i,n={}){var r,s,o,a,d;const l=this.sanitizeUrlForLogs(t);null===(r=this.opts.logger)||void 0===r||r.debug(`FetchHttpApi: --\x3e ${e} ${l}`);const u=Object.assign({},n.headers||{}),p=null===(s=n.json)||void 0===s||s,g=p&&(null==i||null===(o=i.constructor)||void 0===o?void 0:o.name)===Object.name;p&&(g&&!u["Content-Type"]&&(u["Content-Type"]="application/json"),u.Accept||(u.Accept="application/json"));const v=null!==(a=n.localTimeoutMs)&&void 0!==a?a:this.opts.localTimeoutMs,f=null!==(d=n.keepAlive)&&void 0!==d&&d,y=[this.abortController.signal];let b;void 0!==v&&y.push(h(v)),n.abortSignal&&y.push(n.abortSignal),b=g?JSON.stringify(i):i;const{signal:S,cleanup:w}=function(e){const t=new AbortController;function i(){for(const t of e)t.removeEventListener("abort",n)}function n(){t.abort(),i()}for(const t of e){if(t.aborted){n();break}t.addEventListener("abort",n)}return{signal:t.signal,cleanup:i}}(y);let _;const E=Date.now();try{var I;_=await this.fetch(t,{signal:S,method:e,body:b,headers:u,mode:"cors",redirect:"follow",referrer:"",referrerPolicy:"no-referrer",cache:"no-cache",credentials:"omit",keepalive:f,priority:n.priority}),null===(I=this.opts.logger)||void 0===I||I.debug(`FetchHttpApi: <-- ${e} ${l} [${Date.now()-E}ms ${_.status}]`)}catch(t){var k;if(null===(k=this.opts.logger)||void 0===k||k.debug(`FetchHttpApi: <-- ${e} ${l} [${Date.now()-E}ms ${t}]`),"AbortError"===t.name)throw t;throw new c("fetch failed",t)}finally{w()}if(!_.ok)throw m(_,await _.text());return this.opts.onlyData?p?_.json():_.text():_}sanitizeUrlForLogs(e){try{let t;t="string"==typeof e?new URL(e):e;const i=new URLSearchParams;for(const e of t.searchParams.keys())i.append(e,"xxx");const n=i.toString(),r=n?`?${n}`:"";return t.origin+t.pathname+r}catch(e){return"??"}}getUrl(e,t,i,n){const s=null!=n?n:this.opts.baseUrl,o=s.endsWith("/")?s.slice(0,-1):s,a=new URL(o+(null!=i?i:this.opts.prefix)+e);return t&&(0,r.hm)(t,a.searchParams),a}}let S=function(e){return e.V1="/_matrix/client/v1",e.V3="/_matrix/client/v3",e.Unstable="/_matrix/client/unstable",e}({}),w=function(e){return e.V2="/_matrix/identity/v2",e}({}),_=function(e){return e.V1="/_matrix/media/v1",e.V3="/_matrix/media/v3",e}({});const E=1e3;let I,k=0;const R=[],T=function(...e){};function C(e,t,...i){(t=t||0)<0&&(t=0);const n=Date.now()+t,r=k++;T("setTimeout: scheduling cb",r,"at",n,"(delay",t,")");const s={runAt:n,func:e,params:i,key:r},o=function(e,t){let i=0,n=e.length;for(;i<n;){const r=i+n>>1;t(e[r])>0?n=r:i=r+1}return i}(R,(function(e){return e.runAt-n}));return R.splice(o,0,s),O(),r}function A(e){if(0===R.length)return;let t;for(t=0;t<R.length;t++){if(R[t].key==e){R.splice(t,1);break}}0===t&&O()}function O(){I&&i.g.clearTimeout(I);const e=R[0];if(!e)return void T("scheduleRealCallback: no more callbacks, not rescheduling");const t=Date.now(),n=Math.min(e.runAt-t,E);T("scheduleRealCallback: now:",t,"delay:",n),I=i.g.setTimeout(x,n)}function x(){const e=Date.now();T("runCallbacks: now:",e);const t=[];for(;;){const i=R[0];if(!i||i.runAt>e)break;const n=R.shift();T("runCallbacks: popping",n.key),t.push(n)}O();for(const e of t)try{e.func.apply(i.g,e.params)}catch(e){u.v.error("Uncaught exception in callback function",e)}}class M extends b{constructor(...e){super(...e),(0,n.A)(this,"uploads",[])}uploadContent(e,t={}){var n,o,a,d;const l=null===(n=t.includeFilename)||void 0===n||n,u=null!==(o=t.abortController)&&void 0!==o?o:new AbortController,h=(null!==(a=t.type)&&void 0!==a?a:e.type)||"application/octet-stream",p=null!==(d=t.name)&&void 0!==d?d:e.name,g={loaded:0,total:0,abortController:u},v=(0,r.v6)();if(i.g.XMLHttpRequest){const n=new i.g.XMLHttpRequest,r=function(){n.abort(),v.reject(new Error("Timeout"))};let o=C(r,3e4);n.onreadystatechange=function(){if(n.readyState===i.g.XMLHttpRequest.DONE){A(o);try{if(0===n.status)throw new DOMException(n.statusText,"AbortError");if(!n.responseText)throw new Error("No response body.");n.status>=400?v.reject(m(n,n.responseText)):v.resolve(JSON.parse(n.responseText))}catch(e){if("AbortError"===e.name)return void v.reject(e);v.reject(new c("request failed",e))}}},n.upload.onprogress=e=>{var i;A(o),g.loaded=e.loaded,g.total=e.total,o=C(r,3e4),null===(i=t.progressHandler)||void 0===i||i.call(t,{loaded:e.loaded,total:e.total})};const a=this.getUrl("/upload",void 0,_.V3);l&&p&&a.searchParams.set("filename",encodeURIComponent(p)),!this.opts.useAuthorizationHeader&&this.opts.accessToken&&a.searchParams.set("access_token",encodeURIComponent(this.opts.accessToken)),n.open(s.Post,a.href),this.opts.useAuthorizationHeader&&this.opts.accessToken&&n.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),n.setRequestHeader("Content-Type",h),n.send(e),u.signal.addEventListener("abort",(()=>{n.abort()}))}else{const t={};l&&p&&(t.filename=p);const i={"Content-Type":h};this.authedRequest(s.Post,"/upload",t,e,{prefix:_.V3,headers:i,abortSignal:u.signal}).then((e=>this.opts.onlyData?e:e.json())).then(v.resolve,v.reject)}return g.promise=v.promise.finally((()=>{(0,r.Nz)(this.uploads,(e=>e===g))})),u.signal.addEventListener("abort",(()=>{(0,r.Nz)(this.uploads,(e=>e===g)),v.reject(new DOMException("Aborted","AbortError"))})),this.uploads.push(g),g.promise}cancelUpload(e){const t=this.uploads.find((t=>t.promise===e));return!!t&&(t.abortController.abort(),!0)}getCurrentUploads(){return this.uploads}getContentUri(){return{base:this.opts.baseUrl,path:_.V3+"/upload",params:{access_token:this.opts.accessToken}}}}},"./node_modules/matrix-js-sdk/src/indexeddb-helpers.ts":(e,t,i)=>{"use strict";function n(e,t){return new Promise(((i,n)=>{let r=!0;const s=e.open(t);s.onupgradeneeded=()=>{r=!1},s.onblocked=()=>n(s.error),s.onsuccess=()=>{s.result.close(),r||e.deleteDatabase(t),i(r)},s.onerror=()=>n(s.error)}))}i.d(t,{t:()=>n})},"./node_modules/matrix-js-sdk/src/interactive-auth.ts":(e,t,i)=>{"use strict";i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),i("./node_modules/matrix-js-sdk/src/logger.ts"),i("./node_modules/matrix-js-sdk/src/utils.ts"),i("./node_modules/matrix-js-sdk/src/http-api/index.ts");Error},"./node_modules/matrix-js-sdk/src/logger.ts":(e,t,i)=>{"use strict";i.d(t,{T:()=>d,v:()=>c});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/loglevel/lib/loglevel.js"),s=i.n(r);const o="matrix";function a(e){const t=e;t.getChild=t.withPrefix=function(e){return function(e){const t=s().getLogger(`${o}-${e}`);t.prefix!==e&&(a(t),t.prefix=e,t.setLevel(s().levels.DEBUG,!1));return t}((this.prefix||"")+e)}}s().methodFactory=function(e,t,i){return function(...t){this.prefix&&t.unshift(this.prefix);return"error"===e||"warn"===e||"trace"===e||"info"===e||"debug"===e?console[e](...t):console.log(...t)}};const c=s().getLogger(o);c.setLevel(s().levels.DEBUG,!1),a(c);class d{constructor(e,t){this.parent=e,(0,n.A)(this,"name",void 0),this.name=t+":"}trace(...e){this.parent.trace(this.name,...e)}debug(...e){this.parent.debug(this.name,...e)}info(...e){this.parent.info(this.name,...e)}warn(...e){this.parent.warn(this.name,...e)}error(...e){this.parent.error(this.name,...e)}}},"./node_modules/matrix-js-sdk/src/matrix.ts":(e,t,i)=>{"use strict";i.d(t,{CryptoEvent:()=>a.cr,encodeUnpaddedBase64:()=>r.PP});i("./node_modules/matrix-js-sdk/src/crypto/store/memory-crypto-store.ts"),i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),i("./node_modules/matrix-js-sdk/src/models/room-state.ts"),i("./node_modules/matrix-js-sdk/src/utils.ts"),i("./node_modules/matrix-js-sdk/src/@types/membership.ts");i("./node_modules/matrix-js-sdk/src/scheduler.ts");var n=i("./node_modules/matrix-js-sdk/src/client.ts");i("./node_modules/matrix-widget-api/lib/index.js"),i("./node_modules/matrix-js-sdk/src/models/event.ts"),i("./node_modules/matrix-js-sdk/src/@types/event.ts"),i("./node_modules/matrix-js-sdk/src/logger.ts"),i("./node_modules/matrix-js-sdk/src/sync.ts"),i("./node_modules/matrix-js-sdk/src/sliding-sync-sdk.ts"),i("./node_modules/matrix-js-sdk/src/models/user.ts");n.pB;i("./node_modules/matrix-js-sdk/src/http-api/index.ts"),i("./node_modules/matrix-js-sdk/src/autodiscovery.ts"),i("./node_modules/matrix-js-sdk/src/@types/sync.ts");i("./node_modules/matrix-js-sdk/src/errors.ts");var r=i("./node_modules/matrix-js-sdk/src/base64.ts"),s=(i("./node_modules/matrix-js-sdk/src/models/beacon.ts"),i("./node_modules/matrix-js-sdk/src/models/room.ts"),i("./node_modules/matrix-js-sdk/src/models/event-timeline.ts"),i("./node_modules/matrix-js-sdk/src/models/event-timeline-set.ts"),i("./node_modules/matrix-js-sdk/src/models/poll.ts"),i("./node_modules/matrix-js-sdk/src/models/room-member.ts"),i("./node_modules/matrix-js-sdk/src/models/thread.ts"),i("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"));i("./node_modules/matrix-js-sdk/src/models/device.ts"),i("./node_modules/matrix-js-sdk/src/models/search-result.ts"),i("./node_modules/matrix-js-sdk/src/oidc/authorize.ts"),i("./node_modules/oidc-client-ts/dist/esm/oidc-client-ts.js"),i("./node_modules/matrix-js-sdk/src/oidc/validate.ts");i("./node_modules/matrix-js-sdk/src/oidc/error.ts");i("./node_modules/matrix-js-sdk/src/filter.ts");i("./node_modules/matrix-js-sdk/src/interactive-auth.ts"),i("./node_modules/matrix-js-sdk/src/service-types.ts"),i("./node_modules/matrix-js-sdk/src/indexeddb-helpers.ts");const o=[e=>{e.createObjectStore("users",{keyPath:["userId"]}),e.createObjectStore("accountData",{keyPath:["type"]}),e.createObjectStore("sync",{keyPath:["clobber"]})},e=>{e.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]}).createIndex("room","room_id")},e=>{e.createObjectStore("client_options",{keyPath:["clobber"]})},e=>{e.createObjectStore("to_device_queue",{autoIncrement:!0})}];o.length;i("./node_modules/matrix-js-sdk/src/crypto/store/localStorage-crypto-store.ts"),i("./node_modules/matrix-js-sdk/src/crypto/store/indexeddb-crypto-store.ts"),i("./node_modules/matrix-js-sdk/src/content-repo.ts"),i("./node_modules/matrix-js-sdk/src/@types/PushRules.ts"),i("./node_modules/matrix-js-sdk/src/@types/partials.ts"),i("./node_modules/matrix-js-sdk/src/@types/search.ts"),i("./node_modules/matrix-js-sdk/src/@types/beacon.ts"),i("./node_modules/matrix-js-sdk/src/@types/topic.ts"),i("./node_modules/matrix-js-sdk/src/@types/location.ts");new(i("./node_modules/matrix-js-sdk/src/NamespacedValue.ts").qr)("delegated_oidc_compatibility","org.matrix.msc3824.delegated_oidc_compatibility");i("./node_modules/matrix-js-sdk/src/@types/polls.ts"),i("./node_modules/matrix-js-sdk/src/@types/read_receipts.ts"),i("./node_modules/matrix-js-sdk/src/@types/extensible_events.ts"),i("./node_modules/matrix-js-sdk/src/models/event-status.ts"),i("./node_modules/matrix-js-sdk/src/content-helpers.ts"),i("./node_modules/matrix-js-sdk/src/secret-storage.ts"),i("./node_modules/matrix-js-sdk/src/webrtc/call.ts"),i("./node_modules/matrix-js-sdk/src/webrtc/groupCall.ts");var a=i("./node_modules/matrix-js-sdk/src/crypto/index.ts");i("./node_modules/matrix-js-sdk/src/sliding-sync.ts"),i("./node_modules/matrix-js-sdk/src/webrtc/mediaHandler.ts"),i("./node_modules/matrix-js-sdk/src/webrtc/callFeed.ts"),i("./node_modules/matrix-js-sdk/src/webrtc/stats/statsReport.ts"),i("./node_modules/matrix-js-sdk/src/models/relations.ts");class c extends s.X{}new c;i("./node_modules/matrix-js-sdk/src/crypto-api.ts")},"./node_modules/matrix-js-sdk/src/matrixrtc/MatrixRTCSession.ts":(e,t,i)=>{"use strict";i.d(t,{n:()=>b});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/logger.ts"),s=i("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),o=i("./node_modules/matrix-js-sdk/src/models/event-timeline.ts"),a=i("./node_modules/matrix-js-sdk/src/@types/event.ts"),c=i("./node_modules/matrix-js-sdk/src/utils.ts");class d{static equal(e,t){return(0,c.ky)(e.data,t.data)}constructor(e,t){if(this.parentEvent=e,this.data=t,!t.expires&&!t.expires_ts)throw new Error("Malformed membership: expires_ts or expires must be present");if(t.expires&&"number"!=typeof t.expires)throw new Error("Malformed membership: expires must be numeric");if(t.expires_ts&&"number"!=typeof t.expires_ts)throw new Error("Malformed membership: expires_ts must be numeric");if("string"!=typeof t.device_id)throw new Error("Malformed membership event: device_id must be string");if("string"!=typeof t.call_id)throw new Error("Malformed membership event: call_id must be string");if("string"!=typeof t.scope)throw new Error("Malformed membership event: scope must be string");if(!e.getSender())throw new Error("Invalid parent event: sender is null")}get sender(){return this.parentEvent.getSender()}get callId(){return this.data.call_id}get deviceId(){return this.data.device_id}get application(){return this.data.application}get scope(){return this.data.scope}get membershipID(){return this.data.membershipID}createdTs(){var e;return null!==(e=this.data.created_ts)&&void 0!==e?e:this.parentEvent.getTs()}getAbsoluteExpiry(){return this.data.expires?this.createdTs()+this.data.expires:this.data.expires_ts}getLocalExpiry(){if(this.data.expires){const e=this.parentEvent.getTs()-this.createdTs();return this.parentEvent.localTimestamp-e+this.data.expires}return this.data.expires_ts}getMsUntilExpiry(){return this.getLocalExpiry()-Date.now()}isExpired(){return this.getMsUntilExpiry()<=0}getActiveFoci(){var e;return null!==(e=this.data.foci_active)&&void 0!==e?e:[]}}var l=i("./node_modules/matrix-js-sdk/src/models/room-state.ts"),u=i("./node_modules/matrix-js-sdk/src/randomstring.ts"),h=i("./node_modules/matrix-js-sdk/src/base64.ts"),m=i("./node_modules/matrix-js-sdk/src/@types/membership.ts");const p=36e5,g=12e4,v=(e,t)=>`${e}:${t}`,f=e=>v(e.sender,e.deviceId);let y=function(e){return e.MembershipsChanged="memberships_changed",e.JoinStateChanged="join_state_changed",e.EncryptionKeyChanged="encryption_key_changed",e}({});class b extends s.X{get callId(){return this._callId}static callMembershipsForRoom(e){const t=e.getLiveTimeline().getState(o.q.FORWARDS);if(!t)throw r.v.warn("Couldn't get state for room "+e.roomId),new Error("Could't get state for room "+e.roomId);const i=t.getStateEvents(a.Bx.GroupCallMemberPrefix),n=[];for(const t of i){const i=t.getContent().memberships;if(void 0!==i)if(Array.isArray(i))for(const o of i)try{var s;const i=new d(t,o);if(""!==i.callId||"m.room"!==i.scope){r.v.info("Ignoring user-scoped call");continue}if(i.isExpired()){r.v.info(`Ignoring expired device membership ${i.sender}/${i.deviceId}`);continue}if(!e.hasMembershipState(null!==(s=i.sender)&&void 0!==s?s:"",m.O.Join)){r.v.info(`Ignoring membership of user ${i.sender} who is not in the room.`);continue}n.push(i)}catch(e){r.v.warn("Couldn't construct call membership: ",e)}else r.v.warn(`Malformed member event from ${t.getSender()}: memberships is not an array`)}return n.sort(((e,t)=>e.createdTs()-t.createdTs())),n.length>1&&r.v.debug(`Call memberships in room ${e.roomId}, in order: `,n.map((e=>[e.createdTs(),e.sender]))),n}static roomSessionForRoom(e,t){const i=b.callMembershipsForRoom(t);return new b(e,t,i)}constructor(e,t,i){var s;super(),this.client=e,this.room=t,this.memberships=i,(0,n.A)(this,"_callId",void 0),(0,n.A)(this,"relativeExpiry",void 0),(0,n.A)(this,"membershipId",void 0),(0,n.A)(this,"memberEventTimeout",void 0),(0,n.A)(this,"expiryTimeout",void 0),(0,n.A)(this,"keysEventUpdateTimeout",void 0),(0,n.A)(this,"makeNewKeyTimeout",void 0),(0,n.A)(this,"setNewKeyTimeouts",new Set),(0,n.A)(this,"activeFoci",void 0),(0,n.A)(this,"updateCallMembershipRunning",!1),(0,n.A)(this,"needCallMembershipUpdate",!1),(0,n.A)(this,"manageMediaKeys",!1),(0,n.A)(this,"encryptionKeys",new Map),(0,n.A)(this,"lastEncryptionKeyUpdateRequest",void 0),(0,n.A)(this,"sendEncryptionKeysEvent",(async()=>{if(void 0!==this.keysEventUpdateTimeout&&(clearTimeout(this.keysEventUpdateTimeout),this.keysEventUpdateTimeout=void 0),this.lastEncryptionKeyUpdateRequest=Date.now(),r.v.info("Sending encryption keys event"),!this.isJoined())return;const e=this.client.getUserId(),t=this.client.getDeviceId();if(!e)throw new Error("No userId");if(!t)throw new Error("No deviceId");const i=this.getKeysForParticipant(e,t);if(i)try{await this.client.sendEvent(this.room.roomId,a.Bx.CallEncryptionKeysPrefix,{keys:i.map(((e,t)=>({index:t,key:(0,h.PP)(e)}))),device_id:t,call_id:""}),r.v.debug(`Embedded-E2EE-LOG updateEncryptionKeyEvent participantId=${e}:${t} numSent=${i.length}`,this.encryptionKeys)}catch(e){const t=e;if(t.event&&this.client.cancelPendingEvent(t.event),void 0===this.keysEventUpdateTimeout){var n,s;const i=null!==(n=null===(s=t.data)||void 0===s?void 0:s.retry_after_ms)&&void 0!==n?n:5e3;r.v.warn(`Failed to send m.call.encryption_key, retrying in ${i}`,e),this.keysEventUpdateTimeout=setTimeout(this.sendEncryptionKeysEvent,i)}else r.v.info("Not scheduling key resend as another re-send is already pending")}else r.v.warn("Tried to send encryption keys event but no keys found!")})),(0,n.A)(this,"onCallEncryption",(e=>{const t=e.getSender(),i=e.getContent(),n=i.device_id,s=i.call_id;if(t)if(""===s)if(Array.isArray(i.keys))if(t!==this.client.getUserId()||n!==this.client.getDeviceId())for(const e of i.keys){if(!e){r.v.info("Ignoring false-y key in keys event");continue}const i=e.key,o=e.index;i&&null!=o&&null!=s&&"string"==typeof n&&"string"==typeof s&&"string"==typeof i&&"number"==typeof o?(r.v.debug(`Embedded-E2EE-LOG onCallEncryption userId=${t}:${n} encryptionKeyIndex=${o}`,this.encryptionKeys),this.setEncryptionKey(t,n,o,i)):r.v.warn(`Malformed call encryption_key: userId=${t}, deviceId=${n}, encryptionKeyIndex=${o} callId=${s}`)}else r.v.info("Ignoring our own keys event");else r.v.warn(`Received m.call.encryption_keys where keys wasn't an array: callId=${s}`);else r.v.warn(`Received m.call.encryption_keys with unsupported callId: userId=${t}, deviceId=${n}, callId=${s}`);else r.v.warn(`Received m.call.encryption_keys with no userId: callId=${s}`)})),(0,n.A)(this,"onMembershipUpdate",(()=>{var e,t;const i=this.memberships;this.memberships=b.callMembershipsForRoom(this.room),this._callId=null!==(e=this._callId)&&void 0!==e?e:null===(t=this.memberships[0])||void 0===t?void 0:t.callId;(i.length!=this.memberships.length||i.some(((e,t)=>!d.equal(e,this.memberships[t]))))&&(r.v.info(`Memberships for call in room ${this.room.roomId} have changed: emitting`),this.emit(y.MembershipsChanged,i,this.memberships));const n=e=>e.sender===this.client.getUserId()&&e.deviceId===this.client.getDeviceId();if(this.manageMediaKeys&&this.isJoined()&&void 0===this.makeNewKeyTimeout){const e=new Set(i.filter((e=>!n(e))).map(f)),t=new Set(this.memberships.filter((e=>!n(e))).map(f)),s=Array.from(e).some((e=>!t.has(e))),o=Array.from(t).some((t=>!e.has(t)));s?(r.v.debug("Member(s) have left: queueing sender key rotation"),this.makeNewKeyTimeout=setTimeout(this.onRotateKeyTimeout,3e3)):o&&(r.v.debug("New member(s) have joined: re-sending keys"),this.requestKeyEventSend())}this.setExpiryTimer()})),(0,n.A)(this,"triggerCallMembershipEventUpdate",(async()=>{if(this.updateCallMembershipRunning)this.needCallMembershipUpdate=!0;else{this.updateCallMembershipRunning=!0;try{do{this.needCallMembershipUpdate=!1,await this.updateCallMembershipEvent()}while(this.needCallMembershipUpdate)}finally{this.updateCallMembershipRunning=!1}}})),(0,n.A)(this,"onRotateKeyTimeout",(()=>{this.manageMediaKeys&&(this.makeNewKeyTimeout=void 0,r.v.info("Making new sender key for key rotation"),this.makeNewSenderKey(!0),this.sendEncryptionKeysEvent())})),this._callId=null===(s=i[0])||void 0===s?void 0:s.callId;const c=this.room.getLiveTimeline().getState(o.q.FORWARDS);null==c||c.on(l.f.Members,this.onMembershipUpdate),this.setExpiryTimer()}isJoined(){return void 0!==this.relativeExpiry}async stop(){await this.leaveRoomSession(1e3),this.expiryTimeout&&(clearTimeout(this.expiryTimeout),this.expiryTimeout=void 0),this.memberEventTimeout&&(clearTimeout(this.memberEventTimeout),this.memberEventTimeout=void 0);const e=this.room.getLiveTimeline().getState(o.q.FORWARDS);null==e||e.off(l.f.Members,this.onMembershipUpdate)}joinRoomSession(e,t){this.isJoined()?r.v.info(`Already joined to session in room ${this.room.roomId}: ignoring join call`):(r.v.info(`Joining call session in room ${this.room.roomId} with manageMediaKeys=${t}`),this.activeFoci=e,this.relativeExpiry=p,this.manageMediaKeys=null!=t&&t,this.membershipId=(0,u.DU)(5),this.emit(y.JoinStateChanged,!0),t&&(this.makeNewSenderKey(),this.requestKeyEventSend()),this.triggerCallMembershipEventUpdate())}async leaveRoomSession(e=void 0){if(!this.isJoined())return r.v.info(`Not joined to session in room ${this.room.roomId}: ignoring leave call`),new Promise((e=>e(!1)));const t=this.client.getUserId(),i=this.client.getDeviceId();if(!t)throw new Error("No userId");if(!i)throw new Error("No deviceId");this.encryptionKeys.set(v(t,i),[]),void 0!==this.makeNewKeyTimeout&&(clearTimeout(this.makeNewKeyTimeout),this.makeNewKeyTimeout=void 0);for(const e of this.setNewKeyTimeouts)clearTimeout(e);this.setNewKeyTimeouts.clear(),r.v.info(`Leaving call session in room ${this.room.roomId}`),this.relativeExpiry=void 0,this.activeFoci=void 0,this.manageMediaKeys=!1,this.membershipId=void 0,this.emit(y.JoinStateChanged,!1);const n=new Promise((t=>{e&&setTimeout(t,e,"timeout")}));return new Promise((e=>{Promise.race([this.triggerCallMembershipEventUpdate(),n]).then((t=>{e("timeout"!=t)}))}))}getKeysForParticipant(e,t){return this.encryptionKeys.get(v(e,t))}getEncryptionKeys(){return this.encryptionKeys.entries()}getNewEncryptionKeyIndex(){var e,t;const i=this.client.getUserId(),n=this.client.getDeviceId();if(!i)throw new Error("No userId!");if(!n)throw new Error("No deviceId!");return(null!==(e=null===(t=this.getKeysForParticipant(i,n))||void 0===t?void 0:t.length)&&void 0!==e?e:0)%16}setEncryptionKey(e,t,i,n,s=!1){var o;const a=(0,h.y4)(n),c=v(e,t),d=null!==(o=this.encryptionKeys.get(c))&&void 0!==o?o:[];var l,u;if(!((l=d[i])===(u=a)||l&&u&&l.length===u.length&&l.every(((e,t)=>e===u[t]))))if(d[i]=a,this.encryptionKeys.set(c,d),s){const e=setTimeout((()=>{this.setNewKeyTimeouts.delete(e),r.v.info(`Delayed-emitting key changed event for ${c} idx ${i}`),this.emit(y.EncryptionKeyChanged,a,i,c)}),5e3);this.setNewKeyTimeouts.add(e)}else this.emit(y.EncryptionKeyChanged,a,i,c)}makeNewSenderKey(e=!1){const t=this.client.getUserId(),i=this.client.getDeviceId();if(!t)throw new Error("No userId");if(!i)throw new Error("No deviceId");const n=(0,u.rl)(16),s=this.getNewEncryptionKeyIndex();r.v.info("Generated new key at index "+s),this.setEncryptionKey(t,i,s,n,e)}requestKeyEventSend(){if(this.manageMediaKeys)return this.lastEncryptionKeyUpdateRequest&&this.lastEncryptionKeyUpdateRequest+3e3>Date.now()?(r.v.info("Last encryption key event sent too recently: postponing"),void(void 0===this.keysEventUpdateTimeout&&(this.keysEventUpdateTimeout=setTimeout(this.sendEncryptionKeysEvent,3e3)))):void this.sendEncryptionKeysEvent()}setExpiryTimer(){let e;this.expiryTimeout&&(clearTimeout(this.expiryTimeout),this.expiryTimeout=void 0);for(const t of this.memberships){const i=t.getMsUntilExpiry();(void 0===e||i<e)&&(e=i)}null!=e&&(this.expiryTimeout=setTimeout(this.onMembershipUpdate,e))}getOldestMembership(){return this.memberships[0]}makeMyMembership(e){var t,i;if(void 0===this.relativeExpiry)throw new Error("Tried to create our own membership event when we're not joined!");if(void 0===this.membershipId)throw new Error("Tried to create our own membership event when we have no membership ID!");const n={call_id:"",scope:"m.room",application:"m.call",device_id:this.client.getDeviceId(),expires:this.relativeExpiry,foci_active:this.activeFoci,membershipID:this.membershipId};return e&&(n.created_ts=e.createdTs()),n.created_ts?n.expires_ts=n.created_ts+(null!==(t=n.expires)&&void 0!==t?t:0):n.expires_ts=Date.now()+(null!==(i=n.expires)&&void 0!==i?i:0),n}membershipEventNeedsUpdate(e,t){let i=!1;return!this.isJoined()&&e&&(i=!0),this.isJoined()&&(t?t.getMsUntilExpiry()<18e5&&(i=!0,this.relativeExpiry+=p):i=!0),i}makeNewMemberships(e,t,i){const n=this.client.getDeviceId();if(!n)throw new Error("Local device ID is null!");let r=e.filter((e=>{let i;try{i=new d(t,e)}catch(e){return!1}return!i.isExpired()})).filter((e=>e.device_id!==n));return r=r.map((e=>(void 0===e.created_ts&&(e.created_ts=t.getTs()),e))),this.isJoined()&&r.push(this.makeMyMembership(i)),r}async updateCallMembershipEvent(){var e,t;this.memberEventTimeout&&(clearTimeout(this.memberEventTimeout),this.memberEventTimeout=void 0);const i=this.room.getLiveTimeline().getState(o.q.FORWARDS);if(!i)throw new Error("Couldn't get room state for room "+this.room.roomId);const n=this.client.getUserId(),s=this.client.getDeviceId();if(!n||!s)throw new Error("User ID or device ID was null!");const c=null!==(e=i.getStateEvents(a.Bx.GroupCallMemberPrefix,n))&&void 0!==e?e:void 0,l=null!==(t=null==c?void 0:c.getContent())&&void 0!==t?t:{},u=Array.isArray(l.memberships)?l.memberships:[],h=u.find((e=>e.device_id===s));let m;try{c&&h&&h.membershipID===this.membershipId&&(m=new d(c,h))}catch(e){r.v.warn("Our previous call membership was invalid - this shouldn't happen.",e)}if(m&&r.v.debug(`${m.getMsUntilExpiry()} until our membership expires`),!this.membershipEventNeedsUpdate(h,m))return void(this.memberEventTimeout=setTimeout(this.triggerCallMembershipEventUpdate,g));const p={memberships:this.makeNewMemberships(u,c,m)};try{await this.client.sendStateEvent(this.room.roomId,a.Bx.GroupCallMemberPrefix,p,n),r.v.info("Sent updated call member event."),this.isJoined()&&(this.memberEventTimeout=setTimeout(this.triggerCallMembershipEventUpdate,g))}catch(e){const t=3e3+2e3*Math.random();r.v.warn(`Failed to send call member event: retrying in ${t}`),await new Promise((e=>setTimeout(e,t))),await this.triggerCallMembershipEventUpdate()}}}},"./node_modules/matrix-js-sdk/src/matrixrtc/MatrixRTCSessionManager.ts":(e,t,i)=>{"use strict";i.d(t,{I:()=>h});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/logger.ts"),s=i("./node_modules/matrix-js-sdk/src/client.ts"),o=i("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),a=i("./node_modules/matrix-js-sdk/src/models/room.ts"),c=i("./node_modules/matrix-js-sdk/src/models/room-state.ts"),d=i("./node_modules/matrix-js-sdk/src/matrixrtc/MatrixRTCSession.ts"),l=i("./node_modules/matrix-js-sdk/src/@types/event.ts");let u=function(e){return e.SessionStarted="session_started",e.SessionEnded="session_ended",e}({});class h extends o.X{constructor(e){super(),this.client=e,(0,n.A)(this,"roomSessions",new Map),(0,n.A)(this,"onTimeline",(e=>{this.consumeCallEncryptionEvent(e)})),(0,n.A)(this,"onRoom",(e=>{this.refreshRoom(e)})),(0,n.A)(this,"onRoomState",((e,t)=>{const i=this.client.getRoom(e.getRoomId());i?e.getType()==l.Bx.GroupCallMemberPrefix&&this.refreshRoom(i):r.v.error(`Got room state event for unknown room ${e.getRoomId()}!`)}))}start(){for(const t of null!==(e=this.client.getRooms())&&void 0!==e?e:[]){var e;const i=d.n.roomSessionForRoom(this.client,t);i.memberships.length>0&&this.roomSessions.set(t.roomId,i)}this.client.on(s.AU.Room,this.onRoom),this.client.on(a.u9.Timeline,this.onTimeline),this.client.on(c.f.Events,this.onRoomState)}stop(){for(const e of this.roomSessions.values())e.stop();this.roomSessions.clear(),this.client.removeListener(s.AU.Room,this.onRoom),this.client.removeListener(a.u9.Timeline,this.onTimeline),this.client.removeListener(c.f.Events,this.onRoomState)}getActiveRoomSession(e){return this.roomSessions.get(e.roomId)}getRoomSession(e){return this.roomSessions.has(e.roomId)||this.roomSessions.set(e.roomId,d.n.roomSessionForRoom(this.client,e)),this.roomSessions.get(e.roomId)}async consumeCallEncryptionEvent(e){if(await this.client.decryptEventIfNeeded(e),e.getType()!==l.Bx.CallEncryptionKeysPrefix)return Promise.resolve();const t=this.client.getRoom(e.getRoomId());if(!t)return r.v.error(`Got room state event for unknown room ${e.getRoomId()}!`),Promise.resolve();this.getRoomSession(t).onCallEncryption(e)}refreshRoom(e){const t=!this.roomSessions.has(e.roomId),i=this.getRoomSession(e),n=i.memberships.length>0&&!t;i.onMembershipUpdate();const r=i.memberships.length>0;n&&!r?this.emit(u.SessionEnded,e.roomId,this.roomSessions.get(e.roomId)):!n&&r&&this.emit(u.SessionStarted,e.roomId,this.roomSessions.get(e.roomId))}}},"./node_modules/matrix-js-sdk/src/models/beacon.ts":(e,t,i)=>{"use strict";i.d(t,{HF:()=>l,JH:()=>a,M9:()=>d});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/content-helpers.ts"),s=i("./node_modules/matrix-js-sdk/src/utils.ts"),o=i("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts");let a=function(e){return e.New="Beacon.new",e.Update="Beacon.update",e.LivenessChange="Beacon.LivenessChange",e.Destroy="Beacon.Destroy",e.LocationUpdate="Beacon.LocationUpdate",e}({});const c=(e,t,i)=>i>=e&&e+t>=i,d=e=>`${e.getRoomId()}_${e.getStateKey()}`;class l extends o.X{constructor(e){super(),this.rootEvent=e,(0,n.A)(this,"roomId",void 0),(0,n.A)(this,"_beaconInfo",void 0),(0,n.A)(this,"_isLive",void 0),(0,n.A)(this,"livenessWatchTimeout",void 0),(0,n.A)(this,"_latestLocationEvent",void 0),(0,n.A)(this,"clearLatestLocation",(()=>{this._latestLocationEvent=void 0,this.emit(a.LocationUpdate,this.latestLocationState)})),this.roomId=this.rootEvent.getRoomId(),this.setBeaconInfo(this.rootEvent)}get isLive(){return!!this._isLive}get identifier(){return d(this.rootEvent)}get beaconInfoId(){return this.rootEvent.getId()}get beaconInfoOwner(){return this.rootEvent.getStateKey()}get beaconInfoEventType(){return this.rootEvent.getType()}get beaconInfo(){return this._beaconInfo}get latestLocationState(){return this._latestLocationEvent&&(0,r.parseBeaconContent)(this._latestLocationEvent.getContent())}get latestLocationEvent(){return this._latestLocationEvent}update(e){if(d(e)!==this.identifier)throw new Error("Invalid updating event");e.getTs()<this.rootEvent.getTs()||(this.rootEvent=e,this.setBeaconInfo(this.rootEvent),this.emit(a.Update,e,this),this.clearLatestLocation())}destroy(){this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this._isLive=!1,this.emit(a.Destroy,this.identifier)}monitorLiveness(){if(this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this.checkLiveness(),this.beaconInfo)if(this.isLive){const e=this.beaconInfo.timestamp+this.beaconInfo.timeout-Date.now();e>1&&(this.livenessWatchTimeout=setTimeout((()=>{this.monitorLiveness()}),e))}else this.beaconInfo.timestamp>Date.now()&&(this.livenessWatchTimeout=setTimeout((()=>{this.monitorLiveness()}),this.beaconInfo.timestamp-Date.now()))}addLocations(e){var t;if(!this.isLive)return;const i=null===(t=e.filter((e=>{const t=e.getContent(),i=(0,r.parseBeaconContent)(t);if(!i.uri||!i.timestamp)return!1;const{timestamp:n}=i;return this._beaconInfo.timestamp&&c(this._beaconInfo.timestamp,this._beaconInfo.timeout,n)&&(!this.latestLocationState||n>this.latestLocationState.timestamp)})).sort(s.Fq))||void 0===t?void 0:t[0];i&&(this._latestLocationEvent=i,this.emit(a.LocationUpdate,this.latestLocationState))}setBeaconInfo(e){this._beaconInfo=(0,r.parseBeaconInfoContent)(e.getContent()),this.checkLiveness()}checkLiveness(){const e=this.isLive;if(!this.beaconInfo)return;const t=this.beaconInfo.timestamp>Date.now()?this.beaconInfo.timestamp-36e4:this.beaconInfo.timestamp;this._isLive=!!this._beaconInfo.live&&!!t&&c(t,this._beaconInfo.timeout,Date.now()),e!==this.isLive&&this.emit(a.LivenessChange,this.isLive,this)}}},"./node_modules/matrix-js-sdk/src/models/device.ts":(e,t,i)=>{"use strict";i.d(t,{p:()=>s,u:()=>r});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js");let r=function(e){return e[e.Blocked=-1]="Blocked",e[e.Unverified=0]="Unverified",e[e.Verified=1]="Verified",e}({});class s{constructor(e){(0,n.A)(this,"deviceId",void 0),(0,n.A)(this,"userId",void 0),(0,n.A)(this,"algorithms",void 0),(0,n.A)(this,"keys",void 0),(0,n.A)(this,"verified",void 0),(0,n.A)(this,"signatures",void 0),(0,n.A)(this,"displayName",void 0),(0,n.A)(this,"dehydrated",!1),this.deviceId=e.deviceId,this.userId=e.userId,this.algorithms=e.algorithms,this.keys=e.keys,this.verified=e.verified||r.Unverified,this.signatures=e.signatures||new Map,this.displayName=e.displayName,this.dehydrated=!!e.dehydrated}getFingerprint(){return this.keys.get(`ed25519:${this.deviceId}`)}getIdentityKey(){return this.keys.get(`curve25519:${this.deviceId}`)}}},"./node_modules/matrix-js-sdk/src/models/event-status.ts":(e,t,i)=>{"use strict";i.d(t,{f:()=>n});let n=function(e){return e.NOT_SENT="not_sent",e.ENCRYPTING="encrypting",e.SENDING="sending",e.QUEUED="queued",e.SENT="sent",e.CANCELLED="cancelled",e}({})},"./node_modules/matrix-js-sdk/src/models/event-timeline-set.ts":(e,t,i)=>{"use strict";i.d(t,{m:()=>u,x:()=>l});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/models/event-timeline.ts"),s=i("./node_modules/matrix-js-sdk/src/logger.ts"),o=i("./node_modules/matrix-js-sdk/src/models/room.ts"),a=i("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),c=i("./node_modules/matrix-js-sdk/src/models/relations-container.ts");let d;d=s.v.log.bind(s.v);let l=function(e){return e.Ignore="ignore",e.Replace="replace",e}({});class u extends a.X{constructor(e,t={},i,s,o=null){var a,d,l;super(),this.room=e,this.thread=s,this.threadListType=o,(0,n.A)(this,"relations",void 0),(0,n.A)(this,"timelineSupport",void 0),(0,n.A)(this,"displayPendingEvents",void 0),(0,n.A)(this,"liveTimeline",void 0),(0,n.A)(this,"timelines",void 0),(0,n.A)(this,"_eventIdToTimeline",new Map),(0,n.A)(this,"filter",void 0),this.timelineSupport=Boolean(t.timelineSupport),this.liveTimeline=new r.q(this),this.displayPendingEvents=!1!==t.pendingEvents,this.timelines=[this.liveTimeline],this._eventIdToTimeline=new Map,this.filter=t.filter,this.relations=null!==(a=null===(d=this.room)||void 0===d?void 0:d.relations)&&void 0!==a?a:new c.t(null!==(l=null==e?void 0:e.client)&&void 0!==l?l:i)}getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(e){this.filter=e}getPendingEvents(){return this.room&&this.displayPendingEvents?this.room.getPendingEvents():[]}getLiveTimeline(){return this.liveTimeline}setLiveTimeline(e){this.liveTimeline=e}eventIdToTimeline(e){return this._eventIdToTimeline.get(e)}replaceEventId(e,t){const i=this._eventIdToTimeline.get(e);i&&(this._eventIdToTimeline.delete(e),this._eventIdToTimeline.set(t,i))}resetLiveTimeline(e,t){const i=!this.timelineSupport||!t,n=this.liveTimeline,s=i?n.forkLive(r.q.FORWARDS):n.fork(r.q.FORWARDS);i?(this.timelines=[s],this._eventIdToTimeline=new Map):this.timelines.push(s),t&&n.setPaginationToken(t,r.q.FORWARDS),s.setPaginationToken(null!=e?e:null,r.q.BACKWARDS),this.liveTimeline=s,this.emit(o.u9.TimelineReset,this.room,this,i)}getTimelineForEvent(e){if(null==e)return null;const t=this._eventIdToTimeline.get(e);return void 0===t?null:t}findEventById(e){const t=this.getTimelineForEvent(e);if(t)return t.getEvents().find((function(t){return t.getId()==e}))}addTimeline(){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");const e=new r.q(this);return this.timelines.push(e),e}addEventsToTimeline(e,t,i,n){if(!i)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&i==this.liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(this.filter&&!(e=this.filter.filterRoomTimeline(e)).length)return;const o=t?r.q.BACKWARDS:r.q.FORWARDS,a=t?r.q.FORWARDS:r.q.BACKWARDS;let c=!1,l=!1;for(const n of e){const e=n.getId(),u=this._eventIdToTimeline.get(e);if(!u){this.addEventToTimeline(n,i,{toStartOfTimeline:t}),l=!0,c=!0;continue}if(l=!1,u==i){d("Event "+e+" already in timeline "+i);continue}const h=i.getNeighbouringTimeline(o);if(h){d(u==h?"Event "+e+" in neighbouring timeline - switching to "+u:"Event "+e+" already in a different timeline "+u),i=u;continue}s.v.info("Already have timeline for "+e+" - joining timeline "+i+" to "+u);const m=u===this.liveTimeline,p=i===this.liveTimeline,g=o===r.q.BACKWARDS&&m,v=o===r.q.FORWARDS&&p;g||v?(g&&s.v.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+u+")"),v&&s.v.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+i+")")):(i.setNeighbouringTimeline(u,o),u.setNeighbouringTimeline(i,a),i=u,c=!0)}if(l||!c){if(o===r.q.FORWARDS&&i===this.liveTimeline)return s.v.warn({lastEventWasNew:l,didUpdate:c}),void s.v.warn(`Refusing to set forwards pagination token of live timeline ${i} to ${n}`);i.setPaginationToken(null!=n?n:null,o)}}addLiveEvent(e,{duplicateStrategy:t,fromCache:i,roomState:n,timelineWasEmpty:s}={}){if(this.filter){if(!this.filter.filterRoomTimeline([e]).length)return}const o=this._eventIdToTimeline.get(e.getId());if(o)if(t===l.Replace){d("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());const t=o.getEvents();for(let i=0;i<t.length;i++)if(t[i].getId()===e.getId()){n||(n=o.getState(r.q.FORWARDS)),r.q.setEventMetadata(e,n,!1),t[i]=e;break}}else d("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());else this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,fromCache:i,roomState:n,timelineWasEmpty:s})}addEventToTimeline(e,t,i,n=!1,r){let a,c=!!i;var d;if("object"==typeof i?({toStartOfTimeline:c,fromCache:n=!1,roomState:r,timelineWasEmpty:a}=i):void 0!==i&&s.v.warn("Overload deprecated: `EventTimelineSet.addEventToTimeline(event, timeline, toStartOfTimeline, fromCache?, roomState?)` is deprecated in favor of the overload with `EventTimelineSet.addEventToTimeline(event, timeline, IAddEventToTimelineOptions)`"),t.getTimelineSet()!==this)throw new Error(`EventTimelineSet.addEventToTimeline: Timeline=${t.toString()} does not belong " +\n                "in timelineSet(threadId=${null===(d=this.thread)||void 0===d?void 0:d.id})`);const l=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var u;let i=`event=${l}`;return e.threadRootId&&(i+=`(belongs to thread=${e.threadRootId})`),void s.v.warn(`EventTimelineSet.addEventToTimeline: Ignoring ${i} that does not belong in timeline=${t.toString()} timelineSet(threadId=${null===(u=this.thread)||void 0===u?void 0:u.id})`)}t.addEvent(e,{toStartOfTimeline:c,roomState:r,timelineWasEmpty:a}),this._eventIdToTimeline.set(l,t);const h={timeline:t,liveEvent:!c&&t==this.liveTimeline&&!n};this.emit(o.u9.Timeline,e,this.room,Boolean(c),!1,h)}insertEventIntoTimeline(e,t,i){var n;if(t.getTimelineSet()!==this)throw new Error(`EventTimelineSet.insertEventIntoTimeline: Timeline=${t.toString()} does not belong " +\n                "in timelineSet(threadId=${null===(n=this.thread)||void 0===n?void 0:n.id})`);const r=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var a;let i=`event=${r}`;return e.threadRootId&&(i+=`(belongs to thread=${e.threadRootId})`),void s.v.warn(`EventTimelineSet.insertEventIntoTimeline: Ignoring ${i} that does not belong in timeline=${t.toString()} timelineSet(threadId=${null===(a=this.thread)||void 0===a?void 0:a.id})`)}const c=e.relationEventId;if(!c)return void this.addEventToTimeline(e,t,{toStartOfTimeline:!1,fromCache:!1,timelineWasEmpty:!1,roomState:i});const d=this.findEventById(c),l=t.getEvents();let u=void 0!==d?l.indexOf(d):0;for(;u<l.length;u++){if(l[u].getTs()>e.getTs())break}t.insertEvent(e,u,i),this._eventIdToTimeline.set(r,t);const h={timeline:t,liveEvent:!1};this.emit(o.u9.Timeline,e,this.room,!1,!1,h)}handleRemoteEcho(e,t,i){const n=this._eventIdToTimeline.get(t);n?(this._eventIdToTimeline.delete(t),this._eventIdToTimeline.set(i,n)):this.filter&&!this.filter.filterRoomTimeline([e]).length||this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1})}removeEvent(e){const t=this._eventIdToTimeline.get(e);if(!t)return null;const i=t.removeEvent(e);if(i){this._eventIdToTimeline.delete(e);const n={timeline:t};this.emit(o.u9.Timeline,i,this.room,void 0,!0,n)}return i}compareEventOrdering(e,t){if(e==t)return 0;const i=this._eventIdToTimeline.get(e),n=this._eventIdToTimeline.get(t);if(void 0===i)return null;if(void 0===n)return null;if(i===n){let n,r;const s=i.getEvents();for(let i=0;i<s.length&&(void 0===n||void 0===r);i++){const o=s[i].getId();o==e&&(n=i),o==t&&(r=i)}const o=n-r;return o<0?-1:o>0?1:0}let s=i;for(;s;){if(s===n)return-1;s=s.getNeighbouringTimeline(r.q.FORWARDS)}for(s=i;s;){if(s===n)return 1;s=s.getNeighbouringTimeline(r.q.BACKWARDS)}return null}canContain(e){if(!this.room)throw new Error("Cannot call `EventTimelineSet::canContain without a `room` set. Set the room when creating the EventTimelineSet to call this method.");const{threadId:t,shouldLiveInRoom:i,shouldLiveInThread:n}=this.room.eventShouldLiveIn(e);if(this.thread)return this.thread.id===t;var r;i||n||s.v.warn(`EventTimelineSet:canContain event encountered which cannot be added to any timeline roomId=${null===(r=this.room)||void 0===r?void 0:r.roomId} eventId=${e.getId()} threadId=${e.threadRootId}`);return i}}},"./node_modules/matrix-js-sdk/src/models/event-timeline.ts":(e,t,i)=>{"use strict";i.d(t,{O:()=>o,q:()=>a});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/models/room-state.ts"),s=i("./node_modules/matrix-js-sdk/src/@types/event.ts");let o=function(e){return e.Backward="b",e.Forward="f",e}({});class a{static setEventMetadata(e,t,i){var n,r,o,a;null!==(n=e.sender)&&void 0!==n&&null!==(r=n.events)&&void 0!==r&&r.member||(e.sender=t.getSentinelMember(e.getSender())),null!==(o=e.target)&&void 0!==o&&null!==(a=o.events)&&void 0!==a&&a.member||e.getType()!==s.Bx.RoomMember||(e.target=t.getSentinelMember(e.getStateKey())),e.isState()&&i&&(e.forwardLooking=!1)}constructor(e){var t,i;this.eventTimelineSet=e,(0,n.A)(this,"roomId",void 0),(0,n.A)(this,"name",void 0),(0,n.A)(this,"events",[]),(0,n.A)(this,"baseIndex",0),(0,n.A)(this,"startState",void 0),(0,n.A)(this,"endState",void 0),(0,n.A)(this,"startToken",null),(0,n.A)(this,"endToken",null),(0,n.A)(this,"prevTimeline",null),(0,n.A)(this,"nextTimeline",null),(0,n.A)(this,"paginationRequests",{[o.Backward]:null,[o.Forward]:null}),this.roomId=null!==(t=null===(i=e.room)||void 0===i?void 0:i.roomId)&&void 0!==t?t:null,this.roomId&&(this.startState=new r.H(this.roomId),this.endState=new r.H(this.roomId)),this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+(new Date).toISOString()}initialiseState(e,{timelineWasEmpty:t}={}){var i,n;if(this.events.length>0)throw new Error("Cannot initialise state after events are added");null===(i=this.startState)||void 0===i||i.setStateEvents(e,{timelineWasEmpty:t}),null===(n=this.endState)||void 0===n||n.setStateEvents(e,{timelineWasEmpty:t})}forkLive(e){const t=this.getState(e),i=new a(this.eventTimelineSet);return i.startState=null==t?void 0:t.clone(),i.endState=t,this.endState=null==t?void 0:t.clone(),i}fork(e){const t=this.getState(e),i=new a(this.eventTimelineSet);return i.startState=null==t?void 0:t.clone(),i.endState=null==t?void 0:t.clone(),i}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(e){if(e==a.BACKWARDS)return this.startState;if(e==a.FORWARDS)return this.endState;throw new Error("Invalid direction '"+e+"'")}getPaginationToken(e){return this.roomId?this.getState(e).paginationToken:e===o.Backward?this.startToken:this.endToken}setPaginationToken(e,t){this.roomId?this.getState(t).paginationToken=e:t===o.Backward?this.startToken=e:this.endToken=e}getNeighbouringTimeline(e){if(e==a.BACKWARDS)return this.prevTimeline;if(e==a.FORWARDS)return this.nextTimeline;throw new Error("Invalid direction '"+e+"'")}setNeighbouringTimeline(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==a.BACKWARDS)this.prevTimeline=e;else{if(t!=a.FORWARDS)throw new Error("Invalid direction '"+t+"'");this.nextTimeline=e}this.setPaginationToken(null,t)}addEvent(e,{toStartOfTimeline:t,roomState:i,timelineWasEmpty:n}={toStartOfTimeline:!1}){i||(i=t?this.startState:this.endState);const r=this.getTimelineSet();var o;r.room&&(a.setEventMetadata(e,i,t),e.isState()&&r.room.getUnfilteredTimelineSet()===r&&(null===(o=i)||void 0===o||o.setStateEvents([e],{timelineWasEmpty:n}),e.sender&&(e.getType()!==s.Bx.RoomMember||t)||a.setEventMetadata(e,i,t)));let c;c=t?0:this.events.length,this.events.splice(c,0,e),t&&this.baseIndex++}insertEvent(e,t,i){const n=this.getTimelineSet();n.room&&(a.setEventMetadata(e,i,!1),e.isState()&&n.room.getUnfilteredTimelineSet()===n&&(i.setStateEvents([e],{}),e.sender&&e.getType()!==s.Bx.RoomMember||a.setEventMetadata(e,i,!1))),this.events.splice(t,0,e)}removeEvent(e){for(let t=this.events.length-1;t>=0;t--){const i=this.events[t];if(i.getId()==e)return this.events.splice(t,1),t<this.baseIndex&&this.baseIndex--,i}return null}toString(){return this.name}}(0,n.A)(a,"BACKWARDS",o.Backward),(0,n.A)(a,"FORWARDS",o.Forward)},"./node_modules/matrix-js-sdk/src/models/event.ts":(e,t,i)=>{"use strict";i.d(t,{OQ:()=>f,fb:()=>g.f,kl:()=>y});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-events-sdk/lib/index.js"),s=i("./node_modules/matrix-js-sdk/src/logger.ts"),o=i("./node_modules/matrix-js-sdk/src/@types/event.ts"),a=i("./node_modules/matrix-js-sdk/src/utils.ts"),c=i("./node_modules/matrix-js-sdk/src/models/thread.ts"),d=i("./node_modules/matrix-js-sdk/src/ReEmitter.ts"),l=i("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),u=i("./node_modules/matrix-js-sdk/src/common-crypto/CryptoBackend.ts"),h=i("./node_modules/matrix-js-sdk/src/crypto/OlmDevice.ts"),m=i("./node_modules/matrix-js-sdk/src/models/event-timeline.ts"),p=i("./node_modules/matrix-js-sdk/src/crypto-api.ts"),g=i("./node_modules/matrix-js-sdk/src/models/event-status.ts");const v=Object.freeze({visible:!0});let f=function(e){return e.Decrypted="Event.decrypted",e.BeforeRedaction="Event.beforeRedaction",e.VisibilityChange="Event.visibilityChange",e.LocalEventIdReplaced="Event.localEventIdReplaced",e.Status="Event.status",e.Replaced="Event.replaced",e.RelationsCreated="Event.relationsCreated",e}({});class y extends l.X{constructor(e={}){var t;super(),this.event=e,(0,n.A)(this,"pushDetails",{}),(0,n.A)(this,"_replacingEvent",null),(0,n.A)(this,"_localRedactionEvent",null),(0,n.A)(this,"_isCancelled",!1),(0,n.A)(this,"clearEvent",void 0),(0,n.A)(this,"visibility",v),(0,n.A)(this,"_hasCachedExtEv",!1),(0,n.A)(this,"_cachedExtEv",void 0),(0,n.A)(this,"_decryptionFailureReason",null),(0,n.A)(this,"senderCurve25519Key",null),(0,n.A)(this,"claimedEd25519Key",null),(0,n.A)(this,"forwardingCurve25519KeyChain",[]),(0,n.A)(this,"untrusted",null),(0,n.A)(this,"decryptionPromise",null),(0,n.A)(this,"retryDecryption",!1),(0,n.A)(this,"txnId",void 0),(0,n.A)(this,"thread",void 0),(0,n.A)(this,"threadId",void 0),(0,n.A)(this,"encryptedDisabledForUnverifiedDevices",!1),(0,n.A)(this,"localTimestamp",void 0),(0,n.A)(this,"sender",null),(0,n.A)(this,"target",null),(0,n.A)(this,"status",null),(0,n.A)(this,"error",null),(0,n.A)(this,"forwardLooking",!0),(0,n.A)(this,"verificationRequest",void 0),(0,n.A)(this,"reEmitter",void 0),["state_key","type","sender","room_id","membership"].forEach((t=>{"string"==typeof e[t]&&(e[t]=(0,a.yD)(e[t]))})),["membership","avatar_url","displayname"].forEach((t=>{var i;"string"==typeof(null===(i=e.content)||void 0===i?void 0:i[t])&&(e.content[t]=(0,a.yD)(e.content[t]))})),["rel_type"].forEach((t=>{var i,n;"string"==typeof(null===(i=e.content)||void 0===i||null===(n=i["m.relates_to"])||void 0===n?void 0:n[t])&&(e.content["m.relates_to"][t]=(0,a.yD)(e.content["m.relates_to"][t]))})),this.txnId=e.txn_id;const i=this.getAge();this.localTimestamp=void 0!==i?Date.now()-i:null!==(t=this.getTs())&&void 0!==t?t:Date.now(),this.reEmitter=new d.Q(this)}get unstableExtensibleEvent(){return this._hasCachedExtEv||(this._cachedExtEv=r.ExtensibleEvents.parse(this.getEffectiveEvent())),this._cachedExtEv}invalidateExtensibleEvent(){this._hasCachedExtEv=!1}getEffectiveEvent(){const e=Object.assign({},this.getContent());if(this.getWireType()===o.Bx.RoomMessageEncrypted)for(const[t,i]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(t)||void 0===e[t]&&(e[t]=i);return Object.assign({},this.event,this.clearEvent,{content:e})}getId(){return this.event.event_id}getSender(){return this.event.sender}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getDetails(){const e=this.getRoomId();var t;if(e)return`id=${this.getId()} type=${this.getWireType()} sender=${this.getSender()} room=${e} ts=${null===(t=this.getDate())||void 0===t?void 0:t.toISOString()}`;return`msgid=${this.getContent()[o.wt]} type=${this.getWireType()} sender=${this.getSender()}`}getOriginalContent(){return this._localRedactionEvent?{}:this.clearEvent?this.clearEvent.content||{}:this.event.content||{}}getContent(){return this._localRedactionEvent?{}:this._replacingEvent?this._replacingEvent.getContent()["m.new_content"]||{}:this.getOriginalContent()}getWireContent(){return this.event.content||{}}get threadRootId(){var e;if(this.isState())return;const t=null===(e=this.getWireContent())||void 0===e?void 0:e["m.relates_to"];if((null==t?void 0:t.rel_type)===c.RN.name)return t.event_id;if(this.thread)return this.thread.id;if(void 0!==this.threadId)return this.threadId;const i=this.getUnsigned();return"string"==typeof i[o.Sr.name]?i[o.Sr.name]:void 0}get isThreadRoot(){if(this.isState())return!1;return!!this.getServerAggregatedRelation(c.RN.name)||this.threadRootId===this.getId()}get replyEventId(){var e,t;return null===(e=this.getWireContent()["m.relates_to"])||void 0===e||null===(t=e["m.in_reply_to"])||void 0===t?void 0:t.event_id}get relationEventId(){var e,t;return null===(e=this.getWireContent())||void 0===e||null===(t=e["m.relates_to"])||void 0===t?void 0:t.event_id}getPrevContent(){return this.getUnsigned().prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.event.state_key}isState(){return void 0!==this.event.state_key}getMembershipAtEvent(){const e=this.getUnsigned();return"string"==typeof e[o.SY.name]?e[o.SY.name]:void 0}makeEncrypted(e,t,i,n){this.clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this.senderCurve25519Key=i,this.claimedEd25519Key=n}isBeingDecrypted(){return null!=this.decryptionPromise}getDecryptionPromise(){return this.decryptionPromise}isDecryptionFailure(){return null!==this._decryptionFailureReason}get decryptionFailureReason(){return this._decryptionFailureReason}get isEncryptedDisabledForUnverifiedDevices(){return this.isDecryptionFailure()&&this.encryptedDisabledForUnverifiedDevices}shouldAttemptDecryption(){return!this.isRedacted()&&(!this.isBeingDecrypted()&&(!this.clearEvent&&!!this.isEncrypted()))}async attemptDecryption(e,t={}){if(!this.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");const i=this.clearEvent&&!this.isDecryptionFailure(),n=t.forceRedecryptIfUntrusted&&this.isKeySourceUntrusted();if(i&&!n)throw new Error("Attempt to decrypt event which has already been decrypted");return this.decryptionPromise?(s.v.log(`Event ${this.getId()} already being decrypted; queueing a retry`),this.retryDecryption=!0,this.decryptionPromise):(this.decryptionPromise=this.decryptionLoop(e,t),this.decryptionPromise)}cancelAndResendKeyRequest(e,t){const i=this.getWireContent();return e.requestRoomKey({algorithm:i.algorithm,room_id:this.getRoomId(),session_id:i.session_id,sender_key:i.sender_key},this.getKeyRequestRecipients(t),!0)}getKeyRequestRecipients(e){return[{userId:e,deviceId:"*"}]}async decryptionLoop(e,t={}){for(await Promise.resolve();;){let i;this.retryDecryption=!1;try{const i=await e.decryptEvent(this);!0===t.isRetry&&s.v.info(`Decrypted event on retry (${this.getDetails()})`),this.setClearData(i),this._decryptionFailureReason=null}catch(e){const t=e instanceof u.O?e.detailedString:String(e);if(i=e,this.retryDecryption){s.v.log(`Error decrypting event (${this.getDetails()}), but retrying: ${t}`);continue}s.v.warn(`Error decrypting event (${this.getDetails()}): ${t}`),this.setClearDataForDecryptionFailure(String(e)),this._decryptionFailureReason=e instanceof u.O?e.code:p.DecryptionFailureCode.UNKNOWN_ERROR}return this.decryptionPromise=null,this.retryDecryption=!1,this.setPushDetails(),void(!1!==t.emit&&this.emit(f.Decrypted,this,i))}}setClearData(e){var t,i;this.clearEvent=e.clearEvent,this.senderCurve25519Key=null!==(t=e.senderCurve25519Key)&&void 0!==t?t:null,this.claimedEd25519Key=null!==(i=e.claimedEd25519Key)&&void 0!==i?i:null,this.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[],this.untrusted=e.untrusted||!1,this.encryptedDisabledForUnverifiedDevices=!1,this.invalidateExtensibleEvent()}setClearDataForDecryptionFailure(e){this.clearEvent={type:o.Bx.RoomMessage,content:{msgtype:"m.bad.encrypted",body:`** Unable to decrypt: ${e} **`}},this.senderCurve25519Key=null,this.claimedEd25519Key=null,this.forwardingCurve25519KeyChain=[],this.untrusted=!1,this.encryptedDisabledForUnverifiedDevices=e===`DecryptionError: ${h.nC["m.unverified"]}`,this.invalidateExtensibleEvent()}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return!this.isState()&&this.event.type===o.Bx.RoomMessageEncrypted}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return this.claimedEd25519Key?{ed25519:this.claimedEd25519Key}:{}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return this.forwardingCurve25519KeyChain}isKeySourceUntrusted(){return!!this.untrusted}getUnsigned(){return this.event.unsigned||{}}setUnsigned(e){this.event.unsigned=e}unmarkLocallyRedacted(){const e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=void 0),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit(f.BeforeRedaction,this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}applyVisibilityEvent(e){var t,i;const n=null===(t=null==e?void 0:e.visible)||void 0===t||t,r=null!==(i=null==e?void 0:e.reason)&&void 0!==i?i:null;let s=!1;this.visibility.visible!==n?s=!0:this.visibility.visible||this.visibility.reason===r||(s=!0),s&&(this.visibility=n?v:Object.freeze({visible:!1,reason:r}),this.emit(f.VisibilityChange,this,n))}messageVisibility(){return this.visibility}makeRedacted(e,t){if(!e.event)throw new Error("invalid redactionEvent in makeRedacted");this._localRedactionEvent=null,this.emit(f.BeforeRedaction,this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event;for(const e in this.event)this.event.hasOwnProperty(e)&&!b.has(e)&&delete this.event[e];this.isEncrypted()&&(this.clearEvent=void 0);const i=this.getType()in S?S[this.getType()]:{},n=this.getContent();for(const e in n)n.hasOwnProperty(e)&&!i[e]&&delete n[e];!this.isThreadRoot&&this.threadRootId&&this.threadRootId!==this.getId()&&(this.moveAllRelatedToMainTimeline(t),e.moveToMainTimeline(t)),this.invalidateExtensibleEvent()}moveAllRelatedToMainTimeline(e){const t=this.thread;if(this.moveToMainTimeline(e),t)for(const n of t.events){var i;(null===(i=n.getRelation())||void 0===i?void 0:i.event_id)===this.getId()&&n.moveAllRelatedToMainTimeline(e)}}moveToMainTimeline(e){var t;null===(t=this.thread)||void 0===t||t.timelineSet.removeEvent(this.getId()),this.setThread(void 0);const i=e.getLiveTimeline();i.getTimelineSet().insertEventIntoTimeline(this,i,i.getState(m.q.FORWARDS))}isRedacted(){return Boolean(this.getUnsigned().redacted_because)}isRedaction(){return this.getType()===o.Bx.RoomRedaction}asVisibilityChange(){if(!o.Yg.matches(this.getType()))return null;const e=this.getRelation();if(!e||"m.reference"!=e.rel_type)return null;const t=e.event_id;if(!t)return null;const i=this.getWireContent(),n=!!i.visible,r=i.reason;return r&&"string"!=typeof r?null:{visible:n,reason:r,eventId:t}}isVisibilityEvent(){return o.Yg.matches(this.getType())}getRedactionEvent(){var e,t,i,n;return this.isRedacted()?null!==(e=this.clearEvent)&&void 0!==e&&e.unsigned?null!==(i=null===(n=this.clearEvent)||void 0===n?void 0:n.unsigned.redacted_because)&&void 0!==i?i:null:null!==(t=this.event.unsigned)&&void 0!==t&&t.redacted_because?this.event.unsigned.redacted_because:{}:null}getPushActions(){return this.pushDetails.actions||null}getPushDetails(){return this.pushDetails}setPushDetails(e,t){this.pushDetails={actions:e,rule:t}}handleRemoteEcho(e){const t=this.getUnsigned(),i=this.getId();this.event=e,t.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=t.redacted_because),this.setStatus(null),this.getId()!==i&&this.emit(f.LocalEventIdReplaced,this),this.localTimestamp=Date.now()-this.getAge()}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit(f.Status,this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit(f.LocalEventIdReplaced,this)}isRelation(e){var t;const i=null===(t=this.getWireContent())||void 0===t?void 0:t["m.relates_to"];return!(this.isState()&&null!=i&&i.rel_type&&[o.zZ.Replace,o.zZ.Thread].includes(i.rel_type))&&!(null==i||!i.rel_type||!i.event_id||e&&i.rel_type!==e)}getRelation(){var e;return this.isRelation()&&null!==(e=this.getWireContent()["m.relates_to"])&&void 0!==e?e:null}makeReplaced(e){this.isRedacted()&&e||this.isState()||this._replacingEvent!==e&&(this._replacingEvent=null!=e?e:null,this.emit(f.Replaced,this),this.invalidateExtensibleEvent())}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){var t;return null===(t=this.getUnsigned()["m.relations"])||void 0===t?void 0:t[e]}replacingEventId(){const e=this.getServerAggregatedRelation(o.zZ.Replace);return e?e.event_id:this._replacingEvent?this._replacingEvent.getId():void 0}replacingEvent(){return this._replacingEvent}replacingEventDate(){const e=this.getServerAggregatedRelation(o.zZ.Replace);if(e){const t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent){var t;return null!==(t=this._replacingEvent.getDate())&&void 0!==t?t:void 0}}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){const e=this.getRelation();return this.replyEventId?this.replyEventId:e?e.event_id:this.isRedaction()?this.event.redacts:void 0}hasAssociation(){return!!this.getAssociatedId()}updateAssociatedId(e){const t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(e=!0){this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){const e=new y(JSON.parse(JSON.stringify(this.event)));for(const[t,i]of Object.entries(this))"event"!==t&&(e[t]=i);return e}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;const t=(0,a.hl)(this.event),i=(0,a.hl)(e.event);return JSON.stringify(t)===JSON.stringify(i)}toJSON(){const e=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}setVerificationRequest(e){this.verificationRequest=e}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}setThread(e){this.isState()||(this.thread&&this.reEmitter.stopReEmitting(this.thread,[c.ju.Update]),this.thread=e,this.setThreadId(null==e?void 0:e.id),e&&this.reEmitter.reEmit(e,[c.ju.Update]))}getThread(){return this.thread}setThreadId(e){this.threadId=e}}const b=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),S={[o.Bx.RoomMember]:{membership:1},[o.Bx.RoomJoinRules]:{join_rule:1},[o.Bx.RoomPowerLevels]:{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1}}},"./node_modules/matrix-js-sdk/src/models/invites-ignorer.ts":(e,t,i)=>{"use strict";i.d(t,{bp:()=>m});var n=i("./node_modules/matrix-events-sdk/lib/index.js"),r=i("./node_modules/matrix-js-sdk/src/models/event-timeline.ts"),s=i("./node_modules/matrix-js-sdk/src/@types/partials.ts"),o=i("./node_modules/matrix-js-sdk/src/utils.ts"),a=i("./node_modules/matrix-js-sdk/src/@types/event.ts");const c=new n.UnstableValue("m.policies","org.matrix.msc3847.policies"),d=new n.UnstableValue("m.ignore.invites","org.matrix.msc3847.ignore.invites");let l=function(e){return e.Ban="m.ban",e}({}),u=function(e){return e.User="m.policy.user",e.Room="m.policy.room",e.Server="m.policy.server",e}({});const h={[u.User]:a.Bx.PolicyRuleUser,[u.Room]:a.Bx.PolicyRuleRoom,[u.Server]:a.Bx.PolicyRuleServer};class m{constructor(e){this.client=e}async addRule(e,t,i){const n=await this.getOrCreateTargetRoom();return(await this.client.sendStateEvent(n.roomId,h[e],{entity:t,reason:i,recommendation:l.Ban})).event_id}async removeRule(e){await this.client.redactEvent(e.getRoomId(),e.getId())}async addSource(e){await this.client.joinRoom(e);const t=(await this.getOrCreateSourceRooms()).map((e=>e.roomId));return!t.includes(e)&&(t.push(e),await this.withIgnoreInvitesPolicies((e=>{e.sources=t})),!0)}async getRuleForInvite({sender:e,roomId:t}){const i=await this.getOrCreateSourceRooms(),n=e.split(":")[1],s=t.split(":")[1];for(const a of i){const i=a.getUnfilteredTimelineSet().getLiveTimeline().getState(r.q.FORWARDS);for(const{scope:r,entities:a}of[{scope:u.Room,entities:[t]},{scope:u.User,entities:[e]},{scope:u.Server,entities:[n,s]}]){const e=i.getStateEvents(h[r]);for(const t of e){const e=t.getContent();if((null==e?void 0:e.recommendation)!=l.Ban)continue;const i=null==e?void 0:e.entity;if(!i)continue;let n;try{n=new RegExp((0,o.dn)(i))}catch(e){continue}for(const e of a)if(e&&n.test(e))return t}}}return null}async getOrCreateTargetRoom(){let e=this.getIgnoreInvitesPolicies().target;if("string"!=typeof e&&(e=null),e){const t=this.client.getRoom(e);if(t)return t;e=null}return e=(await this.client.createRoom({name:"Individual Policy Room",preset:s.k.PrivateChat})).room_id,await this.withIgnoreInvitesPolicies((t=>{t.target=e})),this.client.getRoom(e)}async getOrCreateSourceRooms(){let e=this.getIgnoreInvitesPolicies().sources,t=!1;Array.isArray(e)||(t=!0,e=[]);let i=e.filter((e=>"string"==typeof e)).map((e=>this.client.getRoom(e))).filter((e=>!!e));if(i.length!=e.length&&(t=!0),0==i.length){t=!0,i=[await this.getOrCreateTargetRoom()]}return t&&await this.withIgnoreInvitesPolicies((t=>{t.sources=e})),i}getIgnoreInvitesPolicies(){return this.getPoliciesAndIgnoreInvitesPolicies().ignoreInvitesPolicies}async withIgnoreInvitesPolicies(e){const{policies:t,ignoreInvitesPolicies:i}=this.getPoliciesAndIgnoreInvitesPolicies();e(i),t[d.name]=i,await this.client.setAccountData(c.name,t)}getPoliciesAndIgnoreInvitesPolicies(){let e={};for(const i of[c.name,c.altName]){var t;if(!i)continue;const n=null===(t=this.client.getAccountData(i))||void 0===t?void 0:t.getContent();if(n){e=n;break}}let i={},n=!1;for(const t of[d.name,d.altName]){if(!t)continue;const r=e[t];if(r&&"object"==typeof r){i=r,n=!0;break}}return n||(e[d.name]=i),{policies:e,ignoreInvitesPolicies:i}}}},"./node_modules/matrix-js-sdk/src/models/poll.ts":(e,t,i)=>{"use strict";i.d(t,{Wi:()=>u,sP:()=>l,sn:()=>c});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-events-sdk/lib/index.js"),s=i("./node_modules/matrix-js-sdk/src/@types/polls.ts"),o=i("./node_modules/matrix-js-sdk/src/models/relations.ts"),a=i("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts");let c=function(e){return e.New="Poll.new",e.End="Poll.end",e.Update="Poll.update",e.Responses="Poll.Responses",e.Destroy="Poll.Destroy",e.UndecryptableRelations="Poll.UndecryptableRelations",e}({});const d=(e,t)=>({responseEvents:e.filter((e=>{if(!e.isDecryptionFailure())return s.qN.matches(e.getType())&&e.getTs()<=t}))});class l extends a.X{constructor(e,t,i){if(super(),this.rootEvent=e,this.matrixClient=t,this.room=i,(0,n.A)(this,"roomId",void 0),(0,n.A)(this,"pollEvent",void 0),(0,n.A)(this,"_isFetchingResponses",!1),(0,n.A)(this,"relationsNextBatch",void 0),(0,n.A)(this,"responses",null),(0,n.A)(this,"endEvent",void 0),(0,n.A)(this,"undecryptableRelationEventIds",new Set),(0,n.A)(this,"countUndecryptableEvents",(e=>{const t=e.filter((e=>e.isDecryptionFailure())).map((e=>e.getId())),i=this.undecryptableRelationsCount;this.undecryptableRelationEventIds=new Set([...this.undecryptableRelationEventIds,...t]),this.undecryptableRelationsCount!==i&&this.emit(c.UndecryptableRelations,this.undecryptableRelationsCount)})),!this.rootEvent.getRoomId()||!this.rootEvent.getId())throw new Error("Invalid poll start event.");this.roomId=this.rootEvent.getRoomId(),this.pollEvent=this.rootEvent.unstableExtensibleEvent}get pollId(){return this.rootEvent.getId()}get endEventId(){var e;return null===(e=this.endEvent)||void 0===e?void 0:e.getId()}get isEnded(){return!!this.endEvent}get isFetchingResponses(){return this._isFetchingResponses}get undecryptableRelationsCount(){return this.undecryptableRelationEventIds.size}async getResponses(){return this.responses||this.isFetchingResponses||await this.fetchResponses(),this.responses}onNewRelation(e){var t;if(s.cI.matches(e.getType())&&this.validateEndEvent(e)&&(this.endEvent=e,this.refilterResponsesOnEnd(),this.emit(c.End)),!this.responses)return;const i=(null===(t=this.endEvent)||void 0===t?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:n}=d([e],i);this.countUndecryptableEvents([e]),n.length&&(n.forEach((e=>{this.responses.addEvent(e)})),this.emit(c.Responses,this.responses))}async fetchResponses(){var e,t;this._isFetchingResponses=!0;const i=await this.matrixClient.relations(this.roomId,this.rootEvent.getId(),"m.reference",void 0,{from:this.relationsNextBatch||void 0});await Promise.all(i.events.map((e=>this.matrixClient.decryptEventIfNeeded(e))));const n=this.responses||new o.s("m.reference",s.qN.name,this.matrixClient,[s.qN.altName]),r=i.events.find((e=>s.cI.matches(e.getType())));this.validateEndEvent(r)&&(this.endEvent=r,this.refilterResponsesOnEnd(),this.emit(c.End));const a=(null===(e=this.endEvent)||void 0===e?void 0:e.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:l}=d(i.events,a);l.forEach((e=>{n.addEvent(e)})),this.relationsNextBatch=null!==(t=i.nextBatch)&&void 0!==t?t:void 0,this.responses=n,this.countUndecryptableEvents(i.events),this.relationsNextBatch?this.fetchResponses():this._isFetchingResponses=!1,this.emit(c.Responses,this.responses)}refilterResponsesOnEnd(){var e;if(!this.responses)return;const t=(null===(e=this.endEvent)||void 0===e?void 0:e.getTs())||Number.MAX_SAFE_INTEGER;this.responses.getRelations().forEach((e=>{var i;e.getTs()>t&&(null===(i=this.responses)||void 0===i||i.removeEvent(e))})),this.emit(c.Responses,this.responses)}validateEndEvent(e){if(!e)return!1;if(this.endEvent&&this.endEvent.getTs()<e.getTs())return!1;const t=this.room.currentState,i=e.getSender();return!!i&&(i===this.rootEvent.getSender()||t.maySendRedactionForEvent(this.rootEvent,i))}}const u=e=>{const t=e.getType();return r.M_POLL_START.matches(t)||s.qN.matches(t)||s.cI.matches(t)}},"./node_modules/matrix-js-sdk/src/models/read-receipt.ts":(e,t,i)=>{"use strict";i.d(t,{D:()=>p,h:()=>g});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/@types/read_receipts.ts"),s=i("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),o=i("./node_modules/matrix-js-sdk/src/utils.ts"),a=i("./node_modules/matrix-js-sdk/src/models/event.ts"),c=i("./node_modules/matrix-js-sdk/src/@types/event.ts"),d=i("./node_modules/matrix-js-sdk/src/models/room.ts"),l=i("./node_modules/matrix-js-sdk/src/logger.ts"),u=i("./node_modules/matrix-js-sdk/src/client.ts");function h(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function m(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?h(Object(i),!0).forEach((function(t){(0,n.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):h(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function p(e,t,i,n=!1){return new a.kl({content:{[t.getId()]:{[i]:{[e]:m({ts:t.getTs()},!n&&{thread_id:(0,u.Xb)(t)})}}},type:c.Bx.Receipt,room_id:t.getRoomId()})}class g extends s.X{constructor(...e){super(...e),(0,n.A)(this,"receipts",new o.kG((()=>new Map))),(0,n.A)(this,"receiptCacheByEventId",new Map)}getReadReceiptForUserId(e,t=!1,i=r.L.Read){var n,s;const[o,a]=null!==(n=null===(s=this.receipts.get(i))||void 0===s?void 0:s.get(e))&&void 0!==n?n:[null,null];return t?o:null!=a?a:o}compareReceipts(e,t){var i;return null!==(i=this.getUnfilteredTimelineSet().compareEventOrdering(e.eventId,t.eventId))&&void 0!==i?i:e.data.ts-t.data.ts}getEventReadUpTo(e,t=!1){const i=this.getLatestReceipt(e,t);return i&&this.receiptPointsAtConsistentEvent(i)?i.eventId:null}receiptPointsAtConsistentEvent(e){var t;const i=this.findEventById(e.eventId);if(!i)return!1;if(null===(t=e.data)||void 0===t||!t.thread_id)return!0;if(e.data.thread_id===r.S){if((0,u.fN)(i))return!0}else if(i.threadRootId===e.data.thread_id)return!0;return l.v.warn(`Ignoring receipt because its thread_id (${e.data.thread_id}) disagrees with the thread root (${i.threadRootId}) of the referenced event (event ID = ${e.eventId})`),!1}getLatestReceipt(e,t){var i,n;const s=this.getReadReceiptForUserId(e,t,r.L.Read),o=this.getReadReceiptForUserId(e,t,r.L.ReadPrivate);let a;return null!=s&&s.eventId&&null!=o&&o.eventId&&(a=this.compareReceipts(s,o)),a?null!==(n=a<0?o:s)&&void 0!==n?n:null:null!==(i=null!=o?o:s)&&void 0!==i?i:null}addReceiptToStructure(e,t,i,n,r){var s,o;const a=this.receipts.getOrCreate(t);let c=a.get(i);c||(c=[null,null],a.set(i,c));let d=c[0];var l;r&&(d=null!==(l=c[1])&&void 0!==l?l:c[0]);const u={eventId:e,data:n};if(d){if(this.compareReceipts(d,u)>=0)return}const h=r?c[0]:u,m=r?u:c[1];let p=null;h&&m&&(p=this.getUnfilteredTimelineSet().compareEventOrdering(h.eventId,m.eventId));const g=null===p||p<0,v=null!==(s=c[1])&&void 0!==s?s:c[0];r&&g?c[1]=u:r||(c[0]=u,g||(c[1]=null));if(v!==(null!==(o=c[1])&&void 0!==o?o:c[0])){if(v&&this.receiptCacheByEventId.get(v.eventId)){const e=v.eventId;this.receiptCacheByEventId.set(e,this.receiptCacheByEventId.get(e).filter((e=>e.type!==t||e.userId!==i))),this.receiptCacheByEventId.get(e).length<1&&this.receiptCacheByEventId.delete(e)}this.receiptCacheByEventId.get(e)||this.receiptCacheByEventId.set(e,[]),this.receiptCacheByEventId.get(e).push({userId:i,type:t,data:n})}}getReceiptsForEvent(e){return this.receiptCacheByEventId.get(e.getId())||[]}fixupNotifications(e){const t=this.getReadReceiptForUserId(e,!1),i=this.timeline[this.timeline.length-1];i&&(null==t?void 0:t.eventId)===i.getId()&&e===i.getSender()&&(this.setUnread(d.X5.Total,0),this.setUnread(d.X5.Highlight,0))}addLocalEchoReceipt(e,t,i,n=!1){this.addReceipt(p(e,t,i,n),!0)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter((function(e){return(0,o.ll)(e.type)})).map((function(e){return e.userId}))}}},"./node_modules/matrix-js-sdk/src/models/relations-container.ts":(e,t,i)=>{"use strict";i.d(t,{t:()=>o});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/models/relations.ts"),s=i("./node_modules/matrix-js-sdk/src/models/event.ts");class o{constructor(e,t){this.client=e,this.room=t,(0,n.A)(this,"relations",new Map)}getChildEventsForEvent(e,t,i){var n,r;return null===(n=this.relations.get(e))||void 0===n||null===(r=n.get(t))||void 0===r?void 0:r.get(i)}getAllChildEventsForEvent(e){var t;const i=null!==(t=this.relations.get(e))&&void 0!==t?t:new Map,n=[];for(const e of i.values())for(const t of e.values())n.push(...t.getRelations());return n}aggregateParentEvent(e){const t=this.relations.get(e.getId());if(t)for(const i of t.values())for(const t of i.values())t.setTargetEvent(e)}aggregateChildEvent(e,t){if(e.isRedacted()||e.status===s.fb.CANCELLED)return;const i=e.getRelation();if(!i)return;const n=()=>{e.isDecryptionFailure()?e.once(s.OQ.Decrypted,n):this.aggregateChildEvent(e,t)};if(e.isBeingDecrypted()||e.shouldAttemptDecryption())return void e.once(s.OQ.Decrypted,n);const{event_id:o,rel_type:a}=i,c=e.getType();let d=this.relations.get(o);d||(d=new Map,this.relations.set(o,d));let l=d.get(a);l||(l=new Map,d.set(a,l));let u=l.get(c);if(!u){var h,m,p;u=new r.s(a,c,this.client),l.set(c,u);const e=null!==(h=this.room)&&void 0!==h?h:null==t?void 0:t.room,i=null!==(m=null!==(p=null==t?void 0:t.findEventById(o))&&void 0!==p?p:null==e?void 0:e.findEventById(o))&&void 0!==m?m:null==e?void 0:e.getPendingEvent(o);i&&u.setTargetEvent(i)}u.addEvent(e)}}},"./node_modules/matrix-js-sdk/src/models/relations.ts":(e,t,i)=>{"use strict";i.d(t,{s:()=>l});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/models/event.ts"),s=i("./node_modules/matrix-js-sdk/src/logger.ts"),o=i("./node_modules/matrix-js-sdk/src/@types/event.ts"),a=i("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),c=i("./node_modules/matrix-js-sdk/src/models/room.ts");let d=function(e){return e.Add="Relations.add",e.Remove="Relations.remove",e.Redaction="Relations.redaction",e}({});class l extends a.X{constructor(e,t,i,s){super(),this.relationType=e,this.eventType=t,this.altEventTypes=s,(0,n.A)(this,"relationEventIds",new Set),(0,n.A)(this,"relations",new Set),(0,n.A)(this,"annotationsByKey",{}),(0,n.A)(this,"annotationsBySender",{}),(0,n.A)(this,"sortedAnnotationsByKey",[]),(0,n.A)(this,"targetEvent",null),(0,n.A)(this,"creationEmitted",!1),(0,n.A)(this,"client",void 0),(0,n.A)(this,"onEventStatus",((e,t)=>{e.isSending()?t===r.fb.CANCELLED&&(e.removeListener(r.OQ.Status,this.onEventStatus),this.removeEvent(e)):e.removeListener(r.OQ.Status,this.onEventStatus)})),(0,n.A)(this,"onBeforeRedaction",(async e=>{if(this.relations.has(e)){if(this.relations.delete(e),this.relationType===o.zZ.Annotation)this.removeAnnotationFromAggregation(e);else if(this.relationType===o.zZ.Replace&&this.targetEvent&&!this.targetEvent.isState()){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}e.removeListener(r.OQ.BeforeRedaction,this.onBeforeRedaction),this.emit(d.Redaction,e)}})),this.client=i instanceof c.Wv?i.client:i}async addEvent(e){if(this.relationEventIds.has(e.getId()))return;const t=e.getRelation();if(!t)return void s.v.error("Event must have relation info");const i=t.rel_type,n=e.getType();if(this.relationType===i&&((e,t,i=[])=>[t,...i].includes(e))(n,this.eventType,this.altEventTypes)){if(e.isSending()&&e.on(r.OQ.Status,this.onEventStatus),this.relations.add(e),this.relationEventIds.add(e.getId()),this.relationType===o.zZ.Annotation)this.addAnnotationToAggregation(e);else if(this.relationType===o.zZ.Replace&&this.targetEvent&&!this.targetEvent.isState()){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}e.on(r.OQ.BeforeRedaction,this.onBeforeRedaction),this.emit(d.Add,e),this.maybeEmitCreated()}else s.v.error("Event relation info doesn't match this container")}async removeEvent(e){if(this.relations.has(e)){if(this.relations.delete(e),this.relationType===o.zZ.Annotation)this.removeAnnotationFromAggregation(e);else if(this.relationType===o.zZ.Replace&&this.targetEvent&&!this.targetEvent.isState()){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}this.emit(d.Remove,e)}}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){var t;const{key:i}=null!==(t=e.getRelation())&&void 0!==t?t:{};if(!i)return;let n=this.annotationsByKey[i];n||(n=this.annotationsByKey[i]=new Set,this.sortedAnnotationsByKey.push([i,n])),n.add(e),this.sortedAnnotationsByKey.sort(((e,t)=>{const i=e[1];return t[1].size-i.size}));const r=e.getSender();let s=this.annotationsBySender[r];s||(s=this.annotationsBySender[r]=new Set),s.add(e)}removeAnnotationFromAggregation(e){var t;const{key:i}=null!==(t=e.getRelation())&&void 0!==t?t:{};if(!i)return;const n=this.annotationsByKey[i];n&&(n.delete(e),this.sortedAnnotationsByKey.sort(((e,t)=>{const i=e[1];return t[1].size-i.size})));const r=e.getSender(),s=this.annotationsBySender[r];s&&s.delete(e)}getSortedAnnotationsByKey(){return this.relationType!==o.zZ.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==o.zZ.Annotation?null:this.annotationsBySender}async getLastReplacement(){if(this.relationType!==o.zZ.Replace)return null;if(!this.targetEvent)return null;const e=this.targetEvent.getServerAggregatedRelation(o.zZ.Replace),t=null==e?void 0:e.origin_server_ts,i=this.getRelations().reduce(((e,i)=>i.getSender()!==this.targetEvent.getSender()||t&&t>i.getTs()||e&&e.getTs()>i.getTs()?e:i),null);return null!=i&&i.shouldAttemptDecryption()&&this.client.isCryptoEnabled()?await i.attemptDecryption(this.client.crypto):null!=i&&i.isBeingDecrypted()&&await i.getDecryptionPromise(),i}async setTargetEvent(e){if(!this.targetEvent){if(this.targetEvent=e,this.relationType===o.zZ.Replace&&!this.targetEvent.isState()){const e=await this.getLastReplacement();e&&this.targetEvent.makeReplaced(e)}this.maybeEmitCreated()}}maybeEmitCreated(){this.creationEmitted||this.targetEvent&&this.relations.size&&(this.creationEmitted=!0,this.targetEvent.emit(r.OQ.RelationsCreated,this.relationType,this.eventType))}}},"./node_modules/matrix-js-sdk/src/models/room-member.ts":(e,t,i)=>{"use strict";i.d(t,{Y:()=>u,o:()=>l});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/content-repo.ts"),s=i("./node_modules/matrix-js-sdk/src/utils.ts"),o=i("./node_modules/matrix-js-sdk/src/logger.ts"),a=i("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),c=i("./node_modules/matrix-js-sdk/src/@types/event.ts"),d=i("./node_modules/matrix-js-sdk/src/@types/membership.ts");let l=function(e){return e.Membership="RoomMember.membership",e.Name="RoomMember.name",e.PowerLevel="RoomMember.powerLevel",e.Typing="RoomMember.typing",e}({});class u extends a.X{constructor(e,t){super(),this.roomId=e,this.userId=t,(0,n.A)(this,"_isOutOfBand",!1),(0,n.A)(this,"modified",-1),(0,n.A)(this,"requestedProfileInfo",!1),(0,n.A)(this,"typing",!1),(0,n.A)(this,"name",void 0),(0,n.A)(this,"rawDisplayName",void 0),(0,n.A)(this,"powerLevel",0),(0,n.A)(this,"powerLevelNorm",0),(0,n.A)(this,"user",void 0),(0,n.A)(this,"membership",void 0),(0,n.A)(this,"disambiguate",!1),(0,n.A)(this,"events",{}),this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(e,t){var i,n;const r=null!==(i=e.getDirectionalContent().displayname)&&void 0!==i?i:"";if(e.getType()!==c.Bx.RoomMember)return;this._isOutOfBand=!1,this.events.member=e;const a=this.membership;this.membership=e.getDirectionalContent().membership,void 0===this.membership&&o.v.trace(`membership event with membership undefined (forwardLooking: ${e.forwardLooking})!`,e.getContent(),"prevcontent is ",e.getPrevContent()),this.disambiguate=function(e,t,i){if(!t||t===e)return!1;if(!(0,s.Gp)(t))return!1;if(!i)return!1;if(h.test(t))return!0;if(m.test(t))return!0;const n=i.getUserIdsWithDisplayName(t);return!!n.some((t=>t!==e))}(this.userId,r,t);const d=this.name;this.name=function(e,t,i){return t&&t!==e?i?(0,s.d7)(t)+" ("+e+")":(0,s.Gp)(t)?(0,s.d7)(t):e:e}(this.userId,r,this.disambiguate),this.rawDisplayName=(0,s.d7)(null!==(n=e.getDirectionalContent().displayname)&&void 0!==n?n:""),this.rawDisplayName&&(0,s.Gp)(this.rawDisplayName)||(this.rawDisplayName=this.userId),a!==this.membership&&(this.updateModifiedTime(),this.emit(l.Membership,e,this,a)),d!==this.name&&(this.updateModifiedTime(),this.emit(l.Name,e,this,d))}setPowerLevelEvent(e){if(e.getType()!==c.Bx.RoomPowerLevels||""!==e.getStateKey())return;const t=e.getDirectionalContent();let i=t.users_default||0;const n=t.users||{};Object.values(n).forEach((e=>{i=Math.max(i,e)}));const r=this.powerLevel,s=this.powerLevelNorm;void 0!==n[this.userId]&&Number.isInteger(n[this.userId])?this.powerLevel=n[this.userId]:void 0!==t.users_default?this.powerLevel=t.users_default:this.powerLevel=0,this.powerLevelNorm=0,i>0&&(this.powerLevelNorm=100*this.powerLevel/i),r===this.powerLevel&&s===this.powerLevelNorm||(this.updateModifiedTime(),this.emit(l.PowerLevel,e,this))}setTypingEvent(e){if("m.typing"!==e.getType())return;const t=this.typing;this.typing=!1;const i=e.getContent().user_ids;Array.isArray(i)&&(-1!==i.indexOf(this.userId)&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit(l.Typing,e,this)))}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}isKicked(){return this.membership===d.O.Leave&&void 0!==this.events.member&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){const e=this.events.member;let t=e.getContent(),i=e.getSender();if(t.membership===d.O.Join&&(t=e.getPrevContent(),i=e.getUnsigned().prev_sender),t.membership===d.O.Invite&&t.is_direct)return i}}getAvatarUrl(e,t,i,n,s=!0,o){const a=this.getMxcAvatarUrl();if(!a&&!s)return null;const c=(0,r.y)(e,a,t,i,n,o);return c||null}getMxcAvatarUrl(){return this.events.member?this.events.member.getDirectionalContent().avatar_url:this.user?this.user.avatarUrl:void 0}}const h=/@.+:.+/,m=/[\u200E\u200F\u202A-\u202F]/},"./node_modules/matrix-js-sdk/src/models/room-state.ts":(e,t,i)=>{"use strict";i.d(t,{H:()=>f,f:()=>v});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/models/room-member.ts"),s=i("./node_modules/matrix-js-sdk/src/logger.ts"),o=i("./node_modules/matrix-js-sdk/src/utils.ts"),a=i("./node_modules/matrix-js-sdk/src/@types/event.ts"),c=i("./node_modules/matrix-js-sdk/src/models/event.ts"),d=i("./node_modules/matrix-js-sdk/src/@types/partials.ts"),l=i("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),u=i("./node_modules/matrix-js-sdk/src/models/beacon.ts"),h=i("./node_modules/matrix-js-sdk/src/ReEmitter.ts"),m=i("./node_modules/matrix-js-sdk/src/@types/beacon.ts"),p=i("./node_modules/matrix-js-sdk/src/@types/membership.ts"),g=function(e){return e[e.NotStarted=0]="NotStarted",e[e.InProgress=1]="InProgress",e[e.Finished=2]="Finished",e}(g||{});let v=function(e){return e.Events="RoomState.events",e.Members="RoomState.members",e.NewMember="RoomState.newMember",e.Update="RoomState.update",e.BeaconLiveness="RoomState.BeaconLiveness",e.Marker="RoomState.Marker",e}({});class f extends l.X{constructor(e,t={status:g.NotStarted}){super(),this.roomId=e,this.oobMemberFlags=t,(0,n.A)(this,"reEmitter",new h.Q(this)),(0,n.A)(this,"sentinels",{}),(0,n.A)(this,"displayNameToUserIds",new Map),(0,n.A)(this,"userIdsToDisplayNames",{}),(0,n.A)(this,"tokenToInvite",{}),(0,n.A)(this,"joinedMemberCount",null),(0,n.A)(this,"summaryJoinedMemberCount",null),(0,n.A)(this,"invitedMemberCount",null),(0,n.A)(this,"summaryInvitedMemberCount",null),(0,n.A)(this,"modified",-1),(0,n.A)(this,"members",{}),(0,n.A)(this,"events",new Map),(0,n.A)(this,"paginationToken",null),(0,n.A)(this,"beacons",new Map),(0,n.A)(this,"_liveBeaconIds",[]),this.updateModifiedTime()}getJoinedMemberCount(){return null!==this.summaryJoinedMemberCount?this.summaryJoinedMemberCount:(null===this.joinedMemberCount&&(this.joinedMemberCount=this.getMembers().reduce(((e,t)=>t.membership===p.O.Join?e+1:e),0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return null!==this.summaryInvitedMemberCount?this.summaryInvitedMemberCount:(null===this.invitedMemberCount&&(this.invitedMemberCount=this.getMembers().reduce(((e,t)=>t.membership===p.O.Invite?e+1:e),0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter((t=>!e.includes(t.userId)))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;let t=this.sentinels[e];if(void 0===t){t=new r.Y(this.roomId,e);const i=this.members[e];null!=i&&i.events.member&&t.setMembershipEvent(i.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){if(!this.events.has(e))return void 0===t?[]:null;if(void 0===t)return Array.from(this.events.get(e).values());const i=this.events.get(e).get(t);return i||null}get hasLiveBeacons(){var e;return!(null===(e=this.liveBeaconIds)||void 0===e||!e.length)}get liveBeaconIds(){return this._liveBeaconIds}clone(){const e=new f(this.roomId,this.oobMemberFlags),t=this.oobMemberFlags.status;return this.oobMemberFlags.status=g.NotStarted,Array.from(this.events.values()).forEach((t=>{e.setStateEvents(Array.from(t.values()))})),this.oobMemberFlags.status=t,null!==this.summaryInvitedMemberCount&&e.setInvitedMemberCount(this.getInvitedMemberCount()),null!==this.summaryJoinedMemberCount&&e.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==g.Finished&&this.getMembers().forEach((t=>{var i;t.isOutOfBand()&&(null===(i=e.getMember(t.userId))||void 0===i||i.markOutOfBand())})),e}setUnknownStateEvents(e){const t=e.filter((e=>!this.events.has(e.getType())||!this.events.get(e.getType()).has(e.getStateKey())));this.setStateEvents(t)}setStateEvents(e,t){this.updateModifiedTime(),e.forEach((e=>{if(e.getRoomId()!==this.roomId||!e.isState())return;m.E.matches(e.getType())&&this.setBeacon(e);const t=this.getStateEventMatching(e);var i;(this.setStateEvent(e),e.getType()===a.Bx.RoomMember)&&(this.updateDisplayNameCache(e.getStateKey(),null!==(i=e.getContent().displayname)&&void 0!==i?i:""),this.updateThirdPartyTokenCache(e));this.emit(v.Events,e,this,t)})),this.onBeaconLivenessChange(),e.forEach((e=>{if(e.getRoomId()===this.roomId&&e.isState())if(e.getType()===a.Bx.RoomMember){const t=e.getStateKey();e.getContent().membership!==p.O.Leave&&e.getContent().membership!==p.O.Ban||(e.getContent().avatar_url=e.getContent().avatar_url||e.getPrevContent().avatar_url,e.getContent().displayname=e.getContent().displayname||e.getPrevContent().displayname);const i=this.getOrCreateMember(t,e);i.setMembershipEvent(e,this),this.updateMember(i),this.emit(v.Members,e,this,i)}else if(e.getType()===a.Bx.RoomPowerLevels){if(""!==e.getStateKey())return;Object.values(this.members).forEach((t=>{const i=t.getLastModifiedTime();t.setPowerLevelEvent(e),i!==t.getLastModifiedTime()&&this.emit(v.Members,e,this,t)})),this.sentinels={}}else a.ge.matches(e.getType())&&this.emit(v.Marker,e,t)})),this.emit(v.Update,this)}async processBeaconEvents(e,t){if(!e.length||!this.beacons.size)return;const i=[...this.beacons.values()].reduce(((e,t)=>(e[t.beaconInfoId]=t,e)),{}),n=(e,t)=>{if(!m.z.matches(t.getType()))return;const n=i[e];n&&n.addLocations([t])};for(const s of e){var r;const e=null===(r=s.getRelation())||void 0===r?void 0:r.event_id;if(!e||!i[e])return;if(!m.z.matches(s.getType())&&!s.isEncrypted())return;try{await t.decryptEventIfNeeded(s),n(e,s)}catch{s.isDecryptionFailure()&&s.once(c.OQ.Decrypted,(async()=>{n(e,s)}))}}}getOrCreateMember(e,t){let i=this.members[e];return i||(i=new r.Y(this.roomId,e),this.members[e]=i,this.emit(v.NewMember,t,this,i)),i}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}setBeacon(e){const t=(0,u.M9)(e);if(this.beacons.has(t)){const n=this.beacons.get(t);var i;return e.isRedacted()?void(n.beaconInfoId===(null===(i=e.getRedactionEvent())||void 0===i?void 0:i.redacts)&&(n.destroy(),this.beacons.delete(t))):n.update(e)}if(e.isRedacted())return;const n=new u.HF(e);this.reEmitter.reEmit(n,[u.JH.New,u.JH.Update,u.JH.Destroy,u.JH.LivenessChange]),this.emit(u.JH.New,e,n),n.on(u.JH.LivenessChange,this.onBeaconLivenessChange.bind(this)),n.on(u.JH.Destroy,this.onBeaconLivenessChange.bind(this)),this.beacons.set(n.identifier,n)}onBeaconLivenessChange(){this._liveBeaconIds=Array.from(this.beacons.values()).filter((e=>e.isLive)).map((e=>e.identifier)),this.emit(v.BeaconLiveness,this,this.hasLiveBeacons)}getStateEventMatching(e){var t,i;return null!==(t=null===(i=this.events.get(e.getType()))||void 0===i?void 0:i.get(e.getStateKey()))&&void 0!==t?t:null}updateMember(e){const t=this.getStateEvents(a.Bx.RoomPowerLevels,"");t&&e.setPowerLevelEvent(t),delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===g.NotStarted}outOfBandMembersReady(){return this.oobMemberFlags.status===g.Finished}markOutOfBandMembersStarted(){this.oobMemberFlags.status===g.NotStarted&&(this.oobMemberFlags.status=g.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===g.InProgress&&(this.oobMemberFlags.status=g.NotStarted)}clearOutOfBandMembers(){let e=0;Object.keys(this.members).forEach((t=>{this.members[t].isOutOfBand()&&(++e,delete this.members[t])})),s.v.log(`LL: RoomState removed ${e} members...`),this.oobMemberFlags.status=g.NotStarted}setOutOfBandMembers(e){s.v.log(`LL: RoomState about to set ${e.length} OOB members ...`),this.oobMemberFlags.status===g.InProgress&&(s.v.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=g.Finished,e.forEach((e=>this.setOutOfBandMember(e))),this.emit(v.Update,this))}setOutOfBandMember(e){if(e.getType()!==a.Bx.RoomMember)return;const t=e.getStateKey(),i=this.getMember(t);if(i&&!i.isOutOfBand())return;const n=this.getOrCreateMember(t,e);n.setMembershipEvent(e,this),n.markOutOfBand(),this.updateDisplayNameCache(n.userId,n.name),this.setStateEvent(e),this.updateMember(n),this.emit(v.Members,e,this,n)}setTypingEvent(e){Object.values(this.members).forEach((function(t){t.setTypingEvent(e)}))}getInviteForThreePidToken(e){return this.tokenToInvite[e]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(e){var t;return null!==(t=this.displayNameToUserIds.get((0,o.Gp)(e)))&&void 0!==t?t:[]}maySendRedactionForEvent(e,t){const i=this.getMember(t);if(!i||i.membership===p.O.Leave)return!1;if(e.status||e.isRedacted())return!1;return!!this.maySendEvent(a.Bx.RoomRedaction,t)&&(e.getSender()===t||this.hasSufficientPowerLevelFor("redact",i.powerLevel))}hasSufficientPowerLevelFor(e,t){const i=this.getStateEvents(a.Bx.RoomPowerLevels,"");let n={};i&&(n=i.getContent());let r=50;return(0,o.Et)(n[e])&&(r=n[e]),t>=r}maySendMessage(e){return this.maySendEventOfType(a.Bx.RoomMessage,e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return!(t.isGuest()||!t.credentials.userId)&&this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,i){const n=this.getStateEvents(a.Bx.RoomPowerLevels,"");let r,s={},o=0,c=0,d=0;if(n){r=n.getContent(),s=r.events||{},o=Number.isSafeInteger(r.state_default)?r.state_default:50;const e=r.users&&r.users[t];Number.isSafeInteger(e)?d=e:Number.isSafeInteger(r.users_default)&&(d=r.users_default),Number.isSafeInteger(r.events_default)&&(c=r.events_default)}let l=i?o:c;return Number.isSafeInteger(s[e])&&(l=s[e]),d>=l}mayTriggerNotifOfType(e,t){const i=this.getMember(t);if(!i)return!1;const n=this.getStateEvents(a.Bx.RoomPowerLevels,"");let r=50;return n&&n.getContent()&&n.getContent().notifications&&(0,o.Et)(n.getContent().notifications[e])&&(r=n.getContent().notifications[e]),i.powerLevel>=r}getJoinRule(){var e;const t=this.getStateEvents(a.Bx.RoomJoinRules,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).join_rule||d.dx.Invite}getHistoryVisibility(){var e;const t=this.getStateEvents(a.Bx.RoomHistoryVisibility,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).history_visibility||d.Jv.Shared}getGuestAccess(){var e;const t=this.getStateEvents(a.Bx.RoomGuestAccess,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).guest_access||d.rF.Forbidden}findPredecessor(e=!1){if(e){const e=this.getStateEvents(a.Bx.RoomPredecessor,"");if(e){const t=e.getContent(),i=t.predecessor_room_id;let n=t.last_known_event_id;"string"!=typeof n&&(n=void 0);let r=t.via_servers;if(Array.isArray(r)||(r=void 0),"string"==typeof i)return{roomId:i,eventId:n,viaServers:r}}}const t=this.getStateEvents(a.Bx.RoomCreate,"");if(t){const e=t.getContent().predecessor;if(e){const t=e.room_id;if("string"==typeof t){let i=e.event_id;return"string"==typeof i&&""!==i||(i=void 0),{roomId:t,eventId:i}}}}return null}updateThirdPartyTokenCache(e){if(!e.getContent().third_party_invite)return;const t=(e.getContent().third_party_invite.signed||{}).token;if(!t)return;this.getStateEvents(a.Bx.RoomThirdPartyInvite,t)&&(this.tokenToInvite[t]=e)}updateDisplayNameCache(e,t){const i=this.userIdsToDisplayNames[e];if(delete this.userIdsToDisplayNames[e],i){const t=(0,o.Gp)(i),n=this.displayNameToUserIds.get(t);if(n){const i=n.filter((t=>t!==e));this.displayNameToUserIds.set(t,i)}}this.userIdsToDisplayNames[e]=t;const n=t&&(0,o.Gp)(t);if(n){var r;const t=null!==(r=this.displayNameToUserIds.get(n))&&void 0!==r?r:[];t.push(e),this.displayNameToUserIds.set(n,t)}}}},"./node_modules/matrix-js-sdk/src/models/room-summary.ts":(e,t,i)=>{"use strict";i.d(t,{c:()=>n});class n{constructor(e,t){this.roomId=e}}},"./node_modules/matrix-js-sdk/src/models/room.ts":(e,t,i)=>{"use strict";i.d(t,{X5:()=>F,Wv:()=>$,u9:()=>K});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-events-sdk/lib/index.js"),s=i("./node_modules/matrix-js-sdk/src/models/event-timeline-set.ts"),o=i("./node_modules/matrix-js-sdk/src/models/event-timeline.ts"),a=i("./node_modules/matrix-js-sdk/src/content-repo.ts"),c=i("./node_modules/matrix-js-sdk/src/utils.ts"),d=i("./node_modules/matrix-js-sdk/src/models/event.ts"),l=i("./node_modules/matrix-js-sdk/src/models/event-status.ts"),u=i("./node_modules/matrix-js-sdk/src/models/room-member.ts"),h=i("./node_modules/matrix-js-sdk/src/models/room-summary.ts"),m=i("./node_modules/matrix-js-sdk/src/logger.ts"),p=i("./node_modules/matrix-js-sdk/src/ReEmitter.ts"),g=i("./node_modules/matrix-js-sdk/src/@types/event.ts"),v=i("./node_modules/matrix-js-sdk/src/client.ts"),f=i("./node_modules/matrix-js-sdk/src/filter.ts"),y=i("./node_modules/matrix-js-sdk/src/models/room-state.ts"),b=i("./node_modules/matrix-js-sdk/src/models/beacon.ts"),S=i("./node_modules/matrix-js-sdk/src/models/thread.ts"),w=i("./node_modules/matrix-js-sdk/src/@types/read_receipts.ts"),_=i("./node_modules/matrix-js-sdk/src/models/relations-container.ts"),E=i("./node_modules/matrix-js-sdk/src/models/read-receipt.ts"),I=i("./node_modules/matrix-js-sdk/src/models/poll.ts");class k{constructor(e){(0,n.A)(this,"room",void 0),(0,n.A)(this,"threadedReceipts",void 0),(0,n.A)(this,"unthreadedReceipts",void 0),(0,n.A)(this,"danglingReceipts",void 0),(0,n.A)(this,"onTimelineEvent",(e=>{const t=e.getId();if(!t)return;const i=this.danglingReceipts.remove(t);null==i||i.forEach((e=>{e.receipt.thread_id?this.threadedReceipts.set(e.receipt.thread_id,e.eventId,e.receiptType,e.userId,e.receipt.ts,e.synthetic):this.unthreadedReceipts.set(t,e.receiptType,e.userId,e.receipt.ts,e.synthetic)}))})),this.room=e,this.threadedReceipts=new O(e),this.unthreadedReceipts=new A(e),this.danglingReceipts=new x,e.on(K.Timeline,this.onTimelineEvent)}add(e,t){for(const[i,n]of Object.entries(e))for(const[e,r]of Object.entries(n))for(const[n,s]of Object.entries(r)){this.room.findEventById(i)?s.thread_id?this.threadedReceipts.set(s.thread_id,i,e,n,s.ts,t):this.unthreadedReceipts.set(i,e,n,s.ts,t):this.danglingReceipts.add(new T(i,e,n,s,t))}}hasUserReadEvent(e,t){const i=this.unthreadedReceipts.get(e);if(i&&P(i.eventId,t,this.room))return!0;const n=this.room.findEventById(t);if(!n)return m.v.warn(`hasUserReadEvent event ID ${t} not found in room ${this.room.roomId}: this shouldn't happen!`),!1;const r=(0,v.Xb)(n),s=this.threadedReceipts.get(r,e);return!(!s||!P(s.eventId,t,this.room))||!!this.userSentLatestEventInThread(r,e)}userSentLatestEventInThread(e,t){var i;const n=e===w.S?this.room.getLiveTimeline().getEvents():null===(i=this.room.getThread(e))||void 0===i?void 0:i.timeline;return!!(n&&n.length>0&&n[n.length-1].getSender()===t)}}class R{constructor(e,t,i){this.eventId=e,this.receiptType=t,this.ts=i}}class T{constructor(e,t,i,n,r){this.eventId=e,this.receiptType=t,this.userId=i,this.receipt=n,this.synthetic=r}}class C{constructor(e){(0,n.A)(this,"room",void 0),(0,n.A)(this,"real",void 0),(0,n.A)(this,"synthetic",void 0),this.room=e,this.real=void 0,this.synthetic=void 0}set(e,t){e?this.synthetic=t:this.real=t,this.synthetic&&this.real&&P(this.real.eventId,this.synthetic.eventId,this.room)&&(this.synthetic=void 0)}get(){var e;return null!==(e=this.synthetic)&&void 0!==e?e:this.real}getByType(e){return e?this.synthetic:this.real}}class A{constructor(e){(0,n.A)(this,"room",void 0),(0,n.A)(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,i,n,r){const s=M(this.data,i,(()=>new C(this.room))),o=s.getByType(r);o&&function(e,t,i){const n=i.compareEventOrdering(e,t);return null!==n&&n>0}(o.eventId,e,this.room)||s.set(r,new R(e,t,n))}get(e){var t;return null===(t=this.data.get(e))||void 0===t?void 0:t.get()}}class O{constructor(e){(0,n.A)(this,"room",void 0),(0,n.A)(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,i,n,r,s){M(this.data,e,(()=>new A(this.room))).set(t,i,n,r,s)}get(e,t){var i;return null===(i=this.data.get(e))||void 0===i?void 0:i.get(t)}}class x{constructor(){(0,n.A)(this,"data",new Map)}add(e){M(this.data,e.eventId,(()=>[])).push(e)}remove(e){const t=this.data.get(e);return this.data.delete(e),t}}function M(e,t,i){const n=e.get(t);if(n)return n;{const n=i();return e.set(t,n),n}}function P(e,t,i){const n=i.compareEventOrdering(e,t);return null!==n&&n>=0}function j(e,t,i){const n=e.findEventById(t),r=e.findEventById(i);if(!n||!r)return null;const s=(0,v.fN)(n),o=(0,v.fN)(r);return s&&o?function(e,t,i,n,r){const s=e.getUnfilteredTimelineSet(),o=s.compareEventOrdering(t,i);if(null!==o)return o;const a=s.getTimelineForEvent(t);if(a===s.getLiveTimeline())return 1;const c=s.getTimelineForEvent(i);if(c===s.getLiveTimeline())return-1;return D(n,r)}(e,t,i,n,r):function(e,t,i,n){const r=(0,v.Xb)(i),s=(0,v.Xb)(n),o=i.getThread();return o&&r===s?o.timelineSet.compareEventOrdering(e,t):D(i,n)}(t,i,n,r)}function D(e,t){const i=e.getTs(),n=t.getTs();return i<n?-1:i>n?1:0}var U=i("./node_modules/matrix-js-sdk/src/@types/membership.ts");function L(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function N(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?L(Object(i),!0).forEach((function(t){(0,n.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):L(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const B=["1","2","3","4","5","6","7","8","9","10"];let F=function(e){return e.Highlight="highlight",e.Total="total",e}({}),K=function(e){return e.MyMembership="Room.myMembership",e.Tags="Room.tags",e.AccountData="Room.accountData",e.Receipt="Room.receipt",e.Name="Room.name",e.Redaction="Room.redaction",e.RedactionCancelled="Room.redactionCancelled",e.LocalEchoUpdated="Room.localEchoUpdated",e.Timeline="Room.timeline",e.TimelineReset="Room.timelineReset",e.TimelineRefresh="Room.TimelineRefresh",e.OldStateUpdated="Room.OldStateUpdated",e.CurrentStateUpdated="Room.CurrentStateUpdated",e.HistoryImportedWithinTimeline="Room.historyImportedWithinTimeline",e.UnreadNotifications="Room.UnreadNotifications",e.Summary="Room.Summary",e}({});class $ extends E.h{constructor(e,t,i,r={}){super(),this.roomId=e,this.client=t,this.myUserId=i,this.opts=r,(0,n.A)(this,"reEmitter",void 0),(0,n.A)(this,"txnToEvent",new Map),(0,n.A)(this,"notificationCounts",{}),(0,n.A)(this,"threadNotifications",new Map),(0,n.A)(this,"cachedThreadReadReceipts",new Map),(0,n.A)(this,"oldestThreadedReceiptTs",1/0),(0,n.A)(this,"unthreadedReceipts",new Map),(0,n.A)(this,"timelineSets",void 0),(0,n.A)(this,"polls",new Map),(0,n.A)(this,"threadsTimelineSets",[]),(0,n.A)(this,"filteredTimelineSets",{}),(0,n.A)(this,"timelineNeedsRefresh",!1),(0,n.A)(this,"pendingEventList",void 0),(0,n.A)(this,"blacklistUnverifiedDevices",void 0),(0,n.A)(this,"selfMembership",void 0),(0,n.A)(this,"summaryHeroes",null),(0,n.A)(this,"getTypeWarning",!1),(0,n.A)(this,"getVersionWarning",!1),(0,n.A)(this,"membersPromise",void 0),(0,n.A)(this,"name",void 0),(0,n.A)(this,"normalizedName",void 0),(0,n.A)(this,"tags",{}),(0,n.A)(this,"accountData",new Map),(0,n.A)(this,"summary",null),(0,n.A)(this,"oldState",void 0),(0,n.A)(this,"currentState",void 0),(0,n.A)(this,"relations",new _.t(this.client,this)),(0,n.A)(this,"threads",new Map),(0,n.A)(this,"visibilityEvents",new Map),(0,n.A)(this,"roomReceipts",new k(this)),(0,n.A)(this,"threadTimelineSetsPromise",null),(0,n.A)(this,"threadsReady",!1),(0,n.A)(this,"updateThreadRootEvents",((e,t,i)=>{var n,r;e.length&&(this.updateThreadRootEvent(null===(n=this.threadsTimelineSets)||void 0===n?void 0:n[0],e,t,i),e.hasCurrentUserParticipated&&this.updateThreadRootEvent(null===(r=this.threadsTimelineSets)||void 0===r?void 0:r[1],e,t,i))})),(0,n.A)(this,"updateThreadRootEvent",((e,t,i,n)=>{e&&t.rootEvent&&(n&&e.removeEvent(t.id),S.jV.hasServerSideSupport?e.addLiveEvent(t.rootEvent,{duplicateStrategy:s.x.Replace,fromCache:!1,roomState:this.currentState}):e.addEventToTimeline(t.rootEvent,e.getLiveTimeline(),{toStartOfTimeline:i}))})),(0,n.A)(this,"applyRedaction",(e=>{if(e.isRedaction()){const t=e.event.redacts,i=t?this.findEventById(t):void 0;if(i){const n=i.threadRootId;if(i.makeRedacted(e,this),i.isState()){const e=this.currentState.getStateEvents(i.getType(),i.getStateKey());(null==e?void 0:e.getId())===i.getId()&&this.currentState.setStateEvents([i])}this.emit(K.Redaction,e,this,n),this.visibilityEvents.delete(t),i.isVisibilityEvent()&&this.redactVisibilityChangeEvent(e)}}})),this.setMaxListeners(100),this.reEmitter=new p.Q(this),r.pendingEventOrdering=r.pendingEventOrdering||v.eO.Chronological,this.name=e,this.normalizedName=e,this.on(K.Receipt,this.onReceipt),this.timelineSets=[new s.m(this,r)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),[K.Timeline,K.TimelineReset]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===v.eO.Detached&&(this.pendingEventList=[],this.client.store.getPendingEvents(this.roomId).then((e=>{const i=this.client.getEventMapper({toDevice:!1,decrypt:!1});e.forEach((async e=>{const n=i(e);await t.decryptEventIfNeeded(n),n.setStatus(l.f.NOT_SENT),this.addPendingEvent(n,n.getTxnId())}))}))),this.opts.lazyLoadMembers?this.membersPromise=void 0:this.membersPromise=Promise.resolve(!1)}async createThreadsTimelineSets(){var e;if(this.threadTimelineSetsPromise)return this.threadTimelineSetsPromise;if(null!==(e=this.client)&&void 0!==e&&e.supportsThreads())try{this.threadTimelineSetsPromise=Promise.all([this.createThreadTimelineSet(),this.createThreadTimelineSet(S.x3.My)]);const e=await this.threadTimelineSetsPromise;return this.threadsTimelineSets[0]=e[0],this.threadsTimelineSets[1]=e[1],e}catch(e){return this.threadTimelineSetsPromise=null,null}return null}async decryptCriticalEvents(){if(!this.client.isCryptoEnabled())return;const e=this.getEventReadUpTo(this.client.getUserId(),!0),t=this.getLiveTimeline().getEvents(),i=t.findIndex((t=>t.event.event_id===e)),n=t.slice(i).reverse().map((e=>this.client.decryptEventIfNeeded(e)));await Promise.allSettled(n)}async decryptAllEvents(){if(!this.client.isCryptoEnabled())return;const e=this.getUnfilteredTimelineSet().getLiveTimeline().getEvents().slice(0).reverse().map((e=>this.client.decryptEventIfNeeded(e)));await Promise.allSettled(e)}getCreator(){var e;const t=this.currentState.getStateEvents(g.Bx.RoomCreate,"");return null!==(e=null==t?void 0:t.getSender())&&void 0!==e?e:null}getVersion(){var e;const t=this.currentState.getStateEvents(g.Bx.RoomCreate,"");return t?null!==(e=t.getContent().room_version)&&void 0!==e?e:"1":(this.getVersionWarning||(m.v.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1")}async getRecommendedVersion(){let e=(await this.client.getCapabilities())["m.room_versions"];if(!e){e={default:"10",available:{}};for(const t of B)e.available[t]=v.L$.Stable}let t=this.checkVersionAgainstCapability(e);if(t.urgent&&t.needsUpgrade){m.v.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about.");if(e=(await this.client.getCapabilities(!0))["m.room_versions"],!e)return m.v.warn("No room version capability - assuming upgrade required."),t;t=this.checkVersionAgainstCapability(e)}return t}checkVersionAgainstCapability(e){const t=this.getVersion();m.v.log(`[${this.roomId}] Current version: ${t}`),m.v.log(`[${this.roomId}] Version capability: `,e);const i={version:t,needsUpgrade:!1,urgent:!1};if(t===e.default)return i;return Object.keys(e.available).filter((t=>"stable"===e.available[t])).includes(t)||(i.version=e.default,i.needsUpgrade=!0,i.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),i.urgent?m.v.warn(`URGENT upgrade required on ${this.roomId}`):m.v.warn(`Non-urgent upgrade required on ${this.roomId}`)),i}userMayUpgradeRoom(e){return this.currentState.maySendStateEvent(g.Bx.RoomTombstone,e)}getPendingEvents(){if(!this.pendingEventList)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(e){if(!this.pendingEventList)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);const t=(0,c.Nz)(this.pendingEventList,(function(t){return t.getId()==e}),!1);return this.savePendingEvents(),t}hasPendingEvent(e){var t,i;return null!==(t=null===(i=this.pendingEventList)||void 0===i?void 0:i.some((t=>t.getId()===e)))&&void 0!==t&&t}getPendingEvent(e){var t,i;return null!==(t=null===(i=this.pendingEventList)||void 0===i?void 0:i.find((t=>t.getId()===e)))&&void 0!==t?t:null}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}get timeline(){return this.getLiveTimeline().getEvents()}getLastActiveTimestamp(){const e=this.getLiveTimeline().getEvents();if(e.length){return e[e.length-1].getTs()}return Number.MIN_SAFE_INTEGER}getLastLiveEvent(){var e,t;const i=this.getLiveTimeline().getEvents(),n=i[i.length-1],r=this.getLastThread();if(!r)return n;const s=r.events[r.events.length-1];return(null!==(e=null==n?void 0:n.getTs())&&void 0!==e?e:0)>(null!==(t=null==s?void 0:s.getTs())&&void 0!==t?t:0)?n:s}getLastThread(){return this.getThreads().reduce(((e,t)=>{var i,n;if(!e)return t;const r=t.events[t.events.length-1],s=e.events[e.events.length-1];return(null!==(i=null==r?void 0:r.getTs())&&void 0!==i?i:0)>=(null!==(n=null==s?void 0:s.getTs())&&void 0!==n?n:0)?t:e}),void 0)}getMyMembership(){var e;return null!==(e=this.selfMembership)&&void 0!==e?e:U.O.Leave}getDMInviter(){const e=this.getMember(this.myUserId);if(e)return e.getDMInviter();if(this.selfMembership===U.O.Invite){var t;if(2===this.getInvitedAndJoinedMemberCount())return null===(t=this.summaryHeroes)||void 0===t?void 0:t[0]}}guessDMUserId(){const e=this.getMember(this.myUserId);if(e){const t=e.getDMInviter();if(t)return t}if(Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length)return this.summaryHeroes[0];const t=this.currentState.getMembers().find((e=>e.userId!==this.myUserId));return t?t.userId:this.myUserId}getFunctionalMembers(){const e=this.currentState.getStateEvents(g.Ng.name,"");return Array.isArray(null==e?void 0:e.getContent().service_members)?e.getContent().service_members:[]}getAvatarFallbackMember(){var e;const t=this.getFunctionalMembers();let i=0;if(this.getMembers().forEach((e=>{"join"!==e.membership&&"invite"!==e.membership||t.includes(e.userId)||i++})),i>2)return;const n=null===(e=this.summaryHeroes)||void 0===e?void 0:e.filter((e=>!t.includes(e))),r=Array.isArray(n)&&n.length;if(r){const e=n.map((e=>this.getMember(e))).find((e=>!!e));if(e)return e}const s=this.getMembers(),o=null==s?void 0:s.filter((e=>!t.includes(e.userId)));if(o.length<=2){const e=o.find((e=>e.userId!==this.myUserId));if(e)return e}if(r){const e=n.map((e=>this.client.getUser(e))).find((e=>!!e));if(e){const t=new u.Y(this.roomId,e.userId);return t.user=e,t}}}updateMyMembership(e){const t=this.selfMembership;this.selfMembership=e,t!==e&&(e===U.O.Leave&&this.cleanupAfterLeaving(),this.emit(K.MyMembership,this,e,t))}async loadMembersFromServer(){const e=this.client.store.getSyncToken();return(await this.client.members(this.roomId,void 0,U.O.Leave,null!=e?e:void 0)).chunk}async loadMembers(){let e=!1,t=await this.client.store.getOutOfBandMembers(this.roomId);(null===t||this.hasEncryptionStateEvent())&&(e=!0,t=await this.loadMembersFromServer(),m.v.log(`LL: got ${t.length} members from server for room ${this.roomId}`));return{memberEvents:t.filter(c.O5).map(this.client.getEventMapper()),fromServer:e}}membersLoaded(){return!this.opts.lazyLoadMembers||this.currentState.outOfBandMembersReady()}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();const e=this.loadMembers().then((e=>(this.currentState.setOutOfBandMembers(e.memberEvents),e.fromServer))).catch((e=>{throw this.membersPromise=void 0,this.currentState.markOutOfBandMembersFailed(),e}));return e.then((e=>{if(e){const e=this.currentState.getMembers().filter((e=>e.isOutOfBand())).map((e=>{var t;return null===(t=e.events.member)||void 0===t?void 0:t.event}));m.v.log(`LL: telling store to write ${e.length} members for room ${this.roomId}`);return this.client.store.setOutOfBandMembers(this.roomId,e).catch((e=>{m.v.log("LL: storing OOB room members failed, oh well",e)}))}})).catch((e=>{m.v.error(e)})),this.membersPromise=e,this.membersPromise}async clearLoadedMembersIfNeeded(){this.opts.lazyLoadMembers&&this.membersPromise&&(await this.loadMembersIfNeeded(),await this.client.store.clearOutOfBandMembers(this.roomId),this.currentState.clearOutOfBandMembers(),this.membersPromise=void 0)}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch((e=>{m.v.error(`error after clearing loaded members from room ${this.roomId} after leaving`),m.v.log(e)}))}async refreshLiveTimeline(){const e=this.getLiveTimeline(),t=e.getPaginationToken(o.q.FORWARDS),i=e.getPaginationToken(o.q.BACKWARDS),n=e.getEvents(),r=n[n.length-1];m.v.log(`[refreshLiveTimeline for ${this.roomId}] at mostRecentEventInTimeline=${r&&r.getId()} liveTimelineBefore=${e.toString()} forwardPaginationToken=${t} backwardPaginationToken=${i}`);const s=this.getUnfilteredTimelineSet();let a;r?(this.resetLiveTimeline(null,null),this.emit(K.TimelineRefresh,this,s),a=await this.client.getEventTimeline(s,r.getId())):a=await this.client.getLatestTimeline(s);const c=s.getLiveTimeline();!c||null===c.getPaginationToken(o.O.Forward)&&null===c.getPaginationToken(o.O.Backward)&&0===c.getEvents().length?(m.v.log(`[refreshLiveTimeline for ${this.roomId}] using our new live timeline`),a.setPaginationToken(t,o.q.FORWARDS),s.setLiveTimeline(a),this.fixUpLegacyTimelineFields()):m.v.log(`[refreshLiveTimeline for ${this.roomId}] \`/sync\` or some other request beat us to creating a new live timeline after we reset it. We'll use that instead since any events in the scrollback from this timeline will include the history.`),this.setTimelineNeedsRefresh(!1),this.emit(K.TimelineRefresh,this,s)}resetLiveTimeline(e,t){for(const i of this.timelineSets)i.resetLiveTimeline(null!=e?e:void 0,null!=t?t:void 0);for(const i of this.threads.values())i.resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){const e=this.oldState,t=this.currentState;this.oldState=this.getLiveTimeline().getState(o.q.BACKWARDS),this.currentState=this.getLiveTimeline().getState(o.q.FORWARDS),e!==this.oldState&&this.emit(K.OldStateUpdated,this,e,this.oldState),t!==this.currentState&&(this.emit(K.CurrentStateUpdated,this,t,this.currentState),this.reEmitter.stopReEmitting(t,[y.f.Events,y.f.Members,y.f.NewMember,y.f.Update,y.f.Marker,b.JH.New,b.JH.Update,b.JH.Destroy,b.JH.LivenessChange]),this.reEmitter.reEmit(this.currentState,[y.f.Events,y.f.Members,y.f.NewMember,y.f.Update,y.f.Marker,b.JH.New,b.JH.Update,b.JH.Destroy,b.JH.LivenessChange]))}onReceipt(e){this.hasEncryptionStateEvent()&&this.clearNotificationsOnReceipt(e)}clearNotificationsOnReceipt(e){let t=[],i=!1;const n=e.getContent();for(const e of Object.values(n))for(const[n,r]of Object.entries(e))if(c.ll(n)&&r)for(const[e,n]of Object.entries(r)){if(!n||"object"!=typeof n)continue;const r=n;e===this.client.getUserId()&&(void 0===r.thread_id?i=!0:"string"==typeof r.thread_id&&t.push(r.thread_id))}i&&(t=this.getThreads().filter((e=>this.getThreadUnreadNotificationCount(e.id,F.Total)>0||this.getThreadUnreadNotificationCount(e.id,F.Highlight)>0)).map((e=>e.id)),t.push("main"));for(const e of t){var r;const t=20,i="main"===e?this.getLiveTimeline():null===(r=this.getThread(e))||void 0===r?void 0:r.liveTimeline;if(!i){m.v.warn(`Couldn't find timeline for thread ID ${e} in room ${this.roomId}`);continue}const n=i.getEvents();let o=0;for(let e=n.length-1;e>=0;e--){var s;if(e===n.length-t)return;const i=n[e];if(this.hasUserReadEvent(this.client.getUserId(),i.getId()))break;const r=this.client.getPushActionsForEvent(i);o+=null!=r&&null!==(s=r.tweaks)&&void 0!==s&&s.highlight?1:0}"main"===e?this.setUnreadNotificationCount(F.Highlight,o):this.setThreadUnreadNotificationCount(e,F.Highlight,o)}}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){const t=this.findEventById(e),i=this.findThreadForEvent(t);return i?i.timelineSet.getTimelineForEvent(e):this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}setTimelineNeedsRefresh(e){this.timelineNeedsRefresh=e}getTimelineNeedsRefresh(){return this.timelineNeedsRefresh}findEventById(e){let t=this.getUnfilteredTimelineSet().findEventById(e);if(!t){const i=this.getThreads();for(let n=0;n<i.length;n++){if(t=i[n].findEventById(e),t)return t}}return t}getUnreadNotificationCount(e=F.Total){let t=this.getRoomUnreadNotificationCount(e);for(const n of this.threadNotifications.values()){var i;t+=null!==(i=n[e])&&void 0!==i?i:0}return t}getUnreadCountForEventContext(e=F.Total,t){var i;return null!==(i=!!t.threadRootId&&!t.isThreadRoot?this.getThreadUnreadNotificationCount(t.threadRootId,e):this.getRoomUnreadNotificationCount(e))&&void 0!==i?i:0}getRoomUnreadNotificationCount(e=F.Total){var t;return null!==(t=this.notificationCounts[e])&&void 0!==t?t:0}getThreadUnreadNotificationCount(e,t=F.Total){var i,n;return null!==(i=null===(n=this.threadNotifications.get(e))||void 0===n?void 0:n[t])&&void 0!==i?i:0}hasThreadUnreadNotification(){for(const i of this.threadNotifications.values()){var e,t;if((null!==(e=i.highlight)&&void 0!==e?e:0)>0||(null!==(t=i.total)&&void 0!==t?t:0)>0)return!0}return!1}setThreadUnreadNotificationCount(e,t,i){var n,r;const s=N({highlight:null===(n=this.threadNotifications.get(e))||void 0===n?void 0:n.highlight,total:null===(r=this.threadNotifications.get(e))||void 0===r?void 0:r.total},{[t]:i});this.threadNotifications.set(e,s),this.emit(K.UnreadNotifications,s,e)}get threadsAggregateNotificationType(){let e=null;for(const n of this.threadNotifications.values()){var t,i;if((null!==(t=n.highlight)&&void 0!==t?t:0)>0)return F.Highlight;(null!==(i=n.total)&&void 0!==i?i:0)>0&&!e&&(e=F.Total)}return e}resetThreadUnreadNotificationCountFromSync(e=[]){const t=this.hasEncryptionStateEvent();for(const[i,n]of this.threadNotifications)e.includes(i)||(n.total=0,t||(n.highlight=0));this.emit(K.UnreadNotifications)}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t,this.emit(K.UnreadNotifications,this.notificationCounts)}setUnread(e,t){return this.setUnreadNotificationCount(e,t)}setSummary(e){const t=e["m.heroes"],i=e["m.joined_member_count"],n=e["m.invited_member_count"];Number.isInteger(i)&&this.currentState.setJoinedMemberCount(i),Number.isInteger(n)&&this.currentState.setInvitedMemberCount(n),Array.isArray(t)&&(this.summaryHeroes=t.filter((e=>e!==this.myUserId))),this.emit(K.Summary,e)}setBlacklistUnverifiedDevices(e){this.blacklistUnverifiedDevices=e}getBlacklistUnverifiedDevices(){return void 0===this.blacklistUnverifiedDevices?null:this.blacklistUnverifiedDevices}getAvatarUrl(e,t,i,n,r=!0){const s=this.currentState.getStateEvents(g.Bx.RoomAvatar,"");if(!s&&!r)return null;const o=s?s.getContent().url:null;return o?(0,a.y)(e,o,t,i,n):null}getMxcAvatarUrl(){var e,t;return(null===(e=this.currentState.getStateEvents(g.Bx.RoomAvatar,""))||void 0===e||null===(t=e.getContent())||void 0===t?void 0:t.url)||null}getCanonicalAlias(){const e=this.currentState.getStateEvents(g.Bx.RoomCanonicalAlias,"");return e&&e.getContent().alias||null}getAltAliases(){const e=this.currentState.getStateEvents(g.Bx.RoomCanonicalAlias,"");return e&&e.getContent().alt_aliases||[]}addEventsToTimeline(e,t,i,n){i.getTimelineSet().addEventsToTimeline(e,t,i,n)}getThread(e){var t;return null!==(t=this.threads.get(e))&&void 0!==t?t:null}getThreads(){return Array.from(this.threads.values())}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership(U.O.Join)}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter((function(t){return t.membership===e}))}async getEncryptionTargetMembers(){await this.loadMembersIfNeeded();let e=this.getMembersWithMembership(U.O.Join);return this.shouldEncryptForInvitedMembers()&&(e=e.concat(this.getMembersWithMembership(U.O.Invite))),e}shouldEncryptForInvitedMembers(){var e;const t=this.currentState.getStateEvents(g.Bx.RoomHistoryVisibility,"");return"joined"!==(null==t||null===(e=t.getContent())||void 0===e?void 0:e.history_visibility)}getDefaultRoomName(e){return this.calculateRoomName(e,!0)}hasMembershipState(e,t){const i=this.getMember(e);return!!i&&i.membership===t}getOrCreateFilteredTimelineSet(e,{prepopulateTimeline:t=!0,useSyncEvents:i=!0,pendingEvents:n=!0}={}){if(this.filteredTimelineSets[e.filterId])return this.filteredTimelineSets[e.filterId];const r=Object.assign({filter:e,pendingEvents:n},this.opts),a=new s.m(this,r);this.reEmitter.reEmit(a,[K.Timeline,K.TimelineReset]),i&&(this.filteredTimelineSets[e.filterId]=a,this.timelineSets.push(a));const c=this.getLiveTimeline();if(t){c.getEvents().forEach((function(e){a.addLiveEvent(e)}));let e=c;for(;e.getNeighbouringTimeline(o.q.BACKWARDS);)e=e.getNeighbouringTimeline(o.q.BACKWARDS);a.getLiveTimeline().setPaginationToken(e.getPaginationToken(o.q.BACKWARDS),o.q.BACKWARDS)}else if(i){const e=c.getPaginationToken(o.O.Forward);a.getLiveTimeline().setPaginationToken(e,o.O.Backward)}return a}async getThreadListFilter(e=S.x3.All){const t=this.client.getUserId(),i=new f.d(t),n={room:{timeline:{[S.H.name]:[S.RN.name]}}};e===S.x3.My&&(n.room.timeline[S.o1.name]=[t]),i.setDefinition(n);const r=await this.client.getOrCreateFilter(`THREAD_PANEL_${this.roomId}_${e}`,i);return i.filterId=r,i}async createThreadTimelineSet(e){let t;if(S.jV.hasServerSideListSupport)t=new s.m(this,N(N({},this.opts),{},{pendingEvents:!1}),void 0,void 0,null!=e?e:S.x3.All),this.reEmitter.reEmit(t,[K.Timeline,K.TimelineReset]);else if(S.jV.hasServerSideSupport){const i=await this.getThreadListFilter(e);t=this.getOrCreateFilteredTimelineSet(i,{prepopulateTimeline:!1,useSyncEvents:!1,pendingEvents:!1})}else t=new s.m(this,{pendingEvents:!1}),Array.from(this.threads).forEach((([,i])=>{if(0===i.length)return;const n=i.timeline.some((e=>e.getSender()===this.client.getUserId()));(e!==S.x3.My||n)&&t.getLiveTimeline().addEvent(i.rootEvent,{toStartOfTimeline:!1})}));return t}processThreadRoots(e,t){if(this.client.supportsThreads())for(const i of e)o.q.setEventMetadata(i,this.currentState,t),this.getThread(i.getId())||this.createThread(i.getId(),i,[],t)}async fetchRoomThreads(){if(!this.threadsReady&&this.client.supportsThreads()){if(S.jV.hasServerSideListSupport)await Promise.all([this.fetchRoomThreadList(S.x3.All),this.fetchRoomThreadList(S.x3.My)]);else{const i=await this.getThreadListFilter(),{chunk:n}=await this.client.createMessagesRequest(this.roomId,"",Number.MAX_SAFE_INTEGER,o.O.Backward,i);if(!n.length)return;const r=n.map(this.client.getEventMapper()).sort(((e,t)=>{const i=e.getServerAggregatedRelation(S.RN.name),n=t.getServerAggregatedRelation(S.RN.name);return i.latest_event.origin_server_ts-n.latest_event.origin_server_ts}));let a;const c=this.getLiveTimeline().getState(o.q.FORWARDS);for(const i of r){var e;const n={duplicateStrategy:s.x.Ignore,fromCache:!1,roomState:c};null===(e=this.threadsTimelineSets[0])||void 0===e||e.addLiveEvent(i,n);const r=i.getServerAggregatedRelation(S.RN.name);var t;if(null!=r&&r.current_user_participated)null===(t=this.threadsTimelineSets[1])||void 0===t||t.addLiveEvent(i,n),a=i}this.processThreadRoots(r,!0),this.client.decryptEventIfNeeded(r[r.length-1]),a&&this.client.decryptEventIfNeeded(a)}this.on(S.ju.NewReply,this.onThreadReply),this.on(S.ju.Update,this.onThreadUpdate),this.on(S.ju.Delete,this.onThreadDelete),this.threadsReady=!0}}async processPollEvents(e){for(const t of e)try{if(!t.isEncrypted()&&!(0,I.Wi)(t))continue;await this.client.decryptEventIfNeeded(t),this.processPollEvent(t)}catch(e){m.v.warn("Error processing poll event",t.getId(),e)}}async processPollEvent(e){if(e.isDecryptionFailure())return void e.once(d.OQ.Decrypted,(e=>{this.processPollEvent(e)}));if(r.M_POLL_START.matches(e.getType())){try{const t=new I.sP(e,this.client,this);this.polls.set(e.getId(),t),this.emit(I.sn.New,t),e.once(d.OQ.BeforeRedaction,(e=>{this.polls.delete(e.getId())}))}catch{}return}const t=e.relationEventId;if(t&&this.polls.has(t)){const i=this.polls.get(t);null==i||i.onNewRelation(e)}}async fetchRoomThreadList(e){if(!this.client.supportsThreads())return;if(0===this.threadsTimelineSets.length)return;const t=e===S.x3.My?this.threadsTimelineSets[1]:this.threadsTimelineSets[0],{chunk:i,end:n}=await this.client.createThreadListMessagesRequest(this.roomId,null,void 0,o.O.Backward,t.threadListType,t.getFilter());if(t.getLiveTimeline().setPaginationToken(null!=n?n:null,o.O.Backward),!i.length)return;const r=i.map(this.client.getEventMapper());this.processThreadRoots(r,!0);const a=this.getLiveTimeline().getState(o.q.FORWARDS);for(const e of r)t.addLiveEvent(e,{duplicateStrategy:s.x.Replace,fromCache:!1,roomState:a})}onThreadUpdate(e){this.updateThreadRootEvents(e,!1,!1)}onThreadReply(e){this.updateThreadRootEvents(e,!1,!0)}onThreadDelete(e){var t;this.threads.delete(e.id);const i=this.getTimelineForEvent(e.id),n=null==i||null===(t=i.getEvents())||void 0===t?void 0:t.find((t=>t.getId()===e.id));n?e.clearEventMetadata(n):m.v.debug("onThreadDelete: Could not find root event in room timeline");for(const t of this.threadsTimelineSets)t.removeEvent(e.id)}removeFilteredTimelineSet(e){const t=this.filteredTimelineSets[e.filterId];delete this.filteredTimelineSets[e.filterId];const i=this.timelineSets.indexOf(t);i>-1&&this.timelineSets.splice(i,1)}eventShouldLiveIn(e,t,i){var n;if(null===(n=this.client)||void 0===n||!n.supportsThreads())return{shouldLiveInRoom:!0,shouldLiveInThread:!1};if(e.isThreadRoot||null!=i&&i.has(e.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.getId()};const r=e.isRelation(S.RN.name),s=e.getAssociatedId(),o=e.threadRootId;if(s&&!r&&(o===s||null!=i&&i.has(s)))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};let a;var c;s&&(a=null!==(c=this.findEventById(s))&&void 0!==c?c:null==t?void 0:t.find((e=>e.getId()===s)));return a&&!r?this.eventShouldLiveIn(a,t,i):null!=o?{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:o}:!s||e.replyEventId?{shouldLiveInRoom:!0,shouldLiveInThread:!1}:{shouldLiveInRoom:!1,shouldLiveInThread:!1}}findThreadForEvent(e){if(!e)return null;const{threadId:t}=this.eventShouldLiveIn(e);return t?this.getThread(t):null}addThreadedEvents(e,t,i=!1){const n=this.getThread(e);if(n)n.addEvents(t,i);else{var r;const n=null!==(r=this.findEventById(e))&&void 0!==r?r:t.find((t=>t.getId()===e));this.createThread(e,n,t,i)}}processThreadedEvents(e,t){e.forEach(this.applyRedaction);const i={};for(const t of e){var n;const{threadId:e,shouldLiveInThread:r}=this.eventShouldLiveIn(t);r&&!i[e]&&(i[e]=[]),null===(n=i[e])||void 0===n||n.push(t)}Object.entries(i).map((([e,i])=>this.addThreadedEvents(e,i,t)))}createThread(e,t,i=[],n){var r;if(this.threads.has(e))return this.threads.get(e);if(t){const e=this.relations.getAllChildEventsForEvent(t.getId());null!=e&&e.length&&(i=i.concat(e.filter((e=>!e.isRelation(g.zZ.Replace)))))}const s=new S.jV(e,t,{room:this,client:this.client,pendingEventOrdering:this.opts.pendingEventOrdering,receipts:null!==(r=this.cachedThreadReadReceipts.get(e))&&void 0!==r?r:[]});return this.reEmitter.reEmit(s,[S.ju.Delete,S.ju.Update,S.ju.NewReply,K.Timeline,K.TimelineReset]),this.cachedThreadReadReceipts.delete(e),this.threads.set(s.id,s),s.addEvents(i,!1),this.threadsReady&&s.initialEventsFetched&&this.updateThreadRootEvents(s,n,!1),this.emit(S.ju.New,s,n),s}processLiveEvent(e){this.applyRedaction(e),e.isVisibilityEvent()&&this.applyNewVisibilityEvent(e),this.applyPendingVisibilityEvents(e);if(!e.getUnsigned().transaction_id&&e.getSender()===this.myUserId)for(const[t,i]of this.txnToEvent)if(i.getId()===e.getId()){m.v.debug("processLiveEvent: found sent event without txn ID: ",t,e.getId());const i=e.getUnsigned();i.transaction_id=t,e.setUnsigned(i);break}}addLiveEvent(e,t){const{duplicateStrategy:i,timelineWasEmpty:n,fromCache:r}=t;for(const t of this.timelineSets)t.addLiveEvent(e,{duplicateStrategy:i,fromCache:r,timelineWasEmpty:n});e.sender&&e.getType()!==g.Bx.RoomRedaction&&this.addReceipt((0,E.D)(e.sender.userId,e,w.L.Read),!0)}addPendingEvent(e,t){if(e.status!==l.f.SENDING&&e.status!==l.f.NOT_SENT)throw new Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent.get(t))throw new Error("addPendingEvent called on an event with known txnId "+t);if(o.q.setEventMetadata(e,this.getLiveTimeline().getState(o.q.FORWARDS),!1),this.txnToEvent.set(t,e),this.pendingEventList){if(this.pendingEventList.some((e=>e.status===l.f.NOT_SENT))&&(m.v.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(l.f.NOT_SENT)),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){const t=e.event.redacts;let i=this.pendingEventList.find((e=>e.getId()===t));!i&&t&&(i=this.findEventById(t)),i&&(i.markLocallyRedacted(e),this.emit(K.Redaction,e,this,i.threadRootId))}}else for(const t of this.timelineSets)t.getFilter()?t.getFilter().filterRoomTimeline([e]).length&&t.addEventToTimeline(e,t.getLiveTimeline(),{toStartOfTimeline:!1}):t.addEventToTimeline(e,t.getLiveTimeline(),{toStartOfTimeline:!1});this.emit(K.LocalEchoUpdated,e,this)}savePendingEvents(){if(this.pendingEventList){const e=this.pendingEventList.map((e=>N(N({},e.event),{},{txn_id:e.getTxnId()}))).filter((e=>{const t=e.type===g.Bx.RoomMessageEncrypted,i=this.hasEncryptionStateEvent();return t||!i}));this.client.store.setPendingEvents(this.roomId,e)}}aggregateNonLiveRelation(e){this.relations.aggregateChildEvent(e)}getEventForTxnId(e){return this.txnToEvent.get(e)}handleRemoteEcho(e,t){const i=t.getId(),n=e.getId(),r=t.status;m.v.debug(`Got remote echo for event ${i} -> ${n} old status ${r}`),this.txnToEvent.delete(e.getUnsigned().transaction_id),this.pendingEventList&&this.removePendingEvent(i),t.handleRemoteEcho(e.event);const{shouldLiveInRoom:s,threadId:o}=this.eventShouldLiveIn(e),a=o?this.getThread(o):null;if(null==a||a.setEventMetadata(t),null==a||a.timelineSet.handleRemoteEcho(t,i,n),s)for(const e of this.timelineSets)e.handleRemoteEcho(t,i,n);this.emit(K.LocalEchoUpdated,t,this,i,r)}updatePendingEvent(e,t,i){if(m.v.log(`setting pendingEvent status to ${t} in ${e.getRoomId()} event ID ${e.getId()} -> ${i}`),t==l.f.SENT&&!i)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==l.f.SENT){if(this.getTimelineForEvent(i)){const t=this.findEventById(i);if(!(null==t?void 0:t.getUnsigned().transaction_id)&&t){const i=t.getUnsigned();i.transaction_id=e.getTxnId(),t.setUnsigned(i),this.removeEvent(t.getId()),this.handleRemoteEcho(t,e)}return}}const n=e.status,r=e.getId();if(!n)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");const s=q[n];if(null==s||!s.includes(t))throw new Error(`Invalid EventStatus transition ${n}->${t}`);if(e.setStatus(t),t==l.f.SENT){e.replaceLocalEventId(i);const{shouldLiveInRoom:t,threadId:n}=this.eventShouldLiveIn(e),s=n?this.getThread(n):void 0;if(null==s||s.setEventMetadata(e),null==s||s.timelineSet.replaceEventId(r,i),t)for(const e of this.timelineSets)e.replaceEventId(r,i)}else if(t==l.f.CANCELLED){if(this.pendingEventList){const e=this.getPendingEvent(r);this.removePendingEvent(r),null!=e&&e.isRedaction()&&this.revertRedactionLocalEcho(e)}this.removeEvent(r)}this.savePendingEvents(),this.emit(K.LocalEchoUpdated,e,this,r,n)}revertRedactionLocalEcho(e){const t=e.event.redacts;if(!t)return;const i=this.getUnfilteredTimelineSet().findEventById(t);i&&(i.unmarkLocallyRedacted(),this.emit(K.RedactionCancelled,e,this),i.isRelation()&&this.aggregateNonLiveRelation(i))}async addLiveEvents(e,t){const{duplicateStrategy:i,fromCache:n,timelineWasEmpty:r=!1}=null!=t?t:{};if(i&&-1===["replace","ignore"].indexOf(i))throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");for(let e=0;e<this.timelineSets.length;e++){const t=this.timelineSets[e].getLiveTimeline();if(t.getPaginationToken(o.q.FORWARDS))throw new Error("live timeline "+e+" is no longer live - it has a pagination token ("+t.getPaginationToken(o.q.FORWARDS)+")");if(t.getNeighbouringTimeline(o.q.FORWARDS))throw new Error(`live timeline ${e} is no longer live - it has a neighbouring timeline`)}const s=this.findThreadRoots(e),a={},c={duplicateStrategy:i,fromCache:n,timelineWasEmpty:r},l=[...e];for(const t of e){var u,h,p;if(this.processLiveEvent(t),t.getUnsigned().transaction_id){const e=this.txnToEvent.get(t.getUnsigned().transaction_id);if(e){this.handleRemoteEcho(t,e);continue}}let{shouldLiveInRoom:e,shouldLiveInThread:i,threadId:n}=this.eventShouldLiveIn(t,l,s);if(!i&&!e&&t.isRelation())try{const r=new d.kl(await this.client.fetchRoomEvent(this.roomId,t.relationEventId));if(l.push(r),r.threadRootId){s.add(r.threadRootId);const e=t.getUnsigned();e[g.Sr.name]=r.threadRootId,t.setUnsigned(e)}({shouldLiveInRoom:e,shouldLiveInThread:i,threadId:n}=this.eventShouldLiveIn(t,l,s))}catch(e){m.v.error("Failed to load parent event of unhandled relation",e)}var v;if(i&&!a[null!==(u=n)&&void 0!==u?u:""])a[null!==(v=n)&&void 0!==v?v:""]=[];null===(h=a[null!==(p=n)&&void 0!==p?p:""])||void 0===h||h.push(t),e?this.addLiveEvent(t,c):!i&&t.isRelation()&&this.relations.aggregateChildEvent(t)}Object.entries(a).forEach((([e,t])=>{this.addThreadedEvents(e,t,!1)}))}partitionThreadedEvents(e){if(this.client.supportsThreads()){const t=this.findThreadRoots(e);return e.reduce(((i,n)=>{const{shouldLiveInRoom:r,shouldLiveInThread:s,threadId:o}=this.eventShouldLiveIn(n,e,t);return r&&i[0].push(n),s&&(n.setThreadId(null!=o?o:""),i[1].push(n)),s||r||i[2].push(n),i}),[[],[],[]])}return[e,[],[]]}findThreadRoots(e){const t=new Set;for(const i of e){const e=i.threadRootId;null!=e&&t.add(e)}return t}addReceipt(e,t=!1){const i=e.getContent();this.roomReceipts.add(i,t),Object.keys(i).forEach((e=>{Object.keys(i[e]).forEach((n=>{Object.keys(i[e][n]).forEach((r=>{var s,o,a;const c=i[e][n][r],d=!c.thread_id||c.thread_id===w.S,l=d?this:this.threads.get(null!==(s=c.thread_id)&&void 0!==s?s:"");var u;if(l){if(l.addReceiptToStructure(e,n,r,c,t),!t&&this.client.isInitialSyncComplete()&&r===this.client.getUserId()){const t=l.timeline[l.timeline.length-1];t&&e===t.getId()&&r===t.getSender()&&(l.setUnread(F.Total,0),l.setUnread(F.Highlight,0))}}else this.cachedThreadReadReceipts.set(c.thread_id,[...null!==(u=this.cachedThreadReadReceipts.get(c.thread_id))&&void 0!==u?u:[],{eventId:e,receiptType:n,userId:r,receipt:c,synthetic:t}]);r===this.client.getUserId()&&!d&&c.ts<this.oldestThreadedReceiptTs&&(this.oldestThreadedReceiptTs=c.ts),!c.thread_id&&c.ts>(null!==(o=null===(a=this.unthreadedReceipts.get(r))||void 0===a?void 0:a.ts)&&void 0!==o?o:0)&&this.unthreadedReceipts.set(r,c)}))}))})),this.emit(K.Receipt,e,this)}addEphemeralEvents(e){for(const t of e)t.getType()===g.Bx.Typing?this.currentState.setTypingEvent(t):t.getType()===g.Bx.Receipt&&this.addReceipt(t)}removeEvents(e){for(const t of e)this.removeEvent(t)}removeEvent(e){let t=!1;for(const i of this.timelineSets){const n=i.removeEvent(e);n&&(n.isRedaction()&&this.revertRedactionLocalEcho(n),t=!0)}return t}recalculate(){const e=this.currentState.getStateEvents(g.Bx.RoomMember,this.myUserId);if(e){const t=e.getContent().membership;if(this.updateMyMembership(t),t===U.O.Invite){(e.getUnsigned().invite_room_state||[]).forEach((e=>{this.currentState.getStateEvents(e.type,e.state_key)||this.currentState.setStateEvents([new d.kl({type:e.type,state_key:e.state_key,content:e.content,event_id:"$fake"+Date.now(),room_id:this.roomId,sender:this.myUserId})])}))}}const t=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=(0,c.S8)(this.name),this.summary=new h.c(this.roomId,{title:this.name}),t!==this.name&&this.emit(K.Name,this)}addTags(e){this.tags=e.getContent().tags||{},this.emit(K.Tags,e,this)}addAccountData(e){for(const t of e){"m.tag"===t.getType()&&this.addTags(t);const e=t.getType(),i=this.accountData.get(e);this.accountData.set(e,t),this.emit(K.AccountData,t,this,i)}}getAccountData(e){return this.accountData.get(e)}maySendMessage(){return this.getMyMembership()===U.O.Join&&(this.hasEncryptionStateEvent()?this.currentState.maySendEvent(g.Bx.RoomMessageEncrypted,this.myUserId):this.currentState.maySendEvent(g.Bx.RoomMessage,this.myUserId))}canInvite(e){let t=this.getMyMembership()===U.O.Join;const i=this.currentState.getStateEvents(g.Bx.RoomPowerLevels,""),n=i&&i.getContent(),r=this.getMember(e);return n&&r&&n.invite>r.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){const e=this.currentState.getStateEvents(g.Bx.RoomCreate,"");if(e)return e.getContent()[g.Ct];this.getTypeWarning||(m.v.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0)}isSpaceRoom(){return this.getType()===g.CJ.Space}isCallRoom(){return this.getType()===g.CJ.UnstableCall}isElementVideoRoom(){return this.getType()===g.CJ.ElementVideo}findPredecessor(e=!1){const t=this.getLiveTimeline().getState(o.q.FORWARDS);return t?t.findPredecessor(e):null}roomNameGenerator(e){if(this.client.roomNameGenerator){const t=this.client.roomNameGenerator(this.roomId,e);if(null!==t)return t}switch(e.type){case V.Actual:return e.name;case V.Generated:return"Inviting"===e.subtype?`Inviting ${G(e.names,e.count)}`:G(e.names,e.count);case V.EmptyRoom:return e.oldName?`Empty room (was ${e.oldName})`:"Empty room"}}calculateRoomName(e,t=!1){if(!t){const e=this.currentState.getStateEvents(g.Bx.RoomName,"");if(null!=e&&e.getContent().name)return this.roomNameGenerator({type:V.Actual,name:e.getContent().name})}const i=this.getCanonicalAlias();if(i)return this.roomNameGenerator({type:V.Actual,name:i});let n=this.currentState.getJoinedMemberCount()+this.currentState.getInvitedMemberCount()-1;const r=this.getFunctionalMembers();let s=[];if(this.summaryHeroes)this.summaryHeroes.forEach((e=>{if(r.includes(e))return void n--;const t=this.getMember(e);s.push(t?t.name:e)}));else{let t=this.currentState.getMembers().filter((t=>t.userId!==e&&(t.membership===U.O.Invite||t.membership===U.O.Join)));t=t.filter((({userId:e})=>!r.includes(e)||(n--,!1))),t.sort(((e,t)=>(0,c.UD)(e.userId,t.userId))),t=t.slice(0,5),s=t.map((e=>e.name))}if(n)return this.roomNameGenerator({type:V.Generated,names:s,count:n});if(this.getMyMembership()==U.O.Join){const e=this.currentState.getStateEvents(g.Bx.RoomThirdPartyInvite);if(null!=e&&e.length){const t=e.map((e=>e.getContent().display_name));return this.roomNameGenerator({type:V.Generated,subtype:"Inviting",names:t,count:t.length+1})}}let o,a=s;return a.length||(a=this.currentState.getMembers().filter((t=>t.userId!==e&&t.membership!==U.O.Invite&&t.membership!==U.O.Join)).map((e=>e.name))),a.length&&(o=this.roomNameGenerator({type:V.Generated,names:a,count:a.length+1})),this.roomNameGenerator({type:V.EmptyRoom,oldName:o})}applyNewVisibilityEvent(e){const t=e.asVisibilityChange();if(!t)return;const i=e.getSender();if(!i)return;if(!(g.Yg.name&&this.currentState.maySendStateEvent(g.Yg.name,i)||g.Yg.altName&&this.currentState.maySendStateEvent(g.Yg.altName,i)))return;const n=this.visibilityEvents.get(t.eventId);if(n){let t=n.length-1;const i=Math.max(0,n.length-30);for(;t>=i;--t){if(n[t].getTs()<e.getTs())break}-1===t?n.unshift(e):n.splice(t+1,0,e)}else this.visibilityEvents.set(t.eventId,[e]);const r=this.findEventById(t.eventId);r&&r.applyVisibilityEvent(t)}redactVisibilityChangeEvent(e){if(!e.isVisibilityEvent)throw new Error("expected a visibility change event");const t=e.getRelation(),i=null==t?void 0:t.event_id,n=this.visibilityEvents.get(i);if(!n)return;const r=n.findIndex((t=>t.getId()===e.getId()));if(-1!==r&&(n.splice(r,1),r===n.length)){const e=this.findEventById(i);if(!e)return;if(0===r)this.visibilityEvents.delete(i),e.applyVisibilityEvent();else{const t=n[n.length-1].asVisibilityChange();if(!t)throw new Error("at this stage, visibility changes should be well-formed");e.applyVisibilityEvent(t)}}}applyPendingVisibilityEvents(e){const t=this.visibilityEvents.get(e.getId());if(!t||0==t.length)return;const i=t[t.length-1],n=i.asVisibilityChange();n&&(n.visible,i.getTs()<e.getTs()||e.applyVisibilityEvent(n))}getOldestThreadedReceiptTs(){return this.oldestThreadedReceiptTs}hasUserReadEvent(e,t){return this.roomReceipts.hasUserReadEvent(e,t)}getLastUnthreadedReceiptFor(e){return this.unthreadedReceipts.get(e)}fixupNotifications(e){super.fixupNotifications(e);const t=this.getThreads().filter((e=>this.getThreadUnreadNotificationCount(e.id,F.Total)>0));for(const i of t)i.fixupNotifications(e)}compareEventOrdering(e,t){return j(this,e,t)}hasEncryptionStateEvent(){var e;return Boolean(null===(e=this.getLiveTimeline().getState(o.q.FORWARDS))||void 0===e?void 0:e.getStateEvents(g.Bx.RoomEncryption,""))}}const q={[l.f.ENCRYPTING]:[l.f.SENDING,l.f.NOT_SENT,l.f.CANCELLED],[l.f.SENDING]:[l.f.ENCRYPTING,l.f.QUEUED,l.f.NOT_SENT,l.f.SENT],[l.f.QUEUED]:[l.f.SENDING,l.f.NOT_SENT,l.f.CANCELLED],[l.f.SENT]:[],[l.f.NOT_SENT]:[l.f.SENDING,l.f.QUEUED,l.f.CANCELLED],[l.f.CANCELLED]:[]};let V=function(e){return e[e.EmptyRoom=0]="EmptyRoom",e[e.Generated=1]="Generated",e[e.Actual=2]="Actual",e}({});function G(e,t){const i=t-1;if(e.length){if(1===e.length&&i<=1)return e[0];if(2===e.length&&i<=2)return`${e[0]} and ${e[1]}`;return i>1?`${e[0]} and ${i} others`:`${e[0]} and 1 other`}return"Empty room"}},"./node_modules/matrix-js-sdk/src/models/search-result.ts":(e,t,i)=>{"use strict";i.d(t,{q:()=>o});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/models/event-timeline.ts");class s{constructor(e){this.ourEvent=e,(0,n.A)(this,"timeline",void 0),(0,n.A)(this,"ourEventIndex",0),(0,n.A)(this,"paginateTokens",{[r.O.Backward]:null,[r.O.Forward]:null}),this.timeline=[e]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(e=!1){return this.paginateTokens[e?r.O.Backward:r.O.Forward]}setPaginateToken(e,t=!1){this.paginateTokens[t?r.O.Backward:r.O.Forward]=null!=e?e:null}addEvents(e,t=!1){t?(this.timeline=e.concat(this.timeline),this.ourEventIndex+=e.length):this.timeline=this.timeline.concat(e)}}class o{static fromJson(e,t){const i=e.context||{};let n=(i.events_before||[]).map(t),r=(i.events_after||[]).map(t);const a=new s(t(e.result)),c=a.ourEvent.threadRootId;return n=n.filter((e=>e.threadRootId===c)),r=r.filter((e=>e.threadRootId===c)),a.setPaginateToken(i.start,!0),a.addEvents(n,!0),a.addEvents(r,!1),a.setPaginateToken(i.end,!1),new o(e.rank,a)}constructor(e,t){this.rank=e,this.context=t}}},"./node_modules/matrix-js-sdk/src/models/thread.ts":(e,t,i)=>{"use strict";i.d(t,{FD:()=>S,H:()=>I,RN:()=>k,UR:()=>T,c1:()=>b,jV:()=>w,ju:()=>y,o1:()=>E,x3:()=>R});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/client.ts"),s=i("./node_modules/matrix-js-sdk/src/ReEmitter.ts"),o=i("./node_modules/matrix-js-sdk/src/@types/event.ts"),a=i("./node_modules/matrix-js-sdk/src/models/event.ts"),c=i("./node_modules/matrix-js-sdk/src/models/event-timeline.ts"),d=i("./node_modules/matrix-js-sdk/src/models/event-timeline-set.ts"),l=i("./node_modules/matrix-js-sdk/src/models/room.ts"),u=i("./node_modules/matrix-js-sdk/src/NamespacedValue.ts"),h=i("./node_modules/matrix-js-sdk/src/logger.ts"),m=i("./node_modules/matrix-js-sdk/src/models/read-receipt.ts"),p=i("./node_modules/matrix-js-sdk/src/@types/read_receipts.ts"),g=i("./node_modules/matrix-js-sdk/src/feature.ts");function v(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function f(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?v(Object(i),!0).forEach((function(t){(0,n.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):v(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let y=function(e){return e.New="Thread.new",e.Update="Thread.update",e.NewReply="Thread.newReply",e.ViewThread="Thread.viewThread",e.Delete="Thread.delete",e}({}),b=function(e){return e[e.None=0]="None",e[e.Experimental=1]="Experimental",e[e.Stable=2]="Stable",e}({});function S(e,t){return e?b.Stable:t?b.Experimental:b.None}class w extends m.h{constructor(e,t,i){var o;if(super(),this.id=e,this.rootEvent=t,(0,n.A)(this,"timelineSet",void 0),(0,n.A)(this,"_currentUserParticipated",!1),(0,n.A)(this,"reEmitter",void 0),(0,n.A)(this,"lastEvent",void 0),(0,n.A)(this,"replyCount",0),(0,n.A)(this,"lastPendingEvent",void 0),(0,n.A)(this,"pendingReplyCount",0),(0,n.A)(this,"room",void 0),(0,n.A)(this,"client",void 0),(0,n.A)(this,"pendingEventOrdering",void 0),(0,n.A)(this,"processRootEventPromise",void 0),(0,n.A)(this,"initialEventsFetched",!w.hasServerSideSupport),(0,n.A)(this,"initalEventFetchProm",void 0),(0,n.A)(this,"replayEvents",[]),(0,n.A)(this,"onTimelineReset",(async()=>{await this.processRootEventPromise,this.processRootEventPromise=void 0})),(0,n.A)(this,"onBeforeRedaction",((e,t)=>{null!=e&&e.isRelation(k.name)&&this.room.eventShouldLiveIn(e).threadId===this.id&&e.getId()!==this.id&&!t.status&&(this.replyCount--,this.updatePendingReplyCount(),this.emit(y.Update,this))})),(0,n.A)(this,"onRedaction",(async(e,t,i)=>{if(i===this.id)if(this.replyCount<=0){for(const e of this.timeline)this.clearEventMetadata(e);this.lastEvent=this.rootEvent,this._currentUserParticipated=!1,this.emit(y.Delete,this)}else{var n;(null===(n=this.lastEvent)||void 0===n?void 0:n.getId())===e.getAssociatedId()&&(await this.processRootEventPromise,this.processRootEventPromise=void 0),await this.updateThreadMetadata()}})),(0,n.A)(this,"onTimelineEvent",((e,t,i)=>{if(!i){const i=e.getSender();i&&t&&this.shouldSendLocalEchoReceipt(i,e)&&t.addLocalEchoReceipt(i,e,p.L.Read),e.getId()!==this.id&&e.isRelation(k.name)&&this.replyCount++}this.onEcho(e,null!=i&&i)})),(0,n.A)(this,"onLocalEcho",(e=>{this.onEcho(e,!1)})),(0,n.A)(this,"onEcho",(async(e,t)=>{e.threadRootId===this.id&&this.lastEvent!==e&&(await this.updateThreadMetadata(),e.isRelation(k.name)&&(t||(this.lastEvent=void 0,this.emit(y.NewReply,this,e))))})),this.setMaxListeners(1e3),null==i||!i.room)throw new Error("element-web#22141: A thread requires a room in order to function");this.room=i.room,this.client=i.client,this.pendingEventOrdering=null!==(o=i.pendingEventOrdering)&&void 0!==o?o:r.eO.Chronological,this.timelineSet=new d.m(this.room,{timelineSupport:!0,pendingEvents:!0},this.client,this),this.reEmitter=new s.Q(this),this.reEmitter.reEmit(this.timelineSet,[l.u9.Timeline,l.u9.TimelineReset]),this.room.on(a.OQ.BeforeRedaction,this.onBeforeRedaction),this.room.on(l.u9.Redaction,this.onRedaction),this.room.on(l.u9.LocalEchoUpdated,this.onLocalEcho),this.room.on(l.u9.TimelineReset,this.onTimelineReset),this.timelineSet.on(l.u9.Timeline,this.onTimelineEvent),this.processReceipts(i.receipts),this.updateThreadMetadata(),this.setEventMetadata(this.rootEvent)}async fetchRootEvent(){try{const e=await this.client.fetchRoomEvent(this.roomId,this.id),t=this.client.getEventMapper();this.rootEvent=t(e)}catch(e){h.v.error("Failed to fetch thread root to construct thread with",e)}await this.processEvent(this.rootEvent)}static setServerSideSupport(e){w.hasServerSideSupport=e,e!==b.Stable&&(E.setPreferUnstable(!0),I.setPreferUnstable(!0),k.setPreferUnstable(!0))}static setServerSideListSupport(e){w.hasServerSideListSupport=e}static setServerSideFwdPaginationSupport(e){w.hasServerSideFwdPaginationSupport=e}shouldSendLocalEchoReceipt(e,t){var i;if((null!==(i=this.client.canSupport.get(g.Xj.RelationsRecursion))&&void 0!==i?i:g.Tj.Unsupported)===g.Tj.Unsupported){var n;const i=null===(n=this.getReadReceiptForUserId(e))||void 0===n?void 0:n.eventId;if(i){const e=this.findEventById(i);if(e&&e.getTs()>t.getTs())return!1}}return!0}get roomState(){return this.room.getLiveTimeline().getState(c.q.FORWARDS)}addEventToTimeline(e,t){this.findEventById(e.getId())||this.timelineSet.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:t,fromCache:!1,roomState:this.roomState})}insertEventIntoTimeline(e){const t=e.getId();t&&(this.findEventById(t)||this.timelineSet.insertEventIntoTimeline(e,this.liveTimeline,this.roomState))}addEvents(e,t){e.forEach((e=>this.addEvent(e,t,!1))),this.updateThreadMetadata()}addEvent(e,t,i=!0){this.setEventMetadata(e);const n=this.lastReply(),r=!n||e.localTimestamp>=n.localTimestamp;if(w.hasServerSideSupport){if(e.isRelation(o.zZ.Annotation)||e.isRelation(o.zZ.Replace))return void this.addRelatedThreadEvent(e,t);!t&&r?(this.addEventToTimeline(e,!1),this.fetchEditsWhereNeeded(e)):t?this.addEventToTimeline(e,t):this.insertEventIntoTimeline(e)}else this.addEventToTimeline(e,t),this.client.decryptEventIfNeeded(e);e.getId()!==this.id&&e.isRelation(k.name)&&!t&&r&&(this.lastEvent=void 0),i&&(this.emit(y.NewReply,this,e),this.updateThreadMetadata())}addRelatedThreadEvent(e,t){var i,n;if(this.initialEventsFetched){var r;(null!==(r=this.client.canSupport.get(g.Xj.RelationsRecursion))&&void 0!==r?r:g.Tj.Unsupported)===g.Tj.Unsupported?this.insertEventIntoTimeline(e):this.addEventToTimeline(e,t)}else{var s;null===(s=this.replayEvents)||void 0===s||s.push(e)}null===(i=this.timelineSet.relations)||void 0===i||i.aggregateParentEvent(e),null===(n=this.timelineSet.relations)||void 0===n||n.aggregateChildEvent(e,this.timelineSet)}async processEvent(e){e&&(this.setEventMetadata(e),await this.fetchEditsWhereNeeded(e))}processReceipts(e=[]){for(const{eventId:t,receiptType:i,userId:n,receipt:r,synthetic:s}of e)this.addReceiptToStructure(t,i,n,r,s)}getRootEventBundledRelationship(e=this.rootEvent){return null==e?void 0:e.getServerAggregatedRelation(k.name)}async processRootEvent(){const e=this.getRootEventBundledRelationship();if(w.hasServerSideSupport&&e){this.replyCount=e.count,this._currentUserParticipated=!!e.current_user_participated;const t=this.client.getEventMapper();this.lastEvent=t(f(f({},e.latest_event),{},{room_id:this.roomId})),this.updatePendingReplyCount(),await this.processEvent(this.lastEvent)}}updatePendingReplyCount(){const e=(this.pendingEventOrdering===r.eO.Detached?this.room.getPendingEvents():this.events).filter((e=>{var t;return e.threadRootId===this.id&&e.isRelation(k.name)&&null!==e.status&&e.getId()!==(null===(t=this.lastEvent)||void 0===t?void 0:t.getId())}));this.lastPendingEvent=e.length?e[e.length-1]:void 0,this.pendingReplyCount=e.length}async resetLiveTimeline(e,t){const i=this.liveTimeline;this.timelineSet.resetLiveTimeline(null!=e?e:void 0,null!=t?t:void 0);const n=this.liveTimeline;let r,s;if(e){r=(await this.client.createMessagesRequest(this.roomId,e,1,c.O.Forward)).end}if(t){s=(await this.client.createMessagesRequest(this.roomId,t,1,c.O.Backward)).start}var o,a;t&&i.getPaginationToken(c.O.Forward)===t&&i.setPaginationToken(null!==(o=s)&&void 0!==o?o:null,c.O.Forward);e&&n.getPaginationToken(c.O.Backward)===e&&n.setPaginationToken(null!==(a=r)&&void 0!==a?a:null,c.O.Backward)}async updateThreadFromRootEvent(){w.hasServerSideSupport&&(this.initialEventsFetched||this.lastEvent||await this.processRootEvent(),await this.fetchRootEvent()),await this.processRootEvent()}async updateThreadMetadata(){if(this.updatePendingReplyCount(),this.processRootEventPromise||(this.processRootEventPromise=this.updateThreadFromRootEvent()),await this.processRootEventPromise,!this.initialEventsFetched)if(this.initalEventFetchProm)await this.initalEventFetchProm;else try{this.timelineSet.resetLiveTimeline(),0===this.replyCount&&this.rootEvent?(this.timelineSet.addEventsToTimeline([this.rootEvent],!0,this.liveTimeline,null),this.liveTimeline.setPaginationToken(null,c.O.Backward)):(this.initalEventFetchProm=this.client.paginateEventTimeline(this.liveTimeline,{backwards:!0}),await this.initalEventFetchProm),this.initialEventsFetched=!0;for(const e of this.replayEvents)this.addEvent(e,!1);this.replayEvents=null,this.emit(l.u9.TimelineReset,this.room,this.timelineSet,!0)}catch(e){h.v.error("Failed to load start of newly created thread: ",e),this.initialEventsFetched=!1}this.emit(y.Update,this)}async fetchEditsWhereNeeded(...e){var t;if((null!==(t=this.client.canSupport.get(g.Xj.RelationsRecursion))&&void 0!==t?t:g.Tj.Unsupported)===g.Tj.Unsupported)return Promise.all(e.filter(_).map((async e=>{try{const t=await this.client.relations(this.roomId,e.getId(),o.zZ.Replace,e.getType(),{limit:1});if(t.events.length){const i=t.events[0];e.makeReplaced(i),this.insertEventIntoTimeline(i)}}catch(e){h.v.error("Failed to load edits for encrypted thread event",e)}})))}setEventMetadata(e){e&&(c.q.setEventMetadata(e,this.roomState,!1),e.setThread(this))}clearEventMetadata(e){var t,i,n;e&&(e.setThread(void 0),null===(t=e.event)||void 0===t||(null===(i=t.unsigned)||void 0===i||(null===(n=i["m.relations"])||void 0===n||delete n[k.name])))}findEventById(e){return this.timelineSet.findEventById(e)}lastReply(e=(e=>e.isRelation(k.name))){for(let t=this.timeline.length-1;t>=0;t--){const i=this.timeline[t];if(e(i))return i}return null}get roomId(){return this.room.roomId}get length(){return this.replyCount+this.pendingReplyCount}get replyToEvent(){var e,t;return null!==(e=null!==(t=this.lastPendingEvent)&&void 0!==t?t:this.lastEvent)&&void 0!==e?e:this.lastReply()}get timeline(){return this.events}get events(){return this.liveTimeline.getEvents()}has(e){return this.timelineSet.findEventById(e)instanceof a.kl}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}getUnfilteredTimelineSet(){return this.timelineSet}addReceipt(e,t){throw new Error("Unsupported function on the thread model")}getEventReadUpTo(e,t){const i=e===this.client.getUserId(),n=this.timeline[this.timeline.length-1];if(i&&n){const e=n.getTs()<this.room.getOldestThreadedReceiptTs(),t=n.getId();if(e&&t)return t}const r=super.getEventReadUpTo(e,t);if(n){const t=this.room.getLastUnthreadedReceiptFor(e);if(!t)return r;for(let e=(null===(s=this.timeline)||void 0===s?void 0:s.length)-1;e>=0;--e){var s,o;const i=this.timeline[e];if(i.getId()===r)return r;if(i.getTs()<t.ts)return null!==(o=i.getId())&&void 0!==o?o:r}}return r}hasUserReadEvent(e,t){if(e===this.client.getUserId()){var i,n,r,s,o,a;const t=(null!==(i=null===(n=this.lastReply())||void 0===n?void 0:n.getTs())&&void 0!==i?i:0)<this.room.getOldestThreadedReceiptTs(),c=null!==(r=null===(s=this.room.getLastUnthreadedReceiptFor(e))||void 0===s?void 0:s.ts)&&void 0!==r?r:0,d=(null!==(o=null==this||null===(a=this.lastReply())||void 0===a?void 0:a.getTs())&&void 0!==o?o:0)<c;if(t||d)return!0}return this.room.hasUserReadEvent(e,t)}setUnread(e,t){return this.room.setThreadUnreadNotificationCount(this.id,e,t)}getLastUnthreadedReceiptFor(e){return this.room.getLastUnthreadedReceiptFor(e)}}function _(e){return e.isEncrypted()&&(e.isRelation(k.name)||e.isThreadRoot)}(0,n.A)(w,"hasServerSideSupport",b.None),(0,n.A)(w,"hasServerSideListSupport",b.None),(0,n.A)(w,"hasServerSideFwdPaginationSupport",b.None);const E=new u.M6("related_by_senders","io.element.relation_senders"),I=new u.M6("related_by_rel_types","io.element.relation_types"),k=new u.M6("m.thread","io.element.thread");let R=function(e){return e[e.My=0]="My",e[e.All=1]="All",e}({});function T(e){return e===R.My?"participated":"all"}},"./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts":(e,t,i)=>{"use strict";i.d(t,{X:()=>s,u:()=>r});var n=i("./node_modules/events/events.js");let r=function(e){return e.NewListener="newListener",e.RemoveListener="removeListener",e.Error="error",e}({});class s extends n.EventEmitter{addListener(e,t){return super.addListener(e,t)}emit(e,...t){return super.emit(e,...t)}async emitPromised(e,...t){const i=this.listeners(e);return Promise.allSettled(i.map((e=>e(...t)))).then((()=>i.length>0))}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}off(e,t){return super.off(e,t)}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeAllListeners(e){return void 0===e?super.removeAllListeners():super.removeAllListeners(e)}removeListener(e,t){return super.removeListener(e,t)}rawListeners(e){return super.rawListeners(e)}}},"./node_modules/matrix-js-sdk/src/models/user.ts":(e,t,i)=>{"use strict";i.d(t,{K:()=>o,U:()=>s});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts");let s=function(e){return e.DisplayName="User.displayName",e.AvatarUrl="User.avatarUrl",e.Presence="User.presence",e.CurrentlyActive="User.currentlyActive",e.LastPresenceTs="User.lastPresenceTs",e}({});class o extends r.X{constructor(e){super(),this.userId=e,(0,n.A)(this,"modified",-1),(0,n.A)(this,"displayName",void 0),(0,n.A)(this,"rawDisplayName",void 0),(0,n.A)(this,"avatarUrl",void 0),(0,n.A)(this,"presenceStatusMsg",void 0),(0,n.A)(this,"presence","offline"),(0,n.A)(this,"lastActiveAgo",0),(0,n.A)(this,"lastPresenceTs",0),(0,n.A)(this,"currentlyActive",!1),(0,n.A)(this,"events",{}),this.displayName=e,this.rawDisplayName=e,this.updateModifiedTime()}static createUser(e,t){const i=new o(e);return t.reEmitter.reEmit(i,[s.AvatarUrl,s.DisplayName,s.Presence,s.CurrentlyActive,s.LastPresenceTs]),i}setPresenceEvent(e){if("m.presence"!==e.getType())return;const t=null===this.events.presence;this.events.presence=e;const i=[];(e.getContent().presence!==this.presence||t)&&i.push(s.Presence),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&i.push(s.AvatarUrl),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&i.push(s.DisplayName),void 0!==e.getContent().currently_active&&e.getContent().currently_active!==this.currentlyActive&&i.push(s.CurrentlyActive),this.presence=e.getContent().presence,i.push(s.LastPresenceTs),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime();for(const t of i)this.emit(t,e,this)}setDisplayName(e){const t=this.displayName;this.displayName=e,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName=e}setAvatarUrl(e){const t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}}},"./node_modules/matrix-js-sdk/src/oidc/authorize.ts":(e,t,i)=>{"use strict";i("./node_modules/oidc-client-ts/dist/esm/oidc-client-ts.js"),i("./node_modules/matrix-js-sdk/src/crypto/crypto.ts"),i("./node_modules/matrix-js-sdk/src/logger.ts"),i("./node_modules/matrix-js-sdk/src/randomstring.ts"),i("./node_modules/matrix-js-sdk/src/oidc/error.ts"),i("./node_modules/matrix-js-sdk/src/oidc/validate.ts")},"./node_modules/matrix-js-sdk/src/oidc/error.ts":(e,t,i)=>{"use strict"},"./node_modules/matrix-js-sdk/src/oidc/validate.ts":(e,t,i)=>{"use strict";i("./node_modules/jwt-decode/build/esm/index.js"),i("./node_modules/matrix-js-sdk/src/logger.ts"),i("./node_modules/matrix-js-sdk/src/oidc/error.ts")},"./node_modules/matrix-js-sdk/src/pushprocessor.ts":(e,t,i)=>{"use strict";i.d(t,{j:()=>f});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/utils.ts"),s=i("./node_modules/matrix-js-sdk/src/logger.ts"),o=i("./node_modules/matrix-js-sdk/src/@types/PushRules.ts"),a=i("./node_modules/matrix-js-sdk/src/@types/event.ts");function c(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function d(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?c(Object(i),!0).forEach((function(t){(0,n.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):c(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const l=[o.Ji.Override,o.Ji.ContentSpecific,o.Ji.RoomSpecific,o.Ji.SenderSpecific,o.Ji.Underride],u={".m.rule.is_room_mention":{rule_id:".m.rule.is_room_mention",default:!0,enabled:!0,conditions:[{kind:o.wp.EventPropertyIs,key:"content.m\\.mentions.room",value:!0},{kind:o.wp.SenderNotificationPermission,key:"room"}],actions:[o.YU.Notify,{set_tweak:o.QN.Highlight}]},".m.rule.reaction":{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:o.wp.EventMatch,key:"type",pattern:"m.reaction"}],actions:[o.YU.DontNotify]},".org.matrix.msc3786.rule.room.server_acl":{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:o.wp.EventMatch,key:"type",pattern:a.Bx.RoomServerAcl},{kind:o.wp.EventMatch,key:"state_key",pattern:""}],actions:[]}},h=Symbol("UserDefinedRules"),m=[o.kq.Master,h,o.kq.SuppressNotices,o.kq.InviteToSelf,o.kq.MemberEvent,o.kq.IsUserMention,o.kq.ContainsDisplayName,o.kq.IsRoomMention,o.kq.AtRoomNotification,o.kq.Tombstone,".m.rule.reaction",".m.rule.room.server_acl",".org.matrix.msc3786.rule.room.server_acl",".m.rule.suppress_edits"],p={".org.matrix.msc3914.rule.room.call":{rule_id:".org.matrix.msc3914.rule.room.call",default:!0,enabled:!0,conditions:[{kind:o.wp.EventMatch,key:"type",pattern:"org.matrix.msc3401.call"},{kind:o.wp.CallStarted}],actions:[o.YU.Notify,{set_tweak:o.QN.Sound,value:"default"}]}},g=[h,o.kq.IncomingCall,".org.matrix.msc3914.rule.room.call",o.kq.EncryptedDM,o.kq.DM,o.kq.Message,o.kq.EncryptedMessage];function v(e,t,i,n){const r=t.filter((e=>e.default)),o=t.filter((e=>!e.default));function a(t){t===h?d.push(...o):t in i?(s.v.warn(`Adding default global ${e} push rule ${t}`),d.push(i[t])):s.v.warn(`Missing default global ${e} push rule ${t}`)}let c=0;const d=[];for(const e of r){const t=n.indexOf(e.rule_id);if(-1!==t){for(;t>c;){a(n[c]),c+=1}d.push(e),c+=1}else d.push(e)}for(const e of n.slice(c))a(e);return d}class f{constructor(e){this.client=e,(0,n.A)(this,"parsedKeys",new Map)}static actionListToActionsObject(e){const t={notify:!1,tweaks:{}};for(const i of e)i===o.YU.Notify?t.notify=!0:"object"==typeof i&&(void 0===i.value&&(i.value=!0),t.tweaks[i.set_tweak]=i.value);return t}static rewriteDefaultRules(e,t=void 0){let i=JSON.parse(JSON.stringify(e));return i||(i={}),i.global||(i.global={}),i.global.override||(i.global.override=[]),i.global.underride||(i.global.underride=[]),i.global.override=v(o.Ji.Override,i.global.override,u,m),i.global.underride=v(o.Ji.Underride,i.global.underride,p,g),i}updateCachedPushRuleKeys(e){e||(e={}),e.global||(e.global={}),e.global.override||(e.global.override=[]),e.global.room||(e.global.room=[]),e.global.sender||(e.global.sender=[]),e.global.underride||(e.global.underride=[]);const t=new Set(this.parsedKeys.keys());for(const i of[e.global.override,e.global.room,e.global.sender,e.global.underride])for(const e of i)if(e.conditions)for(const i of e.conditions)i.kind===o.wp.EventMatch&&(t.delete(i.key),this.parsedKeys.set(i.key,f.partsForDottedKey(i.key)));t.forEach((e=>this.parsedKeys.delete(e)))}matchingRuleFromKindSet(e,t){for(const i of l){const n=t[i];if(n)for(const t of n){if(!t.enabled)continue;const n=this.templateRuleToRaw(i,t);if(n&&this.ruleMatchesEvent(n,e))return d(d({},t),{},{kind:i})}}return null}templateRuleToRaw(e,t){const i={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case o.Ji.Underride:case o.Ji.Override:i.conditions=t.conditions;break;case o.Ji.RoomSpecific:if(!t.rule_id)return null;i.conditions.push({kind:o.wp.EventMatch,key:"room_id",value:t.rule_id});break;case o.Ji.SenderSpecific:if(!t.rule_id)return null;i.conditions.push({kind:o.wp.EventMatch,key:"user_id",value:t.rule_id});break;case o.Ji.ContentSpecific:if(!t.pattern)return null;i.conditions.push({kind:o.wp.EventMatch,key:"content.body",pattern:t.pattern})}return i}eventFulfillsCondition(e,t){switch(e.kind){case o.wp.EventMatch:return this.eventFulfillsEventMatchCondition(e,t);case o.wp.EventPropertyIs:return this.eventFulfillsEventPropertyIsCondition(e,t);case o.wp.EventPropertyContains:return this.eventFulfillsEventPropertyContains(e,t);case o.wp.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(e,t);case o.wp.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(e,t);case o.wp.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(e,t);case o.wp.CallStarted:case o.wp.CallStartedPrefix:return this.eventFulfillsCallStartedCondition(e,t)}return!1}eventFulfillsSenderNotifPermCondition(e,t){const i=e.key;if(!i)return!1;const n=this.client.getRoom(t.getRoomId());return!(null==n||!n.currentState)&&n.currentState.mayTriggerNotifOfType(i,t.getSender())}eventFulfillsRoomMemberCountCondition(e,t){if(!e.is)return!1;const i=this.client.getRoom(t.getRoomId());if(!i||!i.currentState||!i.currentState.members)return!1;const n=i.currentState.getJoinedMemberCount(),r=e.is.match(/^([=<>]*)(\d*)$/);if(!r)return!1;const s=r[1],o=parseInt(r[2]);if(isNaN(o))return!1;switch(s){case"":case"==":return n==o;case"<":return n<o;case">":return n>o;case"<=":return n<=o;case">=":return n>=o;default:return!1}}eventFulfillsDisplayNameCondition(e,t){var i;let n=t.getContent();if(t.isEncrypted()&&t.getClearContent()&&(n=t.getClearContent()),!n||!n.body||"string"!=typeof n.body)return!1;const s=this.client.getRoom(t.getRoomId()),o=null==s||null===(i=s.currentState)||void 0===i?void 0:i.getMember(this.client.credentials.userId);if(!o)return!1;const a=o.name,c=new RegExp("(^|\\W)"+(0,r.Nt)(a)+"(\\W|$)","i");return n.body.search(c)>-1}eventFulfillsEventMatchCondition(e,t){if(!e.key)return!1;const i=this.valueForDottedKey(e.key,t);if("string"!=typeof i)return!1;if(e.value)return e.value===i;if("string"!=typeof e.pattern)return!1;const n="content.body"===e.key?this.createCachedRegex("(^|\\W)",e.pattern,"(\\W|$)"):this.createCachedRegex("^",e.pattern,"$");return!!i.match(n)}eventFulfillsEventPropertyIsCondition(e,t){return!(!e.key||void 0===e.value)&&e.value===this.valueForDottedKey(e.key,t)}eventFulfillsEventPropertyContains(e,t){if(!e.key||void 0===e.value)return!1;const i=this.valueForDottedKey(e.key,t);return!!Array.isArray(i)&&i.includes(e.value)}eventFulfillsCallStartedCondition(e,t){return["m.ring","m.prompt"].includes(t.getContent()["m.intent"])&&!("m.terminated"in t.getContent())&&(t.getPrevContent()["m.terminated"]!==t.getContent()["m.terminated"]||(0,r.ky)(t.getPrevContent(),{}))}createCachedRegex(e,t,i){return f.cachedGlobToRegex[t]||(f.cachedGlobToRegex[t]=new RegExp(e+(0,r.dn)(t)+i,"i")),f.cachedGlobToRegex[t]}static partsForDottedKey(e){const t=[];let i="",n=!1;for(const r of e)n?(i+="\\"===r||"."===r?r:"\\"+r,n=!1):"."==r?(t.push(i),i=""):"\\"==r?n=!0:i+=r;return n&&(i+="\\"),t.push(i),t}valueForDottedKey(e,t){let i,n=this.parsedKeys.get(e);void 0===n&&(n=f.partsForDottedKey(e),this.parsedKeys.set(e,n));const s=n[0];let o=0;for("content"===s?(i=t.getContent(),++o):"type"===s?(i=t.getType(),++o):i=t.event;o<n.length;++o){if((0,r.hX)(i))return;i=i[n[o]]}return i}matchingRuleForEventWithRulesets(e,t){return t?e.getSender()===this.client.getSafeUserId()?null:this.matchingRuleFromKindSet(e,t.global):null}pushActionsForEventAndRulesets(e,t){const i=this.matchingRuleForEventWithRulesets(e,t);if(!i)return{};const n=f.actionListToActionsObject(i.actions);return void 0===n.tweaks.highlight&&(n.tweaks.highlight=i.kind==o.Ji.ContentSpecific),{actions:n,rule:i}}ruleMatchesEvent(e,t){var i;return(!this.client.supportsIntentionalMentions()||void 0===t.getContent()["m.mentions"]||e.rule_id!==o.kq.ContainsUserName&&e.rule_id!==o.kq.ContainsDisplayName&&e.rule_id!==o.kq.AtRoomNotification)&&!(null!==(i=e.conditions)&&void 0!==i&&i.some((e=>!this.eventFulfillsCondition(e,t))))}actionsForEvent(e){const{actions:t}=this.pushActionsForEventAndRulesets(e,this.client.pushRules);return t||{}}actionsAndRuleForEvent(e){return this.pushActionsForEventAndRulesets(e,this.client.pushRules)}getPushRuleById(e){var t;const i=this.getPushRuleAndKindById(e);return null!==(t=null==i?void 0:i.rule)&&void 0!==t?t:null}getPushRuleAndKindById(e){for(const i of["global"]){var t;if(void 0!==(null===(t=this.client.pushRules)||void 0===t?void 0:t[i]))for(const t of l)if(void 0!==this.client.pushRules[i][t])for(const n of this.client.pushRules[i][t])if(n.rule_id===e)return{rule:n,kind:t}}return null}}(0,n.A)(f,"cachedGlobToRegex",{})},"./node_modules/matrix-js-sdk/src/randomstring.ts":(e,t,i)=>{"use strict";i.d(t,{DU:()=>d,rl:()=>c});var n=i("./node_modules/matrix-js-sdk/src/base64.ts"),r=i("./node_modules/matrix-js-sdk/src/crypto/crypto.ts");const s="abcdefghijklmnopqrstuvwxyz",o="ABCDEFGHIJKLMNOPQRSTUVWXYZ",a="0123456789";function c(e){const t=new Uint8Array(e);return r.Et.getRandomValues(t),(0,n.A4)(t)}function d(e){return l(e,o+s+a)}function l(e,t){let i="";for(let n=0;n<e;++n)i+=t.charAt(Math.floor(Math.random()*t.length));return i}},"./node_modules/matrix-js-sdk/src/scheduler.ts":(e,t,i)=>{"use strict";i.d(t,{b:()=>c});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/logger.ts"),s=i("./node_modules/matrix-js-sdk/src/@types/event.ts"),o=i("./node_modules/matrix-js-sdk/src/utils.ts"),a=i("./node_modules/matrix-js-sdk/src/http-api/index.ts");class c{static RETRY_BACKOFF_RATELIMIT(e,t,i){return(0,a.fZ)(i,t,!1)}static QUEUE_MESSAGES(e){return e.getType()===s.Bx.RoomMessage||e.hasAssociation()?"message":null}constructor(e=c.RETRY_BACKOFF_RATELIMIT,t=c.QUEUE_MESSAGES){this.retryAlgorithm=e,this.queueAlgorithm=t,(0,n.A)(this,"queues",{}),(0,n.A)(this,"activeQueues",[]),(0,n.A)(this,"procFn",null),(0,n.A)(this,"processQueue",(e=>{const t=this.peekNextEvent(e);t?(d("Queue '%s' has %s pending events",e,this.queues[e].length),Promise.resolve().then((()=>this.procFn(t.event))).then((i=>{this.removeNextEvent(e),d("Queue '%s' sent event %s",e,t.event.getId()),t.defer.resolve(i),this.processQueue(e)}),(i=>{t.attempts+=1;const n=this.retryAlgorithm(t.event,t.attempts,i);d("retry(%s) err=%s event_id=%s waitTime=%s",t.attempts,i,t.event.getId(),n),-1===n?(r.v.info("Queue '%s' giving up on event %s",e,t.event.getId()),this.clearQueue(e,i)):setTimeout(this.processQueue,n,e)}))):this.disableQueue(e)}))}getQueueForEvent(e){const t=this.queueAlgorithm(e);return t&&this.queues[t]?this.queues[t].map((function(e){return e.event})):null}removeEventFromQueue(e){const t=this.queueAlgorithm(e);if(!t||!this.queues[t])return!1;let i=!1;return(0,o.Nz)(this.queues[t],(t=>t.event.getId()===e.getId()&&(i=!0,!0))),i}setProcessFunction(e){this.procFn=e,this.startProcessingQueues()}queueEvent(e){const t=this.queueAlgorithm(e);if(!t)return null;this.queues[t]||(this.queues[t]=[]);const i=(0,o.v6)();return this.queues[t].push({event:e,defer:i,attempts:0}),d("Queue algorithm dumped event %s into queue '%s'",e.getId(),t),this.startProcessingQueues(),i.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter((e=>-1===this.activeQueues.indexOf(e)&&this.queues[e].length>0)).forEach((e=>{this.activeQueues.push(e),d("Spinning up queue: '%s'",e),this.processQueue(e)}))}disableQueue(e){const t=this.activeQueues.indexOf(e);t>=0&&this.activeQueues.splice(t,1),r.v.info("Stopping queue '%s' as it is now empty",e)}clearQueue(e,t){let i;for(r.v.info("clearing queue '%s'",e);i=this.removeNextEvent(e);)i.defer.reject(t);this.disableQueue(e)}peekNextEvent(e){const t=this.queues[e];if(Array.isArray(t))return t[0]}removeNextEvent(e){const t=this.queues[e];if(Array.isArray(t))return t.shift()}}function d(...e){false}},"./node_modules/matrix-js-sdk/src/secret-storage.ts":(e,t,i)=>{"use strict";i.d(t,{SECRET_STORAGE_ALGORITHM_V1_AES:()=>a,ServerSideSecretStorageImpl:()=>c});var n=i("./node_modules/matrix-js-sdk/src/client.ts"),r=i("./node_modules/matrix-js-sdk/src/crypto/aes.ts"),s=i("./node_modules/matrix-js-sdk/src/randomstring.ts"),o=i("./node_modules/matrix-js-sdk/src/logger.ts");const a="m.secret_storage.v1.aes-hmac-sha2";class c{constructor(e,t){this.accountDataAdapter=e,this.callbacks=t}async getDefaultKeyId(){const e=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return e?e.key:null}setDefaultKeyId(e){return new Promise(((t,i)=>{const r=i=>{"m.secret_storage.default_key"===i.getType()&&i.getContent().key===e&&(this.accountDataAdapter.removeListener(n.AU.AccountData,r),t())};this.accountDataAdapter.on(n.AU.AccountData,r),this.accountDataAdapter.setAccountData("m.secret_storage.default_key",{key:e}).catch((e=>{this.accountDataAdapter.removeListener(n.AU.AccountData,r),i(e)}))}))}async addKey(e,t,i){if(e!==a)throw new Error(`Unknown key algorithm ${e}`);const n={algorithm:e};t.name&&(n.name=t.name),t.passphrase&&(n.passphrase=t.passphrase);const{iv:o,mac:c}=await(0,r.iV)(t.key);if(n.iv=o,n.mac=c,!i)do{i=(0,s.DU)(32)}while(await this.accountDataAdapter.getAccountDataFromServer(`m.secret_storage.key.${i}`));return await this.accountDataAdapter.setAccountData(`m.secret_storage.key.${i}`,n),{keyId:i,keyInfo:n}}async getKey(e){if(e||(e=await this.getDefaultKeyId()),!e)return null;const t=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e);return t?[e,t]:null}async hasKey(e){const t=await this.getKey(e);return Boolean(t)}async checkKey(e,t){if(t.algorithm===a){if(t.mac){const{mac:i}=await(0,r.iV)(e,t.iv);return d(t.mac)===d(i)}return!0}throw new Error("Unknown algorithm")}async store(e,t,i){const n={};if(!i){const e=await this.getDefaultKeyId();if(!e)throw new Error("No keys specified and no default key present");i=[e]}if(0===i.length)throw new Error("Zero keys given to encrypt with!");for(const r of i){const i=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+r);if(!i)throw new Error("Unknown key: "+r);if(i.algorithm===a){const s={[r]:i},[,o]=await this.getSecretStorageKey(s,e);n[r]=await o.encrypt(t)}else o.v.warn("unknown algorithm for secret storage key "+r+": "+i.algorithm)}await this.accountDataAdapter.setAccountData(e,{encrypted:n})}async get(e){const t=await this.accountDataAdapter.getAccountDataFromServer(e);if(!t)return;if(!t.encrypted)throw new Error("Content is not encrypted!");const i={};for(const e of Object.keys(t.encrypted)){const n=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e),r=t.encrypted[e];(null==n?void 0:n.algorithm)===a&&r.iv&&r.ciphertext&&r.mac&&(i[e]=n)}if(0===Object.keys(i).length)throw new Error(`Could not decrypt ${e} because none of the keys it is encrypted with are for a supported algorithm`);const[n,r]=await this.getSecretStorageKey(i,e),s=t.encrypted[n];return r.decrypt(s)}async isStored(e){const t=await this.accountDataAdapter.getAccountDataFromServer(e);if(null==t||!t.encrypted)return null;const i={};for(const e of Object.keys(t.encrypted)){const n=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e);if(!n)continue;const r=t.encrypted[e];n.algorithm===a&&r.iv&&r.ciphertext&&r.mac&&(i[e]=n)}return Object.keys(i).length?i:null}async getSecretStorageKey(e,t){if(!this.callbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");const i=await this.callbacks.getSecretStorageKey({keys:e},t);if(!i)throw new Error("getSecretStorageKey callback returned falsey");if(i.length<2)throw new Error("getSecretStorageKey callback returned invalid data");const[n,s]=i;if(!e[n])throw new Error("App returned unknown key from getSecretStorageKey!");if(e[n].algorithm===a){return[n,{encrypt:function(e){return(0,r.r9)(e,s,t)},decrypt:function(e){return(0,r.VK)(e,s,t)}}]}throw new Error("Unknown key type: "+e[n].algorithm)}}function d(e){let t=e.length;for(;t>=1&&61==e.charCodeAt(t-1);)t--;return t<e.length?e.substring(0,t):e}},"./node_modules/matrix-js-sdk/src/service-types.ts":(e,t,i)=>{"use strict";i.d(t,{S:()=>n});let n=function(e){return e.IS="SERVICE_TYPE_IS",e.IM="SERVICE_TYPE_IM",e}({})},"./node_modules/matrix-js-sdk/src/sliding-sync-sdk.ts":(e,t,i)=>{"use strict";i.d(t,{m:()=>w});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/models/room.ts"),s=i("./node_modules/matrix-js-sdk/src/logger.ts"),o=i("./node_modules/matrix-js-sdk/src/utils.ts"),a=i("./node_modules/matrix-js-sdk/src/models/event-timeline.ts"),c=i("./node_modules/matrix-js-sdk/src/client.ts"),d=i("./node_modules/matrix-js-sdk/src/sync.ts"),l=i("./node_modules/matrix-js-sdk/src/http-api/index.ts"),u=i("./node_modules/matrix-js-sdk/src/sliding-sync.ts"),h=i("./node_modules/matrix-js-sdk/src/@types/event.ts"),m=i("./node_modules/matrix-js-sdk/src/models/room-state.ts"),p=i("./node_modules/matrix-js-sdk/src/models/room-member.ts"),g=i("./node_modules/matrix-js-sdk/src/@types/membership.ts");class v{constructor(e){this.crypto=e}name(){return"e2ee"}when(){return u.HY.PreProcess}onRequest(e){if(e)return{enabled:!0}}async onResponse(e){e.device_lists&&await this.crypto.processDeviceLists(e.device_lists),await this.crypto.processKeyCounts(e.device_one_time_keys_count,e.device_unused_fallback_key_types||e["org.matrix.msc2732.device_unused_fallback_key_types"]),this.crypto.onSyncCompleted({})}}class f{constructor(e,t){this.client=e,this.cryptoCallbacks=t,(0,n.A)(this,"nextBatch",null)}name(){return"to_device"}when(){return u.HY.PreProcess}onRequest(e){const t={since:null!==this.nextBatch?this.nextBatch:void 0};return e&&(t.limit=100,t.enabled=!0),t}async onResponse(e){const t=[];let i=e.events||[];i.length>0&&this.cryptoCallbacks&&(i=await this.cryptoCallbacks.preprocessToDeviceMessages(i)),i.map(this.client.getEventMapper()).map((e=>{if("m.key.verification.cancel"===e.getType()){const i=e.getContent().transaction_id;i&&t.push(i)}return e})).forEach((e=>{const i=e.getContent();if("m.room.message"!=e.getType()||"m.bad.encrypted"!=i.msgtype){if("m.key.verification.start"===e.getType()||"m.key.verification.request"===e.getType()){const n=i.transaction_id;t.includes(n)&&e.flagCancelled()}this.client.emit(c.AU.ToDeviceEvent,e)}else s.v.log("Ignoring undecryptable to-device event from "+e.getSender())})),this.nextBatch=e.next_batch}}class y{constructor(e){this.client=e}name(){return"account_data"}when(){return u.HY.PostProcess}onRequest(e){if(e)return{enabled:!0}}async onResponse(e){e.global&&e.global.length>0&&this.processGlobalAccountData(e.global);for(const t in e.rooms){const i=_(this.client,t,e.rooms[t]),n=this.client.getRoom(t);n?(n.addAccountData(i),i.forEach((e=>{this.client.emit(c.AU.Event,e)}))):s.v.warn("got account data for room but room doesn't exist on client:",t)}}processGlobalAccountData(e){const t=_(this.client,void 0,e),i=t.reduce(((e,t)=>(e[t.getType()]=this.client.store.getAccountData(t.getType()),e)),{});this.client.store.storeAccountDataEvents(t),t.forEach((e=>{if(e.getType()===h.Bx.PushRules){const t=e.getContent();this.client.setPushRules(t)}const t=i[e.getType()];return this.client.emit(c.AU.AccountData,e,t),e}))}}class b{constructor(e){this.client=e}name(){return"typing"}when(){return u.HY.PostProcess}onRequest(e){if(e)return{enabled:!0}}async onResponse(e){if(null!=e&&e.rooms)for(const t in e.rooms)E(this.client,t,[e.rooms[t]])}}class S{constructor(e){this.client=e}name(){return"receipts"}when(){return u.HY.PostProcess}onRequest(e){if(e)return{enabled:!0}}async onResponse(e){if(null!=e&&e.rooms)for(const t in e.rooms)E(this.client,t,[e.rooms[t]])}}class w{constructor(e,t,i,s){this.slidingSync=e,this.client=t,(0,n.A)(this,"opts",void 0),(0,n.A)(this,"syncOpts",void 0),(0,n.A)(this,"syncState",null),(0,n.A)(this,"syncStateData",void 0),(0,n.A)(this,"lastPos",null),(0,n.A)(this,"failCount",0),(0,n.A)(this,"notifEvents",[]),this.opts=(0,d.Bn)(i),this.syncOpts=(0,d.Fe)(s),t.getNotifTimelineSet()&&t.reEmitter.reEmit(t.getNotifTimelineSet(),[r.u9.Timeline,r.u9.TimelineReset]),this.slidingSync.on(u.cQ.Lifecycle,this.onLifecycle.bind(this)),this.slidingSync.on(u.cQ.RoomData,this.onRoomData.bind(this));const o=[new f(this.client,this.syncOpts.cryptoCallbacks),new y(this.client),new b(this.client),new S(this.client)];this.syncOpts.crypto&&o.push(new v(this.syncOpts.crypto)),o.forEach((e=>{this.slidingSync.registerExtension(e)}))}async onRoomData(e,t){let i=this.client.store.getRoom(e);if(!i){if(!t.initial)return void s.v.debug("initial flag not set but no stored room exists for room ",e,t);i=(0,d.M)(this.client,e,this.opts)}await this.processRoomData(this.client,i,t)}onLifecycle(e,t,i){switch(i&&s.v.debug("onLifecycle",e,i),e){case u.ns.Complete:if(this.purgeNotifications(),!t)break;this.lastPos||this.updateSyncState(d.Lm.Prepared,{oldSyncToken:void 0,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.updateSyncState(d.Lm.Syncing,{oldSyncToken:this.lastPos,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.lastPos=t.pos;break;case u.ns.RequestFinished:if(i){if(this.failCount+=1,this.updateSyncState(this.failCount>3?d.Lm.Error:d.Lm.Reconnecting,{error:new l.up(i)}),this.shouldAbortSync(new l.up(i)))return}else this.failCount=0}}async syncLeftRooms(){return[]}async peek(e){return null}stopPeeking(){}setPresence(e){}getSyncState(){return this.syncState}getSyncStateData(){var e;return null!==(e=this.syncStateData)&&void 0!==e?e:null}createRoom(e){const{timelineSupport:t}=this.client,i=new r.Wv(e,this.client,this.client.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:t});return this.client.reEmitter.reEmit(i,[r.u9.Name,r.u9.Redaction,r.u9.RedactionCancelled,r.u9.Receipt,r.u9.Tags,r.u9.LocalEchoUpdated,r.u9.AccountData,r.u9.MyMembership,r.u9.Timeline,r.u9.TimelineReset]),this.registerStateListeners(i),i}registerStateListeners(e){this.client.reEmitter.reEmit(e.currentState,[m.f.Events,m.f.Members,m.f.NewMember,m.f.Update]),e.currentState.on(m.f.NewMember,((e,t,i)=>{var n;i.user=null!==(n=this.client.getUser(i.userId))&&void 0!==n?n:void 0,this.client.reEmitter.reEmit(i,[p.o.Name,p.o.Typing,p.o.PowerLevel,p.o.Membership])}))}shouldAbortSync(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(s.v.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(d.Lm.Error,{error:e}),!0)}async processRoomData(e,t,i){i=function(e,t,i){if(!i.name)return i;for(const e of i.required_state)if(e.type===h.Bx.RoomName&&""===e.state_key)return e.content={name:i.name},i;return i.required_state.push({event_id:"$fake-sliding-sync-name-event-"+t,state_key:"",type:h.Bx.RoomName,content:{name:i.name},sender:e.getUserId(),origin_server_ts:(new Date).getTime()}),i}(e,t.roomId,i);const n=_(this.client,t.roomId,i.required_state);let s=_(this.client,t.roomId,i.timeline,!1);const d=[];if(i.initial){const e=new Set;t.getLiveTimeline().getEvents().forEach((t=>{e.add(t.getId())}));const n=[],r=[];let o=!1;for(let t=s.length-1;t>=0;t--){const i=s[t];e.has(i.getId())?o=!0:o?n.push(i):r.unshift(i)}s=r,n.length>0&&t.addEventsToTimeline(n,!0,t.getLiveTimeline(),i.prev_batch)}const l=t.hasEncryptionStateEvent();if(null!=i.notification_count&&t.setUnreadNotificationCount(r.X5.Total,i.notification_count),null!=i.highlight_count&&(!l||l&&t.getUnreadNotificationCount(r.X5.Highlight)<=0)&&t.setUnreadNotificationCount(r.X5.Highlight,i.highlight_count),Number.isInteger(i.invited_count)&&t.currentState.setInvitedMemberCount(i.invited_count),Number.isInteger(i.joined_count)&&t.currentState.setJoinedMemberCount(i.joined_count),i.invite_state){const e=_(this.client,t.roomId,i.invite_state);return await this.injectRoomEvents(t,e),i.initial&&(t.recalculate(),this.client.store.storeRoom(t),this.client.emit(c.AU.Room,t)),e.forEach((e=>{this.client.emit(c.AU.Event,e)})),void t.updateMyMembership(g.O.Invite)}var u;i.initial&&t.getLiveTimeline().setPaginationToken(null!==(u=i.prev_batch)&&void 0!==u?u:null,a.q.BACKWARDS);await this.injectRoomEvents(t,n,s,i.num_live),t.addEphemeralEvents(d),t.updateMyMembership(g.O.Join),t.recalculate(),i.initial&&(e.store.storeRoom(t),e.emit(c.AU.Room,t)),this.addNotifications(s);const m=async i=>{e.emit(c.AU.Event,i),i.isState()&&i.getType()==h.Bx.RoomEncryption&&this.syncOpts.cryptoCallbacks&&await this.syncOpts.cryptoCallbacks.onCryptoEvent(t,i)};await(0,o.d8)(n,m),await(0,o.d8)(s,m),d.forEach((function(t){e.emit(c.AU.Event,t)})),t.decryptCriticalEvents()}async injectRoomEvents(e,t,i,n){i=i||[],t=t||[],n=n||0;const r=e.getLiveTimeline(),s=0==r.getEvents().length;if(s){for(const e of t)this.client.getPushActionsForEvent(e);r.initialiseState(t)}s||(e.oldState.setStateEvents(t),e.currentState.setStateEvents(t));let o=[];n>0&&(o=i.slice(-1*n),i=i.slice(0,-1*o.length)),await e.addLiveEvents(i,{fromCache:!0}),o.length>0&&await e.addLiveEvents(o,{fromCache:!1}),e.recalculate(),this.resolveInvites(e)}resolveInvites(e){if(!e||!this.opts.resolveInvitesToProfiles)return;const t=this.client;e.getMembersWithMembership(g.O.Invite).forEach((function(i){if(i.requestedProfileInfo)return;i.requestedProfileInfo=!0;const n=t.getUser(i.userId);let r;r=n?Promise.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):t.getProfileInfo(i.userId),r.then((function(t){const n=i.events.member;n.getContent().membership===g.O.Invite&&(n.getContent().avatar_url=t.avatar_url,n.getContent().displayname=t.displayname,i.setMembershipEvent(n,e.currentState))}),(function(e){}))}))}retryImmediately(){return!0}async sync(){for(s.v.debug("Sliding sync init loop");!this.client.isGuest();)try{s.v.debug("Getting push rules...");const e=await this.client.getPushRules();s.v.debug("Got push rules"),this.client.pushRules=e;break}catch(e){if(s.v.error("Getting push rules failed",e),this.shouldAbortSync(e))return}await this.slidingSync.start()}stop(){s.v.debug("SyncApi.stop"),this.slidingSync.stop()}updateSyncState(e,t){const i=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(c.AU.Sync,this.syncState,i,t)}addNotifications(e){if(this.client.getNotifTimelineSet())for(const t of e){const e=this.client.getPushActionsForEvent(t);e&&e.notify&&e.tweaks&&e.tweaks.highlight&&this.notifEvents.push(t)}}purgeNotifications(){this.notifEvents.sort((function(e,t){return e.getTs()-t.getTs()})),this.notifEvents.forEach((e=>{var t;null===(t=this.client.getNotifTimelineSet())||void 0===t||t.addLiveEvent(e)})),this.notifEvents=[]}}function _(e,t,i,n=!0){const r=e.getEventMapper({decrypt:n});return i.map((function(e){return e.room_id=t,r(e)}))}function E(e,t,i){const n=_(e,t,i),r=e.getRoom(t);r?(r.addEphemeralEvents(n),n.forEach((t=>{e.emit(c.AU.Event,t)}))):s.v.warn("got ephemeral events for room but room doesn't exist on client:",t)}},"./node_modules/matrix-js-sdk/src/sliding-sync.ts":(e,t,i)=>{"use strict";i.d(t,{HY:()=>s,cQ:()=>o,ns:()=>r});i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),i("./node_modules/matrix-js-sdk/src/logger.ts");var n=i("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts");i("./node_modules/matrix-js-sdk/src/utils.ts");let r=function(e){return e.RequestFinished="FINISHED",e.Complete="COMPLETE",e}({});let s=function(e){return e.PreProcess="ExtState.PreProcess",e.PostProcess="ExtState.PostProcess",e}({}),o=function(e){return e.RoomData="SlidingSync.RoomData",e.Lifecycle="SlidingSync.Lifecycle",e.List="SlidingSync.List",e}({});n.X},"./node_modules/matrix-js-sdk/src/sync.ts":(e,t,i)=>{"use strict";i.d(t,{Bn:()=>R,Fe:()=>T,Lm:()=>w,M:()=>A,w_:()=>C});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/models/user.ts"),s=i("./node_modules/matrix-js-sdk/src/models/room.ts"),o=i("./node_modules/matrix-js-sdk/src/utils.ts"),a=i("./node_modules/matrix-js-sdk/src/filter.ts"),c=i("./node_modules/matrix-js-sdk/src/models/event-timeline.ts"),d=i("./node_modules/matrix-js-sdk/src/logger.ts"),l=i("./node_modules/matrix-js-sdk/src/client.ts"),u=i("./node_modules/matrix-js-sdk/src/http-api/index.ts"),h=i("./node_modules/matrix-js-sdk/src/@types/event.ts"),m=i("./node_modules/matrix-js-sdk/src/models/room-state.ts"),p=i("./node_modules/matrix-js-sdk/src/models/room-member.ts"),g=i("./node_modules/matrix-js-sdk/src/models/beacon.ts"),v=i("./node_modules/matrix-js-sdk/src/@types/sync.ts"),f=i("./node_modules/matrix-js-sdk/src/feature.ts"),y=i("./node_modules/matrix-js-sdk/src/@types/membership.ts");function b(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function S(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?b(Object(i),!0).forEach((function(t){(0,n.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):b(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let w=function(e){return e.Error="ERROR",e.Prepared="PREPARED",e.Stopped="STOPPED",e.Syncing="SYNCING",e.Catchup="CATCHUP",e.Reconnecting="RECONNECTING",e}({});const _=["org.matrix.msc2716v3"];function E(e,t){return`FILTER_SYNC_${e}`+(t?"_"+t:"")}function I(...e){d.v.log(...e)}let k=function(e){return e.Offline="offline",e.Online="online",e.Unavailable="unavailable",e}({});function R(e){return S({initialSyncLimit:8,resolveInvitesToProfiles:!1,pollTimeout:3e4,pendingEventOrdering:l.eO.Chronological,threadSupport:!1},e)}function T(e){return S({canResetEntireTimeline:e=>!1},e)}class C{constructor(e,t,i){this.client=e,(0,n.A)(this,"opts",void 0),(0,n.A)(this,"syncOpts",void 0),(0,n.A)(this,"_peekRoom",null),(0,n.A)(this,"currentSyncRequest",void 0),(0,n.A)(this,"abortController",void 0),(0,n.A)(this,"syncState",null),(0,n.A)(this,"syncStateData",void 0),(0,n.A)(this,"catchingUp",!1),(0,n.A)(this,"running",!1),(0,n.A)(this,"keepAliveTimer",void 0),(0,n.A)(this,"connectionReturnedDefer",void 0),(0,n.A)(this,"notifEvents",[]),(0,n.A)(this,"failedSyncCount",0),(0,n.A)(this,"storeIsInvalid",!1),(0,n.A)(this,"presence",void 0),(0,n.A)(this,"getPushRules",(async()=>{try{I("Getting push rules...");const e=await this.client.getPushRules();I("Got push rules"),this.client.pushRules=e}catch(e){if(d.v.error("Getting push rules failed",e),this.shouldAbortSync(e))return;return I("Waiting for saved sync before retrying push rules..."),await this.recoverFromSyncStartupError(this.savedSyncPromise,e),this.getPushRules()}})),(0,n.A)(this,"buildDefaultFilter",(()=>{const e=new a.d(this.client.credentials.userId);return this.client.canSupport.get(f.Xj.ThreadUnreadNotifications)!==f.Tj.Unsupported&&e.setUnreadThreadNotifications(!0),e})),(0,n.A)(this,"prepareLazyLoadingForSync",(async()=>{var e;(I("Prepare lazy loading for sync..."),this.client.isGuest()&&(this.opts.lazyLoadMembers=!1),this.opts.lazyLoadMembers&&(I("Enabling lazy load on sync filter..."),this.opts.filter||(this.opts.filter=this.buildDefaultFilter()),this.opts.filter.setLazyLoadMembers(!0)),this.opts.lazyLoadMembers)&&(null===(e=this.syncOpts.crypto)||void 0===e||e.enableLazyLoading())})),(0,n.A)(this,"storeClientOptions",(async()=>{try{I("Storing client options..."),await this.client.storeClientOptions(),I("Stored client options")}catch(e){throw d.v.error("Storing client options failed",e),e}})),(0,n.A)(this,"getFilter",(async()=>{let e,t;I("Getting filter..."),e=this.opts.filter?this.opts.filter:this.buildDefaultFilter();try{t=await this.client.getOrCreateFilter(E(this.client.credentials.userId),e)}catch(e){return d.v.error("Getting filter failed",e),this.shouldAbortSync(e)?{}:(I("Waiting for saved sync before retrying filter..."),await this.recoverFromSyncStartupError(this.savedSyncPromise,e),this.getFilter())}return{filter:e,filterId:t}})),(0,n.A)(this,"savedSyncPromise",void 0),(0,n.A)(this,"onOnline",(()=>{I("Browser thinks we are back online"),this.startKeepAlives(0)})),this.opts=R(t),this.syncOpts=T(i),e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),[s.u9.Timeline,s.u9.TimelineReset])}createRoom(e){const t=A(this.client,e,this.opts);return t.on(m.f.Marker,((e,i)=>{this.onMarkerStateEvent(t,e,i)})),t}onMarkerStateEvent(e,t,{timelineWasEmpty:i}={}){if(i)return void d.v.debug(`MarkerState: Ignoring markerEventId=${t.getId()} in roomId=${e.roomId} because the timeline was empty before the marker arrived which means there is nothing to refresh.`);_.includes(e.getVersion())||t.getSender()===e.getCreator()?(d.v.debug(`MarkerState: Timeline needs to be refreshed because a new markerEventId=${t.getId()} was sent in roomId=${e.roomId}`),e.setTimelineNeedsRefresh(!0),e.emit(s.u9.HistoryImportedWithinTimeline,t,e)):d.v.debug(`MarkerState: Ignoring markerEventId=${t.getId()} in roomId=${e.roomId} because MSC2716 is not supported in the room version or for any room version, the marker wasn't sent by the room creator.`)}async syncLeftRooms(){var e;const t=this.client,i=new a.d(this.client.credentials.userId);i.setTimelineLimit(1),i.setIncludeLeaveRooms(!0);const n=this.opts.pollTimeout+8e4,r={timeout:0,filter:await t.getOrCreateFilter(E(t.credentials.userId,"LEFT_ROOMS"),i)},s=await t.http.authedRequest(u.IT.Get,"/sync",r,void 0,{localTimeoutMs:n});let o=[];null!==(e=s.rooms)&&void 0!==e&&e.leave&&(o=this.mapSyncResponseToRoomArray(s.rooms.leave));return(await Promise.all(o.map((async e=>{const i=e.room;if(!e.isBrandNewRoom)return;e.timeline=e.timeline||{prev_batch:null,events:[]};const n=this.mapSyncEventsFormat(e.timeline,i),r=this.mapSyncEventsFormat(e.state,i);return i.getLiveTimeline().setPaginationToken(e.timeline.prev_batch,c.q.BACKWARDS),await this.injectRoomEvents(i,r,n),i.recalculate(),t.store.storeRoom(i),t.emit(l.AU.Room,i),this.processEventsForNotifs(i,n),i})))).filter(Boolean)}peek(e){var t;if((null===(t=this._peekRoom)||void 0===t?void 0:t.roomId)===e)return Promise.resolve(this._peekRoom);const i=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,20).then((t=>{var n;if((null===(n=this._peekRoom)||void 0===n?void 0:n.roomId)!==e)throw new Error("Peeking aborted");t.messages=t.messages||{chunk:[]},t.messages.chunk=t.messages.chunk||[],t.state=t.state||[];const s=(0,o.A4)(t.state).map(i.getEventMapper()),a=t.state.map(i.getEventMapper()),c=t.messages.chunk.map(i.getEventMapper());return Array.isArray(t.presence)&&t.presence.map(i.getEventMapper()).forEach((function(e){let t=i.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):(t=r.K.createUser(e.getContent().user_id,i),t.setPresenceEvent(e),i.store.storeUser(t)),i.emit(l.AU.Event,e)})),t.messages.start&&(this._peekRoom.oldState.paginationToken=t.messages.start),this._peekRoom.oldState.setStateEvents(s),this._peekRoom.currentState.setStateEvents(a),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(c.reverse(),!0,this._peekRoom.getLiveTimeline(),t.messages.start),i.store.storeRoom(this._peekRoom),i.emit(l.AU.Room,this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom}))}stopPeeking(){this._peekRoom=null}peekPoll(e,t){var i;this._peekRoom===e?this.client.http.authedRequest(u.IT.Get,"/events",{room_id:e.roomId,timeout:String(3e4),from:t},void 0,{localTimeoutMs:5e4,abortSignal:null===(i=this.abortController)||void 0===i?void 0:i.signal}).then((async t=>{if(this._peekRoom!==e)return void I("Stopped peeking in room %s",e.roomId);t.chunk.filter((function(e){return"m.presence"===e.type})).map(this.client.getEventMapper()).forEach((e=>{let t=this.client.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):(t=r.K.createUser(e.getContent().user_id,this.client),t.setPresenceEvent(e),this.client.store.storeUser(t)),this.client.emit(l.AU.Event,e)}));const i=t.chunk.filter((function(t){return t.room_id===e.roomId&&t.event_id})).map(this.client.getEventMapper());await e.addLiveEvents(i),this.peekPoll(e,t.end)}),(i=>{d.v.error("[%s] Peek poll failed: %s",e.roomId,i),setTimeout((()=>{this.peekPoll(e,t)}),3e4)})):I("Stopped peeking in room %s",e.roomId)}getSyncState(){return this.syncState}getSyncStateData(){var e;return null!==(e=this.syncStateData)&&void 0!==e?e:null}async recoverFromSyncStartupError(e,t){await e;const i=this.startKeepAlives();this.updateSyncState(w.Error,{error:t}),await i}shouldAbortSync(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(d.v.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(w.Error,{error:e}),!0)}async sync(){var e,t;if(this.running=!0,this.abortController=new AbortController,null===(e=i.g.window)||void 0===e||null===(t=e.addEventListener)||void 0===t||t.call(e,"online",this.onOnline,!1),this.client.isGuest())return this.doSync({});I("Getting saved sync token...");const n=this.client.store.getSavedSyncToken().then((e=>(I("Got saved sync token"),e)));this.savedSyncPromise=this.client.store.getSavedSync().then((e=>{if(I(`Got reply from saved sync, exists? ${!!e}`),e)return this.syncFromCache(e)})).catch((e=>{d.v.error("Getting saved sync failed",e)})),await this.getPushRules(),await this.prepareLazyLoadingForSync(),await this.storeClientOptions();const{filterId:r,filter:s}=await this.getFilter();if(s){if(this.client.resetNotifTimelineSet(),!this.currentSyncRequest){let e=r;const t=await n;if(t)I("Sending first sync request...");else{I("Sending initial sync request...");const t=this.buildDefaultFilter();t.setDefinition(s.getDefinition()),t.setTimelineLimit(this.opts.initialSyncLimit),e=JSON.stringify(t.getDefinition())}this.currentSyncRequest=this.doSyncRequest({filter:e},t)}return I("Waiting for saved sync before starting sync processing..."),await this.savedSyncPromise,this.doSync({filter:r})}}stop(){var e,t,n;I("SyncApi.stop"),null===(e=i.g.window)||void 0===e||null===(t=e.removeEventListener)||void 0===t||t.call(e,"online",this.onOnline,!1),this.running=!1,null===(n=this.abortController)||void 0===n||n.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=void 0)}retryImmediately(){return!!this.connectionReturnedDefer&&(this.startKeepAlives(0),!0)}async syncFromCache(e){I("sync(): not doing HTTP hit, instead returning stored /sync data");const t=e.nextBatch;this.client.store.setSyncToken(t);const i={nextSyncToken:t,catchingUp:!1,fromCache:!0},n={next_batch:t,rooms:e.roomsData,account_data:{events:e.accountData}};try{await this.processSyncResponse(i,n)}catch(e){d.v.error("Error processing cached sync",e)}this.storeIsInvalid||this.updateSyncState(w.Prepared,i)}async doSync(e){for(;this.running;){const t=this.client.store.getSyncToken();let i;try{this.currentSyncRequest||(this.currentSyncRequest=this.doSyncRequest(e,t)),i=await this.currentSyncRequest}catch(e){if(await this.onSyncError(e))return;continue}finally{this.currentSyncRequest=void 0}this.client.store.setSyncToken(i.next_batch),this.failedSyncCount=0;const n={oldSyncToken:null!=t?t:void 0,nextSyncToken:i.next_batch,catchingUp:this.catchingUp};this.syncOpts.crypto&&await this.syncOpts.crypto.onSyncWillProcess(n);try{await this.processSyncResponse(n,i)}catch(e){d.v.error("Caught /sync error",e),this.client.emit(l.AU.SyncUnexpectedError,e)}await this.client.store.setSyncData(i),n.catchingUp=this.catchingUp,e.hasSyncedBefore||(this.updateSyncState(w.Prepared,n),e.hasSyncedBefore=!0),this.syncOpts.cryptoCallbacks&&await this.syncOpts.cryptoCallbacks.onSyncCompleted(n),this.updateSyncState(w.Syncing,n),this.client.store.wantsSave()&&(this.syncOpts.crypto&&await this.syncOpts.crypto.saveDeviceList(0),await this.client.store.save())}this.running||(I("Sync no longer running: exiting."),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject(),this.connectionReturnedDefer=void 0),this.updateSyncState(w.Stopped))}doSyncRequest(e,t){var i;const n=this.getSyncParams(e,t);return this.client.http.authedRequest(u.IT.Get,"/sync",n,void 0,{localTimeoutMs:n.timeout+8e4,abortSignal:null===(i=this.abortController)||void 0===i?void 0:i.signal})}getSyncParams(e,t){let i=this.opts.pollTimeout;(this.getSyncState()!==w.Syncing||this.catchingUp)&&(this.catchingUp=!0,i=0);let n=e.filter;this.client.isGuest()&&!n&&(n=this.getGuestFilter());const r={filter:n,timeout:i};return this.opts.disablePresence?r.set_presence=k.Offline:void 0!==this.presence&&(r.set_presence=this.presence),t?r.since=t:r._cacheBuster=Date.now(),[w.Reconnecting,w.Error].includes(this.getSyncState())&&(r.timeout=0),r}setPresence(e){this.presence=e}async onSyncError(e){if(!this.running)return I("Sync no longer running: exiting"),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject(),this.connectionReturnedDefer=void 0),this.updateSyncState(w.Stopped),!0;if(d.v.error("/sync error %s",e),this.shouldAbortSync(e))return!0;this.failedSyncCount++,d.v.log("Number of consecutive failed sync requests:",this.failedSyncCount),I("Starting keep-alive");const t=this.startKeepAlives();this.currentSyncRequest=void 0,this.updateSyncState(this.failedSyncCount>=3?w.Error:w.Reconnecting,{error:e});return await t&&this.getSyncState()===w.Error&&this.updateSyncState(w.Catchup,{catchingUp:!0}),!1}async processSyncResponse(e,t){var i,n,a,u;const m=this.client;if(Array.isArray(null===(i=t.presence)||void 0===i?void 0:i.events)&&t.presence.events.filter(o.O5).map(m.getEventMapper()).forEach((function(e){let t=m.store.getUser(e.getSender());t?t.setPresenceEvent(e):(t=r.K.createUser(e.getSender(),m),t.setPresenceEvent(e),m.store.storeUser(t)),m.emit(l.AU.Event,e)})),Array.isArray(null===(n=t.account_data)||void 0===n?void 0:n.events)){const e=t.account_data.events.filter(o.O5).map(m.getEventMapper()),i=e.reduce(((e,t)=>(e[t.getType()]=m.store.getAccountData(t.getType()),e)),{});m.store.storeAccountDataEvents(e),e.forEach((function(e){if(e.getType()===h.Bx.PushRules){const t=e.getContent();m.setPushRules(t)}const t=i[e.getType()];return m.emit(l.AU.AccountData,e,t),e}))}if(t.to_device&&Array.isArray(t.to_device.events)&&t.to_device.events.length>0){let e=t.to_device.events.filter(o.O5);this.syncOpts.cryptoCallbacks&&(e=await this.syncOpts.cryptoCallbacks.preprocessToDeviceMessages(e));const i=[];e.map(m.getEventMapper({toDevice:!0})).map((e=>{if("m.key.verification.cancel"===e.getType()){const t=e.getContent().transaction_id;t&&i.push(t)}return e})).forEach((function(e){const t=e.getContent();if("m.room.message"!=e.getType()||"m.bad.encrypted"!=t.msgtype){if("m.key.verification.start"===e.getType()||"m.key.verification.request"===e.getType()){const n=t.transaction_id;i.includes(n)&&e.flagCancelled()}m.emit(l.AU.ToDeviceEvent,e)}else d.v.log("Ignoring undecryptable to-device event from "+e.getSender())}))}else this.catchingUp=!1;let p=[],g=[],f=[],y=[];t.rooms&&(t.rooms.invite&&(p=this.mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(g=this.mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(f=this.mapSyncResponseToRoomArray(t.rooms.leave)),t.rooms.knock&&(y=this.mapSyncResponseToRoomArray(t.rooms.knock))),this.notifEvents=[],await(0,o.d8)(p,(async e=>{var t;const i=e.room,n=this.mapSyncEventsFormat(e.invite_state,i);await this.injectRoomEvents(i,n);const r=null===(t=i.currentState.getStateEvents(h.Bx.RoomMember,m.getUserId()))||void 0===t?void 0:t.getSender(),s=m.crypto;if(s){const e=await s.cryptoStore.takeParkedSharedHistory(i.roomId);for(const t of e)t.senderId===r&&await s.olmDevice.addInboundGroupSession(i.roomId,t.senderKey,t.forwardingCurve25519KeyChain,t.sessionId,t.sessionKey,t.keysClaimed,!0,{sharedHistory:!0,untrusted:!0})}e.isBrandNewRoom?(i.recalculate(),m.store.storeRoom(i),m.emit(l.AU.Room,i)):i.recalculate(),n.forEach((function(e){m.emit(l.AU.Event,e)}))})),await(0,o.d8)(g,(async t=>{var i;const n=t.room,r=this.mapSyncEventsFormat(t.state,n),o=this.mapSyncEventsFormat(t.timeline,n,!1),a=this.mapSyncEventsFormat(t.ephemeral),u=this.mapSyncEventsFormat(t.account_data),p=this.isRoomEncrypted(n,r,o);if(t.unread_notifications){var g,f;if(!p||0===t.unread_notifications.notification_count)n.setUnreadNotificationCount(s.X5.Total,null!==(g=t.unread_notifications.notification_count)&&void 0!==g?g:0);if(!p||n.getUnreadNotificationCount(s.X5.Highlight)<=0)n.setUnreadNotificationCount(s.X5.Highlight,null!==(f=t.unread_notifications.highlight_count)&&void 0!==f?f:0)}const y=null!==(i=t[v.a.name])&&void 0!==i?i:t[v.a.altName];if(y){n.resetThreadUnreadNotificationCountFromSync(Object.keys(y));for(const[e,t]of Object.entries(y)){var b;if(!p||0===t.notification_count)n.setThreadUnreadNotificationCount(e,s.X5.Total,null!==(b=t.notification_count)&&void 0!==b?b:0);const i=n.getThreadUnreadNotificationCount(e,s.X5.Highlight)<=0;var S;if(!p||p&&i)n.setThreadUnreadNotificationCount(e,s.X5.Highlight,null!==(S=t.highlight_count)&&void 0!==S?S:0)}}else n.resetThreadUnreadNotificationCountFromSync();if(t.timeline=t.timeline||{},t.isBrandNewRoom)null!==t.timeline.prev_batch&&n.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,c.q.BACKWARDS);else if(t.timeline.limited){let i=!0;for(let e=o.length-1;e>=0;e--){const t=o[e].getId();if(n.getTimelineForEvent(t)){I(`Already have event ${t} in limited sync - not resetting`),i=!1,o.splice(0,e);break}}var w;if(i)n.resetLiveTimeline(t.timeline.prev_batch,this.syncOpts.canResetEntireTimeline(n.roomId)?null:null!==(w=e.oldSyncToken)&&void 0!==w?w:null),m.resetNotifTimelineSet()}if(this.syncOpts.cryptoCallbacks)for(const e of r.concat(o))e.isState()&&e.getType()===h.Bx.RoomEncryption&&""===e.getStateKey()&&await this.syncOpts.cryptoCallbacks.onCryptoEvent(n,e);try{await this.injectRoomEvents(n,r,o,e.fromCache)}catch(e){d.v.error(`Failed to process events on room ${n.roomId}:`,e)}t.summary&&n.setSummary(t.summary),n.addEphemeralEvents(a),n.addAccountData(u),n.recalculate(),t.isBrandNewRoom&&(m.store.storeRoom(n),m.emit(l.AU.Room,n)),this.processEventsForNotifs(n,o);const _=e=>m.emit(l.AU.Event,e);r.forEach(_),o.forEach(_),a.forEach(_),u.forEach(_),n.decryptCriticalEvents()})),await(0,o.d8)(f,(async e=>{const t=e.room,i=this.mapSyncEventsFormat(e.state,t),n=this.mapSyncEventsFormat(e.timeline,t),r=this.mapSyncEventsFormat(e.account_data);await this.injectRoomEvents(t,i,n),t.addAccountData(r),t.recalculate(),e.isBrandNewRoom&&(m.store.storeRoom(t),m.emit(l.AU.Room,t)),this.processEventsForNotifs(t,n),i.forEach((function(e){m.emit(l.AU.Event,e)})),n.forEach((function(e){m.emit(l.AU.Event,e)})),r.forEach((function(e){m.emit(l.AU.Event,e)}))})),await(0,o.d8)(y,(async e=>{const t=e.room,i=this.mapSyncEventsFormat(e.knock_state,t);await this.injectRoomEvents(t,i),e.isBrandNewRoom?(t.recalculate(),m.store.storeRoom(t),m.emit(l.AU.Room,t)):t.recalculate(),i.forEach((function(e){m.emit(l.AU.Event,e)}))})),e.oldSyncToken&&this.notifEvents.length&&(this.notifEvents.sort((function(e,t){return e.getTs()-t.getTs()})),this.notifEvents.forEach((function(e){var t;null===(t=m.getNotifTimelineSet())||void 0===t||t.addLiveEvent(e)}))),t.device_lists&&this.syncOpts.cryptoCallbacks&&await this.syncOpts.cryptoCallbacks.processDeviceLists(t.device_lists),await(null===(a=this.syncOpts.cryptoCallbacks)||void 0===a?void 0:a.processKeyCounts(t.device_one_time_keys_count,null!==(u=t.device_unused_fallback_key_types)&&void 0!==u?u:t["org.matrix.msc2732.device_unused_fallback_key_types"]))}startKeepAlives(e){return void 0===e&&(e=2e3+Math.floor(5e3*Math.random())),null!==this.keepAliveTimer&&clearTimeout(this.keepAliveTimer),e>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),e):this.pokeKeepAlive(),this.connectionReturnedDefer||(this.connectionReturnedDefer=(0,o.v6)()),this.connectionReturnedDefer.promise}pokeKeepAlive(e=!1){var t;if(!this.running)return clearTimeout(this.keepAliveTimer),void(this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject("SyncApi.stop() was called"),this.connectionReturnedDefer=void 0));const i=()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedDefer&&(this.connectionReturnedDefer.resolve(e),this.connectionReturnedDefer=void 0)};this.client.http.request(u.IT.Get,"/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15e3,abortSignal:null===(t=this.abortController)||void 0===t?void 0:t.signal}).then((()=>{i()}),(t=>{400==t.httpStatus||404==t.httpStatus?this.keepAliveTimer=setTimeout(i,2e3):(e=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,e),5e3+Math.floor(5e3*Math.random())),this.updateSyncState(w.Error,{error:t}))}))}mapSyncResponseToRoomArray(e){const t=this.client;return Object.keys(e).filter((e=>!(0,o.YY)(e))).map((i=>{let n=t.store.getRoom(i),r=!1;return n||(n=this.createRoom(i),r=!0),S(S({},e[i]),{},{room:n,isBrandNewRoom:r})}))}mapSyncEventsFormat(e,t,i=!0){if(!e||!Array.isArray(e.events))return[];const n=this.client.getEventMapper({decrypt:i});return e.events.filter(o.O5).map((function(e){return t&&(e.room_id=t.roomId),n(e)}))}resolveInvites(e){if(!e||!this.opts.resolveInvitesToProfiles)return;const t=this.client;e.getMembersWithMembership(y.O.Invite).forEach((function(i){if(i.requestedProfileInfo)return;i.requestedProfileInfo=!0;const n=t.getUser(i.userId);let r;r=n?Promise.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):t.getProfileInfo(i.userId),r.then((function(t){const n=i.events.member;(null==n?void 0:n.getContent().membership)===y.O.Invite&&(n.getContent().avatar_url=t.avatar_url,n.getContent().displayname=t.displayname,i.setMembershipEvent(n,e.currentState))}),(function(e){}))}))}findEncryptionEvent(e){return null==e?void 0:e.find((e=>e.getType()===h.Bx.RoomEncryption&&""===e.getStateKey()))}isRoomEncrypted(e,t,i){return e.hasEncryptionStateEvent()||!!this.findEncryptionEvent(t)||!!this.findEncryptionEvent(i)}async injectRoomEvents(e,t,i,n=!1){const r=e.getLiveTimeline(),s=0==r.getEvents().length;if(s){for(const e of t)this.client.getPushActionsForEvent(e);r.initialiseState(t,{timelineWasEmpty:s})}this.resolveInvites(e),e.recalculate(),s||(e.oldState.setStateEvents(t||[]),e.currentState.setStateEvents(t||[])),await e.addLiveEvents(i||[],{fromCache:n,timelineWasEmpty:s}),this.client.processBeaconEvents(e,i)}processEventsForNotifs(e,t){if(this.client.getNotifTimelineSet())for(const e of t){var i;const t=this.client.getPushActionsForEvent(e);null!=t&&t.notify&&null!==(i=t.tweaks)&&void 0!==i&&i.highlight&&this.notifEvents.push(e)}}getGuestFilter(){return"{}"}updateSyncState(e,t){const i=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(l.AU.Sync,this.syncState,i,t)}}function A(e,t,i){const{timelineSupport:n}=e,r=new s.Wv(t,e,e.getUserId(),{lazyLoadMembers:i.lazyLoadMembers,pendingEventOrdering:i.pendingEventOrdering,timelineSupport:n});return e.reEmitter.reEmit(r,[s.u9.Name,s.u9.Redaction,s.u9.RedactionCancelled,s.u9.Receipt,s.u9.Tags,s.u9.LocalEchoUpdated,s.u9.AccountData,s.u9.MyMembership,s.u9.Timeline,s.u9.TimelineReset,m.f.Events,m.f.Members,m.f.NewMember,m.f.Update,g.JH.New,g.JH.Update,g.JH.Destroy,g.JH.LivenessChange]),r.on(m.f.NewMember,((t,i,n)=>{var r;n.user=null!==(r=e.getUser(n.userId))&&void 0!==r?r:void 0,e.reEmitter.reEmit(n,[p.o.Name,p.o.Typing,p.o.PowerLevel,p.o.Membership])})),r}},"./node_modules/matrix-js-sdk/src/types.ts":(e,t,i)=>{"use strict";i.d(t,{V:()=>n});i("./node_modules/matrix-js-sdk/src/@types/membership.ts");let n=function(e){return e.Sas="m.sas.v1",e.ShowQrCode="m.qr_code.show.v1",e.ScanQrCode="m.qr_code.scan.v1",e.Reciprocate="m.reciprocate.v1",e}({})},"./node_modules/matrix-js-sdk/src/utils.ts":(e,t,i)=>{"use strict";i.d(t,{$9:()=>V,A4:()=>b,Ab:()=>g,Bi:()=>z,C6:()=>ne,CC:()=>N,Et:()=>_,Fq:()=>Y,Gp:()=>E,HF:()=>te,Mf:()=>B,NQ:()=>x,Nt:()=>T,Nz:()=>f,O5:()=>re,RR:()=>v,S8:()=>k,UB:()=>y,UD:()=>J,YY:()=>ie,aw:()=>W,d7:()=>I,d8:()=>D,dn:()=>C,hX:()=>P,hc:()=>A,hl:()=>w,hm:()=>p,iH:()=>M,iK:()=>L,j0:()=>U,kG:()=>se,kg:()=>Z,ky:()=>S,ll:()=>X,sy:()=>q,v6:()=>j,yD:()=>m,yy:()=>O,zR:()=>G});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/unhomoglyph/index.js"),s=i.n(r),o=i("./node_modules/p-retry/index.js"),a=i.n(o),c=i("./node_modules/matrix-js-sdk/src/@types/location.ts"),d=i("./node_modules/matrix-js-sdk/src/@types/read_receipts.ts");function l(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function u(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?l(Object(i),!0).forEach((function(t){(0,n.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):l(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const h=new Map;function m(e){return e instanceof String&&(e=e.toString()),h.has(e)||h.set(e,e),h.get(e)}function p(e,t){const i=null!=t?t:new URLSearchParams;for(const[t,n]of Object.entries(e))null!=n&&(Array.isArray(n)?n.forEach((e=>{i.append(t,String(e))})):i.append(t,String(n)));return i}function g(e,t,i){const n=u(u({},i),{},{[t]:i[e]});return delete n[e],n}function v(e,t){for(const i in t){if(!t.hasOwnProperty(i))continue;const n=t[i];null!=n&&(e=e.replace(i,encodeURIComponent(n)))}return e}function f(e,t,i){let n;if(i){for(n=e.length-1;n>=0;n--)if(t(e[n],n,e))return e.splice(n,1),!0}else for(n=0;n<e.length;n++)if(t(e[n],n,e))return e.splice(n,1),!0;return!1}function y(e,t){for(const i of t)if(!e.hasOwnProperty(i))throw new Error("Missing required key: "+i)}function b(e){return JSON.parse(JSON.stringify(e))}function S(e,t){if(e===t)return!0;if(typeof e!=typeof t)return!1;if("number"==typeof e&&isNaN(e)&&isNaN(t))return!0;if(null===e||null===t)return e===t;if(!(e instanceof Object))return!1;if(e.constructor!==t.constructor||e.prototype!==t.prototype)return!1;if(e instanceof RegExp||e instanceof Date)return e.toString()===t.toString();if(Array.isArray(e)){if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(!S(e[i],t[i]))return!1}else{for(const i in t)if(t.hasOwnProperty(i)!==e.hasOwnProperty(i))return!1;for(const i in e)if(t.hasOwnProperty(i)!==e.hasOwnProperty(i)||!S(e[i],t[i]))return!1}return!0}function w(e){if("object"!=typeof e)return e;if(null==e||Array.isArray(e))return e;const t=[];for(const[i,n]of Object.entries(e))t.push([i,w(n)]);return t.sort(((e,t)=>W(e[0],t[0]))),t}function _(e){return"number"==typeof e&&isFinite(e)}function E(e){return"string"==typeof e?s()(e.normalize("NFD").replace(R,"")):""}function I(e){return"string"==typeof e?e.replace(/[\u202d-\u202e]/g,""):""}function k(e){return E(e.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase()}const R=/[\u2000-\u200F\u202A-\u202F\u0300-\u036F\uFEFF\u061C\u2800\u2062-\u2063\s]/g;function T(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function C(e){return T(e).replace(/\\\*/g,".*").replace(/\?/g,".")}function A(e){return null!=e&&e.endsWith("/")?e.slice(0,-1):e}function O(e,t){return new Promise((i=>{setTimeout(i,e,t)}))}async function x(e,t,i){const n=Date.now();try{return await i()}finally{const i=Date.now();e.debug(`[Perf]: ${t} took ${i-n}ms`)}}function M(){return new Promise(setImmediate)}function P(e){return null==e}function j(){let e,t;const i=new Promise(((i,n)=>{e=i,t=n}));return{resolve:e,reject:t,promise:i}}async function D(e,t){for(const i of e)await t(await i)}function U(e){return Promise.resolve(e())}async function L(e,t){const i=[];for(let n=0;n<e.length;n+=t)i.push(...await Promise.all(e.slice(n,n+t).map((e=>e()))));return i}function N(e){return a()((t=>e(t)),{forever:!0,factor:2,minTimeout:3e3,maxTimeout:15e3})}const B=(()=>{let e="";for(let t=32;t<=126;t++)e+=String.fromCharCode(t);return e})();function F(e,t,i=B){return e.padEnd(t,i[0])}function K(e,t=B){const i=BigInt(t.length);var n;if(e<=i)return null!==(n=t[Number(e)-1])&&void 0!==n?n:"";let r=e/i,s=Number(e%i)-1;return s<0&&(r-=BigInt(Math.abs(s)),s=Number(i)-1),K(r,t)+t[s]}function $(e,t=B){const i=BigInt(t.length);let n=BigInt(0);for(let r=e.length-1,s=BigInt(0);r>=0;r--,s++){const o=e.charCodeAt(r)-t.charCodeAt(0);n+=BigInt(1+o)*i**s}return n}function q(e,t,i=B){const n=Math.max(e.length,t.length),r=$(F(e,n,i),i),s=$(F(t,n,i),i),o=(r+s)/BigInt(2);return o===r||o==s?K(o,i)+i[0]:K(o,i)}function V(e,t=B){return K($(e,t)+BigInt(1),t)}function G(e,t=B){return K($(e,t)-BigInt(1),t)}function W(e,t){return e<t?-1:e>t?1:0}const H=new Intl.Collator;function J(e,t){return H.compare(e,t)}function z(e,t,i=!1){for(const[n,r]of Object.entries(t))e[n]instanceof Object&&r?z(e[n],r):null==r&&i||ne(e,n,r);return e}function Q(e){var t;return null!==(t=c.vo.findIn(e.getContent()))&&void 0!==t?t:-1}function Y(e,t){return Q(t)-Q(e)}function X(e){return[d.L.Read,d.L.ReadPrivate].includes(e)}function Z(e,t,i=((e,t)=>e===t)){if(e.size!==t.size)return!1;for(const[n,r]of e){const e=t.get(n);if(void 0===e||!i(r,e))return!1}return!0}function ee(e){return e instanceof Map?te(e):Array.isArray(e)?e.map((e=>ee(e))):e}function te(e){const t=new Map;for(const[i,n]of e)t.set(i,ee(n));return Object.fromEntries(t.entries())}function ie(e){return"__proto__"===e||"prototype"===e||"constructor"===e}function ne(e,t,i){if(ie(t))throw new Error("Trying to modify prototype or constructor");e[t]=i}function re(e){return!(ie(e.room_id)||ie(e.sender)||ie(e.event_id))}class se extends Map{constructor(e){super(),this.createDefault=e}getOrCreate(e){return this.has(e)||this.set(e,this.createDefault()),this.get(e)}}},"./node_modules/matrix-js-sdk/src/version-support.ts":(e,t,i)=>{"use strict";i.d(t,{Hr:()=>n});const n=["v1.1","v1.2","v1.3","v1.4","v1.5","v1.6","v1.7","v1.8","v1.9"];n[0],n[n.length-1]},"./node_modules/matrix-js-sdk/src/webrtc/call.ts":(e,t,i)=>{"use strict";i.d(t,{$E:()=>_,Il:()=>E,QO:()=>S,RA:()=>k,WE:()=>R,iP:()=>y,ms:()=>O,sj:()=>x,sv:()=>M});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/uuid/dist/esm-browser/v4.js"),s=i("./node_modules/sdp-transform/lib/index.js"),o=i("./node_modules/matrix-js-sdk/src/logger.ts"),a=i("./node_modules/matrix-js-sdk/src/utils.ts"),c=i("./node_modules/matrix-js-sdk/src/@types/event.ts"),d=i("./node_modules/matrix-js-sdk/src/randomstring.ts"),l=i("./node_modules/matrix-js-sdk/src/webrtc/callEventTypes.ts"),u=i("./node_modules/matrix-js-sdk/src/webrtc/callFeed.ts"),h=i("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),m=i("./node_modules/matrix-js-sdk/src/crypto/deviceinfo.ts"),p=i("./node_modules/matrix-js-sdk/src/webrtc/groupCall.ts"),g=i("./node_modules/matrix-js-sdk/src/http-api/index.ts");function v(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function f(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?v(Object(i),!0).forEach((function(t){(0,n.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):v(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let y=function(e){return e.Fledgling="fledgling",e.InviteSent="invite_sent",e.WaitLocalMedia="wait_local_media",e.CreateOffer="create_offer",e.CreateAnswer="create_answer",e.Connecting="connecting",e.Connected="connected",e.Ringing="ringing",e.Ended="ended",e}({}),b=function(e){return e.Voice="voice",e.Video="video",e}({}),S=function(e){return e.Inbound="inbound",e.Outbound="outbound",e}({}),w=function(e){return e.Local="local",e.Remote="remote",e}({}),_=function(e){return e.Hangup="hangup",e.State="state",e.Error="error",e.Replaced="replaced",e.LocalHoldUnhold="local_hold_unhold",e.RemoteHoldUnhold="remote_hold_unhold",e.HoldUnhold="hold_unhold",e.FeedsChanged="feeds_changed",e.AssertedIdentityChanged="asserted_identity_changed",e.LengthChanged="length_changed",e.DataChannel="datachannel",e.SendVoipEvent="send_voip_event",e.PeerConnectionCreated="peer_connection_created",e}({}),E=function(e){return e.UserHangup="user_hangup",e.LocalOfferFailed="local_offer_failed",e.NoUserMedia="no_user_media",e.UnknownDevices="unknown_devices",e.SendInvite="send_invite",e.CreateAnswer="create_answer",e.CreateOffer="create_offer",e.SendAnswer="send_answer",e.SetRemoteDescription="set_remote_description",e.SetLocalDescription="set_local_description",e.AnsweredElsewhere="answered_elsewhere",e.IceFailed="ice_failed",e.InviteTimeout="invite_timeout",e.Replaced="replaced",e.SignallingFailed="signalling_timeout",e.UserBusy="user_busy",e.Transferred="transferred",e.NewSession="new_session",e}({});const I=6e4;class k extends Error{constructor(e,t,i){super(t+": "+i),(0,n.A)(this,"code",void 0),this.code=e}}function R(){return Date.now().toString()+(0,d.DU)(16)}function T(e){return[{mediaType:"audio",codec:"opus",enableDtx:!0,maxAverageBitrate:e?12e3:void 0}]}function C(e,t){return e+":"+t}class A extends h.X{constructor(e){var t;if(super(),(0,n.A)(this,"roomId",void 0),(0,n.A)(this,"callId",void 0),(0,n.A)(this,"invitee",void 0),(0,n.A)(this,"hangupParty",void 0),(0,n.A)(this,"hangupReason",void 0),(0,n.A)(this,"direction",void 0),(0,n.A)(this,"ourPartyId",void 0),(0,n.A)(this,"peerConn",void 0),(0,n.A)(this,"toDeviceSeq",0),(0,n.A)(this,"isPtt",!1),(0,n.A)(this,"_state",y.Fledgling),(0,n.A)(this,"client",void 0),(0,n.A)(this,"forceTURN",void 0),(0,n.A)(this,"turnServers",void 0),(0,n.A)(this,"candidateSendQueue",[]),(0,n.A)(this,"candidateSendTries",0),(0,n.A)(this,"candidatesEnded",!1),(0,n.A)(this,"feeds",[]),(0,n.A)(this,"transceivers",new Map),(0,n.A)(this,"inviteOrAnswerSent",!1),(0,n.A)(this,"waitForLocalAVStream",!1),(0,n.A)(this,"successor",void 0),(0,n.A)(this,"opponentMember",void 0),(0,n.A)(this,"opponentVersion",void 0),(0,n.A)(this,"opponentPartyId",void 0),(0,n.A)(this,"opponentCaps",void 0),(0,n.A)(this,"iceDisconnectedTimeout",void 0),(0,n.A)(this,"iceReconnectionTimeOut",void 0),(0,n.A)(this,"inviteTimeout",void 0),(0,n.A)(this,"removeTrackListeners",new Map),(0,n.A)(this,"remoteOnHold",!1),(0,n.A)(this,"callStatsAtEnd",void 0),(0,n.A)(this,"makingOffer",!1),(0,n.A)(this,"ignoreOffer",!1),(0,n.A)(this,"isSettingRemoteAnswerPending",!1),(0,n.A)(this,"responsePromiseChain",void 0),(0,n.A)(this,"remoteCandidateBuffer",new Map),(0,n.A)(this,"remoteAssertedIdentity",void 0),(0,n.A)(this,"remoteSDPStreamMetadata",void 0),(0,n.A)(this,"callLengthInterval",void 0),(0,n.A)(this,"callStartTime",void 0),(0,n.A)(this,"opponentDeviceId",void 0),(0,n.A)(this,"opponentDeviceInfo",void 0),(0,n.A)(this,"opponentSessionId",void 0),(0,n.A)(this,"groupCallId",void 0),(0,n.A)(this,"stopVideoTrackTimer",void 0),(0,n.A)(this,"isOnlyDataChannelAllowed",void 0),(0,n.A)(this,"stats",void 0),(0,n.A)(this,"gotLocalIceCandidate",(e=>{if(e.candidate){if(this.candidatesEnded&&o.v.warn(`Call ${this.callId} gotLocalIceCandidate() got candidate after candidates have ended!`),o.v.debug(`Call ${this.callId} got local ICE ${e.candidate.sdpMid} ${e.candidate.candidate}`),this.callHasEnded())return;""===e.candidate.candidate?this.queueCandidate(null):this.queueCandidate(e.candidate)}})),(0,n.A)(this,"onIceGatheringStateChange",(e=>{var t;o.v.debug(`Call ${this.callId} onIceGatheringStateChange() ice gathering state changed to ${this.peerConn.iceGatheringState}`),"complete"===(null===(t=this.peerConn)||void 0===t?void 0:t.iceGatheringState)&&(this.queueCandidate(null),o.v.debug(`Call ${this.callId} onIceGatheringStateChange() ice gathering state complete, set candidates have ended`))})),(0,n.A)(this,"getLocalOfferFailed",(e=>{o.v.error(`Call ${this.callId} getLocalOfferFailed() running`,e),this.emit(_.Error,new k(E.LocalOfferFailed,"Failed to get local offer!",e),this),this.terminate(w.Local,E.LocalOfferFailed,!1)})),(0,n.A)(this,"getUserMediaFailed",(e=>{this.successor?this.successor.getUserMediaFailed(e):(o.v.warn(`Call ${this.callId} getUserMediaFailed() failed to get user media - ending call`,e),this.emit(_.Error,new k(E.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",e),this),this.terminate(w.Local,E.NoUserMedia,!1))})),(0,n.A)(this,"placeCallFailed",(e=>{this.successor?this.successor.placeCallFailed(e):(o.v.warn(`Call ${this.callId} placeCallWithCallFeeds() failed - ending call`,e),this.emit(_.Error,new k(E.IceFailed,"Couldn't start call! Invalid ICE server configuration.",e),this),this.terminate(w.Local,E.IceFailed,!1))})),(0,n.A)(this,"onIceConnectionStateChanged",(()=>{var e,t,i,n,r,s;if(!this.callHasEnded()){if(o.v.debug(`Call ${this.callId} onIceConnectionStateChanged() running (state=${null===(e=this.peerConn)||void 0===e?void 0:e.iceConnectionState}, conn=${null===(t=this.peerConn)||void 0===t?void 0:t.connectionState})`),["connected","completed"].includes(null!==(i=null===(n=this.peerConn)||void 0===n?void 0:n.iceConnectionState)&&void 0!==i?i:""))clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0,this.iceReconnectionTimeOut&&clearTimeout(this.iceReconnectionTimeOut),this.state=y.Connected,this.callLengthInterval||this.callStartTime||(this.callStartTime=Date.now(),this.callLengthInterval=setInterval((()=>{this.emit(_.LengthChanged,Math.round((Date.now()-this.callStartTime)/1e3),this)}),1e3));else if("failed"==(null===(r=this.peerConn)||void 0===r?void 0:r.iceConnectionState)){var a,c;if(this.candidatesEnded=!1,null!==(a=this.peerConn)&&void 0!==a&&a.restartIce)this.candidatesEnded=!1,o.v.debug(`Call ${this.callId} onIceConnectionStateChanged() ice restart (state=${null===(c=this.peerConn)||void 0===c?void 0:c.iceConnectionState})`),this.peerConn.restartIce();else o.v.info(`Call ${this.callId} onIceConnectionStateChanged() hanging up call (ICE failed and no ICE restart method)`),this.hangup(E.IceFailed,!1)}else"disconnected"==(null===(s=this.peerConn)||void 0===s?void 0:s.iceConnectionState)&&(this.candidatesEnded=!1,this.iceReconnectionTimeOut=setTimeout((()=>{var e,t,i;o.v.info(`Call ${this.callId} onIceConnectionStateChanged() ICE restarting because of ICE disconnected, (state=${null===(e=this.peerConn)||void 0===e?void 0:e.iceConnectionState}, conn=${null===(t=this.peerConn)||void 0===t?void 0:t.connectionState})`),null!==(i=this.peerConn)&&void 0!==i&&i.restartIce&&(this.candidatesEnded=!1,this.peerConn.restartIce()),this.iceReconnectionTimeOut=void 0}),2e3),this.iceDisconnectedTimeout=setTimeout((()=>{o.v.info(`Call ${this.callId} onIceConnectionStateChanged() hanging up call (ICE disconnected for too long)`),this.hangup(E.IceFailed,!1)}),3e4),this.state=y.Connecting);if(this.isPtt&&["failed","disconnected"].includes(this.peerConn.iceConnectionState))for(const e of this.getRemoteFeeds())e.setAudioVideoMuted(!0,!0)}})),(0,n.A)(this,"onSignallingStateChanged",(()=>{var e;o.v.debug(`Call ${this.callId} onSignallingStateChanged() running (state=${null===(e=this.peerConn)||void 0===e?void 0:e.signalingState})`)})),(0,n.A)(this,"onTrack",(e=>{if(0===e.streams.length)return void o.v.warn(`Call ${this.callId} onTrack() called with streamless track streamless (kind=${e.track.kind})`);const t=e.streams[0];if(this.pushRemoteFeed(t),!this.removeTrackListeners.has(t)){const e=()=>{0===t.getTracks().length&&(o.v.info(`Call ${this.callId} onTrack() removing track (streamId=${t.id})`),this.deleteFeedByStream(t),t.removeEventListener("removetrack",e),this.removeTrackListeners.delete(t))};t.addEventListener("removetrack",e),this.removeTrackListeners.set(t,e)}})),(0,n.A)(this,"onDataChannel",(e=>{this.emit(_.DataChannel,e.channel,this)})),(0,n.A)(this,"onNegotiationNeeded",(async()=>{o.v.info(`Call ${this.callId} onNegotiationNeeded() negotiation is needed!`),this.state===y.CreateOffer||0!==this.opponentVersion?this.queueGotLocalOffer():o.v.info(`Call ${this.callId} onNegotiationNeeded() opponent does not support renegotiation: ignoring negotiationneeded event`)})),(0,n.A)(this,"onHangupReceived",(e=>{o.v.debug(`Call ${this.callId} onHangupReceived() running`),this.partyIdMatches(e)||this.state===y.Ringing?this.terminate(w.Remote,e.reason||E.UserHangup,!0):o.v.info(`Call ${this.callId} onHangupReceived() ignoring message from party ID ${e.party_id}: our partner is ${this.opponentPartyId}`)})),(0,n.A)(this,"onRejectReceived",(e=>{o.v.debug(`Call ${this.callId} onRejectReceived() running`);[y.InviteSent,y.Ringing].includes(this.state)||this.state===y.Fledgling&&this.direction===S.Inbound?this.terminate(w.Remote,e.reason||E.UserHangup,!0):o.v.debug(`Call ${this.callId} onRejectReceived() called in wrong state (state=${this.state})`)})),(0,n.A)(this,"onAnsweredElsewhere",(e=>{o.v.debug(`Call ${this.callId} onAnsweredElsewhere() running`),this.terminate(w.Remote,E.AnsweredElsewhere,!0)})),this.roomId=e.roomId,this.invitee=e.invitee,this.client=e.client,!this.client.deviceId)throw new Error("Client must have a device ID to start calls");this.forceTURN=null!==(t=e.forceTURN)&&void 0!==t&&t,this.ourPartyId=this.client.deviceId,this.opponentDeviceId=e.opponentDeviceId,this.opponentSessionId=e.opponentSessionId,this.groupCallId=e.groupCallId,this.turnServers=e.turnServers||[],0===this.turnServers.length&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:["stun:turn.matrix.org"]});for(const e of this.turnServers)(0,a.UB)(e,["urls"]);this.callId=R(),this.isOnlyDataChannelAllowed=this.client.isVoipWithNoMediaAllowed}async placeVoiceCall(){await this.placeCall(!0,!1)}async placeVideoCall(){await this.placeCall(!0,!0)}createDataChannel(e,t){const i=this.peerConn.createDataChannel(e,t);return this.emit(_.DataChannel,i,this),i}getOpponentMember(){return this.opponentMember}getOpponentDeviceId(){return this.opponentDeviceId}getOpponentSessionId(){return this.opponentSessionId}opponentCanBeTransferred(){return Boolean(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return Boolean(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(_.State,e,t,this)}get type(){return this.hasUserMediaVideoSender||this.hasRemoteUserMediaVideoTrack?b.Video:b.Voice}get hasLocalUserMediaVideoTrack(){var e;return!(null===(e=this.localUsermediaStream)||void 0===e||!e.getVideoTracks().length)}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some((e=>{var t;return e.purpose===l.h.Usermedia&&(null===(t=e.stream)||void 0===t?void 0:t.getVideoTracks().length)}))}get hasLocalUserMediaAudioTrack(){var e;return!(null===(e=this.localUsermediaStream)||void 0===e||!e.getAudioTracks().length)}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some((e=>{var t;return e.purpose===l.h.Usermedia&&!(null===(t=e.stream)||void 0===t||!t.getAudioTracks().length)}))}get hasUserMediaAudioSender(){var e;return Boolean(null===(e=this.transceivers.get(C(l.h.Usermedia,"audio")))||void 0===e?void 0:e.sender)}get hasUserMediaVideoSender(){var e;return Boolean(null===(e=this.transceivers.get(C(l.h.Usermedia,"video")))||void 0===e?void 0:e.sender)}get localUsermediaFeed(){return this.getLocalFeeds().find((e=>e.purpose===l.h.Usermedia))}get localScreensharingFeed(){return this.getLocalFeeds().find((e=>e.purpose===l.h.Screenshare))}get localUsermediaStream(){var e;return null===(e=this.localUsermediaFeed)||void 0===e?void 0:e.stream}get localScreensharingStream(){var e;return null===(e=this.localScreensharingFeed)||void 0===e?void 0:e.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find((e=>e.purpose===l.h.Usermedia))}get remoteScreensharingFeed(){return this.getRemoteFeeds().find((e=>e.purpose===l.h.Screenshare))}get remoteUsermediaStream(){var e;return null===(e=this.remoteUsermediaFeed)||void 0===e?void 0:e.stream}get remoteScreensharingStream(){var e;return null===(e=this.remoteScreensharingFeed)||void 0===e?void 0:e.stream}getFeedByStreamId(e){return this.getFeeds().find((t=>t.stream.id===e))}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter((e=>e.isLocal()))}getRemoteFeeds(){return this.feeds.filter((e=>!e.isLocal()))}async initOpponentCrypto(){var e,t;if(!this.opponentDeviceId)return;if(!this.client.getUseE2eForGroupCall())return;if(!this.client.isCryptoEnabled())return void(this.opponentDeviceInfo=new m.V(this.opponentDeviceId));if(!this.client.crypto)throw new Error("Crypto is not initialised.");const i=this.invitee||(null===(e=this.getOpponentMember())||void 0===e?void 0:e.userId);if(!i)throw new Error("Couldn't find opponent user ID to init crypto");const n=await this.client.crypto.deviceList.downloadKeys([i],!1);if(this.opponentDeviceInfo=null===(t=n.get(i))||void 0===t?void 0:t.get(this.opponentDeviceId),void 0===this.opponentDeviceInfo)throw new p.Iy(i)}getLocalSDPStreamMetadata(e=!1){const t={};for(const i of this.getLocalFeeds())e&&(i.sdpMetadataStreamId=i.stream.id),t[i.sdpMetadataStreamId]={purpose:i.purpose,audio_muted:i.isAudioMuted(),video_muted:i.isVideoMuted()};return t}noIncomingFeeds(){return!this.feeds.some((e=>!e.isLocal()))}pushRemoteFeed(e){if(!this.opponentSupportsSDPStreamMetadata())return void this.pushRemoteFeedWithoutMetadata(e);const t=this.getOpponentMember().userId,i=this.remoteSDPStreamMetadata[e.id].purpose,n=this.remoteSDPStreamMetadata[e.id].audio_muted,r=this.remoteSDPStreamMetadata[e.id].video_muted;i?this.getFeedByStreamId(e.id)?o.v.warn(`Call ${this.callId} pushRemoteFeed() ignoring stream because we already have a feed for it (streamId=${e.id})`):(this.feeds.push(new u.Hh({client:this.client,call:this,roomId:this.roomId,userId:t,deviceId:this.getOpponentDeviceId(),stream:e,purpose:i,audioMuted:n,videoMuted:r})),this.emit(_.FeedsChanged,this.feeds,this),o.v.info(`Call ${this.callId} pushRemoteFeed() pushed stream (streamId=${e.id}, active=${e.active}, purpose=${i})`)):o.v.warn(`Call ${this.callId} pushRemoteFeed() ignoring stream because we didn't get any metadata about it (streamId=${e.id})`)}pushRemoteFeedWithoutMetadata(e){var t;const i=this.getOpponentMember().userId,n=l.h.Usermedia,r=null===(t=this.feeds.find((e=>!e.isLocal())))||void 0===t?void 0:t.stream;r&&e.id!==r.id?o.v.warn(`Call ${this.callId} pushRemoteFeedWithoutMetadata() ignoring new stream because we already have stream (streamId=${e.id})`):this.getFeedByStreamId(e.id)?o.v.warn(`Call ${this.callId} pushRemoteFeedWithoutMetadata() ignoring stream because we already have a feed for it (streamId=${e.id})`):(this.feeds.push(new u.Hh({client:this.client,call:this,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:i,deviceId:this.getOpponentDeviceId(),stream:e,purpose:n})),this.emit(_.FeedsChanged,this.feeds,this),o.v.info(`Call ${this.callId} pushRemoteFeedWithoutMetadata() pushed stream (streamId=${e.id}, active=${e.active})`))}pushNewLocalFeed(e,t,i=!0){const n=this.client.getUserId();O(e.getAudioTracks(),!0),O(e.getVideoTracks(),!0),this.getFeedByStreamId(e.id)?o.v.warn(`Call ${this.callId} pushNewLocalFeed() ignoring stream because we already have a feed for it (streamId=${e.id})`):this.pushLocalFeed(new u.Hh({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:n,deviceId:this.getOpponentDeviceId(),stream:e,purpose:t}),i)}pushLocalFeed(e,t=!0){if(this.feeds.some((t=>e.stream.id===t.stream.id)))o.v.info(`Call ${this.callId} pushLocalFeed() ignoring duplicate local stream (streamId=${e.stream.id})`);else{if(this.feeds.push(e),t)for(const t of e.stream.getTracks()){o.v.info(`Call ${this.callId} pushLocalFeed() adding track to peer connection (id=${t.id}, kind=${t.kind}, streamId=${e.stream.id}, streamPurpose=${e.purpose}, enabled=${t.enabled})`);const i=C(e.purpose,t.kind);if(this.transceivers.has(i)){const e=this.transceivers.get(i);e.sender.replaceTrack(t),e.direction="inactive"===e.direction?"sendonly":"sendrecv"}else{const n=this.peerConn.addTrack(t,e.stream),r=this.peerConn.getTransceivers().find((e=>e.sender===n));r?this.transceivers.set(i,r):o.v.warn(`Call ${this.callId} pushLocalFeed() didn't find a matching transceiver after adding track!`)}}o.v.info(`Call ${this.callId} pushLocalFeed() pushed stream (id=${e.stream.id}, active=${e.stream.active}, purpose=${e.purpose})`),this.emit(_.FeedsChanged,this.feeds,this)}}removeLocalFeed(e){const t=C(e.purpose,"audio"),i=C(e.purpose,"video");for(const e of[t,i])if(this.transceivers.has(e)){const t=this.transceivers.get(e);t.sender&&this.peerConn.removeTrack(t.sender)}e.purpose===l.h.Screenshare&&this.client.getMediaHandler().stopScreensharingStream(e.stream),this.deleteFeed(e)}deleteAllFeeds(){for(const e of this.feeds)e.isLocal()&&this.groupCallId||e.dispose();this.feeds=[],this.emit(_.FeedsChanged,this.feeds,this)}deleteFeedByStream(e){const t=this.getFeedByStreamId(e.id);t?this.deleteFeed(t):o.v.warn(`Call ${this.callId} deleteFeedByStream() didn't find the feed to delete (streamId=${e.id})`)}deleteFeed(e){e.dispose(),this.feeds.splice(this.feeds.indexOf(e),1),this.emit(_.FeedsChanged,this.feeds,this)}async getCurrentCallStats(){return this.callHasEnded()?this.callStatsAtEnd:this.collectCallStats()}async collectCallStats(){if(!this.peerConn)return;const e=await this.peerConn.getStats(),t=[];return e.forEach((e=>{t.push(e)})),t}async initWithInvite(e){var t;const i=e.getContent();this.direction=S.Inbound;await this.client.checkTurnServers()||o.v.warn(`Call ${this.callId} initWithInvite() failed to get TURN credentials! Proceeding with call anyway...`);const n=i[l.A];n?this.updateRemoteSDPStreamMetadata(n):o.v.debug(`Call ${this.callId} initWithInvite() did not get any SDPStreamMetadata! Can not send/receive multiple streams`),this.peerConn=this.createPeerConnection(),this.emit(_.PeerConnectionCreated,this.peerConn,this),this.chooseOpponent(e),await this.initOpponentCrypto();try{await this.peerConn.setRemoteDescription(i.offer),o.v.debug(`Call ${this.callId} initWithInvite() set remote description: ${i.offer.type}`),await this.addBufferedIceCandidates()}catch(e){return o.v.debug(`Call ${this.callId} initWithInvite() failed to set remote description`,e),void this.terminate(w.Local,E.SetRemoteDescription,!1)}const r=null===(t=this.feeds.find((e=>!e.isLocal())))||void 0===t?void 0:t.stream;if(!(this.isOnlyDataChannelAllowed||r&&0!==r.getTracks().length))return o.v.error(`Call ${this.callId} initWithInvite() no remote stream or no tracks after setting remote description!`),void this.terminate(w.Local,E.SetRemoteDescription,!1);if(this.state=y.Ringing,e.getLocalAge()){const t=setTimeout((()=>{var e;this.state==y.Ringing&&(o.v.debug(`Call ${this.callId} initWithInvite() invite has expired. Hanging up.`),this.hangupParty=w.Remote,this.state=y.Ended,this.stopAllMedia(),"closed"!=this.peerConn.signalingState&&this.peerConn.close(),null===(e=this.stats)||void 0===e||e.removeStatsReportGatherer(this.callId),this.emit(_.Hangup,this))}),i.lifetime-e.getLocalAge()),n=e=>{e!==y.Ringing&&(clearTimeout(t),this.off(_.State,n))};this.on(_.State,n)}}initWithHangup(e){this.state=y.Ended}shouldAnswerWithMediaType(e,t,i){return e&&!t?(o.v.warn(`Call ${this.callId} shouldAnswerWithMediaType() unable to answer with ${i} because the other side isn't sending it either.`),!1):(0,a.hX)(e)||e===t||this.opponentSupportsSDPStreamMetadata()?null!=e?e:t:(o.v.warn(`Call ${this.callId} shouldAnswerWithMediaType() unable to answer with ${i}=${e} because the other side doesn't support it. Answering with ${i}=${t}.`),t)}async answer(e,t){if(!this.inviteOrAnswerSent){if(!1===e&&!1===t)throw new Error("You CANNOT answer a call without media");if(this.localUsermediaStream||this.waitForLocalAVStream)this.waitForLocalAVStream&&(this.state=y.WaitLocalMedia);else{const n=this.state,r=this.shouldAnswerWithMediaType(e,this.hasRemoteUserMediaAudioTrack,"audio"),s=this.shouldAnswerWithMediaType(t,this.hasRemoteUserMediaVideoTrack,"video");this.state=y.WaitLocalMedia,this.waitForLocalAVStream=!0;try{var i;const e=await this.client.getMediaHandler().getUserMediaStream(r,s);this.waitForLocalAVStream=!1;const t=[new u.Hh({client:this.client,roomId:this.roomId,userId:this.client.getUserId(),deviceId:null!==(i=this.client.getDeviceId())&&void 0!==i?i:void 0,stream:e,purpose:l.h.Usermedia,audioMuted:!1,videoMuted:!1})];this.localScreensharingFeed&&t.push(this.localScreensharingFeed),this.answerWithCallFeeds(t)}catch(e){if(!s)return void this.getUserMediaFailed(e);o.v.warn(`Call ${this.callId} answer() failed to getUserMedia(), trying to getUserMedia() without video`),this.state=n,this.waitForLocalAVStream=!1,await this.answer(r,!1)}}}}answerWithCallFeeds(e){this.inviteOrAnswerSent||this.queueGotCallFeedsForAnswer(e)}replacedBy(e){o.v.debug(`Call ${this.callId} replacedBy() running (newCallId=${e.callId})`),this.state===y.WaitLocalMedia?(o.v.debug(`Call ${this.callId} replacedBy() telling new call to wait for local media (newCallId=${e.callId})`),e.waitForLocalAVStream=!0):[y.CreateOffer,y.InviteSent].includes(this.state)&&(e.direction===S.Outbound?e.queueGotCallFeedsForAnswer([]):(o.v.debug(`Call ${this.callId} replacedBy() handing local stream to new call(newCallId=${e.callId})`),e.queueGotCallFeedsForAnswer(this.getLocalFeeds().map((e=>e.clone()))))),this.successor=e,this.emit(_.Replaced,e,this),this.hangup(E.Replaced,!0)}hangup(e,t){if(this.callHasEnded())return;if(o.v.debug(`Call ${this.callId} hangup() ending call (reason=${e})`),this.terminate(w.Local,e,!t),[y.Fledgling,y.WaitLocalMedia].includes(this.state))return;const i={};(this.opponentVersion&&0!==this.opponentVersion||e!==E.UserHangup)&&(i.reason=e),this.sendVoipEvent(c.Bx.CallHangup,i)}reject(){if(this.state!==y.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(0===this.opponentVersion)return o.v.info(`Call ${this.callId} reject() opponent version is less than 1: sending hangup instead of reject (opponentVersion=${this.opponentVersion})`),void this.hangup(E.UserHangup,!0);o.v.debug("Rejecting call: "+this.callId),this.terminate(w.Local,E.UserHangup,!0),this.sendVoipEvent(c.Bx.CallReject,{})}async upgradeCall(e,t){if((e||t)&&this.opponentSupportsSDPStreamMetadata())try{o.v.debug(`Call ${this.callId} upgradeCall() upgrading call (audio=${e}, video=${t})`);const i=e||this.hasLocalUserMediaAudioTrack,n=t||this.hasLocalUserMediaVideoTrack,r=await this.client.getMediaHandler().getUserMediaStream(i,n,!1);await this.updateLocalUsermediaStream(r,e,t)}catch(e){o.v.error(`Call ${this.callId} upgradeCall() failed to upgrade the call`,e),this.emit(_.Error,new k(E.NoUserMedia,"Failed to get camera access: ",e),this)}}opponentSupportsSDPStreamMetadata(){return Boolean(this.remoteSDPStreamMetadata)}isScreensharing(){return Boolean(this.localScreensharingStream)}async setScreensharingEnabled(e,t){if(e&&this.isScreensharing())return o.v.warn(`Call ${this.callId} setScreensharingEnabled() there is already a screensharing stream - there is nothing to do!`),!0;if(!e&&!this.isScreensharing())return o.v.warn(`Call ${this.callId} setScreensharingEnabled() there already isn't a screensharing stream - there is nothing to do!`),!1;if(!this.opponentSupportsSDPStreamMetadata())return this.setScreensharingEnabledWithoutMetadataSupport(e,t);if(o.v.debug(`Call ${this.callId} setScreensharingEnabled() running (enabled=${e})`),!e){const e=this.transceivers.get(C(l.h.Screenshare,"audio")),t=this.transceivers.get(C(l.h.Screenshare,"video"));for(const i of[e,t])i&&i.sender&&this.peerConn.removeTrack(i.sender);return this.client.getMediaHandler().stopScreensharingStream(this.localScreensharingStream),this.deleteFeedByStream(this.localScreensharingStream),!1}try{const e=await this.client.getMediaHandler().getScreensharingStream(t);return!!e&&(this.pushNewLocalFeed(e,l.h.Screenshare),!0)}catch(e){return o.v.error(`Call ${this.callId} setScreensharingEnabled() failed to get screen-sharing stream:`,e),!1}}async setScreensharingEnabledWithoutMetadataSupport(e,t){if(o.v.debug(`Call ${this.callId} setScreensharingEnabledWithoutMetadataSupport() running (enabled=${e})`),!e){var i,n;const e=null===(i=this.localUsermediaStream)||void 0===i?void 0:i.getTracks().find((e=>"video"===e.kind)),t=null===(n=this.transceivers.get(C(l.h.Usermedia,"video")))||void 0===n?void 0:n.sender;return null==t||t.replaceTrack(null!=e?e:null),this.client.getMediaHandler().stopScreensharingStream(this.localScreensharingStream),this.deleteFeedByStream(this.localScreensharingStream),!1}try{var r;const e=await this.client.getMediaHandler().getScreensharingStream(t);if(!e)return!1;const i=e.getTracks().find((e=>"video"===e.kind)),n=null===(r=this.transceivers.get(C(l.h.Usermedia,"video")))||void 0===r?void 0:r.sender;return null==n||n.replaceTrack(null!=i?i:null),this.pushNewLocalFeed(e,l.h.Screenshare,!1),!0}catch(e){return o.v.error(`Call ${this.callId} setScreensharingEnabledWithoutMetadataSupport() failed to get screen-sharing stream:`,e),!1}}async updateLocalUsermediaStream(e,t=!1,i=!1){const n=this.localUsermediaFeed,r=t||!n.isAudioMuted()&&!this.remoteOnHold,s=i||!n.isVideoMuted()&&!this.remoteOnHold;o.v.log(`Call ${this.callId} updateLocalUsermediaStream() running (streamId=${e.id}, audio=${r}, video=${s})`),O(e.getAudioTracks(),r),O(e.getVideoTracks(),s);for(const e of this.localUsermediaStream.getTracks())this.localUsermediaStream.removeTrack(e),e.stop();for(const t of e.getTracks())this.localUsermediaStream.addTrack(t);for(const t of e.getTracks()){const i=C(l.h.Usermedia,t.kind),r=this.transceivers.get(i),s=null==r?void 0:r.sender;let a=!1;if(s)try{o.v.info(`Call ${this.callId} updateLocalUsermediaStream() replacing track (id=${t.id}, kind=${t.kind}, streamId=${e.id}, streamPurpose=${n.purpose})`),await s.replaceTrack(t),r.direction="inactive"===r.direction?"sendonly":"sendrecv",a=!0}catch(e){o.v.warn(`Call ${this.callId} updateLocalUsermediaStream() replaceTrack failed: adding new transceiver instead`,e)}if(!a){o.v.info(`Call ${this.callId} updateLocalUsermediaStream() adding track to peer connection (id=${t.id}, kind=${t.kind}, streamId=${e.id}, streamPurpose=${n.purpose})`);const r=this.peerConn.addTrack(t,this.localUsermediaStream),s=this.peerConn.getTransceivers().find((e=>e.sender===r));s?this.transceivers.set(i,s):o.v.warn(`Call ${this.callId} updateLocalUsermediaStream() couldn't find matching transceiver for newly added track!`)}}}async setLocalVideoMuted(e){var t,i;if(o.v.log(`Call ${this.callId} setLocalVideoMuted() running ${e}`),e||void 0===this.stopVideoTrackTimer||(clearTimeout(this.stopVideoTrackTimer),this.stopVideoTrackTimer=void 0),!await this.client.getMediaHandler().hasVideoDevice())return this.isLocalVideoMuted();if(!this.hasUserMediaVideoSender&&!e)return null===(i=this.localUsermediaFeed)||void 0===i||i.setAudioVideoMuted(null,e),await this.upgradeCall(!1,!0),this.isLocalVideoMuted();if(!e&&0===this.localUsermediaStream.getVideoTracks().length){const e=await this.client.getMediaHandler().getUserMediaStream(!0,!0);await this.updateLocalUsermediaStream(e)}return null===(t=this.localUsermediaFeed)||void 0===t||t.setAudioVideoMuted(null,e),this.updateMuteStatus(),await this.sendMetadataUpdate(),e&&(this.stopVideoTrackTimer=setTimeout((()=>{for(const e of this.localUsermediaStream.getVideoTracks())e.stop(),this.localUsermediaStream.removeTrack(e)}),120)),this.isLocalVideoMuted()}isLocalVideoMuted(){var e,t;return null!==(e=null===(t=this.localUsermediaFeed)||void 0===t?void 0:t.isVideoMuted())&&void 0!==e&&e}async setMicrophoneMuted(e){var t;return o.v.log(`Call ${this.callId} setMicrophoneMuted() running ${e}`),await this.client.getMediaHandler().hasAudioDevice()?e||this.hasUserMediaAudioSender&&this.hasLocalUserMediaAudioTrack?(null===(t=this.localUsermediaFeed)||void 0===t||t.setAudioVideoMuted(e,null),this.updateMuteStatus(),await this.sendMetadataUpdate(),this.isMicrophoneMuted()):(await this.upgradeCall(!0,!1),this.isMicrophoneMuted()):this.isMicrophoneMuted()}isMicrophoneMuted(){var e,t;return null!==(e=null===(t=this.localUsermediaFeed)||void 0===t?void 0:t.isAudioMuted())&&void 0!==e&&e}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){this.remoteOnHold=e;for(const t of this.peerConn.getTransceivers())t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.sendMetadataUpdate(),this.emit(_.RemoteHoldUnhold,this.remoteOnHold,this)}}isLocalOnHold(){if(this.state!==y.Connected)return!1;let e=!0;for(const t of this.peerConn.getTransceivers()){["inactive","recvonly"].includes(t.currentDirection)||(e=!1)}return e}sendDtmfDigit(e){for(const i of this.peerConn.getSenders()){var t;if("audio"===(null===(t=i.track)||void 0===t?void 0:t.kind)&&i.dtmf)return void i.dtmf.insertDTMF(e)}throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){const e=this.isMicrophoneMuted()||this.remoteOnHold,t=this.isLocalVideoMuted()||this.remoteOnHold;o.v.log(`Call ${this.callId} updateMuteStatus stream ${this.localUsermediaStream.id} micShouldBeMuted ${e} vidShouldBeMuted ${t}`),O(this.localUsermediaStream.getAudioTracks(),!e),O(this.localUsermediaStream.getVideoTracks(),!t)}async sendMetadataUpdate(){await this.sendVoipEvent(c.Bx.CallSDPStreamMetadataChangedPrefix,{[l.A]:this.getLocalSDPStreamMetadata()})}gotCallFeedsForInvite(e,t=!1){if(this.successor)this.successor.queueGotCallFeedsForAnswer(e);else if(this.callHasEnded())this.stopAllMedia();else{for(const t of e)this.pushLocalFeed(t);t&&this.peerConn.addTransceiver("video",{direction:"recvonly"}),this.state=y.CreateOffer,o.v.debug(`Call ${this.callId} gotUserMediaForInvite() run`)}}async sendAnswer(){const e={answer:{sdp:this.peerConn.localDescription.sdp,type:this.peerConn.localDescription.type},[l.A]:this.getLocalSDPStreamMetadata(!0)};e.capabilities={"m.call.transferee":this.client.supportsCallTransfer,"m.call.dtmf":!1};const t=this.discardDuplicateCandidates();o.v.info(`Call ${this.callId} sendAnswer() discarding ${t} candidates that will be sent in answer`);try{await this.sendVoipEvent(c.Bx.CallAnswer,e),this.inviteOrAnswerSent=!0}catch(e){this.state=y.Ringing,e instanceof g.up&&e.event&&this.client.cancelPendingEvent(e.event);let t=E.SendAnswer,i="Failed to send answer";throw"UnknownDeviceError"==e.name&&(t=E.UnknownDevices,i="Unknown devices present in the room"),this.emit(_.Error,new k(t,i,e),this),e}this.sendCandidateQueue()}queueGotCallFeedsForAnswer(e){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then((()=>this.gotCallFeedsForAnswer(e))):this.responsePromiseChain=this.gotCallFeedsForAnswer(e)}mungeSdp(e,t){const i=(0,s.qg)(e.sdp);i.media.forEach((e=>{const i=new Map,n=new Map;for(const t of e.rtp)i.set(t.payload,t.codec),n.set(t.codec,t.payload);for(const r of t){if(r.mediaType!==e.type)continue;if(!n.has(r.codec)){o.v.info(`Call ${this.callId} mungeSdp() ignoring SDP modifications for ${r.codec} as it's not present.`);continue}const t=[];void 0!==r.enableDtx&&t.push("usedtx="+(r.enableDtx?"1":"0")),void 0!==r.maxAverageBitrate&&t.push(`maxaveragebitrate=${r.maxAverageBitrate}`);let s=!1;for(const n of e.fmtp)i.get(n.payload)===r.codec&&(s=!0,n.config+=";"+t.join(";"));s||e.fmtp.push({payload:n.get(r.codec),config:t.join(";")})}})),e.sdp=(0,s.M9)(i)}async createOffer(){const e=await this.peerConn.createOffer();return this.mungeSdp(e,T(this.isPtt)),e}async createAnswer(){const e=await this.peerConn.createAnswer();return this.mungeSdp(e,T(this.isPtt)),e}async gotCallFeedsForAnswer(e){if(this.callHasEnded())return;this.waitForLocalAVStream=!1;for(const t of e)this.pushLocalFeed(t);let t;this.state=y.CreateAnswer;try{this.getRidOfRTXCodecs(),t=await this.createAnswer()}catch(e){return o.v.debug(`Call ${this.callId} gotCallFeedsForAnswer() failed to create answer: `,e),void this.terminate(w.Local,E.CreateAnswer,!0)}try{if(await this.peerConn.setLocalDescription(t),this.callHasEnded())return;if(this.state=y.Connecting,await new Promise((e=>{setTimeout(e,200)})),this.callHasEnded())return;this.sendAnswer()}catch(e){return o.v.debug(`Call ${this.callId} gotCallFeedsForAnswer() error setting local description!`,e),void this.terminate(w.Local,E.SetLocalDescription,!0)}}async onRemoteIceCandidatesReceived(e){if(this.callHasEnded())return;const t=e.getContent(),i=t.candidates;if(!i)return void o.v.info(`Call ${this.callId} onRemoteIceCandidatesReceived() ignoring candidates event with no candidates!`);const n=0===t.version?null:t.party_id||null;if(void 0!==this.opponentPartyId)this.partyIdMatches(t)?await this.addIceCandidates(i):o.v.info(`Call ${this.callId} onRemoteIceCandidatesReceived() ignoring candidates from party ID ${t.party_id}: we have chosen party ID ${this.opponentPartyId}`);else if(n){o.v.info(`Call ${this.callId} onRemoteIceCandidatesReceived() buffering ${i.length} candidates until we pick an opponent`);const e=this.remoteCandidateBuffer.get(n)||[];e.push(...i),this.remoteCandidateBuffer.set(n,e)}}async onAnswerReceived(e){const t=e.getContent();if(o.v.debug(`Call ${this.callId} onAnswerReceived() running (hangupParty=${t.party_id})`),this.callHasEnded())return void o.v.debug(`Call ${this.callId} onAnswerReceived() ignoring answer because call has ended`);if(void 0!==this.opponentPartyId)return void o.v.info(`Call ${this.callId} onAnswerReceived() ignoring answer from party ID ${t.party_id}: we already have an answer/reject from ${this.opponentPartyId}`);this.chooseOpponent(e),await this.addBufferedIceCandidates(),this.state=y.Connecting;const i=t[l.A];i?this.updateRemoteSDPStreamMetadata(i):o.v.warn(`Call ${this.callId} onAnswerReceived() did not get any SDPStreamMetadata! Can not send/receive multiple streams`);try{this.isSettingRemoteAnswerPending=!0,await this.peerConn.setRemoteDescription(t.answer),this.isSettingRemoteAnswerPending=!1,o.v.debug(`Call ${this.callId} onAnswerReceived() set remote description: ${t.answer.type}`)}catch(e){return this.isSettingRemoteAnswerPending=!1,o.v.debug(`Call ${this.callId} onAnswerReceived() failed to set remote description`,e),void this.terminate(w.Local,E.SetRemoteDescription,!1)}if(null!==this.opponentPartyId)try{await this.sendVoipEvent(c.Bx.CallSelectAnswer,{selected_party_id:this.opponentPartyId})}catch(e){o.v.warn(`Call ${this.callId} onAnswerReceived() failed to send select_answer event`,e)}}async onSelectAnswerReceived(e){if(this.direction!==S.Inbound)return void o.v.warn(`Call ${this.callId} onSelectAnswerReceived() got select_answer for an outbound call: ignoring`);const t=e.getContent().selected_party_id;null!=t?t!==this.ourPartyId&&(o.v.info(`Call ${this.callId} onSelectAnswerReceived() got select_answer for party ID ${t}: we are party ID ${this.ourPartyId}.`),await this.terminate(w.Remote,E.AnsweredElsewhere,!0)):o.v.warn(`Call ${this.callId} onSelectAnswerReceived() got nonsensical select_answer with null/undefined selected_party_id: ignoring`)}async onNegotiateReceived(e){const t=e.getContent(),i=t.description;if(!i||!i.sdp||!i.type)return void o.v.info(`Call ${this.callId} onNegotiateReceived() ignoring invalid m.call.negotiate event`);const n=this.direction===S.Inbound,r=!this.makingOffer&&("stable"===this.peerConn.signalingState||this.isSettingRemoteAnswerPending),s="offer"===i.type&&!r;if(this.ignoreOffer=!n&&s,this.ignoreOffer)return void o.v.info(`Call ${this.callId} onNegotiateReceived() ignoring colliding negotiate event because we're impolite`);const a=this.isLocalOnHold(),d=t[l.A];d?this.updateRemoteSDPStreamMetadata(d):o.v.warn(`Call ${this.callId} onNegotiateReceived() received negotiation event without SDPStreamMetadata!`);try{if(this.isSettingRemoteAnswerPending="answer"==i.type,await this.peerConn.setRemoteDescription(i),this.isSettingRemoteAnswerPending=!1,o.v.debug(`Call ${this.callId} onNegotiateReceived() set remote description: ${i.type}`),"offer"===i.type){var u;let e;try{this.getRidOfRTXCodecs(),e=await this.createAnswer()}catch(e){return o.v.debug(`Call ${this.callId} onNegotiateReceived() failed to create answer: `,e),void this.terminate(w.Local,E.CreateAnswer,!0)}await this.peerConn.setLocalDescription(e),o.v.debug(`Call ${this.callId} onNegotiateReceived() create an answer`),this.sendVoipEvent(c.Bx.CallNegotiate,{lifetime:I,description:null===(u=this.peerConn.localDescription)||void 0===u?void 0:u.toJSON(),[l.A]:this.getLocalSDPStreamMetadata(!0)})}}catch(e){this.isSettingRemoteAnswerPending=!1,o.v.warn(`Call ${this.callId} onNegotiateReceived() failed to complete negotiation`,e)}const h=this.isLocalOnHold();a!==h&&(this.emit(_.LocalHoldUnhold,h,this),this.emit(_.HoldUnhold,h))}updateRemoteSDPStreamMetadata(e){this.remoteSDPStreamMetadata=(0,a.Bi)(this.remoteSDPStreamMetadata||{},e,!0);for(const e of this.getRemoteFeeds()){var t;const i=e.stream.id,n=this.remoteSDPStreamMetadata[i];e.setAudioVideoMuted(null==n?void 0:n.audio_muted,null==n?void 0:n.video_muted),e.purpose=null===(t=this.remoteSDPStreamMetadata[i])||void 0===t?void 0:t.purpose}}onSDPStreamMetadataChangedReceived(e){const t=e.getContent()[l.A];this.updateRemoteSDPStreamMetadata(t)}async onAssertedIdentityReceived(e){const t=e.getContent();t.asserted_identity&&(this.remoteAssertedIdentity={id:t.asserted_identity.id,displayName:t.asserted_identity.display_name},this.emit(_.AssertedIdentityChanged,this))}callHasEnded(){return this.state===y.Ended}queueGotLocalOffer(){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then((()=>this.wrappedGotLocalOffer())):this.responsePromiseChain=this.wrappedGotLocalOffer()}async wrappedGotLocalOffer(){this.makingOffer=!0;try{await this.gotLocalOffer()}catch(e){return void this.getLocalOfferFailed(e)}finally{this.makingOffer=!1}}async gotLocalOffer(){if(o.v.debug(`Call ${this.callId} gotLocalOffer() running`),this.callHasEnded())return void o.v.debug(`Call ${this.callId} gotLocalOffer() ignoring newly created offer because the call has ended"`);let e;try{this.getRidOfRTXCodecs(),e=await this.createOffer()}catch(e){return o.v.debug(`Call ${this.callId} gotLocalOffer() failed to create offer: `,e),void this.terminate(w.Local,E.CreateOffer,!0)}try{await this.peerConn.setLocalDescription(e)}catch(e){return o.v.debug(`Call ${this.callId} gotLocalOffer() error setting local description!`,e),void this.terminate(w.Local,E.SetLocalDescription,!0)}if("gathering"===this.peerConn.iceGatheringState&&await new Promise((e=>{setTimeout(e,200)})),this.callHasEnded())return;const t=this.state===y.CreateOffer?c.Bx.CallInvite:c.Bx.CallNegotiate,i={lifetime:I};var n,r;(t===c.Bx.CallInvite&&this.invitee&&(i.invitee=this.invitee),this.state===y.CreateOffer)?i.offer=null===(n=this.peerConn.localDescription)||void 0===n?void 0:n.toJSON():i.description=null===(r=this.peerConn.localDescription)||void 0===r?void 0:r.toJSON();i.capabilities={"m.call.transferee":this.client.supportsCallTransfer,"m.call.dtmf":!1},i[l.A]=this.getLocalSDPStreamMetadata(!0);const s=this.discardDuplicateCandidates();o.v.info(`Call ${this.callId} gotLocalOffer() discarding ${s} candidates that will be sent in offer`);try{await this.sendVoipEvent(t,i)}catch(e){o.v.error(`Call ${this.callId} gotLocalOffer() failed to send invite`,e),e instanceof g.up&&e.event&&this.client.cancelPendingEvent(e.event);let t=E.SignallingFailed,i="Signalling failed";return this.state===y.CreateOffer&&(t=E.SendInvite,i="Failed to send invite"),"UnknownDeviceError"==e.name&&(t=E.UnknownDevices,i="Unknown devices present in the room"),this.emit(_.Error,new k(t,i,e),this),void this.terminate(w.Local,t,!1)}this.sendCandidateQueue(),this.state===y.CreateOffer&&(this.inviteOrAnswerSent=!0,this.state=y.InviteSent,this.inviteTimeout=setTimeout((()=>{this.inviteTimeout=void 0,this.state===y.InviteSent&&this.hangup(E.InviteTimeout,!1)}),I))}getRidOfRTXCodecs(){var e;if(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)return;const t=RTCRtpReceiver.getCapabilities("video").codecs,i=[...RTCRtpSender.getCapabilities("video").codecs,...t];for(const e of i)if("video/rtx"===e.mimeType){const t=i.indexOf(e);i.splice(t,1)}const n=this.transceivers.get(C(l.h.Screenshare,"video"));null==n||null===(e=n.setCodecPreferences)||void 0===e||e.call(n,i)}async sendVoipEvent(e,t){const i=f(f({},t),{},{version:"1",call_id:this.callId,party_id:this.ourPartyId,conf_id:this.groupCallId});if(this.opponentDeviceId){var n;const t=this.toDeviceSeq++,s=f(f({},i),{},{device_id:this.client.deviceId,sender_session_id:this.client.getSessionId(),dest_session_id:this.opponentSessionId,seq:t,[c.wt]:(0,r.A)()});this.emit(_.SendVoipEvent,{type:"toDevice",eventType:e,userId:this.invitee||(null===(n=this.getOpponentMember())||void 0===n?void 0:n.userId),opponentDeviceId:this.opponentDeviceId,content:s},this);const a=this.invitee||this.getOpponentMember().userId;if(this.client.getUseE2eForGroupCall()){if(!this.opponentDeviceInfo)return void o.v.warn(`Call ${this.callId} sendVoipEvent() failed: we do not have opponentDeviceInfo`);await this.client.encryptAndSendToDevices([{userId:a,deviceInfo:this.opponentDeviceInfo}],{type:e,content:s})}else await this.client.sendToDevice(e,new Map([[a,new Map([[this.opponentDeviceId,s]])]]))}else{var s;this.emit(_.SendVoipEvent,{type:"sendEvent",eventType:e,roomId:this.roomId,content:i,userId:this.invitee||(null===(s=this.getOpponentMember())||void 0===s?void 0:s.userId)},this),await this.client.sendEvent(this.roomId,e,i)}}queueCandidate(e){if(e?this.candidateSendQueue.push(e):this.candidatesEnded=!0,this.state===y.Ringing||!this.inviteOrAnswerSent)return;const t=this.direction===S.Inbound?500:2e3;0===this.candidateSendTries&&setTimeout((()=>{this.sendCandidateQueue()}),t)}discardDuplicateCandidates(){let e=0;const t=[];for(let i=0;i<this.candidateSendQueue.length;i++){const n=this.candidateSendQueue[i];""===n.candidate?t.push(n):e++}return this.candidateSendQueue=t,e}async transfer(e){const t=await this.client.getProfileInfo(e),i=R(),n={replacement_id:R(),target_user:{id:e,display_name:t.displayname,avatar_url:t.avatar_url},create_call:i};await this.sendVoipEvent(c.Bx.CallReplaces,n),await this.terminate(w.Local,E.Transferred,!0)}async transferToCall(e){var t,i;const n=null===(t=e.getOpponentMember())||void 0===t?void 0:t.userId,r=n?await this.client.getProfileInfo(n):void 0,s=null===(i=this.getOpponentMember())||void 0===i?void 0:i.userId,o=s?await this.client.getProfileInfo(s):void 0,a=R(),d={replacement_id:R(),target_user:{id:s,display_name:null==o?void 0:o.displayname,avatar_url:null==o?void 0:o.avatar_url},await_call:a};await e.sendVoipEvent(c.Bx.CallReplaces,d);const l={replacement_id:R(),target_user:{id:n,display_name:null==r?void 0:r.displayname,avatar_url:null==r?void 0:r.avatar_url},create_call:a};await this.sendVoipEvent(c.Bx.CallReplaces,l),await this.terminate(w.Local,E.Transferred,!0),await e.terminate(w.Local,E.Transferred,!0)}async terminate(e,t,i){var n;if(!this.callHasEnded()){this.hangupParty=e,this.hangupReason=t,this.state=y.Ended,this.inviteTimeout&&(clearTimeout(this.inviteTimeout),this.inviteTimeout=void 0),void 0!==this.iceDisconnectedTimeout&&(clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0),this.callLengthInterval&&(clearInterval(this.callLengthInterval),this.callLengthInterval=void 0),void 0!==this.stopVideoTrackTimer&&(clearTimeout(this.stopVideoTrackTimer),this.stopVideoTrackTimer=void 0);for(const[e,t]of this.removeTrackListeners)e.removeEventListener("removetrack",t);this.removeTrackListeners.clear(),this.callStatsAtEnd=await this.collectCallStats(),this.stopAllMedia(),this.deleteAllFeeds(),this.peerConn&&"closed"!==this.peerConn.signalingState&&this.peerConn.close(),null===(n=this.stats)||void 0===n||n.removeStatsReportGatherer(this.callId),i&&this.emit(_.Hangup,this),this.client.callEventHandler.calls.delete(this.callId)}}stopAllMedia(){o.v.debug(`Call ${this.callId} stopAllMedia() running`);for(const e of this.feeds)if(e.isLocal()&&e.purpose===l.h.Usermedia)this.client.getMediaHandler().stopUserMediaStream(e.stream);else if(e.isLocal()&&e.purpose===l.h.Screenshare)this.client.getMediaHandler().stopScreensharingStream(e.stream);else if(!e.isLocal()){o.v.debug(`Call ${this.callId} stopAllMedia() stopping stream (streamId=${e.stream.id})`);for(const t of e.stream.getTracks())t.stop()}}checkForErrorListener(){if(0===this.listeners(h.u.Error).length)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}async sendCandidateQueue(){if(0===this.candidateSendQueue.length||this.callHasEnded())return;const e=this.candidateSendQueue;this.candidateSendQueue=[],++this.candidateSendTries;const t={candidates:e.map((e=>e.toJSON()))};this.candidatesEnded&&t.candidates.push({candidate:""}),o.v.debug(`Call ${this.callId} sendCandidateQueue() attempting to send ${e.length} candidates`);try{await this.sendVoipEvent(c.Bx.CallCandidates,t),this.candidateSendTries=0,this.sendCandidateQueue()}catch(t){if(t instanceof g.up&&t.event&&this.client.cancelPendingEvent(t.event),this.candidateSendQueue.push(...e),this.candidateSendTries>5){o.v.debug(`Call ${this.callId} sendCandidateQueue() failed to send candidates on attempt ${this.candidateSendTries}. Giving up on this call.`,t);const e=E.SignallingFailed,i="Signalling failed";return this.emit(_.Error,new k(e,i,t),this),void this.hangup(e,!1)}const i=500*Math.pow(2,this.candidateSendTries);++this.candidateSendTries,o.v.debug(`Call ${this.callId} sendCandidateQueue() failed to send candidates. Retrying in ${i}ms`,t),setTimeout((()=>{this.sendCandidateQueue()}),i)}}async placeCall(e,t){if(!e)throw new Error("You CANNOT start a call without audio");let i;this.state=y.WaitLocalMedia;try{var n;const r=await this.client.getMediaHandler().getUserMediaStream(e,t);O(r.getAudioTracks(),!0),O(r.getVideoTracks(),!0),i=new u.Hh({client:this.client,roomId:this.roomId,userId:this.client.getUserId(),deviceId:null!==(n=this.client.getDeviceId())&&void 0!==n?n:void 0,stream:r,purpose:l.h.Usermedia,audioMuted:!1,videoMuted:!1})}catch(e){return void this.getUserMediaFailed(e)}try{await this.placeCallWithCallFeeds([i])}catch(e){return void this.placeCallFailed(e)}}async placeCallWithCallFeeds(e,t=!1){this.checkForErrorListener(),this.direction=S.Outbound,await this.initOpponentCrypto(),this.client.callEventHandler.calls.set(this.callId,this);await this.client.checkTurnServers()||o.v.warn(`Call ${this.callId} placeCallWithCallFeeds() failed to get TURN credentials! Proceeding with call anyway...`),this.peerConn=this.createPeerConnection(),this.emit(_.PeerConnectionCreated,this.peerConn,this),this.gotCallFeedsForInvite(e,t)}createPeerConnection(){var e;const t=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers.length?this.turnServers:void 0,iceCandidatePoolSize:this.client.iceCandidatePoolSize,bundlePolicy:"max-bundle"});t.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),t.addEventListener("signalingstatechange",this.onSignallingStateChanged),t.addEventListener("icecandidate",this.gotLocalIceCandidate),t.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),t.addEventListener("track",this.onTrack),t.addEventListener("negotiationneeded",this.onNegotiationNeeded),t.addEventListener("datachannel",this.onDataChannel);const i=this.getOpponentMember(),n=i?i.userId:"unknown";return null===(e=this.stats)||void 0===e||e.addStatsReportGatherer(this.callId,n,t),t}partyIdMatches(e){return(0===e.version?null:e.party_id||null)===this.opponentPartyId}chooseOpponent(e){var t;const i=e.getContent();var n;(o.v.debug(`Call ${this.callId} chooseOpponent() running (partyId=${i.party_id})`),this.opponentVersion=i.version,0===this.opponentVersion?this.opponentPartyId=null:this.opponentPartyId=i.party_id||null,this.opponentCaps=i.capabilities||{},this.opponentMember=null!==(t=this.client.getRoom(this.roomId).getMember(e.getSender()))&&void 0!==t?t:void 0,this.opponentMember)&&(null===(n=this.stats)||void 0===n||n.updateOpponentMember(this.callId,this.opponentMember.userId))}async addBufferedIceCandidates(){const e=this.remoteCandidateBuffer.get(this.opponentPartyId);e&&(o.v.info(`Call ${this.callId} addBufferedIceCandidates() adding ${e.length} buffered candidates for opponent ${this.opponentPartyId}`),await this.addIceCandidates(e)),this.remoteCandidateBuffer.clear()}async addIceCandidates(e){for(const t of e){null!==t.sdpMid&&void 0!==t.sdpMid||null!==t.sdpMLineIndex&&void 0!==t.sdpMLineIndex?o.v.debug(`Call ${this.callId} addIceCandidates() got remote ICE candidate (sdpMid=${t.sdpMid}, candidate=${t.candidate})`):o.v.debug(`Call ${this.callId} addIceCandidates() got remote ICE end-of-candidates`);try{await this.peerConn.addIceCandidate(t)}catch(e){this.ignoreOffer?o.v.debug(`Call ${this.callId} addIceCandidates() failed to add remote ICE candidate because ignoring offer`,e):o.v.info(`Call ${this.callId} addIceCandidates() failed to add remote ICE candidate`,e)}}}get hasPeerConnection(){return Boolean(this.peerConn)}initStats(e,t="unknown"){this.stats=e,this.stats.start()}}function O(e,t){for(const i of e)i.enabled=t}function x(){if("undefined"==typeof window||"undefined"==typeof document)return!1;try{if(!Boolean(window.RTCPeerConnection||window.RTCSessionDescription||window.RTCIceCandidate||navigator.mediaDevices))return o.v.error("WebRTC is not supported in this browser / environment"),!1}catch(e){return o.v.error("Exception thrown when trying to access WebRTC",e),!1}return!0}function M(e,t,i){if(!x())return null;const n=!!i&&i.forceTURN,r={client:e,roomId:t,invitee:null==i?void 0:i.invitee,turnServers:e.getTurnServers(),forceTURN:e.forceTURN||n,opponentDeviceId:null==i?void 0:i.opponentDeviceId,opponentSessionId:null==i?void 0:i.opponentSessionId,groupCallId:null==i?void 0:i.groupCallId},s=new A(r);return e.reEmitter.reEmit(s,Object.values(_)),s}},"./node_modules/matrix-js-sdk/src/webrtc/callEventHandler.ts":(e,t,i)=>{"use strict";i.d(t,{B:()=>l,N:()=>u});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/logger.ts"),s=i("./node_modules/matrix-js-sdk/src/webrtc/call.ts"),o=i("./node_modules/matrix-js-sdk/src/@types/event.ts"),a=i("./node_modules/matrix-js-sdk/src/client.ts"),c=i("./node_modules/matrix-js-sdk/src/webrtc/groupCall.ts"),d=i("./node_modules/matrix-js-sdk/src/models/room.ts");let l=function(e){return e.Incoming="Call.incoming",e}({});class u{constructor(e){(0,n.A)(this,"calls",void 0),(0,n.A)(this,"callEventBuffer",void 0),(0,n.A)(this,"nextSeqByCall",new Map),(0,n.A)(this,"toDeviceEventBuffers",new Map),(0,n.A)(this,"client",void 0),(0,n.A)(this,"candidateEventsByCall",void 0),(0,n.A)(this,"eventBufferPromiseChain",void 0),(0,n.A)(this,"onSync",(()=>{const e=this.callEventBuffer;this.callEventBuffer=[],this.eventBufferPromiseChain?this.eventBufferPromiseChain=this.eventBufferPromiseChain.then((()=>this.evaluateEventBuffer(e))):this.eventBufferPromiseChain=this.evaluateEventBuffer(e)})),(0,n.A)(this,"onRoomTimeline",(e=>{this.callEventBuffer.push(e)})),(0,n.A)(this,"onToDeviceEvent",(e=>{const t=e.getContent();if(!t.call_id)return void this.callEventBuffer.push(e);if(this.nextSeqByCall.has(t.call_id)||this.nextSeqByCall.set(t.call_id,0),void 0===t.seq)return void this.callEventBuffer.push(e);const i=this.nextSeqByCall.get(t.call_id)||0;if(t.seq!==i){this.toDeviceEventBuffers.has(t.call_id)||this.toDeviceEventBuffers.set(t.call_id,[]);const i=this.toDeviceEventBuffers.get(t.call_id),n=i.findIndex((e=>e.getContent().seq>t.seq));-1===n?i.push(e):i.splice(n,0,e)}else{const i=t.call_id;this.callEventBuffer.push(e),this.nextSeqByCall.set(i,t.seq+1);const n=this.toDeviceEventBuffers.get(i);let r=n&&n.shift();for(;r&&r.getContent().seq===this.nextSeqByCall.get(i);)this.callEventBuffer.push(r),this.nextSeqByCall.set(i,r.getContent().seq+1),r=n.shift()}})),this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on(a.AU.Sync,this.onSync),this.client.on(d.u9.Timeline,this.onRoomTimeline),this.client.on(a.AU.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.removeListener(a.AU.Sync,this.onSync),this.client.removeListener(d.u9.Timeline,this.onRoomTimeline),this.client.removeListener(a.AU.ToDeviceEvent,this.onToDeviceEvent)}async evaluateEventBuffer(e){await Promise.all(e.map((e=>this.client.decryptEventIfNeeded(e))));const t=e.filter((e=>{const t=e.getType();return t.startsWith("m.call.")||t.startsWith("org.matrix.call.")})),i=new Set;for(const e of t){const t=e.getType();t!==o.Bx.CallAnswer&&t!==o.Bx.CallHangup||i.add(e.getContent().call_id)}for(const e of t){const t=e.getType(),n=e.getContent().call_id;if(t!==o.Bx.CallInvite||!i.has(n))try{await this.handleCallEvent(e)}catch(e){r.v.error("CallEventHandler evaluateEventBuffer() caught exception handling call event",e)}}}async handleCallEvent(e){var t,i;this.client.emit(a.AU.ReceivedVoipEvent,e);const n=e.getContent(),d=e.getRoomId()||(null===(t=this.client.groupCallEventHandler.getGroupCallById(n.conf_id))||void 0===t||null===(i=t.room)||void 0===i?void 0:i.roomId),u=n.conf_id,h=e.getType(),m=e.getSender();let p,g,v=n.call_id?this.calls.get(n.call_id):void 0;if(u){if(g=this.client.groupCallEventHandler.getGroupCallById(u),!g)return void r.v.warn(`CallEventHandler handleCallEvent() could not find a group call - ignoring event (groupCallId=${u}, type=${h})`);if(p=n.device_id,!p)return r.v.warn(`CallEventHandler handleCallEvent() could not find a device id - ignoring event (senderId=${m})`),void g.emit(c.AZ.Error,new c.Iy(m));if(n.dest_session_id!==this.client.getSessionId())return void r.v.warn("CallEventHandler handleCallEvent() call event does not match current session id - ignoring")}const f=m===this.client.credentials.userId&&(void 0===p||p===this.client.getDeviceId());if(d)if(h!==o.Bx.CallInvite)if(h!==o.Bx.CallCandidates){var y;if([o.Bx.CallHangup,o.Bx.CallReject].includes(h))v?v.state!==s.iP.Ended&&(h===o.Bx.CallHangup?v.onHangupReceived(n):v.onRejectReceived(n),v.state===s.iP.Ended&&this.calls.delete(n.call_id)):(v=null!==(y=(0,s.sv)(this.client,d,{opponentDeviceId:p,opponentSessionId:n.sender_session_id}))&&void 0!==y?y:void 0,v&&(v.callId=n.call_id,v.initWithHangup(e),this.calls.set(n.call_id,v)));else if(v&&v.hasPeerConnection){if(e.getContent().party_id!==v.ourPartyId)switch(h){case o.Bx.CallAnswer:f?v.state===s.iP.Ringing&&v.onAnsweredElsewhere(n):v.onAnswerReceived(e);break;case o.Bx.CallSelectAnswer:v.onSelectAnswerReceived(e);break;case o.Bx.CallNegotiate:v.onNegotiateReceived(e);break;case o.Bx.CallAssertedIdentity:case o.Bx.CallAssertedIdentityPrefix:v.onAssertedIdentityReceived(e);break;case o.Bx.CallSDPStreamMetadataChanged:case o.Bx.CallSDPStreamMetadataChangedPrefix:v.onSDPStreamMetadataChangedReceived(e)}}else r.v.info(`CallEventHandler handleCallEvent() discarding possible call event as we don't have a call (type=${h})`)}else{if(f)return;v?v.onRemoteIceCandidatesReceived(e):(this.candidateEventsByCall.has(n.call_id)||this.candidateEventsByCall.set(n.call_id,[]),this.candidateEventsByCall.get(n.call_id).push(e))}else{var b,S,w;if(f)return;if(e.getLocalAge()>n.lifetime-3e3)return;if(v&&v.state===s.iP.Ended)return;if(v&&r.v.warn(`CallEventHandler handleCallEvent() already has a call but got an invite - clobbering (callId=${n.call_id})`),n.invitee&&n.invitee!==this.client.getUserId())return;const t=(null!==(b=this.client.getTurnServersExpiry())&&void 0!==b?b:0)-Date.now();if(r.v.info("CallEventHandler handleCallEvent() current turn creds expire in "+t+" ms"),v=null!==(S=(0,s.sv)(this.client,d,{forceTURN:this.client.forceTURN,opponentDeviceId:p,groupCallId:u,opponentSessionId:n.sender_session_id}))&&void 0!==S?S:void 0,!v)return void r.v.log(`CallEventHandler handleCallEvent() this client does not support WebRTC (callId=${n.call_id})`);v.callId=n.call_id;const i=null===(w=g)||void 0===w?void 0:w.getGroupCallStats();i&&v.initStats(i);try{await v.initWithInvite(e)}catch(e){var _;if(e instanceof s.RA)if(e.code===c.BF.UnknownDevice)null===(_=g)||void 0===_||_.emit(c.AZ.Error,e);else r.v.error(e)}if(this.calls.set(v.callId,v),this.candidateEventsByCall.get(v.callId))for(const e of this.candidateEventsByCall.get(v.callId))v.onRemoteIceCandidatesReceived(e);let o;for(const e of this.calls.values()){var E;const t=[s.iP.WaitLocalMedia,s.iP.CreateOffer,s.iP.InviteSent].includes(e.state);if(v.roomId===e.roomId&&e.direction===s.QO.Outbound&&(null===(E=v.getOpponentMember())||void 0===E?void 0:E.userId)===e.invitee&&t){o=e;break}}o?o.callId>v.callId?(r.v.log(`CallEventHandler handleCallEvent() detected glare - answering incoming call and canceling outgoing call (incomingId=${v.callId}, outgoingId=${o.callId})`),o.replacedBy(v)):(r.v.log(`CallEventHandler handleCallEvent() detected glare - hanging up incoming call (incomingId=${v.callId}, outgoingId=${o.callId})`),v.hangup(s.Il.Replaced,!0)):this.client.emit(l.Incoming,v)}}}},"./node_modules/matrix-js-sdk/src/webrtc/callEventTypes.ts":(e,t,i)=>{"use strict";i.d(t,{A:()=>n,h:()=>r});const n="org.matrix.msc3077.sdp_stream_metadata";let r=function(e){return e.Usermedia="m.usermedia",e.Screenshare="m.screenshare",e}({})},"./node_modules/matrix-js-sdk/src/webrtc/callFeed.ts":(e,t,i)=>{"use strict";i.d(t,{Hh:()=>h,Tw:()=>l});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/webrtc/callEventTypes.ts");let s=null,o=0;var a=i("./node_modules/matrix-js-sdk/src/logger.ts"),c=i("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),d=i("./node_modules/matrix-js-sdk/src/webrtc/call.ts");const l=-60;let u=function(e){return e.NewStream="new_stream",e.MuteStateChanged="mute_state_changed",e.LocalVolumeChanged="local_volume_changed",e.VolumeChanged="volume_changed",e.ConnectedChanged="connected_changed",e.Speaking="speaking",e.Disposed="disposed",e}({});class h extends c.X{constructor(e){super(),(0,n.A)(this,"stream",void 0),(0,n.A)(this,"sdpMetadataStreamId",void 0),(0,n.A)(this,"userId",void 0),(0,n.A)(this,"deviceId",void 0),(0,n.A)(this,"purpose",void 0),(0,n.A)(this,"speakingVolumeSamples",void 0),(0,n.A)(this,"client",void 0),(0,n.A)(this,"call",void 0),(0,n.A)(this,"roomId",void 0),(0,n.A)(this,"audioMuted",void 0),(0,n.A)(this,"videoMuted",void 0),(0,n.A)(this,"localVolume",1),(0,n.A)(this,"measuringVolumeActivity",!1),(0,n.A)(this,"audioContext",void 0),(0,n.A)(this,"analyser",void 0),(0,n.A)(this,"frequencyBinCount",void 0),(0,n.A)(this,"speakingThreshold",l),(0,n.A)(this,"speaking",!1),(0,n.A)(this,"volumeLooperTimeout",void 0),(0,n.A)(this,"_disposed",!1),(0,n.A)(this,"_connected",!1),(0,n.A)(this,"onAddTrack",(()=>{this.emit(u.NewStream,this.stream)})),(0,n.A)(this,"onCallState",(e=>{e===d.iP.Connected?this.connected=!0:e===d.iP.Connecting&&(this.connected=!1)})),(0,n.A)(this,"volumeLooper",(()=>{if(!this.analyser)return;if(!this.measuringVolumeActivity)return;this.analyser.getFloatFrequencyData(this.frequencyBinCount);let e=-1/0;for(const t of this.frequencyBinCount)t>e&&(e=t);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(e),this.emit(u.VolumeChanged,e);let t=!1;for(const e of this.speakingVolumeSamples)if(e>this.speakingThreshold){t=!0;break}this.speaking!==t&&(this.speaking=t,this.emit(u.Speaking,this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,200)})),this.client=e.client,this.call=e.call,this.roomId=e.roomId,this.userId=e.userId,this.deviceId=e.deviceId,this.purpose=e.purpose,this.audioMuted=e.audioMuted,this.videoMuted=e.videoMuted,this.speakingVolumeSamples=new Array(8).fill(-1/0),this.sdpMetadataStreamId=e.stream.id,this.updateStream(null,e.stream),this.stream=e.stream,this.hasAudioTrack&&this.initVolumeMeasuring(),e.call&&(e.call.addListener(d.$E.State,this.onCallState),this.onCallState(e.call.state))}get connected(){return this.isLocal()||this._connected}set connected(e){this._connected=e,this.emit(u.ConnectedChanged,this.connected)}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(e,t){if(t===e)return;const i=this.measuringVolumeActivity;e&&(e.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),this.stream=t,t.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?(this.initVolumeMeasuring(),i&&this.measureVolumeActivity(!0)):this.measureVolumeActivity(!1),this.emit(u.NewStream,this.stream)}initVolumeMeasuring(){if(!this.hasAudioTrack)return;this.audioContext||(this.audioContext=(null===s&&(s=new AudioContext),o++,s)),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1;this.audioContext.createMediaStreamSource(this.stream).connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}getMember(){var e;const t=this.client.getRoom(this.roomId);return null!==(e=null==t?void 0:t.getMember(this.userId))&&void 0!==e?e:null}isLocal(){return this.userId===this.client.getUserId()&&(void 0===this.deviceId||this.deviceId===this.client.getDeviceId())}isAudioMuted(){return 0===this.stream.getAudioTracks().length||this.audioMuted}isVideoMuted(){return 0===this.stream.getVideoTracks().length||this.videoMuted}isSpeaking(){return this.speaking}setNewStream(e){this.updateStream(this.stream,e)}setAudioVideoMuted(e,t){null!==e&&(this.audioMuted!==e&&this.speakingVolumeSamples.fill(-1/0),this.audioMuted=e),null!==t&&(this.videoMuted=t),this.emit(u.MuteStateChanged,this.audioMuted,this.videoMuted)}measureVolumeActivity(e){if(e){if(!this.analyser||!this.frequencyBinCount||!this.hasAudioTrack)return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit(u.VolumeChanged,-1/0)}setSpeakingThreshold(e){this.speakingThreshold=e}clone(){const e=this.client.getMediaHandler(),t=this.stream.clone();return a.v.log(`CallFeed clone() cloning stream (originalStreamId=${this.stream.id}, newStreamId${t.id})`),this.purpose===r.h.Usermedia?e.userMediaStreams.push(t):e.screensharingStreams.push(t),new h({client:this.client,roomId:this.roomId,userId:this.userId,deviceId:this.deviceId,stream:t,purpose:this.purpose,audioMuted:this.audioMuted,videoMuted:this.videoMuted})}dispose(){var e,t,i;clearTimeout(this.volumeLooperTimeout),null===(e=this.stream)||void 0===e||e.removeEventListener("addtrack",this.onAddTrack),null===(t=this.call)||void 0===t||t.removeListener(d.$E.State,this.onCallState),this.audioContext&&(this.audioContext=void 0,this.analyser=void 0,o--,0===o&&(null===(i=s)||void 0===i||i.close(),s=null)),this._disposed=!0,this.emit(u.Disposed)}get disposed(){return this._disposed}set disposed(e){this._disposed=e}getLocalVolume(){return this.localVolume}setLocalVolume(e){this.localVolume=e,this.emit(u.LocalVolumeChanged,e)}}},"./node_modules/matrix-js-sdk/src/webrtc/groupCall.ts":(e,t,i)=>{"use strict";i.d(t,{eO:()=>J,BF:()=>$,AZ:()=>F,MC:()=>L,F_:()=>G,Ad:()=>N,Iy:()=>V});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),s=i("./node_modules/matrix-js-sdk/src/webrtc/callFeed.ts"),o=i("./node_modules/matrix-js-sdk/src/webrtc/call.ts"),a=i("./node_modules/matrix-js-sdk/src/models/room-state.ts"),c=i("./node_modules/matrix-js-sdk/src/logger.ts"),d=i("./node_modules/matrix-js-sdk/src/ReEmitter.ts"),l=i("./node_modules/matrix-js-sdk/src/webrtc/callEventTypes.ts"),u=i("./node_modules/matrix-js-sdk/src/@types/event.ts"),h=i("./node_modules/matrix-js-sdk/src/webrtc/callEventHandler.ts"),m=i("./node_modules/matrix-js-sdk/src/webrtc/groupCallEventHandler.ts"),p=i("./node_modules/matrix-js-sdk/src/utils.ts");class g{constructor(){(0,n.A)(this,"bandwidth",{}),(0,n.A)(this,"bitrate",{}),(0,n.A)(this,"packetLoss",{}),(0,n.A)(this,"transport",[])}}class v{static buildBandwidthReport(e){const t=e.availableIncomingBitrate,i=e.availableOutgoingBitrate;return{download:t?Math.round(t/1e3):0,upload:i?Math.round(i/1e3):0}}}class f{static buildReport(e,t,i,n){const r=null==e?void 0:e.get(t.localCandidateId),s=null==e?void 0:e.get(t.remoteCandidateId);if(s&&r){const e=`${void 0!==s.ip?s.ip:s.address}:${s.port}`,o=`${void 0!==r.ip?r.ip:r.address}:${r.port}`,a=s.protocol;i.some((t=>t.ip===e&&t.type===a&&t.localIp===o))||i.push({ip:e,type:a,localIp:o,isFocus:n,localCandidateType:r.candidateType,remoteCandidateType:s.candidateType,networkType:r.networkType,rtt:t.currentRoundTripTime?1e3*t.currentRoundTripTime:NaN})}return i}}var y=i("./node_modules/sdp-transform/lib/index.js");class b{constructor(){(0,n.A)(this,"ssrcToMid",{local:new Map,remote:new Map})}findMidBySsrc(e,t){let i;return this.ssrcToMid[t].forEach(((t,n)=>{t.find((t=>t==e))&&(i=n)})),i}parse(e,t){const i=(0,y.qg)(e),n=new Map;i.media.forEach((e=>{if(e.mid&&"video"===e.type||"audio"===e.type){var t;const i=[];null===(t=e.ssrcs)||void 0===t||t.forEach((e=>{"cname"===e.attribute&&i.push(`${e.id}`)})),n.set(`${e.mid}`,i)}})),this.ssrcToMid[t]=n}getSsrcToMidMap(e){return this.ssrcToMid[e]}}class S{constructor(e){this.pc=e}getLocalTracks(e){return this.pc.getTransceivers().filter((e=>"sendonly"===e.currentDirection||"sendrecv"===e.currentDirection)).filter((e=>null!==e.sender)).map((e=>e.sender)).map((e=>e.track)).filter((t=>null!==t&&t.kind===e))}getTackById(e){return this.pc.getTransceivers().map((t=>null!==(null==t?void 0:t.sender.track)&&t.sender.track.id===e?t.sender.track:null!==(null==t?void 0:t.receiver.track)&&t.receiver.track.id===e?t.receiver.track:void 0)).find((e=>void 0!==e))}getLocalTrackIdByMid(e){const t=this.pc.getTransceivers().find((t=>t.mid===e));if(void 0!==t&&t.sender&&t.sender.track)return t.sender.track.id}getRemoteTrackIdByMid(e){const t=this.pc.getTransceivers().find((t=>t.mid===e));if(void 0!==t&&t.receiver&&t.receiver.track)return t.receiver.track.id}getActiveSimulcastStreams(){return 3}getTransceiverByTrackId(e){return this.pc.getTransceivers().find((t=>t.receiver.track.id===e||null!==t.sender.track&&t.sender.track.id===e))}}class w{constructor(e,t,i){this.trackId=e,this.type=t,this.kind=i,(0,n.A)(this,"loss",{packetsTotal:0,packetsLost:0,isDownloadStream:!1}),(0,n.A)(this,"bitrate",{download:0,upload:0}),(0,n.A)(this,"resolution",{width:-1,height:-1}),(0,n.A)(this,"audioConcealment",{concealedAudio:0,totalAudioDuration:0}),(0,n.A)(this,"framerate",0),(0,n.A)(this,"jitter",0),(0,n.A)(this,"codec",""),(0,n.A)(this,"isAlive",!0),(0,n.A)(this,"isMuted",!1),(0,n.A)(this,"isEnabled",!0)}getType(){return this.type}setLoss(e){this.loss=e}getLoss(){return this.loss}setResolution(e){this.resolution=e}getResolution(){return this.resolution}setFramerate(e){this.framerate=e}getFramerate(){return this.framerate}setBitrate(e){this.bitrate=e}getBitrate(){return this.bitrate}setCodec(e){return this.codec=e,!0}getCodec(){return this.codec}resetBitrate(){this.bitrate={download:0,upload:0}}set alive(e){this.isAlive=e}get alive(){return this.isAlive}set muted(e){this.isMuted=e}get muted(){return this.isMuted}set enabled(e){this.isEnabled=e}get enabled(){return this.isEnabled}setJitter(e){this.jitter=e}getJitter(){return this.jitter}setAudioConcealment(e,t){this.audioConcealment.concealedAudio=e,this.audioConcealment.totalAudioDuration=t}getAudioConcealment(){return this.audioConcealment}}class _{constructor(e,t){this.mediaSsrcHandler=e,this.mediaTrackHandler=t,(0,n.A)(this,"track2stats",new Map)}findTrack2Stats(e,t){let i;if(e.trackIdentifier)i=e.trackIdentifier;else if(e.mid)i="remote"===t?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid);else if(e.ssrc){if(!this.mediaSsrcHandler.findMidBySsrc(e.ssrc,t))return;i="remote"===t?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid)}if(!i)return;let n=this.track2stats.get(i);if(!n){const e=this.mediaTrackHandler.getTackById(i);if(void 0===e)return;{const r="audio"===e.kind?e.kind:"video";n=new w(i,t,r),this.track2stats.set(i,n)}}return n}findLocalVideoTrackStats(e){if(0!==this.mediaTrackHandler.getLocalTracks("video").length)return this.findTrack2Stats(e,"local")}getTrack2stats(){return this.track2stats}findTransceiverByTrackId(e){return this.mediaTrackHandler.getTransceiverByTrackId(e)}}class E{static getNonNegativeValue(e){let t=e;return"number"!=typeof t&&(t=Number(t)),isNaN(t)?0:Math.max(0,t)}}class I{static buildFramerateResolution(e,t){const i={height:t.frameHeight,width:t.frameWidth},n=t.framesPerSecond;i.height&&i.width&&e.setResolution(i),e.setFramerate(Math.round(n||0))}static calculateSimulcastFramerate(e,t,i,n){let r=e.getFramerate();if(!r){if(i){const e=t.timestamp-i.timestamp;if(e>0&&t.framesSent){r=(t.framesSent-i.framesSent)/e*1e3}}if(!r)return}r=n?Math.round(r/n):0,e.setFramerate(r)}static buildCodec(e,t,i){const n=null==e?void 0:e.get(i.codecId);if(n){const e=n.mimeType.split("/")[1];e&&t.setCodec(e)}}static buildBitrateReceived(e,t,i){e.setBitrate({download:I.calculateBitrate(t.bytesReceived,i.bytesReceived,t.timestamp,i.timestamp),upload:0})}static buildBitrateSend(e,t,i){e.setBitrate({download:0,upload:this.calculateBitrate(t.bytesSent,i.bytesSent,t.timestamp,i.timestamp)})}static buildPacketsLost(e,t,i){const n="outbound-rtp"===t.type?"packetsSent":"packetsReceived";let r=t[n];(!r||r<0)&&(r=0);const s=E.getNonNegativeValue(i[n]),o=Math.max(0,r-s),a=E.getNonNegativeValue(t.packetsLost),c=E.getNonNegativeValue(i.packetsLost),d=Math.max(0,a-c);e.setLoss({packetsTotal:o+d,packetsLost:d,isDownloadStream:"outbound-rtp"!==t.type})}static calculateBitrate(e,t,i,n){const r=E.getNonNegativeValue(e),s=E.getNonNegativeValue(t),o=Math.max(0,r-s),a=i-n;let c=0;return a>0&&(c=Math.round(8*o/a)),c}static setTrackStatsState(e,t){var i;if(void 0===t)return void(e.alive=!1);const n="remote"===e.getType()?t.receiver.track:null==t||null===(i=t.sender)||void 0===i?void 0:i.track;null!=n&&"ended"!==n.readyState?(e.muted=n.muted,e.enabled=n.enabled,e.alive=!0):e.alive=!1}static buildTrackSummary(e){const t={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},i={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},n=e.filter((e=>"remote"===e.getType())),r=n.filter((e=>"audio"===e.kind));return n.forEach((e=>{const n="video"===e.kind?t:i;var s,o;(n.count++,e.alive&&e.muted&&n.muted++,n.maxJitter<e.getJitter()&&(n.maxJitter=e.getJitter()),n.maxPacketLoss<e.getLoss().packetsLost&&(n.maxPacketLoss=e.getLoss().packetsLost),r.length>0)&&(n.concealedAudio+=null===(s=e.getAudioConcealment())||void 0===s?void 0:s.concealedAudio,n.totalAudio+=null===(o=e.getAudioConcealment())||void 0===o?void 0:o.totalAudioDuration)})),{audioTrackSummary:i,videoTrackSummary:t}}static buildJitter(e,t){if("inbound-rtp"!==t.type)return;const i=null==t?void 0:t.jitter;if(void 0!==i){const t=E.getNonNegativeValue(i);e.setJitter(Math.round(1e3*t))}else e.setJitter(-1)}static buildAudioConcealment(e,t){if("inbound-rtp"!==t.type)return;const i=1e3*(null==t?void 0:t.totalSamplesDuration)/(null==t?void 0:t.totalSamplesReceived)*(null==t?void 0:t.concealedSamples),n=1e3*(null==t?void 0:t.totalSamplesDuration);e.setAudioConcealment(i,n)}}class k{static build(e){const t={},i={download:0,upload:0},n={download:0,upload:0};let r=0,s=0;const o={local:new Map,remote:new Map},a={local:new Map,remote:new Map},c={local:new Map,remote:new Map},d=new Map,l=new Map;let u=0,h=0,m=0,p=0,g=0,v=0;for(const[t,f]of e){const e=f.getLoss(),y=e.isDownloadStream?"download":"upload";if(i[y]+=e.packetsTotal,n[y]+=e.packetsLost,r+=f.getBitrate().download,s+=f.getBitrate().upload,"audio"===f.kind){const e=f.getAudioConcealment();g+=e.concealedAudio,v+=e.totalAudioDuration,u+=f.getBitrate().download,h+=f.getBitrate().upload}else m+=f.getBitrate().download,p+=f.getBitrate().upload;o[f.getType()].set(t,f.getResolution()),a[f.getType()].set(t,f.getFramerate()),c[f.getType()].set(t,f.getCodec()),"remote"===f.getType()&&(d.set(t,f.getJitter()),"audio"===f.kind&&l.set(t,f.getAudioConcealment())),f.resetBitrate()}return t.bitrate={upload:s,download:r},t.bitrate.audio={upload:h,download:u},t.bitrate.video={upload:p,download:m},t.packetLoss={total:k.calculatePacketLoss(n.download+n.upload,i.download+i.upload),download:k.calculatePacketLoss(n.download,i.download),upload:k.calculatePacketLoss(n.upload,i.upload)},t.audioConcealment=l,t.totalAudioConcealment={concealedAudio:g,totalAudioDuration:v},t.framerate=a,t.resolution=o,t.codec=c,t.jitter=d,t}static calculatePacketLoss(e,t){return!t||t<=0||!e||e<=0?0:Math.round(e/t*100)}}class R{static buildCallFeedReport(e,t,i){const n=i.getTransceivers(),r=[];return n.forEach((e=>{var t;const i=null!==(t=e.sender)&&void 0!==t&&t.track?R.buildTrackStats(e.sender.track,"sender"):null,n=R.buildTrackStats(e.receiver.track,"receiver");r.push({mid:null==e.mid?"null":e.mid,direction:e.direction,currentDirection:null==e.currentDirection?"null":e.currentDirection,sender:i,receiver:n})})),{callId:e,opponentMemberId:t,transceiver:r,callFeeds:[]}}static buildTrackStats(e,t="--"){var i,n;const r=null===(i=e.getSettings())||void 0===i?void 0:i.deviceId,s=null===(n=e.getConstraints())||void 0===n?void 0:n.deviceId;return{id:e.id,kind:e.kind,settingDeviceId:r||"unknown",constrainDeviceId:s||"unknown",muted:e.muted,enabled:e.enabled,readyState:e.readyState,label:t}}static expandCallFeedReport(e,t,i="unknown"){return e.callFeeds||(e.callFeeds=[]),t.forEach((t=>{const n=t.stream.getAudioTracks(),r=t.stream.getVideoTracks(),s=n.length>0?R.buildTrackStats(t.stream.getAudioTracks()[0],t.purpose):null,o=r.length>0?R.buildTrackStats(t.stream.getVideoTracks()[0],t.purpose):null,a={stream:t.stream.id,type:t.isLocal()?"local":"remote",audio:s,video:o,purpose:t.purpose,prefix:i,isVideoMuted:t.isVideoMuted(),isAudioMuted:t.isAudioMuted()};e.callFeeds.push(a)})),e}}function T(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function C(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?T(Object(i),!0).forEach((function(t){(0,n.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):T(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class A{constructor(e,t,i,r,s=!0){this.callId=e,this.opponentMemberId=t,this.pc=i,this.emitter=r,this.isFocus=s,(0,n.A)(this,"isActive",!0),(0,n.A)(this,"previousStatsReport",void 0),(0,n.A)(this,"currentStatsReport",void 0),(0,n.A)(this,"connectionStats",new g),(0,n.A)(this,"trackStats",void 0),i.addEventListener("signalingstatechange",this.onSignalStateChange.bind(this)),this.trackStats=new _(new b,new S(i))}async processStats(e,t){const i={isFirstCollection:void 0===this.previousStatsReport,receivedMedia:0,receivedAudioMedia:0,receivedVideoMedia:0,audioTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0},videoTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0}};if(this.isActive){const n=this.pc.getStats();if("function"==typeof(null==n?void 0:n.then))return n.then((n=>{var r,s;this.currentStatsReport="function"==typeof(null==n?void 0:n.result)?n.result():n;try{this.processStatsReport(e,t)}catch(e){return this.handleError(e),i}this.previousStatsReport=this.currentStatsReport,i.receivedMedia=this.connectionStats.bitrate.download,i.receivedAudioMedia=(null===(r=this.connectionStats.bitrate.audio)||void 0===r?void 0:r.download)||0,i.receivedVideoMedia=(null===(s=this.connectionStats.bitrate.video)||void 0===s?void 0:s.download)||0;const o=I.buildTrackSummary(Array.from(this.trackStats.getTrack2stats().values()));return C(C({},i),{},{audioTrackSummary:o.audioTrackSummary,videoTrackSummary:o.videoTrackSummary})})).catch((e=>(this.handleError(e),i)));this.isActive=!1}return Promise.resolve(i)}processStatsReport(e,t){var i;const n=new Map;n.callId=this.callId,n.opponentMemberId=this.opponentMemberId,null===(i=this.currentStatsReport)||void 0===i||i.forEach((e=>{const t=this.previousStatsReport?this.previousStatsReport.get(e.id):null;if("candidate-pair"===e.type&&e.nominated&&"succeeded"===e.state)this.connectionStats.bandwidth=v.buildBandwidthReport(e),this.connectionStats.transport=f.buildReport(this.currentStatsReport,e,this.connectionStats.transport,this.isFocus);else if("inbound-rtp"===e.type||"outbound-rtp"===e.type){const i=this.trackStats.findTrack2Stats(e,"inbound-rtp"===e.type?"remote":"local");if(!i)return;if(t&&I.buildPacketsLost(i,e,t),"inbound-rtp"===e.type){I.buildFramerateResolution(i,e),t&&I.buildBitrateReceived(i,e,t);const n=this.trackStats.findTransceiverByTrackId(i.trackId);I.setTrackStatsState(i,n),I.buildJitter(i,e),I.buildAudioConcealment(i,e)}else t&&(n.set(i.trackId,E.getNonNegativeValue(e.bytesSent)),I.buildBitrateSend(i,e,t));I.buildCodec(this.currentStatsReport,i,e)}else if("track"===e.type&&"video"===e.kind&&!e.remoteSource){const i=this.trackStats.findLocalVideoTrackStats(e);if(!i)return;I.buildFramerateResolution(i,e),I.calculateSimulcastFramerate(i,e,t,this.trackStats.mediaTrackHandler.getActiveSimulcastStreams())}})),this.emitter.emitByteSendReport(n),this.emitter.emitCallFeedReport(R.buildCallFeedReport(this.callId,this.opponentMemberId,this.pc)),this.processAndEmitConnectionStatsReport()}setActive(e){this.isActive=e}getActive(){return this.isActive}handleError(e){this.isActive=!1,c.v.warn(`CallStatsReportGatherer ${this.callId} processStatsReport fails and set to inactive ${e}`)}processAndEmitConnectionStatsReport(){const e=k.build(this.trackStats.getTrack2stats());e.callId=this.callId,e.opponentMemberId=this.opponentMemberId,this.connectionStats.bandwidth=e.bandwidth,this.connectionStats.bitrate=e.bitrate,this.connectionStats.packetLoss=e.packetLoss,this.emitter.emitConnectionStatsReport(C(C({},e),{},{transport:this.connectionStats.transport})),this.connectionStats.transport=[]}stopProcessingStats(){}onSignalStateChange(){"stable"===this.pc.signalingState&&(this.pc.currentRemoteDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentRemoteDescription.sdp,"remote"),this.pc.currentLocalDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentLocalDescription.sdp,"local"))}setOpponentMemberId(e){this.opponentMemberId=e}}var O=i("./node_modules/matrix-js-sdk/src/webrtc/stats/statsReport.ts");class x extends r.X{emitByteSendReport(e){this.emit(O.I.BYTE_SENT_STATS,e)}emitConnectionStatsReport(e){this.emit(O.I.CONNECTION_STATS,e)}emitCallFeedReport(e){this.emit(O.I.CALL_FEED_REPORT,e)}emitSummaryStatsReport(e){this.emit(O.I.SUMMARY_STATS,e)}}class M{constructor(e){this.emitter=e}build(e){const t=e.filter((e=>!e.isFirstCollection)),i=t.length,n=e.length;if(0===i)return;const r={receivedAudio:0,receivedVideo:0,receivedMedia:0,concealedAudio:0,totalAudio:0};let s=0,o=0;t.forEach((e=>{this.countTrackListReceivedMedia(r,e),this.countConcealedAudio(r,e),s=this.buildMaxJitter(s,e),o=this.buildMaxPacketLoss(o,e)}));const a={percentageReceivedMedia:Number((r.receivedMedia/i).toFixed(5)),percentageReceivedVideoMedia:Number((r.receivedVideo/i).toFixed(5)),percentageReceivedAudioMedia:Number((r.receivedAudio/i).toFixed(5)),maxJitter:s,maxPacketLoss:o,percentageConcealedAudio:Number(r.totalAudio>0?(r.concealedAudio/r.totalAudio).toFixed(5):0),peerConnections:n};this.emitter.emitSummaryStatsReport(a)}static extendSummaryReport(e,t){const i=[],n=[];for(const e of t){n.push(e);for(const t of e[1])i.push(t)}e.opponentDevicesInCall=Math.max(0,i.length-1),e.opponentUsersInCall=Math.max(0,n.length-1),e.diffDevicesToPeerConnections=Math.max(0,i.length-1)-e.peerConnections,e.ratioPeerConnectionToDevices=0==Math.max(0,i.length-1)?0:e.peerConnections/(i.length-1)}countTrackListReceivedMedia(e,t){let i=!1,n=!1;(t.receivedAudioMedia>0||0===t.audioTrackSummary.count)&&(e.receivedAudio++,i=!0),(t.receivedVideoMedia>0||0===t.videoTrackSummary.count||t.videoTrackSummary.muted>0&&t.videoTrackSummary.muted===t.videoTrackSummary.count)&&(e.receivedVideo++,n=!0),n&&i&&e.receivedMedia++}buildMaxJitter(e,t){return e<t.videoTrackSummary.maxJitter&&(e=t.videoTrackSummary.maxJitter),e<t.audioTrackSummary.maxJitter&&(e=t.audioTrackSummary.maxJitter),e}buildMaxPacketLoss(e,t){return e<t.videoTrackSummary.maxPacketLoss&&(e=t.videoTrackSummary.maxPacketLoss),e<t.audioTrackSummary.maxPacketLoss&&(e=t.audioTrackSummary.maxPacketLoss),e}countConcealedAudio(e,t){e.concealedAudio+=t.audioTrackSummary.concealedAudio,e.totalAudio+=t.audioTrackSummary.totalAudio}}class P{constructor(e,t,i=1e4){this.groupCallId=e,this.userId=t,this.interval=i,(0,n.A)(this,"timer",void 0),(0,n.A)(this,"gatherers",new Map),(0,n.A)(this,"reports",new x),(0,n.A)(this,"summaryStatsReportGatherer",new M(this.reports))}start(){void 0===this.timer&&this.interval>0&&(this.timer=setInterval((()=>{this.processStats()}),this.interval))}stop(){void 0!==this.timer&&(clearInterval(this.timer),this.gatherers.forEach((e=>e.stopProcessingStats())))}hasStatsReportGatherer(e){return this.gatherers.has(e)}addStatsReportGatherer(e,t,i){return!this.hasStatsReportGatherer(e)&&(this.gatherers.set(e,new A(e,t,i,this.reports)),!0)}removeStatsReportGatherer(e){return this.gatherers.delete(e)}getStatsReportGatherer(e){return this.hasStatsReportGatherer(e)?this.gatherers.get(e):void 0}updateOpponentMember(e,t){var i;null===(i=this.getStatsReportGatherer(e))||void 0===i||i.setOpponentMemberId(t)}processStats(){const e=[];this.gatherers.forEach((t=>{e.push(t.processStats(this.groupCallId,this.userId))})),Promise.all(e).then((e=>this.summaryStatsReportGatherer.build(e))).catch((e=>{c.v.error("Could not build summary stats report",e)}))}setInterval(e){this.interval=e}}var j=i("./node_modules/matrix-js-sdk/src/@types/membership.ts");function D(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function U(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?D(Object(i),!0).forEach((function(t){(0,n.A)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):D(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let L=function(e){return e.Ring="m.ring",e.Prompt="m.prompt",e.Room="m.room",e}({}),N=function(e){return e.Video="m.video",e.Voice="m.voice",e}({}),B=function(e){return e.CallEnded="call_ended",e}({}),F=function(e){return e.GroupCallStateChanged="group_call_state_changed",e.ActiveSpeakerChanged="active_speaker_changed",e.CallsChanged="calls_changed",e.UserMediaFeedsChanged="user_media_feeds_changed",e.ScreenshareFeedsChanged="screenshare_feeds_changed",e.LocalScreenshareStateChanged="local_screenshare_state_changed",e.LocalMuteStateChanged="local_mute_state_changed",e.ParticipantsChanged="participants_changed",e.Error="group_call_error",e}({}),K=function(e){return e.ConnectionStats="GroupCall.connection_stats",e.ByteSentStats="GroupCall.byte_sent_stats",e.SummaryStats="GroupCall.summary_stats",e.CallFeedStats="GroupCall.call_feed_stats",e}({}),$=function(e){return e.NoUserMedia="no_user_media",e.UnknownDevice="unknown_device",e.PlaceCallFailed="place_call_failed",e}({});class q extends Error{constructor(e,t,i){i?(super(t+": "+i),(0,n.A)(this,"code",void 0)):(super(t),(0,n.A)(this,"code",void 0)),this.code=e}}class V extends q{constructor(e){super($.UnknownDevice,"No device found for "+e),this.userId=e}}Error;let G=function(e){return e.LocalCallFeedUninitialized="local_call_feed_uninitialized",e.InitializingLocalCallFeed="initializing_local_call_feed",e.LocalCallFeedInitialized="local_call_feed_initialized",e.Entered="entered",e.Ended="ended",e}({});const W=36e5;function H(e){var t;return(null===(t=e.getOpponentMember())||void 0===t?void 0:t.userId)||e.invitee||null}class J extends r.X{constructor(e,t,i,r,l,h,m,p,g,v=!1,f){var y,b;super(),this.client=e,this.room=t,this.type=i,this.isPtt=r,this.intent=l,this.dataChannelsEnabled=m,this.dataChannelOptions=p,this.useLivekit=v,(0,n.A)(this,"activeSpeakerInterval",1e3),(0,n.A)(this,"retryCallInterval",5e3),(0,n.A)(this,"participantTimeout",15e3),(0,n.A)(this,"pttMaxTransmitTime",2e4),(0,n.A)(this,"activeSpeaker",void 0),(0,n.A)(this,"localCallFeed",void 0),(0,n.A)(this,"localScreenshareFeed",void 0),(0,n.A)(this,"localDesktopCapturerSourceId",void 0),(0,n.A)(this,"userMediaFeeds",[]),(0,n.A)(this,"screenshareFeeds",[]),(0,n.A)(this,"groupCallId",void 0),(0,n.A)(this,"allowCallWithoutVideoAndAudio",void 0),(0,n.A)(this,"calls",new Map),(0,n.A)(this,"callHandlers",new Map),(0,n.A)(this,"activeSpeakerLoopInterval",void 0),(0,n.A)(this,"retryCallLoopInterval",void 0),(0,n.A)(this,"retryCallCounts",new Map),(0,n.A)(this,"reEmitter",void 0),(0,n.A)(this,"transmitTimer",null),(0,n.A)(this,"participantsExpirationTimer",null),(0,n.A)(this,"resendMemberStateTimer",null),(0,n.A)(this,"initWithAudioMuted",!1),(0,n.A)(this,"initWithVideoMuted",!1),(0,n.A)(this,"initCallFeedPromise",void 0),(0,n.A)(this,"_livekitServiceURL",void 0),(0,n.A)(this,"stats",void 0),(0,n.A)(this,"statsCollectIntervalTime",0),(0,n.A)(this,"onConnectionStats",(e=>{this.emit(K.ConnectionStats,{report:e})})),(0,n.A)(this,"onByteSentStats",(e=>{this.emit(K.ByteSentStats,{report:e})})),(0,n.A)(this,"onSummaryStats",(e=>{M.extendSummaryReport(e,this.participants),this.emit(K.SummaryStats,{report:e})})),(0,n.A)(this,"onCallFeedReport",(e=>{this.localCallFeed&&(e=R.expandCallFeedReport(e,[this.localCallFeed],"from-local-feed"));const t=[];this.forEachCall((i=>{i.callId===e.callId&&i.getFeeds().forEach((e=>t.push(e)))})),e=R.expandCallFeedReport(e,t,"from-call-feed"),this.emit(K.CallFeedStats,{report:e})})),(0,n.A)(this,"_state",G.LocalCallFeedUninitialized),(0,n.A)(this,"_participants",new Map),(0,n.A)(this,"_creationTs",null),(0,n.A)(this,"_enteredViaAnotherSession",!1),(0,n.A)(this,"onIncomingCall",(e=>{var t,i;if(e.roomId!==this.room.roomId)return;if(e.state!==o.iP.Ringing)return void c.v.warn(`GroupCall ${this.groupCallId} onIncomingCall() incoming call no longer in ringing state - ignoring`);if(!e.groupCallId||e.groupCallId!==this.groupCallId)return c.v.log(`GroupCall ${this.groupCallId} onIncomingCall() ignored because it doesn't match the current group call`),void e.reject();const n=null===(t=e.getOpponentMember())||void 0===t?void 0:t.userId;if(void 0===n)return void c.v.warn(`GroupCall ${this.groupCallId} onIncomingCall() incoming call with no member - ignoring`);if(this.useLivekit)return void c.v.info("Received incoming call whilst in signaling-only mode! Ignoring.");const r=null!==(i=this.calls.get(n))&&void 0!==i?i:new Map,s=r.get(e.getOpponentDeviceId());if((null==s?void 0:s.callId)===e.callId)return;c.v.log(`GroupCall ${this.groupCallId} onIncomingCall() incoming call (userId=${n}, callId=${e.callId})`),s&&s.hangup(o.Il.Replaced,!1),r.set(e.getOpponentDeviceId(),e),this.calls.set(n,r),this.initCall(e);const a=this.getLocalFeeds().map((e=>e.clone()));if(!this.callExpected(e))for(const e of a)(0,o.ms)(e.stream.getAudioTracks(),!1),(0,o.ms)(e.stream.getVideoTracks(),!1);e.answerWithCallFeeds(a),this.emit(F.CallsChanged,this.calls)})),(0,n.A)(this,"onRetryCallLoop",(()=>{let e=!1;for(const[{userId:n},r]of this.participants){const s=this.calls.get(n);let o=this.retryCallCounts.get(n);for(const[a,c]of r){var t,i;const r=null==s?void 0:s.get(a),d=null!==(t=null===(i=o)||void 0===i?void 0:i.get(a))&&void 0!==t?t:0;(null==r?void 0:r.getOpponentSessionId())!==c.sessionId&&this.wantsOutgoingCall(n,a)&&d<3&&(void 0===o&&(o=new Map,this.retryCallCounts.set(n,o)),o.set(a,d+1),e=!0)}}e&&this.placeOutgoingCalls()})),(0,n.A)(this,"onCallFeedsChanged",(e=>{const t=H(e),i=e.getOpponentDeviceId();if(!t)throw new Error("Cannot change call feeds without user id");const n=this.getUserMediaFeed(t,i),r=e.remoteUsermediaFeed,s=r!==n,o=this.calls.get(t),a=null==o?void 0:o.get(i);if((null==a?void 0:a.callId)!==e.callId)return;s&&(!n&&r?this.addUserMediaFeed(r):n&&r?this.replaceUserMediaFeed(n,r):n&&!r&&this.removeUserMediaFeed(n));const c=this.getScreenshareFeed(t,i),d=e.remoteScreensharingFeed;d!==c&&(!c&&d?this.addScreenshareFeed(d):c&&d?this.replaceScreenshareFeed(c,d):c&&!d&&this.removeScreenshareFeed(c))})),(0,n.A)(this,"onCallStateChanged",((e,t,i)=>{var n;if(t===o.iP.Ended)return;const r=this.localCallFeed.isAudioMuted();e.localUsermediaStream&&e.isMicrophoneMuted()!==r&&e.setMicrophoneMuted(r);const s=this.localCallFeed.isVideoMuted();e.localUsermediaStream&&e.isLocalVideoMuted()!==s&&e.setLocalVideoMuted(s);const a=null===(n=e.getOpponentMember())||void 0===n?void 0:n.userId;if(t===o.iP.Connected&&a){const t=this.retryCallCounts.get(a);null==t||t.delete(e.getOpponentDeviceId()),0===(null==t?void 0:t.size)&&this.retryCallCounts.delete(a)}})),(0,n.A)(this,"onCallHangup",(e=>{var t,i;if(e.hangupReason===o.Il.Replaced)return;const n=null!==(t=null===(i=e.getOpponentMember())||void 0===i?void 0:i.userId)&&void 0!==t?t:this.room.getMember(e.invitee).userId,r=this.calls.get(n);(null==r?void 0:r.get(e.getOpponentDeviceId()))===e&&(this.disposeCall(e,e.hangupReason),r.delete(e.getOpponentDeviceId()),0===r.size&&this.calls.delete(n),this.emit(F.CallsChanged,this.calls))})),(0,n.A)(this,"onCallReplaced",((e,t)=>{const i=e.getOpponentMember().userId;let n=this.calls.get(i);void 0===n&&(n=new Map,this.calls.set(i,n)),e.hangup(o.Il.Replaced,!1),this.initCall(t),n.set(e.getOpponentDeviceId(),t),this.emit(F.CallsChanged,this.calls)})),(0,n.A)(this,"onActiveSpeakerLoop",(()=>{let e,t;for(const i of this.userMediaFeeds){if(i.isLocal()&&this.userMediaFeeds.length>1)continue;const n=i.speakingVolumeSamples.reduce(((e,t)=>e+Math.max(t,s.Tw)))/i.speakingVolumeSamples.length;(!e||n>e)&&(e=n,t=i)}t&&this.activeSpeaker!==t&&e&&e>s.Tw&&(this.activeSpeaker=t,this.emit(F.ActiveSpeakerChanged,this.activeSpeaker))})),(0,n.A)(this,"onRoomState",(()=>this.updateParticipants())),(0,n.A)(this,"onParticipantsChanged",(()=>{this.forEachCall((e=>{const t=this.callExpected(e);for(const i of e.getLocalFeeds())(0,o.ms)(i.stream.getAudioTracks(),!i.isAudioMuted()&&t),(0,o.ms)(i.stream.getVideoTracks(),!i.isVideoMuted()&&t)})),this.state!==G.Entered||this.useLivekit||this.placeOutgoingCalls()})),(0,n.A)(this,"onStateChanged",((e,t)=>{e!==G.Entered&&t!==G.Entered&&e!==G.Ended||(this.updateParticipants(),this.updateMemberState().catch((e=>c.v.error(`GroupCall ${this.groupCallId} onStateChanged() failed to update member state devices"`,e))))})),(0,n.A)(this,"onLocalFeedsChanged",(()=>{this.state===G.Entered&&this.updateMemberState().catch((e=>c.v.error(`GroupCall ${this.groupCallId} onLocalFeedsChanged() failed to update member state feeds`,e)))})),this.reEmitter=new d.K(this),this.groupCallId=null!=h?h:(0,o.WE)(),this._livekitServiceURL=f,this.creationTs=null!==(y=null===(b=t.currentState.getStateEvents(u.Bx.GroupCallPrefix,this.groupCallId))||void 0===b?void 0:b.getTs())&&void 0!==y?y:null,this.updateParticipants(),t.on(a.f.Update,this.onRoomState),this.on(F.ParticipantsChanged,this.onParticipantsChanged),this.on(F.GroupCallStateChanged,this.onStateChanged),this.on(F.LocalScreenshareStateChanged,this.onLocalFeedsChanged),this.allowCallWithoutVideoAndAudio=!!g}async create(){return this.creationTs=Date.now(),this.client.groupCallEventHandler.groupCalls.set(this.room.roomId,this),this.client.emit(m.o.Outgoing,this),await this.sendCallStateEvent(),this}async sendCallStateEvent(){const e={"m.intent":this.intent,"m.type":this.type,"io.element.ptt":this.isPtt,dataChannelsEnabled:this.dataChannelsEnabled,dataChannelOptions:this.dataChannelsEnabled?this.dataChannelOptions:void 0};this.livekitServiceURL&&(e["io.element.livekit_service_url"]=this.livekitServiceURL),await this.client.sendStateEvent(this.room.roomId,u.Bx.GroupCallPrefix,e,this.groupCallId)}get livekitServiceURL(){return this._livekitServiceURL}updateLivekitServiceURL(e){return this._livekitServiceURL=e,this.sendCallStateEvent()}get state(){return this._state}set state(e){const t=this._state;e!==t&&(this._state=e,this.emit(F.GroupCallStateChanged,e,t))}get participants(){return this._participants}set participants(e){const t=this._participants,i=(e,t)=>e.sessionId===t.sessionId&&e.screensharing===t.screensharing;(0,p.kg)(e,t,((e,t)=>(0,p.kg)(e,t,i)))||(this._participants=e,this.emit(F.ParticipantsChanged,e))}get creationTs(){return this._creationTs}set creationTs(e){this._creationTs=e}get enteredViaAnotherSession(){return this._enteredViaAnotherSession}set enteredViaAnotherSession(e){this._enteredViaAnotherSession=e,this.updateParticipants()}forEachCall(e){for(const t of this.calls.values())for(const i of t.values())e(i)}getLocalFeeds(){const e=[];return this.localCallFeed&&e.push(this.localCallFeed),this.localScreenshareFeed&&e.push(this.localScreenshareFeed),e}hasLocalParticipant(){var e,t;return null!==(e=null===(t=this.participants.get(this.room.getMember(this.client.getUserId())))||void 0===t?void 0:t.has(this.client.getDeviceId()))&&void 0!==e&&e}callExpected(e){var t;const i=H(e),n=null===i?null:this.room.getMember(i),r=e.getOpponentDeviceId();return null!==n&&void 0!==r&&void 0!==(null===(t=this.participants.get(n))||void 0===t?void 0:t.get(r))}async initLocalCallFeed(){if(this.useLivekit)c.v.info("Livekit group call: not starting local call feed.");else{if(this.state!==G.LocalCallFeedUninitialized)throw new Error(`Cannot initialize local call feed in the "${this.state}" state.`);if(this.state=G.InitializingLocalCallFeed,this.initCallFeedPromise)return this.initCallFeedPromise;try{this.initCallFeedPromise=this.initLocalCallFeedInternal(),await this.initCallFeedPromise}finally{this.initCallFeedPromise=void 0}}}async initLocalCallFeedInternal(){let e;c.v.log(`GroupCall ${this.groupCallId} initLocalCallFeedInternal() running`);try{e=await this.client.getMediaHandler().getUserMediaStream(!0,this.type===N.Video)}catch(t){if(!this.allowCallWithoutVideoAndAudio)throw this.state=G.LocalCallFeedUninitialized,t;e=new MediaStream}if(this._state!==G.InitializingLocalCallFeed)throw this.client.getMediaHandler().stopUserMediaStream(e),new Error("Group call disposed while gathering media stream");const t=new s.Hh({client:this.client,roomId:this.room.roomId,userId:this.client.getUserId(),deviceId:this.client.getDeviceId(),stream:e,purpose:l.h.Usermedia,audioMuted:this.initWithAudioMuted||0===e.getAudioTracks().length||this.isPtt,videoMuted:this.initWithVideoMuted||0===e.getVideoTracks().length});(0,o.ms)(e.getAudioTracks(),!t.isAudioMuted()),(0,o.ms)(e.getVideoTracks(),!t.isVideoMuted()),this.localCallFeed=t,this.addUserMediaFeed(t),this.state=G.LocalCallFeedInitialized}async updateLocalUsermediaStream(e){if(this.localCallFeed){const t=this.localCallFeed.stream;this.localCallFeed.setNewStream(e);const i=this.localCallFeed.isAudioMuted(),n=this.localCallFeed.isVideoMuted();c.v.log(`GroupCall ${this.groupCallId} updateLocalUsermediaStream() (oldStreamId=${t.id}, newStreamId=${e.id}, micShouldBeMuted=${i}, vidShouldBeMuted=${n})`),(0,o.ms)(e.getAudioTracks(),!i),(0,o.ms)(e.getVideoTracks(),!n),this.client.getMediaHandler().stopUserMediaStream(t)}}async enter(){if(this.state===G.LocalCallFeedUninitialized)await this.initLocalCallFeed();else if(this.state!==G.LocalCallFeedInitialized)throw new Error(`Cannot enter call in the "${this.state}" state`);c.v.log(`GroupCall ${this.groupCallId} enter() running`),this.state=G.Entered,this.client.on(h.B.Incoming,this.onIncomingCall);for(const e of this.client.callEventHandler.calls.values())this.onIncomingCall(e);this.useLivekit||(this.retryCallLoopInterval=setInterval(this.onRetryCallLoop,this.retryCallInterval),this.activeSpeaker=void 0,this.onActiveSpeakerLoop(),this.activeSpeakerLoopInterval=setInterval(this.onActiveSpeakerLoop,this.activeSpeakerInterval))}dispose(){var e;this.localCallFeed&&(this.removeUserMediaFeed(this.localCallFeed),this.localCallFeed=void 0),this.localScreenshareFeed&&(this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0),this.client.getMediaHandler().stopAllStreams(),null!==this.transmitTimer&&(clearTimeout(this.transmitTimer),this.transmitTimer=null),void 0!==this.retryCallLoopInterval&&(clearInterval(this.retryCallLoopInterval),this.retryCallLoopInterval=void 0),null!==this.participantsExpirationTimer&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===G.Entered&&(this.forEachCall((e=>e.hangup(o.Il.UserHangup,!1))),this.activeSpeaker=void 0,clearInterval(this.activeSpeakerLoopInterval),this.retryCallCounts.clear(),clearInterval(this.retryCallLoopInterval),this.client.removeListener(h.B.Incoming,this.onIncomingCall),null===(e=this.stats)||void 0===e||e.stop())}leave(){this.dispose(),this.state=G.LocalCallFeedUninitialized}async terminate(e=!0){if(this.dispose(),this.room.off(a.f.Update,this.onRoomState),this.client.groupCallEventHandler.groupCalls.delete(this.room.roomId),this.client.emit(m.o.Ended,this),this.state=G.Ended,e){const e=this.room.currentState.getStateEvents(u.Bx.GroupCallPrefix,this.groupCallId);await this.client.sendStateEvent(this.room.roomId,u.Bx.GroupCallPrefix,U(U({},e.getContent()),{},{"m.terminated":B.CallEnded}),this.groupCallId)}}isLocalVideoMuted(){return!this.localCallFeed||this.localCallFeed.isVideoMuted()}isMicrophoneMuted(){return!this.localCallFeed||this.localCallFeed.isAudioMuted()}async setMicrophoneMuted(e){if(!e&&!await this.client.getMediaHandler().hasAudioDevice())return!1;const t=!e&&this.isPtt;this.isPtt&&(!e&&this.isMicrophoneMuted()?this.transmitTimer=setTimeout((()=>{this.setMicrophoneMuted(!0)}),this.pttMaxTransmitTime):e&&!this.isMicrophoneMuted()&&(null!==this.transmitTimer&&clearTimeout(this.transmitTimer),this.transmitTimer=null)),this.forEachCall((t=>{var i;return null===(i=t.localUsermediaFeed)||void 0===i?void 0:i.setAudioVideoMuted(e,null)}));const i=async()=>{const e=[];this.forEachCall((t=>e.push(t.sendMetadataUpdate()))),await Promise.all(e).catch((e=>c.v.info(`GroupCall ${this.groupCallId} setMicrophoneMuted() failed to send some metadata updates`,e)))};if(t&&await i(),this.localCallFeed){c.v.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() (streamId=${this.localCallFeed.stream.id}, muted=${e})`);if(!await this.checkAudioPermissionIfNecessary(e))return!1;this.localCallFeed.setAudioVideoMuted(e,null),(0,o.ms)(this.localCallFeed.stream.getAudioTracks(),!e)}else c.v.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() no stream muted (muted=${e})`),this.initWithAudioMuted=e;return this.forEachCall((t=>(0,o.ms)(t.localUsermediaFeed.stream.getAudioTracks(),!e&&this.callExpected(t)))),this.emit(F.LocalMuteStateChanged,e,this.isLocalVideoMuted()),t||await i(),!0}async checkAudioPermissionIfNecessary(e){try{if(!e&&this.localCallFeed&&!this.localCallFeed.hasAudioTrack){const t=await this.client.getMediaHandler().getUserMediaStream(!0,!this.localCallFeed.isVideoMuted());if(0===(null==t?void 0:t.getTracks().length))return c.v.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() no device to receive local stream, muted=${e}`),!1}}catch(t){return c.v.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() no device or permission to receive local stream, muted=${e}`),!1}return!0}async setLocalVideoMuted(e){if(!e&&!await this.client.getMediaHandler().hasVideoDevice())return!1;if(this.localCallFeed){c.v.log(`GroupCall ${this.groupCallId} setLocalVideoMuted() (stream=${this.localCallFeed.stream.id}, muted=${e})`);try{const t=await this.client.getMediaHandler().getUserMediaStream(!0,!e);await this.updateLocalUsermediaStream(t),this.localCallFeed.setAudioVideoMuted(null,e),(0,o.ms)(this.localCallFeed.stream.getVideoTracks(),!e)}catch(t){return c.v.log(`GroupCall ${this.groupCallId} setLocalVideoMuted() no device or permission to receive local stream, muted=${e}`),!1}}else c.v.log(`GroupCall ${this.groupCallId} setLocalVideoMuted() no stream muted (muted=${e})`),this.initWithVideoMuted=e;const t=[];return this.forEachCall((i=>t.push(i.setLocalVideoMuted(e)))),await Promise.all(t),this.forEachCall((t=>(0,o.ms)(t.localUsermediaFeed.stream.getVideoTracks(),!e&&this.callExpected(t)))),this.emit(F.LocalMuteStateChanged,this.isMicrophoneMuted(),e),!0}async setScreensharingEnabled(e,t={}){if(e===this.isScreensharing())return e;if(!e)return this.forEachCall((e=>{e.localScreensharingFeed&&e.removeLocalFeed(e.localScreensharingFeed)})),this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0,this.emit(F.LocalScreenshareStateChanged,!1,void 0,void 0),!1;try{c.v.log(`GroupCall ${this.groupCallId} setScreensharingEnabled() is asking for screensharing permissions`);const e=await this.client.getMediaHandler().getScreensharingStream(t);for(const t of e.getTracks()){const e=()=>{this.setScreensharingEnabled(!1),t.removeEventListener("ended",e)};t.addEventListener("ended",e)}return c.v.log(`GroupCall ${this.groupCallId} setScreensharingEnabled() granted screensharing permissions. Setting screensharing enabled on all calls`),this.localDesktopCapturerSourceId=t.desktopCapturerSourceId,this.localScreenshareFeed=new s.Hh({client:this.client,roomId:this.room.roomId,userId:this.client.getUserId(),deviceId:this.client.getDeviceId(),stream:e,purpose:l.h.Screenshare,audioMuted:!1,videoMuted:!1}),this.addScreenshareFeed(this.localScreenshareFeed),this.emit(F.LocalScreenshareStateChanged,!0,this.localScreenshareFeed,this.localDesktopCapturerSourceId),this.forEachCall((e=>e.pushLocalFeed(this.localScreenshareFeed.clone()))),!0}catch(e){if(t.throwOnFail)throw e;return c.v.error(`GroupCall ${this.groupCallId} setScreensharingEnabled() enabling screensharing error`,e),this.emit(F.Error,new q($.NoUserMedia,"Failed to get screen-sharing stream: ",e)),!1}}isScreensharing(){return!!this.localScreenshareFeed}wantsOutgoingCall(e,t){const i=this.client.getUserId(),n=this.client.getDeviceId();return e>=i&&(e!==i||t>n)}placeOutgoingCalls(){let e=!1;for(const[{userId:i},n]of this.participants){var t;const r=null!==(t=this.calls.get(i))&&void 0!==t?t:new Map;for(const[t,s]of n){const n=r.get(t);if((null==n?void 0:n.getOpponentSessionId())!==s.sessionId&&this.wantsOutgoingCall(i,t)){e=!0,void 0!==n&&(c.v.debug(`GroupCall ${this.groupCallId} placeOutgoingCalls() replacing call (userId=${i}, deviceId=${t}, callId=${n.callId})`),n.hangup(o.Il.NewSession,!1));const a=(0,o.sv)(this.client,this.room.roomId,{invitee:i,opponentDeviceId:t,opponentSessionId:s.sessionId,groupCallId:this.groupCallId});null===a?(c.v.error(`GroupCall ${this.groupCallId} placeOutgoingCalls() failed to create call (userId=${i}, device=${t})`),r.delete(t)):(this.initCall(a),r.set(t,a),c.v.debug(`GroupCall ${this.groupCallId} placeOutgoingCalls() placing call (userId=${i}, deviceId=${t}, sessionId=${s.sessionId})`),a.placeCallWithCallFeeds(this.getLocalFeeds().map((e=>e.clone())),s.screensharing).then((()=>{this.dataChannelsEnabled&&a.createDataChannel("datachannel",this.dataChannelOptions)})).catch((e=>{c.v.warn(`GroupCall ${this.groupCallId} placeOutgoingCalls() failed to place call (userId=${i})`,e),e instanceof o.RA&&e.code===$.UnknownDevice?this.emit(F.Error,e):this.emit(F.Error,new q($.PlaceCallFailed,`Failed to place call to ${i}`)),a.hangup(o.Il.SignallingFailed,!1),r.get(t)===a&&r.delete(t)})))}}r.size>0?this.calls.set(i,r):this.calls.delete(i)}e&&this.emit(F.CallsChanged,this.calls)}getMemberStateEvents(e){return void 0===e?this.room.currentState.getStateEvents(u.Bx.GroupCallMemberPrefix):this.room.currentState.getStateEvents(u.Bx.GroupCallMemberPrefix,e)}initCall(e){const t=H(e);if(!t)throw new Error("Cannot init call without user id");const i=()=>this.onCallFeedsChanged(e),n=(t,i)=>this.onCallStateChanged(e,t,i),r=this.onCallHangup,s=t=>this.onCallReplaced(e,t);let a=this.callHandlers.get(t);void 0===a&&(a=new Map,this.callHandlers.set(t,a)),a.set(e.getOpponentDeviceId(),{onCallFeedsChanged:i,onCallStateChanged:n,onCallHangup:r,onCallReplaced:s}),e.on(o.$E.FeedsChanged,i),e.on(o.$E.State,n),e.on(o.$E.Hangup,r),e.on(o.$E.Replaced,s),e.isPtt=this.isPtt,this.reEmitter.reEmit(e,Object.values(o.$E)),e.initStats(this.getGroupCallStats()),i()}disposeCall(e,t){const i=H(e),n=e.getOpponentDeviceId();if(!i)throw new Error("Cannot dispose call without user id");const r=this.callHandlers.get(i),{onCallFeedsChanged:s,onCallStateChanged:a,onCallHangup:c,onCallReplaced:d}=r.get(n);if(e.removeListener(o.$E.FeedsChanged,s),e.removeListener(o.$E.State,a),e.removeListener(o.$E.Hangup,c),e.removeListener(o.$E.Replaced,d),r.delete(i),0===r.size&&this.callHandlers.delete(i),e.hangupReason===o.Il.Replaced)return;const l=this.getUserMediaFeed(i,n);l&&this.removeUserMediaFeed(l);const u=this.getScreenshareFeed(i,n);u&&this.removeScreenshareFeed(u)}getUserMediaFeed(e,t){return this.userMediaFeeds.find((i=>i.userId===e&&i.deviceId===t))}addUserMediaFeed(e){this.userMediaFeeds.push(e),e.measureVolumeActivity(!0),this.emit(F.UserMediaFeedsChanged,this.userMediaFeeds)}replaceUserMediaFeed(e,t){const i=this.userMediaFeeds.findIndex((t=>t.userId===e.userId&&t.deviceId===e.deviceId));if(-1===i)throw new Error("Couldn't find user media feed to replace");this.userMediaFeeds.splice(i,1,t),e.dispose(),t.measureVolumeActivity(!0),this.emit(F.UserMediaFeedsChanged,this.userMediaFeeds)}removeUserMediaFeed(e){const t=this.userMediaFeeds.findIndex((t=>t.userId===e.userId&&t.deviceId===e.deviceId));if(-1===t)throw new Error("Couldn't find user media feed to remove");this.userMediaFeeds.splice(t,1),e.dispose(),this.emit(F.UserMediaFeedsChanged,this.userMediaFeeds),this.activeSpeaker===e&&(this.activeSpeaker=this.userMediaFeeds[0],this.emit(F.ActiveSpeakerChanged,this.activeSpeaker))}getScreenshareFeed(e,t){return this.screenshareFeeds.find((i=>i.userId===e&&i.deviceId===t))}addScreenshareFeed(e){this.screenshareFeeds.push(e),this.emit(F.ScreenshareFeedsChanged,this.screenshareFeeds)}replaceScreenshareFeed(e,t){const i=this.screenshareFeeds.findIndex((t=>t.userId===e.userId&&t.deviceId===e.deviceId));if(-1===i)throw new Error("Couldn't find screenshare feed to replace");this.screenshareFeeds.splice(i,1,t),e.dispose(),this.emit(F.ScreenshareFeedsChanged,this.screenshareFeeds)}removeScreenshareFeed(e){const t=this.screenshareFeeds.findIndex((t=>t.userId===e.userId&&t.deviceId===e.deviceId));if(-1===t)throw new Error("Couldn't find screenshare feed to remove");this.screenshareFeeds.splice(t,1),e.dispose(),this.emit(F.ScreenshareFeedsChanged,this.screenshareFeeds)}updateParticipants(){const e=this.room.getMember(this.client.getUserId());if(!e)return void c.v.warn(`GroupCall ${this.groupCallId} updateParticipants() tried to update participants before local room member is available`);if(null!==this.participantsExpirationTimer&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===G.Ended)return void(this.participants=new Map);const t=new Map,i=Date.now(),n=this.state===G.Entered||this.enteredViaAnotherSession;let r=1/0;for(const e of this.getMemberStateEvents()){const s=this.room.getMember(e.getStateKey()),o=e.getContent(),a=(Array.isArray(o["m.calls"])?o["m.calls"]:[]).find((e=>e["m.call_id"]===this.groupCallId));let c=(Array.isArray(null==a?void 0:a["m.devices"])?a["m.devices"]:[]).filter((e=>"string"==typeof e.device_id&&"string"==typeof e.session_id&&"number"==typeof e.expires_ts&&e.expires_ts>i&&Array.isArray(e.feeds)));if(n||(null==s?void 0:s.userId)!==this.client.getUserId()||(c=c.filter((e=>e.device_id!==this.client.getDeviceId()))),c.length>0&&(null==s?void 0:s.membership)===j.O.Join){const e=new Map;t.set(s,e);for(const t of c)e.set(t.device_id,{sessionId:t.session_id,screensharing:t.feeds.some((e=>e.purpose===l.h.Screenshare))}),t.expires_ts<r&&(r=t.expires_ts)}}if(n){let i=t.get(e);void 0===i&&(i=new Map,t.set(e,i)),i.has(this.client.getDeviceId())||i.set(this.client.getDeviceId(),{sessionId:this.client.getSessionId(),screensharing:this.getLocalFeeds().some((e=>e.purpose===l.h.Screenshare))})}this.participants=t,r<1/0&&(this.participantsExpirationTimer=setTimeout((()=>this.updateParticipants()),r-i))}async updateDevices(e,t=!1){var i;const n=Date.now(),r=this.client.getUserId(),s=this.getMemberStateEvents(r),o=null!==(i=null==s?void 0:s.getContent())&&void 0!==i?i:{},a=Array.isArray(o["m.calls"])?o["m.calls"]:[];let c=null;const d=[];for(const e of a)e["m.call_id"]===this.groupCallId?c=e:d.push(e);null===c&&(c={});const l=e((Array.isArray(c["m.devices"])?c["m.devices"]:[]).filter((e=>"string"==typeof e.device_id&&"string"==typeof e.session_id&&"number"==typeof e.expires_ts&&e.expires_ts>n&&Array.isArray(e.feeds))));if(null===l)return;const h=[...d];l.length>0&&h.push(U(U({},c),{},{"m.call_id":this.groupCallId,"m.devices":l}));const m={"m.calls":h};await this.client.sendStateEvent(this.room.roomId,u.Bx.GroupCallMemberPrefix,m,r,{keepAlive:t})}async addDeviceToMemberState(){await this.updateDevices((e=>[...e.filter((e=>e.device_id!==this.client.getDeviceId())),{device_id:this.client.getDeviceId(),session_id:this.client.getSessionId(),expires_ts:Date.now()+W,feeds:this.getLocalFeeds().map((e=>({purpose:e.purpose})))}]))}async updateMemberState(){null!==this.resendMemberStateTimer&&(clearInterval(this.resendMemberStateTimer),this.resendMemberStateTimer=null),this.state===G.Entered?(await this.addDeviceToMemberState(),this.resendMemberStateTimer=setInterval((async()=>{c.v.log(`GroupCall ${this.groupCallId} updateMemberState() resending call member state"`);try{await this.addDeviceToMemberState()}catch(e){c.v.error(`GroupCall ${this.groupCallId} updateMemberState() failed to resend call member state`,e)}}),27e5)):await this.updateDevices((e=>e.filter((e=>e.device_id!==this.client.getDeviceId()))),!0)}async cleanMemberState(){const{devices:e}=await this.client.getDevices(),t=new Map(e.map((e=>[e.device_id,e])));await this.updateDevices((e=>{const i=e.filter((e=>{const i=t.get(e.device_id);return void 0!==(null==i?void 0:i.last_seen_ts)&&!(e.device_id===this.client.getDeviceId()&&this.state!==G.Entered&&!this.enteredViaAnotherSession)}));return i.length===e.length?null:i}))}getGroupCallStats(){if(void 0===this.stats){const e=this.client.getUserId()||"unknown";this.stats=new P(this.groupCallId,e,this.statsCollectIntervalTime),this.stats.reports.on(O.I.CONNECTION_STATS,this.onConnectionStats),this.stats.reports.on(O.I.BYTE_SENT_STATS,this.onByteSentStats),this.stats.reports.on(O.I.SUMMARY_STATS,this.onSummaryStats),this.stats.reports.on(O.I.CALL_FEED_REPORT,this.onCallFeedReport)}return this.stats}setGroupCallStatsInterval(e){this.statsCollectIntervalTime=e,void 0!==this.stats&&(this.stats.stop(),this.stats.setInterval(e),e>0&&this.stats.start())}}},"./node_modules/matrix-js-sdk/src/webrtc/groupCallEventHandler.ts":(e,t,i)=>{"use strict";i.d(t,{e:()=>u,o:()=>l});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/client.ts"),s=i("./node_modules/matrix-js-sdk/src/webrtc/groupCall.ts"),o=i("./node_modules/matrix-js-sdk/src/models/room-state.ts"),a=i("./node_modules/matrix-js-sdk/src/logger.ts"),c=i("./node_modules/matrix-js-sdk/src/@types/event.ts"),d=i("./node_modules/matrix-js-sdk/src/sync.ts");let l=function(e){return e.Incoming="GroupCall.incoming",e.Outgoing="GroupCall.outgoing",e.Ended="GroupCall.ended",e.Participants="GroupCall.participants",e}({});class u{constructor(e){this.client=e,(0,n.A)(this,"groupCalls",new Map),(0,n.A)(this,"roomDeferreds",new Map),(0,n.A)(this,"onRoomsChanged",(e=>{this.createGroupCallForRoom(e)})),(0,n.A)(this,"onRoomStateChanged",((e,t)=>{if(e.getType()===c.Bx.GroupCallPrefix){const i=e.getStateKey(),n=e.getContent(),r=this.groupCalls.get(t.roomId);r||n["m.terminated"]||e.isRedacted()?r&&r.groupCallId===i?n["m.terminated"]||e.isRedacted()?r.terminate(!1):n["m.type"]!==r.type&&a.v.warn(`GroupCallEventHandler onRoomStateChanged() currently does not support changing type (roomId=${t.roomId})`):r&&r.groupCallId!==i&&a.v.warn(`GroupCallEventHandler onRoomStateChanged() currently does not support multiple calls (roomId=${t.roomId})`):this.createGroupCallFromRoomStateEvent(e)}}))}async start(){this.client.getSyncState()!==d.Lm.Syncing&&(a.v.debug("GroupCallEventHandler start() waiting for client to start syncing"),await new Promise((e=>{const t=()=>{if(this.client.getSyncState()===d.Lm.Syncing)return this.client.off(r.AU.Sync,t),e()};this.client.on(r.AU.Sync,t)})));const e=this.client.getRooms();for(const t of e)this.createGroupCallForRoom(t);this.client.on(r.AU.Room,this.onRoomsChanged),this.client.on(o.f.Events,this.onRoomStateChanged)}stop(){this.client.removeListener(r.AU.Room,this.onRoomsChanged),this.client.removeListener(o.f.Events,this.onRoomStateChanged)}getRoomDeferred(e){let t=this.roomDeferreds.get(e);if(void 0===t){let i;t={prom:new Promise((e=>{i=e}))},t.resolve=i,this.roomDeferreds.set(e,t)}return t}waitUntilRoomReadyForGroupCalls(e){return this.getRoomDeferred(e).prom}getGroupCallById(e){return[...this.groupCalls.values()].find((t=>t.groupCallId===e))}createGroupCallForRoom(e){const t=e.currentState.getStateEvents(c.Bx.GroupCallPrefix),i=t.sort(((e,t)=>t.getTs()-e.getTs()));for(const n of i){if(!n.getContent()["m.terminated"]&&!n.isRedacted()){a.v.debug(`GroupCallEventHandler createGroupCallForRoom() choosing group call from possible calls (stateKey=${n.getStateKey()}, ts=${n.getTs()}, roomId=${e.roomId}, numOfPossibleCalls=${t.length})`),this.createGroupCallFromRoomStateEvent(n);break}}this.getRoomDeferred(e.roomId).resolve()}createGroupCallFromRoomStateEvent(e){const t=e.getRoomId(),i=e.getContent(),n=this.client.getRoom(t);if(!n)return void a.v.warn(`GroupCallEventHandler createGroupCallFromRoomStateEvent() couldn't find room for call (roomId=${t})`);const r=e.getStateKey(),o=i["m.type"];if(!Object.values(s.Ad).includes(o))return void a.v.warn(`GroupCallEventHandler createGroupCallFromRoomStateEvent() received invalid call type (type=${o}, roomId=${t})`);const c=i["m.intent"];if(!Object.values(s.MC).includes(c))return void a.v.warn(`Received invalid group call intent (type=${o}, roomId=${t})`);const d=Boolean(i["io.element.ptt"]);let u;if(null!=i&&i.dataChannelsEnabled&&null!=i&&i.dataChannelOptions){const{ordered:e,maxPacketLifeTime:t,maxRetransmits:n,protocol:r}=i.dataChannelOptions;u={ordered:e,maxPacketLifeTime:t,maxRetransmits:n,protocol:r}}const h=new s.eO(this.client,n,o,d,c,r,(null==i?void 0:i.dataChannelsEnabled)||this.client.isVoipWithNoMediaAllowed,u,this.client.isVoipWithNoMediaAllowed,this.client.useLivekitForGroupCalls,i["io.element.livekit_service_url"]);return this.groupCalls.set(n.roomId,h),this.client.emit(l.Incoming,h),h}}},"./node_modules/matrix-js-sdk/src/webrtc/mediaHandler.ts":(e,t,i)=>{"use strict";i.d(t,{L:()=>c});var n=i("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=i("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),s=i("./node_modules/matrix-js-sdk/src/webrtc/groupCall.ts"),o=i("./node_modules/matrix-js-sdk/src/logger.ts");let a=function(e){return e.LocalStreamsChanged="local_streams_changed",e}({});class c extends r.X{constructor(e){super(),this.client=e,(0,n.A)(this,"audioInput",void 0),(0,n.A)(this,"audioSettings",void 0),(0,n.A)(this,"videoInput",void 0),(0,n.A)(this,"localUserMediaStream",void 0),(0,n.A)(this,"userMediaStreams",[]),(0,n.A)(this,"screensharingStreams",[]),(0,n.A)(this,"getMediaStreamPromise",void 0)}restoreMediaSettings(e,t){this.audioInput=e,this.videoInput=t}async setAudioInput(e){o.v.info(`MediaHandler setAudioInput() running (deviceId=${e})`),this.audioInput!==e&&(this.audioInput=e,await this.updateLocalUsermediaStreams())}async setAudioSettings(e){o.v.info(`MediaHandler setAudioSettings() running (opts=${JSON.stringify(e)})`),this.audioSettings=Object.assign({},e),await this.updateLocalUsermediaStreams()}async setVideoInput(e){o.v.info(`MediaHandler setVideoInput() running (deviceId=${e})`),this.videoInput!==e&&(this.videoInput=e,await this.updateLocalUsermediaStreams())}async setMediaInputs(e,t){o.v.log(`MediaHandler setMediaInputs() running (audioInput: ${e} videoInput: ${t})`),this.audioInput=e,this.videoInput=t,await this.updateLocalUsermediaStreams()}async updateLocalUsermediaStreams(){if(0===this.userMediaStreams.length)return;const e=new Map;for(const t of this.client.callEventHandler.calls.values())e.set(t.callId,{audio:t.hasLocalUserMediaAudioTrack,video:t.hasLocalUserMediaVideoTrack});for(const e of this.userMediaStreams){o.v.log(`MediaHandler updateLocalUsermediaStreams() stopping all tracks (streamId=${e.id})`);for(const t of e.getTracks())t.stop()}this.userMediaStreams=[],this.localUserMediaStream=void 0;for(const t of this.client.callEventHandler.calls.values()){if(t.callHasEnded()||!e.has(t.callId))continue;const{audio:i,video:n}=e.get(t.callId);o.v.log(`MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (callId=${t.callId})`);const r=await this.getUserMediaStream(i,n);t.callHasEnded()||await t.updateLocalUsermediaStream(r)}for(const e of this.client.groupCallEventHandler.groupCalls.values()){if(!e.localCallFeed)continue;o.v.log(`MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (groupCallId=${e.groupCallId})`);const t=await this.getUserMediaStream(!0,e.type===s.Ad.Video);e.state!==s.F_.Ended&&await e.updateLocalUsermediaStream(t)}this.emit(a.LocalStreamsChanged)}async hasAudioDevice(){try{return(await navigator.mediaDevices.enumerateDevices()).filter((e=>"audioinput"===e.kind)).length>0}catch(e){return o.v.log("MediaHandler hasAudioDevice() calling navigator.mediaDevices.enumerateDevices with error",e),!1}}async hasVideoDevice(){try{return(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind)).length>0}catch(e){return o.v.log("MediaHandler hasVideoDevice() calling navigator.mediaDevices.enumerateDevices with error",e),!1}}async getUserMediaStream(e,t,i=!0){return this.getMediaStreamPromise?this.getMediaStreamPromise=this.getMediaStreamPromise.then((()=>this.getUserMediaStreamInternal(e,t,i))):this.getMediaStreamPromise=this.getUserMediaStreamInternal(e,t,i),this.getMediaStreamPromise}async getUserMediaStreamInternal(e,t,i){const n=e&&await this.hasAudioDevice(),r=t&&await this.hasVideoDevice();let s,c=!0;var d,l,u,h;this.localUserMediaStream?(n!==this.localUserMediaStream.getAudioTracks().length>0&&(c=!1),r!==this.localUserMediaStream.getVideoTracks().length>0&&(c=!1),n&&(null===(d=this.localUserMediaStream.getAudioTracks()[0])||void 0===d||null===(l=d.getSettings())||void 0===l?void 0:l.deviceId)!==this.audioInput&&(c=!1),r&&(null===(u=this.localUserMediaStream.getVideoTracks()[0])||void 0===u||null===(h=u.getSettings())||void 0===h?void 0:h.deviceId)!==this.videoInput&&(c=!1)):c=!1;if(c){var m;if(s=this.localUserMediaStream.clone(),o.v.log(`MediaHandler getUserMediaStreamInternal() cloning (oldStreamId=${null===(m=this.localUserMediaStream)||void 0===m?void 0:m.id} newStreamId=${s.id} shouldRequestAudio=${n} shouldRequestVideo=${r})`),!n)for(const e of s.getAudioTracks())s.removeTrack(e);if(!r)for(const e of s.getVideoTracks())s.removeTrack(e)}else{const e=this.getUserMediaContraints(n,r);s=await navigator.mediaDevices.getUserMedia(e),o.v.log(`MediaHandler getUserMediaStreamInternal() calling getUserMediaStream (streamId=${s.id}, shouldRequestAudio=${n}, shouldRequestVideo=${r}, constraints=${JSON.stringify(e)})`);for(const e of s.getTracks()){const t=e.getSettings();"audio"===e.kind?this.audioInput=t.deviceId:"video"===e.kind&&(this.videoInput=t.deviceId)}i&&(this.localUserMediaStream=s)}return i&&this.userMediaStreams.push(s),this.emit(a.LocalStreamsChanged),s}stopUserMediaStream(e){o.v.log(`MediaHandler stopUserMediaStream() stopping (streamId=${e.id})`);for(const t of e.getTracks())t.stop();const t=this.userMediaStreams.indexOf(e);if(-1!==t&&(o.v.debug(`MediaHandler stopUserMediaStream() splicing usermedia stream out stream array (streamId=${e.id})`,e.id),this.userMediaStreams.splice(t,1)),this.emit(a.LocalStreamsChanged),this.localUserMediaStream===e)this.localUserMediaStream=void 0;else for(const t of e.getTracks()){var i;if(null!==(i=this.localUserMediaStream)&&void 0!==i&&i.getTrackById(t.id)){this.stopUserMediaStream(this.localUserMediaStream);break}}}async getScreensharingStream(e={},t=!0){let i;if(0===this.screensharingStreams.length){const t=this.getScreenshareContraints(e);e.desktopCapturerSourceId?(o.v.debug(`MediaHandler getScreensharingStream() calling getUserMedia() (opts=${JSON.stringify(e)})`),i=await navigator.mediaDevices.getUserMedia(t)):(o.v.debug(`MediaHandler getScreensharingStream() calling getDisplayMedia() (opts=${JSON.stringify(e)})`),i=await navigator.mediaDevices.getDisplayMedia(t))}else{const e=this.screensharingStreams[this.screensharingStreams.length-1];o.v.log(`MediaHandler getScreensharingStream() cloning (streamId=${e.id})`),i=e.clone()}return t&&this.screensharingStreams.push(i),this.emit(a.LocalStreamsChanged),i}stopScreensharingStream(e){o.v.debug(`MediaHandler stopScreensharingStream() stopping stream (streamId=${e.id})`);for(const t of e.getTracks())t.stop();const t=this.screensharingStreams.indexOf(e);-1!==t&&(o.v.debug(`MediaHandler stopScreensharingStream() splicing stream out (streamId=${e.id})`),this.screensharingStreams.splice(t,1)),this.emit(a.LocalStreamsChanged)}stopAllStreams(){for(const e of this.userMediaStreams){o.v.log(`MediaHandler stopAllStreams() stopping (streamId=${e.id})`);for(const t of e.getTracks())t.stop()}for(const e of this.screensharingStreams)for(const t of e.getTracks())t.stop();this.userMediaStreams=[],this.screensharingStreams=[],this.localUserMediaStream=void 0,this.emit(a.LocalStreamsChanged)}getUserMediaContraints(e,t){const i=!!navigator.webkitGetUserMedia;return{audio:!!e&&{deviceId:this.audioInput?{ideal:this.audioInput}:void 0,autoGainControl:this.audioSettings?{ideal:this.audioSettings.autoGainControl}:void 0,echoCancellation:this.audioSettings?{ideal:this.audioSettings.echoCancellation}:void 0,noiseSuppression:this.audioSettings?{ideal:this.audioSettings.noiseSuppression}:void 0},video:!!t&&{deviceId:this.videoInput?{ideal:this.videoInput}:void 0,width:i?{exact:640}:{ideal:640},height:i?{exact:360}:{ideal:360}}}}getScreenshareContraints(e){const{desktopCapturerSourceId:t,audio:i}=e;return t?{audio:null!=i&&i,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t}}}:{audio:null!=i&&i,video:!0}}}},"./node_modules/matrix-js-sdk/src/webrtc/stats/statsReport.ts":(e,t,i)=>{"use strict";i.d(t,{I:()=>n});let n=function(e){return e.CONNECTION_STATS="StatsReport.connection_stats",e.CALL_FEED_REPORT="StatsReport.call_feed_report",e.BYTE_SENT_STATS="StatsReport.byte_sent_stats",e.SUMMARY_STATS="StatsReport.summary_stats",e}({})},"./src/serviceworker/index.ts":(e,t,i)=>{"use strict";function n(){try{var e;return null!==(e=self)&&void 0!==e&&e.indexedDB?self.indexedDB:window.indexedDB}catch(e){}}let r=null;async function s(){if(!n())throw new Error("IndexedDB not available");r=await new Promise(((e,t)=>{const i=n().open("matrix-react-sdk",1);i.onerror=t,i.onsuccess=()=>{e(i.result)},i.onupgradeneeded=()=>{const e=i.result;e.createObjectStore("pickleKey"),e.createObjectStore("account")}}))}async function o(e,t){return r||await s(),new Promise(((i,n)=>{const s=r.transaction([e],"readonly");s.onerror=n;const o=s.objectStore(e).get(t);o.onerror=n,o.onsuccess=e=>{i(o.result)}}))}var a=i("./node_modules/matrix-js-sdk/src/crypto/aes.ts"),c=i("./node_modules/matrix-js-sdk/src/logger.ts");const d="access_token";async function l(e){const t=new Uint8Array(e.length);for(let i=0;i<e.length;i++)t[i]=e.charCodeAt(i);const i=await crypto.subtle.importKey("raw",t,"HKDF",!1,["deriveBits"]);return t.fill(0),new Uint8Array(await crypto.subtle.deriveBits({name:"HKDF",hash:"SHA-256",salt:new Uint8Array(32),info:new Uint8Array(0)},i,256))}const u=e=>!!e&&"string"!=typeof e;var h=i("./node_modules/matrix-js-sdk/src/matrix.ts");async function m(e,t,i){var n;if(null!==(n=crypto)&&void 0!==n&&n.subtle&&e&&e.encrypted&&e.iv&&e.cryptoKey)try{const n=function(e,t){const i=new Uint8Array(e.length+t.length+1);for(let t=0;t<e.length;t++)i[t]=e.charCodeAt(t);i[e.length]=124;for(let n=0;n<t.length;n++)i[e.length+1+n]=t.charCodeAt(n);return i}(t,i),r=await crypto.subtle.decrypt({name:"AES-GCM",iv:e.iv,additionalData:n},e.cryptoKey,e.encrypted);if(r)return(0,h.encodeUnpaddedBase64)(r)}catch(e){c.v.error("Error decrypting pickle key")}}const p={};function g(e){if(e)return{headers:{Authorization:`Bearer ${e}`}}}self.addEventListener("install",(e=>{e.waitUntil(skipWaiting())})),self.addEventListener("activate",(e=>{e.waitUntil(clients.claim())})),self.addEventListener("fetch",(e=>{if("GET"!==e.request.method)return;let t=e.request.url;(t.includes("/_matrix/media/v3/download")||t.includes("/_matrix/media/v3/thumbnail"))&&e.respondWith((async()=>{let i;try{const n=t.substring(0,t.indexOf("/_matrix/media/v3"));await new Promise((e=>setTimeout((()=>e()),10*Math.random())));const r=await self.clients.get(e.clientId);i=await async function(e){const t=await o("account","mx_access_token"),{userId:i,deviceId:n}=await async function(e){return new Promise(((t,i)=>{const n=setTimeout((()=>i(new Error("timeout in postMessage"))),1e3),r=Math.random().toString(36),s=e=>{var i;(null===(i=e.data)||void 0===i?void 0:i.responseKey)===r&&(clearTimeout(n),t(e.data),self.removeEventListener("message",s))};self.addEventListener("message",s),e.postMessage({responseKey:r,type:"userinfo"})}))}(e),r=await o("pickleKey",[i,n]);if(r&&(!r.encrypted||!r.iv||!r.cryptoKey))return void console.error("SW: Invalid pickle key loaded - ignoring");try{return async function(e,t,i){if(e&&u(t)){const n=await l(e),r=await(0,a.VK)(t,n,i);return n.fill(0),r}if("string"==typeof t)return t}(await m(r,i,n),t,d)}catch(e){return void console.error("SW: Error decrypting access token.",e)}}(r),await async function(e,t){var i,n;if((null===(i=p[e])||void 0===i?void 0:i.cacheExpiryTimeMs)>(new Date).getTime())return;const r=g(t),s=await(await fetch(`${e}/_matrix/client/versions`,r)).json();p[e]={supportsMSC3916:Boolean(null==s||null===(n=s.unstable_features)||void 0===n?void 0:n["org.matrix.msc3916"]),cacheExpiryTimeMs:(new Date).getTime()+72e5}}(n,i),p[n].supportsMSC3916&&i&&(t=t.replace(/\/media\/v3\/(.*)\//,"/client/unstable/org.matrix.msc3916/media/$1/"))}catch(e){console.error("SW: Error in request rewrite.",e)}return fetch(t,g(i))})())}))},"./node_modules/base-x/src/index.js":e=>{"use strict";e.exports=function(e){if(e.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),i=0;i<t.length;i++)t[i]=255;for(var n=0;n<e.length;n++){var r=e.charAt(n),s=r.charCodeAt(0);if(255!==t[s])throw new TypeError(r+" is ambiguous");t[s]=n}var o=e.length,a=e.charAt(0),c=Math.log(o)/Math.log(256),d=Math.log(256)/Math.log(o);function l(e){if("string"!=typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;for(var i=0,n=0,r=0;e[i]===a;)n++,i++;for(var s=(e.length-i)*c+1>>>0,d=new Uint8Array(s);e[i];){var l=t[e.charCodeAt(i)];if(255===l)return;for(var u=0,h=s-1;(0!==l||u<r)&&-1!==h;h--,u++)l+=o*d[h]>>>0,d[h]=l%256>>>0,l=l/256>>>0;if(0!==l)throw new Error("Non-zero carry");r=u,i++}for(var m=s-r;m!==s&&0===d[m];)m++;for(var p=new Uint8Array(n+(s-m)),g=n;m!==s;)p[g++]=d[m++];return p}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var i=0,n=0,r=0,s=t.length;r!==s&&0===t[r];)r++,i++;for(var c=(s-r)*d+1>>>0,l=new Uint8Array(c);r!==s;){for(var u=t[r],h=0,m=c-1;(0!==u||h<n)&&-1!==m;m--,h++)u+=256*l[m]>>>0,l[m]=u%o>>>0,u=u/o>>>0;if(0!==u)throw new Error("Non-zero carry");n=h,r++}for(var p=c-n;p!==c&&0===l[p];)p++;for(var g=a.repeat(i);p<c;++p)g+=e.charAt(l[p]);return g},decodeUnsafe:l,decode:function(e){var t=l(e);if(t)return t;throw new Error("Non-base"+o+" character")}}}},"./node_modules/base64-js/index.js":(e,t)=>{"use strict";t.byteLength=function(e){var t=a(e),i=t[0],n=t[1];return 3*(i+n)/4-n},t.toByteArray=function(e){var t,i,s=a(e),o=s[0],c=s[1],d=new r(function(e,t,i){return 3*(t+i)/4-i}(0,o,c)),l=0,u=c>0?o-4:o;for(i=0;i<u;i+=4)t=n[e.charCodeAt(i)]<<18|n[e.charCodeAt(i+1)]<<12|n[e.charCodeAt(i+2)]<<6|n[e.charCodeAt(i+3)],d[l++]=t>>16&255,d[l++]=t>>8&255,d[l++]=255&t;2===c&&(t=n[e.charCodeAt(i)]<<2|n[e.charCodeAt(i+1)]>>4,d[l++]=255&t);1===c&&(t=n[e.charCodeAt(i)]<<10|n[e.charCodeAt(i+1)]<<4|n[e.charCodeAt(i+2)]>>2,d[l++]=t>>8&255,d[l++]=255&t);return d},t.fromByteArray=function(e){for(var t,n=e.length,r=n%3,s=[],o=16383,a=0,d=n-r;a<d;a+=o)s.push(c(e,a,a+o>d?d:a+o));1===r?(t=e[n-1],s.push(i[t>>2]+i[t<<4&63]+"==")):2===r&&(t=(e[n-2]<<8)+e[n-1],s.push(i[t>>10]+i[t>>4&63]+i[t<<2&63]+"="));return s.join("")};for(var i=[],n=[],r="undefined"!=typeof Uint8Array?Uint8Array:Array,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=0;o<64;++o)i[o]=s[o],n[s.charCodeAt(o)]=o;function a(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=e.indexOf("=");return-1===i&&(i=t),[i,i===t?0:4-i%4]}function c(e,t,n){for(var r,s,o=[],a=t;a<n;a+=3)r=(e[a]<<16&16711680)+(e[a+1]<<8&65280)+(255&e[a+2]),o.push(i[(s=r)>>18&63]+i[s>>12&63]+i[s>>6&63]+i[63&s]);return o.join("")}n["-".charCodeAt(0)]=62,n["_".charCodeAt(0)]=63},"./node_modules/bs58/index.js":(e,t,i)=>{const n=i("./node_modules/base-x/src/index.js");e.exports=n("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz")},"./node_modules/buffer/index.js":(e,t,i)=>{"use strict";const n=i("./node_modules/base64-js/index.js"),r=i("./node_modules/ieee754/index.js"),s="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;t.hp=c,t.IS=50;const o=2147483647;function a(e){if(e>o)throw new RangeError('The value "'+e+'" is invalid for option "size"');const t=new Uint8Array(e);return Object.setPrototypeOf(t,c.prototype),t}function c(e,t,i){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return u(e)}return d(e,t,i)}function d(e,t,i){if("string"==typeof e)return function(e,t){"string"==typeof t&&""!==t||(t="utf8");if(!c.isEncoding(t))throw new TypeError("Unknown encoding: "+t);const i=0|g(e,t);let n=a(i);const r=n.write(e,t);r!==i&&(n=n.slice(0,r));return n}(e,t);if(ArrayBuffer.isView(e))return function(e){if(z(e,Uint8Array)){const t=new Uint8Array(e);return m(t.buffer,t.byteOffset,t.byteLength)}return h(e)}(e);if(null==e)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(z(e,ArrayBuffer)||e&&z(e.buffer,ArrayBuffer))return m(e,t,i);if("undefined"!=typeof SharedArrayBuffer&&(z(e,SharedArrayBuffer)||e&&z(e.buffer,SharedArrayBuffer)))return m(e,t,i);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');const n=e.valueOf&&e.valueOf();if(null!=n&&n!==e)return c.from(n,t,i);const r=function(e){if(c.isBuffer(e)){const t=0|p(e.length),i=a(t);return 0===i.length||e.copy(i,0,0,t),i}if(void 0!==e.length)return"number"!=typeof e.length||Q(e.length)?a(0):h(e);if("Buffer"===e.type&&Array.isArray(e.data))return h(e.data)}(e);if(r)return r;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return c.from(e[Symbol.toPrimitive]("string"),t,i);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function l(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function u(e){return l(e),a(e<0?0:0|p(e))}function h(e){const t=e.length<0?0:0|p(e.length),i=a(t);for(let n=0;n<t;n+=1)i[n]=255&e[n];return i}function m(e,t,i){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(i||0))throw new RangeError('"length" is outside of buffer bounds');let n;return n=void 0===t&&void 0===i?new Uint8Array(e):void 0===i?new Uint8Array(e,t):new Uint8Array(e,t,i),Object.setPrototypeOf(n,c.prototype),n}function p(e){if(e>=o)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+o.toString(16)+" bytes");return 0|e}function g(e,t){if(c.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||z(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);const i=e.length,n=arguments.length>2&&!0===arguments[2];if(!n&&0===i)return 0;let r=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":return W(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return H(e).length;default:if(r)return n?-1:W(e).length;t=(""+t).toLowerCase(),r=!0}}function v(e,t,i){let n=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),i<=0)return"";if((i>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return O(this,t,i);case"utf8":case"utf-8":return R(this,t,i);case"ascii":return C(this,t,i);case"latin1":case"binary":return A(this,t,i);case"base64":return k(this,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return x(this,t,i);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function f(e,t,i){const n=e[t];e[t]=e[i],e[i]=n}function y(e,t,i,n,r){if(0===e.length)return-1;if("string"==typeof i?(n=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),Q(i=+i)&&(i=r?0:e.length-1),i<0&&(i=e.length+i),i>=e.length){if(r)return-1;i=e.length-1}else if(i<0){if(!r)return-1;i=0}if("string"==typeof t&&(t=c.from(t,n)),c.isBuffer(t))return 0===t.length?-1:b(e,t,i,n,r);if("number"==typeof t)return t&=255,"function"==typeof Uint8Array.prototype.indexOf?r?Uint8Array.prototype.indexOf.call(e,t,i):Uint8Array.prototype.lastIndexOf.call(e,t,i):b(e,[t],i,n,r);throw new TypeError("val must be string, number or Buffer")}function b(e,t,i,n,r){let s,o=1,a=e.length,c=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;o=2,a/=2,c/=2,i/=2}function d(e,t){return 1===o?e[t]:e.readUInt16BE(t*o)}if(r){let n=-1;for(s=i;s<a;s++)if(d(e,s)===d(t,-1===n?0:s-n)){if(-1===n&&(n=s),s-n+1===c)return n*o}else-1!==n&&(s-=s-n),n=-1}else for(i+c>a&&(i=a-c),s=i;s>=0;s--){let i=!0;for(let n=0;n<c;n++)if(d(e,s+n)!==d(t,n)){i=!1;break}if(i)return s}return-1}function S(e,t,i,n){i=Number(i)||0;const r=e.length-i;n?(n=Number(n))>r&&(n=r):n=r;const s=t.length;let o;for(n>s/2&&(n=s/2),o=0;o<n;++o){const n=parseInt(t.substr(2*o,2),16);if(Q(n))return o;e[i+o]=n}return o}function w(e,t,i,n){return J(W(t,e.length-i),e,i,n)}function _(e,t,i,n){return J(function(e){const t=[];for(let i=0;i<e.length;++i)t.push(255&e.charCodeAt(i));return t}(t),e,i,n)}function E(e,t,i,n){return J(H(t),e,i,n)}function I(e,t,i,n){return J(function(e,t){let i,n,r;const s=[];for(let o=0;o<e.length&&!((t-=2)<0);++o)i=e.charCodeAt(o),n=i>>8,r=i%256,s.push(r),s.push(n);return s}(t,e.length-i),e,i,n)}function k(e,t,i){return 0===t&&i===e.length?n.fromByteArray(e):n.fromByteArray(e.slice(t,i))}function R(e,t,i){i=Math.min(e.length,i);const n=[];let r=t;for(;r<i;){const t=e[r];let s=null,o=t>239?4:t>223?3:t>191?2:1;if(r+o<=i){let i,n,a,c;switch(o){case 1:t<128&&(s=t);break;case 2:i=e[r+1],128==(192&i)&&(c=(31&t)<<6|63&i,c>127&&(s=c));break;case 3:i=e[r+1],n=e[r+2],128==(192&i)&&128==(192&n)&&(c=(15&t)<<12|(63&i)<<6|63&n,c>2047&&(c<55296||c>57343)&&(s=c));break;case 4:i=e[r+1],n=e[r+2],a=e[r+3],128==(192&i)&&128==(192&n)&&128==(192&a)&&(c=(15&t)<<18|(63&i)<<12|(63&n)<<6|63&a,c>65535&&c<1114112&&(s=c))}}null===s?(s=65533,o=1):s>65535&&(s-=65536,n.push(s>>>10&1023|55296),s=56320|1023&s),n.push(s),r+=o}return function(e){const t=e.length;if(t<=T)return String.fromCharCode.apply(String,e);let i="",n=0;for(;n<t;)i+=String.fromCharCode.apply(String,e.slice(n,n+=T));return i}(n)}c.TYPED_ARRAY_SUPPORT=function(){try{const e=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(e,t),42===e.foo()}catch(e){return!1}}(),c.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(c.prototype,"parent",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.buffer}}),Object.defineProperty(c.prototype,"offset",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.byteOffset}}),c.poolSize=8192,c.from=function(e,t,i){return d(e,t,i)},Object.setPrototypeOf(c.prototype,Uint8Array.prototype),Object.setPrototypeOf(c,Uint8Array),c.alloc=function(e,t,i){return function(e,t,i){return l(e),e<=0?a(e):void 0!==t?"string"==typeof i?a(e).fill(t,i):a(e).fill(t):a(e)}(e,t,i)},c.allocUnsafe=function(e){return u(e)},c.allocUnsafeSlow=function(e){return u(e)},c.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==c.prototype},c.compare=function(e,t){if(z(e,Uint8Array)&&(e=c.from(e,e.offset,e.byteLength)),z(t,Uint8Array)&&(t=c.from(t,t.offset,t.byteLength)),!c.isBuffer(e)||!c.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;let i=e.length,n=t.length;for(let r=0,s=Math.min(i,n);r<s;++r)if(e[r]!==t[r]){i=e[r],n=t[r];break}return i<n?-1:n<i?1:0},c.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return c.alloc(0);let i;if(void 0===t)for(t=0,i=0;i<e.length;++i)t+=e[i].length;const n=c.allocUnsafe(t);let r=0;for(i=0;i<e.length;++i){let t=e[i];if(z(t,Uint8Array))r+t.length>n.length?(c.isBuffer(t)||(t=c.from(t)),t.copy(n,r)):Uint8Array.prototype.set.call(n,t,r);else{if(!c.isBuffer(t))throw new TypeError('"list" argument must be an Array of Buffers');t.copy(n,r)}r+=t.length}return n},c.byteLength=g,c.prototype._isBuffer=!0,c.prototype.swap16=function(){const e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let t=0;t<e;t+=2)f(this,t,t+1);return this},c.prototype.swap32=function(){const e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let t=0;t<e;t+=4)f(this,t,t+3),f(this,t+1,t+2);return this},c.prototype.swap64=function(){const e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let t=0;t<e;t+=8)f(this,t,t+7),f(this,t+1,t+6),f(this,t+2,t+5),f(this,t+3,t+4);return this},c.prototype.toString=function(){const e=this.length;return 0===e?"":0===arguments.length?R(this,0,e):v.apply(this,arguments)},c.prototype.toLocaleString=c.prototype.toString,c.prototype.equals=function(e){if(!c.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===c.compare(this,e)},c.prototype.inspect=function(){let e="";const i=t.IS;return e=this.toString("hex",0,i).replace(/(.{2})/g,"$1 ").trim(),this.length>i&&(e+=" ... "),"<Buffer "+e+">"},s&&(c.prototype[s]=c.prototype.inspect),c.prototype.compare=function(e,t,i,n,r){if(z(e,Uint8Array)&&(e=c.from(e,e.offset,e.byteLength)),!c.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===i&&(i=e?e.length:0),void 0===n&&(n=0),void 0===r&&(r=this.length),t<0||i>e.length||n<0||r>this.length)throw new RangeError("out of range index");if(n>=r&&t>=i)return 0;if(n>=r)return-1;if(t>=i)return 1;if(this===e)return 0;let s=(r>>>=0)-(n>>>=0),o=(i>>>=0)-(t>>>=0);const a=Math.min(s,o),d=this.slice(n,r),l=e.slice(t,i);for(let e=0;e<a;++e)if(d[e]!==l[e]){s=d[e],o=l[e];break}return s<o?-1:o<s?1:0},c.prototype.includes=function(e,t,i){return-1!==this.indexOf(e,t,i)},c.prototype.indexOf=function(e,t,i){return y(this,e,t,i,!0)},c.prototype.lastIndexOf=function(e,t,i){return y(this,e,t,i,!1)},c.prototype.write=function(e,t,i,n){if(void 0===t)n="utf8",i=this.length,t=0;else if(void 0===i&&"string"==typeof t)n=t,i=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(i)?(i>>>=0,void 0===n&&(n="utf8")):(n=i,i=void 0)}const r=this.length-t;if((void 0===i||i>r)&&(i=r),e.length>0&&(i<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");let s=!1;for(;;)switch(n){case"hex":return S(this,e,t,i);case"utf8":case"utf-8":return w(this,e,t,i);case"ascii":case"latin1":case"binary":return _(this,e,t,i);case"base64":return E(this,e,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return I(this,e,t,i);default:if(s)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),s=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};const T=4096;function C(e,t,i){let n="";i=Math.min(e.length,i);for(let r=t;r<i;++r)n+=String.fromCharCode(127&e[r]);return n}function A(e,t,i){let n="";i=Math.min(e.length,i);for(let r=t;r<i;++r)n+=String.fromCharCode(e[r]);return n}function O(e,t,i){const n=e.length;(!t||t<0)&&(t=0),(!i||i<0||i>n)&&(i=n);let r="";for(let n=t;n<i;++n)r+=Y[e[n]];return r}function x(e,t,i){const n=e.slice(t,i);let r="";for(let e=0;e<n.length-1;e+=2)r+=String.fromCharCode(n[e]+256*n[e+1]);return r}function M(e,t,i){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>i)throw new RangeError("Trying to access beyond buffer length")}function P(e,t,i,n,r,s){if(!c.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>r||t<s)throw new RangeError('"value" argument is out of bounds');if(i+n>e.length)throw new RangeError("Index out of range")}function j(e,t,i,n,r){$(t,n,r,e,i,7);let s=Number(t&BigInt(4294967295));e[i++]=s,s>>=8,e[i++]=s,s>>=8,e[i++]=s,s>>=8,e[i++]=s;let o=Number(t>>BigInt(32)&BigInt(4294967295));return e[i++]=o,o>>=8,e[i++]=o,o>>=8,e[i++]=o,o>>=8,e[i++]=o,i}function D(e,t,i,n,r){$(t,n,r,e,i,7);let s=Number(t&BigInt(4294967295));e[i+7]=s,s>>=8,e[i+6]=s,s>>=8,e[i+5]=s,s>>=8,e[i+4]=s;let o=Number(t>>BigInt(32)&BigInt(4294967295));return e[i+3]=o,o>>=8,e[i+2]=o,o>>=8,e[i+1]=o,o>>=8,e[i]=o,i+8}function U(e,t,i,n,r,s){if(i+n>e.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function L(e,t,i,n,s){return t=+t,i>>>=0,s||U(e,0,i,4),r.write(e,t,i,n,23,4),i+4}function N(e,t,i,n,s){return t=+t,i>>>=0,s||U(e,0,i,8),r.write(e,t,i,n,52,8),i+8}c.prototype.slice=function(e,t){const i=this.length;(e=~~e)<0?(e+=i)<0&&(e=0):e>i&&(e=i),(t=void 0===t?i:~~t)<0?(t+=i)<0&&(t=0):t>i&&(t=i),t<e&&(t=e);const n=this.subarray(e,t);return Object.setPrototypeOf(n,c.prototype),n},c.prototype.readUintLE=c.prototype.readUIntLE=function(e,t,i){e>>>=0,t>>>=0,i||M(e,t,this.length);let n=this[e],r=1,s=0;for(;++s<t&&(r*=256);)n+=this[e+s]*r;return n},c.prototype.readUintBE=c.prototype.readUIntBE=function(e,t,i){e>>>=0,t>>>=0,i||M(e,t,this.length);let n=this[e+--t],r=1;for(;t>0&&(r*=256);)n+=this[e+--t]*r;return n},c.prototype.readUint8=c.prototype.readUInt8=function(e,t){return e>>>=0,t||M(e,1,this.length),this[e]},c.prototype.readUint16LE=c.prototype.readUInt16LE=function(e,t){return e>>>=0,t||M(e,2,this.length),this[e]|this[e+1]<<8},c.prototype.readUint16BE=c.prototype.readUInt16BE=function(e,t){return e>>>=0,t||M(e,2,this.length),this[e]<<8|this[e+1]},c.prototype.readUint32LE=c.prototype.readUInt32LE=function(e,t){return e>>>=0,t||M(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},c.prototype.readUint32BE=c.prototype.readUInt32BE=function(e,t){return e>>>=0,t||M(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},c.prototype.readBigUInt64LE=X((function(e){q(e>>>=0,"offset");const t=this[e],i=this[e+7];void 0!==t&&void 0!==i||V(e,this.length-8);const n=t+256*this[++e]+65536*this[++e]+this[++e]*2**24,r=this[++e]+256*this[++e]+65536*this[++e]+i*2**24;return BigInt(n)+(BigInt(r)<<BigInt(32))})),c.prototype.readBigUInt64BE=X((function(e){q(e>>>=0,"offset");const t=this[e],i=this[e+7];void 0!==t&&void 0!==i||V(e,this.length-8);const n=t*2**24+65536*this[++e]+256*this[++e]+this[++e],r=this[++e]*2**24+65536*this[++e]+256*this[++e]+i;return(BigInt(n)<<BigInt(32))+BigInt(r)})),c.prototype.readIntLE=function(e,t,i){e>>>=0,t>>>=0,i||M(e,t,this.length);let n=this[e],r=1,s=0;for(;++s<t&&(r*=256);)n+=this[e+s]*r;return r*=128,n>=r&&(n-=Math.pow(2,8*t)),n},c.prototype.readIntBE=function(e,t,i){e>>>=0,t>>>=0,i||M(e,t,this.length);let n=t,r=1,s=this[e+--n];for(;n>0&&(r*=256);)s+=this[e+--n]*r;return r*=128,s>=r&&(s-=Math.pow(2,8*t)),s},c.prototype.readInt8=function(e,t){return e>>>=0,t||M(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},c.prototype.readInt16LE=function(e,t){e>>>=0,t||M(e,2,this.length);const i=this[e]|this[e+1]<<8;return 32768&i?4294901760|i:i},c.prototype.readInt16BE=function(e,t){e>>>=0,t||M(e,2,this.length);const i=this[e+1]|this[e]<<8;return 32768&i?4294901760|i:i},c.prototype.readInt32LE=function(e,t){return e>>>=0,t||M(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},c.prototype.readInt32BE=function(e,t){return e>>>=0,t||M(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},c.prototype.readBigInt64LE=X((function(e){q(e>>>=0,"offset");const t=this[e],i=this[e+7];void 0!==t&&void 0!==i||V(e,this.length-8);const n=this[e+4]+256*this[e+5]+65536*this[e+6]+(i<<24);return(BigInt(n)<<BigInt(32))+BigInt(t+256*this[++e]+65536*this[++e]+this[++e]*2**24)})),c.prototype.readBigInt64BE=X((function(e){q(e>>>=0,"offset");const t=this[e],i=this[e+7];void 0!==t&&void 0!==i||V(e,this.length-8);const n=(t<<24)+65536*this[++e]+256*this[++e]+this[++e];return(BigInt(n)<<BigInt(32))+BigInt(this[++e]*2**24+65536*this[++e]+256*this[++e]+i)})),c.prototype.readFloatLE=function(e,t){return e>>>=0,t||M(e,4,this.length),r.read(this,e,!0,23,4)},c.prototype.readFloatBE=function(e,t){return e>>>=0,t||M(e,4,this.length),r.read(this,e,!1,23,4)},c.prototype.readDoubleLE=function(e,t){return e>>>=0,t||M(e,8,this.length),r.read(this,e,!0,52,8)},c.prototype.readDoubleBE=function(e,t){return e>>>=0,t||M(e,8,this.length),r.read(this,e,!1,52,8)},c.prototype.writeUintLE=c.prototype.writeUIntLE=function(e,t,i,n){if(e=+e,t>>>=0,i>>>=0,!n){P(this,e,t,i,Math.pow(2,8*i)-1,0)}let r=1,s=0;for(this[t]=255&e;++s<i&&(r*=256);)this[t+s]=e/r&255;return t+i},c.prototype.writeUintBE=c.prototype.writeUIntBE=function(e,t,i,n){if(e=+e,t>>>=0,i>>>=0,!n){P(this,e,t,i,Math.pow(2,8*i)-1,0)}let r=i-1,s=1;for(this[t+r]=255&e;--r>=0&&(s*=256);)this[t+r]=e/s&255;return t+i},c.prototype.writeUint8=c.prototype.writeUInt8=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,1,255,0),this[t]=255&e,t+1},c.prototype.writeUint16LE=c.prototype.writeUInt16LE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},c.prototype.writeUint16BE=c.prototype.writeUInt16BE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},c.prototype.writeUint32LE=c.prototype.writeUInt32LE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},c.prototype.writeUint32BE=c.prototype.writeUInt32BE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},c.prototype.writeBigUInt64LE=X((function(e,t=0){return j(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))})),c.prototype.writeBigUInt64BE=X((function(e,t=0){return D(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))})),c.prototype.writeIntLE=function(e,t,i,n){if(e=+e,t>>>=0,!n){const n=Math.pow(2,8*i-1);P(this,e,t,i,n-1,-n)}let r=0,s=1,o=0;for(this[t]=255&e;++r<i&&(s*=256);)e<0&&0===o&&0!==this[t+r-1]&&(o=1),this[t+r]=(e/s|0)-o&255;return t+i},c.prototype.writeIntBE=function(e,t,i,n){if(e=+e,t>>>=0,!n){const n=Math.pow(2,8*i-1);P(this,e,t,i,n-1,-n)}let r=i-1,s=1,o=0;for(this[t+r]=255&e;--r>=0&&(s*=256);)e<0&&0===o&&0!==this[t+r+1]&&(o=1),this[t+r]=(e/s|0)-o&255;return t+i},c.prototype.writeInt8=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},c.prototype.writeInt16LE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},c.prototype.writeInt16BE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},c.prototype.writeInt32LE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},c.prototype.writeInt32BE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},c.prototype.writeBigInt64LE=X((function(e,t=0){return j(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),c.prototype.writeBigInt64BE=X((function(e,t=0){return D(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),c.prototype.writeFloatLE=function(e,t,i){return L(this,e,t,!0,i)},c.prototype.writeFloatBE=function(e,t,i){return L(this,e,t,!1,i)},c.prototype.writeDoubleLE=function(e,t,i){return N(this,e,t,!0,i)},c.prototype.writeDoubleBE=function(e,t,i){return N(this,e,t,!1,i)},c.prototype.copy=function(e,t,i,n){if(!c.isBuffer(e))throw new TypeError("argument should be a Buffer");if(i||(i=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<i&&(n=i),n===i)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-i&&(n=e.length-t+i);const r=n-i;return this===e&&"function"==typeof Uint8Array.prototype.copyWithin?this.copyWithin(t,i,n):Uint8Array.prototype.set.call(e,this.subarray(i,n),t),r},c.prototype.fill=function(e,t,i,n){if("string"==typeof e){if("string"==typeof t?(n=t,t=0,i=this.length):"string"==typeof i&&(n=i,i=this.length),void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!c.isEncoding(n))throw new TypeError("Unknown encoding: "+n);if(1===e.length){const t=e.charCodeAt(0);("utf8"===n&&t<128||"latin1"===n)&&(e=t)}}else"number"==typeof e?e&=255:"boolean"==typeof e&&(e=Number(e));if(t<0||this.length<t||this.length<i)throw new RangeError("Out of range index");if(i<=t)return this;let r;if(t>>>=0,i=void 0===i?this.length:i>>>0,e||(e=0),"number"==typeof e)for(r=t;r<i;++r)this[r]=e;else{const s=c.isBuffer(e)?e:c.from(e,n),o=s.length;if(0===o)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(r=0;r<i-t;++r)this[r+t]=s[r%o]}return this};const B={};function F(e,t,i){B[e]=class extends i{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${e}]`,this.stack,delete this.name}get code(){return e}set code(e){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:e,writable:!0})}toString(){return`${this.name} [${e}]: ${this.message}`}}}function K(e){let t="",i=e.length;const n="-"===e[0]?1:0;for(;i>=n+4;i-=3)t=`_${e.slice(i-3,i)}${t}`;return`${e.slice(0,i)}${t}`}function $(e,t,i,n,r,s){if(e>i||e<t){const n="bigint"==typeof t?"n":"";let r;throw r=s>3?0===t||t===BigInt(0)?`>= 0${n} and < 2${n} ** ${8*(s+1)}${n}`:`>= -(2${n} ** ${8*(s+1)-1}${n}) and < 2 ** ${8*(s+1)-1}${n}`:`>= ${t}${n} and <= ${i}${n}`,new B.ERR_OUT_OF_RANGE("value",r,e)}!function(e,t,i){q(t,"offset"),void 0!==e[t]&&void 0!==e[t+i]||V(t,e.length-(i+1))}(n,r,s)}function q(e,t){if("number"!=typeof e)throw new B.ERR_INVALID_ARG_TYPE(t,"number",e)}function V(e,t,i){if(Math.floor(e)!==e)throw q(e,i),new B.ERR_OUT_OF_RANGE(i||"offset","an integer",e);if(t<0)throw new B.ERR_BUFFER_OUT_OF_BOUNDS;throw new B.ERR_OUT_OF_RANGE(i||"offset",`>= ${i?1:0} and <= ${t}`,e)}F("ERR_BUFFER_OUT_OF_BOUNDS",(function(e){return e?`${e} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"}),RangeError),F("ERR_INVALID_ARG_TYPE",(function(e,t){return`The "${e}" argument must be of type number. Received type ${typeof t}`}),TypeError),F("ERR_OUT_OF_RANGE",(function(e,t,i){let n=`The value of "${e}" is out of range.`,r=i;return Number.isInteger(i)&&Math.abs(i)>2**32?r=K(String(i)):"bigint"==typeof i&&(r=String(i),(i>BigInt(2)**BigInt(32)||i<-(BigInt(2)**BigInt(32)))&&(r=K(r)),r+="n"),n+=` It must be ${t}. Received ${r}`,n}),RangeError);const G=/[^+/0-9A-Za-z-_]/g;function W(e,t){let i;t=t||1/0;const n=e.length;let r=null;const s=[];for(let o=0;o<n;++o){if(i=e.charCodeAt(o),i>55295&&i<57344){if(!r){if(i>56319){(t-=3)>-1&&s.push(239,191,189);continue}if(o+1===n){(t-=3)>-1&&s.push(239,191,189);continue}r=i;continue}if(i<56320){(t-=3)>-1&&s.push(239,191,189),r=i;continue}i=65536+(r-55296<<10|i-56320)}else r&&(t-=3)>-1&&s.push(239,191,189);if(r=null,i<128){if((t-=1)<0)break;s.push(i)}else if(i<2048){if((t-=2)<0)break;s.push(i>>6|192,63&i|128)}else if(i<65536){if((t-=3)<0)break;s.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;s.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return s}function H(e){return n.toByteArray(function(e){if((e=(e=e.split("=")[0]).trim().replace(G,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function J(e,t,i,n){let r;for(r=0;r<n&&!(r+i>=t.length||r>=e.length);++r)t[r+i]=e[r];return r}function z(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function Q(e){return e!=e}const Y=function(){const e="0123456789abcdef",t=new Array(256);for(let i=0;i<16;++i){const n=16*i;for(let r=0;r<16;++r)t[n+r]=e[i]+e[r]}return t}();function X(e){return"undefined"==typeof BigInt?Z:e}function Z(){throw new Error("BigInt not supported")}},"./node_modules/call-bind/callBound.js":(e,t,i)=>{"use strict";var n=i("./node_modules/get-intrinsic/index.js"),r=i("./node_modules/call-bind/index.js"),s=r(n("String.prototype.indexOf"));e.exports=function(e,t){var i=n(e,!!t);return"function"==typeof i&&s(e,".prototype.")>-1?r(i):i}},"./node_modules/call-bind/index.js":(e,t,i)=>{"use strict";var n=i("./node_modules/function-bind/index.js"),r=i("./node_modules/get-intrinsic/index.js"),s=i("./node_modules/set-function-length/index.js"),o=i("./node_modules/es-errors/type.js"),a=r("%Function.prototype.apply%"),c=r("%Function.prototype.call%"),d=r("%Reflect.apply%",!0)||n.call(c,a),l=i("./node_modules/es-define-property/index.js"),u=r("%Math.max%");e.exports=function(e){if("function"!=typeof e)throw new o("a function is required");var t=d(n,c,arguments);return s(t,1+u(0,e.length-(arguments.length-1)),!0)};var h=function(){return d(n,a,arguments)};l?l(e.exports,"apply",{value:h}):e.exports.apply=h},"./node_modules/content-type/index.js":(e,t)=>{"use strict";var i=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,n=/^[\u000b\u0020-\u007e\u0080-\u00ff]+$/,r=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,s=/\\([\u000b\u0020-\u00ff])/g,o=/([\\"])/g,a=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;function c(e){var t=String(e);if(r.test(t))return t;if(t.length>0&&!n.test(t))throw new TypeError("invalid parameter value");return'"'+t.replace(o,"\\$1")+'"'}function d(e){this.parameters=Object.create(null),this.type=e}t.q=function(e){if(!e)throw new TypeError("argument string is required");var t="object"==typeof e?function(e){var t;"function"==typeof e.getHeader?t=e.getHeader("content-type"):"object"==typeof e.headers&&(t=e.headers&&e.headers["content-type"]);if("string"!=typeof t)throw new TypeError("content-type header is missing from object");return t}(e):e;if("string"!=typeof t)throw new TypeError("argument string is required to be a string");var n=t.indexOf(";"),r=-1!==n?t.slice(0,n).trim():t.trim();if(!a.test(r))throw new TypeError("invalid media type");var o=new d(r.toLowerCase());if(-1!==n){var c,l,u;for(i.lastIndex=n;l=i.exec(t);){if(l.index!==n)throw new TypeError("invalid parameter format");n+=l[0].length,c=l[1].toLowerCase(),34===(u=l[2]).charCodeAt(0)&&-1!==(u=u.slice(1,-1)).indexOf("\\")&&(u=u.replace(s,"$1")),o.parameters[c]=u}if(n!==t.length)throw new TypeError("invalid parameter format")}return o}},"./node_modules/define-data-property/index.js":(e,t,i)=>{"use strict";var n=i("./node_modules/es-define-property/index.js"),r=i("./node_modules/es-errors/syntax.js"),s=i("./node_modules/es-errors/type.js"),o=i("./node_modules/gopd/index.js");e.exports=function(e,t,i){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new s("`obj` must be an object or a function`");if("string"!=typeof t&&"symbol"!=typeof t)throw new s("`property` must be a string or a symbol`");if(arguments.length>3&&"boolean"!=typeof arguments[3]&&null!==arguments[3])throw new s("`nonEnumerable`, if provided, must be a boolean or null");if(arguments.length>4&&"boolean"!=typeof arguments[4]&&null!==arguments[4])throw new s("`nonWritable`, if provided, must be a boolean or null");if(arguments.length>5&&"boolean"!=typeof arguments[5]&&null!==arguments[5])throw new s("`nonConfigurable`, if provided, must be a boolean or null");if(arguments.length>6&&"boolean"!=typeof arguments[6])throw new s("`loose`, if provided, must be a boolean");var a=arguments.length>3?arguments[3]:null,c=arguments.length>4?arguments[4]:null,d=arguments.length>5?arguments[5]:null,l=arguments.length>6&&arguments[6],u=!!o&&o(e,t);if(n)n(e,t,{configurable:null===d&&u?u.configurable:!d,enumerable:null===a&&u?u.enumerable:!a,value:i,writable:null===c&&u?u.writable:!c});else{if(!l&&(a||c||d))throw new r("This environment does not support defining a property as non-configurable, non-writable, or non-enumerable.");e[t]=i}}},"./node_modules/es-define-property/index.js":(e,t,i)=>{"use strict";var n=i("./node_modules/get-intrinsic/index.js")("%Object.defineProperty%",!0)||!1;if(n)try{n({},"a",{value:1})}catch(e){n=!1}e.exports=n},"./node_modules/es-errors/eval.js":e=>{"use strict";e.exports=EvalError},"./node_modules/es-errors/index.js":e=>{"use strict";e.exports=Error},"./node_modules/es-errors/range.js":e=>{"use strict";e.exports=RangeError},"./node_modules/es-errors/ref.js":e=>{"use strict";e.exports=ReferenceError},"./node_modules/es-errors/syntax.js":e=>{"use strict";e.exports=SyntaxError},"./node_modules/es-errors/type.js":e=>{"use strict";e.exports=TypeError},"./node_modules/es-errors/uri.js":e=>{"use strict";e.exports=URIError},"./node_modules/events/events.js":e=>{"use strict";var t,i="object"==typeof Reflect?Reflect:null,n=i&&"function"==typeof i.apply?i.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};t=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var r=Number.isNaN||function(e){return e!=e};function s(){s.init.call(this)}e.exports=s,e.exports.once=function(e,t){return new Promise((function(i,n){function r(i){e.removeListener(t,s),n(i)}function s(){"function"==typeof e.removeListener&&e.removeListener("error",r),i([].slice.call(arguments))}g(e,t,s,{once:!0}),"error"!==t&&function(e,t,i){"function"==typeof e.on&&g(e,"error",t,i)}(e,r,{once:!0})}))},s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var o=10;function a(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function c(e){return void 0===e._maxListeners?s.defaultMaxListeners:e._maxListeners}function d(e,t,i,n){var r,s,o,d;if(a(i),void 0===(s=e._events)?(s=e._events=Object.create(null),e._eventsCount=0):(void 0!==s.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),s=e._events),o=s[t]),void 0===o)o=s[t]=i,++e._eventsCount;else if("function"==typeof o?o=s[t]=n?[i,o]:[o,i]:n?o.unshift(i):o.push(i),(r=c(e))>0&&o.length>r&&!o.warned){o.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=o.length,d=l,console&&console.warn&&console.warn(d)}return e}function l(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function u(e,t,i){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:i},r=l.bind(n);return r.listener=i,n.wrapFn=r,r}function h(e,t,i){var n=e._events;if(void 0===n)return[];var r=n[t];return void 0===r?[]:"function"==typeof r?i?[r.listener||r]:[r]:i?function(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}(r):p(r,r.length)}function m(e){var t=this._events;if(void 0!==t){var i=t[e];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function p(e,t){for(var i=new Array(t),n=0;n<t;++n)i[n]=e[n];return i}function g(e,t,i,n){if("function"==typeof e.on)n.once?e.once(t,i):e.on(t,i);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function r(s){n.once&&e.removeEventListener(t,r),i(s)}))}}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(e){if("number"!=typeof e||e<0||r(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");o=e}}),s.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||r(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},s.prototype.getMaxListeners=function(){return c(this)},s.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var r="error"===e,s=this._events;if(void 0!==s)r=r&&void 0===s.error;else if(!r)return!1;if(r){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=s[e];if(void 0===c)return!1;if("function"==typeof c)n(c,this,t);else{var d=c.length,l=p(c,d);for(i=0;i<d;++i)n(l[i],this,t)}return!0},s.prototype.addListener=function(e,t){return d(this,e,t,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(e,t){return d(this,e,t,!0)},s.prototype.once=function(e,t){return a(t),this.on(e,u(this,e,t)),this},s.prototype.prependOnceListener=function(e,t){return a(t),this.prependListener(e,u(this,e,t)),this},s.prototype.removeListener=function(e,t){var i,n,r,s,o;if(a(t),void 0===(n=this._events))return this;if(void 0===(i=n[e]))return this;if(i===t||i.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(r=-1,s=i.length-1;s>=0;s--)if(i[s]===t||i[s].listener===t){o=i[s].listener,r=s;break}if(r<0)return this;0===r?i.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(i,r),1===i.length&&(n[e]=i[0]),void 0!==n.removeListener&&this.emit("removeListener",e,o||t)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(e){var t,i,n;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[e]),this;if(0===arguments.length){var r,s=Object.keys(i);for(n=0;n<s.length;++n)"removeListener"!==(r=s[n])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},s.prototype.listeners=function(e){return h(this,e,!0)},s.prototype.rawListeners=function(e){return h(this,e,!1)},s.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):m.call(e,t)},s.prototype.listenerCount=m,s.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}},"./node_modules/for-each/index.js":(e,t,i)=>{"use strict";var n=i("./node_modules/is-callable/index.js"),r=Object.prototype.toString,s=Object.prototype.hasOwnProperty;e.exports=function(e,t,i){if(!n(t))throw new TypeError("iterator must be a function");var o;arguments.length>=3&&(o=i),"[object Array]"===r.call(e)?function(e,t,i){for(var n=0,r=e.length;n<r;n++)s.call(e,n)&&(null==i?t(e[n],n,e):t.call(i,e[n],n,e))}(e,t,o):"string"==typeof e?function(e,t,i){for(var n=0,r=e.length;n<r;n++)null==i?t(e.charAt(n),n,e):t.call(i,e.charAt(n),n,e)}(e,t,o):function(e,t,i){for(var n in e)s.call(e,n)&&(null==i?t(e[n],n,e):t.call(i,e[n],n,e))}(e,t,o)}},"./node_modules/function-bind/implementation.js":e=>{"use strict";var t=Object.prototype.toString,i=Math.max,n=function(e,t){for(var i=[],n=0;n<e.length;n+=1)i[n]=e[n];for(var r=0;r<t.length;r+=1)i[r+e.length]=t[r];return i};e.exports=function(e){var r=this;if("function"!=typeof r||"[object Function]"!==t.apply(r))throw new TypeError("Function.prototype.bind called on incompatible "+r);for(var s,o=function(e,t){for(var i=[],n=t||0,r=0;n<e.length;n+=1,r+=1)i[r]=e[n];return i}(arguments,1),a=i(0,r.length-o.length),c=[],d=0;d<a;d++)c[d]="$"+d;if(s=Function("binder","return function ("+function(e,t){for(var i="",n=0;n<e.length;n+=1)i+=e[n],n+1<e.length&&(i+=t);return i}(c,",")+"){ return binder.apply(this,arguments); }")((function(){if(this instanceof s){var t=r.apply(this,n(o,arguments));return Object(t)===t?t:this}return r.apply(e,n(o,arguments))})),r.prototype){var l=function(){};l.prototype=r.prototype,s.prototype=new l,l.prototype=null}return s}},"./node_modules/function-bind/index.js":(e,t,i)=>{"use strict";var n=i("./node_modules/function-bind/implementation.js");e.exports=Function.prototype.bind||n},"./node_modules/get-intrinsic/index.js":(e,t,i)=>{"use strict";var n,r=i("./node_modules/es-errors/index.js"),s=i("./node_modules/es-errors/eval.js"),o=i("./node_modules/es-errors/range.js"),a=i("./node_modules/es-errors/ref.js"),c=i("./node_modules/es-errors/syntax.js"),d=i("./node_modules/es-errors/type.js"),l=i("./node_modules/es-errors/uri.js"),u=Function,h=function(e){try{return u('"use strict"; return ('+e+").constructor;")()}catch(e){}},m=Object.getOwnPropertyDescriptor;if(m)try{m({},"")}catch(e){m=null}var p=function(){throw new d},g=m?function(){try{return p}catch(e){try{return m(arguments,"callee").get}catch(e){return p}}}():p,v=i("./node_modules/has-symbols/index.js")(),f=i("./node_modules/has-proto/index.js")(),y=Object.getPrototypeOf||(f?function(e){return e.__proto__}:null),b={},S="undefined"!=typeof Uint8Array&&y?y(Uint8Array):n,w={__proto__:null,"%AggregateError%":"undefined"==typeof AggregateError?n:AggregateError,"%Array%":Array,"%ArrayBuffer%":"undefined"==typeof ArrayBuffer?n:ArrayBuffer,"%ArrayIteratorPrototype%":v&&y?y([][Symbol.iterator]()):n,"%AsyncFromSyncIteratorPrototype%":n,"%AsyncFunction%":b,"%AsyncGenerator%":b,"%AsyncGeneratorFunction%":b,"%AsyncIteratorPrototype%":b,"%Atomics%":"undefined"==typeof Atomics?n:Atomics,"%BigInt%":"undefined"==typeof BigInt?n:BigInt,"%BigInt64Array%":"undefined"==typeof BigInt64Array?n:BigInt64Array,"%BigUint64Array%":"undefined"==typeof BigUint64Array?n:BigUint64Array,"%Boolean%":Boolean,"%DataView%":"undefined"==typeof DataView?n:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":r,"%eval%":eval,"%EvalError%":s,"%Float32Array%":"undefined"==typeof Float32Array?n:Float32Array,"%Float64Array%":"undefined"==typeof Float64Array?n:Float64Array,"%FinalizationRegistry%":"undefined"==typeof FinalizationRegistry?n:FinalizationRegistry,"%Function%":u,"%GeneratorFunction%":b,"%Int8Array%":"undefined"==typeof Int8Array?n:Int8Array,"%Int16Array%":"undefined"==typeof Int16Array?n:Int16Array,"%Int32Array%":"undefined"==typeof Int32Array?n:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":v&&y?y(y([][Symbol.iterator]())):n,"%JSON%":"object"==typeof JSON?JSON:n,"%Map%":"undefined"==typeof Map?n:Map,"%MapIteratorPrototype%":"undefined"!=typeof Map&&v&&y?y((new Map)[Symbol.iterator]()):n,"%Math%":Math,"%Number%":Number,"%Object%":Object,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":"undefined"==typeof Promise?n:Promise,"%Proxy%":"undefined"==typeof Proxy?n:Proxy,"%RangeError%":o,"%ReferenceError%":a,"%Reflect%":"undefined"==typeof Reflect?n:Reflect,"%RegExp%":RegExp,"%Set%":"undefined"==typeof Set?n:Set,"%SetIteratorPrototype%":"undefined"!=typeof Set&&v&&y?y((new Set)[Symbol.iterator]()):n,"%SharedArrayBuffer%":"undefined"==typeof SharedArrayBuffer?n:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":v&&y?y(""[Symbol.iterator]()):n,"%Symbol%":v?Symbol:n,"%SyntaxError%":c,"%ThrowTypeError%":g,"%TypedArray%":S,"%TypeError%":d,"%Uint8Array%":"undefined"==typeof Uint8Array?n:Uint8Array,"%Uint8ClampedArray%":"undefined"==typeof Uint8ClampedArray?n:Uint8ClampedArray,"%Uint16Array%":"undefined"==typeof Uint16Array?n:Uint16Array,"%Uint32Array%":"undefined"==typeof Uint32Array?n:Uint32Array,"%URIError%":l,"%WeakMap%":"undefined"==typeof WeakMap?n:WeakMap,"%WeakRef%":"undefined"==typeof WeakRef?n:WeakRef,"%WeakSet%":"undefined"==typeof WeakSet?n:WeakSet};if(y)try{null.error}catch(e){var _=y(y(e));w["%Error.prototype%"]=_}var E=function e(t){var i;if("%AsyncFunction%"===t)i=h("async function () {}");else if("%GeneratorFunction%"===t)i=h("function* () {}");else if("%AsyncGeneratorFunction%"===t)i=h("async function* () {}");else if("%AsyncGenerator%"===t){var n=e("%AsyncGeneratorFunction%");n&&(i=n.prototype)}else if("%AsyncIteratorPrototype%"===t){var r=e("%AsyncGenerator%");r&&y&&(i=y(r.prototype))}return w[t]=i,i},I={__proto__:null,"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},k=i("./node_modules/function-bind/index.js"),R=i("./node_modules/hasown/index.js"),T=k.call(Function.call,Array.prototype.concat),C=k.call(Function.apply,Array.prototype.splice),A=k.call(Function.call,String.prototype.replace),O=k.call(Function.call,String.prototype.slice),x=k.call(Function.call,RegExp.prototype.exec),M=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,P=/\\(\\)?/g,j=function(e,t){var i,n=e;if(R(I,n)&&(n="%"+(i=I[n])[0]+"%"),R(w,n)){var r=w[n];if(r===b&&(r=E(n)),void 0===r&&!t)throw new d("intrinsic "+e+" exists, but is not available. Please file an issue!");return{alias:i,name:n,value:r}}throw new c("intrinsic "+e+" does not exist!")};e.exports=function(e,t){if("string"!=typeof e||0===e.length)throw new d("intrinsic name must be a non-empty string");if(arguments.length>1&&"boolean"!=typeof t)throw new d('"allowMissing" argument must be a boolean');if(null===x(/^%?[^%]*%?$/,e))throw new c("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var i=function(e){var t=O(e,0,1),i=O(e,-1);if("%"===t&&"%"!==i)throw new c("invalid intrinsic syntax, expected closing `%`");if("%"===i&&"%"!==t)throw new c("invalid intrinsic syntax, expected opening `%`");var n=[];return A(e,M,(function(e,t,i,r){n[n.length]=i?A(r,P,"$1"):t||e})),n}(e),n=i.length>0?i[0]:"",r=j("%"+n+"%",t),s=r.name,o=r.value,a=!1,l=r.alias;l&&(n=l[0],C(i,T([0,1],l)));for(var u=1,h=!0;u<i.length;u+=1){var p=i[u],g=O(p,0,1),v=O(p,-1);if(('"'===g||"'"===g||"`"===g||'"'===v||"'"===v||"`"===v)&&g!==v)throw new c("property names with quotes must have matching quotes");if("constructor"!==p&&h||(a=!0),R(w,s="%"+(n+="."+p)+"%"))o=w[s];else if(null!=o){if(!(p in o)){if(!t)throw new d("base intrinsic for "+e+" exists, but the property is not available.");return}if(m&&u+1>=i.length){var f=m(o,p);o=(h=!!f)&&"get"in f&&!("originalValue"in f.get)?f.get:o[p]}else h=R(o,p),o=o[p];h&&!a&&(w[s]=o)}}return o}},"./node_modules/gopd/index.js":(e,t,i)=>{"use strict";var n=i("./node_modules/get-intrinsic/index.js")("%Object.getOwnPropertyDescriptor%",!0);if(n)try{n([],"length")}catch(e){n=null}e.exports=n},"./node_modules/has-property-descriptors/index.js":(e,t,i)=>{"use strict";var n=i("./node_modules/es-define-property/index.js"),r=function(){return!!n};r.hasArrayLengthDefineBug=function(){if(!n)return null;try{return 1!==n([],"length",{value:1}).length}catch(e){return!0}},e.exports=r},"./node_modules/has-proto/index.js":e=>{"use strict";var t={__proto__:null,foo:{}},i=Object;e.exports=function(){return{__proto__:t}.foo===t.foo&&!(t instanceof i)}},"./node_modules/has-symbols/index.js":(e,t,i)=>{"use strict";var n="undefined"!=typeof Symbol&&Symbol,r=i("./node_modules/has-symbols/shams.js");e.exports=function(){return"function"==typeof n&&("function"==typeof Symbol&&("symbol"==typeof n("foo")&&("symbol"==typeof Symbol("bar")&&r())))}},"./node_modules/has-symbols/shams.js":e=>{"use strict";e.exports=function(){if("function"!=typeof Symbol||"function"!=typeof Object.getOwnPropertySymbols)return!1;if("symbol"==typeof Symbol.iterator)return!0;var e={},t=Symbol("test"),i=Object(t);if("string"==typeof t)return!1;if("[object Symbol]"!==Object.prototype.toString.call(t))return!1;if("[object Symbol]"!==Object.prototype.toString.call(i))return!1;for(t in e[t]=42,e)return!1;if("function"==typeof Object.keys&&0!==Object.keys(e).length)return!1;if("function"==typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(e).length)return!1;var n=Object.getOwnPropertySymbols(e);if(1!==n.length||n[0]!==t)return!1;if(!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if("function"==typeof Object.getOwnPropertyDescriptor){var r=Object.getOwnPropertyDescriptor(e,t);if(42!==r.value||!0!==r.enumerable)return!1}return!0}},"./node_modules/has-tostringtag/shams.js":(e,t,i)=>{"use strict";var n=i("./node_modules/has-symbols/shams.js");e.exports=function(){return n()&&!!Symbol.toStringTag}},"./node_modules/hasown/index.js":(e,t,i)=>{"use strict";var n=Function.prototype.call,r=Object.prototype.hasOwnProperty,s=i("./node_modules/function-bind/index.js");e.exports=s.call(n,r)},"./node_modules/ieee754/index.js":(e,t)=>{t.read=function(e,t,i,n,r){var s,o,a=8*r-n-1,c=(1<<a)-1,d=c>>1,l=-7,u=i?r-1:0,h=i?-1:1,m=e[t+u];for(u+=h,s=m&(1<<-l)-1,m>>=-l,l+=a;l>0;s=256*s+e[t+u],u+=h,l-=8);for(o=s&(1<<-l)-1,s>>=-l,l+=n;l>0;o=256*o+e[t+u],u+=h,l-=8);if(0===s)s=1-d;else{if(s===c)return o?NaN:1/0*(m?-1:1);o+=Math.pow(2,n),s-=d}return(m?-1:1)*o*Math.pow(2,s-n)},t.write=function(e,t,i,n,r,s){var o,a,c,d=8*s-r-1,l=(1<<d)-1,u=l>>1,h=23===r?Math.pow(2,-24)-Math.pow(2,-77):0,m=n?0:s-1,p=n?1:-1,g=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,o=l):(o=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-o))<1&&(o--,c*=2),(t+=o+u>=1?h/c:h*Math.pow(2,1-u))*c>=2&&(o++,c/=2),o+u>=l?(a=0,o=l):o+u>=1?(a=(t*c-1)*Math.pow(2,r),o+=u):(a=t*Math.pow(2,u-1)*Math.pow(2,r),o=0));r>=8;e[i+m]=255&a,m+=p,a/=256,r-=8);for(o=o<<r|a,d+=r;d>0;e[i+m]=255&o,m+=p,o/=256,d-=8);e[i+m-p]|=128*g}},"./node_modules/inherits/inherits_browser.js":e=>{"function"==typeof Object.create?e.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:e.exports=function(e,t){if(t){e.super_=t;var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e}}},"./node_modules/is-arguments/index.js":(e,t,i)=>{"use strict";var n=i("./node_modules/has-tostringtag/shams.js")(),r=i("./node_modules/call-bind/callBound.js")("Object.prototype.toString"),s=function(e){return!(n&&e&&"object"==typeof e&&Symbol.toStringTag in e)&&"[object Arguments]"===r(e)},o=function(e){return!!s(e)||null!==e&&"object"==typeof e&&"number"==typeof e.length&&e.length>=0&&"[object Array]"!==r(e)&&"[object Function]"===r(e.callee)},a=function(){return s(arguments)}();s.isLegacyArguments=o,e.exports=a?s:o},"./node_modules/is-callable/index.js":e=>{"use strict";var t,i,n=Function.prototype.toString,r="object"==typeof Reflect&&null!==Reflect&&Reflect.apply;if("function"==typeof r&&"function"==typeof Object.defineProperty)try{t=Object.defineProperty({},"length",{get:function(){throw i}}),i={},r((function(){throw 42}),null,t)}catch(e){e!==i&&(r=null)}else r=null;var s=/^\s*class\b/,o=function(e){try{var t=n.call(e);return s.test(t)}catch(e){return!1}},a=function(e){try{return!o(e)&&(n.call(e),!0)}catch(e){return!1}},c=Object.prototype.toString,d="function"==typeof Symbol&&!!Symbol.toStringTag,l=!(0 in[,]),u=function(){return!1};if("object"==typeof document){var h=document.all;c.call(h)===c.call(document.all)&&(u=function(e){if((l||!e)&&(void 0===e||"object"==typeof e))try{var t=c.call(e);return("[object HTMLAllCollection]"===t||"[object HTML document.all class]"===t||"[object HTMLCollection]"===t||"[object Object]"===t)&&null==e("")}catch(e){}return!1})}e.exports=r?function(e){if(u(e))return!0;if(!e)return!1;if("function"!=typeof e&&"object"!=typeof e)return!1;try{r(e,null,t)}catch(e){if(e!==i)return!1}return!o(e)&&a(e)}:function(e){if(u(e))return!0;if(!e)return!1;if("function"!=typeof e&&"object"!=typeof e)return!1;if(d)return a(e);if(o(e))return!1;var t=c.call(e);return!("[object Function]"!==t&&"[object GeneratorFunction]"!==t&&!/^\[object HTML/.test(t))&&a(e)}},"./node_modules/is-generator-function/index.js":(e,t,i)=>{"use strict";var n,r=Object.prototype.toString,s=Function.prototype.toString,o=/^\s*(?:function)?\*/,a=i("./node_modules/has-tostringtag/shams.js")(),c=Object.getPrototypeOf;e.exports=function(e){if("function"!=typeof e)return!1;if(o.test(s.call(e)))return!0;if(!a)return"[object GeneratorFunction]"===r.call(e);if(!c)return!1;if(void 0===n){var t=function(){if(!a)return!1;try{return Function("return function*() {}")()}catch(e){}}();n=!!t&&c(t)}return c(e)===n}},"./node_modules/loglevel/lib/loglevel.js":function(e,t,i){var n,r;!function(s,o){"use strict";n=function(){var e=function(){},t="undefined",i=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),n=["trace","debug","info","warn","error"],r={},s=null;function o(e,t){var i=e[t];if("function"==typeof i.bind)return i.bind(e);try{return Function.prototype.bind.call(i,e)}catch(t){return function(){return Function.prototype.apply.apply(i,[e,arguments])}}}function a(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function c(n){return"debug"===n&&(n="log"),typeof console!==t&&("trace"===n&&i?a:void 0!==console[n]?o(console,n):void 0!==console.log?o(console,"log"):e)}function d(){for(var i=this.getLevel(),r=0;r<n.length;r++){var s=n[r];this[s]=r<i?e:this.methodFactory(s,i,this.name)}if(this.log=this.debug,typeof console===t&&i<this.levels.SILENT)return"No console available for logging"}function l(e){return function(){typeof console!==t&&(d.call(this),this[e].apply(this,arguments))}}function u(e,t,i){return c(e)||l.apply(this,arguments)}function h(e,i){var o,a,c,l=this,h="loglevel";function m(e){var i=(n[e]||"silent").toUpperCase();if(typeof window!==t&&h){try{return void(window.localStorage[h]=i)}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"="+i+";"}catch(e){}}}function p(){var e;if(typeof window!==t&&h){try{e=window.localStorage[h]}catch(e){}if(typeof e===t)try{var i=window.document.cookie,n=encodeURIComponent(h),r=i.indexOf(n+"=");-1!==r&&(e=/^([^;]+)/.exec(i.slice(r+n.length+1))[1])}catch(e){}return void 0===l.levels[e]&&(e=void 0),e}}function g(){if(typeof window!==t&&h){try{window.localStorage.removeItem(h)}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}function v(e){var t=e;if("string"==typeof t&&void 0!==l.levels[t.toUpperCase()]&&(t=l.levels[t.toUpperCase()]),"number"==typeof t&&t>=0&&t<=l.levels.SILENT)return t;throw new TypeError("log.setLevel() called with invalid level: "+e)}"string"==typeof e?h+=":"+e:"symbol"==typeof e&&(h=void 0),l.name=e,l.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},l.methodFactory=i||u,l.getLevel=function(){return null!=c?c:null!=a?a:o},l.setLevel=function(e,t){return c=v(e),!1!==t&&m(c),d.call(l)},l.setDefaultLevel=function(e){a=v(e),p()||l.setLevel(e,!1)},l.resetLevel=function(){c=null,g(),d.call(l)},l.enableAll=function(e){l.setLevel(l.levels.TRACE,e)},l.disableAll=function(e){l.setLevel(l.levels.SILENT,e)},l.rebuild=function(){if(s!==l&&(o=v(s.getLevel())),d.call(l),s===l)for(var e in r)r[e].rebuild()},o=v(s?s.getLevel():"WARN");var f=p();null!=f&&(c=v(f)),d.call(l)}(s=new h).getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=r[e];return t||(t=r[e]=new h(e,s.methodFactory)),t};var m=typeof window!==t?window.log:void 0;return s.noConflict=function(){return typeof window!==t&&window.log===s&&(window.log=m),s},s.getLoggers=function(){return r},s.default=s,s},void 0===(r="function"==typeof n?n.call(t,i,t,e):n)||(e.exports=r)}()},"./node_modules/matrix-events-sdk/lib/ExtensibleEvents.js":(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExtensibleEvents=void 0;var n=i("./node_modules/matrix-events-sdk/lib/NamespacedMap.js"),r=i("./node_modules/matrix-events-sdk/lib/InvalidEventError.js"),s=i("./node_modules/matrix-events-sdk/lib/interpreters/legacy/MRoomMessage.js"),o=i("./node_modules/matrix-events-sdk/lib/interpreters/modern/MMessage.js"),a=i("./node_modules/matrix-events-sdk/lib/events/message_types.js"),c=i("./node_modules/matrix-events-sdk/lib/events/poll_types.js"),d=i("./node_modules/matrix-events-sdk/lib/interpreters/modern/MPoll.js");function l(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=function(e,t){if(!e)return;if("string"==typeof e)return u(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);"Object"===i&&e.constructor&&(i=e.constructor.name);if("Map"===i||"Set"===i)return Array.from(e);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return u(e,t)}(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var n=0,r=function(){};return{s:r,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,o=!0,a=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return o=e.done,e},e:function(e){a=!0,s=e},f:function(){try{o||null==i.return||i.return()}finally{if(a)throw s}}}}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function h(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function m(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var p=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),m(this,"interpreters",new n.NamespacedMap([[s.LEGACY_M_ROOM_MESSAGE,s.parseMRoomMessage],[a.M_MESSAGE,o.parseMMessage],[a.M_EMOTE,o.parseMMessage],[a.M_NOTICE,o.parseMMessage],[c.M_POLL_START,d.parseMPoll],[c.M_POLL_RESPONSE,d.parseMPoll],[c.M_POLL_END,d.parseMPoll]])),m(this,"_unknownInterpretOrder",[a.M_MESSAGE])}var t,i,u;return t=e,u=[{key:"defaultInstance",get:function(){return e._defaultInstance}},{key:"unknownInterpretOrder",get:function(){return e.defaultInstance.unknownInterpretOrder},set:function(t){e.defaultInstance.unknownInterpretOrder=t}},{key:"registerInterpreter",value:function(t,i){e.defaultInstance.registerInterpreter(t,i)}},{key:"parse",value:function(t){return e.defaultInstance.parse(t)}}],(i=[{key:"unknownInterpretOrder",get:function(){var e;return null!==(e=this._unknownInterpretOrder)&&void 0!==e?e:[]},set:function(e){this._unknownInterpretOrder=e}},{key:"registerInterpreter",value:function(e,t){this.interpreters.set(e,t)}},{key:"parse",value:function(e){try{if(this.interpreters.hasNamespaced(e.type))return this.interpreters.getNamespaced(e.type)(e);var t,i=l(this.unknownInterpretOrder);try{for(i.s();!(t=i.n()).done;){var n=t.value;if(this.interpreters.has(n)){var s=this.interpreters.get(n)(e);if(s)return s}}}catch(e){i.e(e)}finally{i.f()}return null}catch(e){if(e instanceof r.InvalidEventError)return null;throw e}}}])&&h(t.prototype,i),u&&h(t,u),Object.defineProperty(t,"prototype",{writable:!1}),e}();t.ExtensibleEvents=p,m(p,"_defaultInstance",new p)},"./node_modules/matrix-events-sdk/lib/IPartialEvent.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-events-sdk/lib/InvalidEventError.js":(e,t)=>{"use strict";function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function r(e){var t=a();return function(){var n,r=d(e);if(t){var s=d(this).constructor;n=Reflect.construct(r,arguments,s)}else n=r.apply(this,arguments);return function(e,t){if(t&&("object"===i(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,n)}}function s(e){var t="function"==typeof Map?new Map:void 0;return s=function(e){if(null===e||(i=e,-1===Function.toString.call(i).indexOf("[native code]")))return e;var i;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return o(e,arguments,d(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),c(n,e)},s(e)}function o(e,t,i){return o=a()?Reflect.construct:function(e,t,i){var n=[null];n.push.apply(n,t);var r=new(Function.bind.apply(e,n));return i&&c(r,i.prototype),r},o.apply(null,arguments)}function a(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function d(e){return d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},d(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidEventError=void 0;var l=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&c(e,t)}(a,e);var t,i,s,o=r(a);function a(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),o.call(this,e)}return t=a,i&&n(t.prototype,i),s&&n(t,s),Object.defineProperty(t,"prototype",{writable:!1}),t}(s(Error));t.InvalidEventError=l},"./node_modules/matrix-events-sdk/lib/NamespacedMap.js":(e,t)=>{"use strict";function i(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=function(e,t){if(!e)return;if("string"==typeof e)return n(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);"Object"===i&&e.constructor&&(i=e.constructor.name);if("Map"===i||"Set"===i)return Array.from(e);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return n(e,t)}(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var r=0,s=function(){};return{s,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,c=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return a=e.done,e},e:function(e){c=!0,o=e},f:function(){try{a||null==i.return||i.return()}finally{if(c)throw o}}}}function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function r(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}Object.defineProperty(t,"__esModule",{value:!0}),t.NamespacedMap=void 0;var s=function(){function e(t){var n,r,s;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),n=this,r="internalMap",s=new Map,r in n?Object.defineProperty(n,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):n[r]=s,t){var o,a=i(t);try{for(a.s();!(o=a.n()).done;){var c=o.value;this.set(c[0],c[1])}}catch(e){a.e(e)}finally{a.f()}}}var t,n,s;return t=e,(n=[{key:"get",value:function(e){return e.name&&this.internalMap.has(e.name)?this.internalMap.get(e.name):e.altName&&this.internalMap.has(e.altName)?this.internalMap.get(e.altName):null}},{key:"set",value:function(e,t){e.name&&this.internalMap.set(e.name,t),e.altName&&this.internalMap.set(e.altName,t)}},{key:"has",value:function(e){return!!this.get(e)}},{key:"delete",value:function(e){e.name&&this.internalMap.delete(e.name),e.altName&&this.internalMap.delete(e.altName)}},{key:"hasNamespaced",value:function(e){return this.internalMap.has(e)}},{key:"getNamespaced",value:function(e){return this.internalMap.get(e)}}])&&r(t.prototype,n),s&&r(t,s),Object.defineProperty(t,"prototype",{writable:!1}),e}();t.NamespacedMap=s},"./node_modules/matrix-events-sdk/lib/NamespacedValue.js":(e,t)=>{"use strict";function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}function n(e,t){return n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},n(e,t)}function r(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=s(e);if(t){var o=s(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return function(e,t){if(t&&("object"===i(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,n)}}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function c(e,t,i){return t&&a(e.prototype,t),i&&a(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}Object.defineProperty(t,"__esModule",{value:!0}),t.UnstableValue=t.NamespacedValue=void 0;var d=function(){function e(t,i){if(o(this,e),this.stable=t,this.unstable=i,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}return c(e,[{key:"name",get:function(){return this.stable?this.stable:this.unstable}},{key:"altName",get:function(){return this.stable?this.unstable:null}},{key:"matches",value:function(e){return!!this.name&&this.name===e||!!this.altName&&this.altName===e}},{key:"findIn",value:function(e){var t;return this.name&&(t=null==e?void 0:e[this.name]),!t&&this.altName&&(t=null==e?void 0:e[this.altName]),t}},{key:"includedIn",value:function(e){var t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}}]),e}();t.NamespacedValue=d;var l=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&n(e,t)}(i,e);var t=r(i);function i(e,n){var r;if(o(this,i),!(r=t.call(this,e,n)).unstable)throw new Error("Unstable value must be supplied");return r}return c(i,[{key:"name",get:function(){return this.unstable}},{key:"altName",get:function(){return this.stable}}]),i}(d);t.UnstableValue=l},"./node_modules/matrix-events-sdk/lib/events/EmoteEvent.js":(e,t,i)=>{"use strict";function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.EmoteEvent=void 0;var r=i("./node_modules/matrix-events-sdk/lib/events/MessageEvent.js"),s=i("./node_modules/matrix-events-sdk/lib/events/message_types.js"),o=i("./node_modules/matrix-events-sdk/lib/utility/events.js");function a(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function c(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function d(){return d="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=h(e)););return e}(e,t);if(n){var r=Object.getOwnPropertyDescriptor(n,t);return r.get?r.get.call(arguments.length<3?e:i):r.value}},d.apply(this,arguments)}function l(e,t){return l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},l(e,t)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,r=h(e);if(t){var s=h(this).constructor;i=Reflect.construct(r,arguments,s)}else i=r.apply(this,arguments);return function(e,t){if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,i)}}function h(e){return h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},h(e)}var m=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&l(e,t)}(m,e);var t,i,n,r=u(m);function m(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,m),r.call(this,e)}return t=m,n=[{key:"from",value:function(e,t){var i;return new m({type:s.M_EMOTE.name,content:(i={},a(i,s.M_TEXT.name,e),a(i,s.M_HTML.name,t),i)})}}],(i=[{key:"isEmote",get:function(){return!0}},{key:"isEquivalentTo",value:function(e){return(0,o.isEventTypeSame)(e,s.M_EMOTE)||d(h(m.prototype),"isEquivalentTo",this).call(this,e)}},{key:"serialize",value:function(){var e=d(h(m.prototype),"serialize",this).call(this);return e.content.msgtype="m.emote",e}}])&&c(t.prototype,i),n&&c(t,n),Object.defineProperty(t,"prototype",{writable:!1}),m}(r.MessageEvent);t.EmoteEvent=m},"./node_modules/matrix-events-sdk/lib/events/ExtensibleEvent.js":(e,t)=>{"use strict";function i(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}Object.defineProperty(t,"__esModule",{value:!0}),t.ExtensibleEvent=void 0;var n=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.wireFormat=t}var t,n,r;return t=e,(n=[{key:"wireContent",get:function(){return this.wireFormat.content}}])&&i(t.prototype,n),r&&i(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();t.ExtensibleEvent=n},"./node_modules/matrix-events-sdk/lib/events/MessageEvent.js":(e,t,i)=>{"use strict";function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.MessageEvent=void 0;var r=i("./node_modules/matrix-events-sdk/lib/events/ExtensibleEvent.js"),s=i("./node_modules/matrix-events-sdk/lib/types.js"),o=i("./node_modules/matrix-events-sdk/lib/InvalidEventError.js"),a=i("./node_modules/matrix-events-sdk/lib/events/message_types.js"),c=i("./node_modules/matrix-events-sdk/lib/utility/events.js");function d(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function l(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?d(Object(i),!0).forEach((function(t){v(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):d(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function u(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function h(e,t){return h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},h(e,t)}function m(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,r=g(e);if(t){var s=g(this).constructor;i=Reflect.construct(r,arguments,s)}else i=r.apply(this,arguments);return function(e,t){if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return p(e)}(this,i)}}function p(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function g(e){return g=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},g(e)}function v(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var f=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&h(e,t)}(d,e);var t,i,n,r=m(d);function d(e){var t;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,d),v(p(t=r.call(this,e)),"text",void 0),v(p(t),"html",void 0),v(p(t),"renderings",void 0);var i=a.M_MESSAGE.findIn(t.wireContent),n=a.M_TEXT.findIn(t.wireContent),c=a.M_HTML.findIn(t.wireContent);if((0,s.isProvided)(i)){if(!Array.isArray(i))throw new o.InvalidEventError("m.message contents must be an array");var l=i.find((function(e){return!(0,s.isProvided)(e.mimetype)||"text/plain"===e.mimetype})),u=i.find((function(e){return"text/html"===e.mimetype}));if(!l)throw new o.InvalidEventError("m.message is missing a plain text representation");t.text=l.body,t.html=null==u?void 0:u.body,t.renderings=i}else{if(!(0,s.isOptionalAString)(n))throw new o.InvalidEventError("Missing textual representation for event");t.text=n,t.html=c,t.renderings=[{body:n,mimetype:"text/plain"}],t.html&&t.renderings.push({body:t.html,mimetype:"text/html"})}return t}return t=d,n=[{key:"from",value:function(e,t){var i;return new d({type:a.M_MESSAGE.name,content:(i={},v(i,a.M_TEXT.name,e),v(i,a.M_HTML.name,t),i)})}}],(i=[{key:"isEmote",get:function(){return a.M_EMOTE.matches(this.wireFormat.type)||(0,s.isProvided)(a.M_EMOTE.findIn(this.wireFormat.content))}},{key:"isNotice",get:function(){return a.M_NOTICE.matches(this.wireFormat.type)||(0,s.isProvided)(a.M_NOTICE.findIn(this.wireFormat.content))}},{key:"isEquivalentTo",value:function(e){return(0,c.isEventTypeSame)(e,a.M_MESSAGE)}},{key:"serializeMMessageOnly",value:function(){var e=v({},a.M_MESSAGE.name,this.renderings);if(1===this.renderings.length){var t=this.renderings[0].mimetype;void 0!==t&&"text/plain"!==t||(e=v({},a.M_TEXT.name,this.renderings[0].body))}return e}},{key:"serialize",value:function(){var e;return{type:"m.room.message",content:l(l({},this.serializeMMessageOnly()),{},{body:this.text,msgtype:"m.text",format:this.html?"org.matrix.custom.html":void 0,formatted_body:null!==(e=this.html)&&void 0!==e?e:void 0})}}}])&&u(t.prototype,i),n&&u(t,n),Object.defineProperty(t,"prototype",{writable:!1}),d}(r.ExtensibleEvent);t.MessageEvent=f},"./node_modules/matrix-events-sdk/lib/events/NoticeEvent.js":(e,t,i)=>{"use strict";function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.NoticeEvent=void 0;var r=i("./node_modules/matrix-events-sdk/lib/events/MessageEvent.js"),s=i("./node_modules/matrix-events-sdk/lib/events/message_types.js"),o=i("./node_modules/matrix-events-sdk/lib/utility/events.js");function a(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function c(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function d(){return d="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=h(e)););return e}(e,t);if(n){var r=Object.getOwnPropertyDescriptor(n,t);return r.get?r.get.call(arguments.length<3?e:i):r.value}},d.apply(this,arguments)}function l(e,t){return l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},l(e,t)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,r=h(e);if(t){var s=h(this).constructor;i=Reflect.construct(r,arguments,s)}else i=r.apply(this,arguments);return function(e,t){if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,i)}}function h(e){return h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},h(e)}var m=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&l(e,t)}(m,e);var t,i,n,r=u(m);function m(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,m),r.call(this,e)}return t=m,n=[{key:"from",value:function(e,t){var i;return new m({type:s.M_NOTICE.name,content:(i={},a(i,s.M_TEXT.name,e),a(i,s.M_HTML.name,t),i)})}}],(i=[{key:"isNotice",get:function(){return!0}},{key:"isEquivalentTo",value:function(e){return(0,o.isEventTypeSame)(e,s.M_NOTICE)||d(h(m.prototype),"isEquivalentTo",this).call(this,e)}},{key:"serialize",value:function(){var e=d(h(m.prototype),"serialize",this).call(this);return e.content.msgtype="m.notice",e}}])&&c(t.prototype,i),n&&c(t,n),Object.defineProperty(t,"prototype",{writable:!1}),m}(r.MessageEvent);t.NoticeEvent=m},"./node_modules/matrix-events-sdk/lib/events/PollEndEvent.js":(e,t,i)=>{"use strict";function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.PollEndEvent=void 0;var r=i("./node_modules/matrix-events-sdk/lib/events/poll_types.js"),s=i("./node_modules/matrix-events-sdk/lib/InvalidEventError.js"),o=i("./node_modules/matrix-events-sdk/lib/events/relationship_types.js"),a=i("./node_modules/matrix-events-sdk/lib/events/MessageEvent.js"),c=i("./node_modules/matrix-events-sdk/lib/events/message_types.js"),d=i("./node_modules/matrix-events-sdk/lib/utility/events.js");function l(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function u(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?l(Object(i),!0).forEach((function(t){f(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):l(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function h(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function m(e,t){return m=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},m(e,t)}function p(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,r=v(e);if(t){var s=v(this).constructor;i=Reflect.construct(r,arguments,s)}else i=r.apply(this,arguments);return function(e,t){if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return g(e)}(this,i)}}function g(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function v(e){return v=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},v(e)}function f(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var y=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&m(e,t)}(v,e);var t,i,n,l=p(v);function v(e){var t;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,v),f(g(t=l.call(this,e)),"pollEventId",void 0),f(g(t),"closingMessage",void 0);var i=t.wireContent["m.relates_to"];if(!o.REFERENCE_RELATION.matches(null==i?void 0:i.rel_type)||"string"!=typeof(null==i?void 0:i.event_id))throw new s.InvalidEventError("Relationship must be a reference to an event");return t.pollEventId=i.event_id,t.closingMessage=new a.MessageEvent(t.wireFormat),t}return t=v,n=[{key:"from",value:function(e,t){var i;return new v({type:r.M_POLL_END.name,content:(i={"m.relates_to":{rel_type:o.REFERENCE_RELATION.name,event_id:e}},f(i,r.M_POLL_END.name,{}),f(i,c.M_TEXT.name,t),i)})}}],(i=[{key:"isEquivalentTo",value:function(e){return(0,d.isEventTypeSame)(e,r.M_POLL_END)}},{key:"serialize",value:function(){return{type:r.M_POLL_END.name,content:u(f({"m.relates_to":{rel_type:o.REFERENCE_RELATION.name,event_id:this.pollEventId}},r.M_POLL_END.name,{}),this.closingMessage.serialize().content)}}}])&&h(t.prototype,i),n&&h(t,n),Object.defineProperty(t,"prototype",{writable:!1}),v}(i("./node_modules/matrix-events-sdk/lib/events/ExtensibleEvent.js").ExtensibleEvent);t.PollEndEvent=y},"./node_modules/matrix-events-sdk/lib/events/PollResponseEvent.js":(e,t,i)=>{"use strict";function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.PollResponseEvent=void 0;var r=i("./node_modules/matrix-events-sdk/lib/events/ExtensibleEvent.js"),s=i("./node_modules/matrix-events-sdk/lib/events/poll_types.js"),o=i("./node_modules/matrix-events-sdk/lib/InvalidEventError.js"),a=i("./node_modules/matrix-events-sdk/lib/events/relationship_types.js"),c=i("./node_modules/matrix-events-sdk/lib/utility/events.js");function d(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function l(e,t){return l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},l(e,t)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,r=m(e);if(t){var s=m(this).constructor;i=Reflect.construct(r,arguments,s)}else i=r.apply(this,arguments);return function(e,t){if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return h(e)}(this,i)}}function h(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function m(e){return m=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},m(e)}function p(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var g=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&l(e,t)}(m,e);var t,i,n,r=u(m);function m(e){var t;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,m),p(h(t=r.call(this,e)),"internalAnswerIds",void 0),p(h(t),"internalSpoiled",void 0),p(h(t),"pollEventId",void 0);var i=t.wireContent["m.relates_to"];if(!a.REFERENCE_RELATION.matches(null==i?void 0:i.rel_type)||"string"!=typeof(null==i?void 0:i.event_id))throw new o.InvalidEventError("Relationship must be a reference to an event");return t.pollEventId=i.event_id,t.validateAgainst(null),t}return t=m,n=[{key:"from",value:function(e,t){return new m({type:s.M_POLL_RESPONSE.name,content:p({"m.relates_to":{rel_type:a.REFERENCE_RELATION.name,event_id:t}},s.M_POLL_RESPONSE.name,{answers:e})})}}],(i=[{key:"answerIds",get:function(){return this.internalAnswerIds}},{key:"spoiled",get:function(){return this.internalSpoiled}},{key:"validateAgainst",value:function(e){var t=s.M_POLL_RESPONSE.findIn(this.wireContent);if(!Array.isArray(null==t?void 0:t.answers))return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);var i=t.answers;if(i.some((function(e){return"string"!=typeof e}))||0===i.length)return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);if(e){if(i.some((function(t){return!e.answers.some((function(e){return e.id===t}))})))return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);i=i.slice(0,e.maxSelections)}this.internalAnswerIds=i,this.internalSpoiled=!1}},{key:"isEquivalentTo",value:function(e){return(0,c.isEventTypeSame)(e,s.M_POLL_RESPONSE)}},{key:"serialize",value:function(){return{type:s.M_POLL_RESPONSE.name,content:p({"m.relates_to":{rel_type:a.REFERENCE_RELATION.name,event_id:this.pollEventId}},s.M_POLL_RESPONSE.name,{answers:this.spoiled?void 0:this.answerIds})}}}])&&d(t.prototype,i),n&&d(t,n),Object.defineProperty(t,"prototype",{writable:!1}),m}(r.ExtensibleEvent);t.PollResponseEvent=g},"./node_modules/matrix-events-sdk/lib/events/PollStartEvent.js":(e,t,i)=>{"use strict";function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.PollStartEvent=t.PollAnswerSubevent=void 0;var r=i("./node_modules/matrix-events-sdk/lib/events/poll_types.js"),s=i("./node_modules/matrix-events-sdk/lib/events/MessageEvent.js"),o=i("./node_modules/matrix-events-sdk/lib/events/message_types.js"),a=i("./node_modules/matrix-events-sdk/lib/InvalidEventError.js"),c=i("./node_modules/matrix-events-sdk/lib/NamespacedValue.js"),d=i("./node_modules/matrix-events-sdk/lib/utility/events.js"),l=i("./node_modules/matrix-events-sdk/lib/events/ExtensibleEvent.js");function u(e){return function(e){if(Array.isArray(e))return h(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return h(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);"Object"===i&&e.constructor&&(i=e.constructor.name);if("Map"===i||"Set"===i)return Array.from(e);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return h(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function h(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function m(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function p(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?m(Object(i),!0).forEach((function(t){E(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):m(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function g(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function v(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function f(e,t,i){return t&&v(e.prototype,t),i&&v(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function y(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&b(e,t)}function b(e,t){return b=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},b(e,t)}function S(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,r=_(e);if(t){var s=_(this).constructor;i=Reflect.construct(r,arguments,s)}else i=r.apply(this,arguments);return function(e,t){if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return w(e)}(this,i)}}function w(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _(e){return _=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},_(e)}function E(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var I=function(e){y(i,e);var t=S(i);function i(e){var n;g(this,i),E(w(n=t.call(this,e)),"id",void 0);var r=e.content.id;if(!r||"string"!=typeof r)throw new a.InvalidEventError("Answer ID must be a non-empty string");return n.id=r,n}return f(i,[{key:"serialize",value:function(){return{type:"org.matrix.sdk.poll.answer",content:p({id:this.id},this.serializeMMessageOnly())}}}],[{key:"from",value:function(e,t){return new i({type:"org.matrix.sdk.poll.answer",content:E({id:e},o.M_TEXT.name,t)})}}]),i}(s.MessageEvent);t.PollAnswerSubevent=I;var k=function(e){y(i,e);var t=S(i);function i(e){var n;g(this,i),E(w(n=t.call(this,e)),"question",void 0),E(w(n),"kind",void 0),E(w(n),"rawKind",void 0),E(w(n),"maxSelections",void 0),E(w(n),"answers",void 0);var o=r.M_POLL_START.findIn(n.wireContent);if(!o.question)throw new a.InvalidEventError("A question is required");if(n.question=new s.MessageEvent({type:"org.matrix.sdk.poll.question",content:o.question}),n.rawKind=o.kind,r.M_POLL_KIND_DISCLOSED.matches(n.rawKind)?n.kind=r.M_POLL_KIND_DISCLOSED:n.kind=r.M_POLL_KIND_UNDISCLOSED,n.maxSelections=Number.isFinite(o.max_selections)&&o.max_selections>0?o.max_selections:1,!Array.isArray(o.answers))throw new a.InvalidEventError("Poll answers must be an array");var c=o.answers.slice(0,20).map((function(e){return new I({type:"org.matrix.sdk.poll.answer",content:e})}));if(c.length<=0)throw new a.InvalidEventError("No answers available");return n.answers=c,n}return f(i,[{key:"isEquivalentTo",value:function(e){return(0,d.isEventTypeSame)(e,r.M_POLL_START)}},{key:"serialize",value:function(){var e;return{type:r.M_POLL_START.name,content:(e={},E(e,r.M_POLL_START.name,{question:this.question.serialize().content,kind:this.rawKind,max_selections:this.maxSelections,answers:this.answers.map((function(e){return e.serialize().content}))}),E(e,o.M_TEXT.name,"".concat(this.question.text,"\n").concat(this.answers.map((function(e,t){return"".concat(t+1,". ").concat(e.text)})).join("\n"))),e)}}}],[{key:"from",value:function(e,t,n){var s,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return new i({type:r.M_POLL_START.name,content:(s={},E(s,o.M_TEXT.name,e),E(s,r.M_POLL_START.name,{question:E({},o.M_TEXT.name,e),kind:n instanceof c.NamespacedValue?n.name:n,max_selections:a,answers:t.map((function(e){return E({id:u(Array(16)).map((function(){return R.charAt(Math.floor(Math.random()*R.length))})).join("")},o.M_TEXT.name,e)}))}),s)})}}]),i}(l.ExtensibleEvent);t.PollStartEvent=k;var R="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"},"./node_modules/matrix-events-sdk/lib/events/message_types.js":(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_TEXT=t.M_NOTICE=t.M_MESSAGE=t.M_HTML=t.M_EMOTE=void 0;var n=i("./node_modules/matrix-events-sdk/lib/NamespacedValue.js"),r=new n.UnstableValue("m.message","org.matrix.msc1767.message");t.M_MESSAGE=r;var s=new n.UnstableValue("m.text","org.matrix.msc1767.text");t.M_TEXT=s;var o=new n.UnstableValue("m.html","org.matrix.msc1767.html");t.M_HTML=o;var a=new n.UnstableValue("m.emote","org.matrix.msc1767.emote");t.M_EMOTE=a;var c=new n.UnstableValue("m.notice","org.matrix.msc1767.notice");t.M_NOTICE=c},"./node_modules/matrix-events-sdk/lib/events/poll_types.js":(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_POLL_START=t.M_POLL_RESPONSE=t.M_POLL_KIND_UNDISCLOSED=t.M_POLL_KIND_DISCLOSED=t.M_POLL_END=void 0;var n=i("./node_modules/matrix-events-sdk/lib/NamespacedValue.js"),r=new n.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");t.M_POLL_KIND_DISCLOSED=r;var s=new n.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");t.M_POLL_KIND_UNDISCLOSED=s;var o=new n.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");t.M_POLL_START=o;var a=new n.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response");t.M_POLL_RESPONSE=a;var c=new n.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end");t.M_POLL_END=c},"./node_modules/matrix-events-sdk/lib/events/relationship_types.js":(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.REFERENCE_RELATION=void 0;var n=new(i("./node_modules/matrix-events-sdk/lib/NamespacedValue.js").NamespacedValue)("m.reference");t.REFERENCE_RELATION=n},"./node_modules/matrix-events-sdk/lib/index.js":(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=i("./node_modules/matrix-events-sdk/lib/ExtensibleEvents.js");Object.keys(n).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===n[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return n[e]}}))}));var r=i("./node_modules/matrix-events-sdk/lib/IPartialEvent.js");Object.keys(r).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===r[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return r[e]}}))}));var s=i("./node_modules/matrix-events-sdk/lib/InvalidEventError.js");Object.keys(s).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===s[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))}));var o=i("./node_modules/matrix-events-sdk/lib/NamespacedValue.js");Object.keys(o).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===o[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}}))}));var a=i("./node_modules/matrix-events-sdk/lib/NamespacedMap.js");Object.keys(a).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))}));var c=i("./node_modules/matrix-events-sdk/lib/types.js");Object.keys(c).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===c[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return c[e]}}))}));var d=i("./node_modules/matrix-events-sdk/lib/utility/MessageMatchers.js");Object.keys(d).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===d[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}}))}));var l=i("./node_modules/matrix-events-sdk/lib/utility/events.js");Object.keys(l).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===l[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}}))}));var u=i("./node_modules/matrix-events-sdk/lib/interpreters/legacy/MRoomMessage.js");Object.keys(u).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===u[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return u[e]}}))}));var h=i("./node_modules/matrix-events-sdk/lib/interpreters/modern/MMessage.js");Object.keys(h).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===h[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return h[e]}}))}));var m=i("./node_modules/matrix-events-sdk/lib/interpreters/modern/MPoll.js");Object.keys(m).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===m[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return m[e]}}))}));var p=i("./node_modules/matrix-events-sdk/lib/events/relationship_types.js");Object.keys(p).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===p[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return p[e]}}))}));var g=i("./node_modules/matrix-events-sdk/lib/events/ExtensibleEvent.js");Object.keys(g).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===g[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return g[e]}}))}));var v=i("./node_modules/matrix-events-sdk/lib/events/message_types.js");Object.keys(v).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===v[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return v[e]}}))}));var f=i("./node_modules/matrix-events-sdk/lib/events/MessageEvent.js");Object.keys(f).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===f[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return f[e]}}))}));var y=i("./node_modules/matrix-events-sdk/lib/events/EmoteEvent.js");Object.keys(y).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===y[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return y[e]}}))}));var b=i("./node_modules/matrix-events-sdk/lib/events/NoticeEvent.js");Object.keys(b).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===b[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return b[e]}}))}));var S=i("./node_modules/matrix-events-sdk/lib/events/poll_types.js");Object.keys(S).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===S[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return S[e]}}))}));var w=i("./node_modules/matrix-events-sdk/lib/events/PollStartEvent.js");Object.keys(w).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===w[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return w[e]}}))}));var _=i("./node_modules/matrix-events-sdk/lib/events/PollResponseEvent.js");Object.keys(_).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===_[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return _[e]}}))}));var E=i("./node_modules/matrix-events-sdk/lib/events/PollEndEvent.js");Object.keys(E).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===E[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return E[e]}}))}))},"./node_modules/matrix-events-sdk/lib/interpreters/legacy/MRoomMessage.js":(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LEGACY_M_ROOM_MESSAGE=void 0,t.parseMRoomMessage=function(e){var t,i,o;if(a.M_MESSAGE.findIn(e.content)||a.M_TEXT.findIn(e.content))return new n.MessageEvent(e);var c,u=null===(t=e.content)||void 0===t?void 0:t.msgtype,h=null===(i=e.content)||void 0===i?void 0:i.body,m="org.matrix.custom.html"===(null===(o=e.content)||void 0===o?void 0:o.format)?e.content.formatted_body:null;return"m.text"===u?new n.MessageEvent(d(d({},e),{},{content:d(d({},e.content),{},(c={},l(c,a.M_TEXT.name,h),l(c,a.M_HTML.name,m),c))})):"m.notice"===u?new r.NoticeEvent(d(d({},e),{},{content:d(d({},e.content),{},(p={},l(p,a.M_TEXT.name,h),l(p,a.M_HTML.name,m),p))})):"m.emote"===u?new s.EmoteEvent(d(d({},e),{},{content:d(d({},e.content),{},(g={},l(g,a.M_TEXT.name,h),l(g,a.M_HTML.name,m),g))})):null;var p,g};var n=i("./node_modules/matrix-events-sdk/lib/events/MessageEvent.js"),r=i("./node_modules/matrix-events-sdk/lib/events/NoticeEvent.js"),s=i("./node_modules/matrix-events-sdk/lib/events/EmoteEvent.js"),o=i("./node_modules/matrix-events-sdk/lib/NamespacedValue.js"),a=i("./node_modules/matrix-events-sdk/lib/events/message_types.js");function c(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function d(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?c(Object(i),!0).forEach((function(t){l(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):c(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function l(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var u=new o.NamespacedValue("m.room.message");t.LEGACY_M_ROOM_MESSAGE=u},"./node_modules/matrix-events-sdk/lib/interpreters/modern/MMessage.js":(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseMMessage=function(e){if(r.M_EMOTE.matches(e.type))return new s.EmoteEvent(e);if(r.M_NOTICE.matches(e.type))return new o.NoticeEvent(e);return new n.MessageEvent(e)};var n=i("./node_modules/matrix-events-sdk/lib/events/MessageEvent.js"),r=i("./node_modules/matrix-events-sdk/lib/events/message_types.js"),s=i("./node_modules/matrix-events-sdk/lib/events/EmoteEvent.js"),o=i("./node_modules/matrix-events-sdk/lib/events/NoticeEvent.js")},"./node_modules/matrix-events-sdk/lib/interpreters/modern/MPoll.js":(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseMPoll=function(e){if(n.M_POLL_START.matches(e.type))return new r.PollStartEvent(e);if(n.M_POLL_RESPONSE.matches(e.type))return new s.PollResponseEvent(e);if(n.M_POLL_END.matches(e.type))return new o.PollEndEvent(e);return null};var n=i("./node_modules/matrix-events-sdk/lib/events/poll_types.js"),r=i("./node_modules/matrix-events-sdk/lib/events/PollStartEvent.js"),s=i("./node_modules/matrix-events-sdk/lib/events/PollResponseEvent.js"),o=i("./node_modules/matrix-events-sdk/lib/events/PollEndEvent.js")},"./node_modules/matrix-events-sdk/lib/types.js":(e,t)=>{"use strict";function i(e){return null!=e}Object.defineProperty(t,"__esModule",{value:!0}),t.isOptionalAString=function(e){return i(e)&&"string"==typeof e},t.isProvided=i},"./node_modules/matrix-events-sdk/lib/utility/MessageMatchers.js":(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LegacyMsgType=void 0,t.isEventLike=function(e,t){var i=e.content;if(t===n.Text)return r.M_MESSAGE.matches(e.type)||"m.room.message"===e.type&&"m.text"===(null==i?void 0:i.msgtype);if(t===n.Emote)return r.M_EMOTE.matches(e.type)||"m.room.message"===e.type&&"m.emote"===(null==i?void 0:i.msgtype);if(t===n.Notice)return r.M_NOTICE.matches(e.type)||"m.room.message"===e.type&&"m.notice"===(null==i?void 0:i.msgtype);return!1};var n,r=i("./node_modules/matrix-events-sdk/lib/events/message_types.js");t.LegacyMsgType=n,function(e){e.Text="m.text",e.Notice="m.notice",e.Emote="m.emote"}(n||(t.LegacyMsgType=n={}))},"./node_modules/matrix-events-sdk/lib/utility/events.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isEventTypeSame=function(e,t){if("string"==typeof e)return"string"==typeof t?t===e:t.matches(e);if("string"==typeof t)return e.matches(t);var i=t,n=e;return i.matches(n.name)||i.matches(n.altName)}},"./node_modules/matrix-widget-api/lib/ClientWidgetApi.js":(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ClientWidgetApi=void 0;var n=i("./node_modules/events/events.js"),r=i("./node_modules/matrix-widget-api/lib/transport/PostmessageTransport.js"),s=i("./node_modules/matrix-widget-api/lib/interfaces/WidgetApiDirection.js"),o=i("./node_modules/matrix-widget-api/lib/interfaces/WidgetApiAction.js"),a=i("./node_modules/matrix-widget-api/lib/interfaces/Capabilities.js"),c=i("./node_modules/matrix-widget-api/lib/interfaces/ApiVersion.js"),d=i("./node_modules/matrix-widget-api/lib/models/WidgetEventCapability.js"),l=i("./node_modules/matrix-widget-api/lib/interfaces/GetOpenIDAction.js"),u=i("./node_modules/matrix-widget-api/lib/util/SimpleObservable.js"),h=i("./node_modules/matrix-widget-api/lib/Symbols.js");function m(e){return m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},m(e)}function p(){p=function(){return e};var e={},t=Object.prototype,i=t.hasOwnProperty,n=Object.defineProperty||function(e,t,i){e[t]=i.value},r="function"==typeof Symbol?Symbol:{},s=r.iterator||"@@iterator",o=r.asyncIterator||"@@asyncIterator",a=r.toStringTag||"@@toStringTag";function c(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,i){return e[t]=i}}function d(e,t,i,r){var s=t&&t.prototype instanceof h?t:h,o=Object.create(s.prototype),a=new T(r||[]);return n(o,"_invoke",{value:E(e,i,a)}),o}function l(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}e.wrap=d;var u={};function h(){}function g(){}function v(){}var f={};c(f,s,(function(){return this}));var y=Object.getPrototypeOf,b=y&&y(y(C([])));b&&b!==t&&i.call(b,s)&&(f=b);var S=v.prototype=h.prototype=Object.create(f);function w(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function _(e,t){function r(n,s,o,a){var c=l(e[n],e,s);if("throw"!==c.type){var d=c.arg,u=d.value;return u&&"object"==m(u)&&i.call(u,"__await")?t.resolve(u.__await).then((function(e){r("next",e,o,a)}),(function(e){r("throw",e,o,a)})):t.resolve(u).then((function(e){d.value=e,o(d)}),(function(e){return r("throw",e,o,a)}))}a(c.arg)}var s;n(this,"_invoke",{value:function(e,i){function n(){return new t((function(t,n){r(e,i,t,n)}))}return s=s?s.then(n,n):n()}})}function E(e,t,i){var n="suspendedStart";return function(r,s){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===r)throw s;return A()}for(i.method=r,i.arg=s;;){var o=i.delegate;if(o){var a=I(o,i);if(a){if(a===u)continue;return a}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===n)throw n="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);n="executing";var c=l(e,t,i);if("normal"===c.type){if(n=i.done?"completed":"suspendedYield",c.arg===u)continue;return{value:c.arg,done:i.done}}"throw"===c.type&&(n="completed",i.method="throw",i.arg=c.arg)}}}function I(e,t){var i=t.method,n=e.iterator[i];if(void 0===n)return t.delegate=null,"throw"===i&&e.iterator.return&&(t.method="return",t.arg=void 0,I(e,t),"throw"===t.method)||"return"!==i&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+i+"' method")),u;var r=l(n,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,u;var s=r.arg;return s?s.done?(t[e.resultName]=s.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,u):s:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,u)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function R(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function C(e){if(e){var t=e[s];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,r=function t(){for(;++n<e.length;)if(i.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return r.next=r}}return{next:A}}function A(){return{value:void 0,done:!0}}return g.prototype=v,n(S,"constructor",{value:v,configurable:!0}),n(v,"constructor",{value:g,configurable:!0}),g.displayName=c(v,a,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===g||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,c(e,a,"GeneratorFunction")),e.prototype=Object.create(S),e},e.awrap=function(e){return{__await:e}},w(_.prototype),c(_.prototype,o,(function(){return this})),e.AsyncIterator=_,e.async=function(t,i,n,r,s){void 0===s&&(s=Promise);var o=new _(d(t,i,n,r),s);return e.isGeneratorFunction(i)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},w(S),c(S,a,"Generator"),c(S,s,(function(){return this})),c(S,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),i=[];for(var n in t)i.push(n);return i.reverse(),function e(){for(;i.length;){var n=i.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=C,T.prototype={constructor:T,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(R),!e)for(var t in this)"t"===t.charAt(0)&&i.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(i,n){return o.type="throw",o.arg=e,t.next=i,n&&(t.method="next",t.arg=void 0),!!n}for(var r=this.tryEntries.length-1;r>=0;--r){var s=this.tryEntries[r],o=s.completion;if("root"===s.tryLoc)return n("end");if(s.tryLoc<=this.prev){var a=i.call(s,"catchLoc"),c=i.call(s,"finallyLoc");if(a&&c){if(this.prev<s.catchLoc)return n(s.catchLoc,!0);if(this.prev<s.finallyLoc)return n(s.finallyLoc)}else if(a){if(this.prev<s.catchLoc)return n(s.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return n(s.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&i.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var s=r;break}}s&&("break"===e||"continue"===e)&&s.tryLoc<=t&&t<=s.finallyLoc&&(s=null);var o=s?s.completion:{};return o.type=e,o.arg=t,s?(this.method="next",this.next=s.finallyLoc,u):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),u},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.finallyLoc===e)return this.complete(i.completion,i.afterLoc),R(i),u}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.tryLoc===e){var n=i.completion;if("throw"===n.type){var r=n.arg;R(i)}return r}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,i){return this.delegate={iterator:C(e),resultName:t,nextLoc:i},"next"===this.method&&(this.arg=void 0),u}},e}function g(e,t,i,n,r,s,o){try{var a=e[s](o),c=a.value}catch(e){return void i(e)}a.done?t(c):Promise.resolve(c).then(n,r)}function v(e){return function(){var t=this,i=arguments;return new Promise((function(n,r){var s=e.apply(t,i);function o(e){g(s,n,r,o,a,"next",e)}function a(e){g(s,n,r,o,a,"throw",e)}o(void 0)}))}}function f(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=function(e,t){if(!e)return;if("string"==typeof e)return y(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);"Object"===i&&e.constructor&&(i=e.constructor.name);if("Map"===i||"Set"===i)return Array.from(e);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return y(e,t)}(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var n=0,r=function(){};return{s:r,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,o=!0,a=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return o=e.done,e},e:function(e){a=!0,s=e},f:function(){try{o||null==i.return||i.return()}finally{if(a)throw s}}}}function y(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function b(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function S(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?b(Object(i),!0).forEach((function(t){R(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):b(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function w(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,T(n.key),n)}}function _(e,t){return _=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},_(e,t)}function E(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,n=k(e);if(t){var r=k(this).constructor;i=Reflect.construct(n,arguments,r)}else i=n.apply(this,arguments);return function(e,t){if(t&&("object"===m(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return I(e)}(this,i)}}function I(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function k(e){return k=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},k(e)}function R(e,t,i){return(t=T(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function T(e){var t=function(e,t){if("object"!==m(e)||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!==m(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===m(t)?t:String(t)}function C(e){var t,i,n,r=2;for("undefined"!=typeof Symbol&&(i=Symbol.asyncIterator,n=Symbol.iterator);r--;){if(i&&null!=(t=e[i]))return t.call(e);if(n&&null!=(t=e[n]))return new A(t.call(e));i="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function A(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then((function(e){return{value:e,done:t}}))}return A=function(e){this.s=e,this.n=e.next},A.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var i=this.s.return;return void 0===i?Promise.resolve({value:e,done:!0}):t(i.apply(this.s,arguments))},throw:function(e){var i=this.s.return;return void 0===i?Promise.reject(e):t(i.apply(this.s,arguments))}},new A(e)}var O=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_(e,t)}(j,e);var t,i,n,m,g,y,b,k,T,A,O,x,M,P=E(j);function j(e,t,i){var n;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,j),(n=P.call(this)).widget=e,n.iframe=t,n.driver=i,R(I(n),"transport",void 0),R(I(n),"contentLoadedActionSent",!1),R(I(n),"allowedCapabilities",new Set),R(I(n),"allowedEvents",[]),R(I(n),"isStopped",!1),R(I(n),"turnServers",null),R(I(n),"contentLoadedWaitTimer",void 0),null==t||!t.contentWindow)throw new Error("No iframe supplied");if(!e)throw new Error("Invalid widget");if(!i)throw new Error("Invalid driver");return n.transport=new r.PostmessageTransport(s.WidgetApiDirection.ToWidget,e.id,t.contentWindow,window),n.transport.targetOrigin=e.origin,n.transport.on("message",n.handleMessage.bind(I(n))),t.addEventListener("load",n.onIframeLoad.bind(I(n))),n.transport.start(),n}return t=j,i=[{key:"hasCapability",value:function(e){return this.allowedCapabilities.has(e)}},{key:"canUseRoomTimeline",value:function(e){return this.hasCapability("org.matrix.msc2762.timeline:".concat(h.Symbols.AnyRoom))||this.hasCapability("org.matrix.msc2762.timeline:".concat(e))}},{key:"canSendRoomEvent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.allowedEvents.some((function(i){return i.matchesAsRoomEvent(d.EventDirection.Send,e,t)}))}},{key:"canSendStateEvent",value:function(e,t){return this.allowedEvents.some((function(i){return i.matchesAsStateEvent(d.EventDirection.Send,e,t)}))}},{key:"canSendToDeviceEvent",value:function(e){return this.allowedEvents.some((function(t){return t.matchesAsToDeviceEvent(d.EventDirection.Send,e)}))}},{key:"canReceiveRoomEvent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.allowedEvents.some((function(i){return i.matchesAsRoomEvent(d.EventDirection.Receive,e,t)}))}},{key:"canReceiveStateEvent",value:function(e,t){return this.allowedEvents.some((function(i){return i.matchesAsStateEvent(d.EventDirection.Receive,e,t)}))}},{key:"canReceiveToDeviceEvent",value:function(e){return this.allowedEvents.some((function(t){return t.matchesAsToDeviceEvent(d.EventDirection.Receive,e)}))}},{key:"canReceiveRoomAccountData",value:function(e){return this.allowedEvents.some((function(t){return t.matchesAsRoomAccountData(d.EventDirection.Receive,e)}))}},{key:"stop",value:function(){this.isStopped=!0,this.transport.stop()}},{key:"beginCapabilities",value:function(){var e,t=this;this.emit("preparing"),this.transport.send(o.WidgetApiToWidgetAction.Capabilities,{}).then((function(i){return e=i.capabilities,t.driver.validateCapabilities(new Set(i.capabilities))})).then((function(i){console.log("Widget ".concat(t.widget.id," is allowed capabilities:"),Array.from(i)),t.allowedCapabilities=i,t.allowedEvents=d.WidgetEventCapability.findEventCapabilities(i),t.notifyCapabilities(e),t.emit("ready")})).catch((function(e){t.emit("error:preparing",e)}))}},{key:"notifyCapabilities",value:function(e){var t=this;this.transport.send(o.WidgetApiToWidgetAction.NotifyCapabilities,{requested:e,approved:Array.from(this.allowedCapabilities)}).catch((function(e){console.warn("non-fatal error notifying widget of approved capabilities:",e)})).then((function(){t.emit("capabilitiesNotified")}))}},{key:"onIframeLoad",value:function(e){this.widget.waitForIframeLoad?this.beginCapabilities():(console.log("waitForIframeLoad is false: waiting for widget to send contentLoaded"),this.contentLoadedWaitTimer=setTimeout((function(){console.error("Widget specified waitForIframeLoad=false but timed out waiting for contentLoaded event!")}),1e4),this.contentLoadedActionSent=!1)}},{key:"handleContentLoadedAction",value:function(e){if(void 0!==this.contentLoadedWaitTimer&&(clearTimeout(this.contentLoadedWaitTimer),this.contentLoadedWaitTimer=void 0),this.contentLoadedActionSent)throw new Error("Improper sequence: ContentLoaded Action can only be sent once after the widget loaded and should only be used if waitForIframeLoad is false (default=true)");this.widget.waitForIframeLoad?this.transport.reply(e,{error:{message:"Improper sequence: not expecting ContentLoaded event if waitForIframeLoad is true (default=true)"}}):(this.transport.reply(e,{}),this.beginCapabilities()),this.contentLoadedActionSent=!0}},{key:"replyVersions",value:function(e){this.transport.reply(e,{supported_versions:c.CurrentApiVersions})}},{key:"handleCapabilitiesRenegotiate",value:function(e){var t,i=this;this.transport.reply(e,{});var n=(null===(t=e.data)||void 0===t?void 0:t.capabilities)||[],r=new Set(n.filter((function(e){return!i.hasCapability(e)})));if(0===r.size)return this.notifyCapabilities([]);this.driver.validateCapabilities(r).then((function(e){return e.forEach((function(e){return i.allowedCapabilities.add(e)})),d.WidgetEventCapability.findEventCapabilities(e).forEach((function(e){return i.allowedEvents.push(e)})),i.notifyCapabilities(Array.from(r))}))}},{key:"handleNavigate",value:function(e){var t,i,n=this;if(!this.hasCapability(a.MatrixCapabilities.MSC2931Navigate))return this.transport.reply(e,{error:{message:"Missing capability"}});if(null===(t=e.data)||void 0===t||!t.uri||null===(i=e.data)||void 0===i||!i.uri.toString().startsWith("https://matrix.to/#"))return this.transport.reply(e,{error:{message:"Invalid matrix.to URI"}});var r=function(t){return console.error("[ClientWidgetApi] Failed to handle navigation: ",t),n.transport.reply(e,{error:{message:"Error handling navigation"}})};try{this.driver.navigate(e.data.uri.toString()).catch((function(e){return r(e)})).then((function(){return n.transport.reply(e,{})}))}catch(e){return r(e)}}},{key:"handleOIDC",value:function(e){var t=this,i=1,n=function(n,r){return r=r||{},i>1?t.transport.send(o.WidgetApiToWidgetAction.OpenIDCredentials,S({state:n,original_request_id:e.requestId},r)):t.transport.reply(e,S({state:n},r))},r=function(r){return console.error("[ClientWidgetApi] Failed to handle OIDC: ",r),i>1?n(l.OpenIDRequestState.Blocked):t.transport.reply(e,{error:{message:r}})},s=new u.SimpleObservable((function(e){return e.state===l.OpenIDRequestState.PendingUserConfirmation&&i>1?(s.close(),r("client provided out-of-phase response to OIDC flow")):e.state===l.OpenIDRequestState.PendingUserConfirmation?(n(e.state),void i++):e.state!==l.OpenIDRequestState.Allowed||e.token?(e.state===l.OpenIDRequestState.Blocked&&(e.token=void 0),s.close(),n(e.state,e.token)):r("client provided invalid OIDC token for an allowed request")}));this.driver.askOpenID(s)}},{key:"handleReadRoomAccountData",value:function(e){var t=this,i=Promise.resolve([]);return i=this.driver.readRoomAccountData(e.data.type),this.canReceiveRoomAccountData(e.data.type)?i.then((function(i){t.transport.reply(e,{events:i})})):this.transport.reply(e,{error:{message:"Cannot read room account data of this type"}})}},{key:"handleReadEvents",value:function(e){var t=this;if(!e.data.type)return this.transport.reply(e,{error:{message:"Invalid request - missing event type"}});if(void 0!==e.data.limit&&(!e.data.limit||e.data.limit<0))return this.transport.reply(e,{error:{message:"Invalid request - limit out of range"}});var i=null;if(e.data.room_ids){i=e.data.room_ids,Array.isArray(i)||(i=[i]);var n,r=f(i);try{for(r.s();!(n=r.n()).done;){var s=n.value;if(!this.canUseRoomTimeline(s))return this.transport.reply(e,{error:{message:"Unable to access room timeline: ".concat(s)}})}}catch(e){r.e(e)}finally{r.f()}}var o=e.data.limit||0,a=e.data.since,c=Promise.resolve([]);if(void 0!==e.data.state_key){var d=!0===e.data.state_key?void 0:e.data.state_key.toString();if(!this.canReceiveStateEvent(e.data.type,null!=d?d:null))return this.transport.reply(e,{error:{message:"Cannot read state events of this type"}});c=this.driver.readStateEvents(e.data.type,d,o,i)}else{if(!this.canReceiveRoomEvent(e.data.type,e.data.msgtype))return this.transport.reply(e,{error:{message:"Cannot read room events of this type"}});c=this.driver.readRoomEvents(e.data.type,e.data.msgtype,o,i,a)}return c.then((function(i){return t.transport.reply(e,{events:i})}))}},{key:"handleSendEvent",value:function(e){var t,i=this;if(!e.data.type)return this.transport.reply(e,{error:{message:"Invalid request - missing event type"}});if(e.data.room_id&&!this.canUseRoomTimeline(e.data.room_id))return this.transport.reply(e,{error:{message:"Unable to access room timeline: ".concat(e.data.room_id)}});if(null!==e.data.state_key&&void 0!==e.data.state_key){if(!this.canSendStateEvent(e.data.type,e.data.state_key))return this.transport.reply(e,{error:{message:"Cannot send state events of this type"}});t=this.driver.sendEvent(e.data.type,e.data.content||{},e.data.state_key,e.data.room_id)}else{var n=e.data.content||{},r=n.msgtype;if(!this.canSendRoomEvent(e.data.type,r))return this.transport.reply(e,{error:{message:"Cannot send room events of this type"}});t=this.driver.sendEvent(e.data.type,n,null,e.data.room_id)}t.then((function(t){return i.transport.reply(e,{room_id:t.roomId,event_id:t.eventId})})).catch((function(t){return console.error("error sending event: ",t),i.transport.reply(e,{error:{message:"Error sending event"}})}))}},{key:"handleSendToDevice",value:(M=v(p().mark((function e(t){return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.data.type){e.next=5;break}return e.next=3,this.transport.reply(t,{error:{message:"Invalid request - missing event type"}});case 3:case 8:case 13:case 18:case 25:e.next=32;break;case 5:if(t.data.messages){e.next=10;break}return e.next=8,this.transport.reply(t,{error:{message:"Invalid request - missing event contents"}});case 10:if("boolean"==typeof t.data.encrypted){e.next=15;break}return e.next=13,this.transport.reply(t,{error:{message:"Invalid request - missing encryption flag"}});case 15:if(this.canSendToDeviceEvent(t.data.type)){e.next=20;break}return e.next=18,this.transport.reply(t,{error:{message:"Cannot send to-device events of this type"}});case 20:return e.prev=20,e.next=23,this.driver.sendToDevice(t.data.type,t.data.encrypted,t.data.messages);case 23:return e.next=25,this.transport.reply(t,{});case 27:return e.prev=27,e.t0=e.catch(20),console.error("error sending to-device event",e.t0),e.next=32,this.transport.reply(t,{error:{message:"Error sending event"}});case 32:case"end":return e.stop()}}),e,this,[[20,27]])}))),function(e){return M.apply(this,arguments)})},{key:"pollTurnServers",value:(x=v(p().mark((function e(t,i){var n,r,s,a,c,d;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.transport.send(o.WidgetApiToWidgetAction.UpdateTurnServers,i);case 3:n=!1,r=!1,e.prev=5,a=C(t);case 7:return e.next=9,a.next();case 9:if(!(n=!(c=e.sent).done)){e.next=16;break}return d=c.value,e.next=13,this.transport.send(o.WidgetApiToWidgetAction.UpdateTurnServers,d);case 13:n=!1,e.next=7;break;case 16:e.next=22;break;case 18:e.prev=18,e.t0=e.catch(5),r=!0,s=e.t0;case 22:if(e.prev=22,e.prev=23,!n||null==a.return){e.next=27;break}return e.next=27,a.return();case 27:if(e.prev=27,!r){e.next=30;break}throw s;case 30:return e.finish(27);case 31:return e.finish(22);case 32:e.next=37;break;case 34:e.prev=34,e.t1=e.catch(0),console.error("error polling for TURN servers",e.t1);case 37:case"end":return e.stop()}}),e,this,[[0,34],[5,18,22,32],[23,,27,31]])}))),function(e,t){return x.apply(this,arguments)})},{key:"handleWatchTurnServers",value:(O=v(p().mark((function e(t){var i,n,r,s;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(a.MatrixCapabilities.MSC3846TurnServers)){e.next=5;break}return e.next=3,this.transport.reply(t,{error:{message:"Missing capability"}});case 3:case 8:e.next=30;break;case 5:if(!this.turnServers){e.next=10;break}return e.next=8,this.transport.reply(t,{});case 10:return e.prev=10,i=this.driver.getTurnServers(),e.next=14,i.next();case 14:if(n=e.sent,r=n.done,s=n.value,!r){e.next=19;break}throw new Error("Client refuses to provide any TURN servers");case 19:return e.next=21,this.transport.reply(t,{});case 21:this.pollTurnServers(i,s),this.turnServers=i,e.next=30;break;case 25:return e.prev=25,e.t0=e.catch(10),console.error("error getting first TURN server results",e.t0),e.next=30,this.transport.reply(t,{error:{message:"TURN servers not available"}});case 30:case"end":return e.stop()}}),e,this,[[10,25]])}))),function(e){return O.apply(this,arguments)})},{key:"handleUnwatchTurnServers",value:(A=v(p().mark((function e(t){return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(a.MatrixCapabilities.MSC3846TurnServers)){e.next=5;break}return e.next=3,this.transport.reply(t,{error:{message:"Missing capability"}});case 3:case 8:e.next=15;break;case 5:if(this.turnServers){e.next=10;break}return e.next=8,this.transport.reply(t,{});case 10:return e.next=12,this.turnServers.return(void 0);case 12:return this.turnServers=null,e.next=15,this.transport.reply(t,{});case 15:case"end":return e.stop()}}),e,this)}))),function(e){return A.apply(this,arguments)})},{key:"handleReadRelations",value:(T=v(p().mark((function e(t){var i,n,r=this;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.data.event_id){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - missing event ID"}}));case 2:if(!(void 0!==t.data.limit&&t.data.limit<0)){e.next=4;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - limit out of range"}}));case 4:if(void 0===t.data.room_id||this.canUseRoomTimeline(t.data.room_id)){e.next=6;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Unable to access room timeline: ".concat(t.data.room_id)}}));case 6:return e.prev=6,e.next=9,this.driver.readEventRelations(t.data.event_id,t.data.room_id,t.data.rel_type,t.data.event_type,t.data.from,t.data.to,t.data.limit,t.data.direction);case 9:return i=e.sent,n=i.chunk.filter((function(e){return void 0!==e.state_key?r.canReceiveStateEvent(e.type,e.state_key):r.canReceiveRoomEvent(e.type,e.content.msgtype)})),e.abrupt("return",this.transport.reply(t,{chunk:n,prev_batch:i.prevBatch,next_batch:i.nextBatch}));case 14:return e.prev=14,e.t0=e.catch(6),console.error("error getting the relations",e.t0),e.next=19,this.transport.reply(t,{error:{message:"Unexpected error while reading relations"}});case 19:case"end":return e.stop()}}),e,this,[[6,14]])}))),function(e){return T.apply(this,arguments)})},{key:"handleUserDirectorySearch",value:(k=v(p().mark((function e(t){var i;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(a.MatrixCapabilities.MSC3973UserDirectorySearch)){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Missing capability"}}));case 2:if("string"==typeof t.data.search_term){e.next=4;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - missing search term"}}));case 4:if(!(void 0!==t.data.limit&&t.data.limit<0)){e.next=6;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - limit out of range"}}));case 6:return e.prev=6,e.next=9,this.driver.searchUserDirectory(t.data.search_term,t.data.limit);case 9:return i=e.sent,e.abrupt("return",this.transport.reply(t,{limited:i.limited,results:i.results.map((function(e){return{user_id:e.userId,display_name:e.displayName,avatar_url:e.avatarUrl}}))}));case 13:return e.prev=13,e.t0=e.catch(6),console.error("error searching in the user directory",e.t0),e.next=18,this.transport.reply(t,{error:{message:"Unexpected error while searching in the user directory"}});case 18:case"end":return e.stop()}}),e,this,[[6,13]])}))),function(e){return k.apply(this,arguments)})},{key:"handleGetMediaConfig",value:(b=v(p().mark((function e(t){var i;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(a.MatrixCapabilities.MSC4039UploadFile)){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Missing capability"}}));case 2:return e.prev=2,e.next=5,this.driver.getMediaConfig();case 5:return i=e.sent,e.abrupt("return",this.transport.reply(t,i));case 9:return e.prev=9,e.t0=e.catch(2),console.error("error while getting the media configuration",e.t0),e.next=14,this.transport.reply(t,{error:{message:"Unexpected error while getting the media configuration"}});case 14:case"end":return e.stop()}}),e,this,[[2,9]])}))),function(e){return b.apply(this,arguments)})},{key:"handleUploadFile",value:(y=v(p().mark((function e(t){var i;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(a.MatrixCapabilities.MSC4039UploadFile)){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Missing capability"}}));case 2:return e.prev=2,e.next=5,this.driver.uploadFile(t.data.file);case 5:return i=e.sent,e.abrupt("return",this.transport.reply(t,{content_uri:i.contentUri}));case 9:return e.prev=9,e.t0=e.catch(2),console.error("error while uploading a file",e.t0),e.next=14,this.transport.reply(t,{error:{message:"Unexpected error while uploading a file"}});case 14:case"end":return e.stop()}}),e,this,[[2,9]])}))),function(e){return y.apply(this,arguments)})},{key:"handleMessage",value:function(e){if(!this.isStopped){var t=new CustomEvent("action:".concat(e.detail.action),{detail:e.detail,cancelable:!0});if(this.emit("action:".concat(e.detail.action),t),!t.defaultPrevented)switch(e.detail.action){case o.WidgetApiFromWidgetAction.ContentLoaded:return this.handleContentLoadedAction(e.detail);case o.WidgetApiFromWidgetAction.SupportedApiVersions:return this.replyVersions(e.detail);case o.WidgetApiFromWidgetAction.SendEvent:return this.handleSendEvent(e.detail);case o.WidgetApiFromWidgetAction.SendToDevice:return this.handleSendToDevice(e.detail);case o.WidgetApiFromWidgetAction.GetOpenIDCredentials:return this.handleOIDC(e.detail);case o.WidgetApiFromWidgetAction.MSC2931Navigate:return this.handleNavigate(e.detail);case o.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities:return this.handleCapabilitiesRenegotiate(e.detail);case o.WidgetApiFromWidgetAction.MSC2876ReadEvents:return this.handleReadEvents(e.detail);case o.WidgetApiFromWidgetAction.WatchTurnServers:return this.handleWatchTurnServers(e.detail);case o.WidgetApiFromWidgetAction.UnwatchTurnServers:return this.handleUnwatchTurnServers(e.detail);case o.WidgetApiFromWidgetAction.MSC3869ReadRelations:return this.handleReadRelations(e.detail);case o.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch:return this.handleUserDirectorySearch(e.detail);case o.WidgetApiFromWidgetAction.BeeperReadRoomAccountData:return this.handleReadRoomAccountData(e.detail);case o.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction:return this.handleGetMediaConfig(e.detail);case o.WidgetApiFromWidgetAction.MSC4039UploadFileAction:return this.handleUploadFile(e.detail);default:return this.transport.reply(e.detail,{error:{message:"Unknown or unsupported action: "+e.detail.action}})}}}},{key:"takeScreenshot",value:function(){return this.transport.send(o.WidgetApiToWidgetAction.TakeScreenshot,{})}},{key:"updateVisibility",value:function(e){return this.transport.send(o.WidgetApiToWidgetAction.UpdateVisibility,{visible:e})}},{key:"sendWidgetConfig",value:function(e){return this.transport.send(o.WidgetApiToWidgetAction.WidgetConfig,e).then()}},{key:"notifyModalWidgetButtonClicked",value:function(e){return this.transport.send(o.WidgetApiToWidgetAction.ButtonClicked,{id:e}).then()}},{key:"notifyModalWidgetClose",value:function(e){return this.transport.send(o.WidgetApiToWidgetAction.CloseModalWidget,e).then()}},{key:"feedEvent",value:(g=v(p().mark((function e(t,i){var n;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.room_id===i||this.canUseRoomTimeline(t.room_id)){e.next=2;break}return e.abrupt("return");case 2:if(void 0===t.state_key||null===t.state_key){e.next=7;break}if(this.canReceiveStateEvent(t.type,t.state_key)){e.next=5;break}return e.abrupt("return");case 5:e.next=9;break;case 7:if(this.canReceiveRoomEvent(t.type,null===(n=t.content)||void 0===n?void 0:n.msgtype)){e.next=9;break}return e.abrupt("return");case 9:return e.next=11,this.transport.send(o.WidgetApiToWidgetAction.SendEvent,t);case 11:case"end":return e.stop()}}),e,this)}))),function(e,t){return g.apply(this,arguments)})},{key:"feedToDevice",value:(m=v(p().mark((function e(t,i){return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.canReceiveToDeviceEvent(t.type)){e.next=3;break}return e.next=3,this.transport.send(o.WidgetApiToWidgetAction.SendToDevice,S(S({},t),{},{encrypted:i}));case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return m.apply(this,arguments)})}],i&&w(t.prototype,i),n&&w(t,n),Object.defineProperty(t,"prototype",{writable:!1}),j}(n.EventEmitter);t.ClientWidgetApi=O},"./node_modules/matrix-widget-api/lib/Symbols.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Symbols=void 0;var i=function(e){return e.AnyRoom="*",e}({});t.Symbols=i},"./node_modules/matrix-widget-api/lib/WidgetApi.js":(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetApi=void 0;var n=i("./node_modules/events/events.js"),r=i("./node_modules/matrix-widget-api/lib/interfaces/WidgetApiDirection.js"),s=i("./node_modules/matrix-widget-api/lib/interfaces/ApiVersion.js"),o=i("./node_modules/matrix-widget-api/lib/transport/PostmessageTransport.js"),a=i("./node_modules/matrix-widget-api/lib/interfaces/WidgetApiAction.js"),c=i("./node_modules/matrix-widget-api/lib/interfaces/GetOpenIDAction.js"),d=i("./node_modules/matrix-widget-api/lib/interfaces/WidgetType.js"),l=i("./node_modules/matrix-widget-api/lib/interfaces/ModalWidgetActions.js"),u=i("./node_modules/matrix-widget-api/lib/models/WidgetEventCapability.js"),h=i("./node_modules/matrix-widget-api/lib/Symbols.js");function m(e){return m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},m(e)}function p(){p=function(){return e};var e={},t=Object.prototype,i=t.hasOwnProperty,n=Object.defineProperty||function(e,t,i){e[t]=i.value},r="function"==typeof Symbol?Symbol:{},s=r.iterator||"@@iterator",o=r.asyncIterator||"@@asyncIterator",a=r.toStringTag||"@@toStringTag";function c(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,i){return e[t]=i}}function d(e,t,i,r){var s=t&&t.prototype instanceof h?t:h,o=Object.create(s.prototype),a=new T(r||[]);return n(o,"_invoke",{value:E(e,i,a)}),o}function l(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}e.wrap=d;var u={};function h(){}function g(){}function v(){}var f={};c(f,s,(function(){return this}));var y=Object.getPrototypeOf,b=y&&y(y(C([])));b&&b!==t&&i.call(b,s)&&(f=b);var S=v.prototype=h.prototype=Object.create(f);function w(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function _(e,t){function r(n,s,o,a){var c=l(e[n],e,s);if("throw"!==c.type){var d=c.arg,u=d.value;return u&&"object"==m(u)&&i.call(u,"__await")?t.resolve(u.__await).then((function(e){r("next",e,o,a)}),(function(e){r("throw",e,o,a)})):t.resolve(u).then((function(e){d.value=e,o(d)}),(function(e){return r("throw",e,o,a)}))}a(c.arg)}var s;n(this,"_invoke",{value:function(e,i){function n(){return new t((function(t,n){r(e,i,t,n)}))}return s=s?s.then(n,n):n()}})}function E(e,t,i){var n="suspendedStart";return function(r,s){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===r)throw s;return A()}for(i.method=r,i.arg=s;;){var o=i.delegate;if(o){var a=I(o,i);if(a){if(a===u)continue;return a}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===n)throw n="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);n="executing";var c=l(e,t,i);if("normal"===c.type){if(n=i.done?"completed":"suspendedYield",c.arg===u)continue;return{value:c.arg,done:i.done}}"throw"===c.type&&(n="completed",i.method="throw",i.arg=c.arg)}}}function I(e,t){var i=t.method,n=e.iterator[i];if(void 0===n)return t.delegate=null,"throw"===i&&e.iterator.return&&(t.method="return",t.arg=void 0,I(e,t),"throw"===t.method)||"return"!==i&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+i+"' method")),u;var r=l(n,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,u;var s=r.arg;return s?s.done?(t[e.resultName]=s.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,u):s:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,u)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function R(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function C(e){if(e){var t=e[s];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,r=function t(){for(;++n<e.length;)if(i.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return r.next=r}}return{next:A}}function A(){return{value:void 0,done:!0}}return g.prototype=v,n(S,"constructor",{value:v,configurable:!0}),n(v,"constructor",{value:g,configurable:!0}),g.displayName=c(v,a,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===g||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,c(e,a,"GeneratorFunction")),e.prototype=Object.create(S),e},e.awrap=function(e){return{__await:e}},w(_.prototype),c(_.prototype,o,(function(){return this})),e.AsyncIterator=_,e.async=function(t,i,n,r,s){void 0===s&&(s=Promise);var o=new _(d(t,i,n,r),s);return e.isGeneratorFunction(i)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},w(S),c(S,a,"Generator"),c(S,s,(function(){return this})),c(S,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),i=[];for(var n in t)i.push(n);return i.reverse(),function e(){for(;i.length;){var n=i.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=C,T.prototype={constructor:T,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(R),!e)for(var t in this)"t"===t.charAt(0)&&i.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(i,n){return o.type="throw",o.arg=e,t.next=i,n&&(t.method="next",t.arg=void 0),!!n}for(var r=this.tryEntries.length-1;r>=0;--r){var s=this.tryEntries[r],o=s.completion;if("root"===s.tryLoc)return n("end");if(s.tryLoc<=this.prev){var a=i.call(s,"catchLoc"),c=i.call(s,"finallyLoc");if(a&&c){if(this.prev<s.catchLoc)return n(s.catchLoc,!0);if(this.prev<s.finallyLoc)return n(s.finallyLoc)}else if(a){if(this.prev<s.catchLoc)return n(s.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return n(s.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&i.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var s=r;break}}s&&("break"===e||"continue"===e)&&s.tryLoc<=t&&t<=s.finallyLoc&&(s=null);var o=s?s.completion:{};return o.type=e,o.arg=t,s?(this.method="next",this.next=s.finallyLoc,u):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),u},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.finallyLoc===e)return this.complete(i.completion,i.afterLoc),R(i),u}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.tryLoc===e){var n=i.completion;if("throw"===n.type){var r=n.arg;R(i)}return r}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,i){return this.delegate={iterator:C(e),resultName:t,nextLoc:i},"next"===this.method&&(this.arg=void 0),u}},e}function g(e,t,i,n,r,s,o){try{var a=e[s](o),c=a.value}catch(e){return void i(e)}a.done?t(c):Promise.resolve(c).then(n,r)}function v(e){return function(){var t=this,i=arguments;return new Promise((function(n,r){var s=e.apply(t,i);function o(e){g(s,n,r,o,a,"next",e)}function a(e){g(s,n,r,o,a,"throw",e)}o(void 0)}))}}function f(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,E(n.key),n)}}function y(e,t){return y=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},y(e,t)}function b(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,n=w(e);if(t){var r=w(this).constructor;i=Reflect.construct(n,arguments,r)}else i=n.apply(this,arguments);return function(e,t){if(t&&("object"===m(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return S(e)}(this,i)}}function S(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function w(e){return w=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},w(e)}function _(e,t,i){return(t=E(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function E(e){var t=function(e,t){if("object"!==m(e)||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!==m(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===m(t)?t:String(t)}function I(e){return new R(e,0)}function k(e){var t,i;function n(t,i){try{var s=e[t](i),o=s.value,a=o instanceof R;Promise.resolve(a?o.v:o).then((function(i){if(a){var c="return"===t?"return":"next";if(!o.k||i.done)return n(c,i);i=e[c](i).value}r(s.done?"return":"normal",i)}),(function(e){n("throw",e)}))}catch(e){r("throw",e)}}function r(e,r){switch(e){case"return":t.resolve({value:r,done:!0});break;case"throw":t.reject(r);break;default:t.resolve({value:r,done:!1})}(t=t.next)?n(t.key,t.arg):i=null}this._invoke=function(e,r){return new Promise((function(s,o){var a={key:e,arg:r,resolve:s,reject:o,next:null};i?i=i.next=a:(t=i=a,n(e,r))}))},"function"!=typeof e.return&&(this.return=void 0)}function R(e,t){this.v=e,this.k=t}k.prototype["function"==typeof Symbol&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},k.prototype.next=function(e){return this._invoke("next",e)},k.prototype.throw=function(e){return this._invoke("throw",e)},k.prototype.return=function(e){return this._invoke("return",e)};var T=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&y(e,t)}(T,e);var t,i,n,m,g,w,E,R=b(T);function T(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,T),(e=R.call(this)).clientOrigin=i,_(S(e),"transport",void 0),_(S(e),"capabilitiesFinished",!1),_(S(e),"supportsMSC2974Renegotiate",!1),_(S(e),"requestedCapabilities",[]),_(S(e),"approvedCapabilities",void 0),_(S(e),"cachedClientVersions",void 0),_(S(e),"turnServerWatchers",0),!window.parent)throw new Error("No parent window. This widget doesn't appear to be embedded properly.");return e.transport=new o.PostmessageTransport(r.WidgetApiDirection.FromWidget,t,window.parent,window),e.transport.targetOrigin=i,e.transport.on("message",e.handleMessage.bind(S(e))),e}return t=T,i=[{key:"hasCapability",value:function(e){return Array.isArray(this.approvedCapabilities)?this.approvedCapabilities.includes(e):this.requestedCapabilities.includes(e)}},{key:"requestCapability",value:function(e){if(this.capabilitiesFinished&&!this.supportsMSC2974Renegotiate)throw new Error("Capabilities have already been negotiated");this.requestedCapabilities.push(e)}},{key:"requestCapabilities",value:function(e){var t=this;e.forEach((function(e){return t.requestCapability(e)}))}},{key:"requestCapabilityForRoomTimeline",value:function(e){this.requestCapability("org.matrix.msc2762.timeline:".concat(e))}},{key:"requestCapabilityToSendState",value:function(e,t){this.requestCapability(u.WidgetEventCapability.forStateEvent(u.EventDirection.Send,e,t).raw)}},{key:"requestCapabilityToReceiveState",value:function(e,t){this.requestCapability(u.WidgetEventCapability.forStateEvent(u.EventDirection.Receive,e,t).raw)}},{key:"requestCapabilityToSendToDevice",value:function(e){this.requestCapability(u.WidgetEventCapability.forToDeviceEvent(u.EventDirection.Send,e).raw)}},{key:"requestCapabilityToReceiveToDevice",value:function(e){this.requestCapability(u.WidgetEventCapability.forToDeviceEvent(u.EventDirection.Receive,e).raw)}},{key:"requestCapabilityToSendEvent",value:function(e){this.requestCapability(u.WidgetEventCapability.forRoomEvent(u.EventDirection.Send,e).raw)}},{key:"requestCapabilityToReceiveEvent",value:function(e){this.requestCapability(u.WidgetEventCapability.forRoomEvent(u.EventDirection.Receive,e).raw)}},{key:"requestCapabilityToSendMessage",value:function(e){this.requestCapability(u.WidgetEventCapability.forRoomMessageEvent(u.EventDirection.Send,e).raw)}},{key:"requestCapabilityToReceiveMessage",value:function(e){this.requestCapability(u.WidgetEventCapability.forRoomMessageEvent(u.EventDirection.Receive,e).raw)}},{key:"requestCapabilityToReceiveRoomAccountData",value:function(e){this.requestCapability(u.WidgetEventCapability.forRoomAccountData(u.EventDirection.Receive,e).raw)}},{key:"requestOpenIDConnectToken",value:function(){var e=this;return new Promise((function(t,i){e.transport.sendComplete(a.WidgetApiFromWidgetAction.GetOpenIDCredentials,{}).then((function(n){var r=n.response;r.state===c.OpenIDRequestState.Allowed?t(r):r.state===c.OpenIDRequestState.Blocked?i(new Error("User declined to verify their identity")):r.state===c.OpenIDRequestState.PendingUserConfirmation?e.on("action:".concat(a.WidgetApiToWidgetAction.OpenIDCredentials),(function s(o){o.preventDefault();var d=o.detail;d.data.original_request_id===n.requestId&&(d.data.state===c.OpenIDRequestState.Allowed?(t(d.data),e.transport.reply(d,{})):d.data.state===c.OpenIDRequestState.Blocked?(i(new Error("User declined to verify their identity")),e.transport.reply(d,{})):(i(new Error("Invalid state on reply: "+r.state)),e.transport.reply(d,{error:{message:"Invalid state"}})),e.off("action:".concat(a.WidgetApiToWidgetAction.OpenIDCredentials),s))})):i(new Error("Invalid state: "+r.state))})).catch(i)}))}},{key:"updateRequestedCapabilities",value:function(){return this.transport.send(a.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities,{capabilities:this.requestedCapabilities}).then()}},{key:"sendContentLoaded",value:function(){return this.transport.send(a.WidgetApiFromWidgetAction.ContentLoaded,{}).then()}},{key:"sendSticker",value:function(e){return this.transport.send(a.WidgetApiFromWidgetAction.SendSticker,e).then()}},{key:"setAlwaysOnScreen",value:function(e){return this.transport.send(a.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen,{value:e}).then((function(e){return e.success}))}},{key:"openModalWidget",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:d.MatrixWidgetType.Custom;return this.transport.send(a.WidgetApiFromWidgetAction.OpenModalWidget,{type:r,url:e,name:t,buttons:i,data:n}).then()}},{key:"closeModalWidget",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.transport.send(a.WidgetApiFromWidgetAction.CloseModalWidget,e).then()}},{key:"sendRoomEvent",value:function(e,t,i){return this.transport.send(a.WidgetApiFromWidgetAction.SendEvent,{type:e,content:t,room_id:i})}},{key:"sendStateEvent",value:function(e,t,i,n){return this.transport.send(a.WidgetApiFromWidgetAction.SendEvent,{type:e,content:i,state_key:t,room_id:n})}},{key:"sendToDevice",value:function(e,t,i){return this.transport.send(a.WidgetApiFromWidgetAction.SendToDevice,{type:e,encrypted:t,messages:i})}},{key:"readRoomAccountData",value:function(e,t){var i={type:e};return t&&(t.includes(h.Symbols.AnyRoom)?i.room_ids=h.Symbols.AnyRoom:i.room_ids=t),this.transport.send(a.WidgetApiFromWidgetAction.BeeperReadRoomAccountData,i).then((function(e){return e.events}))}},{key:"readRoomEvents",value:function(e,t,i,n,r){var s={type:e,msgtype:i};return void 0!==t&&(s.limit=t),n&&(n.includes(h.Symbols.AnyRoom)?s.room_ids=h.Symbols.AnyRoom:s.room_ids=n),r&&(s.since=r),this.transport.send(a.WidgetApiFromWidgetAction.MSC2876ReadEvents,s).then((function(e){return e.events}))}},{key:"readEventRelations",value:(E=v(p().mark((function e(t,i,n,r,o,c,d,l){var u;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(s.UnstableApiVersion.MSC3869)){e.next=5;break}throw new Error("The read_relations action is not supported by the client.");case 5:return u={event_id:t,rel_type:n,event_type:r,room_id:i,to:d,from:c,limit:o,direction:l},e.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC3869ReadRelations,u));case 7:case"end":return e.stop()}}),e,this)}))),function(e,t,i,n,r,s,o,a){return E.apply(this,arguments)})},{key:"readStateEvents",value:function(e,t,i,n){var r={type:e,state_key:void 0===i||i};return void 0!==t&&(r.limit=t),n&&(n.includes(h.Symbols.AnyRoom)?r.room_ids=h.Symbols.AnyRoom:r.room_ids=n),this.transport.send(a.WidgetApiFromWidgetAction.MSC2876ReadEvents,r).then((function(e){return e.events}))}},{key:"setModalButtonEnabled",value:function(e,t){if(e===l.BuiltInModalButtonID.Close)throw new Error("The close button cannot be disabled");return this.transport.send(a.WidgetApiFromWidgetAction.SetModalButtonEnabled,{button:e,enabled:t}).then()}},{key:"navigateTo",value:function(e){if(!e||!e.startsWith("https://matrix.to/#"))throw new Error("Invalid matrix.to URI");return this.transport.send(a.WidgetApiFromWidgetAction.MSC2931Navigate,{uri:e}).then()}},{key:"getTurnServers",value:function(){var e,t=this;return(e=p().mark((function e(){var i,n;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=function(){var e=v(p().mark((function e(n){return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n.preventDefault(),i(n.detail.data),e.next=4,t.transport.reply(n.detail,{});case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),t.on("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),n),0!==t.turnServerWatchers){e.next=12;break}return e.prev=3,e.next=6,I(t.transport.send(a.WidgetApiFromWidgetAction.WatchTurnServers,{}));case 6:e.next=12;break;case 8:throw e.prev=8,e.t0=e.catch(3),t.off("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),n),e.t0;case 12:t.turnServerWatchers++,e.prev=13;case 14:return e.next=17,I(new Promise((function(e){return i=e})));case 17:return e.next=19,e.sent;case 19:e.next=14;break;case 21:if(e.prev=21,t.off("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),n),t.turnServerWatchers--,0!==t.turnServerWatchers){e.next=27;break}return e.next=27,I(t.transport.send(a.WidgetApiFromWidgetAction.UnwatchTurnServers,{}));case 27:return e.finish(21);case 28:case"end":return e.stop()}}),e,null,[[3,8],[13,,21,28]])})),function(){return new k(e.apply(this,arguments))})()}},{key:"searchUserDirectory",value:(w=v(p().mark((function e(t,i){var n;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(s.UnstableApiVersion.MSC3973)){e.next=5;break}throw new Error("The user_directory_search action is not supported by the client.");case 5:return n={search_term:t,limit:i},e.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch,n));case 7:case"end":return e.stop()}}),e,this)}))),function(e,t){return w.apply(this,arguments)})},{key:"getMediaConfig",value:(g=v(p().mark((function e(){var t;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(s.UnstableApiVersion.MSC4039)){e.next=5;break}throw new Error("The get_media_config action is not supported by the client.");case 5:return t={},e.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction,t));case 7:case"end":return e.stop()}}),e,this)}))),function(){return g.apply(this,arguments)})},{key:"uploadFile",value:(m=v(p().mark((function e(t){var i;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(s.UnstableApiVersion.MSC4039)){e.next=5;break}throw new Error("The upload_file action is not supported by the client.");case 5:return i={file:t},e.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC4039UploadFileAction,i));case 7:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"start",value:function(){var e=this;this.transport.start(),this.getClientVersions().then((function(t){t.includes(s.UnstableApiVersion.MSC2974)&&(e.supportsMSC2974Renegotiate=!0)}))}},{key:"handleMessage",value:function(e){var t=new CustomEvent("action:".concat(e.detail.action),{detail:e.detail,cancelable:!0});if(this.emit("action:".concat(e.detail.action),t),!t.defaultPrevented)switch(e.detail.action){case a.WidgetApiToWidgetAction.SupportedApiVersions:return this.replyVersions(e.detail);case a.WidgetApiToWidgetAction.Capabilities:return this.handleCapabilities(e.detail);case a.WidgetApiToWidgetAction.UpdateVisibility:case a.WidgetApiToWidgetAction.NotifyCapabilities:return this.transport.reply(e.detail,{});default:return this.transport.reply(e.detail,{error:{message:"Unknown or unsupported action: "+e.detail.action}})}}},{key:"replyVersions",value:function(e){this.transport.reply(e,{supported_versions:s.CurrentApiVersions})}},{key:"getClientVersions",value:function(){var e=this;return Array.isArray(this.cachedClientVersions)?Promise.resolve(this.cachedClientVersions):this.transport.send(a.WidgetApiFromWidgetAction.SupportedApiVersions,{}).then((function(t){return e.cachedClientVersions=t.supported_versions,t.supported_versions})).catch((function(e){return console.warn("non-fatal error getting supported client versions: ",e),[]}))}},{key:"handleCapabilities",value:function(e){var t=this;return this.capabilitiesFinished?this.transport.reply(e,{error:{message:"Capability negotiation already completed"}}):this.getClientVersions().then((function(i){return i.includes(s.UnstableApiVersion.MSC2871)?t.once("action:".concat(a.WidgetApiToWidgetAction.NotifyCapabilities),(function(e){t.approvedCapabilities=e.detail.data.approved,t.emit("ready")})):t.emit("ready"),t.capabilitiesFinished=!0,t.transport.reply(e,{capabilities:t.requestedCapabilities})}))}}],i&&f(t.prototype,i),n&&f(t,n),Object.defineProperty(t,"prototype",{writable:!1}),T}(n.EventEmitter);t.WidgetApi=T},"./node_modules/matrix-widget-api/lib/driver/WidgetDriver.js":(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetDriver=void 0;var n=i("./node_modules/matrix-widget-api/lib/index.js");function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}function s(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,(s=n.key,o=void 0,o=function(e,t){if("object"!==r(e)||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!==r(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(s,"string"),"symbol"===r(o)?o:String(o)),n)}var s,o}var o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i,r;return t=e,(i=[{key:"validateCapabilities",value:function(e){return Promise.resolve(new Set)}},{key:"sendEvent",value:function(e,t){return Promise.reject(new Error("Failed to override function"))}},{key:"sendToDevice",value:function(e,t,i){return Promise.reject(new Error("Failed to override function"))}},{key:"readRoomAccountData",value:function(e){return Promise.resolve([])}},{key:"readRoomEvents",value:function(e,t,i){return Promise.resolve([])}},{key:"readStateEvents",value:function(e,t,i){return Promise.resolve([])}},{key:"readEventRelations",value:function(e,t,i,n,r,s,o,a){return Promise.resolve({chunk:[]})}},{key:"askOpenID",value:function(e){e.update({state:n.OpenIDRequestState.Blocked})}},{key:"navigate",value:function(e){throw new Error("Navigation is not implemented")}},{key:"getTurnServers",value:function(){throw new Error("TURN server support is not implemented")}},{key:"searchUserDirectory",value:function(e,t){return Promise.resolve({limited:!1,results:[]})}},{key:"getMediaConfig",value:function(){throw new Error("Get media config is not implemented")}},{key:"uploadFile",value:function(e){throw new Error("Upload file is not implemented")}}])&&s(t.prototype,i),r&&s(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();t.WidgetDriver=o},"./node_modules/matrix-widget-api/lib/index.js":(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=i("./node_modules/matrix-widget-api/lib/WidgetApi.js");Object.keys(n).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===n[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return n[e]}}))}));var r=i("./node_modules/matrix-widget-api/lib/ClientWidgetApi.js");Object.keys(r).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===r[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return r[e]}}))}));var s=i("./node_modules/matrix-widget-api/lib/Symbols.js");Object.keys(s).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===s[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))}));var o=i("./node_modules/matrix-widget-api/lib/transport/ITransport.js");Object.keys(o).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===o[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}}))}));var a=i("./node_modules/matrix-widget-api/lib/transport/PostmessageTransport.js");Object.keys(a).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))}));var c=i("./node_modules/matrix-widget-api/lib/interfaces/ICustomWidgetData.js");Object.keys(c).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===c[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return c[e]}}))}));var d=i("./node_modules/matrix-widget-api/lib/interfaces/IJitsiWidgetData.js");Object.keys(d).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===d[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}}))}));var l=i("./node_modules/matrix-widget-api/lib/interfaces/IStickerpickerWidgetData.js");Object.keys(l).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===l[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}}))}));var u=i("./node_modules/matrix-widget-api/lib/interfaces/IWidget.js");Object.keys(u).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===u[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return u[e]}}))}));var h=i("./node_modules/matrix-widget-api/lib/interfaces/WidgetType.js");Object.keys(h).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===h[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return h[e]}}))}));var m=i("./node_modules/matrix-widget-api/lib/interfaces/IWidgetApiErrorResponse.js");Object.keys(m).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===m[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return m[e]}}))}));var p=i("./node_modules/matrix-widget-api/lib/interfaces/IWidgetApiRequest.js");Object.keys(p).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===p[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return p[e]}}))}));var g=i("./node_modules/matrix-widget-api/lib/interfaces/IWidgetApiResponse.js");Object.keys(g).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===g[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return g[e]}}))}));var v=i("./node_modules/matrix-widget-api/lib/interfaces/WidgetApiAction.js");Object.keys(v).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===v[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return v[e]}}))}));var f=i("./node_modules/matrix-widget-api/lib/interfaces/WidgetApiDirection.js");Object.keys(f).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===f[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return f[e]}}))}));var y=i("./node_modules/matrix-widget-api/lib/interfaces/ApiVersion.js");Object.keys(y).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===y[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return y[e]}}))}));var b=i("./node_modules/matrix-widget-api/lib/interfaces/Capabilities.js");Object.keys(b).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===b[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return b[e]}}))}));var S=i("./node_modules/matrix-widget-api/lib/interfaces/CapabilitiesAction.js");Object.keys(S).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===S[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return S[e]}}))}));var w=i("./node_modules/matrix-widget-api/lib/interfaces/ContentLoadedAction.js");Object.keys(w).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===w[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return w[e]}}))}));var _=i("./node_modules/matrix-widget-api/lib/interfaces/ScreenshotAction.js");Object.keys(_).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===_[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return _[e]}}))}));var E=i("./node_modules/matrix-widget-api/lib/interfaces/StickerAction.js");Object.keys(E).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===E[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return E[e]}}))}));var I=i("./node_modules/matrix-widget-api/lib/interfaces/StickyAction.js");Object.keys(I).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===I[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return I[e]}}))}));var k=i("./node_modules/matrix-widget-api/lib/interfaces/SupportedVersionsAction.js");Object.keys(k).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===k[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return k[e]}}))}));var R=i("./node_modules/matrix-widget-api/lib/interfaces/VisibilityAction.js");Object.keys(R).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===R[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return R[e]}}))}));var T=i("./node_modules/matrix-widget-api/lib/interfaces/GetOpenIDAction.js");Object.keys(T).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===T[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return T[e]}}))}));var C=i("./node_modules/matrix-widget-api/lib/interfaces/OpenIDCredentialsAction.js");Object.keys(C).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===C[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return C[e]}}))}));var A=i("./node_modules/matrix-widget-api/lib/interfaces/WidgetKind.js");Object.keys(A).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===A[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return A[e]}}))}));var O=i("./node_modules/matrix-widget-api/lib/interfaces/ModalButtonKind.js");Object.keys(O).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===O[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return O[e]}}))}));var x=i("./node_modules/matrix-widget-api/lib/interfaces/ModalWidgetActions.js");Object.keys(x).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===x[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return x[e]}}))}));var M=i("./node_modules/matrix-widget-api/lib/interfaces/SetModalButtonEnabledAction.js");Object.keys(M).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===M[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return M[e]}}))}));var P=i("./node_modules/matrix-widget-api/lib/interfaces/WidgetConfigAction.js");Object.keys(P).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===P[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return P[e]}}))}));var j=i("./node_modules/matrix-widget-api/lib/interfaces/SendEventAction.js");Object.keys(j).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===j[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return j[e]}}))}));var D=i("./node_modules/matrix-widget-api/lib/interfaces/SendToDeviceAction.js");Object.keys(D).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===D[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return D[e]}}))}));var U=i("./node_modules/matrix-widget-api/lib/interfaces/ReadEventAction.js");Object.keys(U).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===U[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return U[e]}}))}));var L=i("./node_modules/matrix-widget-api/lib/interfaces/IRoomEvent.js");Object.keys(L).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===L[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return L[e]}}))}));var N=i("./node_modules/matrix-widget-api/lib/interfaces/IRoomAccountData.js");Object.keys(N).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===N[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return N[e]}}))}));var B=i("./node_modules/matrix-widget-api/lib/interfaces/NavigateAction.js");Object.keys(B).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===B[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return B[e]}}))}));var F=i("./node_modules/matrix-widget-api/lib/interfaces/TurnServerActions.js");Object.keys(F).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===F[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return F[e]}}))}));var K=i("./node_modules/matrix-widget-api/lib/interfaces/ReadRelationsAction.js");Object.keys(K).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===K[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return K[e]}}))}));var $=i("./node_modules/matrix-widget-api/lib/interfaces/GetMediaConfigAction.js");Object.keys($).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===$[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return $[e]}}))}));var q=i("./node_modules/matrix-widget-api/lib/interfaces/UploadFileAction.js");Object.keys(q).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===q[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return q[e]}}))}));var V=i("./node_modules/matrix-widget-api/lib/models/WidgetEventCapability.js");Object.keys(V).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===V[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return V[e]}}))}));var G=i("./node_modules/matrix-widget-api/lib/models/validation/url.js");Object.keys(G).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===G[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return G[e]}}))}));var W=i("./node_modules/matrix-widget-api/lib/models/validation/utils.js");Object.keys(W).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===W[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return W[e]}}))}));var H=i("./node_modules/matrix-widget-api/lib/models/Widget.js");Object.keys(H).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===H[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return H[e]}}))}));var J=i("./node_modules/matrix-widget-api/lib/models/WidgetParser.js");Object.keys(J).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===J[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return J[e]}}))}));var z=i("./node_modules/matrix-widget-api/lib/templating/url-template.js");Object.keys(z).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===z[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return z[e]}}))}));var Q=i("./node_modules/matrix-widget-api/lib/util/SimpleObservable.js");Object.keys(Q).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===Q[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return Q[e]}}))}));var Y=i("./node_modules/matrix-widget-api/lib/driver/WidgetDriver.js");Object.keys(Y).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===Y[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return Y[e]}}))}))},"./node_modules/matrix-widget-api/lib/interfaces/ApiVersion.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UnstableApiVersion=t.MatrixApiVersion=t.CurrentApiVersions=void 0;var i=function(e){return e.Prerelease1="0.0.1",e.Prerelease2="0.0.2",e}({});t.MatrixApiVersion=i;var n=function(e){return e.MSC2762="org.matrix.msc2762",e.MSC2871="org.matrix.msc2871",e.MSC2931="org.matrix.msc2931",e.MSC2974="org.matrix.msc2974",e.MSC2876="org.matrix.msc2876",e.MSC3819="org.matrix.msc3819",e.MSC3846="town.robin.msc3846",e.MSC3869="org.matrix.msc3869",e.MSC3973="org.matrix.msc3973",e.MSC4039="org.matrix.msc4039",e}({});t.UnstableApiVersion=n;var r=[i.Prerelease1,i.Prerelease2,n.MSC2762,n.MSC2871,n.MSC2931,n.MSC2974,n.MSC2876,n.MSC3819,n.MSC3846,n.MSC3869,n.MSC3973,n.MSC4039];t.CurrentApiVersions=r},"./node_modules/matrix-widget-api/lib/interfaces/Capabilities.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VideoConferenceCapabilities=t.StickerpickerCapabilities=t.MatrixCapabilities=void 0,t.getTimelineRoomIDFromCapability=function(e){return e.substring(e.indexOf(":")+1)},t.isTimelineCapability=function(e){return null==e?void 0:e.startsWith("org.matrix.msc2762.timeline:")},t.isTimelineCapabilityFor=function(e,t){return e==="org.matrix.msc2762.timeline:".concat(t)};var i=function(e){return e.Screenshots="m.capability.screenshot",e.StickerSending="m.sticker",e.AlwaysOnScreen="m.always_on_screen",e.RequiresClient="io.element.requires_client",e.MSC2931Navigate="org.matrix.msc2931.navigate",e.MSC3846TurnServers="town.robin.msc3846.turn_servers",e.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",e.MSC4039UploadFile="org.matrix.msc4039.upload_file",e}({});t.MatrixCapabilities=i;var n=[i.StickerSending];t.StickerpickerCapabilities=n;var r=[i.AlwaysOnScreen];t.VideoConferenceCapabilities=r},"./node_modules/matrix-widget-api/lib/interfaces/CapabilitiesAction.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/ContentLoadedAction.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/GetMediaConfigAction.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/GetOpenIDAction.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OpenIDRequestState=void 0;var i=function(e){return e.Allowed="allowed",e.Blocked="blocked",e.PendingUserConfirmation="request",e}({});t.OpenIDRequestState=i},"./node_modules/matrix-widget-api/lib/interfaces/ICustomWidgetData.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/IJitsiWidgetData.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/IRoomAccountData.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/IRoomEvent.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/IStickerpickerWidgetData.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/IWidget.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/IWidgetApiErrorResponse.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isErrorResponse=function(e){if("error"in e){return!!e.error.message}return!1}},"./node_modules/matrix-widget-api/lib/interfaces/IWidgetApiRequest.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/IWidgetApiResponse.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/ModalButtonKind.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModalButtonKind=void 0;var i=function(e){return e.Primary="m.primary",e.Secondary="m.secondary",e.Warning="m.warning",e.Danger="m.danger",e.Link="m.link",e}({});t.ModalButtonKind=i},"./node_modules/matrix-widget-api/lib/interfaces/ModalWidgetActions.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BuiltInModalButtonID=void 0;var i=function(e){return e.Close="m.close",e}({});t.BuiltInModalButtonID=i},"./node_modules/matrix-widget-api/lib/interfaces/NavigateAction.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/OpenIDCredentialsAction.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/ReadEventAction.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/ReadRelationsAction.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/ScreenshotAction.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/SendEventAction.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/SendToDeviceAction.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/SetModalButtonEnabledAction.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/StickerAction.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/StickyAction.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/SupportedVersionsAction.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/TurnServerActions.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/UploadFileAction.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/VisibilityAction.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/WidgetApiAction.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetApiToWidgetAction=t.WidgetApiFromWidgetAction=void 0;var i=function(e){return e.SupportedApiVersions="supported_api_versions",e.Capabilities="capabilities",e.NotifyCapabilities="notify_capabilities",e.TakeScreenshot="screenshot",e.UpdateVisibility="visibility",e.OpenIDCredentials="openid_credentials",e.WidgetConfig="widget_config",e.CloseModalWidget="close_modal",e.ButtonClicked="button_clicked",e.SendEvent="send_event",e.SendToDevice="send_to_device",e.UpdateTurnServers="update_turn_servers",e}({});t.WidgetApiToWidgetAction=i;var n=function(e){return e.SupportedApiVersions="supported_api_versions",e.ContentLoaded="content_loaded",e.SendSticker="m.sticker",e.UpdateAlwaysOnScreen="set_always_on_screen",e.GetOpenIDCredentials="get_openid",e.CloseModalWidget="close_modal",e.OpenModalWidget="open_modal",e.SetModalButtonEnabled="set_button_enabled",e.SendEvent="send_event",e.SendToDevice="send_to_device",e.WatchTurnServers="watch_turn_servers",e.UnwatchTurnServers="unwatch_turn_servers",e.BeeperReadRoomAccountData="com.beeper.read_room_account_data",e.MSC2876ReadEvents="org.matrix.msc2876.read_events",e.MSC2931Navigate="org.matrix.msc2931.navigate",e.MSC2974RenegotiateCapabilities="org.matrix.msc2974.request_capabilities",e.MSC3869ReadRelations="org.matrix.msc3869.read_relations",e.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",e.MSC4039GetMediaConfigAction="org.matrix.msc4039.get_media_config",e.MSC4039UploadFileAction="org.matrix.msc4039.upload_file",e}({});t.WidgetApiFromWidgetAction=n},"./node_modules/matrix-widget-api/lib/interfaces/WidgetApiDirection.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetApiDirection=void 0,t.invertedDirection=function(e){if(e===i.ToWidget)return i.FromWidget;if(e===i.FromWidget)return i.ToWidget;throw new Error("Invalid direction")};var i=function(e){return e.ToWidget="toWidget",e.FromWidget="fromWidget",e}({});t.WidgetApiDirection=i},"./node_modules/matrix-widget-api/lib/interfaces/WidgetConfigAction.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/WidgetKind.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetKind=void 0;var i=function(e){return e.Room="room",e.Account="account",e.Modal="modal",e}({});t.WidgetKind=i},"./node_modules/matrix-widget-api/lib/interfaces/WidgetType.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixWidgetType=void 0;var i=function(e){return e.Custom="m.custom",e.JitsiMeet="m.jitsi",e.Stickerpicker="m.stickerpicker",e}({});t.MatrixWidgetType=i},"./node_modules/matrix-widget-api/lib/models/Widget.js":(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Widget=void 0;var n=i("./node_modules/matrix-widget-api/lib/models/validation/utils.js"),r=i("./node_modules/matrix-widget-api/lib/index.js");function s(e){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s(e)}function o(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,(r=n.key,o=void 0,o=function(e,t){if("object"!==s(e)||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!==s(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(r,"string"),"symbol"===s(o)?o:String(o)),n)}var r,o}var a=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.definition=t,!this.definition)throw new Error("Definition is required");(0,n.assertPresent)(t,"id"),(0,n.assertPresent)(t,"creatorUserId"),(0,n.assertPresent)(t,"type"),(0,n.assertPresent)(t,"url")}var t,i,s;return t=e,(i=[{key:"creatorUserId",get:function(){return this.definition.creatorUserId}},{key:"type",get:function(){return this.definition.type}},{key:"id",get:function(){return this.definition.id}},{key:"name",get:function(){return this.definition.name||null}},{key:"title",get:function(){return this.rawData.title||null}},{key:"templateUrl",get:function(){return this.definition.url}},{key:"origin",get:function(){return new URL(this.templateUrl).origin}},{key:"waitForIframeLoad",get:function(){return!1!==this.definition.waitForIframeLoad&&(this.definition.waitForIframeLoad,!0)}},{key:"rawData",get:function(){return this.definition.data||{}}},{key:"getCompleteUrl",value:function(e){return(0,r.runTemplate)(this.templateUrl,this.definition,e)}}])&&o(t.prototype,i),s&&o(t,s),Object.defineProperty(t,"prototype",{writable:!1}),e}();t.Widget=a},"./node_modules/matrix-widget-api/lib/models/WidgetEventCapability.js":(e,t)=>{"use strict";function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}function n(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=function(e,t){if(!e)return;if("string"==typeof e)return r(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);"Object"===i&&e.constructor&&(i=e.constructor.name);if("Map"===i||"Set"===i)return Array.from(e);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return r(e,t)}(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var n=0,s=function(){};return{s,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,c=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return a=e.done,e},e:function(e){c=!0,o=e},f:function(){try{a||null==i.return||i.return()}finally{if(c)throw o}}}}function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,(s=r.key,o=void 0,o=function(e,t){if("object"!==i(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!==i(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(s,"string"),"symbol"===i(o)?o:String(o)),r)}var s,o}Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetEventCapability=t.EventKind=t.EventDirection=void 0;var o=function(e){return e.Event="event",e.State="state_event",e.ToDevice="to_device",e.RoomAccount="room_account",e}({});t.EventKind=o;var a=function(e){return e.Send="send",e.Receive="receive",e}({});t.EventDirection=a;var c=function(){function e(t,i,n,r,s){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.direction=t,this.eventType=i,this.kind=n,this.keyStr=r,this.raw=s}var t,i,r;return t=e,i=[{key:"matchesAsStateEvent",value:function(e,t,i){return this.kind===o.State&&this.direction===e&&this.eventType===t&&(null===this.keyStr||this.keyStr===i)}},{key:"matchesAsToDeviceEvent",value:function(e,t){return this.kind===o.ToDevice&&this.direction===e&&this.eventType===t}},{key:"matchesAsRoomEvent",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return this.kind===o.Event&&this.direction===e&&this.eventType===t&&("m.room.message"!==this.eventType||null===this.keyStr||this.keyStr===i)}},{key:"matchesAsRoomAccountData",value:function(e,t){return this.kind===o.RoomAccount&&this.direction===e&&this.eventType===t}}],r=[{key:"forStateEvent",value:function(t,i,n){i=i.replace(/#/g,"\\#"),n=null!=n?"#".concat(n):"";var r="org.matrix.msc2762.".concat(t,".state_event:").concat(i).concat(n);return e.findEventCapabilities([r])[0]}},{key:"forToDeviceEvent",value:function(t,i){var n="org.matrix.msc3819.".concat(t,".to_device:").concat(i);return e.findEventCapabilities([n])[0]}},{key:"forRoomEvent",value:function(t,i){var n="org.matrix.msc2762.".concat(t,".event:").concat(i);return e.findEventCapabilities([n])[0]}},{key:"forRoomMessageEvent",value:function(t,i){i=null==i?"":i;var n="org.matrix.msc2762.".concat(t,".event:m.room.message#").concat(i);return e.findEventCapabilities([n])[0]}},{key:"forRoomAccountData",value:function(t,i){var n="com.beeper.capabilities.".concat(t,".room_account_data:").concat(i);return e.findEventCapabilities([n])[0]}},{key:"findEventCapabilities",value:function(t){var i,r=[],s=n(t);try{for(s.s();!(i=s.n()).done;){var c=i.value,d=null,l=void 0,u=null;if(c.startsWith("org.matrix.msc2762.send.event:")?(d=a.Send,u=o.Event,l=c.substring(30)):c.startsWith("org.matrix.msc2762.send.state_event:")?(d=a.Send,u=o.State,l=c.substring(36)):c.startsWith("org.matrix.msc3819.send.to_device:")?(d=a.Send,u=o.ToDevice,l=c.substring(34)):c.startsWith("org.matrix.msc2762.receive.event:")?(d=a.Receive,u=o.Event,l=c.substring(33)):c.startsWith("org.matrix.msc2762.receive.state_event:")?(d=a.Receive,u=o.State,l=c.substring(39)):c.startsWith("org.matrix.msc3819.receive.to_device:")?(d=a.Receive,u=o.ToDevice,l=c.substring(37)):c.startsWith("com.beeper.capabilities.receive.room_account_data:")&&(d=a.Receive,u=o.RoomAccount,l=c.substring(50)),null!==d&&null!==u&&void 0!==l){var h=l.startsWith("m.room.message#")||u===o.State,m=null;if(l.includes("#")&&h){var p=l.split("#"),g=p.findIndex((function(e){return!e.endsWith("\\")}));l=p.slice(0,g+1).map((function(e){return e.endsWith("\\")?e.substring(0,e.length-1):e})).join("#"),m=p.slice(g+1).join("#")}r.push(new e(d,l,u,m,c))}}}catch(e){s.e(e)}finally{s.f()}return r}}],i&&s(t.prototype,i),r&&s(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();t.WidgetEventCapability=c},"./node_modules/matrix-widget-api/lib/models/WidgetParser.js":(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetParser=void 0;var n=i("./node_modules/matrix-widget-api/lib/models/Widget.js"),r=i("./node_modules/matrix-widget-api/lib/models/validation/url.js");function s(e){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s(e)}function o(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=function(e,t){if(!e)return;if("string"==typeof e)return a(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);"Object"===i&&e.constructor&&(i=e.constructor.name);if("Map"===i||"Set"===i)return Array.from(e);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return a(e,t)}(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var n=0,r=function(){};return{s:r,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,o=!0,c=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return o=e.done,e},e:function(e){c=!0,s=e},f:function(){try{o||null==i.return||i.return()}finally{if(c)throw s}}}}function a(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function c(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,(r=n.key,o=void 0,o=function(e,t){if("object"!==s(e)||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!==s(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(r,"string"),"symbol"===s(o)?o:String(o)),n)}var r,o}var d=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i,s;return t=e,s=[{key:"parseAccountData",value:function(t){if(!t)return[];for(var i=[],n=0,r=Object.keys(t);n<r.length;n++){var s=r[n],o=t[s];if(o&&("m.widget"===o.type||"im.vector.modular.widgets"===o.type)&&o.sender&&(o.state_key||o.id)===s){var a={content:o.content,sender:o.sender,type:"m.widget",state_key:s,event_id:"$example",room_id:"!example",origin_server_ts:1},c=e.parseRoomWidget(a);c&&i.push(c)}}return i}},{key:"parseWidgetsFromRoomState",value:function(t){if(!t)return[];var i,n=[],r=o(t);try{for(r.s();!(i=r.n()).done;){var s=i.value,a=e.parseRoomWidget(s);a&&n.push(a)}}catch(e){r.e(e)}finally{r.f()}return n}},{key:"parseRoomWidget",value:function(t){if(!t)return null;if("m.widget"!==t.type&&"im.vector.modular.widgets"!==t.type)return null;var i=t.content||{},n={id:t.state_key,creatorUserId:i.creatorUserId||t.sender,name:i.name,type:i.type,url:i.url,waitForIframeLoad:i.waitForIframeLoad,data:i.data};return e.processEstimatedWidget(n)}},{key:"processEstimatedWidget",value:function(e){return e.id&&e.creatorUserId&&e.type&&(0,r.isValidUrl)(e.url)?new n.Widget(e):null}}],(i=null)&&c(t.prototype,i),s&&c(t,s),Object.defineProperty(t,"prototype",{writable:!1}),e}();t.WidgetParser=d},"./node_modules/matrix-widget-api/lib/models/validation/url.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isValidUrl=function(e){if(!e)return!1;try{var t=new URL(e);return"http"===t.protocol||"https"===t.protocol}catch(e){if(e instanceof TypeError)return!1;throw e}}},"./node_modules/matrix-widget-api/lib/models/validation/utils.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.assertPresent=function(e,t){if(!e[t])throw new Error("".concat(String(t)," is required"))}},"./node_modules/matrix-widget-api/lib/templating/url-template.js":(e,t)=>{"use strict";function i(e){return null==e?"".concat(e):String(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.runTemplate=function(e,t,n){for(var r=Object.assign({},t.data,{matrix_room_id:n.widgetRoomId||"",matrix_user_id:n.currentUserId,matrix_display_name:n.userDisplayName||n.currentUserId,matrix_avatar_url:n.userHttpAvatarUrl||"",matrix_widget_id:t.id,"org.matrix.msc2873.client_id":n.clientId||"","org.matrix.msc2873.client_theme":n.clientTheme||"","org.matrix.msc2873.client_language":n.clientLanguage||"","org.matrix.msc3819.matrix_device_id":n.deviceId||"","org.matrix.msc4039.matrix_base_url":n.baseUrl||""}),s=e,o=0,a=Object.keys(r);o<a.length;o++){var c=a[o],d="$".concat(c).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),l=new RegExp(d,"g");s=s.replace(l,encodeURIComponent(i(r[c])))}return s},t.toString=i},"./node_modules/matrix-widget-api/lib/transport/ITransport.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/transport/PostmessageTransport.js":(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PostmessageTransport=void 0;var n=i("./node_modules/events/events.js"),r=i("./node_modules/matrix-widget-api/lib/index.js");function s(e){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s(e)}function o(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function a(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?o(Object(i),!0).forEach((function(t){m(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):o(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function c(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,p(n.key),n)}}function d(e,t){return d=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},d(e,t)}function l(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,n=h(e);if(t){var r=h(this).constructor;i=Reflect.construct(n,arguments,r)}else i=n.apply(this,arguments);return function(e,t){if(t&&("object"===s(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return u(e)}(this,i)}}function u(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function h(e){return h=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},h(e)}function m(e,t,i){return(t=p(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function p(e){var t=function(e,t){if("object"!==s(e)||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!==s(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===s(t)?t:String(t)}var g=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&d(e,t)}(o,e);var t,i,n,s=l(o);function o(e,t,i,n){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),(r=s.call(this)).sendDirection=e,r.initialWidgetId=t,r.transportWindow=i,r.inboundWindow=n,m(u(r),"strictOriginCheck",!1),m(u(r),"targetOrigin","*"),m(u(r),"timeoutSeconds",10),m(u(r),"_ready",!1),m(u(r),"_widgetId",null),m(u(r),"outboundRequests",new Map),m(u(r),"stopController",new AbortController),r._widgetId=t,r}return t=o,(i=[{key:"ready",get:function(){return this._ready}},{key:"widgetId",get:function(){return this._widgetId||null}},{key:"nextRequestId",get:function(){for(var e="widgetapi-".concat(Date.now()),t=0,i=e;this.outboundRequests.has(i);)i="".concat(e,"-").concat(t++);return this.outboundRequests.set(i,null),i}},{key:"sendInternal",value:function(e){console.log("[PostmessageTransport] Sending object to ".concat(this.targetOrigin,": "),e),this.transportWindow.postMessage(e,this.targetOrigin)}},{key:"reply",value:function(e,t){return this.sendInternal(a(a({},e),{},{response:t}))}},{key:"send",value:function(e,t){return this.sendComplete(e,t).then((function(e){return e.response}))}},{key:"sendComplete",value:function(e,t){var i=this;if(!this.ready||!this.widgetId)return Promise.reject(new Error("Not ready or unknown widget ID"));var n={api:this.sendDirection,widgetId:this.widgetId,requestId:this.nextRequestId,action:e,data:t};return e===r.WidgetApiToWidgetAction.UpdateVisibility&&(n.visible=t.visible),new Promise((function(e,t){var r=function(e){a(),t(e)},s=setTimeout((function(){return r(new Error("Request timed out"))}),1e3*(i.timeoutSeconds||1)),o=function(){return r(new Error("Transport stopped"))};i.stopController.signal.addEventListener("abort",o);var a=function(){i.outboundRequests.delete(n.requestId),clearTimeout(s),i.stopController.signal.removeEventListener("abort",o)};i.outboundRequests.set(n.requestId,{request:n,resolve:function(t){a(),e(t)},reject:r}),i.sendInternal(n)}))}},{key:"start",value:function(){var e=this;this.inboundWindow.addEventListener("message",(function(t){e.handleMessage(t)})),this._ready=!0}},{key:"stop",value:function(){this._ready=!1,this.stopController.abort()}},{key:"handleMessage",value:function(e){if(!this.stopController.signal.aborted&&e.data&&(!this.strictOriginCheck||e.origin===window.origin)){var t=e.data;if(t.action&&t.requestId&&t.widgetId)if(t.response){if(t.api!==this.sendDirection)return;this.handleResponse(t)}else{var i=t;if(i.api!==(0,r.invertedDirection)(this.sendDirection))return;this.handleRequest(i)}}}},{key:"handleRequest",value:function(e){if(this.widgetId){if(this.widgetId!==e.widgetId)return}else this._widgetId=e.widgetId;this.emit("message",new CustomEvent("message",{detail:e}))}},{key:"handleResponse",value:function(e){if(e.widgetId===this.widgetId){var t=this.outboundRequests.get(e.requestId);if(t)if((0,r.isErrorResponse)(e.response)){var i=e.response;t.reject(new Error(i.error.message))}else t.resolve(e)}}}])&&c(t.prototype,i),n&&c(t,n),Object.defineProperty(t,"prototype",{writable:!1}),o}(n.EventEmitter);t.PostmessageTransport=g},"./node_modules/matrix-widget-api/lib/util/SimpleObservable.js":(e,t)=>{"use strict";function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}function n(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=function(e,t){if(!e)return;if("string"==typeof e)return r(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);"Object"===i&&e.constructor&&(i=e.constructor.name);if("Map"===i||"Set"===i)return Array.from(e);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return r(e,t)}(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var n=0,s=function(){};return{s,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,c=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return a=e.done,e},e:function(e){c=!0,o=e},f:function(){try{a||null==i.return||i.return()}finally{if(c)throw o}}}}function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function s(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,o(n.key),n)}}function o(e){var t=function(e,t){if("object"!==i(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!==i(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===i(t)?t:String(t)}Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleObservable=void 0;var a=function(){function e(t){var i,n,r;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i=this,r=[],(n=o(n="listeners"))in i?Object.defineProperty(i,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):i[n]=r,t&&this.listeners.push(t)}var t,i,r;return t=e,(i=[{key:"onUpdate",value:function(e){this.listeners.push(e)}},{key:"update",value:function(e){var t,i=n(this.listeners);try{for(i.s();!(t=i.n()).done;)(0,t.value)(e)}catch(e){i.e(e)}finally{i.f()}}},{key:"close",value:function(){this.listeners=[]}}])&&s(t.prototype,i),r&&s(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();t.SimpleObservable=a},"./node_modules/p-retry/index.js":(e,t,i)=>{"use strict";const n=i("./node_modules/retry/index.js"),r=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class s extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const o=(e,t)=>new Promise(((i,o)=>{t={onFailedAttempt:()=>{},retries:10,...t};const a=n.operation(t);a.attempt((async n=>{try{i(await e(n))}catch(e){if(!(e instanceof Error))return void o(new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`));if(e instanceof s)a.stop(),o(e.originalError);else if(e instanceof TypeError&&(c=e.message,!r.includes(c)))a.stop(),o(e);else{((e,t,i)=>{const n=i.retries-(t-1);e.attemptNumber=t,e.retriesLeft=n})(e,n,t);try{await t.onFailedAttempt(e)}catch(e){return void o(e)}a.retry(e)||o(a.mainError())}}var c}))}));e.exports=o,e.exports.default=o,e.exports.AbortError=s},"./node_modules/possible-typed-array-names/index.js":e=>{"use strict";e.exports=["Float32Array","Float64Array","Int8Array","Int16Array","Int32Array","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","BigInt64Array","BigUint64Array"]},"./node_modules/process/browser.js":e=>{var t,i,n=e.exports={};function r(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function o(e){if(t===setTimeout)return setTimeout(e,0);if((t===r||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(i){try{return t.call(null,e,0)}catch(i){return t.call(this,e,0)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:r}catch(e){t=r}try{i="function"==typeof clearTimeout?clearTimeout:s}catch(e){i=s}}();var a,c=[],d=!1,l=-1;function u(){d&&a&&(d=!1,a.length?c=a.concat(c):l=-1,c.length&&h())}function h(){if(!d){var e=o(u);d=!0;for(var t=c.length;t;){for(a=c,c=[];++l<t;)a&&a[l].run();l=-1,t=c.length}a=null,d=!1,function(e){if(i===clearTimeout)return clearTimeout(e);if((i===s||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(e);try{return i(e)}catch(t){try{return i.call(null,e)}catch(t){return i.call(this,e)}}}(e)}}function m(e,t){this.fun=e,this.array=t}function p(){}n.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];c.push(new m(e,t)),1!==c.length||d||o(h)},m.prototype.run=function(){this.fun.apply(null,this.array)},n.title="browser",n.browser=!0,n.env={},n.argv=[],n.version="",n.versions={},n.on=p,n.addListener=p,n.once=p,n.off=p,n.removeListener=p,n.removeAllListeners=p,n.emit=p,n.prependListener=p,n.prependOnceListener=p,n.listeners=function(e){return[]},n.binding=function(e){throw new Error("process.binding is not supported")},n.cwd=function(){return"/"},n.chdir=function(e){throw new Error("process.chdir is not supported")},n.umask=function(){return 0}},"./node_modules/retry/index.js":(e,t,i)=>{e.exports=i("./node_modules/retry/lib/retry.js")},"./node_modules/retry/lib/retry.js":(e,t,i)=>{var n=i("./node_modules/retry/lib/retry_operation.js");t.operation=function(e){var i=t.timeouts(e);return new n(i,{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var i in e)t[i]=e[i];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var n=[],r=0;r<t.retries;r++)n.push(this.createTimeout(r,t));return e&&e.forever&&!n.length&&n.push(this.createTimeout(r,t)),n.sort((function(e,t){return e-t})),n},t.createTimeout=function(e,t){var i=t.randomize?Math.random()+1:1,n=Math.round(i*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return n=Math.min(n,t.maxTimeout)},t.wrap=function(e,i,n){if(i instanceof Array&&(n=i,i=null),!n)for(var r in n=[],e)"function"==typeof e[r]&&n.push(r);for(var s=0;s<n.length;s++){var o=n[s],a=e[o];e[o]=function(n){var r=t.operation(i),s=Array.prototype.slice.call(arguments,1),o=s.pop();s.push((function(e){r.retry(e)||(e&&(arguments[0]=r.mainError()),o.apply(this,arguments))})),r.attempt((function(){n.apply(e,s)}))}.bind(e,a),e[o].options=i}}},"./node_modules/retry/lib/retry_operation.js":e=>{function t(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}e.exports=t,t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},t.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var i=this._timeouts.shift();if(void 0===i){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),i=this._cachedTimeouts.slice(-1)}var n=this;return this._timer=setTimeout((function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout((function(){n._operationTimeoutCb(n._attempts)}),n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)}),i),this._options.unref&&this._timer.unref(),!0},t.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var i=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){i._operationTimeoutCb()}),i._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},t.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},t.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},t.prototype.start=t.prototype.try,t.prototype.errors=function(){return this._errors},t.prototype.attempts=function(){return this._attempts},t.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,i=0,n=0;n<this._errors.length;n++){var r=this._errors[n],s=r.message,o=(e[s]||0)+1;e[s]=o,o>=i&&(t=r,i=o)}return t}},"./node_modules/sdp-transform/lib/grammar.js":e=>{var t=e.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(t).forEach((function(e){t[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}))},"./node_modules/sdp-transform/lib/index.js":(e,t,i)=>{var n=i("./node_modules/sdp-transform/lib/parser.js"),r=i("./node_modules/sdp-transform/lib/writer.js");t.M9=r,t.qg=n.parse,n.parseParams,n.parseFmtpConfig,n.parsePayloads,n.parseRemoteCandidates,n.parseImageAttributes,n.parseSimulcastStreamList},"./node_modules/sdp-transform/lib/parser.js":(e,t,i)=>{var n=function(e){return String(Number(e))===e?Number(e):e},r=function(e,t,i){var r=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:r&&!t[e.name]&&(t[e.name]={});var s=e.push?{}:r?t[e.name]:t;!function(e,t,i,r){if(r&&!i)t[r]=n(e[1]);else for(var s=0;s<i.length;s+=1)null!=e[s+1]&&(t[i[s]]=n(e[s+1]))}(i.match(e.reg),s,e.names,e.name),e.push&&t[e.push].push(s)},s=i("./node_modules/sdp-transform/lib/grammar.js"),o=RegExp.prototype.test.bind(/^([a-z])=(.*)/);t.parse=function(e){var t={},i=[],n=t;return e.split(/(\r\n|\r|\n)/).filter(o).forEach((function(e){var t=e[0],o=e.slice(2);"m"===t&&(i.push({rtp:[],fmtp:[]}),n=i[i.length-1]);for(var a=0;a<(s[t]||[]).length;a+=1){var c=s[t][a];if(c.reg.test(o))return r(c,n,o)}})),t.media=i,t};var a=function(e,t){var i=t.split(/=(.+)/,2);return 2===i.length?e[i[0]]=n(i[1]):1===i.length&&t.length>1&&(e[i[0]]=void 0),e};t.parseParams=function(e){return e.split(/;\s?/).reduce(a,{})},t.parseFmtpConfig=t.parseParams,t.parsePayloads=function(e){return e.toString().split(" ").map(Number)},t.parseRemoteCandidates=function(e){for(var t=[],i=e.split(" ").map(n),r=0;r<i.length;r+=3)t.push({component:i[r],ip:i[r+1],port:i[r+2]});return t},t.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(a,{})}))},t.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var t,i=!1;return"~"!==e[0]?t=n(e):(t=n(e.substring(1,e.length)),i=!0),{scid:t,paused:i}}))}))}},"./node_modules/sdp-transform/lib/writer.js":(e,t,i)=>{var n=i("./node_modules/sdp-transform/lib/grammar.js"),r=/%[sdv%]/g,s=function(e){var t=1,i=arguments,n=i.length;return e.replace(r,(function(e){if(t>=n)return e;var r=i[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(r);case"%d":return Number(r);case"%v":return""}}))},o=function(e,t,i){var n=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var r=0;r<t.names.length;r+=1){var o=t.names[r];t.name?n.push(i[t.name][o]):n.push(i[t.names[r]])}else n.push(i[t.name]);return s.apply(null,n)},a=["v","o","s","i","u","e","p","c","b","t","r","z","a"],c=["i","c","b","a"];e.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var i=t.outerOrder||a,r=t.innerOrder||c,s=[];return i.forEach((function(t){n[t].forEach((function(i){i.name in e&&null!=e[i.name]?s.push(o(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){s.push(o(t,i,e))}))}))})),e.media.forEach((function(e){s.push(o("m",n.m[0],e)),r.forEach((function(t){n[t].forEach((function(i){i.name in e&&null!=e[i.name]?s.push(o(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){s.push(o(t,i,e))}))}))}))})),s.join("\r\n")+"\r\n"}},"./node_modules/set-function-length/index.js":(e,t,i)=>{"use strict";var n=i("./node_modules/get-intrinsic/index.js"),r=i("./node_modules/define-data-property/index.js"),s=i("./node_modules/has-property-descriptors/index.js")(),o=i("./node_modules/gopd/index.js"),a=i("./node_modules/es-errors/type.js"),c=n("%Math.floor%");e.exports=function(e,t){if("function"!=typeof e)throw new a("`fn` is not a function");if("number"!=typeof t||t<0||t>4294967295||c(t)!==t)throw new a("`length` must be a positive 32-bit integer");var i=arguments.length>2&&!!arguments[2],n=!0,d=!0;if("length"in e&&o){var l=o(e,"length");l&&!l.configurable&&(n=!1),l&&!l.writable&&(d=!1)}return(n||d||!i)&&(s?r(e,"length",t,!0,!0):r(e,"length",t)),e}},"./node_modules/unhomoglyph/index.js":(e,t,i)=>{"use strict";var n=i("./node_modules/unhomoglyph/data.json");var r=RegExp(Object.keys(n).map((function(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")})).join("|"),"g");function s(e){return n[e]}e.exports=function(e){return e.replace(r,s)}},"./node_modules/util/node_modules/is-typed-array/index.js":(e,t,i)=>{"use strict";var n=i("./node_modules/util/node_modules/is-typed-array/node_modules/which-typed-array/index.js");e.exports=function(e){return!!n(e)}},"./node_modules/util/node_modules/is-typed-array/node_modules/which-typed-array/index.js":(e,t,i)=>{"use strict";var n=i("./node_modules/for-each/index.js"),r=i("./node_modules/available-typed-arrays/index.js"),s=i("./node_modules/call-bind/index.js"),o=i("./node_modules/call-bind/callBound.js"),a=i("./node_modules/gopd/index.js"),c=o("Object.prototype.toString"),d=i("./node_modules/has-tostringtag/shams.js")(),l="undefined"==typeof globalThis?i.g:globalThis,u=r(),h=o("String.prototype.slice"),m=Object.getPrototypeOf,p=o("Array.prototype.indexOf",!0)||function(e,t){for(var i=0;i<e.length;i+=1)if(e[i]===t)return i;return-1},g={__proto__:null};n(u,d&&a&&m?function(e){var t=new l[e];if(Symbol.toStringTag in t){var i=m(t),n=a(i,Symbol.toStringTag);if(!n){var r=m(i);n=a(r,Symbol.toStringTag)}g["$"+e]=s(n.get)}}:function(e){var t=new l[e],i=t.slice||t.set;i&&(g["$"+e]=s(i))});e.exports=function(e){if(!e||"object"!=typeof e)return!1;if(!d){var t=h(c(e),8,-1);return p(u,t)>-1?t:"Object"===t&&function(e){var t=!1;return n(g,(function(i,n){if(!t)try{i(e),t=h(n,1)}catch(e){}})),t}(e)}return a?function(e){var t=!1;return n(g,(function(i,n){if(!t)try{"$"+i(e)===n&&(t=h(n,1))}catch(e){}})),t}(e):null}},"./node_modules/util/node_modules/which-typed-array/index.js":(e,t,i)=>{"use strict";var n=i("./node_modules/for-each/index.js"),r=i("./node_modules/available-typed-arrays/index.js"),s=i("./node_modules/call-bind/index.js"),o=i("./node_modules/call-bind/callBound.js"),a=i("./node_modules/gopd/index.js"),c=o("Object.prototype.toString"),d=i("./node_modules/has-tostringtag/shams.js")(),l="undefined"==typeof globalThis?i.g:globalThis,u=r(),h=o("String.prototype.slice"),m=Object.getPrototypeOf,p=o("Array.prototype.indexOf",!0)||function(e,t){for(var i=0;i<e.length;i+=1)if(e[i]===t)return i;return-1},g={__proto__:null};n(u,d&&a&&m?function(e){var t=new l[e];if(Symbol.toStringTag in t){var i=m(t),n=a(i,Symbol.toStringTag);if(!n){var r=m(i);n=a(r,Symbol.toStringTag)}g["$"+e]=s(n.get)}}:function(e){var t=new l[e],i=t.slice||t.set;i&&(g["$"+e]=s(i))});e.exports=function(e){if(!e||"object"!=typeof e)return!1;if(!d){var t=h(c(e),8,-1);return p(u,t)>-1?t:"Object"===t&&function(e){var t=!1;return n(g,(function(i,n){if(!t)try{i(e),t=h(n,1)}catch(e){}})),t}(e)}return a?function(e){var t=!1;return n(g,(function(i,n){if(!t)try{"$"+i(e)===n&&(t=h(n,1))}catch(e){}})),t}(e):null}},"./node_modules/util/support/isBufferBrowser.js":e=>{e.exports=function(e){return e&&"object"==typeof e&&"function"==typeof e.copy&&"function"==typeof e.fill&&"function"==typeof e.readUInt8}},"./node_modules/util/support/types.js":(e,t,i)=>{"use strict";var n=i("./node_modules/is-arguments/index.js"),r=i("./node_modules/is-generator-function/index.js"),s=i("./node_modules/util/node_modules/which-typed-array/index.js"),o=i("./node_modules/util/node_modules/is-typed-array/index.js");function a(e){return e.call.bind(e)}var c="undefined"!=typeof BigInt,d="undefined"!=typeof Symbol,l=a(Object.prototype.toString),u=a(Number.prototype.valueOf),h=a(String.prototype.valueOf),m=a(Boolean.prototype.valueOf);if(c)var p=a(BigInt.prototype.valueOf);if(d)var g=a(Symbol.prototype.valueOf);function v(e,t){if("object"!=typeof e)return!1;try{return t(e),!0}catch(e){return!1}}function f(e){return"[object Map]"===l(e)}function y(e){return"[object Set]"===l(e)}function b(e){return"[object WeakMap]"===l(e)}function S(e){return"[object WeakSet]"===l(e)}function w(e){return"[object ArrayBuffer]"===l(e)}function _(e){return"undefined"!=typeof ArrayBuffer&&(w.working?w(e):e instanceof ArrayBuffer)}function E(e){return"[object DataView]"===l(e)}function I(e){return"undefined"!=typeof DataView&&(E.working?E(e):e instanceof DataView)}t.isArgumentsObject=n,t.isGeneratorFunction=r,t.isTypedArray=o,t.isPromise=function(e){return"undefined"!=typeof Promise&&e instanceof Promise||null!==e&&"object"==typeof e&&"function"==typeof e.then&&"function"==typeof e.catch},t.isArrayBufferView=function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):o(e)||I(e)},t.isUint8Array=function(e){return"Uint8Array"===s(e)},t.isUint8ClampedArray=function(e){return"Uint8ClampedArray"===s(e)},t.isUint16Array=function(e){return"Uint16Array"===s(e)},t.isUint32Array=function(e){return"Uint32Array"===s(e)},t.isInt8Array=function(e){return"Int8Array"===s(e)},t.isInt16Array=function(e){return"Int16Array"===s(e)},t.isInt32Array=function(e){return"Int32Array"===s(e)},t.isFloat32Array=function(e){return"Float32Array"===s(e)},t.isFloat64Array=function(e){return"Float64Array"===s(e)},t.isBigInt64Array=function(e){return"BigInt64Array"===s(e)},t.isBigUint64Array=function(e){return"BigUint64Array"===s(e)},f.working="undefined"!=typeof Map&&f(new Map),t.isMap=function(e){return"undefined"!=typeof Map&&(f.working?f(e):e instanceof Map)},y.working="undefined"!=typeof Set&&y(new Set),t.isSet=function(e){return"undefined"!=typeof Set&&(y.working?y(e):e instanceof Set)},b.working="undefined"!=typeof WeakMap&&b(new WeakMap),t.isWeakMap=function(e){return"undefined"!=typeof WeakMap&&(b.working?b(e):e instanceof WeakMap)},S.working="undefined"!=typeof WeakSet&&S(new WeakSet),t.isWeakSet=function(e){return S(e)},w.working="undefined"!=typeof ArrayBuffer&&w(new ArrayBuffer),t.isArrayBuffer=_,E.working="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView&&E(new DataView(new ArrayBuffer(1),0,1)),t.isDataView=I;var k="undefined"!=typeof SharedArrayBuffer?SharedArrayBuffer:void 0;function R(e){return"[object SharedArrayBuffer]"===l(e)}function T(e){return void 0!==k&&(void 0===R.working&&(R.working=R(new k)),R.working?R(e):e instanceof k)}function C(e){return v(e,u)}function A(e){return v(e,h)}function O(e){return v(e,m)}function x(e){return c&&v(e,p)}function M(e){return d&&v(e,g)}t.isSharedArrayBuffer=T,t.isAsyncFunction=function(e){return"[object AsyncFunction]"===l(e)},t.isMapIterator=function(e){return"[object Map Iterator]"===l(e)},t.isSetIterator=function(e){return"[object Set Iterator]"===l(e)},t.isGeneratorObject=function(e){return"[object Generator]"===l(e)},t.isWebAssemblyCompiledModule=function(e){return"[object WebAssembly.Module]"===l(e)},t.isNumberObject=C,t.isStringObject=A,t.isBooleanObject=O,t.isBigIntObject=x,t.isSymbolObject=M,t.isBoxedPrimitive=function(e){return C(e)||A(e)||O(e)||x(e)||M(e)},t.isAnyArrayBuffer=function(e){return"undefined"!=typeof Uint8Array&&(_(e)||T(e))},["isProxy","isExternal","isModuleNamespaceObject"].forEach((function(e){Object.defineProperty(t,e,{enumerable:!1,value:function(){throw new Error(e+" is not supported in userland")}})}))},"./node_modules/util/util.js":(e,t,i)=>{var n=i("./node_modules/process/browser.js"),r=Object.getOwnPropertyDescriptors||function(e){for(var t=Object.keys(e),i={},n=0;n<t.length;n++)i[t[n]]=Object.getOwnPropertyDescriptor(e,t[n]);return i},s=/%[sdj%]/g;t.format=function(e){if(!b(e)){for(var t=[],i=0;i<arguments.length;i++)t.push(d(arguments[i]));return t.join(" ")}i=1;for(var n=arguments,r=n.length,o=String(e).replace(s,(function(e){if("%%"===e)return"%";if(i>=r)return e;switch(e){case"%s":return String(n[i++]);case"%d":return Number(n[i++]);case"%j":try{return JSON.stringify(n[i++])}catch(e){return"[Circular]"}default:return e}})),a=n[i];i<r;a=n[++i])f(a)||!_(a)?o+=" "+a:o+=" "+d(a);return o},t.deprecate=function(e,i){if(void 0!==n&&!0===n.noDeprecation)return e;if(void 0===n)return function(){return t.deprecate(e,i).apply(this,arguments)};var r=!1;return function(){if(!r){if(n.throwDeprecation)throw new Error(i);n.traceDeprecation?console.trace(i):console.error(i),r=!0}return e.apply(this,arguments)}};var o={},a=/^$/;if(n.env.NODE_DEBUG){var c=n.env.NODE_DEBUG;c=c.replace(/[|\\{}()[\]^$+?.]/g,"\\$&").replace(/\*/g,".*").replace(/,/g,"$|^").toUpperCase(),a=new RegExp("^"+c+"$","i")}function d(e,i){var n={seen:[],stylize:u};return arguments.length>=3&&(n.depth=arguments[2]),arguments.length>=4&&(n.colors=arguments[3]),v(i)?n.showHidden=i:i&&t._extend(n,i),S(n.showHidden)&&(n.showHidden=!1),S(n.depth)&&(n.depth=2),S(n.colors)&&(n.colors=!1),S(n.customInspect)&&(n.customInspect=!0),n.colors&&(n.stylize=l),h(n,e,n.depth)}function l(e,t){var i=d.styles[t];return i?"["+d.colors[i][0]+"m"+e+"["+d.colors[i][1]+"m":e}function u(e,t){return e}function h(e,i,n){if(e.customInspect&&i&&k(i.inspect)&&i.inspect!==t.inspect&&(!i.constructor||i.constructor.prototype!==i)){var r=i.inspect(n,e);return b(r)||(r=h(e,r,n)),r}var s=function(e,t){if(S(t))return e.stylize("undefined","undefined");if(b(t)){var i="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(i,"string")}if(y(t))return e.stylize(""+t,"number");if(v(t))return e.stylize(""+t,"boolean");if(f(t))return e.stylize("null","null")}(e,i);if(s)return s;var o=Object.keys(i),a=function(e){var t={};return e.forEach((function(e,i){t[e]=!0})),t}(o);if(e.showHidden&&(o=Object.getOwnPropertyNames(i)),I(i)&&(o.indexOf("message")>=0||o.indexOf("description")>=0))return m(i);if(0===o.length){if(k(i)){var c=i.name?": "+i.name:"";return e.stylize("[Function"+c+"]","special")}if(w(i))return e.stylize(RegExp.prototype.toString.call(i),"regexp");if(E(i))return e.stylize(Date.prototype.toString.call(i),"date");if(I(i))return m(i)}var d,l="",u=!1,_=["{","}"];(g(i)&&(u=!0,_=["[","]"]),k(i))&&(l=" [Function"+(i.name?": "+i.name:"")+"]");return w(i)&&(l=" "+RegExp.prototype.toString.call(i)),E(i)&&(l=" "+Date.prototype.toUTCString.call(i)),I(i)&&(l=" "+m(i)),0!==o.length||u&&0!=i.length?n<0?w(i)?e.stylize(RegExp.prototype.toString.call(i),"regexp"):e.stylize("[Object]","special"):(e.seen.push(i),d=u?function(e,t,i,n,r){for(var s=[],o=0,a=t.length;o<a;++o)A(t,String(o))?s.push(p(e,t,i,n,String(o),!0)):s.push("");return r.forEach((function(r){r.match(/^\d+$/)||s.push(p(e,t,i,n,r,!0))})),s}(e,i,n,a,o):o.map((function(t){return p(e,i,n,a,t,u)})),e.seen.pop(),function(e,t,i){var n=e.reduce((function(e,t){return t.indexOf("\n")>=0&&0,e+t.replace(/\u001b\[\d\d?m/g,"").length+1}),0);if(n>60)return i[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+i[1];return i[0]+t+" "+e.join(", ")+" "+i[1]}(d,l,_)):_[0]+l+_[1]}function m(e){return"["+Error.prototype.toString.call(e)+"]"}function p(e,t,i,n,r,s){var o,a,c;if((c=Object.getOwnPropertyDescriptor(t,r)||{value:t[r]}).get?a=c.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):c.set&&(a=e.stylize("[Setter]","special")),A(n,r)||(o="["+r+"]"),a||(e.seen.indexOf(c.value)<0?(a=f(i)?h(e,c.value,null):h(e,c.value,i-1)).indexOf("\n")>-1&&(a=s?a.split("\n").map((function(e){return"  "+e})).join("\n").slice(2):"\n"+a.split("\n").map((function(e){return"   "+e})).join("\n")):a=e.stylize("[Circular]","special")),S(o)){if(s&&r.match(/^\d+$/))return a;(o=JSON.stringify(""+r)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(o=o.slice(1,-1),o=e.stylize(o,"name")):(o=o.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),o=e.stylize(o,"string"))}return o+": "+a}function g(e){return Array.isArray(e)}function v(e){return"boolean"==typeof e}function f(e){return null===e}function y(e){return"number"==typeof e}function b(e){return"string"==typeof e}function S(e){return void 0===e}function w(e){return _(e)&&"[object RegExp]"===R(e)}function _(e){return"object"==typeof e&&null!==e}function E(e){return _(e)&&"[object Date]"===R(e)}function I(e){return _(e)&&("[object Error]"===R(e)||e instanceof Error)}function k(e){return"function"==typeof e}function R(e){return Object.prototype.toString.call(e)}function T(e){return e<10?"0"+e.toString(10):e.toString(10)}t.debuglog=function(e){if(e=e.toUpperCase(),!o[e])if(a.test(e)){var i=n.pid;o[e]=function(){var n=t.format.apply(t,arguments);console.error("%s %d: %s",e,i,n)}}else o[e]=function(){};return o[e]},t.inspect=d,d.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},d.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},t.types=i("./node_modules/util/support/types.js"),t.isArray=g,t.isBoolean=v,t.isNull=f,t.isNullOrUndefined=function(e){return null==e},t.isNumber=y,t.isString=b,t.isSymbol=function(e){return"symbol"==typeof e},t.isUndefined=S,t.isRegExp=w,t.types.isRegExp=w,t.isObject=_,t.isDate=E,t.types.isDate=E,t.isError=I,t.types.isNativeError=I,t.isFunction=k,t.isPrimitive=function(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e},t.isBuffer=i("./node_modules/util/support/isBufferBrowser.js");var C=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function A(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.log=function(){var e,i;console.log("%s - %s",(e=new Date,i=[T(e.getHours()),T(e.getMinutes()),T(e.getSeconds())].join(":"),[e.getDate(),C[e.getMonth()],i].join(" ")),t.format.apply(t,arguments))},t.inherits=i("./node_modules/inherits/inherits_browser.js"),t._extend=function(e,t){if(!t||!_(t))return e;for(var i=Object.keys(t),n=i.length;n--;)e[i[n]]=t[i[n]];return e};var O="undefined"!=typeof Symbol?Symbol("util.promisify.custom"):void 0;function x(e,t){if(!e){var i=new Error("Promise was rejected with a falsy value");i.reason=e,e=i}return t(e)}t.promisify=function(e){if("function"!=typeof e)throw new TypeError('The "original" argument must be of type Function');if(O&&e[O]){var t;if("function"!=typeof(t=e[O]))throw new TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(t,O,{value:t,enumerable:!1,writable:!1,configurable:!0}),t}function t(){for(var t,i,n=new Promise((function(e,n){t=e,i=n})),r=[],s=0;s<arguments.length;s++)r.push(arguments[s]);r.push((function(e,n){e?i(e):t(n)}));try{e.apply(this,r)}catch(e){i(e)}return n}return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),O&&Object.defineProperty(t,O,{value:t,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(t,r(e))},t.promisify.custom=O,t.callbackify=function(e){if("function"!=typeof e)throw new TypeError('The "original" argument must be of type Function');function t(){for(var t=[],i=0;i<arguments.length;i++)t.push(arguments[i]);var r=t.pop();if("function"!=typeof r)throw new TypeError("The last argument must be of type Function");var s=this,o=function(){return r.apply(s,arguments)};e.apply(this,t).then((function(e){n.nextTick(o.bind(null,null,e))}),(function(e){n.nextTick(x.bind(null,e,o))}))}return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),Object.defineProperties(t,r(e)),t}},"./node_modules/uuid/dist/esm-browser/v4.js":(e,t,i)=>{"use strict";i.d(t,{A:()=>d});const n={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let r;const s=new Uint8Array(16);function o(){if(!r&&(r="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!r))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return r(s)}const a=[];for(let e=0;e<256;++e)a.push((e+256).toString(16).slice(1));function c(e,t=0){return a[e[t+0]]+a[e[t+1]]+a[e[t+2]]+a[e[t+3]]+"-"+a[e[t+4]]+a[e[t+5]]+"-"+a[e[t+6]]+a[e[t+7]]+"-"+a[e[t+8]]+a[e[t+9]]+"-"+a[e[t+10]]+a[e[t+11]]+a[e[t+12]]+a[e[t+13]]+a[e[t+14]]+a[e[t+15]]}const d=function(e,t,i){if(n.randomUUID&&!t&&!e)return n.randomUUID();const r=(e=e||{}).random||(e.rng||o)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){i=i||0;for(let e=0;e<16;++e)t[i+e]=r[e];return t}return c(r)}},"?50b8":()=>{},"./node_modules/available-typed-arrays/index.js":(e,t,i)=>{"use strict";var n=i("./node_modules/possible-typed-array-names/index.js"),r="undefined"==typeof globalThis?i.g:globalThis;e.exports=function(){for(var e=[],t=0;t<n.length;t++)"function"==typeof r[n[t]]&&(e[e.length]=n[t]);return e}},"./node_modules/@babel/runtime/helpers/esm/defineProperty.js":(e,t,i)=>{"use strict";i.d(t,{A:()=>r});var n=i("./node_modules/@babel/runtime/helpers/esm/toPropertyKey.js");function r(e,t,i){return(t=(0,n.A)(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}},"./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js":(e,t,i)=>{"use strict";function n(e,t){if(null==e)return{};var i,n,r=function(e,t){if(null==e)return{};var i={};for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){if(t.indexOf(n)>=0)continue;i[n]=e[n]}return i}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)i=s[n],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(r[i]=e[i])}return r}i.d(t,{A:()=>n})},"./node_modules/@babel/runtime/helpers/esm/toPrimitive.js":(e,t,i)=>{"use strict";i.d(t,{A:()=>r});var n=i("./node_modules/@babel/runtime/helpers/esm/typeof.js");function r(e,t){if("object"!=(0,n.A)(e)||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=(0,n.A)(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}},"./node_modules/@babel/runtime/helpers/esm/toPropertyKey.js":(e,t,i)=>{"use strict";i.d(t,{A:()=>s});var n=i("./node_modules/@babel/runtime/helpers/esm/typeof.js"),r=i("./node_modules/@babel/runtime/helpers/esm/toPrimitive.js");function s(e){var t=(0,r.A)(e,"string");return"symbol"==(0,n.A)(t)?t:t+""}},"./node_modules/@babel/runtime/helpers/esm/typeof.js":(e,t,i)=>{"use strict";function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}i.d(t,{A:()=>n})},"./node_modules/jwt-decode/build/esm/index.js":(e,t,i)=>{"use strict";class n extends Error{}n.prototype.name="InvalidTokenError"},"./node_modules/oidc-client-ts/dist/esm/oidc-client-ts.js":(e,t,i)=>{"use strict";i("./node_modules/jwt-decode/build/esm/index.js");var n,r,s,o={debug:()=>{},info:()=>{},warn:()=>{},error:()=>{}},a=(e=>(e[e.NONE=0]="NONE",e[e.ERROR=1]="ERROR",e[e.WARN=2]="WARN",e[e.INFO=3]="INFO",e[e.DEBUG=4]="DEBUG",e))(a||{});(s=a||(a={})).reset=function(){n=3,r=o},s.setLevel=function(e){if(!(0<=e&&e<=4))throw new Error("Invalid log level");n=e},s.setLogger=function(e){r=e};var c=class e{constructor(e){this._name=e}debug(...t){n>=4&&r.debug(e._format(this._name,this._method),...t)}info(...t){n>=3&&r.info(e._format(this._name,this._method),...t)}warn(...t){n>=2&&r.warn(e._format(this._name,this._method),...t)}error(...t){n>=1&&r.error(e._format(this._name,this._method),...t)}throw(e){throw this.error(e),e}create(e){const t=Object.create(this);return t._method=e,t.debug("begin"),t}static createStatic(t,i){const n=new e(`${t}.${i}`);return n.debug("begin"),n}static _format(e,t){const i=`[${e}]`;return t?`${i} ${t}:`:i}static debug(t,...i){n>=4&&r.debug(e._format(t),...i)}static info(t,...i){n>=3&&r.info(e._format(t),...i)}static warn(t,...i){n>=2&&r.warn(e._format(t),...i)}static error(t,...i){n>=1&&r.error(e._format(t),...i)}};a.reset();var d=e=>btoa([...new Uint8Array(e)].map((e=>String.fromCharCode(e))).join("")),l=class e{static _randomWord(){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]}static generateUUIDv4(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(t=>(+t^e._randomWord()&15>>+t/4).toString(16))).replace(/-/g,"")}static generateCodeVerifier(){return e.generateUUIDv4()+e.generateUUIDv4()+e.generateUUIDv4()}static async generateCodeChallenge(e){if(!crypto.subtle)throw new Error("Crypto.subtle is available only in secure contexts (HTTPS).");try{const t=(new TextEncoder).encode(e),i=await crypto.subtle.digest("SHA-256",t);return d(i).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch(e){throw c.error("CryptoUtils.generateCodeChallenge",e),e}}static generateBasicAuth(e,t){const i=(new TextEncoder).encode([e,t].join(":"));return d(i)}},u=class{constructor(e){this._name=e,this._logger=new c(`Event('${this._name}')`),this._callbacks=[]}addHandler(e){return this._callbacks.push(e),()=>this.removeHandler(e)}removeHandler(e){const t=this._callbacks.lastIndexOf(e);t>=0&&this._callbacks.splice(t,1)}async raise(...e){this._logger.debug("raise:",...e);for(const t of this._callbacks)await t(...e)}},h=class e extends u{constructor(){super(...arguments),this._logger=new c(`Timer('${this._name}')`),this._timerHandle=null,this._expiration=0,this._callback=()=>{const t=this._expiration-e.getEpochTime();this._logger.debug("timer completes in",t),this._expiration<=e.getEpochTime()&&(this.cancel(),super.raise())}}static getEpochTime(){return Math.floor(Date.now()/1e3)}init(t){const i=this._logger.create("init");t=Math.max(Math.floor(t),1);const n=e.getEpochTime()+t;if(this.expiration===n&&this._timerHandle)return void i.debug("skipping since already initialized for expiration at",this.expiration);this.cancel(),i.debug("using duration",t),this._expiration=n;const r=Math.min(t,5);this._timerHandle=setInterval(this._callback,1e3*r)}get expiration(){return this._expiration}cancel(){this._logger.create("cancel"),this._timerHandle&&(clearInterval(this._timerHandle),this._timerHandle=null)}},m=(Error,Error,class e{constructor(e){this.id=e.id||l.generateUUIDv4(),this.data=e.data,e.created&&e.created>0?this.created=e.created:this.created=h.getEpochTime(),this.request_type=e.request_type,this.url_state=e.url_state}toStorageString(){return new c("State").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state})}static fromStorageString(t){return c.createStatic("State","fromStorageString"),Promise.resolve(new e(JSON.parse(t)))}static async clearStaleState(t,i){const n=c.createStatic("State","clearStaleState"),r=h.getEpochTime()-i,s=await t.getAllKeys();n.debug("got keys",s);for(let i=0;i<s.length;i++){const o=s[i],a=await t.get(o);let c=!1;if(a)try{const t=await e.fromStorageString(a);n.debug("got item from key:",o,t.created),t.created<=r&&(c=!0)}catch(e){n.error("Error parsing state for key:",o,e),c=!0}else n.debug("no item in storage for key:",o),c=!0;c&&(n.debug("removed item for key:",o),t.remove(o))}}}),p=class e extends m{constructor(e){super(e),this.code_verifier=e.code_verifier,this.code_challenge=e.code_challenge,this.authority=e.authority,this.client_id=e.client_id,this.redirect_uri=e.redirect_uri,this.scope=e.scope,this.client_secret=e.client_secret,this.extraTokenParams=e.extraTokenParams,this.response_mode=e.response_mode,this.skipUserInfo=e.skipUserInfo}static async create(t){const i=!0===t.code_verifier?l.generateCodeVerifier():t.code_verifier||void 0,n=i?await l.generateCodeChallenge(i):void 0;return new e({...t,code_verifier:i,code_challenge:n})}toStorageString(){return new c("SigninState").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state,code_verifier:this.code_verifier,authority:this.authority,client_id:this.client_id,redirect_uri:this.redirect_uri,scope:this.scope,client_secret:this.client_secret,extraTokenParams:this.extraTokenParams,response_mode:this.response_mode,skipUserInfo:this.skipUserInfo})}static fromStorageString(t){c.createStatic("SigninState","fromStorageString");const i=JSON.parse(t);return e.create(i)}},g=class e{constructor(e){this.url=e.url,this.state=e.state}static async create({url:t,authority:i,client_id:n,redirect_uri:r,response_type:s,scope:o,state_data:a,response_mode:c,request_type:d,client_secret:l,nonce:u,url_state:h,resource:m,skipUserInfo:g,extraQueryParams:v,extraTokenParams:f,disablePKCE:y,...b}){if(!t)throw this._logger.error("create: No url passed"),new Error("url");if(!n)throw this._logger.error("create: No client_id passed"),new Error("client_id");if(!r)throw this._logger.error("create: No redirect_uri passed"),new Error("redirect_uri");if(!s)throw this._logger.error("create: No response_type passed"),new Error("response_type");if(!o)throw this._logger.error("create: No scope passed"),new Error("scope");if(!i)throw this._logger.error("create: No authority passed"),new Error("authority");const S=await p.create({data:a,request_type:d,url_state:h,code_verifier:!y,client_id:n,authority:i,redirect_uri:r,response_mode:c,client_secret:l,scope:o,extraTokenParams:f,skipUserInfo:g}),w=new URL(t);w.searchParams.append("client_id",n),w.searchParams.append("redirect_uri",r),w.searchParams.append("response_type",s),w.searchParams.append("scope",o),u&&w.searchParams.append("nonce",u);let _=S.id;if(h&&(_=`${_};${h}`),w.searchParams.append("state",_),S.code_challenge&&(w.searchParams.append("code_challenge",S.code_challenge),w.searchParams.append("code_challenge_method","S256")),m){(Array.isArray(m)?m:[m]).forEach((e=>w.searchParams.append("resource",e)))}for(const[e,t]of Object.entries({response_mode:c,...b,...v}))null!=t&&w.searchParams.append(e,t.toString());return new e({url:w.href,state:S})}};g._logger=new c("SigninRequest")}},r={};function s(e){var t=r[e];if(void 0!==t)return t.exports;var i=r[e]={id:e,loaded:!1,exports:{}};return n[e].call(i.exports,i,i.exports,s),i.loaded=!0,i.exports}s.m=n,e=[],s.O=(t,i,n,r)=>{if(!i){var o=1/0;for(l=0;l<e.length;l++){for(var[i,n,r]=e[l],a=!0,c=0;c<i.length;c++)(!1&r||o>=r)&&Object.keys(s.O).every((e=>s.O[e](i[c])))?i.splice(c--,1):(a=!1,r<o&&(o=r));if(a){e.splice(l--,1);var d=n();void 0!==d&&(t=d)}}return t}r=r||0;for(var l=e.length;l>0&&e[l-1][2]>r;l--)e[l]=e[l-1];e[l]=[i,n,r]},s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.f={},s.e=e=>Promise.all(Object.keys(s.f).reduce(((t,i)=>(s.f[i](e,t),t)),[])),s.u=e=>"bundles/"+s.h()+"/"+e+".js",s.miniCssF=e=>{},s.h=()=>"c73469086a55f7f61043",s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),t={},i="element-web:",s.l=(e,n,r,o)=>{if(t[e])t[e].push(n);else{var a,c;if(void 0!==r)for(var d=document.getElementsByTagName("script"),l=0;l<d.length;l++){var u=d[l];if(u.getAttribute("src")==e||u.getAttribute("data-webpack")==i+r){a=u;break}}a||(c=!0,(a=document.createElement("script")).charset="utf-8",a.timeout=120,s.nc&&a.setAttribute("nonce",s.nc),a.setAttribute("data-webpack",i+r),a.src=e),t[e]=[n];var h=(i,n)=>{a.onerror=a.onload=null,clearTimeout(m);var r=t[e];if(delete t[e],a.parentNode&&a.parentNode.removeChild(a),r&&r.forEach((e=>e(n))),i)return i(n)},m=setTimeout(h.bind(null,void 0,{type:"timeout",target:a}),12e4);a.onerror=h.bind(null,a.onerror),a.onload=h.bind(null,a.onload),c&&document.head.appendChild(a)}},s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),(()=>{var e;s.g.importScripts&&(e=s.g.location+"");var t=s.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var i=t.getElementsByTagName("script");if(i.length)for(var n=i.length-1;n>-1&&(!e||!/^http(s?):/.test(e));)e=i[n--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),s.p=e})(),(()=>{var e={2798:0};s.f.j=(t,i)=>{var n=s.o(e,t)?e[t]:void 0;if(0!==n)if(n)i.push(n[2]);else{var r=new Promise(((i,r)=>n=e[t]=[i,r]));i.push(n[2]=r);var o=s.p+s.u(t),a=new Error;s.l(o,(i=>{if(s.o(e,t)&&(0!==(n=e[t])&&(e[t]=void 0),n)){var r=i&&("load"===i.type?"missing":i.type),o=i&&i.target&&i.target.src;a.message="Loading chunk "+t+" failed.\n("+r+": "+o+")",a.name="ChunkLoadError",a.type=r,a.request=o,n[1](a)}}),"chunk-"+t,t)}},s.O.j=t=>0===e[t];var t=(t,i)=>{var n,r,[o,a,c]=i,d=0;if(o.some((t=>0!==e[t]))){for(n in a)s.o(a,n)&&(s.m[n]=a[n]);if(c)var l=c(s)}for(t&&t(i);d<o.length;d++)r=o[d],s.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return s.O(l)},i=self.webpackChunkelement_web=self.webpackChunkelement_web||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})();var o=s.O(void 0,[1040],(()=>s("./src/serviceworker/index.ts")));o=s.O(o)})();
//# sourceMappingURL=sw.js.map